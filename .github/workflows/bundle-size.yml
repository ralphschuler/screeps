name: Bundle Size Check

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  bundle-size:
    name: Check Bundle Sizes
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build all packages
        run: npm run build:all

      - name: Check bundle sizes
        run: |
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Size (KB) | Files |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          
          # Define packages to check
          declare -a packages=(
            "@ralphschuler/screeps-kernel:packages/@ralphschuler/screeps-kernel/dist:screeps-kernel"
            "@ralphschuler/screeps-roles:packages/@ralphschuler/screeps-roles/dist:screeps-roles"
            "@ralphschuler/screeps-pathfinding:packages/@ralphschuler/screeps-pathfinding/dist:screeps-pathfinding"
            "@ralphschuler/screeps-remote-mining:packages/@ralphschuler/screeps-remote-mining/dist:screeps-remote-mining"
            "@ralphschuler/screeps-spawn:packages/screeps-spawn/dist:screeps-spawn"
            "@ralphschuler/screeps-economy:packages/screeps-economy/dist:screeps-economy"
            "@ralphschuler/screeps-defense:packages/screeps-defense/dist:screeps-defense"
            "@ralphschuler/screeps-chemistry:packages/screeps-chemistry/dist:screeps-chemistry"
            "@ralphschuler/screeps-utils:packages/screeps-utils/dist:screeps-utils"
            "@ralphschuler/screeps-tasks:packages/screeps-tasks/dist:screeps-tasks"
            "@ralphschuler/screeps-posis:packages/screeps-posis/dist:screeps-posis"
            "screeps-bot:packages/screeps-bot/dist:screeps-bot (main)"
          )
          
          # Check each package
          for package_info in "${packages[@]}"; do
            IFS=':' read -r package_name dist_path display_name <<< "$package_info"
            if [ -d "$dist_path" ]; then
              size=$(du -sk "$dist_path" | cut -f1)
              files=$(find "$dist_path" -type f | wc -l)
              echo "| $display_name | $size | $files |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Note:** Size is reported in kilobytes (KB) for the entire dist directory." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Warning:** Watch for unexpected size increases that could indicate bloat or unintended dependencies." >> $GITHUB_STEP_SUMMARY
