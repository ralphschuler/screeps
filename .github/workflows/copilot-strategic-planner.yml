---
name: Copilot Strategic Planner

# This workflow uses GitHub Copilot with MCP (Model Context Protocol) servers to:
# 1. Analyze live Screeps bot performance using screeps-mcp and grafana-mcp
# 2. Review code quality and architecture alignment with ROADMAP.md
# 3. Create evidence-based GitHub issues for improvements
#
# REQUIRED SECRETS:
# - SCREEPS_TOKEN: Screeps API token for accessing game data (from https://screeps.com/a/#!/account/auth-tokens)
# - GRAFANA_SERVICE_ACCOUNT_TOKEN: Grafana service account token with read permissions
# - COPILOT_TOKEN: GitHub Copilot API token
#
# The workflow will fail immediately if these secrets are not configured.
# See the "Validate required secrets" step for detailed error messages.

on:
  schedule:
    # Run every 6 hours to analyze bot performance and create improvement roadmaps
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose logging for debugging'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read
  issues: write

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  strategic-planning:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    environment:
      name: copilot
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        run: |
          missing_secrets=()
          
          if [ -z "${{ secrets.SCREEPS_TOKEN }}" ]; then
            missing_secrets+=("SCREEPS_TOKEN")
          fi
          
          if [ -z "${{ secrets.GRAFANA_SERVICE_ACCOUNT_TOKEN }}" ]; then
            missing_secrets+=("GRAFANA_SERVICE_ACCOUNT_TOKEN")
          fi
          
          if [ -z "${{ secrets.COPILOT_TOKEN }}" ]; then
            missing_secrets+=("COPILOT_TOKEN")
          fi
          
          if [ ${#missing_secrets[@]} -gt 0 ]; then
            echo "❌ ERROR: Required secrets are not configured:"
            for secret in "${missing_secrets[@]}"; do
              echo "  - $secret"
            done
            echo ""
            echo "To fix this issue:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Configure the missing secrets:"
            echo "   - SCREEPS_TOKEN: Your Screeps API token (get from https://screeps.com/a/#!/account/auth-tokens)"
            echo "   - GRAFANA_SERVICE_ACCOUNT_TOKEN: Grafana service account token with read permissions"
            echo "   - COPILOT_TOKEN: GitHub Copilot API token"
            echo ""
            echo "The strategic planner workflow requires these secrets to:"
            echo "  - Access live Screeps game data (SCREEPS_TOKEN)"
            echo "  - Query Grafana monitoring dashboards (GRAFANA_SERVICE_ACCOUNT_TOKEN)"
            echo "  - Use GitHub Copilot AI (COPILOT_TOKEN)"
            echo ""
            echo "Without these credentials, the agent cannot perform comprehensive analysis."
            exit 1
          fi
          
          echo "✅ All required secrets are configured"

      - name: Run strategic planning analysis
        uses: ./.github/actions/copilot-exec
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: "${{ github.repository }}"
          RUN_ID: "${{ github.run_id }}"
          RUN_URL: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COPILOT_MCP_SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
          COPILOT_MCP_SCREEPS_HOST: ${{ vars.SCREEPS_HOST || 'screeps.com' }}
          COPILOT_MCP_SCREEPS_SHARD: ${{ vars.SCREEPS_SHARD || 'shard3' }}
          COPILOT_MCP_SCREEPS_DOCS_CACHE_TTL: ${{ vars.SCREEPS_DOCS_CACHE_TTL || '3600' }}
          COPILOT_MCP_SCREEPS_WIKI_CACHE_TTL: ${{ vars.SCREEPS_WIKI_CACHE_TTL || '3600' }}
          COPILOT_MCP_SCREEPS_TYPES_CACHE_TTL: ${{ vars.SCREEPS_TYPES_CACHE_TTL || '3600' }}
          COPILOT_MCP_GRAFANA_SERVICE_ACCOUNT_TOKEN: ${{ secrets.GRAFANA_SERVICE_ACCOUNT_TOKEN }}
        with:
          copilot-token: ${{ secrets.COPILOT_TOKEN }}
          prompt-path: .github/agents/strategic-planner.agent.md
          output-path: "reports/copilot/strategic-planner-${{ github.run_id }}.log"
          verbose: "${{ inputs.verbose || 'false' }}"
          additional-mcp-config: '@.github/mcp/all-servers.json'

      - name: Upload strategic planning report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strategic-planner-report-${{ github.run_id }}
          path: |
            reports/copilot/strategic-planner-${{ github.run_id }}.log
          retention-days: 30
