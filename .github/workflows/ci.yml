name: Continuous Integration

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches:
      - main
      - develop

# Cancel in-progress runs for the same workflow and ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ============================================================================
  # Main Bot Tests
  # ============================================================================
  test-bot:
    name: Test Main Bot
    runs-on: ubuntu-latest
    # Skip draft PRs
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build dependencies
        run: npm run build

      - name: Run main bot tests with coverage
        id: coverage
        run: npm run test:coverage -w screeps-typescript-starter
        continue-on-error: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v5
        if: always()
        with:
          file: ./packages/screeps-bot/coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Coverage Summary
        if: always()
        run: |
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f packages/screeps-bot/coverage/lcov.info ]; then
            echo "âœ… Main bot coverage report generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View detailed coverage report in the Codecov upload above." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.coverage.outcome }}" == "failure" ]; then
              echo "âš ï¸ Note: Coverage test step failed (possibly due to threshold requirements), but report was still generated and uploaded." >> $GITHUB_STEP_SUMMARY
            fi
          else
            # Coverage file is truly missing - this is a real failure (e.g., c8 not installed)
            echo "âš ï¸ No coverage report found for main bot" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ============================================================================
  # Package Tests (Framework Packages)
  # ============================================================================
  test-packages:
    name: Test ${{ matrix.package-name }}
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    env:
      CI: true
    strategy:
      fail-fast: false
      matrix:
        include:
          # @ralphschuler scoped packages
          - package-name: screeps-kernel
            workspace: "@ralphschuler/screeps-kernel"
            test-script: "test:kernel"
          - package-name: screeps-roles
            workspace: "@ralphschuler/screeps-roles"
            test-script: "test:roles"
          - package-name: screeps-pathfinding
            workspace: "@ralphschuler/screeps-pathfinding"
            test-script: "test:pathfinding"
          - package-name: screeps-remote-mining
            workspace: "@ralphschuler/screeps-remote-mining"
            test-script: "test:remote-mining"
          # Non-scoped packages
          - package-name: screeps-spawn
            workspace: "@ralphschuler/screeps-spawn"
            test-script: "test:spawn"
          - package-name: screeps-economy
            workspace: "@ralphschuler/screeps-economy"
            test-script: "test:economy"
          - package-name: screeps-defense
            workspace: "@ralphschuler/screeps-defense"
            test-script: "test:defense"
          - package-name: screeps-chemistry
            workspace: "@ralphschuler/screeps-chemistry"
            test-script: "test:chemistry"
          - package-name: screeps-utils
            workspace: "@ralphschuler/screeps-utils"
            test-script: "test:utils"
          - package-name: screeps-tasks
            workspace: "@ralphschuler/screeps-tasks"
            test-script: "test:tasks"
          - package-name: screeps-posis
            workspace: "@ralphschuler/screeps-posis"
            test-script: "test:posis"
          - package-name: screeps-server
            workspace: "@ralphschuler/screeps-server"
            test-script: "test:server"

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build dependencies
        run: npm run build

      - name: Test ${{ matrix.package-name }}
        id: test-step
        run: npm run ${{ matrix.test-script }}
        continue-on-error: true

      - name: Test Summary
        if: always()
        run: |
          echo "## ${{ matrix.package-name }} Test Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test-step.outcome }}" == "success" ]; then
            echo "âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ============================================================================
  # Linting & Type Checking
  # ============================================================================
  lint-bot:
    name: Lint Main Bot
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run ESLint on main bot
        run: npm run lint

  typecheck-packages:
    name: TypeCheck ${{ matrix.package-name }}
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    env:
      CI: true
    strategy:
      fail-fast: false
      matrix:
        include:
          # @ralphschuler scoped packages
          - package-name: screeps-kernel
            workspace: "@ralphschuler/screeps-kernel"
          - package-name: screeps-roles
            workspace: "@ralphschuler/screeps-roles"
          - package-name: screeps-pathfinding
            workspace: "@ralphschuler/screeps-pathfinding"
          - package-name: screeps-remote-mining
            workspace: "@ralphschuler/screeps-remote-mining"
          # Non-scoped packages
          - package-name: screeps-spawn
            workspace: "@ralphschuler/screeps-spawn"
          - package-name: screeps-economy
            workspace: "@ralphschuler/screeps-economy"
          - package-name: screeps-defense
            workspace: "@ralphschuler/screeps-defense"
          - package-name: screeps-chemistry
            workspace: "@ralphschuler/screeps-chemistry"
          - package-name: screeps-utils
            workspace: "@ralphschuler/screeps-utils"
          - package-name: screeps-tasks
            workspace: "@ralphschuler/screeps-tasks"
          - package-name: screeps-posis
            workspace: "@ralphschuler/screeps-posis"

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build ${{ matrix.package-name }}
        id: build-step
        run: npm run build -w ${{ matrix.workspace }}
        continue-on-error: true

      - name: TypeCheck Summary
        if: always()
        run: |
          echo "## ${{ matrix.package-name }} TypeCheck Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.build-step.outcome }}" == "success" ]; then
            echo "âœ… TypeScript compilation passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ TypeScript compilation failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ============================================================================
  # Code Formatting
  # ============================================================================
  format-check:
    name: Check Code Formatting
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Check formatting
        working-directory: packages/screeps-bot
        run: |
          npx prettier --check \
            "src/**/*.{ts,tsx}" \
            "test/**/*.{ts,tsx}" \
            rollup.config.js \
            package.json \
            tsconfig*.json

  # ============================================================================
  # Framework Dependency Sync Check
  # ============================================================================
  check-framework-deps:
    name: Check Framework Package Dependencies
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Check dependency synchronization
        run: npm run sync:deps:check

      - name: Report inconsistencies
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY
          echo "## âŒ Framework Dependency Drift Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Framework packages have inconsistent devDependencies." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To fix locally:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm run sync:deps" >> $GITHUB_STEP_SUMMARY
          echo "git add packages/@ralphschuler/*/package.json" >> $GITHUB_STEP_SUMMARY
          echo "git commit -m 'chore: Sync framework dependencies'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To update shared dependencies:**" >> $GITHUB_STEP_SUMMARY
          echo "Edit \`scripts/shared-dependencies.json\` and run \`npm run sync:deps\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Exporter Tests
  # ============================================================================
  test-exporters:
    name: Test ${{ matrix.package }}
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    strategy:
      matrix:
        package:
          - screeps-graphite-exporter
          - screeps-loki-exporter
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build TypeScript for ${{ matrix.package }}
        run: npm run build -w ${{ matrix.package }}

      - name: Validate Docker build
        uses: docker/build-push-action@v6
        with:
          context: packages/${{ matrix.package }}
          push: false
          load: true
          tags: ${{ matrix.package }}:ci

  # ============================================================================
  # MCP Server Tests
  # ============================================================================
  test-mcp:
    name: Test MCP ${{ matrix.package }}
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    strategy:
      matrix:
        package:
          - screeps-docs-mcp
          - screeps-mcp
          - screeps-wiki-mcp
          - screeps-typescript-mcp
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build ${{ matrix.package }}
        run: npm run build -w @ralphschuler/${{ matrix.package }}

      - name: Run coverage for ${{ matrix.package }}
        run: npm run test:coverage -w @ralphschuler/${{ matrix.package }}

      - name: Upload coverage
        uses: actions/upload-artifact@v6
        with:
          name: coverage-${{ matrix.package }}
          path: packages/${{ matrix.package }}/coverage
          retention-days: 7

  # ============================================================================
  # Bundle Size Check
  # ============================================================================
  bundle-size:
    name: Check Bundle Sizes
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build all packages
        run: npm run build:all

      - name: Check bundle sizes
        run: |
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Size (KB) | Files |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          
          # Define packages to check
          declare -a packages=(
            "@ralphschuler/screeps-kernel:packages/@ralphschuler/screeps-kernel/dist:screeps-kernel"
            "@ralphschuler/screeps-roles:packages/@ralphschuler/screeps-roles/dist:screeps-roles"
            "@ralphschuler/screeps-pathfinding:packages/@ralphschuler/screeps-pathfinding/dist:screeps-pathfinding"
            "@ralphschuler/screeps-remote-mining:packages/@ralphschuler/screeps-remote-mining/dist:screeps-remote-mining"
            "@ralphschuler/screeps-spawn:packages/screeps-spawn/dist:screeps-spawn"
            "@ralphschuler/screeps-economy:packages/screeps-economy/dist:screeps-economy"
            "@ralphschuler/screeps-defense:packages/screeps-defense/dist:screeps-defense"
            "@ralphschuler/screeps-chemistry:packages/screeps-chemistry/dist:screeps-chemistry"
            "@ralphschuler/screeps-utils:packages/screeps-utils/dist:screeps-utils"
            "@ralphschuler/screeps-tasks:packages/screeps-tasks/dist:screeps-tasks"
            "@ralphschuler/screeps-posis:packages/screeps-posis/dist:screeps-posis"
            "screeps-bot:packages/screeps-bot/dist:screeps-bot (main)"
          )
          
          # Check each package
          for package_info in "${packages[@]}"; do
            IFS=':' read -r package_name dist_path display_name <<< "$package_info"
            if [ -d "$dist_path" ]; then
              size=$(du -sk "$dist_path" | cut -f1)
              files=$(find "$dist_path" -type f | wc -l)
              echo "| $display_name | $size | $files |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Note:** Size is reported in kilobytes (KB) for the entire dist directory." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Warning:** Watch for unexpected size increases that could indicate bloat or unintended dependencies." >> $GITHUB_STEP_SUMMARY
