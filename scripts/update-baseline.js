#!/usr/bin/env node

/**
 * Update Performance Baseline Script
 * 
 * Updates the performance baseline for a branch with current metrics.
 * 
 * Prerequisites:
 *   cd scripts/mcp-helpers && npx tsc
 * 
 * Usage:
 *   node scripts/update-baseline.js [branch] [cpu-avg] [cpu-p95] [gcl-progress]
 * 
 * Example:
 *   node scripts/update-baseline.js main 48.5 72.3 0.012
 * 
 * If metrics are not provided, they will be loaded from performance-report.json
 * (generated by packages/screeps-bot/scripts/analyze-performance.js).
 * 
 * Note: performance-results.json contains milestone data, not CPU metrics.
 * CPU metrics come from analyzing console logs via analyze-performance.js.
 */

const fs = require('fs');
const path = require('path');

// Constants
const DEFAULT_SCENARIO = 'default';

// Check if compiled files exist
const distPath = path.join(__dirname, 'mcp-helpers', 'dist', 'regression.js');
if (!fs.existsSync(distPath)) {
  console.error('❌ MCP helpers not compiled. Please run:');
  console.error('   cd scripts/mcp-helpers && npx tsc');
  process.exit(1);
}

const { saveBaseline } = require('./mcp-helpers/dist/regression');

const args = process.argv.slice(2);
const branch = args[0] || process.env.GITHUB_REF_NAME || 'develop';
const cpuAvg = parseFloat(args[1]) || null;
const cpuP95 = parseFloat(args[2]) || null;
const gclProgress = parseFloat(args[3]) || null;

async function main() {
  console.log('=== Update Performance Baseline ===\n');
  console.log(`Branch: ${branch}`);
  
  let metrics;
  
  // If metrics provided via command line, use them
  if (cpuAvg !== null && cpuP95 !== null) {
    console.log('\nUsing provided metrics:');
    console.log(`  CPU Average: ${cpuAvg.toFixed(2)}`);
    console.log(`  CPU P95: ${cpuP95.toFixed(2)}`);
    
    metrics = {
      avg: cpuAvg,
      p95: cpuP95,
      max: cpuP95 * 1.1,
      min: cpuAvg * 0.5,
      p99: cpuP95 * 1.05,
      timestamp: Date.now()
    };
  } else {
    // Try to load from performance report (generated by analyze-performance.js)
    const reportPath = path.join(process.cwd(), 'packages/screeps-bot/performance-report.json');
    
    if (!fs.existsSync(reportPath)) {
      console.error('\n❌ No performance report found and no metrics provided');
      console.log('\nRun performance analysis first:');
      console.log('  cd packages/screeps-bot && node scripts/analyze-performance.js');
      console.log('\nOr provide metrics manually:');
      console.log('  node scripts/update-baseline.js <branch> <cpu-avg> <cpu-p95> [gcl-progress]');
      process.exit(1);
    }
    
    console.log('\nLoading metrics from performance-report.json...');
    const report = JSON.parse(fs.readFileSync(reportPath, 'utf-8'));
    
    // Extract metrics from performance report
    // The report structure is created by analyze-performance.js and contains:
    // - analysis.cpu: { avg, max, min, median, p95, p99, sampleCount }
    // - analysis.bucket: { avg, min, max, ... }
    if (!report.analysis || !report.analysis.cpu) {
      console.error('\n❌ Invalid performance report structure');
      console.log('Expected report.analysis.cpu with avg, max, p95, p99 fields');
      process.exit(1);
    }
    
    metrics = {
      avg: report.analysis.cpu.avg,
      p95: report.analysis.cpu.p95,
      max: report.analysis.cpu.max,
      min: report.analysis.cpu.min,
      p99: report.analysis.cpu.p99,
      timestamp: Date.now()
    };
    
    console.log(`  CPU Average: ${metrics.avg.toFixed(2)}`);
    console.log(`  CPU P95: ${metrics.p95.toFixed(2)}`);
    console.log(`  CPU Max: ${metrics.max.toFixed(2)}`);
    console.log(`  CPU P99: ${metrics.p99.toFixed(2)}`);
  }
  
  // Additional data
  const additionalData = {};
  
  if (gclProgress !== null) {
    additionalData.gcl = {
      progressPerTick: gclProgress
    };
    console.log(`  GCL Progress/Tick: ${gclProgress.toFixed(4)}`);
  }
  
  // Save baseline
  console.log('\nSaving baseline...');
  
  try {
    // Save using the regression module's saveBaseline function
    // This saves the simple cpu/gcl structure
    saveBaseline(metrics, branch, additionalData);
    
    // Also update the baseline with the full scenarios structure
    // This is needed for analyze-performance.js compatibility
    const baselinePath = path.join(process.cwd(), 'performance-baselines', `${branch}.json`);
    
    let baseline;
    try {
      baseline = JSON.parse(fs.readFileSync(baselinePath, 'utf-8'));
    } catch (parseError) {
      console.error(`Error reading baseline file: ${parseError.message}`);
      throw new Error('Failed to read baseline file after saving. File may be corrupted.');
    }
    
    // Add scenarios structure if it doesn't exist
    if (!baseline.scenarios) {
      baseline.scenarios = {};
    }
    
    // Update the default scenario with current metrics
    baseline.scenarios[DEFAULT_SCENARIO] = {
      avgCpu: metrics.avg,
      maxCpu: metrics.max,
      p95Cpu: metrics.p95,
      p99Cpu: metrics.p99
    };
    
    // Add commit hash if available
    if (process.env.GITHUB_SHA) {
      baseline.commit = process.env.GITHUB_SHA;
    }
    
    // Save updated baseline
    try {
      fs.writeFileSync(baselinePath, JSON.stringify(baseline, null, 2), 'utf-8');
    } catch (writeError) {
      console.error(`Error writing baseline file: ${writeError.message}`);
      throw new Error('Failed to write updated baseline. Check file permissions and disk space.');
    }
    
    console.log('\n✅ Baseline updated successfully');
    console.log(`\nBaseline saved to: performance-baselines/${branch}.json`);
    console.log(`History saved to: performance-baselines/history/${branch}-${new Date().toISOString().split('T')[0]}.json`);
  } catch (error) {
    console.error(`\n❌ Failed to save baseline: ${error.message}`);
    throw error;
  }
}

main().catch(error => {
  console.error('❌ Error:', error.message);
  process.exit(1);
});
