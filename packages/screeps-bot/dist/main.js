"use strict";var e=require("url"),t=require("fs"),r=require("path"),o=require("main.js.map");const n="#555555",s="#AAAAAA",i="#FFE87B",a="#F53547",c="#181818",l="#8FBB93";"undefined"!=typeof RoomVisual&&(RoomVisual.prototype.structure=function(e,t,r,o={}){const u={opacity:1,...o};switch(r){case STRUCTURE_EXTENSION:this.circle(e,t,{radius:.5,fill:c,stroke:l,strokeWidth:.05,opacity:u.opacity}),this.circle(e,t,{radius:.35,fill:n,opacity:u.opacity});break;case STRUCTURE_SPAWN:this.circle(e,t,{radius:.65,fill:c,stroke:"#CCCCCC",strokeWidth:.1,opacity:u.opacity}),this.circle(e,t,{radius:.4,fill:i,opacity:u.opacity});break;case STRUCTURE_POWER_SPAWN:this.circle(e,t,{radius:.65,fill:c,stroke:a,strokeWidth:.1,opacity:u.opacity}),this.circle(e,t,{radius:.4,fill:i,opacity:u.opacity});break;case STRUCTURE_TOWER:this.circle(e,t,{radius:.6,fill:c,stroke:l,strokeWidth:.05,opacity:u.opacity}),this.circle(e,t,{radius:.45,fill:n,opacity:u.opacity}),this.rect(e-.2,t-.3,.4,.6,{fill:s,opacity:u.opacity});break;case STRUCTURE_STORAGE:{const r=[[-.45,-.55],[0,-.65],[.45,-.55],[.55,0],[.45,.55],[0,.65],[-.45,.55],[-.55,0]];this.poly(r.map(r=>[r[0]+e,r[1]+t]),{stroke:l,strokeWidth:.05,fill:c,opacity:u.opacity}),this.rect(e-.35,t-.45,.7,.9,{fill:i,opacity:.6*u.opacity});break}case STRUCTURE_TERMINAL:{const r=[[-.45,-.55],[0,-.65],[.45,-.55],[.55,0],[.45,.55],[0,.65],[-.45,.55],[-.55,0]];this.poly(r.map(r=>[r[0]+e,r[1]+t]),{stroke:l,strokeWidth:.05,fill:c,opacity:u.opacity}),this.circle(e,t,{radius:.3,fill:s,opacity:u.opacity}),this.rect(e-.15,t-.15,.3,.3,{fill:n,opacity:u.opacity});break}case STRUCTURE_LAB:this.circle(e,t,{radius:.55,fill:c,stroke:l,strokeWidth:.05,opacity:u.opacity}),this.circle(e,t,{radius:.4,fill:n,opacity:u.opacity}),this.rect(e-.15,t+.1,.3,.25,{fill:s,opacity:u.opacity});break;case STRUCTURE_LINK:this.circle(e,t,{radius:.5,fill:c,stroke:l,strokeWidth:.05,opacity:u.opacity}),this.circle(e,t,{radius:.35,fill:s,opacity:u.opacity});break;case STRUCTURE_NUKER:this.circle(e,t,{radius:.65,fill:c,stroke:"#ff0000",strokeWidth:.1,opacity:u.opacity}),this.circle(e,t,{radius:.4,fill:"#ff0000",opacity:.6*u.opacity});break;case STRUCTURE_OBSERVER:this.circle(e,t,{radius:.6,fill:c,stroke:l,strokeWidth:.05,opacity:u.opacity}),this.circle(e,t,{radius:.4,fill:"#00ffff",opacity:.6*u.opacity});break;case STRUCTURE_CONTAINER:this.rect(e-.45,t-.45,.9,.9,{fill:c,stroke:l,strokeWidth:.05,opacity:u.opacity}),this.rect(e-.35,t-.35,.7,.7,{fill:"transparent",stroke:n,strokeWidth:.05,opacity:u.opacity});break;case STRUCTURE_ROAD:this.circle(e,t,{radius:.175,fill:"#666",opacity:u.opacity});break;case STRUCTURE_RAMPART:this.rect(e-.45,t-.45,.9,.9,{fill:"transparent",stroke:"#00ff00",strokeWidth:.1,opacity:u.opacity});break;case STRUCTURE_WALL:this.rect(e-.45,t-.45,.9,.9,{fill:c,stroke:s,strokeWidth:.05,opacity:u.opacity});break;case STRUCTURE_EXTRACTOR:this.circle(e,t,{radius:.6,fill:c,stroke:l,strokeWidth:.05,opacity:u.opacity}),this.circle(e,t,{radius:.45,fill:n,opacity:u.opacity});break;default:this.circle(e,t,{radius:.5,fill:n,stroke:l,strokeWidth:.05,opacity:u.opacity})}},RoomVisual.prototype.speech=function(e,t,r,o={}){var n,s,i,a,c;const l=null!==(n=o.background)&&void 0!==n?n:"#2ccf3b",u=null!==(s=o.textcolor)&&void 0!==s?s:"#000000",m=null!==(i=o.textsize)&&void 0!==i?i:.5,d=null!==(a=o.textfont)&&void 0!==a?a:"Times New Roman",p=null!==(c=o.opacity)&&void 0!==c?c:1,g=m,f=e.length*g*.4+.4,h=g+.4;this.rect(t-f/2,r-1-h,f,h,{fill:l,opacity:.9*p});const y=[[t-.1,r-1],[t+.1,r-1],[t,r-.6]];this.poly(y,{fill:l,opacity:.9*p,stroke:"transparent"}),this.text(e,t,r-1-h/2+.1,{color:u,font:`${g} ${d}`,opacity:p})},RoomVisual.prototype.animatedPosition=function(e,t,r={}){var o,n,s,i;const a=null!==(o=r.color)&&void 0!==o?o:"#ff0000",c=null!==(n=r.opacity)&&void 0!==n?n:1,l=null!==(s=r.radius)&&void 0!==s?s:.75,u=null!==(i=r.frames)&&void 0!==i?i:6,m=Game.time%u,d=l*(1-m/u),p=c*(m/u);this.circle(e,t,{radius:d,fill:"transparent",stroke:a,strokeWidth:.1,opacity:p})},RoomVisual.prototype.resource=function(e,t,r,o=.25){var n;const s=null!==(n={[RESOURCE_ENERGY]:i,[RESOURCE_POWER]:a,[RESOURCE_HYDROGEN]:"#FFFFFF",[RESOURCE_OXYGEN]:"#DDDDDD",[RESOURCE_UTRIUM]:"#48C5E5",[RESOURCE_LEMERGIUM]:"#24D490",[RESOURCE_KEANIUM]:"#9269EC",[RESOURCE_ZYNTHIUM]:"#D9B478",[RESOURCE_CATALYST]:"#F26D6F",[RESOURCE_GHODIUM]:"#FFFFFF"}[e])&&void 0!==n?n:"#CCCCCC";this.circle(t,r,{radius:o,fill:c,opacity:.9}),this.circle(t,r,{radius:.8*o,fill:s,opacity:.8});const l=e.length>2?e.substring(0,2).toUpperCase():e;this.text(l,t,r+.03,{color:c,font:1.2*o+" monospace",align:"center",opacity:.9})});var u="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function m(e){if({}.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if("function"==typeof t){var r=function e(){var r=!1;try{r=this instanceof e}catch{}return r?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(t){var o=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,o.get?o:{enumerable:!0,get:function(){return e[t]}})}),r}var d,p,g={},f={},h={},y={};function R(){if(d)return y;d=1;const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");return y.encode=function(t){if(t>=0&&t<e.length)return e[t];throw new TypeError("Must be between 0 and 63: "+t)},y}function E(){if(p)return h;p=1;const e=R();return h.encode=function(t){let r,o="",n=function(e){return 0>e?1+(-e<<1):0+(e<<1)}(t);do{r=31&n,n>>>=5,n>0&&(r|=32),o+=e.encode(r)}while(n>0);return o},h}var T,C,v,S={};function _(){return C?T:(C=1,T="function"==typeof URL?URL:e.URL)}function b(){if(v)return S;v=1;const e=_();S.getArg=function(e,t,r){if(t in e)return e[t];if(3===arguments.length)return r;throw Error('"'+t+'" is a required argument.')};const t=!("__proto__"in Object.create(null));function r(e){return e}function o(e){if(!e)return!1;const t=e.length;if(9>t)return!1;if(95!==e.charCodeAt(t-1)||95!==e.charCodeAt(t-2)||111!==e.charCodeAt(t-3)||116!==e.charCodeAt(t-4)||111!==e.charCodeAt(t-5)||114!==e.charCodeAt(t-6)||112!==e.charCodeAt(t-7)||95!==e.charCodeAt(t-8)||95!==e.charCodeAt(t-9))return!1;for(let r=t-10;r>=0;r--)if(36!==e.charCodeAt(r))return!1;return!0}function n(e,t){return e===t?0:null===e?1:null===t?-1:e>t?1:-1}S.toSetString=t?r:function(e){return o(e)?"$"+e:e},S.fromSetString=t?r:function(e){return o(e)?e.slice(1):e},S.compareByGeneratedPositionsInflated=function(e,t){let r=e.generatedLine-t.generatedLine;return 0!==r?r:(r=e.generatedColumn-t.generatedColumn,0!==r?r:(r=n(e.source,t.source),0!==r?r:(r=e.originalLine-t.originalLine,0!==r?r:(r=e.originalColumn-t.originalColumn,0!==r?r:n(e.name,t.name)))))},S.parseSourceMapInput=function(e){return JSON.parse(e.replace(/^\)]}'[^\n]*\n/,""))};const s="http://host";function i(t){return r=>{const o=u(r),n=c(r),s=new e(r,n);t(s);const i=s.toString();return"absolute"===o?i:"scheme-relative"===o?i.slice(5):"path-absolute"===o?i.slice(11):m(n,i)}}function a(t,r){return new e(t,r).toString()}function c(e){const t=e.split("..").length-1,r=function(e,t){let r=0;for(;;){const e="p"+r++;if(-1===t.indexOf(e))return e}}(0,e);let o=s+"/";for(let e=0;t>e;e++)o+=r+"/";return o}const l=/^[A-Za-z0-9\+\-\.]+:/;function u(e){return"/"===e[0]?"/"===e[1]?"scheme-relative":"path-absolute":l.test(e)?"absolute":"path-relative"}function m(t,r){"string"==typeof t&&(t=new e(t)),"string"==typeof r&&(r=new e(r));const o=r.pathname.split("/"),n=t.pathname.split("/");for(n.length>0&&!n[n.length-1]&&n.pop();o.length>0&&n.length>0&&o[0]===n[0];)o.shift(),n.shift();return n.map(()=>"..").concat(o).join("/")+r.search+r.hash}const d=i(e=>{e.pathname=e.pathname.replace(/\/?$/,"/")}),p=i(t=>{t.href=new e(".",t.toString()).toString()}),g=i(e=>{});function f(e,t){const r=u(t),o=u(e);if(e=d(e),"absolute"===r)return a(t,void 0);if("absolute"===o)return a(t,e);if("scheme-relative"===r)return g(t);if("scheme-relative"===o)return a(t,a(e,s)).slice(5);if("path-absolute"===r)return g(t);if("path-absolute"===o)return a(t,a(e,s)).slice(11);const n=c(t+e);return m(n,a(t,a(e,n)))}return S.normalize=g,S.join=f,S.relative=function(t,r){const o=function(t,r){if(u(t)!==u(r))return null;const o=c(t+r),n=new e(t,o),s=new e(r,o);try{new e("",s.toString())}catch(e){return null}return s.protocol!==n.protocol||s.user!==n.user||s.password!==n.password||s.hostname!==n.hostname||s.port!==n.port?null:m(n,s)}(t,r);return"string"==typeof o?o:g(r)},S.computeSourceURL=function(e,t,r){e&&"path-absolute"===u(t)&&(t=t.replace(/^\//,""));let o=g(t||"");return e&&(o=f(e,o)),r&&(o=f(p(r),o)),o},S}var O,U={};function M(){if(O)return U;O=1;class e{constructor(){this._array=[],this._set=new Map}static fromArray(t,r){const o=new e;for(let e=0,n=t.length;n>e;e++)o.add(t[e],r);return o}size(){return this._set.size}add(e,t){const r=this.has(e),o=this._array.length;r&&!t||this._array.push(e),r||this._set.set(e,o)}has(e){return this._set.has(e)}indexOf(e){const t=this._set.get(e);if(t>=0)return t;throw Error('"'+e+'" is not in the set.')}at(e){if(e>=0&&e<this._array.length)return this._array[e];throw Error("No element indexed by "+e)}toArray(){return this._array.slice()}}return U.ArraySet=e,U}var A,w,k={};function N(){if(w)return f;w=1;const e=E(),t=b(),r=M().ArraySet,o=function(){if(A)return k;A=1;const e=b();return k.MappingList=class{constructor(){this._array=[],this._sorted=!0,this._last={generatedLine:-1,generatedColumn:0}}unsortedForEach(e,t){this._array.forEach(e,t)}add(t){!function(t,r){const o=t.generatedLine,n=r.generatedLine,s=t.generatedColumn,i=r.generatedColumn;return n>o||n==o&&i>=s||0>=e.compareByGeneratedPositionsInflated(t,r)}(this._last,t)?(this._sorted=!1,this._array.push(t)):(this._last=t,this._array.push(t))}toArray(){return this._sorted||(this._array.sort(e.compareByGeneratedPositionsInflated),this._sorted=!0),this._array}},k}().MappingList;class n{constructor(e){e||(e={}),this._file=t.getArg(e,"file",null),this._sourceRoot=t.getArg(e,"sourceRoot",null),this._skipValidation=t.getArg(e,"skipValidation",!1),this._sources=new r,this._names=new r,this._mappings=new o,this._sourcesContents=null}static fromSourceMap(e){const r=e.sourceRoot,o=new n({file:e.file,sourceRoot:r});return e.eachMapping(function(e){const n={generated:{line:e.generatedLine,column:e.generatedColumn}};null!=e.source&&(n.source=e.source,null!=r&&(n.source=t.relative(r,n.source)),n.original={line:e.originalLine,column:e.originalColumn},null!=e.name&&(n.name=e.name)),o.addMapping(n)}),e.sources.forEach(function(n){let s=n;null!=r&&(s=t.relative(r,n)),o._sources.has(s)||o._sources.add(s);const i=e.sourceContentFor(n);null!=i&&o.setSourceContent(n,i)}),o}addMapping(e){const r=t.getArg(e,"generated"),o=t.getArg(e,"original",null);let n=t.getArg(e,"source",null),s=t.getArg(e,"name",null);this._skipValidation||this._validateMapping(r,o,n,s),null!=n&&(n+="",this._sources.has(n)||this._sources.add(n)),null!=s&&(s+="",this._names.has(s)||this._names.add(s)),this._mappings.add({generatedLine:r.line,generatedColumn:r.column,originalLine:o&&o.line,originalColumn:o&&o.column,source:n,name:s})}setSourceContent(e,r){let o=e;null!=this._sourceRoot&&(o=t.relative(this._sourceRoot,o)),null!=r?(this._sourcesContents||(this._sourcesContents=Object.create(null)),this._sourcesContents[t.toSetString(o)]=r):this._sourcesContents&&(delete this._sourcesContents[t.toSetString(o)],0===Object.keys(this._sourcesContents).length&&(this._sourcesContents=null))}applySourceMap(e,o,n){let s=o;if(null==o){if(null==e.file)throw Error('SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, or the source map\'s "file" property. Both were omitted.');s=e.file}const i=this._sourceRoot;null!=i&&(s=t.relative(i,s));const a=this._mappings.toArray().length>0?new r:this._sources,c=new r;this._mappings.unsortedForEach(function(r){if(r.source===s&&null!=r.originalLine){const o=e.originalPositionFor({line:r.originalLine,column:r.originalColumn});null!=o.source&&(r.source=o.source,null!=n&&(r.source=t.join(n,r.source)),null!=i&&(r.source=t.relative(i,r.source)),r.originalLine=o.line,r.originalColumn=o.column,null!=o.name&&(r.name=o.name))}const o=r.source;null==o||a.has(o)||a.add(o);const l=r.name;null==l||c.has(l)||c.add(l)},this),this._sources=a,this._names=c,e.sources.forEach(function(r){const o=e.sourceContentFor(r);null!=o&&(null!=n&&(r=t.join(n,r)),null!=i&&(r=t.relative(i,r)),this.setSourceContent(r,o))},this)}_validateMapping(e,t,r,o){if(t&&"number"!=typeof t.line&&"number"!=typeof t.column)throw Error("original.line and original.column are not numbers -- you probably meant to omit the original mapping entirely and only map the generated position. If so, pass null for the original mapping instead of an object with empty or null values.");if((!(e&&"line"in e&&"column"in e&&e.line>0)||0>e.column||t||r||o)&&!(e&&"line"in e&&"column"in e&&t&&"line"in t&&"column"in t&&e.line>0&&e.column>=0&&t.line>0&&t.column>=0&&r))throw Error("Invalid mapping: "+JSON.stringify({generated:e,source:r,original:t,name:o}))}_serializeMappings(){let r,o,n,s,i=0,a=1,c=0,l=0,u=0,m=0,d="";const p=this._mappings.toArray();for(let g=0,f=p.length;f>g;g++){if(o=p[g],r="",o.generatedLine!==a)for(i=0;o.generatedLine!==a;)r+=";",a++;else if(g>0){if(!t.compareByGeneratedPositionsInflated(o,p[g-1]))continue;r+=","}r+=e.encode(o.generatedColumn-i),i=o.generatedColumn,null!=o.source&&(s=this._sources.indexOf(o.source),r+=e.encode(s-m),m=s,r+=e.encode(o.originalLine-1-l),l=o.originalLine-1,r+=e.encode(o.originalColumn-c),c=o.originalColumn,null!=o.name&&(n=this._names.indexOf(o.name),r+=e.encode(n-u),u=n)),d+=r}return d}_generateSourcesContent(e,r){return e.map(function(e){if(!this._sourcesContents)return null;null!=r&&(e=t.relative(r,e));const o=t.toSetString(e);return{}.hasOwnProperty.call(this._sourcesContents,o)?this._sourcesContents[o]:null},this)}toJSON(){const e={version:this._version,sources:this._sources.toArray(),names:this._names.toArray(),mappings:this._serializeMappings()};return null!=this._file&&(e.file=this._file),null!=this._sourceRoot&&(e.sourceRoot=this._sourceRoot),this._sourcesContents&&(e.sourcesContent=this._generateSourcesContent(e.sources,e.sourceRoot)),e}toString(){return JSON.stringify(this.toJSON())}}return n.prototype._version=3,f.SourceMapGenerator=n,f}var P,I={},x={};function $(){return P||(P=1,function(e){function t(r,o,n,s,i,a){const c=Math.floor((o-r)/2)+r,l=i(n,s[c],!0);return 0===l?c:l>0?o-c>1?t(c,o,n,s,i,a):a===e.LEAST_UPPER_BOUND?o<s.length?o:-1:c:c-r>1?t(r,c,n,s,i,a):a==e.LEAST_UPPER_BOUND?c:0>r?-1:r}e.GREATEST_LOWER_BOUND=1,e.LEAST_UPPER_BOUND=2,e.search=function(r,o,n,s){if(0===o.length)return-1;let i=t(-1,o.length,r,o,n,s||e.GREATEST_LOWER_BOUND);if(0>i)return-1;for(;i-1>=0&&0===n(o[i],o[i-1],!0);)--i;return i}}(x)),x}var G,L,D,F,B={exports:{}};function H(){if(G)return B.exports;G=1;const e=t,o=r;return B.exports=function(){return new Promise((t,r)=>{const n=o.join(__dirname,"mappings.wasm");e.readFile(n,null,(e,o)=>{e?r(e):t(o.buffer)})})},B.exports.initialize=e=>{console.debug("SourceMapConsumer.initialize is a no-op when running in node.js")},B.exports}function W(){if(D)return L;D=1;const e=H();function t(){this.generatedLine=0,this.generatedColumn=0,this.lastGeneratedColumn=null,this.source=null,this.originalLine=null,this.originalColumn=null,this.name=null}let r=null;return L=function(){if(r)return r;const o=[];return r=e().then(e=>WebAssembly.instantiate(e,{env:{mapping_callback(e,r,n,s,i,a,c,l,u,m){const d=new t;d.generatedLine=e+1,d.generatedColumn=r,n&&(d.lastGeneratedColumn=s-1),i&&(d.source=a,d.originalLine=c+1,d.originalColumn=l,u&&(d.name=m)),o[o.length-1](d)},start_all_generated_locations_for(){console.time("all_generated_locations_for")},end_all_generated_locations_for(){console.timeEnd("all_generated_locations_for")},start_compute_column_spans(){console.time("compute_column_spans")},end_compute_column_spans(){console.timeEnd("compute_column_spans")},start_generated_location_for(){console.time("generated_location_for")},end_generated_location_for(){console.timeEnd("generated_location_for")},start_original_location_for(){console.time("original_location_for")},end_original_location_for(){console.timeEnd("original_location_for")},start_parse_mappings(){console.time("parse_mappings")},end_parse_mappings(){console.timeEnd("parse_mappings")},start_sort_by_generated_location(){console.time("sort_by_generated_location")},end_sort_by_generated_location(){console.timeEnd("sort_by_generated_location")},start_sort_by_original_location(){console.time("sort_by_original_location")},end_sort_by_original_location(){console.timeEnd("sort_by_original_location")}}})).then(e=>({exports:e.instance.exports,withMappingCallback:(e,t)=>{o.push(e);try{t()}finally{o.pop()}}})).then(null,e=>{throw r=null,e}),r}}var Y,K,j={};function V(){return K||(K=1,g.SourceMapGenerator=N().SourceMapGenerator,g.SourceMapConsumer=function(){if(F)return I;F=1;const e=b(),t=$(),r=M().ArraySet;E();const o=H(),n=W(),s=Symbol("smcInternal");class i{constructor(t,r){return t==s?Promise.resolve(this):function(t,r){let o=t;"string"==typeof t&&(o=e.parseSourceMapInput(t));const n=null!=o.sections?new c(o,r):new a(o,r);return Promise.resolve(n)}(t,r)}static initialize(e){o.initialize(e["lib/mappings.wasm"])}static fromSourceMap(e,t){return function(e,t){return a.fromSourceMap(e,t)}(e,t)}static async with(e,t,r){const o=await new i(e,t);try{return await r(o)}finally{o.destroy()}}eachMapping(e,t,r){throw Error("Subclasses must implement eachMapping")}allGeneratedPositionsFor(e){throw Error("Subclasses must implement allGeneratedPositionsFor")}destroy(){throw Error("Subclasses must implement destroy")}}i.prototype._version=3,i.GENERATED_ORDER=1,i.ORIGINAL_ORDER=2,i.GREATEST_LOWER_BOUND=1,i.LEAST_UPPER_BOUND=2,I.SourceMapConsumer=i;class a extends i{constructor(t,o){return super(s).then(s=>{let i=t;"string"==typeof t&&(i=e.parseSourceMapInput(t));const a=e.getArg(i,"version"),c=e.getArg(i,"sources").map(String),l=e.getArg(i,"names",[]),u=e.getArg(i,"sourceRoot",null),m=e.getArg(i,"sourcesContent",null),d=e.getArg(i,"mappings"),p=e.getArg(i,"file",null),g=e.getArg(i,"x_google_ignoreList",null);if(a!=s._version)throw Error("Unsupported version: "+a);return s._sourceLookupCache=new Map,s._names=r.fromArray(l.map(String),!0),s._sources=r.fromArray(c,!0),s._absoluteSources=r.fromArray(s._sources.toArray().map(function(t){return e.computeSourceURL(u,t,o)}),!0),s.sourceRoot=u,s.sourcesContent=m,s._mappings=d,s._sourceMapURL=o,s.file=p,s.x_google_ignoreList=g,s._computedColumnSpans=!1,s._mappingsPtr=0,s._wasm=null,n().then(e=>(s._wasm=e,s))})}_findSourceIndex(t){const r=this._sourceLookupCache.get(t);if("number"==typeof r)return r;const o=e.computeSourceURL(null,t,this._sourceMapURL);if(this._absoluteSources.has(o)){const e=this._absoluteSources.indexOf(o);return this._sourceLookupCache.set(t,e),e}const n=e.computeSourceURL(this.sourceRoot,t,this._sourceMapURL);if(this._absoluteSources.has(n)){const e=this._absoluteSources.indexOf(n);return this._sourceLookupCache.set(t,e),e}return-1}static fromSourceMap(e,t){return new a(e.toString())}get sources(){return this._absoluteSources.toArray()}_getMappingsPtr(){return 0===this._mappingsPtr&&this._parseMappings(),this._mappingsPtr}_parseMappings(){const e=this._mappings,t=e.length,r=this._wasm.exports.allocate_mappings(t)>>>0,o=new Uint8Array(this._wasm.exports.memory.buffer,r,t);for(let r=0;t>r;r++)o[r]=e.charCodeAt(r);const n=this._wasm.exports.parse_mappings(r);if(!n){const e=this._wasm.exports.get_last_error();let t=`Error parsing mappings (code ${e}): `;switch(e){case 1:t+="the mappings contained a negative line, column, source index, or name index";break;case 2:t+="the mappings contained a number larger than 2**32";break;case 3:t+="reached EOF while in the middle of parsing a VLQ";break;case 4:t+="invalid base 64 character while parsing a VLQ";break;default:t+="unknown error code"}throw Error(t)}this._mappingsPtr=n}eachMapping(e,t,r){const o=t||null,n=r||i.GENERATED_ORDER;this._wasm.withMappingCallback(t=>{null!==t.source&&(t.source=this._absoluteSources.at(t.source),null!==t.name&&(t.name=this._names.at(t.name))),this._computedColumnSpans&&null===t.lastGeneratedColumn&&(t.lastGeneratedColumn=1/0),e.call(o,t)},()=>{switch(n){case i.GENERATED_ORDER:this._wasm.exports.by_generated_location(this._getMappingsPtr());break;case i.ORIGINAL_ORDER:this._wasm.exports.by_original_location(this._getMappingsPtr());break;default:throw Error("Unknown order of iteration.")}})}allGeneratedPositionsFor(t){let r=e.getArg(t,"source");const o=e.getArg(t,"line"),n=t.column||0;if(r=this._findSourceIndex(r),0>r)return[];if(1>o)throw Error("Line numbers must be >= 1");if(0>n)throw Error("Column numbers must be >= 0");const s=[];return this._wasm.withMappingCallback(e=>{let t=e.lastGeneratedColumn;this._computedColumnSpans&&null===t&&(t=1/0),s.push({line:e.generatedLine,column:e.generatedColumn,lastColumn:t})},()=>{this._wasm.exports.all_generated_locations_for(this._getMappingsPtr(),r,o-1,"column"in t,n)}),s}destroy(){0!==this._mappingsPtr&&(this._wasm.exports.free_mappings(this._mappingsPtr),this._mappingsPtr=0)}computeColumnSpans(){this._computedColumnSpans||(this._wasm.exports.compute_column_spans(this._getMappingsPtr()),this._computedColumnSpans=!0)}originalPositionFor(t){const r={generatedLine:e.getArg(t,"line"),generatedColumn:e.getArg(t,"column")};if(1>r.generatedLine)throw Error("Line numbers must be >= 1");if(0>r.generatedColumn)throw Error("Column numbers must be >= 0");let o,n=e.getArg(t,"bias",i.GREATEST_LOWER_BOUND);if(null==n&&(n=i.GREATEST_LOWER_BOUND),this._wasm.withMappingCallback(e=>o=e,()=>{this._wasm.exports.original_location_for(this._getMappingsPtr(),r.generatedLine-1,r.generatedColumn,n)}),o&&o.generatedLine===r.generatedLine){let t=e.getArg(o,"source",null);null!==t&&(t=this._absoluteSources.at(t));let r=e.getArg(o,"name",null);return null!==r&&(r=this._names.at(r)),{source:t,line:e.getArg(o,"originalLine",null),column:e.getArg(o,"originalColumn",null),name:r}}return{source:null,line:null,column:null,name:null}}hasContentsOfAllSources(){return!!this.sourcesContent&&this.sourcesContent.length>=this._sources.size()&&!this.sourcesContent.some(function(e){return null==e})}sourceContentFor(e,t){if(!this.sourcesContent)return null;const r=this._findSourceIndex(e);if(r>=0)return this.sourcesContent[r];if(t)return null;throw Error('"'+e+'" is not in the SourceMap.')}generatedPositionFor(t){let r=e.getArg(t,"source");if(r=this._findSourceIndex(r),0>r)return{line:null,column:null,lastColumn:null};const o={source:r,originalLine:e.getArg(t,"line"),originalColumn:e.getArg(t,"column")};if(1>o.originalLine)throw Error("Line numbers must be >= 1");if(0>o.originalColumn)throw Error("Column numbers must be >= 0");let n,s=e.getArg(t,"bias",i.GREATEST_LOWER_BOUND);if(null==s&&(s=i.GREATEST_LOWER_BOUND),this._wasm.withMappingCallback(e=>n=e,()=>{this._wasm.exports.generated_location_for(this._getMappingsPtr(),o.source,o.originalLine-1,o.originalColumn,s)}),n&&n.source===o.source){let t=n.lastGeneratedColumn;return this._computedColumnSpans&&null===t&&(t=1/0),{line:e.getArg(n,"generatedLine",null),column:e.getArg(n,"generatedColumn",null),lastColumn:t}}return{line:null,column:null,lastColumn:null}}}a.prototype.consumer=i,I.BasicSourceMapConsumer=a;class c extends i{constructor(t,r){return super(s).then(o=>{let n=t;"string"==typeof t&&(n=e.parseSourceMapInput(t));const s=e.getArg(n,"version"),a=e.getArg(n,"sections");if(s!=o._version)throw Error("Unsupported version: "+s);let c={line:-1,column:0};return Promise.all(a.map(t=>{if(t.url)throw Error("Support for url field in sections not implemented.");const o=e.getArg(t,"offset"),n=e.getArg(o,"line"),s=e.getArg(o,"column");if(n<c.line||n===c.line&&s<c.column)throw Error("Section offsets must be ordered and non-overlapping.");return c=o,new i(e.getArg(t,"map"),r).then(e=>({generatedOffset:{generatedLine:n+1,generatedColumn:s+1},consumer:e}))})).then(e=>(o._sections=e,o))})}get sources(){const e=[];for(let t=0;t<this._sections.length;t++)for(let r=0;r<this._sections[t].consumer.sources.length;r++)e.push(this._sections[t].consumer.sources[r]);return e}originalPositionFor(r){const o={generatedLine:e.getArg(r,"line"),generatedColumn:e.getArg(r,"column")},n=t.search(o,this._sections,function(e,t){return e.generatedLine-t.generatedOffset.generatedLine||e.generatedColumn-(t.generatedOffset.generatedColumn-1)}),s=this._sections[n];return s?s.consumer.originalPositionFor({line:o.generatedLine-(s.generatedOffset.generatedLine-1),column:o.generatedColumn-(s.generatedOffset.generatedLine===o.generatedLine?s.generatedOffset.generatedColumn-1:0),bias:r.bias}):{source:null,line:null,column:null,name:null}}hasContentsOfAllSources(){return this._sections.every(function(e){return e.consumer.hasContentsOfAllSources()})}sourceContentFor(e,t){for(let t=0;t<this._sections.length;t++){const r=this._sections[t].consumer.sourceContentFor(e,!0);if(r)return r}if(t)return null;throw Error('"'+e+'" is not in the SourceMap.')}_findSectionIndex(e){for(let t=0;t<this._sections.length;t++){const{consumer:r}=this._sections[t];if(-1!==r._findSourceIndex(e))return t}return-1}generatedPositionFor(t){const r=this._findSectionIndex(e.getArg(t,"source")),o=0>r?null:this._sections[r],n=r>=0&&r+1<this._sections.length?this._sections[r+1]:null,s=o&&o.consumer.generatedPositionFor(t);if(s&&null!==s.line){const e=o.generatedOffset.generatedLine-1,t=o.generatedOffset.generatedColumn-1;return 1===s.line&&(s.column+=t,"number"==typeof s.lastColumn&&(s.lastColumn+=t)),s.lastColumn===1/0&&n&&s.line===n.generatedOffset.generatedLine&&(s.lastColumn=n.generatedOffset.generatedColumn-2),s.line+=e,s}return{line:null,column:null,lastColumn:null}}allGeneratedPositionsFor(t){const r=this._findSectionIndex(e.getArg(t,"source")),o=0>r?null:this._sections[r],n=r>=0&&r+1<this._sections.length?this._sections[r+1]:null;return o?o.consumer.allGeneratedPositionsFor(t).map(e=>{const t=o.generatedOffset.generatedLine-1,r=o.generatedOffset.generatedColumn-1;return 1===e.line&&(e.column+=r,"number"==typeof e.lastColumn&&(e.lastColumn+=r)),e.lastColumn===1/0&&n&&e.line===n.generatedOffset.generatedLine&&(e.lastColumn=n.generatedOffset.generatedColumn-2),e.line+=t,e}):[]}eachMapping(e,t,r){this._sections.forEach((o,n)=>{const s=n+1<this._sections.length?this._sections[n+1]:null,{generatedOffset:i}=o,a=i.generatedLine-1,c=i.generatedColumn-1;o.consumer.eachMapping(function(t){1===t.generatedLine&&(t.generatedColumn+=c,"number"==typeof t.lastGeneratedColumn&&(t.lastGeneratedColumn+=c)),t.lastGeneratedColumn===1/0&&s&&t.generatedLine===s.generatedOffset.generatedLine&&(t.lastGeneratedColumn=s.generatedOffset.generatedColumn-2),t.generatedLine+=a,e.call(this,t)},t,r)})}computeColumnSpans(){for(let e=0;e<this._sections.length;e++)this._sections[e].consumer.computeColumnSpans()}destroy(){for(let e=0;e<this._sections.length;e++)this._sections[e].consumer.destroy()}}return I.IndexedSourceMapConsumer=c,I}().SourceMapConsumer,g.SourceNode=function(){if(Y)return j;Y=1;const e=N().SourceMapGenerator,t=b(),r=/(\r?\n)/,o="$$$isSourceNode$$$";class n{constructor(e,t,r,n,s){this.children=[],this.sourceContents={},this.line=null==e?null:e,this.column=null==t?null:t,this.source=null==r?null:r,this.name=null==s?null:s,this[o]=!0,null!=n&&this.add(n)}static fromStringWithSourceMap(e,o,s){const i=new n,a=e.split(r);let c=0;const l=function(){return e()+(e()||"");function e(){return c<a.length?a[c++]:void 0}};let u,m=1,d=0,p=null;return o.eachMapping(function(e){if(null!==p){if(m>=e.generatedLine){u=a[c]||"";const t=u.substr(0,e.generatedColumn-d);return a[c]=u.substr(e.generatedColumn-d),d=e.generatedColumn,g(p,t),void(p=e)}g(p,l()),m++,d=0}for(;m<e.generatedLine;)i.add(l()),m++;d<e.generatedColumn&&(u=a[c]||"",i.add(u.substr(0,e.generatedColumn)),a[c]=u.substr(e.generatedColumn),d=e.generatedColumn),p=e},this),c<a.length&&(p&&g(p,l()),i.add(a.splice(c).join(""))),o.sources.forEach(function(e){const r=o.sourceContentFor(e);null!=r&&(null!=s&&(e=t.join(s,e)),i.setSourceContent(e,r))}),i;function g(e,r){if(null===e||void 0===e.source)i.add(r);else{const o=s?t.join(s,e.source):e.source;i.add(new n(e.originalLine,e.originalColumn,o,r,e.name))}}}add(e){if(Array.isArray(e))e.forEach(function(e){this.add(e)},this);else{if(!e[o]&&"string"!=typeof e)throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);e&&this.children.push(e)}return this}prepend(e){if(Array.isArray(e))for(let t=e.length-1;t>=0;t--)this.prepend(e[t]);else{if(!e[o]&&"string"!=typeof e)throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);this.children.unshift(e)}return this}walk(e){let t;for(let r=0,n=this.children.length;n>r;r++)t=this.children[r],t[o]?t.walk(e):""!==t&&e(t,{source:this.source,line:this.line,column:this.column,name:this.name})}join(e){let t,r;const o=this.children.length;if(o>0){for(t=[],r=0;o-1>r;r++)t.push(this.children[r]),t.push(e);t.push(this.children[r]),this.children=t}return this}replaceRight(e,t){const r=this.children[this.children.length-1];return r[o]?r.replaceRight(e,t):"string"==typeof r?this.children[this.children.length-1]=r.replace(e,t):this.children.push("".replace(e,t)),this}setSourceContent(e,r){this.sourceContents[t.toSetString(e)]=r}walkSourceContents(e){for(let t=0,r=this.children.length;r>t;t++)this.children[t][o]&&this.children[t].walkSourceContents(e);const r=Object.keys(this.sourceContents);for(let o=0,n=r.length;n>o;o++)e(t.fromSetString(r[o]),this.sourceContents[r[o]])}toString(){let e="";return this.walk(function(t){e+=t}),e}toStringWithSourceMap(t){const r={code:"",line:1,column:0},o=new e(t);let n=!1,s=null,i=null,a=null,c=null;return this.walk(function(e,t){r.code+=e,null!==t.source&&null!==t.line&&null!==t.column?(s===t.source&&i===t.line&&a===t.column&&c===t.name||o.addMapping({source:t.source,original:{line:t.line,column:t.column},generated:{line:r.line,column:r.column},name:t.name}),s=t.source,i=t.line,a=t.column,c=t.name,n=!0):n&&(o.addMapping({generated:{line:r.line,column:r.column}}),s=null,n=!1);for(let i=0,a=e.length;a>i;i++)10===e.charCodeAt(i)?(r.line++,r.column=0,i+1===a?(s=null,n=!1):n&&o.addMapping({source:t.source,original:{line:t.line,column:t.column},generated:{line:r.line,column:r.column},name:t.name})):r.column++}),this.walkSourceContents(function(e,t){o.setSourceContent(e,t)}),{code:r.code,map:o}}}return j.SourceNode=n,j}().SourceNode),g}var q=V();function z(e){return null==e?"":(e+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}let X=class{static get consumer(){var e;if(void 0===this._consumer)try{const e=require("main.js.map");let t;if("string"==typeof e)try{t=JSON.parse(e)}catch(e){return console.error("Failed to parse source map JSON: "+(e instanceof Error?e.message:e+"")),this._consumer=null,this._sourceMapAvailable=!1,null}else t=e;try{this._consumer=new q.SourceMapConsumer(t),this._sourceMapAvailable=!0}catch(e){console.log("SourceMapConsumer requires async initialization - source maps disabled"),this._consumer=null,this._sourceMapAvailable=!1}}catch(e){this._consumer=null,this._sourceMapAvailable=!1}return null!==(e=this._consumer)&&void 0!==e?e:null}static sourceMappedStackTrace(e){const t=e instanceof Error?e.stack:e;if({}.hasOwnProperty.call(this.cache,t))return this.cache[t];const r=this.consumer;if(!r){const r=e.toString();return this.cache[t]=r,r}const o=/^\s+at\s+(.+?\s+)?\(?([0-z._\-\\\/]+):(\d+):(\d+)\)?$/gm;let n,s=e.toString();for(;(n=o.exec(t))&&"main"===n[2];){const e=r.originalPositionFor({column:parseInt(n[4],10),line:parseInt(n[3],10)});if(null==e.line)break;e.name?s+=`\n    at ${e.name} (${e.source}:${e.line}:${e.column})`:n[1]?s+=`\n    at ${n[1]} (${e.source}:${e.line}:${e.column})`:s+=`\n    at ${e.source}:${e.line}:${e.column}`}return this.cache[t]=s,s}static wrapLoop(e){return()=>{try{e()}catch(e){if(!(e instanceof Error))throw e;"sim"in Game.rooms?console.log(`<span style='color:red'>Source maps don't work in the simulator - displaying original error<br>${z(e.stack)}</span>`):console.log(`<span style='color:red'>${z(this.sourceMappedStackTrace(e))}</span>`)}}}};function Q(e,t,r,o){var n,s=arguments.length,i=3>s?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(3>s?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i}var Z;X.cache={},"function"==typeof SuppressedError&&SuppressedError,function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.NONE=4]="NONE"}(Z||(Z={}));let J={level:Z.INFO,cpuLogging:!1};function ee(e){J={...J,...e}}function te(){return{...J}}const re=new Set(["type","level","message","tick","subsystem","room","creep","processId","shard"]);function oe(e,t,r,o="log"){const n={type:o,level:e,message:t,tick:"undefined"!=typeof Game?Game.time:0,shard:"undefined"!=typeof Game&&Game.shard?Game.shard.name:"shard0"};if(r&&(r.shard&&(n.shard=r.shard),r.subsystem&&(n.subsystem=r.subsystem),r.room&&(n.room=r.room),r.creep&&(n.creep=r.creep),r.processId&&(n.processId=r.processId),r.meta))for(const e in r.meta)re.has(e)||(n[e]=r.meta[e]);return JSON.stringify(n)}function ne(e,t){J.level>Z.DEBUG||console.log(oe("DEBUG",e,t))}function se(e,t){J.level>Z.INFO||console.log(oe("INFO",e,t))}function ie(e,t){J.level>Z.WARN||console.log(oe("WARN",e,t))}function ae(e,t){J.level>Z.ERROR||console.log(oe("ERROR",e,t))}function ce(e,t,r){if(!J.cpuLogging)return t();const o=Game.cpu.getUsed(),n=t();return ne(`${e}: ${(Game.cpu.getUsed()-o).toFixed(3)} CPU`,r),n}const le=new Set(["type","key","value","tick","unit","subsystem","room","shard"]);function ue(e,t,r,o){const n={type:"stat",key:e,value:t,tick:"undefined"!=typeof Game?Game.time:0,shard:"undefined"!=typeof Game&&Game.shard?Game.shard.name:"shard0"};if(r&&(n.unit=r),o&&(o.shard&&(n.shard=o.shard),o.subsystem&&(n.subsystem=o.subsystem),o.room&&(n.room=o.room),o.meta))for(const e in o.meta)le.has(e)||(n[e]=o.meta[e]);console.log(JSON.stringify(n))}function me(e){return{debug:(t,r)=>{ne(t,"string"==typeof r?{subsystem:e,room:r}:{subsystem:e,...r})},info:(t,r)=>{se(t,"string"==typeof r?{subsystem:e,room:r}:{subsystem:e,...r})},warn:(t,r)=>{ie(t,"string"==typeof r?{subsystem:e,room:r}:{subsystem:e,...r})},error:(t,r)=>{ae(t,"string"==typeof r?{subsystem:e,room:r}:{subsystem:e,...r})},stat:(t,r,o,n)=>{ue(t,r,o,"string"==typeof n?{subsystem:e,room:n}:{subsystem:e,...n})},measureCpu:(t,r,o)=>ce(t,r,"string"==typeof o?{subsystem:e,room:o}:{subsystem:e,...o})}}const de={debug:ne,info:se,warn:ie,error:ae,stat:ue,measureCpu:ce,configure:ee,getConfig:te,createLogger:me};var pe=Object.freeze({__proto__:null,get LogLevel(){return Z},configureLogger:ee,createLogger:me,debug:ne,error:ae,getLoggerConfig:te,info:se,logger:de,measureCpu:ce,stat:ue,warn:ie});const ge=[],fe=new class{constructor(){this.commands=new Map,this.initialized=!1,this.lazyLoadEnabled=!1,this.commandsRegistered=!1,this.commandsExposed=!1}register(e,t){var r;this.commands.has(e.name)&&de.warn(`Command "${e.name}" is already registered, overwriting`,{subsystem:"CommandRegistry"}),this.commands.set(e.name,{metadata:{...e,category:null!==(r=e.category)&&void 0!==r?r:"General"},handler:t}),de.debug(`Registered command "${e.name}"`,{subsystem:"CommandRegistry"})}unregister(e){const t=this.commands.delete(e);return t&&de.debug(`Unregistered command "${e}"`,{subsystem:"CommandRegistry"}),t}getCommand(e){return this.lazyLoadEnabled&&!this.commandsRegistered&&this.triggerLazyLoad(),this.commands.get(e)}getCommands(){return this.lazyLoadEnabled&&!this.commandsRegistered&&this.triggerLazyLoad(),Array.from(this.commands.values())}getCommandsByCategory(){var e,t;this.lazyLoadEnabled&&!this.commandsRegistered&&this.triggerLazyLoad();const r=new Map;for(const o of this.commands.values()){const n=null!==(e=o.metadata.category)&&void 0!==e?e:"General",s=null!==(t=r.get(n))&&void 0!==t?t:[];s.push(o),r.set(n,s)}for(const[e,t]of r)r.set(e,t.sort((e,t)=>e.metadata.name.localeCompare(t.metadata.name)));return r}execute(e,...t){this.lazyLoadEnabled&&!this.commandsRegistered&&this.triggerLazyLoad();const r=this.commands.get(e);if(!r)return`Command "${e}" not found. Use help() to see available commands.`;try{return r.handler(...t)}catch(t){const r=t instanceof Error?t.message:t+"";return de.error(`Error executing command "${e}": ${r}`,{subsystem:"CommandRegistry"}),"Error: "+r}}generateHelp(){var e;const t=this.getCommandsByCategory(),r=["=== Available Console Commands ===",""],o=Array.from(t.keys()).sort((e,t)=>"General"===e?-1:"General"===t?1:e.localeCompare(t));for(const n of o){const o=t.get(n);if(o&&0!==o.length){r.push(`--- ${n} ---`);for(const t of o){const o=null!==(e=t.metadata.usage)&&void 0!==e?e:t.metadata.name+"()";if(r.push("  "+o),r.push("    "+t.metadata.description),t.metadata.examples&&t.metadata.examples.length>0){r.push("    Examples:");for(const e of t.metadata.examples)r.push("      "+e)}r.push("")}}}return r.join("\n")}generateCommandHelp(e){var t,r;this.lazyLoadEnabled&&!this.commandsRegistered&&this.triggerLazyLoad();const o=this.commands.get(e);if(!o)return`Command "${e}" not found. Use help() to see available commands.`;const n=[`=== ${o.metadata.name} ===`,"","Description: "+o.metadata.description,"Usage: "+(null!==(t=o.metadata.usage)&&void 0!==t?t:o.metadata.name+"()"),"Category: "+(null!==(r=o.metadata.category)&&void 0!==r?r:"General")];if(o.metadata.examples&&o.metadata.examples.length>0){n.push(""),n.push("Examples:");for(const e of o.metadata.examples)n.push("  "+e)}return n.join("\n")}exposeToGlobal(){const e=global;if(!this.commandsExposed||this.lazyLoadEnabled&&this.commandsRegistered){for(const[t,r]of this.commands)e[t]=r.handler;this.commandsExposed=!0,de.debug(`Exposed ${this.commands.size} commands to global scope`,{subsystem:"CommandRegistry"})}e.help=e=>(this.lazyLoadEnabled&&!this.commandsRegistered&&this.triggerLazyLoad(),e?this.generateCommandHelp(e):this.generateHelp())}initialize(){this.initialized||(this.register({name:"help",description:"Show available commands and their descriptions",usage:"help() or help('commandName')",examples:["help()","help('setLogLevel')"],category:"System"},(...e)=>{const t=e[0];return void 0!==t?this.generateCommandHelp(t+""):this.generateHelp()}),this.initialized=!0,de.info("Command registry initialized",{subsystem:"CommandRegistry"}))}enableLazyLoading(e){this.lazyLoadEnabled=!0,this.registrationCallback=e,de.info("Console commands lazy loading enabled",{subsystem:"CommandRegistry"})}triggerLazyLoad(){!this.commandsRegistered&&this.registrationCallback&&(de.debug("Lazy loading console commands on first access",{subsystem:"CommandRegistry"}),this.commandsRegistered=!0,this.registrationCallback(),this.exposeToGlobal())}getCommandCount(){return this.commands.size}isInitialized(){return this.initialized}reset(){this.commands.clear(),this.initialized=!1,this.lazyLoadEnabled=!1,this.commandsRegistered=!1,this.commandsExposed=!1,this.registrationCallback=void 0}};function he(e){return function(t,r,o){ge.push({metadata:e,methodName:r+"",target:t})}}function ye(e){const t=Object.getPrototypeOf(e);for(const r of ge)if(Re(r.target,t)){const t=e[r.methodName];if("function"==typeof t){const o=t.bind(e);fe.register(r.metadata,o),de.debug(`Registered decorated command "${r.metadata.name}"`,{subsystem:"CommandRegistry"})}}}function Re(e,t){return null!==t&&(e===t||Object.getPrototypeOf(e)===t||e===Object.getPrototypeOf(t))}var Ee;!function(e){e[e.CRITICAL=100]="CRITICAL",e[e.HIGH=75]="HIGH",e[e.NORMAL=50]="NORMAL",e[e.LOW=25]="LOW",e[e.BACKGROUND=10]="BACKGROUND"}(Ee||(Ee={}));const Te={"hostile.detected":Ee.CRITICAL,"nuke.detected":Ee.CRITICAL,"safemode.activated":Ee.CRITICAL,"structure.destroyed":Ee.HIGH,"hostile.cleared":Ee.HIGH,"creep.died":Ee.HIGH,"energy.critical":Ee.HIGH,"spawn.emergency":Ee.HIGH,"posture.change":Ee.HIGH,"spawn.completed":Ee.NORMAL,"rcl.upgrade":Ee.NORMAL,"construction.complete":Ee.NORMAL,"remote.lost":Ee.NORMAL,"squad.formed":Ee.NORMAL,"squad.dissolved":Ee.NORMAL,"market.transaction":Ee.LOW,"pheromone.update":Ee.LOW,"cluster.update":Ee.LOW,"expansion.candidate":Ee.LOW,"powerbank.discovered":Ee.LOW,"cpu.spike":Ee.BACKGROUND,"bucket.modeChange":Ee.BACKGROUND},Ce={maxEventsPerTick:50,maxQueueSize:200,lowBucketThreshold:2e3,criticalBucketThreshold:1e3,maxEventAge:100,enableLogging:!1,statsLogInterval:100},ve=new class{constructor(e={}){this.handlers=new Map,this.eventQueue=[],this.handlerIdCounter=0,this.stats={eventsEmitted:0,eventsProcessed:0,eventsDeferred:0,eventsDropped:0,handlersInvoked:0},this.config={...Ce,...e}}on(e,t,r={}){var o,n,s,i;const a={handler:t,priority:null!==(o=r.priority)&&void 0!==o?o:Ee.NORMAL,minBucket:null!==(n=r.minBucket)&&void 0!==n?n:0,once:null!==(s=r.once)&&void 0!==s&&s,id:"handler_"+ ++this.handlerIdCounter},c=null!==(i=this.handlers.get(e))&&void 0!==i?i:[];return c.push(a),c.sort((e,t)=>t.priority-e.priority),this.handlers.set(e,c),this.config.enableLogging&&de.debug(`EventBus: Registered handler for "${e}" (id: ${a.id})`,{subsystem:"EventBus"}),()=>this.off(e,a.id)}once(e,t,r={}){return this.on(e,t,{...r,once:!0})}off(e,t){const r=this.handlers.get(e);if(r){const o=r.findIndex(e=>e.id===t);-1!==o&&(r.splice(o,1),this.config.enableLogging&&de.debug(`EventBus: Unregistered handler "${t}" from "${e}"`,{subsystem:"EventBus"}))}}offAll(e){this.handlers.delete(e),this.config.enableLogging&&de.debug(`EventBus: Removed all handlers for "${e}"`,{subsystem:"EventBus"})}emit(e,t,r={}){var o,n,s;const i={...t,tick:Game.time},a=null!==(n=null!==(o=r.priority)&&void 0!==o?o:Te[e])&&void 0!==n?n:Ee.NORMAL,c=null!==(s=r.immediate)&&void 0!==s?s:a>=Ee.CRITICAL;this.stats.eventsEmitted++,this.config.enableLogging&&de.debug(`EventBus: Emitting "${e}" (priority: ${a}, immediate: ${c+""})`,{subsystem:"EventBus"});const l=Game.cpu.bucket;c||l>=this.config.lowBucketThreshold?this.processEvent(e,i):l<this.config.criticalBucketThreshold?a<Ee.CRITICAL?(this.stats.eventsDropped++,this.config.enableLogging&&de.warn(`EventBus: Dropped event "${e}" due to critical bucket`,{subsystem:"EventBus"})):this.processEvent(e,i):this.queueEvent(e,i,a)}processEvent(e,t){const r=this.handlers.get(e);if(!r||0===r.length)return;const o=Game.cpu.bucket,n=[];for(const s of r)if(o>=s.minBucket)try{s.handler(t),this.stats.handlersInvoked++,s.once&&n.push(s.id)}catch(t){const r=t instanceof Error?t.message:t+"";de.error(`EventBus: Handler error for "${e}": ${r}`,{subsystem:"EventBus"})}for(const t of n)this.off(e,t);this.stats.eventsProcessed++}queueEvent(e,t,r){if(this.eventQueue.length>=this.config.maxQueueSize){const e=this.eventQueue.map((e,t)=>({event:e,index:t})).filter(({event:e})=>e.priority<Ee.HIGH).sort((e,t)=>e.event.queuedAt-t.event.queuedAt)[0];if(!e||e.event.priority>=r)return void this.stats.eventsDropped++;this.eventQueue.splice(e.index,1),this.stats.eventsDropped++}const o={name:e,payload:t,priority:r,queuedAt:Game.time};this.eventQueue.push(o),this.eventQueue.sort((e,t)=>t.priority!==e.priority?t.priority-e.priority:e.queuedAt-t.queuedAt),this.stats.eventsDeferred++}processQueue(){const e=Game.cpu.bucket;if(e<this.config.criticalBucketThreshold)return;let t=this.config.maxEventsPerTick;e<this.config.lowBucketThreshold&&(t=Math.floor(t/2));const r=Game.time;this.eventQueue=this.eventQueue.filter(e=>r-e.queuedAt<=this.config.maxEventAge||(this.stats.eventsDropped++,!1));let o=0;for(;this.eventQueue.length>0&&t>o;){const e=this.eventQueue.shift();e&&(this.processEvent(e.name,e.payload),o++)}}getStats(){let e=0;for(const t of this.handlers.values())e+=t.length;return{...this.stats,queueSize:this.eventQueue.length,handlerCount:e}}resetStats(){this.stats={eventsEmitted:0,eventsProcessed:0,eventsDeferred:0,eventsDropped:0,handlersInvoked:0}}getConfig(){return{...this.config}}updateConfig(e){this.config={...this.config,...e}}clear(){this.handlers.clear(),this.eventQueue=[],this.resetStats()}getHandlerCount(e){var t,r;return null!==(r=null===(t=this.handlers.get(e))||void 0===t?void 0:t.length)&&void 0!==r?r:0}hasHandlers(e){return this.getHandlerCount(e)>0}logStats(){if(Game.time%this.config.statsLogInterval===0){const e=this.getStats();de.debug(`EventBus stats: ${e.eventsEmitted} emitted, ${e.eventsProcessed} processed, ${e.eventsDeferred} deferred, ${e.eventsDropped} dropped, ${e.queueSize} queued, ${e.handlerCount} handlers`,{subsystem:"EventBus"})}}};let Se={pheromone:{updateInterval:5,decayFactors:{expand:.95,harvest:.9,build:.92,upgrade:.93,defense:.97,war:.98,siege:.99,logistics:.91,nukeTarget:.99},diffusionRates:{expand:.3,harvest:.1,build:.15,upgrade:.1,defense:.4,war:.5,siege:.6,logistics:.2,nukeTarget:.1},maxValue:100,minValue:0},war:{dangerThresholds:{level1HostileCount:1,level2HostileCount:3,level2DamageThreshold:100,level3DamageThreshold:500},postureThresholds:{defensivePosture:30,warPosture:50,expandPosture:40},economyStabilityRatio:1.2,warSustainedTicks:100},nuke:{minEnemyRCL:5,minThreatLevel:2,minNukeScore:35,scoring:{enemyRCLWeight:2,hostileStructuresWeight:3,warPheromoneWeight:1.5,distancePenalty:.5},evaluationInterval:200},expansion:{minEnergySurplus:1e3,minBucketForClaim:8e3,maxRemoteDistance:2,maxClaimDistance:5,scoring:{sourcesWeight:20,mineralWeight:10,distancePenalty:5,hostilePenalty:30,terrainPenalty:2,highwayBonus:15}},cpu:{bucketThresholds:{lowMode:2e3,highMode:9e3},budgets:{rooms:.4,creeps:.3,strategic:.1,market:.1,visualization:.1},taskFrequencies:{pheromoneUpdate:5,clusterLogic:10,strategicDecisions:20,marketScan:100,nukeEvaluation:200,memoryCleanup:50}},market:{maxCreditsPerTick:1e5,minCreditReserve:5e4,safetyBuffer:{energy:5e4,baseMinerals:5e3},priceTolerance:{buy:.1,sell:.1,emergency:.5},scanInterval:100,tradeCooldown:10},spawn:{bodyCosts:{[MOVE]:50,[WORK]:100,[CARRY]:50,[ATTACK]:80,[RANGED_ATTACK]:150,[HEAL]:250,[CLAIM]:600,[TOUGH]:10},minCreepCounts:{harvester:2,hauler:2,upgrader:1,builder:1},rolePriorities:{harvester:100,hauler:90,queenCarrier:85,builder:70,upgrader:60,guard:80,healer:75,scout:40,claimer:50}},boost:{roleBoosts:{harvester:["UO"],upgrader:["GH","GH2O","XGH2O"],guard:["UH","LO"],healer:["LO","LHO2","XLHO2"],soldier:["UH","KO","XZHO2"]},boostPriority:["XLHO2","XUH2O","XZHO2","XGH2O"],minBoostAmount:30},debug:!1,profiling:!0,visualizations:!0,lazyLoadConsoleCommands:!0};function _e(){return Se}function be(e){Se={...Se,...e}}var Oe,Ue={},Me={},Ae={};function we(){if(Oe)return Ae;function e(e){return{debug:(t,...r)=>console.log(`[${e}]`,t,...r),info:(t,...r)=>console.log(`[${e}]`,t,...r),warn:(t,...r)=>console.log(`[${e}] WARN:`,t,...r),error:(t,...r)=>console.log(`[${e}] ERROR:`,t,...r)}}var t,r;return Oe=1,Object.defineProperty(Ae,"__esModule",{value:!0}),Ae.globalCache=Ae.shardManager=Ae.VisualizationLayer=Ae.PheromoneState=Ae.memoryManager=Ae.logger=void 0,Ae.createLogger=e,Ae.getRoomFindCacheStats=function(){return{rooms:0,totalEntries:0,hits:0,misses:0,invalidations:0,size:0,hitRate:0}},Ae.getBodyPartCacheStats=function(){return{hits:0,misses:0,size:0,hitRate:0}},Ae.getObjectCacheStats=function(){return{hits:0,misses:0,size:0,hitRate:0}},Ae.getPathCacheStats=function(){return{hits:0,misses:0,size:0,maxSize:0,evictions:0,hitRate:0}},Ae.getRoleCacheStats=function(){return{totalEntries:0}},Ae.logger=e("stats"),Ae.memoryManager={getRoomMemory:e=>Memory.rooms?.[e]||{},getCreepMemory:e=>Memory.creeps?.[e]||{},getAllRoomMemories:()=>{const e=new Map;if(Memory.rooms)for(const[t,r]of Object.entries(Memory.rooms))e.set(t,r);return e},getSwarmState:e=>({})},function(e){e.ACTIVE="active",e.DECAY="decay",e.INACTIVE="inactive"}(t||(Ae.PheromoneState=t={})),function(e){e.PHEROMONES="pheromones",e.PATHS="paths",e.TARGETS="targets",e.DEBUG="debug"}(r||(Ae.VisualizationLayer=r={})),Ae.shardManager={getCurrentShard:()=>Game.shard?.name||"shard0",getAllShards:()=>[Game.shard?.name||"shard0"],getCurrentShardState:()=>({})},Ae.globalCache={getCacheStats:()=>({hits:0,misses:0,hitRate:0,size:0,evictions:0})},Ae}var ke,Ne={};function Pe(){return ke||(ke=1,function(e){function t(e,t){const{minRooms:r,scaleFactor:o,maxMultiplier:n}=t.roomScaling;return Math.max(1,Math.min(n,1+Math.log(Math.max(e,r)/r)/Math.log(o)))}function r(e,t){const{highThreshold:r,lowThreshold:o,criticalThreshold:n,highMultiplier:s,lowMultiplier:i,criticalMultiplier:a}=t.bucketMultipliers;return r>e?n>e?a:o>e?i:1:s}function o(o,n,s,i=e.DEFAULT_ADAPTIVE_CONFIG){const a=i.baseFrequencyBudgets[o],c=t(n,i),l=r(s,i);return Math.max(.01,Math.min(1,a*c*l))}function n(t,r,n=e.DEFAULT_ADAPTIVE_CONFIG){return{high:o("high",t,r,n),medium:o("medium",t,r,n),low:o("low",t,r,n)}}function s(){const e=Object.keys(Game.rooms).length;return Math.max(1,e)}function i(){return Game.cpu.bucket}Object.defineProperty(e,"__esModule",{value:!0}),e.DEFAULT_ADAPTIVE_CONFIG=void 0,e.calculateRoomScalingMultiplier=t,e.calculateBucketMultiplier=r,e.calculateAdaptiveBudget=o,e.calculateAdaptiveBudgets=n,e.getCurrentRoomCount=s,e.getCurrentBucket=i,e.getAdaptiveBudgets=function(t=e.DEFAULT_ADAPTIVE_CONFIG){return n(s(),i(),t)},e.getAdaptiveBudgetInfo=function(o=e.DEFAULT_ADAPTIVE_CONFIG){const a=s(),c=i();return{roomCount:a,bucket:c,roomMultiplier:t(a,o),bucketMultiplier:r(c,o),budgets:n(a,c,o),baseBudgets:o.baseFrequencyBudgets}},e.DEFAULT_ADAPTIVE_CONFIG={baseFrequencyBudgets:{high:.25,medium:.06,low:.05},roomScaling:{minRooms:1,scaleFactor:20,maxMultiplier:2.5},bucketMultipliers:{highThreshold:9e3,lowThreshold:2e3,criticalThreshold:500,highMultiplier:1.2,lowMultiplier:.6,criticalMultiplier:.3}}}(Ne)),Ne}var Ie,xe,$e={};function Ge(){return Ie||(Ie=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.pathfindingMetrics=void 0,e.trackPathfindingCall=function(t,r,o){const n=Game.cpu.getUsed(),s=o(),i=Game.cpu.getUsed()-n;return e.pathfindingMetrics.recordCall(t,r,i),s},e.pathfindingMetrics=new class{metrics={totalCalls:0,cacheHits:0,cacheMisses:0,cacheHitRate:0,cpuUsed:0,avgCpuPerCall:0,cpuSaved:0,callsByType:{moveTo:0,pathFinderSearch:0,findPath:0,moveByPath:0}};recordCall(e,t,r){if(this.metrics.totalCalls++,this.metrics.callsByType[e]++,this.metrics.cpuUsed+=r,t){this.metrics.cacheHits++;const e=Math.max(.5-r,0);this.metrics.cpuSaved+=e}else this.metrics.cacheMisses++}getMetrics(){return this.metrics.cacheHitRate=this.metrics.totalCalls>0?this.metrics.cacheHits/this.metrics.totalCalls:0,this.metrics.avgCpuPerCall=this.metrics.totalCalls>0?this.metrics.cpuUsed/this.metrics.totalCalls:0,{...this.metrics}}reset(){this.metrics={totalCalls:0,cacheHits:0,cacheMisses:0,cacheHitRate:0,cpuUsed:0,avgCpuPerCall:0,cpuSaved:0,callsByType:{moveTo:0,pathFinderSearch:0,findPath:0,moveByPath:0}}}}}($e)),$e}var Le,De,Fe,Be,He={},We={},Ye=(Fe||(Fe=1,function(e){var t=Ue&&Ue.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),r=Ue&&Ue.__exportStar||function(e,r){for(var o in e)"default"===o||{}.hasOwnProperty.call(r,o)||t(r,e,o)};Object.defineProperty(e,"__esModule",{value:!0}),e.VisualizationLayer=e.DEFAULT_ADAPTIVE_CONFIG=e.calculateAdaptiveBudgets=e.calculateAdaptiveBudget=e.getAdaptiveBudgets=e.getAdaptiveBudgetInfo=e.calculateBucketMultiplier=e.calculateRoomScalingMultiplier=e.trackPathfindingCall=e.pathfindingMetrics=e.memorySegmentStats=e.MemorySegmentStats=e.unifiedStats=e.UnifiedStatsManager=void 0;var o=function(){if(xe)return Me;xe=1,Object.defineProperty(Me,"__esModule",{value:!0}),Me.unifiedStats=Me.UnifiedStatsManager=void 0;const e=we(),t=Pe(),r=Ge(),o={enabled:!0,smoothingFactor:.1,trackNativeCalls:!0,logInterval:100,segmentUpdateInterval:10,segmentId:90,maxHistoryPoints:1e3,budgetLimits:{ecoRoom:.1,warRoom:.25,overmind:1},budgetAlertThresholds:{warning:.8,critical:1},anomalyDetection:{enabled:!0,spikeThreshold:2,minSamples:10}};class n{config;currentSnapshot;nativeCallsThisTick;subsystemMeasurements=new Map;roomMeasurements=new Map;lastSegmentUpdate=0;segmentRequested=!1;skippedProcessesThisTick=0;constructor(e={}){this.config={...o,...e},this.currentSnapshot=this.createEmptySnapshot(),this.nativeCallsThisTick=this.createEmptyNativeCalls()}initialize(){void 0===RawMemory.segments[this.config.segmentId]&&(RawMemory.setActiveSegments([this.config.segmentId]),this.segmentRequested=!0),e.logger.info("Unified stats system initialized",{subsystem:"Stats"})}preserveRoomStats(){const e=this.currentSnapshot?.rooms;if(!e)return{};const t={};for(const r in e)({}).hasOwnProperty.call(e,r)&&Game.rooms[r]&&(t[r]=e[r]);return t}startTick(){if(!this.config.enabled)return;RawMemory.setActiveSegments([this.config.segmentId]),this.segmentRequested=!0;const e=this.preserveRoomStats();this.currentSnapshot=this.createEmptySnapshot(),this.currentSnapshot.rooms=e,this.nativeCallsThisTick=this.createEmptyNativeCalls(),this.subsystemMeasurements.clear(),this.roomMeasurements.clear(),this.skippedProcessesThisTick=0,r.pathfindingMetrics.reset()}finalizeTick(){if(!this.config.enabled)return;this.currentSnapshot.cpu={used:Game.cpu.getUsed(),limit:Game.cpu.limit,bucket:Game.cpu.bucket,percent:Game.cpu.limit>0?Game.cpu.getUsed()/Game.cpu.limit*100:0,heapUsed:(Game.cpu.getHeapStatistics?.()?.used_heap_size??0)/1024/1024},this.currentSnapshot.progression={gcl:{level:Game.gcl.level,progress:Game.gcl.progress,progressTotal:Game.gcl.progressTotal,progressPercent:Game.gcl.progressTotal>0?Game.gcl.progress/Game.gcl.progressTotal*100:0},gpl:{level:Game.gpl?.level??0,progress:Game.gpl?.progress??0,progressTotal:Game.gpl?.progressTotal??0,progressPercent:(Game.gpl?.progressTotal??0)>0?(Game.gpl?.progress??0)/(Game.gpl?.progressTotal??0)*100:0}},this.finalizeEmpireStats(),this.finalizeSubsystemStats(),this.finalizeCacheStats(),this.finalizePathfindingStats(),this.currentSnapshot.native={...this.nativeCallsThisTick},this.finalizeCreepStats(),this.currentSnapshot.tick=Game.time,this.currentSnapshot.timestamp=Date.now();const t=this.validateBudgets(),r=this.detectAnomalies();if(t.alerts.length>0){const r=t.alerts.filter(e=>"critical"===e.severity),o=t.alerts.filter(e=>"warning"===e.severity);r.length>0&&e.logger.error(`CPU Budget: ${r.length} critical violations detected`,{subsystem:"CPUBudget",meta:{violations:r.map(e=>`${e.target}: ${(100*e.percentUsed).toFixed(1)}% (${e.cpuUsed.toFixed(3)}/${e.budgetLimit})`)}}),o.length>0&&e.logger.warn(`CPU Budget: ${o.length} warnings (80% of limit)`,{subsystem:"CPUBudget",meta:{warnings:o.map(e=>`${e.target}: ${(100*e.percentUsed).toFixed(1)}%`)}})}r.length>0&&e.logger.warn(`CPU Anomalies: ${r.length} detected`,{subsystem:"CPUProfiler",meta:{anomalies:r.map(e=>`${e.target} (${e.type}): ${e.current.toFixed(3)} CPU (${e.multiplier.toFixed(1)}x baseline)${e.context?" - "+e.context:""}`)}}),this.publishToMemory(),this.publishToConsole(),Game.time-this.lastSegmentUpdate<this.config.segmentUpdateInterval||(this.updateSegment(),this.lastSegmentUpdate=Game.time),this.config.logInterval>0&&Game.time%this.config.logInterval===0&&this.logSummary()}startRoom(e){return this.config.enabled?Game.cpu.getUsed():0}endRoom(e,t){if(!this.config.enabled)return;const r=Game.cpu.getUsed()-t;this.roomMeasurements.set(e,r)}measureSubsystem(e,t){if(!this.config.enabled)return t();const r=Game.cpu.getUsed(),o=t(),n=Game.cpu.getUsed()-r,s=this.subsystemMeasurements.get(e)??[];return s.push(n),this.subsystemMeasurements.set(e,s),o}recordNativeCall(e){this.config.enabled&&this.config.trackNativeCalls&&(this.nativeCallsThisTick[e]++,this.nativeCallsThisTick.total++)}recordProcess(e){this.config.enabled&&(this.currentSnapshot.processes[e.id]={id:e.id,name:e.name,priority:e.priority,frequency:e.frequency,state:e.state,totalCpu:e.stats.totalCpu,runCount:e.stats.runCount,avgCpu:e.stats.avgCpu,maxCpu:e.stats.maxCpu,lastRunTick:e.stats.lastRunTick,skippedCount:e.stats.skippedCount,errorCount:e.stats.errorCount,cpuBudget:e.cpuBudget,minBucket:e.minBucket,tickModulo:e.tickModulo,tickOffset:e.tickOffset})}collectProcessStats(e){this.config.enabled&&e.forEach(e=>{this.recordProcess(e)})}setSkippedProcesses(e){this.config.enabled&&(this.skippedProcessesThisTick=Math.max(0,e))}collectKernelBudgetStats(e){if(!this.config.enabled)return;const r=e.getConfig();if(r.enableAdaptiveBudgets){const o=Object.keys(Game.rooms).length,n=Game.cpu.bucket,s=e.getProcesses().reduce((e,t)=>e+t.cpuBudget,0),i=e.getTickCpuUsed(),a=s>0?i/s:0;this.currentSnapshot.kernelBudgets={adaptiveBudgetsEnabled:!0,roomCount:o,roomMultiplier:(0,t.calculateRoomScalingMultiplier)(o,r.adaptiveBudgetConfig),bucketMultiplier:(0,t.calculateBucketMultiplier)(n,r.adaptiveBudgetConfig),budgets:{high:r.frequencyCpuBudgets.high||0,medium:r.frequencyCpuBudgets.medium||0,low:r.frequencyCpuBudgets.low||0},totalAllocated:s,totalUsed:i,utilizationRatio:a}}else{const t=e.getProcesses().reduce((e,t)=>e+t.cpuBudget,0),o=e.getTickCpuUsed();this.currentSnapshot.kernelBudgets={adaptiveBudgetsEnabled:!1,roomCount:Object.keys(Game.rooms).length,roomMultiplier:1,bucketMultiplier:1,budgets:{high:r.frequencyCpuBudgets.high||0,medium:r.frequencyCpuBudgets.medium||0,low:r.frequencyCpuBudgets.low||0},totalAllocated:t,totalUsed:o,utilizationRatio:t>0?o/t:0}}}recordCreep(e,t,r,o=0){if(!this.config.enabled)return;const n=e.memory;this.currentSnapshot.creeps[e.name]={name:e.name,role:n.role??"unknown",homeRoom:n.homeRoom??e.room.name,currentRoom:e.room.name,cpu:t,action:r,ticksToLive:e.ticksToLive??0,hits:e.hits,hitsMax:e.hitsMax,bodyParts:e.body.length,fatigue:e.fatigue,actionsThisTick:o}}recordRoom(t,r){if(!this.config.enabled)return;const o=e.memoryManager.getSwarmState(t.name),n=Object.values(Game.creeps).filter(e=>e.room.name===t.name).length,s=t.find(FIND_HOSTILE_CREEPS);let i=this.currentSnapshot.rooms[t.name];if(i||(i={name:t.name,rcl:t.controller?.level??0,energy:{available:t.energyAvailable,capacity:t.energyCapacityAvailable,storage:t.storage?.store.getUsedCapacity(RESOURCE_ENERGY)??0,terminal:t.terminal?.store.getUsedCapacity(RESOURCE_ENERGY)??0},controller:{progress:t.controller?.progress??0,progressTotal:t.controller?.progressTotal??1,progressPercent:0},creeps:n,hostiles:s.length,brain:{danger:o?.danger??0,postureCode:this.postureToCode(o?.posture??"eco"),colonyLevelCode:this.colonyLevelToCode(o?.colonyLevel??"seedNest")},pheromones:{},metrics:{energyHarvested:0,energySpawning:0,energyConstruction:0,energyRepair:0,energyTower:0,energyAvailableForSharing:0,energyCapacityTotal:0,energyNeed:0,controllerProgress:0,hostileCount:s.length,damageReceived:0,constructionSites:0},profiler:{avgCpu:r,peakCpu:r,samples:1}},this.currentSnapshot.rooms[t.name]=i),i.controller.progressPercent=i.controller.progressTotal>0?i.controller.progress/i.controller.progressTotal*100:0,o){for(const[e,t]of Object.entries(o.pheromones))i.pheromones[e]=t;i.metrics={energyHarvested:o.metrics.energyHarvested,energySpawning:o.metrics.energySpawning,energyConstruction:o.metrics.energyConstruction,energyRepair:o.metrics.energyRepair,energyTower:o.metrics.energyTower,energyAvailableForSharing:o.metrics.energyAvailable,energyCapacityTotal:o.metrics.energyCapacity,energyNeed:o.metrics.energyNeed,controllerProgress:o.metrics.controllerProgress,hostileCount:o.metrics.hostileCount,damageReceived:o.metrics.damageReceived,constructionSites:o.metrics.constructionSites}}const a=this.getProfilerMemory().rooms[t.name];a&&(i.profiler.avgCpu=a.avgCpu*(1-this.config.smoothingFactor)+r*this.config.smoothingFactor,i.profiler.peakCpu=Math.max(a.peakCpu,r),i.profiler.samples=a.samples+1),this.getProfilerMemory().rooms[t.name]={avgCpu:i.profiler.avgCpu,peakCpu:i.profiler.peakCpu,samples:i.profiler.samples,lastTick:Game.time}}isWarRoom(t){const r=e.memoryManager.getSwarmState(t);return!(!r||"war"!==r.posture&&"siege"!==r.posture&&2>r.danger)}validateBudgets(){const e={roomsEvaluated:0,roomsWithinBudget:0,roomsOverBudget:0,alerts:[],anomalies:[],tick:Game.time};for(const[t,r]of Object.entries(this.currentSnapshot.rooms)){e.roomsEvaluated++;const o=this.isWarRoom(t)?this.config.budgetLimits.warRoom:this.config.budgetLimits.ecoRoom,n=r.profiler.avgCpu,s=n/o;s<this.config.budgetAlertThresholds.critical?(s<this.config.budgetAlertThresholds.warning||e.alerts.push({severity:"warning",target:t,targetType:"room",cpuUsed:n,budgetLimit:o,percentUsed:s,tick:Game.time}),e.roomsWithinBudget++):(e.roomsOverBudget++,e.alerts.push({severity:"critical",target:t,targetType:"room",cpuUsed:n,budgetLimit:o,percentUsed:s,tick:Game.time}))}return e}detectAnomalies(){if(!this.config.anomalyDetection.enabled)return[];const t=[];for(const[r,o]of Object.entries(this.currentSnapshot.rooms)){if(o.profiler.samples<this.config.anomalyDetection.minSamples)continue;const n=this.roomMeasurements.get(r)??0,s=o.profiler.avgCpu;if(.01>s)continue;const i=n/s;if(i>=this.config.anomalyDetection.spikeThreshold){const o=e.memoryManager.getSwarmState(r),a=o?`RCL ${Game.rooms[r]?.controller?.level??0}, posture: ${o.posture}, danger: ${o.danger}`:void 0;t.push({type:"spike",target:r,targetType:"room",current:n,baseline:s,multiplier:i,tick:Game.time,context:a})}}for(const[e,r]of Object.entries(this.currentSnapshot.processes)){if(r.runCount<this.config.anomalyDetection.minSamples)continue;const o=r.maxCpu,n=r.avgCpu;if(100>=Game.time-r.lastRunTick&&n>=.01&&(o<n*this.config.anomalyDetection.spikeThreshold||t.push({type:"spike",target:e,targetType:"process",current:o,baseline:n,multiplier:o/n,tick:Game.time,context:`${r.name} (${r.frequency})`}),r.cpuBudget>0)){const o=n/r.cpuBudget;1.5>o||t.push({type:"sustained_high",target:e,targetType:"process",current:n,baseline:r.cpuBudget,multiplier:o,tick:Game.time,context:`${r.name} (${r.frequency})`})}}return t}createEmptySnapshot(){return{tick:Game.time,timestamp:Date.now(),cpu:{used:0,limit:0,bucket:0,percent:0,heapUsed:0},progression:{gcl:{level:0,progress:0,progressTotal:1,progressPercent:0},gpl:{level:0,progress:0,progressTotal:0,progressPercent:0}},empire:{rooms:0,creeps:0,powerCreeps:{total:0,spawned:0,eco:0,combat:0},energy:{storage:0,terminal:0,available:0,capacity:0},credits:0,skippedProcesses:0},rooms:{},subsystems:{},roles:{},native:this.createEmptyNativeCalls(),processes:{},creeps:{},kernelBudgets:{adaptiveBudgetsEnabled:!1,roomCount:0,roomMultiplier:1,bucketMultiplier:1,budgets:{high:0,medium:0,low:0},totalAllocated:0,totalUsed:0,utilizationRatio:0},cache:{roomFind:{rooms:0,totalEntries:0,hits:0,misses:0,invalidations:0,hitRate:0},bodyPart:{size:0},object:{size:0},path:{size:0,maxSize:0,hits:0,misses:0,evictions:0,hitRate:0},role:{totalEntries:0},global:{hits:0,misses:0,hitRate:0,size:0,evictions:0}},pathfinding:{totalCalls:0,cacheHits:0,cacheMisses:0,cacheHitRate:0,cpuUsed:0,avgCpuPerCall:0,cpuSaved:0,callsByType:{moveTo:0,pathFinderSearch:0,findPath:0,moveByPath:0}}}}createEmptyNativeCalls(){return{pathfinderSearch:0,moveTo:0,move:0,harvest:0,transfer:0,withdraw:0,build:0,repair:0,upgradeController:0,attack:0,rangedAttack:0,heal:0,dismantle:0,say:0,total:0}}finalizeEmpireStats(){const t=Object.values(this.currentSnapshot.rooms),r=Object.keys(Game.creeps).length,o=Object.values(Game.powerCreeps),n=o.filter(e=>void 0!==e.ticksToLive),s=o.filter(e=>"powerQueen"===e.memory.role),i=o.filter(e=>"powerWarrior"===e.memory.role);let a;try{const t=e.shardManager.getCurrentShardState();t&&(a={name:t.name,role:t.role,cpuUsage:t.health.cpuUsage,cpuCategory:t.health.cpuCategory,bucketLevel:t.health.bucketLevel,economyIndex:t.health.economyIndex,warIndex:t.health.warIndex,avgRCL:t.health.avgRCL,portalsCount:t.portals.length,activeTasksCount:t.activeTasks.length})}catch(e){}this.currentSnapshot.empire={rooms:t.length,creeps:r,powerCreeps:{total:o.length,spawned:n.length,eco:s.length,combat:i.length},energy:{storage:t.reduce((e,t)=>e+t.energy.storage,0),terminal:t.reduce((e,t)=>e+t.energy.terminal,0),available:t.reduce((e,t)=>e+t.energy.available,0),capacity:t.reduce((e,t)=>e+t.energy.capacity,0)},credits:Game.market.credits,skippedProcesses:this.skippedProcessesThisTick,shard:a}}finalizeSubsystemStats(){const e=this.getProfilerMemory();for(const[t,r]of this.subsystemMeasurements){const o=r.reduce((e,t)=>e+t,0),n=t.startsWith("role:"),s=n?t.substring(5):t;if(n){const t=Object.values(Game.creeps).filter(e=>e.memory.role===s),n=t.length;let i=0,a=0,c=0,l=0,u=0;for(const e of t){const t=e.memory,r=t.state?.action??"idle",o=t.working??"idle"!==r;u+=e.body.length,l+=e.ticksToLive??0,e.spawning?i++:o&&"idle"!==r?c++:a++}const m=r.length>0?o/r.length:0,d=e.roles?.[s],p=d?d.avgCpu*(1-this.config.smoothingFactor)+m*this.config.smoothingFactor:m,g=d?Math.max(d.peakCpu,m):m;this.currentSnapshot.roles[s]={name:s,count:n,avgCpu:p,peakCpu:g,calls:r.length,samples:(d?.samples??0)+1,spawningCount:i,idleCount:a,activeCount:c,avgTicksToLive:n>0?l/n:0,totalBodyParts:u},e.roles||(e.roles={}),e.roles[s]={avgCpu:p,peakCpu:g,samples:this.currentSnapshot.roles[s].samples,callsThisTick:r.length}}else{const t=e.subsystems[s],n=t?t.avgCpu*(1-this.config.smoothingFactor)+o*this.config.smoothingFactor:o,i=t?Math.max(t.peakCpu,o):o;this.currentSnapshot.subsystems[s]={name:s,avgCpu:n,peakCpu:i,calls:r.length,samples:(t?.samples??0)+1},e.subsystems[s]={avgCpu:n,peakCpu:i,samples:this.currentSnapshot.subsystems[s].samples,callsThisTick:r.length}}}}finalizeCreepStats(){for(const e of Object.values(Game.creeps))if(!this.currentSnapshot.creeps[e.name]){const t=e.memory,r=t.state?.action??(t.working?"working":"idle");this.currentSnapshot.creeps[e.name]={name:e.name,role:t.role??"unknown",homeRoom:t.homeRoom??e.room.name,currentRoom:e.room.name,cpu:0,action:r,ticksToLive:e.ticksToLive??0,hits:e.hits,hitsMax:e.hitsMax,bodyParts:e.body.length,fatigue:e.fatigue,actionsThisTick:0}}}finalizeCacheStats(){const t=(0,e.getRoomFindCacheStats)(),r=(0,e.getBodyPartCacheStats)(),o=(0,e.getObjectCacheStats)(),n=(0,e.getPathCacheStats)(),s=(0,e.getRoleCacheStats)(),i=e.globalCache.getCacheStats();this.currentSnapshot.cache={roomFind:t,bodyPart:{size:r.size},object:{size:o.size},path:n,role:s,global:i}}finalizePathfindingStats(){this.currentSnapshot.pathfinding=r.pathfindingMetrics.getMetrics()}publishToConsole(){const e=Memory;if(e.stats&&"object"==typeof e.stats){const t={type:"stats",tick:"undefined"!=typeof Game?Game.time:0,data:e.stats};console.log(JSON.stringify(t))}}publishToMemory(){const e=Memory,t=this.currentSnapshot;e.stats={tick:t.tick,timestamp:t.timestamp,cpu:{used:t.cpu.used,limit:t.cpu.limit,bucket:t.cpu.bucket,percent:t.cpu.percent,heap_mb:t.cpu.heapUsed},kernel:{adaptive_budgets_enabled:t.kernelBudgets.adaptiveBudgetsEnabled,room_count:t.kernelBudgets.roomCount,room_multiplier:t.kernelBudgets.roomMultiplier,bucket_multiplier:t.kernelBudgets.bucketMultiplier,budget_high:t.kernelBudgets.budgets.high,budget_medium:t.kernelBudgets.budgets.medium,budget_low:t.kernelBudgets.budgets.low,total_allocated:t.kernelBudgets.totalAllocated,total_used:t.kernelBudgets.totalUsed,utilization_ratio:t.kernelBudgets.utilizationRatio},gcl:{level:t.progression.gcl.level,progress:t.progression.gcl.progress,progress_total:t.progression.gcl.progressTotal,progress_percent:t.progression.gcl.progressPercent},gpl:{level:t.progression.gpl.level,progress:t.progression.gpl.progress,progress_total:t.progression.gpl.progressTotal,progress_percent:t.progression.gpl.progressPercent},empire:{rooms:t.empire.rooms,creeps:t.empire.creeps,power_creeps:{total:t.empire.powerCreeps.total,spawned:t.empire.powerCreeps.spawned,eco:t.empire.powerCreeps.eco,combat:t.empire.powerCreeps.combat},energy:{storage:t.empire.energy.storage,terminal:t.empire.energy.terminal,available:t.empire.energy.available,capacity:t.empire.energy.capacity},credits:t.empire.credits,skipped_processes:t.empire.skippedProcesses,shard:t.empire.shard?{name:t.empire.shard.name,role:t.empire.shard.role,cpu_usage:t.empire.shard.cpuUsage,cpu_category:t.empire.shard.cpuCategory,bucket_level:t.empire.shard.bucketLevel,economy_index:t.empire.shard.economyIndex,war_index:t.empire.shard.warIndex,avg_rcl:t.empire.shard.avgRCL,portals_count:t.empire.shard.portalsCount,active_tasks_count:t.empire.shard.activeTasksCount}:void 0},rooms:{},subsystems:{},roles:{},native:{pathfinder_search:t.native.pathfinderSearch,move_to:t.native.moveTo,move:t.native.move,harvest:t.native.harvest,transfer:t.native.transfer,withdraw:t.native.withdraw,build:t.native.build,repair:t.native.repair,upgrade_controller:t.native.upgradeController,attack:t.native.attack,ranged_attack:t.native.rangedAttack,heal:t.native.heal,dismantle:t.native.dismantle,say:t.native.say,total:t.native.total}};for(const[r,o]of Object.entries(t.rooms))e.stats.rooms[r]={rcl:o.rcl,energy:{available:o.energy.available,capacity:o.energy.capacity,storage:o.energy.storage,terminal:o.energy.terminal},controller:{progress:o.controller.progress,progress_total:o.controller.progressTotal,progress_percent:o.controller.progressPercent},creeps:o.creeps,hostiles:o.hostiles,brain:{danger:o.brain.danger,posture_code:o.brain.postureCode,colony_level_code:o.brain.colonyLevelCode},pheromones:{...o.pheromones},metrics:{energy:{harvested:o.metrics.energyHarvested,spawning:o.metrics.energySpawning,construction:o.metrics.energyConstruction,repair:o.metrics.energyRepair,tower:o.metrics.energyTower,available_for_sharing:o.metrics.energyAvailableForSharing,capacity_total:o.metrics.energyCapacityTotal,need:o.metrics.energyNeed},controller_progress:o.metrics.controllerProgress,hostile_count:o.metrics.hostileCount,damage_received:o.metrics.damageReceived,construction_sites:o.metrics.constructionSites},profiler:{avg_cpu:o.profiler.avgCpu,peak_cpu:o.profiler.peakCpu,samples:o.profiler.samples}};for(const[r,o]of Object.entries(t.subsystems))e.stats.subsystems[r]={avg_cpu:o.avgCpu,peak_cpu:o.peakCpu,calls:o.calls,samples:o.samples};for(const[r,o]of Object.entries(t.roles))e.stats.roles[r]={count:o.count,avg_cpu:o.avgCpu,peak_cpu:o.peakCpu,calls:o.calls,samples:o.samples,spawning_count:o.spawningCount,idle_count:o.idleCount,active_count:o.activeCount,avg_ticks_to_live:o.avgTicksToLive,total_body_parts:o.totalBodyParts};e.stats.processes={};for(const[r,o]of Object.entries(t.processes))e.stats.processes[r]={name:o.name,priority:o.priority,frequency:o.frequency,state:o.state,total_cpu:o.totalCpu,run_count:o.runCount,avg_cpu:o.avgCpu,max_cpu:o.maxCpu,last_run_tick:o.lastRunTick,skipped_count:o.skippedCount,error_count:o.errorCount,cpu_budget:o.cpuBudget,min_bucket:o.minBucket};e.stats.creeps={};for(const[r,o]of Object.entries(t.creeps))e.stats.creeps[r]={role:o.role,home_room:o.homeRoom,current_room:o.currentRoom,cpu:o.cpu,action:o.action,ticks_to_live:o.ticksToLive,hits:o.hits,hits_max:o.hitsMax,body_parts:o.bodyParts,fatigue:o.fatigue,actions_this_tick:o.actionsThisTick}}updateSegment(){if(!this.config.enabled)return;if(void 0===RawMemory.segments[this.config.segmentId])return void(this.segmentRequested||(RawMemory.setActiveSegments([this.config.segmentId]),this.segmentRequested=!0));this.segmentRequested=!1;const t=102400;let r=[];const o=RawMemory.segments[this.config.segmentId];if(o)try{const e=JSON.parse(o);Array.isArray(e)&&(r=e)}catch(t){const r=t instanceof Error?t.message:t+"";e.logger.error("Failed to parse stats segment: "+r,{subsystem:"Stats"})}r.push(this.currentSnapshot),r.length>this.config.maxHistoryPoints&&(r=r.slice(-this.config.maxHistoryPoints));let n=JSON.stringify(r);if(n.length>t){for(e.logger.warn(`Stats segment size ${n.length} exceeds 102400 bytes, trimming history`,{subsystem:"Stats"});n.length>t&&r.length>1;)r.shift(),n=JSON.stringify(r);if(n.length>t)return void e.logger.error("Failed to persist stats segment within 102400 bytes after trimming",{subsystem:"Stats"})}try{RawMemory.segments[this.config.segmentId]=n}catch(t){const r=t instanceof Error?t.message:t+"";e.logger.error("Failed to save stats segment: "+r,{subsystem:"Stats"})}}getProfilerMemory(){const e=Memory;return e.stats&&"object"==typeof e.stats||(e.stats={}),e.stats.profiler||(e.stats.profiler={rooms:{},subsystems:{},roles:{},tickCount:0,lastUpdate:0}),e.stats.profiler}logSummary(){const t=this.currentSnapshot;e.logger.info("=== Unified Stats Summary ==="),e.logger.info(`CPU: ${t.cpu.used.toFixed(2)}/${t.cpu.limit} (${t.cpu.percent.toFixed(1)}%) | Bucket: ${t.cpu.bucket}`),e.logger.info(`Empire: ${t.empire.rooms} rooms, ${t.empire.creeps} creeps, ${t.empire.credits} credits`);const r=Object.values(t.subsystems).sort((e,t)=>t.avgCpu-e.avgCpu).slice(0,5);if(r.length>0){e.logger.info("Top Subsystems:");for(const t of r)e.logger.info(`  ${t.name}: ${t.avgCpu.toFixed(3)} CPU`)}const o=Object.values(t.roles).sort((e,t)=>t.avgCpu-e.avgCpu).slice(0,5);if(o.length>0){e.logger.info("Top Roles:");for(const t of o)e.logger.info(`  ${t.name}: ${t.count} creeps, ${t.avgCpu.toFixed(3)} CPU`)}const n=Object.values(t.processes).sort((e,t)=>t.avgCpu-e.avgCpu).slice(0,5);if(n.length>0){e.logger.info("Top Processes:");for(const t of n)e.logger.info(`  ${t.name}: ${t.avgCpu.toFixed(3)} CPU (runs: ${t.runCount}, state: ${t.state})`)}const s=Object.values(t.rooms).sort((e,t)=>t.profiler.avgCpu-e.profiler.avgCpu).slice(0,5);if(s.length>0){e.logger.info("Top Rooms by CPU:");for(const t of s)e.logger.info(`  ${t.name}: ${t.profiler.avgCpu.toFixed(3)} CPU (RCL ${t.rcl})`)}const i=Object.values(t.creeps).sort((e,t)=>t.cpu-e.cpu).slice(0,5);if(i.length>0){e.logger.info("Top Creeps by CPU:");for(const t of i)e.logger.info(`  ${t.name} (${t.role}): ${t.cpu.toFixed(3)} CPU in ${t.currentRoom}`)}this.config.trackNativeCalls&&e.logger.info(`Native calls: ${t.native.total} total`)}postureToCode(e){return{eco:0,expand:1,defensive:2,war:3,siege:4,evacuate:5,nukePrep:6}[e]??-1}static POSTURE_NAMES=["eco","expand","defensive","war","siege","evacuate","nukePrep"];postureCodeToName(e){return n.POSTURE_NAMES[e]??"eco"}colonyLevelToCode(e){return{seedNest:1,foragingExpansion:2,matureColony:3,fortifiedHive:4,empireDominance:5}[e]??0}getSnapshot(){return this.currentSnapshot}setEnabled(e){this.config.enabled=e}isEnabled(){return this.config.enabled}reset(){this.currentSnapshot=this.createEmptySnapshot();const e=Memory;e.stats?.profiler&&(e.stats.profiler={rooms:{},subsystems:{},roles:{},tickCount:0,lastUpdate:0})}getCurrentSnapshot(){return{...this.currentSnapshot}}}return Me.UnifiedStatsManager=n,Me.unifiedStats=new n,Me}();Object.defineProperty(e,"UnifiedStatsManager",{enumerable:!0,get:function(){return o.UnifiedStatsManager}}),Object.defineProperty(e,"unifiedStats",{enumerable:!0,get:function(){return o.unifiedStats}});var n=function(){if(Le)return He;Le=1,Object.defineProperty(He,"__esModule",{value:!0}),He.memorySegmentStats=He.MemorySegmentStats=void 0;const e=we(),t={primarySegment:90,backupSegment:91,retentionPeriod:1e4,updateInterval:50,maxDataPoints:1e3};class r{config;statsData=null;segmentRequested=!1;lastUpdate=0;constructor(e={}){this.config={...t,...e}}initialize(){RawMemory.setActiveSegments([this.config.primarySegment]),this.segmentRequested=!0}run(){this.segmentRequested&&void 0!==RawMemory.segments[this.config.primarySegment]&&(this.loadFromSegment(),this.segmentRequested=!1),Game.time-this.lastUpdate<this.config.updateInterval||(this.updateStats(),this.lastUpdate=Game.time)}loadFromSegment(){const t=RawMemory.segments[this.config.primarySegment];if(t&&0!==t.length)try{this.statsData=JSON.parse(t),e.logger.debug("Loaded stats from segment",{subsystem:"Stats"})}catch(t){const r=t instanceof Error?t.message:t+"";e.logger.error("Failed to parse stats segment: "+r,{subsystem:"Stats"}),this.statsData=this.createDefaultStatsData()}else this.statsData=this.createDefaultStatsData()}createDefaultStatsData(){return{version:1,lastUpdate:Game.time,history:[],series:{}}}updateStats(){this.statsData||(this.statsData=this.createDefaultStatsData());const e=this.collectGlobalStats();for(this.statsData.history.push(e);this.statsData.history.length>this.config.maxDataPoints;)this.statsData.history.shift();const t=Game.time-this.config.retentionPeriod;this.statsData.history=this.statsData.history.filter(e=>e.tick>=t),this.updateMetricSeries("cpu",e.cpuUsed),this.updateMetricSeries("bucket",e.cpuBucket),this.updateMetricSeries("creeps",e.totalCreeps),this.updateMetricSeries("rooms",e.totalRooms),this.publishStatsToMemory(e),this.saveToSegment()}publishStatsToMemory(t){const r=Memory;r.stats&&"object"==typeof r.stats||(r.stats={});const o=r.stats;o["stats.cpu.used"]=t.cpuUsed,o["stats.cpu.limit"]=t.cpuLimit,o["stats.cpu.bucket"]=t.cpuBucket,o["stats.cpu.percent"]=t.cpuLimit>0?t.cpuUsed/t.cpuLimit*100:0,o["stats.gcl.level"]=t.gclLevel,o["stats.gcl.progress"]=t.gclProgress,o["stats.gcl.progress_total"]=t.gclProgressTotal,o["stats.gpl.level"]=t.gplLevel,o["stats.empire.creeps"]=t.totalCreeps,o["stats.empire.rooms"]=t.totalRooms;const n=t.rooms.reduce((e,t)=>({storage:e.storage+t.storageEnergy,terminal:e.terminal+t.terminalEnergy,available:e.available+t.energyAvailable,capacity:e.capacity+t.energyCapacity}),{storage:0,terminal:0,available:0,capacity:0});o["stats.empire.energy.storage"]=n.storage,o["stats.empire.energy.terminal"]=n.terminal,o["stats.empire.energy.available"]=n.available,o["stats.empire.energy.capacity"]=n.capacity;for(const r of t.rooms){const t="stats.room."+r.roomName;o[t+".rcl"]=r.rcl,o[t+".energy.available"]=r.energyAvailable,o[t+".energy.capacity"]=r.energyCapacity,o[t+".storage.energy"]=r.storageEnergy,o[t+".terminal.energy"]=r.terminalEnergy,o[t+".creeps"]=r.creepCount,o[t+".controller.progress"]=r.controllerProgress,o[t+".controller.progress_total"]=r.controllerProgressTotal,o[t+".controller.progress_percent"]=r.controllerProgressTotal>0?r.controllerProgress/r.controllerProgressTotal*100:0;const n=e.memoryManager.getSwarmState(r.roomName);if(n){o[t+".brain.danger"]=n.danger,o[t+".brain.posture_code"]=this.postureToCode(n.posture),o[t+".brain.colony_level_code"]=this.colonyLevelToCode(n.colonyLevel);for(const[e,r]of Object.entries(n.pheromones))o[`${t}.pheromone.${e}`]=r;const e=n.metrics;o[t+".metrics.energy.harvested"]=e.energyHarvested,o[t+".metrics.energy.spawning"]=e.energySpawning,o[t+".metrics.energy.construction"]=e.energyConstruction,o[t+".metrics.energy.repair"]=e.energyRepair,o[t+".metrics.energy.tower"]=e.energyTower,o[t+".metrics.energy.available_for_sharing"]=e.energyAvailable,o[t+".metrics.energy.capacity_total"]=e.energyCapacity,o[t+".metrics.energy.need"]=e.energyNeed,o[t+".metrics.controller_progress"]=e.controllerProgress,o[t+".metrics.hostile_count"]=e.hostileCount,o[t+".metrics.damage_received"]=e.damageReceived,o[t+".metrics.construction_sites"]=e.constructionSites}}o["stats.system.tick"]=t.tick,o["stats.system.timestamp"]=Date.now()}collectGlobalStats(){const e=Object.values(Game.rooms).filter(e=>e.controller?.my),t=new Map;for(const e in Game.creeps){const r=Game.creeps[e];if(!r.spawning&&r.room.controller?.my){const e=t.get(r.room.name)??0;t.set(r.room.name,e+1)}}const r=e.map(e=>({roomName:e.name,rcl:e.controller?.level??0,energyAvailable:e.energyAvailable,energyCapacity:e.energyCapacityAvailable,storageEnergy:e.storage?.store.getUsedCapacity(RESOURCE_ENERGY)??0,terminalEnergy:e.terminal?.store.getUsedCapacity(RESOURCE_ENERGY)??0,creepCount:t.get(e.name)??0,controllerProgress:e.controller?.progress??0,controllerProgressTotal:e.controller?.progressTotal??1}));return{tick:Game.time,cpuUsed:Game.cpu.getUsed(),cpuLimit:Game.cpu.limit,cpuBucket:Game.cpu.bucket,gclLevel:Game.gcl.level,gclProgress:Game.gcl.progress,gclProgressTotal:Game.gcl.progressTotal,gplLevel:Game.gpl?.level??0,totalCreeps:Object.keys(Game.creeps).length,totalRooms:e.length,rooms:r,metrics:{}}}updateMetricSeries(e,t){if(!this.statsData)return;let r=this.statsData.series[e];r||(r={name:e,data:[],lastUpdate:Game.time,min:t,max:t,avg:t},this.statsData.series[e]=r),r.data.push({tick:Game.time,value:t}),r.lastUpdate=Game.time;const o=Game.time-this.config.retentionPeriod;for(r.data=r.data.filter(e=>e.tick>=o);r.data.length>this.config.maxDataPoints;)r.data.shift();r.data.length>0&&(r.min=Math.min(...r.data.map(e=>e.value)),r.max=Math.max(...r.data.map(e=>e.value)),r.avg=r.data.reduce((e,t)=>e+t.value,0)/r.data.length)}saveToSegment(){if(!this.statsData)return;const t=102400;try{this.statsData.lastUpdate=Game.time;let r=JSON.stringify(this.statsData);if(r.length>t){for(e.logger.warn(`Stats data exceeds segment limit: ${r.length} bytes, trimming...`,{subsystem:"Stats"});r.length>t&&this.statsData.history.length>10;)this.statsData.history.shift(),r=JSON.stringify(this.statsData);if(r.length>t)for(const e of Object.keys(this.statsData.series)){const o=this.statsData.series[e];for(;o.data.length>10&&r.length>t;)o.data.shift(),r=JSON.stringify(this.statsData)}if(r.length>t){e.logger.warn("Stats data still exceeds limit after trimming, clearing history",{subsystem:"Stats"}),this.statsData.history=this.statsData.history.slice(-5);for(const e of Object.keys(this.statsData.series))this.statsData.series[e].data=this.statsData.series[e].data.slice(-5);r=JSON.stringify(this.statsData)}}RawMemory.segments[this.config.primarySegment]=r}catch(t){const r=t instanceof Error?t.message:t+"";e.logger.error("Failed to save stats segment: "+r,{subsystem:"Stats"})}}recordMetric(e,t){this.updateMetricSeries(e,t)}getLatestStats(){return this.statsData&&0!==this.statsData.history.length?this.statsData.history[this.statsData.history.length-1]??null:null}getMetricSeries(e){return this.statsData?.series[e]??null}getMetricNames(){return Object.keys(this.statsData?.series??{})}getHistory(e){if(!this.statsData)return[];const t=this.statsData.history;return e?t.slice(-e):t}getRoomHistory(e,t){if(!this.statsData)return[];const r=this.statsData.history.map(t=>t.rooms.find(t=>t.roomName===e)).filter(e=>void 0!==e);return t?r.slice(-t):r}exportForGraphana(){const e=this.getLatestStats();if(!e)return"{}";const t={timestamp:(new Date).toISOString(),tick:e.tick,cpu:{used:e.cpuUsed,limit:e.cpuLimit,bucket:e.cpuBucket},gcl:{level:e.gclLevel,progress:e.gclProgress,progressTotal:e.gclProgressTotal},gpl:{level:e.gplLevel},empire:{totalCreeps:e.totalCreeps,totalRooms:e.totalRooms},rooms:{}};for(const r of e.rooms)t.rooms[r.roomName]={rcl:r.rcl,energyAvailable:r.energyAvailable,energyCapacity:r.energyCapacity,storageEnergy:r.storageEnergy,terminalEnergy:r.terminalEnergy,creepCount:r.creepCount,controllerProgress:r.controllerProgress,controllerProgressTotal:r.controllerProgressTotal};return JSON.stringify(t,null,2)}clear(){this.statsData=this.createDefaultStatsData(),this.saveToSegment()}postureToCode(e){return{eco:0,expand:1,defensive:2,war:3,siege:4,evacuate:5,nukePrep:6}[e]??-1}colonyLevelToCode(e){return{seedNest:1,foragingExpansion:2,matureColony:3,fortifiedHive:4,empireDominance:5}[e]??0}}return He.MemorySegmentStats=r,He.memorySegmentStats=new r,He}();Object.defineProperty(e,"MemorySegmentStats",{enumerable:!0,get:function(){return n.MemorySegmentStats}}),Object.defineProperty(e,"memorySegmentStats",{enumerable:!0,get:function(){return n.memorySegmentStats}});var s=Ge();Object.defineProperty(e,"pathfindingMetrics",{enumerable:!0,get:function(){return s.pathfindingMetrics}}),Object.defineProperty(e,"trackPathfindingCall",{enumerable:!0,get:function(){return s.trackPathfindingCall}});var i=Pe();Object.defineProperty(e,"calculateRoomScalingMultiplier",{enumerable:!0,get:function(){return i.calculateRoomScalingMultiplier}}),Object.defineProperty(e,"calculateBucketMultiplier",{enumerable:!0,get:function(){return i.calculateBucketMultiplier}}),Object.defineProperty(e,"getAdaptiveBudgetInfo",{enumerable:!0,get:function(){return i.getAdaptiveBudgetInfo}}),Object.defineProperty(e,"getAdaptiveBudgets",{enumerable:!0,get:function(){return i.getAdaptiveBudgets}}),Object.defineProperty(e,"calculateAdaptiveBudget",{enumerable:!0,get:function(){return i.calculateAdaptiveBudget}}),Object.defineProperty(e,"calculateAdaptiveBudgets",{enumerable:!0,get:function(){return i.calculateAdaptiveBudgets}}),Object.defineProperty(e,"DEFAULT_ADAPTIVE_CONFIG",{enumerable:!0,get:function(){return i.DEFAULT_ADAPTIVE_CONFIG}}),r((De||(De=1,Object.defineProperty(We,"__esModule",{value:!0})),We),e);var a=we();Object.defineProperty(e,"VisualizationLayer",{enumerable:!0,get:function(){return a.VisualizationLayer}})}(Ue)),Ue);!function(e){e[e.CRITICAL=100]="CRITICAL",e[e.HIGH=75]="HIGH",e[e.MEDIUM=50]="MEDIUM",e[e.LOW=25]="LOW",e[e.IDLE=10]="IDLE"}(Be||(Be={}));const Ke={targetCpuUsage:.98,reservedCpuFraction:.02,enableStats:!0,statsLogInterval:100,budgetWarningThreshold:1.5,budgetWarningInterval:500,enableAdaptiveBudgets:!0,adaptiveBudgetConfig:Ye.DEFAULT_ADAPTIVE_CONFIG};function je(e){const t=e.bucketThresholds.highMode,r=e.bucketThresholds.lowMode,o=function(e){return Math.max(0,Math.floor(e/2))}(r),n=(s=e.taskFrequencies,{high:1,medium:Math.max(1,Math.min(s.clusterLogic,s.pheromoneUpdate)),low:Math.max(s.marketScan,s.nukeEvaluation,s.memoryCleanup)});var s;const i=(e.bucketThresholds,{high:0,medium:0,low:0}),a={high:(c=e.budgets).rooms,medium:c.strategic,low:Math.max(c.market,c.visualization)};var c;return{...Ke,lowBucketThreshold:r,highBucketThreshold:t,criticalBucketThreshold:o,frequencyIntervals:n,frequencyMinBucket:i,frequencyCpuBudgets:a}}class Ve{constructor(e){this.processes=new Map,this.bucketMode="normal",this.tickCpuUsed=0,this.initialized=!1,this.lastExecutedProcessId=null,this.lastExecutedIndex=-1,this.processQueue=[],this.queueDirty=!0,this.skippedProcessesThisTick=0,this.config={...e},this.validateConfig(),this.frequencyDefaults=this.buildFrequencyDefaults()}registerProcess(e){var t,r,o,n,s;const i=null!==(t=e.frequency)&&void 0!==t?t:"medium",a=this.frequencyDefaults[i];if(void 0!==e.tickModulo){if(0>e.tickModulo)throw de.error(`Kernel: Cannot register process "${e.name}" - tickModulo must be non-negative (got ${e.tickModulo})`,{subsystem:"Kernel"}),Error(`Invalid tickModulo: ${e.tickModulo} (must be >= 0)`);if(void 0!==e.tickOffset&&e.tickOffset>=e.tickModulo)throw de.error(`Kernel: Cannot register process "${e.name}" - tickOffset (${e.tickOffset}) must be less than tickModulo (${e.tickModulo})`,{subsystem:"Kernel"}),Error(`Invalid tickOffset: ${e.tickOffset} (must be < tickModulo ${e.tickModulo})`)}const c={id:e.id,name:e.name,priority:null!==(r=e.priority)&&void 0!==r?r:Be.MEDIUM,frequency:i,minBucket:null!==(o=e.minBucket)&&void 0!==o?o:a.minBucket,cpuBudget:null!==(n=e.cpuBudget)&&void 0!==n?n:a.cpuBudget,interval:null!==(s=e.interval)&&void 0!==s?s:a.interval,tickModulo:e.tickModulo,tickOffset:e.tickOffset,execute:e.execute,state:"idle",stats:{totalCpu:0,runCount:0,avgCpu:0,maxCpu:0,lastRunTick:0,skippedCount:0,errorCount:0,consecutiveErrors:0,lastSuccessfulRunTick:0,healthScore:100,suspendedUntil:null,suspensionReason:null}};this.processes.set(e.id,c),this.queueDirty=!0,de.debug(`Kernel: Registered process "${c.name}" (${c.id})`,{subsystem:"Kernel"})}unregisterProcess(e){const t=this.processes.delete(e);return t&&(this.queueDirty=!0,de.debug("Kernel: Unregistered process "+e,{subsystem:"Kernel"})),t}getProcess(e){return this.processes.get(e)}getProcesses(){return Array.from(this.processes.values())}initialize(){this.initialized||(de.info(`Kernel initialized with ${this.processes.size} processes`,{subsystem:"Kernel"}),this.initialized=!0)}updateBucketMode(){const e=Game.cpu.bucket;let t;if(t=e<this.config.criticalBucketThreshold?"critical":e<this.config.lowBucketThreshold?"low":e>this.config.highBucketThreshold?"high":"normal",t!==this.bucketMode&&(de.info(`Kernel: Bucket mode changed from ${this.bucketMode} to ${t} (bucket: ${e})`,{subsystem:"Kernel"}),this.bucketMode=t),Game.time%100==0&&("low"===this.bucketMode||"critical"===this.bucketMode)){const t=this.processes.size;de.info(`Bucket ${this.bucketMode.toUpperCase()} mode: ${e}/10000 bucket. Running all ${t} processes normally (bucket mode is informational only)`,{subsystem:"Kernel"})}}validateConfig(){this.config.criticalBucketThreshold<this.config.lowBucketThreshold||(de.warn(`Kernel: Adjusting critical bucket threshold ${this.config.criticalBucketThreshold} to stay below low threshold ${this.config.lowBucketThreshold}`,{subsystem:"Kernel"}),this.config.criticalBucketThreshold=Math.max(0,this.config.lowBucketThreshold-1)),this.config.lowBucketThreshold<this.config.highBucketThreshold||(de.warn(`Kernel: Adjusting high bucket threshold ${this.config.highBucketThreshold} to stay above low threshold ${this.config.lowBucketThreshold}`,{subsystem:"Kernel"}),this.config.highBucketThreshold=this.config.lowBucketThreshold+1)}buildFrequencyDefaults(){return{high:{interval:this.config.frequencyIntervals.high,minBucket:this.config.frequencyMinBucket.high,cpuBudget:this.config.frequencyCpuBudgets.high},medium:{interval:this.config.frequencyIntervals.medium,minBucket:this.config.frequencyMinBucket.medium,cpuBudget:this.config.frequencyCpuBudgets.medium},low:{interval:this.config.frequencyIntervals.low,minBucket:this.config.frequencyMinBucket.low,cpuBudget:this.config.frequencyCpuBudgets.low}}}updateAdaptiveBudgets(){if(!this.config.enableAdaptiveBudgets)return;const e=Ye.getAdaptiveBudgets(this.config.adaptiveBudgetConfig);if(this.config.frequencyCpuBudgets=e,this.frequencyDefaults=this.buildFrequencyDefaults(),Game.time%500==0){const t=Object.keys(Game.rooms).length,r=Game.cpu.bucket;de.info(`Adaptive budgets updated: rooms=${t}, bucket=${r}, high=${e.high.toFixed(3)}, medium=${e.medium.toFixed(3)}, low=${e.low.toFixed(3)}`,{subsystem:"Kernel"})}}getBucketMode(){return this.updateBucketMode(),this.bucketMode}getCpuLimit(){return Game.cpu.limit*this.config.targetCpuUsage}hasCpuBudget(){const e=Game.cpu.getUsed(),t=this.getCpuLimit();return t-e>t*this.config.reservedCpuFraction}getRemainingCpu(){const e=this.getCpuLimit(),t=e*this.config.reservedCpuFraction;return Math.max(0,e-Game.cpu.getUsed()-t)}rebuildProcessQueue(){this.processQueue=Array.from(this.processes.values()).sort((e,t)=>t.priority-e.priority),this.queueDirty=!1,this.lastExecutedProcessId?this.lastExecutedIndex=this.processQueue.findIndex(e=>e.id===this.lastExecutedProcessId):this.lastExecutedIndex=-1}shouldRunProcess(e){var t;if("suspended"===e.state&&null!==e.stats.suspendedUntil){if(Game.time<e.stats.suspendedUntil){if(Game.time%100==0){const t=e.stats.suspendedUntil-Game.time;de.debug(`Kernel: Process "${e.name}" suspended (${t} ticks remaining)`,{subsystem:"Kernel"})}return!1}{e.state="idle",e.stats.suspendedUntil=null;const t=e.stats.suspensionReason;e.stats.suspensionReason=null,de.info(`Kernel: Process "${e.name}" automatically resumed after suspension. Previous reason: ${t}. Consecutive errors: ${e.stats.consecutiveErrors}`,{subsystem:"Kernel",processId:e.id}),this.emit("process.recovered",{processId:e.id,processName:e.name,previousReason:t||"Unknown",consecutiveErrors:e.stats.consecutiveErrors},{priority:50})}}if(void 0!==e.tickModulo&&e.tickModulo>0){const r=null!==(t=e.tickOffset)&&void 0!==t?t:0;if((Game.time+r)%e.tickModulo!==0)return!1}if(e.stats.runCount>0){const t=Game.time-e.stats.lastRunTick;if(t<e.interval)return Game.time%100!=0||e.priority<Be.HIGH||de.debug(`Kernel: Process "${e.name}" skipped (interval: ${t}/${e.interval} ticks)`,{subsystem:"Kernel"}),!1}return!0}calculateHealthScore(e){if(0===e.runCount)return 100;let t=(e.runCount-e.errorCount)/e.runCount*100;return 100>Game.time-e.lastSuccessfulRunTick&&e.lastSuccessfulRunTick>0&&(t+=20),t-=15*e.consecutiveErrors,Math.max(0,Math.min(100,t))}executeProcess(e){const t=Game.cpu.getUsed();e.state="running";try{e.execute(),e.state="idle",e.stats.consecutiveErrors=0,e.stats.lastSuccessfulRunTick=Game.time}catch(t){e.state="error",e.stats.errorCount++,e.stats.consecutiveErrors++;const r=t instanceof Error?t.message:t+"";de.error(`Kernel: Process "${e.name}" error: ${r}`,{subsystem:"Kernel"}),t instanceof Error&&t.stack&&de.error(t.stack,{subsystem:"Kernel"});const o=e.stats.consecutiveErrors;if(10>o){if(o>=3){const t=Math.min(1e3,Math.pow(2,o));e.stats.suspendedUntil=Game.time+t,e.stats.suspensionReason=`${o} consecutive failures (auto-resume in ${t} ticks)`,e.state="suspended",de.warn(`Kernel: Process "${e.name}" suspended for ${t} ticks after ${o} consecutive failures`,{subsystem:"Kernel",processId:e.id,meta:{errorCount:e.stats.errorCount,resumeAt:e.stats.suspendedUntil}}),this.emit("process.suspended",{processId:e.id,processName:e.name,reason:e.stats.suspensionReason,consecutive:o,permanent:!1,resumeAt:e.stats.suspendedUntil},{immediate:!0,priority:75})}}else e.stats.suspendedUntil=Number.MAX_SAFE_INTEGER,e.stats.suspensionReason=`Circuit breaker: ${o} consecutive failures (permanent)`,e.state="suspended",de.error(`Kernel: Process "${e.name}" permanently suspended after ${o} consecutive failures`,{subsystem:"Kernel",processId:e.id}),this.emit("process.suspended",{processId:e.id,processName:e.name,reason:e.stats.suspensionReason,consecutive:o,permanent:!0},{immediate:!0,priority:100})}const r=Game.cpu.getUsed()-t;this.config.enableStats&&(e.stats.totalCpu+=r,e.stats.runCount++,e.stats.avgCpu=e.stats.totalCpu/e.stats.runCount,e.stats.maxCpu=Math.max(e.stats.maxCpu,r),e.stats.lastRunTick=Game.time,e.stats.healthScore=this.calculateHealthScore(e.stats)),this.tickCpuUsed+=r;const o=this.getCpuLimit()*e.cpuBudget,n=r/o;n>this.config.budgetWarningThreshold&&Game.time%this.config.budgetWarningInterval===0&&de.warn(`Kernel: Process "${e.name}" exceeded CPU budget: ${r.toFixed(3)} > ${o.toFixed(3)} (${(100*n).toFixed(0)}%)`,{subsystem:"Kernel"})}run(){if(this.updateBucketMode(),this.updateAdaptiveBudgets(),this.tickCpuUsed=0,this.skippedProcessesThisTick=0,ve.processQueue(),this.queueDirty&&(this.rebuildProcessQueue(),de.info(`Kernel: Rebuilt process queue with ${this.processQueue.length} processes`,{subsystem:"Kernel"})),0===this.processQueue.length)return void de.warn("Kernel: No processes registered in queue",{subsystem:"Kernel"});Game.time%10==0&&de.info(`Kernel: Running ${this.processQueue.length} registered processes`,{subsystem:"Kernel"});let e=0,t=0,r=0,o=0;const n=(this.lastExecutedIndex+1)%this.processQueue.length;for(let s=0;s<this.processQueue.length;s++){const i=(n+s)%this.processQueue.length,a=this.processQueue[i];if(this.shouldRunProcess(a)){if(!this.hasCpuBudget()){r=this.processQueue.length-e-t,de.warn(`Kernel: CPU budget exhausted after ${e} processes. ${r} processes deferred to next tick. Used: ${Game.cpu.getUsed().toFixed(2)}/${this.getCpuLimit().toFixed(2)}`,{subsystem:"Kernel"});break}this.executeProcess(a),e++,this.lastExecutedProcessId=a.id,this.lastExecutedIndex=i}else this.config.enableStats&&a.stats.skippedCount++,t++,this.skippedProcessesThisTick++,a.stats.runCount>0&&Game.time-a.stats.lastRunTick<a.interval&&o++}this.config.enableStats&&Game.time%this.config.statsLogInterval===0&&(this.logStats(e,t,o,r),ve.logStats())}logStats(e,t,r,o){const n=Game.cpu.bucket,s=(n/1e4*100).toFixed(1),i=Game.cpu.getUsed(),a=this.getCpuLimit();if(de.info(`Kernel: ${e} ran, ${t} skipped (interval: ${r}, CPU: ${o}), CPU: ${i.toFixed(2)}/${a.toFixed(2)} (${(i/a*100).toFixed(1)}%), bucket: ${n}/10000 (${s}%), mode: ${this.bucketMode}`,{subsystem:"Kernel"}),t>10){const e=this.processQueue.filter(e=>e.stats.skippedCount>100).sort((e,t)=>t.stats.skippedCount-e.stats.skippedCount).slice(0,5);e.length>0&&de.warn("Kernel: Top skipped processes: "+e.map(e=>`${e.name}(${e.stats.skippedCount}, interval:${e.interval})`).join(", "),{subsystem:"Kernel"})}}getTickCpuUsed(){return this.tickCpuUsed}getSkippedProcessesThisTick(){return this.skippedProcessesThisTick}suspendProcess(e){const t=this.processes.get(e);return!!t&&(t.state="suspended",de.info(`Kernel: Suspended process "${t.name}"`,{subsystem:"Kernel"}),!0)}resumeProcess(e){const t=this.processes.get(e);if(t&&"suspended"===t.state){t.state="idle",t.stats.suspendedUntil=null;const r=t.stats.suspensionReason;return t.stats.suspensionReason=null,de.info(`Kernel: Manually resumed process "${t.name}". Previous reason: ${r}. Consecutive errors: ${t.stats.consecutiveErrors}`,{subsystem:"Kernel",processId:e}),this.emit("process.recovered",{processId:t.id,processName:t.name,previousReason:r||"Unknown",consecutiveErrors:t.stats.consecutiveErrors,manual:!0},{priority:50}),!0}return!1}getStatsSummary(){const e=Array.from(this.processes.values()),t=e.filter(e=>"suspended"!==e.state),r=e.filter(e=>"suspended"===e.state),o=e.reduce((e,t)=>e+t.stats.totalCpu,0),n=e.length>0?o/e.length:0,s=[...e].sort((e,t)=>t.stats.avgCpu-e.stats.avgCpu).slice(0,5).map(e=>({name:e.name,avgCpu:e.stats.avgCpu})),i=[...e].filter(e=>50>e.stats.healthScore).sort((e,t)=>e.stats.healthScore-t.stats.healthScore).slice(0,5).map(e=>({name:e.name,healthScore:e.stats.healthScore,consecutiveErrors:e.stats.consecutiveErrors})),a=e.reduce((e,t)=>e+t.stats.healthScore,0),c=e.length>0?a/e.length:100;return{totalProcesses:e.length,activeProcesses:t.length,suspendedProcesses:r.length,totalCpuUsed:o,avgCpuPerProcess:n,topCpuProcesses:s,unhealthyProcesses:i,avgHealthScore:c}}resetStats(){for(const e of this.processes.values())e.stats={totalCpu:0,runCount:0,avgCpu:0,maxCpu:0,lastRunTick:0,skippedCount:0,errorCount:0,consecutiveErrors:0,lastSuccessfulRunTick:0,healthScore:100,suspendedUntil:null,suspensionReason:null};de.info("Kernel: Reset all process statistics",{subsystem:"Kernel"})}getDistributionStats(){const e=Array.from(this.processes.values()),t=e.filter(e=>void 0!==e.tickModulo&&e.tickModulo>0),r=e.filter(e=>!e.tickModulo||0===e.tickModulo),o={};for(const e of t){const t=e.tickModulo;o[t]=(o[t]||0)+1}const n=r.length+t.reduce((e,t)=>e+1/(t.tickModulo||1),0),s=e.length,i=s>0?(s-n)/s*100:0;return{totalProcesses:e.length,distributedProcesses:t.length,everyTickProcesses:r.length,distributionRatio:e.length>0?t.length/e.length:0,moduloCounts:o,averageTickLoad:n,estimatedCpuReduction:i}}getConfig(){return{...this.config}}getFrequencyDefaults(e){return{...this.frequencyDefaults[e]}}updateConfig(e){this.config={...this.config,...e},this.validateConfig(),this.frequencyDefaults=this.buildFrequencyDefaults()}updateFromCpuConfig(e){this.updateConfig(je(e))}on(e,t,r={}){return ve.on(e,t,r)}once(e,t,r={}){return ve.once(e,t,r)}emit(e,t,r={}){ve.emit(e,t,r)}offAll(e){ve.offAll(e)}processEvents(){ve.processQueue()}getEventStats(){return ve.getStats()}hasEventHandlers(e){return ve.hasHandlers(e)}getEventBus(){return ve}}const qe=new Ve(je(_e().cpu));var ze=Object.freeze({__proto__:null,Kernel:Ve,get ProcessPriority(){return Be},buildKernelConfigFromCpu:je,createHighFrequencyProcess:function(e,t,r,o=Be.HIGH){const n=qe.getFrequencyDefaults("high");return{id:e,name:t,execute:r,priority:o,frequency:"high",minBucket:n.minBucket,cpuBudget:n.cpuBudget,interval:n.interval}},createLowFrequencyProcess:function(e,t,r,o=Be.LOW){const n=qe.getFrequencyDefaults("low");return{id:e,name:t,execute:r,priority:o,frequency:"low",minBucket:n.minBucket,cpuBudget:n.cpuBudget,interval:n.interval}},createMediumFrequencyProcess:function(e,t,r,o=Be.MEDIUM){const n=qe.getFrequencyDefaults("medium");return{id:e,name:t,execute:r,priority:o,frequency:"medium",minBucket:n.minBucket,cpuBudget:n.cpuBudget,interval:n.interval}},kernel:qe});class Xe{constructor(e="default"){this.namespace=e}getStore(){const e=global,t="_cacheHeap_"+this.namespace;return e[t]&&e[t].tick===Game.time||(e[t]?e[t].tick=Game.time:e[t]={tick:Game.time,entries:new Map}),e[t]}get(e){return this.getStore().entries.get(e)}set(e,t){this.getStore().entries.set(e,t)}delete(e){return this.getStore().entries.delete(e)}has(e){return this.getStore().entries.has(e)}keys(){const e=this.getStore();return Array.from(e.entries.keys())}size(){return this.getStore().entries.size}clear(){this.getStore().entries.clear()}cleanup(){const e=this.getStore();let t=0;for(const[r,o]of e.entries)void 0!==o.ttl&&-1!==o.ttl&&Game.time-o.cachedAt>o.ttl&&(e.entries.delete(r),t++);return t}}class Qe{constructor(e="default",t=10){this.lastPersistTick=0,this.namespace=e,this.persistInterval=t}getHeap(){const e=global,t="_cacheMemoryHeap_"+this.namespace;e[t]&&e[t].tick===Game.time||(e[t]?e[t].tick=Game.time:e[t]={tick:Game.time,entries:new Map,rehydrated:!1});const r=e[t];return r.rehydrated||(this.rehydrate(r),r.rehydrated=!0),r}getMemory(){return Memory._cacheMemory||(Memory._cacheMemory={}),Memory._cacheMemory[this.namespace]||(Memory._cacheMemory[this.namespace]={version:Qe.CACHE_VERSION,lastSync:Game.time,data:{}}),Memory._cacheMemory[this.namespace]}rehydrate(e){const t=this.getMemory(),r=[];for(const[o,n]of Object.entries(t.data))void 0!==n.ttl&&-1!==n.ttl&&Game.time-n.cachedAt>n.ttl?r.push(o):e.entries.set(o,{value:n.value,cachedAt:n.cachedAt,lastAccessed:Game.time,ttl:n.ttl,hits:n.hits,dirty:!1});for(const e of r)delete t.data[e]}get(e){const t=this.getHeap().entries.get(e);if(t)return t.lastAccessed!==Game.time&&(t.lastAccessed=Game.time,t.dirty=!0),t}set(e,t){this.getHeap().entries.set(e,{...t,dirty:!0})}delete(e){const t=this.getHeap().entries.delete(e);return delete this.getMemory().data[e],t}has(e){return this.getHeap().entries.has(e)}keys(){const e=this.getHeap();return Array.from(e.entries.keys())}size(){return this.getHeap().entries.size}clear(){this.getHeap().entries.clear(),this.getMemory().data={}}cleanup(){const e=this.getHeap(),t=this.getMemory();let r=0;for(const[t,o]of e.entries)void 0!==o.ttl&&-1!==o.ttl&&Game.time-o.cachedAt>o.ttl&&(e.entries.delete(t),r++);for(const[e,o]of Object.entries(t.data))void 0!==o.ttl&&-1!==o.ttl&&Game.time-o.cachedAt>o.ttl&&(delete t.data[e],r++);return r}persist(){if(Game.time-this.lastPersistTick<this.persistInterval)return 0;const e=this.getHeap(),t=this.getMemory();let r=0;for(const[o,n]of e.entries)n.dirty&&(t.data[o]={value:n.value,cachedAt:n.cachedAt,ttl:n.ttl,hits:n.hits},n.dirty=!1,r++);return t.lastSync=Game.time,this.lastPersistTick=Game.time,r}}Qe.CACHE_VERSION=1;const Ze=new class{constructor(e="heap"){this.stores=new Map,this.stats=new Map,this.defaultStore=e}getStore(e,t){const r=null!=t?t:this.defaultStore,o=`${e}:${r}`;let n=this.stores.get(o);return n||(n="memory"===r?new Qe(e):new Xe(e),this.stores.set(o,n)),n}getStats(e){let t=this.stats.get(e);return t||(t={hits:0,misses:0,evictions:0},this.stats.set(e,t)),t}makeKey(e,t){return`${e}:${t}`}get(e,t){var r;const o=null!==(r=null==t?void 0:t.namespace)&&void 0!==r?r:"default",n=this.getStore(o,null==t?void 0:t.store),s=this.getStats(o),i=this.makeKey(o,e),a=n.get(i);if(a){if(void 0!==a.ttl&&-1!==a.ttl&&Game.time-a.cachedAt>a.ttl){if(n.delete(i),s.evictions++,s.misses++,null==t?void 0:t.compute){const r=t.compute();return this.set(e,r,t),r}return}return s.hits++,a.hits++,a.lastAccessed=Game.time,a.value}if(s.misses++,null==t?void 0:t.compute){const r=t.compute();return this.set(e,r,t),r}}set(e,t,r){var o;const n=null!==(o=null==r?void 0:r.namespace)&&void 0!==o?o:"default",s=this.getStore(n,null==r?void 0:r.store),i=this.makeKey(n,e);if((null==r?void 0:r.maxSize)&&s.size()>=r.maxSize){const e=Math.max(1,Math.floor(.1*r.maxSize));for(let t=0;e>t;t++)this.evictLRU(n,s);this.getStats(n).evictions+=e}const a={value:t,cachedAt:Game.time,lastAccessed:Game.time,ttl:null==r?void 0:r.ttl,hits:0,dirty:!0};s.set(i,a)}invalidate(e,t="default"){const r=t+":heap",o=t+":memory",n=this.makeKey(t,e);let s=!1;const i=this.stores.get(r);i&&(s=i.delete(n)||s);const a=this.stores.get(o);return a&&(s=a.delete(n)||s),s}invalidatePattern(e,t="default"){const r=t+":heap",o=t+":memory";let n=0;const s=[this.stores.get(r),this.stores.get(o)].filter(Boolean);for(const t of s){if(!t)continue;const r=t.keys();for(const o of r){const r=o.indexOf(":");if(-1===r)continue;const s=o.substring(r+1);e.test(s)&&(t.delete(o),n++)}}return n}clear(e){var t,r;if(e){const o=e+":heap",n=e+":memory";null===(t=this.stores.get(o))||void 0===t||t.clear(),null===(r=this.stores.get(n))||void 0===r||r.clear(),this.stats.delete(e)}else{for(const e of this.stores.values())e.clear();this.stats.clear()}}getCacheStats(e){var t,r,o,n;if(e){const s=this.getStats(e),i=e+":heap",a=e+":memory",c=null!==(r=null===(t=this.stores.get(i))||void 0===t?void 0:t.size())&&void 0!==r?r:0,l=null!==(n=null===(o=this.stores.get(a))||void 0===o?void 0:o.size())&&void 0!==n?n:0,u=s.hits+s.misses,m=u>0?s.hits/u:0;return{hits:s.hits,misses:s.misses,hitRate:m,size:c+l,evictions:s.evictions}}{let e=0,t=0,r=0,o=0;for(const o of this.stats.values())e+=o.hits,t+=o.misses,r+=o.evictions;for(const e of this.stores.values())o+=e.size();const n=e+t;return{hits:e,misses:t,hitRate:n>0?e/n:0,size:o,evictions:r}}}evictLRU(e,t){const r=t.keys();if(0===r.length)return;let o=null,n=1/0;for(const e of r){const r=t.get(e);r&&r.lastAccessed<n&&(n=r.lastAccessed,o=e)}o&&t.delete(o)}cleanup(){let e=0;for(const t of this.stores.values())t.cleanup&&(e+=t.cleanup());return e}persist(){let e=0;for(const t of this.stores.values())t.persist&&(e+=t.persist());return e}}("heap");var Je;!function(e){e.L1="L1",e.L2="L2",e.L3="L3"}(Je||(Je={}));const et="object",tt="path";function rt(e,t){return`${e.roomName}:${e.x},${e.y}:${t.roomName}:${t.x},${t.y}`}function ot(e,t,r,o={}){const n=rt(e,t),s=Room.serializePath(r);Ze.set(n,s,{namespace:tt,ttl:o.ttl,maxSize:1e3})}const nt={[FIND_SOURCES]:5e3,[FIND_MINERALS]:5e3,[FIND_DEPOSITS]:100,[FIND_STRUCTURES]:50,[FIND_MY_STRUCTURES]:50,[FIND_HOSTILE_STRUCTURES]:20,[FIND_MY_SPAWNS]:100,[FIND_MY_CONSTRUCTION_SITES]:20,[FIND_CONSTRUCTION_SITES]:20,[FIND_CREEPS]:5,[FIND_MY_CREEPS]:5,[FIND_HOSTILE_CREEPS]:3,[FIND_DROPPED_RESOURCES]:5,[FIND_TOMBSTONES]:10,[FIND_RUINS]:10,[FIND_FLAGS]:50,[FIND_NUKES]:20,[FIND_POWER_CREEPS]:10,[FIND_MY_POWER_CREEPS]:10};function st(e,t,r){var o,n;const s=function(e,t,r){return r?`${e}:${t}:${r}`:`${e}:${t}`}(e.name,t,null==r?void 0:r.filterKey),i=Ze.get(s,{namespace:"roomFind",ttl:null!==(n=null!==(o=null==r?void 0:r.ttl)&&void 0!==o?o:nt[t])&&void 0!==n?n:20,compute:()=>(null==r?void 0:r.filter)?e.find(t,{filter:r.filter}):e.find(t)});return null!=i?i:[]}function it(e){return st(e,FIND_SOURCES)}function at(e,t){return t?st(e,FIND_MY_STRUCTURES,{filter:e=>e.structureType===t,filterKey:t}):st(e,FIND_MY_STRUCTURES)}function ct(e,t=!0){return st(e,t?FIND_MY_CONSTRUCTION_SITES:FIND_CONSTRUCTION_SITES)}function lt(e,t){return t?st(e,FIND_DROPPED_RESOURCES,{filter:e=>e.resourceType===t,filterKey:t}):st(e,FIND_DROPPED_RESOURCES)}const ut="closest";function mt(e,t){return`${e}:${t}`}function dt(e,t,r,o=10){if(0===t.length)return pt(e,r),null;if(1===t.length)return t[0];const n=mt(e.name,r),s=Ze.get(n,{namespace:ut,ttl:o});if(s){const r=Game.getObjectById(s);if(r&&t.some(e=>e.id===r.id)&&20>=e.pos.getRangeTo(r.pos))return r}const i=e.pos.findClosestByRange(t);return i?Ze.set(n,i.id,{namespace:ut,ttl:o}):pt(e,r),i}function pt(e,t){if(t){const r=mt(e.name,t);Ze.invalidate(r,ut)}else{const t=RegExp(`^${e.name}:`);Ze.invalidatePattern(t,ut)}}function gt(e){pt(e)}function ft(e){const t={[MOVE]:50,[WORK]:100,[CARRY]:50,[ATTACK]:80,[RANGED_ATTACK]:150,[HEAL]:250,[CLAIM]:600,[TOUGH]:10};return e.reduce((e,r)=>e+t[r],0)}function ht(e,t=0){return{parts:e,cost:ft(e),minCapacity:t||ft(e)}}const yt={larvaWorker:{role:"larvaWorker",family:"economy",bodies:[ht([WORK,CARRY],150),ht([WORK,CARRY,MOVE],200),ht([WORK,WORK,CARRY,CARRY,MOVE,MOVE],400),ht([WORK,WORK,WORK,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE],600),ht([WORK,WORK,WORK,WORK,CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE],800)],priority:100,maxPerRoom:3,remoteRole:!1},harvester:{role:"harvester",family:"economy",bodies:[ht([WORK,WORK,MOVE],250),ht([WORK,WORK,WORK,WORK,MOVE,MOVE],500),ht([WORK,WORK,WORK,WORK,WORK,MOVE,MOVE,MOVE],700),ht([WORK,WORK,WORK,WORK,WORK,WORK,MOVE,MOVE,MOVE],800),ht([WORK,WORK,WORK,WORK,WORK,WORK,WORK,WORK,MOVE,MOVE,MOVE,MOVE],1e3)],priority:95,maxPerRoom:2,remoteRole:!1},hauler:{role:"hauler",family:"economy",bodies:[ht([CARRY,CARRY,MOVE,MOVE],200),ht([CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE],400),ht([CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],800),ht([...Array(16).fill(CARRY),...Array(16).fill(MOVE)],1600)],priority:90,maxPerRoom:2,remoteRole:!0},upgrader:{role:"upgrader",family:"economy",bodies:[ht([WORK,CARRY,MOVE],200),ht([WORK,WORK,WORK,CARRY,MOVE,MOVE],450),ht([WORK,WORK,WORK,WORK,WORK,WORK,WORK,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE],1e3),ht([WORK,WORK,WORK,WORK,WORK,WORK,WORK,WORK,WORK,WORK,WORK,WORK,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],1700)],priority:60,maxPerRoom:2,remoteRole:!1},builder:{role:"builder",family:"economy",bodies:[ht([WORK,CARRY,MOVE,MOVE],250),ht([WORK,WORK,WORK,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE],650),ht([WORK,WORK,WORK,WORK,WORK,WORK,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],1400)],priority:70,maxPerRoom:2,remoteRole:!1},queenCarrier:{role:"queenCarrier",family:"economy",bodies:[ht([CARRY,CARRY,CARRY,CARRY,MOVE,MOVE],300),ht([CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE],450),ht([CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE],600)],priority:85,maxPerRoom:1,remoteRole:!1},mineralHarvester:{role:"mineralHarvester",family:"economy",bodies:[ht([WORK,WORK,WORK,WORK,CARRY,MOVE,MOVE],550),ht([WORK,WORK,WORK,WORK,WORK,WORK,CARRY,CARRY,MOVE,MOVE,MOVE],850)],priority:40,maxPerRoom:1,remoteRole:!1},labTech:{role:"labTech",family:"economy",bodies:[ht([CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE],400),ht([CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],600)],priority:35,maxPerRoom:1,remoteRole:!1},factoryWorker:{role:"factoryWorker",family:"economy",bodies:[ht([CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE],400),ht([CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],600)],priority:35,maxPerRoom:1,remoteRole:!1},remoteHarvester:{role:"remoteHarvester",family:"economy",bodies:[ht([WORK,WORK,CARRY,MOVE,MOVE,MOVE],400),ht([WORK,WORK,WORK,WORK,WORK,CARRY,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],750),ht([WORK,WORK,WORK,WORK,WORK,WORK,WORK,CARRY,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],1050),ht([WORK,WORK,WORK,WORK,WORK,WORK,WORK,WORK,WORK,WORK,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],1600)],priority:85,maxPerRoom:6,remoteRole:!0},remoteHauler:{role:"remoteHauler",family:"economy",bodies:[ht([CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE],400),ht([CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],800),ht([...Array(16).fill(CARRY),...Array(16).fill(MOVE)],1600)],priority:80,maxPerRoom:6,remoteRole:!0},interRoomCarrier:{role:"interRoomCarrier",family:"economy",bodies:[ht([CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE],400),ht([CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],600),ht([CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],800)],priority:90,maxPerRoom:4,remoteRole:!1},crossShardCarrier:{role:"crossShardCarrier",family:"economy",bodies:[ht([...[,,,,].fill(CARRY),...[,,,,].fill(MOVE)],400),ht([...[,,,,,,,,].fill(CARRY),...[,,,,,,,,].fill(MOVE)],800),ht([...Array(12).fill(CARRY),...Array(12).fill(MOVE)],1200),ht([...Array(16).fill(CARRY),...Array(16).fill(MOVE)],1600)],priority:85,maxPerRoom:6,remoteRole:!0},guard:{role:"guard",family:"military",bodies:[ht([TOUGH,ATTACK,ATTACK,MOVE,MOVE,MOVE],310),ht([TOUGH,TOUGH,ATTACK,ATTACK,ATTACK,ATTACK,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],620),ht([TOUGH,TOUGH,TOUGH,TOUGH,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,RANGED_ATTACK,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],1070),ht([TOUGH,TOUGH,TOUGH,TOUGH,TOUGH,TOUGH,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,RANGED_ATTACK,RANGED_ATTACK,HEAL,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],1740)],priority:65,maxPerRoom:4,remoteRole:!1},remoteGuard:{role:"remoteGuard",family:"military",bodies:[ht([TOUGH,ATTACK,MOVE,MOVE],190),ht([TOUGH,TOUGH,ATTACK,ATTACK,ATTACK,MOVE,MOVE,MOVE,MOVE,MOVE],500),ht([TOUGH,TOUGH,TOUGH,ATTACK,ATTACK,ATTACK,ATTACK,RANGED_ATTACK,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],880)],priority:65,maxPerRoom:2,remoteRole:!0},healer:{role:"healer",family:"military",bodies:[ht([HEAL,MOVE,MOVE],350),ht([TOUGH,HEAL,HEAL,MOVE,MOVE,MOVE],620),ht([TOUGH,TOUGH,HEAL,HEAL,HEAL,HEAL,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],1240),ht([TOUGH,TOUGH,TOUGH,TOUGH,HEAL,HEAL,HEAL,HEAL,HEAL,HEAL,HEAL,HEAL,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],2640)],priority:55,maxPerRoom:1,remoteRole:!1},soldier:{role:"soldier",family:"military",bodies:[ht([ATTACK,ATTACK,MOVE,MOVE],260),ht([ATTACK,ATTACK,ATTACK,ATTACK,MOVE,MOVE,MOVE,MOVE],520),ht([TOUGH,TOUGH,TOUGH,TOUGH,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,RANGED_ATTACK,RANGED_ATTACK,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],1340)],priority:50,maxPerRoom:1,remoteRole:!1},siegeUnit:{role:"siegeUnit",family:"military",bodies:[ht([WORK,WORK,MOVE,MOVE],300),ht([TOUGH,TOUGH,WORK,WORK,WORK,WORK,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],620),ht([TOUGH,TOUGH,TOUGH,TOUGH,WORK,WORK,WORK,WORK,WORK,WORK,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],1040)],priority:30,maxPerRoom:1,remoteRole:!1},ranger:{role:"ranger",family:"military",bodies:[ht([TOUGH,RANGED_ATTACK,RANGED_ATTACK,MOVE,MOVE,MOVE],360),ht([TOUGH,TOUGH,RANGED_ATTACK,RANGED_ATTACK,RANGED_ATTACK,MOVE,MOVE,MOVE,MOVE,MOVE],570),ht([TOUGH,TOUGH,TOUGH,RANGED_ATTACK,RANGED_ATTACK,RANGED_ATTACK,RANGED_ATTACK,RANGED_ATTACK,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],1040),ht([TOUGH,TOUGH,TOUGH,TOUGH,RANGED_ATTACK,RANGED_ATTACK,RANGED_ATTACK,RANGED_ATTACK,RANGED_ATTACK,RANGED_ATTACK,RANGED_ATTACK,RANGED_ATTACK,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],1480)],priority:60,maxPerRoom:4,remoteRole:!1},harasser:{role:"harasser",family:"military",bodies:[ht([TOUGH,ATTACK,RANGED_ATTACK,MOVE,MOVE],320),ht([TOUGH,TOUGH,ATTACK,ATTACK,RANGED_ATTACK,RANGED_ATTACK,MOVE,MOVE,MOVE,MOVE],640),ht([TOUGH,TOUGH,TOUGH,ATTACK,ATTACK,ATTACK,RANGED_ATTACK,RANGED_ATTACK,RANGED_ATTACK,HEAL,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],1200)],priority:40,maxPerRoom:1,remoteRole:!1},scout:{role:"scout",family:"utility",bodies:[ht([MOVE],50)],priority:30,maxPerRoom:1,remoteRole:!0},claimer:{role:"claimer",family:"utility",bodies:[ht([CLAIM,MOVE],650),ht([CLAIM,CLAIM,MOVE,MOVE],1300)],priority:50,maxPerRoom:3,remoteRole:!0},engineer:{role:"engineer",family:"utility",bodies:[ht([WORK,CARRY,MOVE,MOVE],250),ht([WORK,WORK,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE],500)],priority:55,maxPerRoom:2,remoteRole:!1},remoteWorker:{role:"remoteWorker",family:"utility",bodies:[ht([WORK,WORK,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE],500),ht([WORK,WORK,WORK,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],750)],priority:45,maxPerRoom:4,remoteRole:!0},powerHarvester:{role:"powerHarvester",family:"power",bodies:[ht([TOUGH,TOUGH,TOUGH,TOUGH,TOUGH,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],2300),ht([TOUGH,TOUGH,TOUGH,TOUGH,TOUGH,TOUGH,TOUGH,TOUGH,TOUGH,TOUGH,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,ATTACK,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE],3e3)],priority:30,maxPerRoom:2,remoteRole:!0},powerCarrier:{role:"powerCarrier",family:"power",bodies:[ht([...Array(20).fill(CARRY),...Array(20).fill(MOVE)],2e3),ht([...Array(25).fill(CARRY),...Array(25).fill(MOVE)],2500)],priority:25,maxPerRoom:2,remoteRole:!0}};var Rt,Et=Object.freeze({__proto__:null,ROLE_DEFINITIONS:yt});function Tt(e,t){return{id:e,coreRoom:t,memberRooms:[t],remoteRooms:[],forwardBases:[],role:"economic",metrics:{energyIncome:0,energyConsumption:0,energyBalance:0,warIndex:0,economyIndex:50},squads:[],rallyPoints:[],defenseRequests:[],resourceRequests:[],lastUpdate:0}}!function(e){e[e.None=0]="None",e[e.Pheromones=1]="Pheromones",e[e.Paths=2]="Paths",e[e.Traffic=4]="Traffic",e[e.Defense=8]="Defense",e[e.Economy=16]="Economy",e[e.Construction=32]="Construction",e[e.Performance=64]="Performance"}(Rt||(Rt={}));var Ct=Object.freeze({__proto__:null,get VisualizationLayer(){return Rt},createDefaultClusterMemory:Tt,createDefaultCreepMemory:function(e,t,r){return{role:e,family:t,homeRoom:r,version:1}},createDefaultEmpireMemory:function(){return{knownRooms:{},clusters:[],warTargets:[],ownedRooms:{},claimQueue:[],nukeCandidates:[],powerBanks:[],market:{resources:{},lastScan:0,pendingArbitrage:[],completedArbitrage:0,arbitrageProfit:0},objectives:{targetPowerLevel:0,targetRoomCount:1,warMode:!1,expansionPaused:!1},lastUpdate:0}},createDefaultMarketMemory:function(){return{resources:{},lastScan:0,pendingArbitrage:[],completedArbitrage:0,arbitrageProfit:0}},createDefaultPheromones:function(){return{expand:0,harvest:10,build:5,upgrade:5,defense:0,war:0,siege:0,logistics:5,nukeTarget:0}},createDefaultSwarmState:function(){return{colonyLevel:"seedNest",posture:"eco",danger:0,pheromones:{expand:0,harvest:10,build:5,upgrade:5,defense:0,war:0,siege:0,logistics:5,nukeTarget:0},nextUpdateTick:0,eventLog:[],missingStructures:{spawn:!0,storage:!0,terminal:!0,labs:!0,nuker:!0,factory:!0,extractor:!0,powerSpawn:!0,observer:!0},role:"secondaryCore",remoteAssignments:[],metrics:{energyHarvested:0,energySpawning:0,energyConstruction:0,energyRepair:0,energyTower:0,controllerProgress:0,hostileCount:0,damageReceived:0,constructionSites:0,energyAvailable:0,energyCapacity:0,energyNeed:0},lastUpdate:0}}});const vt=-1;function St(){const e=global;return e._heapCache&&e._heapCache.tick===Game.time||(e._heapCache?e._heapCache.tick=Game.time:e._heapCache={tick:Game.time,entries:new Map,rehydrated:!1}),e._heapCache}function _t(){return Memory._heapCache||(Memory._heapCache={version:1,lastSync:Game.time,data:{}}),Memory._heapCache}const bt=new class{constructor(){this.lastPersistenceTick=0}initialize(){const e=St();e.rehydrated||(this.rehydrateFromMemory(),e.rehydrated=!0)}rehydrateFromMemory(){const e=St(),t=_t();let r=0,o=0;for(const[n,s]of Object.entries(t.data))void 0!==s.ttl&&s.ttl!==vt&&Game.time-s.lastModified>s.ttl?o++:(e.entries.set(n,{value:s.value,lastModified:s.lastModified,dirty:!1,ttl:s.ttl}),r++);r>0&&Game.time%100==0&&de.info(`Rehydrated ${r} entries from Memory`,{subsystem:"HeapCache",meta:{rehydratedCount:r,expiredCount:o}})}get(e){const t=St(),r=t.entries.get(e);if(r)return void 0!==r.ttl&&r.ttl!==vt&&Game.time-r.lastModified>r.ttl?void t.entries.delete(e):r.value;const o=_t(),n=o.data[e];return n?void 0!==n.ttl&&n.ttl!==vt&&Game.time-n.lastModified>n.ttl?void delete o.data[e]:(t.entries.set(e,{value:n.value,lastModified:n.lastModified,dirty:!1,ttl:n.ttl}),n.value):void 0}set(e,t,r){St().entries.set(e,{value:t,lastModified:Game.time,dirty:!0,ttl:null!=r?r:1e3})}delete(e){St().entries.delete(e),delete _t().data[e]}has(e){return void 0!==this.get(e)}clear(){St().entries.clear(),_t().data={}}persist(e=!1){if(!e&&10>Game.time-this.lastPersistenceTick)return 0;const t=St(),r=_t();let o=0;for(const[e,n]of t.entries)n.dirty&&(r.data[e]={value:n.value,lastModified:n.lastModified,ttl:n.ttl},n.dirty=!1,o++);return r.lastSync=Game.time,this.lastPersistenceTick=Game.time,o}getStats(){const e=St(),t=_t();let r=0;for(const t of e.entries.values())t.dirty&&r++;return{heapSize:e.entries.size,memorySize:Object.keys(t.data).length,dirtyEntries:r,lastSync:t.lastSync}}keys(){const e=St();return Array.from(e.entries.keys())}values(){const e=St();return Array.from(e.entries.values()).map(e=>e.value)}cleanExpired(){const e=St(),t=_t();let r=0;for(const[t,o]of e.entries)void 0!==o.ttl&&o.ttl!==vt&&Game.time-o.lastModified>o.ttl&&(e.entries.delete(t),r++);for(const[e,o]of Object.entries(t.data))void 0!==o.ttl&&o.ttl!==vt&&Game.time-o.lastModified>o.ttl&&(delete t.data[e],r++);return r}},Ot=me("MemoryMonitor"),Ut=2097152,Mt=new class{constructor(){this.lastCheckTick=0,this.lastStatus="normal"}checkMemoryUsage(){const e=RawMemory.get().length,t=e/Ut;let r="normal";.9>t?.8>t||(r="warning"):r="critical",r!==this.lastStatus&&("critical"===r?(Game.notify(`CRITICAL: Memory at ${(100*t).toFixed(1)}% (${this.formatBytes(e)}/${this.formatBytes(Ut)})`),Ot.error("Memory usage critical",{meta:{used:e,limit:Ut,percentage:t}})):"warning"===r?Ot.warn("Memory usage warning",{meta:{used:e,limit:Ut,percentage:t}}):Ot.info("Memory usage normal",{meta:{used:e,limit:Ut,percentage:t}}),this.lastStatus=r);const o=this.getMemoryBreakdown();return{used:e,limit:Ut,percentage:t,status:r,breakdown:o}}getMemoryBreakdown(){const e=Memory,t=this.getObjectSize(e.empire),r=this.getObjectSize(Memory.rooms),o=this.getObjectSize(Memory.creeps),n=this.getObjectSize(e.clusters),s=this.getObjectSize(e.ss2PacketQueue),i=RawMemory.get().length;return{empire:t,rooms:r,creeps:o,clusters:n,ss2PacketQueue:s,other:Math.max(0,i-(t+r+o+n+s)),total:i}}getObjectSize(e){return null==e?0:JSON.stringify(e).length}formatBytes(e){return 1024>e?e+"B":1048576>e?(e/1024).toFixed(1)+"KB":(e/1048576).toFixed(2)+"MB"}logBreakdown(){const e=this.getMemoryBreakdown(),t=this.checkMemoryUsage();Ot.info("Memory Usage",{meta:{used:this.formatBytes(t.used),limit:this.formatBytes(t.limit),percentage:(100*t.percentage).toFixed(1)+"%",status:t.status.toUpperCase()}}),Ot.info("Memory Breakdown",{meta:{empire:`${this.formatBytes(e.empire)} (${(e.empire/e.total*100).toFixed(1)}%)`,rooms:`${this.formatBytes(e.rooms)} (${(e.rooms/e.total*100).toFixed(1)}%)`,creeps:`${this.formatBytes(e.creeps)} (${(e.creeps/e.total*100).toFixed(1)}%)`,clusters:`${this.formatBytes(e.clusters)} (${(e.clusters/e.total*100).toFixed(1)}%)`,ss2Queue:`${this.formatBytes(e.ss2PacketQueue)} (${(e.ss2PacketQueue/e.total*100).toFixed(1)}%)`,other:`${this.formatBytes(e.other)} (${(e.other/e.total*100).toFixed(1)}%)`}})}getLargestConsumers(e=10){const t=[];if(Memory.rooms)for(const e in Memory.rooms)t.push({type:"room",name:e,size:this.getObjectSize(Memory.rooms[e])});const r=Memory.clusters;if(r)for(const e in r)t.push({type:"cluster",name:e,size:this.getObjectSize(r[e])});return t.sort((e,t)=>t.size-e.size).slice(0,e)}},At=new class{pruneAll(){const e=RawMemory.get().length,t={deadCreeps:0,eventLogs:0,staleIntel:0,marketHistory:0,bytesSaved:0};t.deadCreeps=this.pruneDeadCreeps(),t.eventLogs=this.pruneEventLogs(20),t.staleIntel=this.pruneStaleIntel(1e4),t.marketHistory=this.pruneMarketHistory(5e3);const r=RawMemory.get().length;return t.bytesSaved=Math.max(0,e-r),t.bytesSaved>0&&de.info("Memory pruning complete",{subsystem:"MemoryPruner",meta:t}),t}pruneDeadCreeps(){let e=0;for(const t in Memory.creeps)t in Game.creeps||(delete Memory.creeps[t],e++);return e}pruneEventLogs(e){let t=0;if(!Memory.rooms)return 0;for(const r in Memory.rooms){const o=Memory.rooms[r],n=null==o?void 0:o.swarm;if((null==n?void 0:n.eventLog)&&n.eventLog.length>e){const r=n.eventLog.length-e;n.eventLog.splice(0,r),t+=r}}return t}pruneStaleIntel(e){var t;const r=Memory.empire;if(!(null==r?void 0:r.knownRooms))return 0;let o=0;const n=Game.time-e;for(const e in r.knownRooms){const s=r.knownRooms[e],i=Game.rooms[e];(null===(t=null==i?void 0:i.controller)||void 0===t?void 0:t.my)||s.lastSeen>=n||s.isHighway||s.hasPortal||(delete r.knownRooms[e],o++)}return o}pruneMarketHistory(e){const t=Memory.empire;if(!(null==t?void 0:t.market))return 0;const r=t.market.priceHistory;if(!r)return 0;let o=0;const n=Game.time-e;for(const e in r){const t=r[e];if(!t)continue;const s=t.length;r[e]=t.filter(e=>e.time>=n),o+=s-r[e].length}return o}pruneCompletedConstruction(){var e;let t=0;if(!Memory.rooms)return 0;for(const r in Memory.rooms){if(!Game.rooms[r])continue;const o=Memory.rooms[r];if(null===(e=o.construction)||void 0===e?void 0:e.sites){const e=o.construction.sites.length;o.construction.sites=o.construction.sites.filter(e=>null!==Game.getObjectById(e)),t+=e-o.construction.sites.length}}return t}prunePowerBanks(){const e=Memory.empire;if(!(null==e?void 0:e.powerBanks))return 0;const t=e.powerBanks.length;return e.powerBanks=e.powerBanks.filter(e=>e.decayTick>Game.time),t-e.powerBanks.length}pruneOldNukes(){const e=Memory.empire;if(!e)return 0;let t=0;if(e.nukesInFlight)for(const r in e.nukesInFlight)e.nukesInFlight[r].impactTick<Game.time&&(delete e.nukesInFlight[r],t++);if(e.incomingNukes){const r=e.incomingNukes.length;e.incomingNukes=e.incomingNukes.filter(e=>e.impactTick>=Game.time),t+=r-e.incomingNukes.length}return t}getRecommendations(){const e=[],t=Memory.empire;if(Memory.rooms)for(const t in Memory.rooms){const r=Memory.rooms[t],o=null==r?void 0:r.swarm;(null==o?void 0:o.eventLog)&&o.eventLog.length>40&&e.push(`Room ${t} has ${o.eventLog.length} event log entries (recommended max: 20)`)}if(null==t?void 0:t.knownRooms){let r=0;const o=Game.time-1e4;for(const e in t.knownRooms){const n=t.knownRooms[e];n.lastSeen>=o||n.isHighway||n.hasPortal||r++}r>50&&e.push(r+" stale intel entries (older than 10000 ticks)")}let r=0;for(const e in Memory.creeps)e in Game.creeps||r++;return r>10&&e.push(r+" dead creeps in memory"),e}},wt={ACTIVE_ROOMS:{start:0,end:9},HISTORICAL_INTEL:{start:10,end:19},MARKET_HISTORY:{start:20,end:29},STANDARDS_DATA:{start:30,end:39},ARCHIVED_EMPIRE:{start:40,end:49},RESERVED:{start:50,end:89},STATS:{start:90,end:99}},kt=new class{constructor(){this.activeSegments=new Set,this.segmentCache=new Map}requestSegment(e){if(0>e||e>99)throw Error(`Invalid segment ID: ${e}. Must be 0-99.`);this.activeSegments.add(e);const t=Array.from(this.activeSegments);if(t.length>10)throw de.error("Cannot have more than 10 active segments",{subsystem:"MemorySegmentManager",meta:{requested:e,currentCount:t.length,activeSegments:t}}),this.activeSegments.delete(e),Error(`Segment limit exceeded: Cannot load segment ${e}. Already have ${t.length-1} active segments (limit: 10). Release a segment first.`);RawMemory.setActiveSegments(t)}releaseSegment(e){this.activeSegments.delete(e),this.segmentCache.delete(e),RawMemory.setActiveSegments(Array.from(this.activeSegments))}isSegmentLoaded(e){return void 0!==RawMemory.segments[e]}writeSegment(e,t,r,o=1){if(!this.isSegmentLoaded(e))return de.warn("Attempted to write to unloaded segment",{subsystem:"MemorySegmentManager",meta:{segmentId:e,key:t}}),!1;try{const n=RawMemory.segments[e],s=n?JSON.parse(n):{},i={data:r,lastUpdate:Game.time,version:o};s[t]=i;const a=JSON.stringify(s);return a.length>102400?(de.error("Segment data exceeds 100KB limit",{subsystem:"MemorySegmentManager",meta:{segmentId:e,key:t,size:a.length}}),!1):(RawMemory.segments[e]=a,this.segmentCache.set(e,s),!0)}catch(r){return de.error("Failed to write segment data",{subsystem:"MemorySegmentManager",meta:{segmentId:e,key:t,error:r+""}}),!1}}readSegment(e,t){if(!this.isSegmentLoaded(e))return de.warn("Attempted to read from unloaded segment",{subsystem:"MemorySegmentManager",meta:{segmentId:e,key:t}}),null;try{let r=this.segmentCache.get(e);if(!r){const t=RawMemory.segments[e];if(!t)return null;if(r=JSON.parse(t),null==r)return null;this.segmentCache.set(e,r)}const o=r[t];return o?o.data:null}catch(r){return de.error("Failed to read segment data",{subsystem:"MemorySegmentManager",meta:{segmentId:e,key:t,error:r+""}}),null}}getSegmentMetadata(e,t){if(!this.isSegmentLoaded(e))return null;try{const r=RawMemory.segments[e];if(!r)return null;const o=JSON.parse(r)[t];return o?{lastUpdate:o.lastUpdate,version:o.version}:null}catch(e){return null}}deleteSegmentKey(e,t){if(!this.isSegmentLoaded(e))return!1;try{const r=RawMemory.segments[e];if(!r)return!1;const o=JSON.parse(r);return delete o[t],RawMemory.segments[e]=JSON.stringify(o),this.segmentCache.set(e,o),!0}catch(e){return!1}}clearSegment(e){this.isSegmentLoaded(e)?(RawMemory.segments[e]="",this.segmentCache.delete(e)):de.warn("Attempted to clear unloaded segment",{subsystem:"MemorySegmentManager",meta:{segmentId:e}})}getSegmentKeys(e){if(!this.isSegmentLoaded(e))return[];try{const t=RawMemory.segments[e];if(!t)return[];const r=JSON.parse(t);return Object.keys(r)}catch(e){return[]}}getSegmentSize(e){if(!this.isSegmentLoaded(e))return 0;const t=RawMemory.segments[e];return t?t.length:0}getActiveSegments(){return Array.from(this.activeSegments)}suggestSegmentForType(e){const t=wt[e];for(let e=t.start;e<=t.end;e++)if(!this.isSegmentLoaded(e)||92160>this.getSegmentSize(e))return e;return t.start}migrateToSegment(e,t,r){const o=e.split(".");let n=Memory;for(const s of o){if(!n||"object"!=typeof n||!(s in n))return de.warn("Memory path not found for migration",{subsystem:"MemorySegmentManager",meta:{memoryPath:e,segmentId:t,key:r}}),!1;n=n[s]}if(!this.isSegmentLoaded(t))return this.requestSegment(t),de.info("Segment not loaded, will migrate next tick",{subsystem:"MemorySegmentManager",meta:{memoryPath:e,segmentId:t,key:r}}),!1;const s=this.writeSegment(t,r,n);return s&&de.info("Successfully migrated data to segment",{subsystem:"MemorySegmentManager",meta:{memoryPath:e,segmentId:t,key:r,dataSize:JSON.stringify(n).length}}),s}};var Nt,Pt,It,xt={exports:{}},$t=(Nt||(Nt=1,Pt=xt,It=function(){var e=String.fromCharCode,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",o={};function n(e,t){if(!o[e]){o[e]={};for(var r=0;r<e.length;r++)o[e][e.charAt(r)]=r}return o[e][t]}var s={compressToBase64:function(e){if(null==e)return"";var r=s._compress(e,6,function(e){return t.charAt(e)});switch(r.length%4){default:case 0:return r;case 1:return r+"===";case 2:return r+"==";case 3:return r+"="}},decompressFromBase64:function(e){return null==e?"":""==e?null:s._decompress(e.length,32,function(r){return n(t,e.charAt(r))})},compressToUTF16:function(t){return null==t?"":s._compress(t,15,function(t){return e(t+32)})+" "},decompressFromUTF16:function(e){return null==e?"":""==e?null:s._decompress(e.length,16384,function(t){return e.charCodeAt(t)-32})},compressToUint8Array:function(e){for(var t=s.compress(e),r=new Uint8Array(2*t.length),o=0,n=t.length;n>o;o++){var i=t.charCodeAt(o);r[2*o]=i>>>8,r[2*o+1]=i%256}return r},decompressFromUint8Array:function(t){if(null==t)return s.decompress(t);for(var r=Array(t.length/2),o=0,n=r.length;n>o;o++)r[o]=256*t[2*o]+t[2*o+1];var i=[];return r.forEach(function(t){i.push(e(t))}),s.decompress(i.join(""))},compressToEncodedURIComponent:function(e){return null==e?"":s._compress(e,6,function(e){return r.charAt(e)})},decompressFromEncodedURIComponent:function(e){return null==e?"":""==e?null:(e=e.replace(/ /g,"+"),s._decompress(e.length,32,function(t){return n(r,e.charAt(t))}))},compress:function(t){return s._compress(t,16,function(t){return e(t)})},_compress:function(e,t,r){if(null==e)return"";var o,n,s,i={},a={},c="",l="",u="",m=2,d=3,p=2,g=[],f=0,h=0;for(s=0;s<e.length;s+=1)if(c=e.charAt(s),{}.hasOwnProperty.call(i,c)||(i[c]=d++,a[c]=!0),l=u+c,{}.hasOwnProperty.call(i,l))u=l;else{if({}.hasOwnProperty.call(a,u)){if(256>u.charCodeAt(0)){for(o=0;p>o;o++)f<<=1,h==t-1?(h=0,g.push(r(f)),f=0):h++;for(n=u.charCodeAt(0),o=0;8>o;o++)f=f<<1|1&n,h==t-1?(h=0,g.push(r(f)),f=0):h++,n>>=1}else{for(n=1,o=0;p>o;o++)f=f<<1|n,h==t-1?(h=0,g.push(r(f)),f=0):h++,n=0;for(n=u.charCodeAt(0),o=0;16>o;o++)f=f<<1|1&n,h==t-1?(h=0,g.push(r(f)),f=0):h++,n>>=1}0==--m&&(m=Math.pow(2,p),p++),delete a[u]}else for(n=i[u],o=0;p>o;o++)f=f<<1|1&n,h==t-1?(h=0,g.push(r(f)),f=0):h++,n>>=1;0==--m&&(m=Math.pow(2,p),p++),i[l]=d++,u=c+""}if(""!==u){if({}.hasOwnProperty.call(a,u)){if(256>u.charCodeAt(0)){for(o=0;p>o;o++)f<<=1,h==t-1?(h=0,g.push(r(f)),f=0):h++;for(n=u.charCodeAt(0),o=0;8>o;o++)f=f<<1|1&n,h==t-1?(h=0,g.push(r(f)),f=0):h++,n>>=1}else{for(n=1,o=0;p>o;o++)f=f<<1|n,h==t-1?(h=0,g.push(r(f)),f=0):h++,n=0;for(n=u.charCodeAt(0),o=0;16>o;o++)f=f<<1|1&n,h==t-1?(h=0,g.push(r(f)),f=0):h++,n>>=1}0==--m&&(m=Math.pow(2,p),p++),delete a[u]}else for(n=i[u],o=0;p>o;o++)f=f<<1|1&n,h==t-1?(h=0,g.push(r(f)),f=0):h++,n>>=1;0==--m&&(m=Math.pow(2,p),p++)}for(n=2,o=0;p>o;o++)f=f<<1|1&n,h==t-1?(h=0,g.push(r(f)),f=0):h++,n>>=1;for(;;){if(f<<=1,h==t-1){g.push(r(f));break}h++}return g.join("")},decompress:function(e){return null==e?"":""==e?null:s._decompress(e.length,32768,function(t){return e.charCodeAt(t)})},_decompress:function(t,r,o){var n,s,i,a,c,l,u,m=[],d=4,p=4,g=3,f="",h=[],y={val:o(0),position:r,index:1};for(n=0;3>n;n+=1)m[n]=n;for(i=0,c=4,l=1;l!=c;)a=y.val&y.position,y.position>>=1,0==y.position&&(y.position=r,y.val=o(y.index++)),i|=(a>0?1:0)*l,l<<=1;switch(i){case 0:for(i=0,c=256,l=1;l!=c;)a=y.val&y.position,y.position>>=1,0==y.position&&(y.position=r,y.val=o(y.index++)),i|=(a>0?1:0)*l,l<<=1;u=e(i);break;case 1:for(i=0,c=65536,l=1;l!=c;)a=y.val&y.position,y.position>>=1,0==y.position&&(y.position=r,y.val=o(y.index++)),i|=(a>0?1:0)*l,l<<=1;u=e(i);break;case 2:return""}for(m[3]=u,s=u,h.push(u);;){if(y.index>t)return"";for(i=0,c=Math.pow(2,g),l=1;l!=c;)a=y.val&y.position,y.position>>=1,0==y.position&&(y.position=r,y.val=o(y.index++)),i|=(a>0?1:0)*l,l<<=1;switch(u=i){case 0:for(i=0,c=256,l=1;l!=c;)a=y.val&y.position,y.position>>=1,0==y.position&&(y.position=r,y.val=o(y.index++)),i|=(a>0?1:0)*l,l<<=1;m[p++]=e(i),u=p-1,d--;break;case 1:for(i=0,c=65536,l=1;l!=c;)a=y.val&y.position,y.position>>=1,0==y.position&&(y.position=r,y.val=o(y.index++)),i|=(a>0?1:0)*l,l<<=1;m[p++]=e(i),u=p-1,d--;break;case 2:return h.join("")}if(0==d&&(d=Math.pow(2,g),g++),m[u])f=m[u];else{if(u!==p)return null;f=s+s.charAt(0)}h.push(f),m[p++]=s+f.charAt(0),s=f,0==--d&&(d=Math.pow(2,g),g++)}}};return s}(),null!=Pt?Pt.exports=It:"undefined"!=typeof angular&&null!=angular&&angular.module("LZString",[]).factory("LZString",function(){return It})),xt.exports);const Gt=new class{compress(e,t=1){const r=JSON.stringify(e),o=r.length,n=$t.compressToUTF16(r);return{compressed:n,originalSize:o,compressedSize:n.length,timestamp:Game.time,version:t}}decompress(e){try{const t="string"==typeof e?e:e.compressed,r=$t.decompressFromUTF16(t);return r?JSON.parse(r):(de.error("Decompression returned null",{subsystem:"MemoryCompressor"}),null)}catch(e){return de.error("Failed to decompress data",{subsystem:"MemoryCompressor",meta:{error:e+""}}),null}}compressIntel(e){return this.compress(e)}decompressIntel(e){return this.decompress(e)}compressPortalMap(e){return this.compress(e)}decompressPortalMap(e){return this.decompress(e)}compressMarketHistory(e){return this.compress(e)}decompressMarketHistory(e){return this.decompress(e)}getCompressionStats(e){const t=this.compress(e),r=t.originalSize,o=t.compressedSize;return{originalSize:r,compressedSize:o,bytesSaved:r-o,ratio:o/r}}shouldCompress(e,t=1e3,r=.9){if(t>JSON.stringify(e).length)return!1;const o=this.compress(e);return o.compressedSize/o.originalSize<r}compressIfBeneficial(e,t=1e3,r=.9){return this.shouldCompress(e,t,r)?this.compress(e):e}isCompressed(e){return"object"==typeof e&&null!==e&&"compressed"in e&&"originalSize"in e&&"compressedSize"in e}getOrDecompress(e){return this.isCompressed(e)?this.decompress(e):e}batchCompress(e){const t={};for(const r in e)t[r]=this.compress(e[r]);return t}batchDecompress(e){const t={};for(const r in e)t[r]=this.decompress(e[r]);return t}formatStats(e){const t=(100*(1-e.ratio)).toFixed(1);return`${this.formatBytes(e.originalSize)}  ${this.formatBytes(e.compressedSize)} (${t}% saved)`}formatBytes(e){return 1024>e?e+"B":1048576>e?(e/1024).toFixed(1)+"KB":(e/1048576).toFixed(2)+"MB"}},Lt=[{version:4,description:"Move historical intel to memory segments",migrate:e=>{var t,r;const o=e.empire;if(!(null==o?void 0:o.knownRooms))return;const n={},s={},i=Game.time-5e3;for(const e in o.knownRooms){const a=o.knownRooms[e];a.lastSeen>=i||(null===(r=null===(t=Game.rooms[e])||void 0===t?void 0:t.controller)||void 0===r?void 0:r.my)||a.isHighway||a.hasPortal?n[e]=a:s[e]=a}if(Object.keys(s).length>0){const e=kt.suggestSegmentForType("HISTORICAL_INTEL");if(!kt.isSegmentLoaded(e))return kt.requestSegment(e),void de.info("Segment not loaded, migration will continue next tick",{subsystem:"MemoryMigrations",meta:{segmentId:e}});if(!kt.writeSegment(e,"historicalIntel",s))return void de.error("Failed to write historical intel to segment",{subsystem:"MemoryMigrations",meta:{segmentId:e}});o.knownRooms=n,de.info("Migrated historical intel to segments",{subsystem:"MemoryMigrations",meta:{historicalCount:Object.keys(s).length,activeCount:Object.keys(n).length,segmentId:e}})}}},{version:5,description:"Compress portal map data",migrate:e=>{const t=e.empire;if(!t)return;const r=t,o=r.portals;if(o&&!Gt.isCompressed(o)){const e=Gt.compressPortalMap(o);r.compressedPortals=e,delete r.portals,de.info("Compressed portal map data",{subsystem:"MemoryMigrations",meta:{originalSize:e.originalSize,compressedSize:e.compressedSize,ratio:(e.compressedSize/e.originalSize*100).toFixed(1)+"%"}})}}},{version:6,description:"Move market history to segments with compression",migrate:e=>{const t=e.empire;if(!(null==t?void 0:t.market))return;const r=t.market,o=r.priceHistory;if(!o)return;const n=Gt.compressMarketHistory(o),s=kt.suggestSegmentForType("MARKET_HISTORY");if(!kt.isSegmentLoaded(s))return kt.requestSegment(s),void de.info("Segment not loaded, migration will continue next tick",{subsystem:"MemoryMigrations",meta:{segmentId:s}});kt.writeSegment(s,"priceHistory",n)?(delete r.priceHistory,de.info("Migrated market history to segments",{subsystem:"MemoryMigrations",meta:{originalSize:n.originalSize,compressedSize:n.compressedSize,segmentId:s}})):de.error("Failed to write market history to segment",{subsystem:"MemoryMigrations",meta:{segmentId:s}})}},{version:7,description:"Ensure all clusters have required array properties",migrate:e=>{const t=e.clusters;if(!t)return;let r=0;for(const e in t){const o=t[e];o.squads||(o.squads=[],r++),o.defenseRequests||(o.defenseRequests=[],r++),o.resourceRequests||(o.resourceRequests=[],r++),o.rallyPoints||(o.rallyPoints=[],r++)}r>0&&de.info(`Migrated ${r} cluster array properties`,{subsystem:"MemoryMigrations",meta:{clustersProcessed:Object.keys(t).length}})}}],Dt=new class{runMigrations(){var e;const t=Memory,r=null!==(e=t.memoryVersion)&&void 0!==e?e:0,o=Lt.filter(e=>e.version>r);if(0!==o.length){de.info(`Running ${o.length} memory migration(s)`,{subsystem:"MigrationRunner",meta:{fromVersion:r,toVersion:o[o.length-1].version}});for(const e of o)try{de.info(`Running migration v${e.version}: ${e.description}`,{subsystem:"MigrationRunner"}),e.migrate(Memory),t.memoryVersion=e.version,de.info(`Migration v${e.version} complete`,{subsystem:"MigrationRunner"})}catch(t){de.error(`Migration v${e.version} failed`,{subsystem:"MigrationRunner",meta:{error:t+""}}),Game.notify(`Migration v${e.version} failed: ${t+""}`);break}}}getCurrentVersion(){var e;return null!==(e=Memory.memoryVersion)&&void 0!==e?e:0}getLatestVersion(){return 0===Lt.length?0:Math.max(...Lt.map(e=>e.version))}hasPendingMigrations(){return this.getCurrentVersion()<this.getLatestVersion()}getPendingMigrations(){const e=this.getCurrentVersion();return Lt.filter(t=>t.version>e)}rollbackToVersion(e){const t=Memory;de.warn("Rolling back memory version to "+e,{subsystem:"MigrationRunner",meta:{fromVersion:this.getCurrentVersion(),toVersion:e}}),t.memoryVersion=e,Game.notify(`Memory version rolled back to ${e}. Data may be inconsistent!`)}},Ft="empire",Bt="clusters";class Ht{constructor(){this.lastInitializeTick=null,this.lastCleanupTick=0,this.lastPruningTick=0,this.lastMonitoringTick=0}initialize(){this.lastInitializeTick!==Game.time&&(this.lastInitializeTick=Game.time,bt.initialize(),Dt.runMigrations(),this.ensureEmpireMemory(),this.ensureClustersMemory(),10>Game.time-this.lastCleanupTick||(this.cleanDeadCreeps(),this.lastCleanupTick=Game.time),100>Game.time-this.lastPruningTick||(At.pruneAll(),this.lastPruningTick=Game.time),50>Game.time-this.lastMonitoringTick||(Mt.checkMemoryUsage(),this.lastMonitoringTick=Game.time))}ensureEmpireMemory(){const e=Memory;e[Ft]||(e[Ft]={knownRooms:{},clusters:[],warTargets:[],ownedRooms:{},claimQueue:[],nukeCandidates:[],powerBanks:[],market:{resources:{},lastScan:0,pendingArbitrage:[],completedArbitrage:0,arbitrageProfit:0},objectives:{targetPowerLevel:0,targetRoomCount:1,warMode:!1,expansionPaused:!1},lastUpdate:0})}ensureClustersMemory(){const e=Memory;e[Bt]||(e[Bt]={})}getEmpire(){const e="memory:"+Ft;let t=bt.get(e);if(!t){this.ensureEmpireMemory();const r=Memory;bt.set(e,r[Ft],vt),t=r[Ft]}return t}getClusters(){const e="memory:"+Bt;let t=bt.get(e);if(!t){this.ensureClustersMemory();const r=Memory;bt.set(e,r[Bt],vt),t=r[Bt]}return t}getCluster(e,t){const r=this.getClusters();return!r[e]&&t&&(r[e]=Tt(e,t)),r[e]}getSwarmState(e){var t;const r=`memory:room:${e}:swarm`;let o=bt.get(r);if(!o){const n=null===(t=Memory.rooms)||void 0===t?void 0:t[e];if(!n)return;const s=n.swarm;s&&(bt.set(r,s,vt),o=s)}return o}initSwarmState(e){const t=`memory:room:${e}:swarm`;Memory.rooms||(Memory.rooms={}),Memory.rooms[e]||(Memory.rooms[e]={});const r=Memory.rooms[e];return r.swarm||(r.swarm={colonyLevel:"seedNest",posture:"eco",danger:0,pheromones:{expand:0,harvest:10,build:5,upgrade:5,defense:0,war:0,siege:0,logistics:5,nukeTarget:0},nextUpdateTick:0,eventLog:[],missingStructures:{spawn:!0,storage:!0,terminal:!0,labs:!0,nuker:!0,factory:!0,extractor:!0,powerSpawn:!0,observer:!0},role:"secondaryCore",remoteAssignments:[],metrics:{energyHarvested:0,energySpawning:0,energyConstruction:0,energyRepair:0,energyTower:0,controllerProgress:0,hostileCount:0,damageReceived:0,constructionSites:0,energyAvailable:0,energyCapacity:0,energyNeed:0},lastUpdate:0}),bt.set(t,r.swarm,vt),r.swarm}getOrInitSwarmState(e){var t;return null!==(t=this.getSwarmState(e))&&void 0!==t?t:this.initSwarmState(e)}getCreepMemory(e){const t=Game.creeps[e];if(t)return t.memory}cleanDeadCreeps(){let e=0;for(const t in Memory.creeps)t in Game.creeps||(delete Memory.creeps[t],e++);return e}recordRoomSeen(e){const t=this.getEmpire();t.knownRooms[e]?t.knownRooms[e].lastSeen=Game.time:t.knownRooms[e]={name:e,lastSeen:Game.time,sources:0,controllerLevel:0,threatLevel:0,scouted:!1,terrain:"mixed",isHighway:!1,isSK:!1}}addRoomEvent(e,t,r){const o=this.getSwarmState(e);if(!o)return;const n={type:t,time:Game.time};for(void 0!==r&&(n.details=r),o.eventLog.push(n);o.eventLog.length>20;)o.eventLog.shift()}getMemorySize(){return JSON.stringify(Memory).length}isMemoryNearLimit(){return this.getMemorySize()>1887436.8}persistHeapCache(){bt.persist()}getHeapCache(){return bt}isRoomHostile(e){var t,r,o;const n=`memory:room:${e}:hostile`,s=bt.get(n);if(void 0!==s)return!0===s;const i=null!==(o=null===(r=null===(t=Memory.rooms)||void 0===t?void 0:t[e])||void 0===r?void 0:r.hostile)&&void 0!==o&&o;return bt.set(n,!!i||null,100),i}setRoomHostile(e,t){Memory.rooms||(Memory.rooms={}),Memory.rooms[e]||(Memory.rooms[e]={}),Memory.rooms[e].hostile=t;const r=`memory:room:${e}:hostile`;bt.set(r,!!t||null,100)}}const Wt=new Ht;var Yt=Object.freeze({__proto__:null,MemoryManager:Ht,memoryManager:Wt});function Kt(e){var t,r;const o={guards:0,rangers:0,healers:0,urgency:1,reasons:[]},n=null!==(r=null===(t=e.controller)||void 0===t?void 0:t.level)&&void 0!==r?r:1;3>n||(o.guards=1,o.rangers=1,o.reasons.push("Baseline defense force for RCL "+n));const s=e.find(FIND_HOSTILE_CREEPS);if(0===s.length)return o;let i=0,a=0,c=0,l=0,u=0;for(const e of s){const t=e.body;t.some(e=>void 0!==e.boost)&&u++;for(const e of t)e.type===ATTACK&&i++,e.type===RANGED_ATTACK&&a++,e.type===HEAL&&c++,e.type===WORK&&l++}return i>0&&(o.guards=Math.max(1,Math.ceil(i/4)),o.reasons.push(i+" melee parts detected")),a>0&&(o.rangers=Math.max(1,Math.ceil(a/6)),o.reasons.push(a+" ranged parts detected")),c>0&&(o.healers=Math.max(1,Math.ceil(c/8)),o.reasons.push(c+" heal parts detected")),l>0&&(o.guards+=Math.ceil(l/5),o.reasons.push(l+" work parts (dismantlers)")),u>0&&(o.guards=Math.ceil(1.5*o.guards),o.rangers=Math.ceil(1.5*o.rangers),o.healers=Math.ceil(1.5*o.healers),o.urgency=2,o.reasons.push(u+" boosted enemies (high threat)")),s.length>0&&(o.guards=Math.max(o.guards,2),o.rangers=Math.max(o.rangers,2)),3>s.length||(o.healers=Math.max(o.healers,1)),5>s.length||(o.urgency=Math.max(o.urgency,1.5),o.reasons.push(s.length+" hostiles (large attack)")),e.find(FIND_MY_STRUCTURES,{filter:e=>(e.structureType===STRUCTURE_SPAWN||e.structureType===STRUCTURE_STORAGE||e.structureType===STRUCTURE_TERMINAL)&&e.hits<.8*e.hitsMax}).length>0&&(o.urgency=3,o.reasons.push("Critical structures under attack!")),de.info(`Defender analysis for ${e.name}: ${o.guards} guards, ${o.rangers} rangers, ${o.healers} healers (urgency: ${o.urgency}x) - ${o.reasons.join(", ")}`,{subsystem:"Defense"}),o}function jt(e){const t=e.find(FIND_MY_CREEPS);return{guards:t.filter(e=>"guard"===e.memory.role).length,rangers:t.filter(e=>"ranger"===e.memory.role).length,healers:t.filter(e=>"healer"===e.memory.role).length}}function Vt(e,t,r){const o=Kt(e),n=jt(e);if(0===o.guards&&0===o.rangers&&0===o.healers)return 0;let s=0;return("guard"===r&&n.guards<o.guards||"ranger"===r&&n.rangers<o.rangers||"healer"===r&&n.healers<o.healers)&&(s=100*o.urgency),s}function qt(e,t){var r,o;if(1>t.danger)return!1;const n=Kt(e),s=jt(e),i=n.guards-s.guards+(n.rangers-s.rangers);if(0>=i)return!1;const a=e.find(FIND_MY_SPAWNS);if(0===a.length)return!0;if(0===a.filter(e=>!e.spawning).length&&i>=1)return!0;if(250>e.energyAvailable&&i>=1)return!0;if(n.urgency>=2&&i>=2)return!0;if(t.danger>=3&&i>=1)return!0;const c=null!==(o=null===(r=e.controller)||void 0===r?void 0:r.level)&&void 0!==o?o:1;return!(2>t.danger||2>i&&c>3)}function zt(e,t){if(!qt(e,t))return null;const r=Kt(e),o=jt(e),n={roomName:e.name,guardsNeeded:Math.max(0,r.guards-o.guards),rangersNeeded:Math.max(0,r.rangers-o.rangers),healersNeeded:Math.max(0,r.healers-o.healers),urgency:r.urgency,createdAt:Game.time,threat:r.reasons.join("; ")};return de.warn(`Defense assistance requested for ${e.name}: ${n.guardsNeeded} guards, ${n.rangersNeeded} rangers, ${n.healersNeeded} healers - ${n.threat}`,{subsystem:"Defense"}),n}var Xt=Object.freeze({__proto__:null,analyzeDefenderNeeds:Kt,createDefenseRequest:zt,getCurrentDefenders:jt,getDefenderPriorityBoost:Vt,needsDefenseAssistance:qt,needsEmergencyDefenders:function(e,t){const r=Kt(e),o=jt(e),n=r.guards>0&&0===o.guards,s=r.rangers>0&&0===o.rangers,i=r.urgency>=2;return(n||s)&&i}});function Qt(e,t,r){let o=0;if("guard"!==r&&"ranger"!==r&&"healer"!==r||(o+=Vt(e,0,r)),"upgrader"===r&&t.clusterId){const r=Wt.getCluster(t.clusterId);(null==r?void 0:r.focusRoom)===e.name&&(o+=40)}return o}function Zt(e,t){var r;const o={harvester:"harvest",hauler:"logistics",upgrader:"upgrade",builder:"build",guard:"defense",remoteGuard:"defense",healer:"defense",soldier:"war",siegeUnit:"siege",ranger:"war",scout:"expand",claimer:"expand",remoteWorker:"expand",engineer:"build",remoteHarvester:"harvest",remoteHauler:"logistics",interRoomCarrier:"logistics"}[e];return o?.5+(null!==(r=t[o])&&void 0!==r?r:0)/100*1.5:1}const Jt=[{carryParts:4,capacity:200,moveParts:4,cost:400},{carryParts:8,capacity:400,moveParts:8,cost:800},{carryParts:16,capacity:800,moveParts:16,cost:1600},{carryParts:24,capacity:1200,moveParts:24,cost:2400}];function er(e,t,r,o){const n=function(e,t){const r=e=>{const t=e.match(/^([WE])(\d+)([NS])(\d+)$/);return t?{x:"W"===t[1]?-parseInt(t[2],10):parseInt(t[2],10),y:"N"===t[3]?parseInt(t[4],10):-parseInt(t[4],10)}:{x:0,y:0}},o=r(e),n=r(t);return Math.abs(n.x-o.x)+Math.abs(n.y-o.y)}(e,t),s=function(e,t=1.2){return Math.ceil(50*e*t*2)}(n),i=10*r;let a=Jt[0];for(const e of Jt){if(e.cost>o)break;a=e}const c=Math.max(1,Math.ceil(i*s/a.capacity*1.2)),l=Math.min(2*r,c+1);return de.debug(`Remote hauler calculation: ${e} -> ${t} (${r} sources, ${n} rooms away) - RT: ${s} ticks, E/tick: ${i}, Min: ${c}, Rec: ${l}, Cap: ${a.capacity}`,{subsystem:"HaulerDimensioning"}),{minHaulers:c,recommendedHaulers:l,haulerConfig:a,distance:n,roundTripTicks:s,energyPerTick:i}}const tr={[MOVE]:50,[WORK]:100,[CARRY]:50,[ATTACK]:80,[RANGED_ATTACK]:150,[HEAL]:250,[CLAIM]:600,[TOUGH]:10};function rr(e){return e.reduce((e,t)=>e+tr[t],0)}var or;!function(e){e[e.EMERGENCY=1e3]="EMERGENCY",e[e.HIGH=500]="HIGH",e[e.NORMAL=100]="NORMAL",e[e.LOW=50]="LOW"}(or||(or={}));const nr=new class{constructor(){this.queues=new Map}getQueue(e){return this.queues.has(e)||this.queues.set(e,{requests:[],inProgress:new Map,lastUpdate:Game.time}),this.queues.get(e)}addRequest(e){const t=this.getQueue(e.roomName);e.id||(e.id=`${e.role}_${Game.time}_${Math.random().toString(36).substring(2,11)}`),t.requests.push(e),t.requests.sort((e,t)=>t.priority-e.priority),de.debug(`Added spawn request: ${e.role} (priority: ${e.priority}) for room ${e.roomName}`,{subsystem:"SpawnQueue"})}getNextRequest(e,t){const r=this.getQueue(e);this.cleanupInProgress(r);for(let e=0;e<r.requests.length;e++){const o=r.requests[e];if(!this.isRequestInProgress(r,o.id)&&o.body.cost<=t)return o}return null}removeRequest(e,t){const r=this.getQueue(e);r.requests=r.requests.filter(e=>e.id!==t)}markInProgress(e,t,r){this.getQueue(e).inProgress.set(t,{spawnId:r,requestId:t})}isRequestInProgress(e,t){return e.inProgress.has(t)}cleanupInProgress(e){const t=[];for(const[r,{spawnId:o}]of e.inProgress){const e=Game.getObjectById(o);e&&e.spawning||t.push(r)}for(const r of t)e.inProgress.delete(r)}getPendingRequests(e){return[...this.getQueue(e).requests]}getQueueSize(e){return this.getQueue(e).requests.length}clearQueue(e){this.getQueue(e).requests=[],de.debug("Cleared spawn queue for room "+e,{subsystem:"SpawnQueue"})}getAvailableSpawns(e){const t=Game.rooms[e];return t?t.find(FIND_MY_SPAWNS).filter(e=>!e.spawning):[]}processQueue(e){const t=Game.rooms[e];if(!t)return 0;const r=this.getAvailableSpawns(e);if(0===r.length)return 0;this.getQueue(e);let o=0;for(const n of r){const r=this.getNextRequest(e,t.energyAvailable);if(!r)break;const s=this.executeSpawn(n,r);s===OK?(o++,this.markInProgress(e,r.id,n.id),this.removeRequest(e,r.id)):s!==ERR_NOT_ENOUGH_ENERGY&&(this.removeRequest(e,r.id),de.warn(`Spawn request failed: ${r.role} in ${e} (error: ${s})`,{subsystem:"SpawnQueue"}))}return o}executeSpawn(e,t){const r=this.generateCreepName(t.role),o={role:t.role,family:t.family,homeRoom:t.roomName,version:1,...t.additionalMemory};return t.targetRoom&&(o.targetRoom=t.targetRoom),t.sourceId&&(o.sourceId=t.sourceId),t.boostRequirements&&(o.boostRequirements=t.boostRequirements),e.spawnCreep(t.body.parts,r,{memory:o})}generateCreepName(e){return`${e}_${Game.time}_${Math.random().toString(36).substring(2,11)}`}hasEmergencySpawns(e){return this.getQueue(e).requests.some(e=>e.priority>=or.EMERGENCY)}countByPriority(e,t){return this.getQueue(e).requests.filter(e=>e.priority>=t).length}getQueueStats(e){const t=this.getQueue(e);return{total:t.requests.length,emergency:t.requests.filter(e=>e.priority>=or.EMERGENCY).length,high:t.requests.filter(e=>e.priority>=or.HIGH&&e.priority<or.EMERGENCY).length,normal:t.requests.filter(e=>e.priority>=or.NORMAL&&e.priority<or.HIGH).length,low:t.requests.filter(e=>e.priority<or.NORMAL).length,inProgress:t.inProgress.size}}};function sr(e){return{name:e,role:"core",health:{cpuCategory:"low",cpuUsage:0,bucketLevel:1e4,economyIndex:50,warIndex:0,commodityIndex:0,roomCount:0,avgRCL:0,creepCount:0,lastUpdate:0},activeTasks:[],portals:[],cpuHistory:[],cpuLimit:0}}function ir(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t&=t;return Math.abs(t)}function ar(e){var t;const r={v:e.version,s:Object.entries(e.shards).map(([e,t])=>{var r;return{n:e,r:t.role[0],h:{c:t.health.cpuCategory[0],cu:Math.round(100*t.health.cpuUsage)/100,b:t.health.bucketLevel,e:Math.round(t.health.economyIndex),w:Math.round(t.health.warIndex),m:Math.round(t.health.commodityIndex),rc:t.health.roomCount,rl:Math.round(10*t.health.avgRCL)/10,cc:t.health.creepCount,u:t.health.lastUpdate},t:t.activeTasks,p:t.portals.map(e=>{var t;return{sr:e.sourceRoom,sp:`${e.sourcePos.x},${e.sourcePos.y}`,ts:e.targetShard,tr:e.targetRoom,th:e.threatRating,s:e.isStable?1:0,tc:null!==(t=e.traversalCount)&&void 0!==t?t:0}}),cl:t.cpuLimit,ch:(null!==(r=t.cpuHistory)&&void 0!==r?r:[]).slice(-5).map(e=>({t:e.tick,l:e.cpuLimit,u:Math.round(100*e.cpuUsed)/100,b:e.bucketLevel}))}}),g:{pl:e.globalTargets.targetPowerLevel,ws:e.globalTargets.mainWarShard,es:e.globalTargets.primaryEcoShard,ct:e.globalTargets.colonizationTarget,en:(null!==(t=e.globalTargets.enemies)&&void 0!==t?t:[]).map(e=>({u:e.username,r:e.rooms,t:e.threatLevel,s:e.lastSeen,a:e.isAlly?1:0}))},k:e.tasks.map(e=>({i:e.id,y:e.type[0],ss:e.sourceShard,ts:e.targetShard,tr:e.targetRoom,rt:e.resourceType,ra:e.resourceAmount,p:e.priority,st:e.status[0],pr:e.progress})),ls:e.lastSync},o=ir(JSON.stringify(r));return JSON.stringify({d:r,c:o})}function cr(e){var t,r,o,n,s;try{const i=JSON.parse(e),a=ir(JSON.stringify(i.d));if(i.c!==a)return de.warn("InterShardMemory checksum mismatch",{subsystem:"InterShard",meta:{expected:a,actual:i.c}}),null;const c=i.d,l={c:"core",f:"frontier",r:"resource",b:"backup",w:"war"},u={l:"low",m:"medium",h:"high",c:"critical"},m={c:"colonize",r:"reinforce",t:"transfer",e:"evacuate"},d={p:"pending",a:"active",c:"complete",f:"failed"},p={},g=c.s;for(const e of g)p[e.n]={name:e.n,role:null!==(t=l[e.r])&&void 0!==t?t:"core",health:{cpuCategory:null!==(r=u[e.h.c])&&void 0!==r?r:"low",cpuUsage:null!==(o=e.h.cu)&&void 0!==o?o:0,bucketLevel:null!==(n=e.h.b)&&void 0!==n?n:1e4,economyIndex:e.h.e,warIndex:e.h.w,commodityIndex:e.h.m,roomCount:e.h.rc,avgRCL:e.h.rl,creepCount:e.h.cc,lastUpdate:e.h.u},activeTasks:e.t,portals:e.p.map(e=>{var t;const[r,o]=e.sp.split(",");return{sourceRoom:e.sr,sourcePos:{x:parseInt(null!=r?r:"0",10),y:parseInt(null!=o?o:"0",10)},targetShard:e.ts,targetRoom:e.tr,threatRating:e.th,lastScouted:0,isStable:1===e.s,traversalCount:null!==(t=e.tc)&&void 0!==t?t:0}}),cpuLimit:e.cl,cpuHistory:(null!==(s=e.ch)&&void 0!==s?s:[]).map(e=>({tick:e.t,cpuLimit:e.l,cpuUsed:e.u,bucketLevel:e.b}))};const f=c.g,h=c.k,y={targetPowerLevel:f.pl};return f.ws&&(y.mainWarShard=f.ws),f.es&&(y.primaryEcoShard=f.es),f.ct&&(y.colonizationTarget=f.ct),f.en&&(y.enemies=f.en.map(e=>({username:e.u,rooms:e.r,threatLevel:e.t,lastSeen:e.s,isAlly:1===e.a}))),{version:c.v,shards:p,globalTargets:y,tasks:h.map(e=>{var t,r;const o={id:e.i,type:null!==(t=m[e.y])&&void 0!==t?t:"colonize",sourceShard:e.ss,targetShard:e.ts,priority:e.p,status:null!==(r=d[e.st])&&void 0!==r?r:"pending",createdAt:0};return e.tr&&(o.targetRoom=e.tr),e.rt&&(o.resourceType=e.rt),void 0!==e.ra&&(o.resourceAmount=e.ra),void 0!==e.pr&&(o.progress=e.pr),o}),lastSync:c.ls,checksum:i.c}}catch(e){return de.error("Failed to deserialize InterShardMemory: "+e,{subsystem:"InterShard"}),null}}const lr=102400,ur=[],mr=new Set;function dr(e){return function(t,r,o){ur.push({options:e,methodName:r+"",target:t})}}function pr(e,t,r){return dr({id:e,name:t,priority:Be.MEDIUM,frequency:"medium",minBucket:0,cpuBudget:.15,interval:5,...r})}function gr(e,t,r){return dr({id:e,name:t,priority:Be.LOW,frequency:"low",minBucket:0,cpuBudget:.1,interval:20,...r})}function fr(e,t,r){return dr({id:e,name:t,priority:Be.IDLE,frequency:"low",minBucket:0,cpuBudget:.05,interval:100,...r})}function hr(){return function(e){return mr.add(e),e}}function yr(e){var t,r;const o=Object.getPrototypeOf(e);for(const n of ur)if(n.target===o||Object.getPrototypeOf(n.target)===o||n.target===Object.getPrototypeOf(o)){const o=e[n.methodName];if("function"==typeof o){const s=o.bind(e);qe.registerProcess({id:n.options.id,name:n.options.name,priority:null!==(t=n.options.priority)&&void 0!==t?t:Be.MEDIUM,frequency:null!==(r=n.options.frequency)&&void 0!==r?r:"medium",minBucket:n.options.minBucket,cpuBudget:n.options.cpuBudget,interval:n.options.interval,execute:s}),de.debug(`Registered decorated process "${n.options.name}" (${n.options.id})`,{subsystem:"ProcessDecorators"})}}}function Rr(...e){for(const t of e)yr(t);de.info(`Registered decorated processes from ${e.length} instance(s)`,{subsystem:"ProcessDecorators"})}var Er=Object.freeze({__proto__:null,CriticalProcess:function(e,t,r){return dr({id:e,name:t,priority:Be.CRITICAL,frequency:"high",minBucket:0,cpuBudget:.3,interval:1,...r})},HighFrequencyProcess:function(e,t,r){return dr({id:e,name:t,priority:Be.HIGH,frequency:"high",minBucket:0,cpuBudget:.3,interval:1,...r})},IdleProcess:fr,LowFrequencyProcess:gr,MediumFrequencyProcess:pr,Process:dr,ProcessClass:hr,clearProcessMetadata:function(){ur.length=0},getProcessMetadata:function(){return[...ur]},getRegisteredClasses:function(){return new Set(mr)},registerAllDecoratedProcesses:Rr,registerDecoratedProcesses:yr});const Tr={updateInterval:100,minBucket:0,maxCpuBudget:.02,defaultCpuLimit:20},Cr={core:1.5,frontier:.8,resource:1,backup:.5,war:1.2};let vr=class{constructor(e={}){this.lastRun=0,this.config={...Tr,...e},this.interShardMemory={version:1,shards:{},globalTargets:{targetPowerLevel:0},tasks:[],lastSync:0,checksum:0}}initialize(){var e,t;try{const e=InterShardMemory.getLocal();if(e){const t=cr(e);t&&(this.interShardMemory=t,de.debug("Loaded InterShardMemory",{subsystem:"Shard"}))}}catch(e){const t=e instanceof Error?e.message:e+"";de.error("Failed to load InterShardMemory: "+t,{subsystem:"Shard"})}const r=null!==(t=null===(e=Game.shard)||void 0===e?void 0:e.name)&&void 0!==t?t:"shard0";this.interShardMemory.shards[r]||(this.interShardMemory.shards[r]=sr(r))}run(){this.lastRun=Game.time,this.updateCurrentShardHealth(),this.processInterShardTasks(),this.scanForPortals(),this.autoAssignShardRole(),Object.keys(this.interShardMemory.shards).length>1&&this.distributeCpuLimits(),this.syncInterShardMemory(),Game.time%500==0&&this.logShardStatus()}calculateCommodityIndex(e){var t;let r=0,o=0;for(const n of e){const e=n.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_FACTORY})[0];if(!e)continue;o++,r+=5*(null!==(t=e.level)&&void 0!==t?t:0),e.store.getUsedCapacity()>0&&(r+=10);const s=n.storage;if(s){const e=[RESOURCE_COMPOSITE,RESOURCE_CRYSTAL,RESOURCE_LIQUID,RESOURCE_GHODIUM_MELT,RESOURCE_OXIDANT,RESOURCE_REDUCTANT,RESOURCE_PURIFIER];for(const t of e){const e=s.store.getUsedCapacity(t);e>0&&(r+=Math.min(10,e/1e3))}}}return 0===o?0:(r=Math.min(100,r/(105*o)*100),Math.round(r))}updateCurrentShardHealth(){var e,t,r;const o=null!==(t=null===(e=Game.shard)||void 0===e?void 0:e.name)&&void 0!==t?t:"shard0",n=this.interShardMemory.shards[o];if(!n)return;const s=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my}),i=Game.cpu.getUsed()/Game.cpu.limit,a=.5>i?"low":.75>i?"medium":.9>i?"high":"critical",c=s.length>0?s.reduce((e,t)=>{var r,o;return e+(null!==(o=null===(r=t.controller)||void 0===r?void 0:r.level)&&void 0!==o?o:0)},0)/s.length:0;let l=0;for(const e of s){const t=e.storage;if(t){const e=t.store.getUsedCapacity(RESOURCE_ENERGY);l+=Math.min(100,e/5e3)}}l=s.length>0?l/s.length:0;let u=0;for(const e of s){const t=e.find(FIND_HOSTILE_CREEPS).length;u+=Math.min(100,10*t)}u=s.length>0?u/s.length:0,n.health={cpuCategory:a,cpuUsage:Math.round(100*i)/100,bucketLevel:Game.cpu.bucket,economyIndex:Math.round(l),warIndex:Math.round(u),commodityIndex:this.calculateCommodityIndex(s),roomCount:s.length,avgRCL:Math.round(10*c)/10,creepCount:Object.keys(Game.creeps).length,lastUpdate:Game.time};const m=null!==(r=n.cpuHistory)&&void 0!==r?r:[];m.push({tick:Game.time,cpuLimit:Game.cpu.limit,cpuUsed:Game.cpu.getUsed(),bucketLevel:Game.cpu.bucket}),n.cpuHistory=m.slice(-10),Game.cpu.shardLimits&&(n.cpuLimit=Game.cpu.shardLimits[o])}processInterShardTasks(){var e,t;const r=null!==(t=null===(e=Game.shard)||void 0===e?void 0:e.name)&&void 0!==t?t:"shard0",o=this.interShardMemory.tasks.filter(e=>e.targetShard===r&&"pending"===e.status);for(const e of o)switch(e.type){case"colonize":this.handleColonizeTask(e);break;case"reinforce":this.handleReinforceTask(e);break;case"transfer":this.handleTransferTask(e);break;case"evacuate":this.handleEvacuateTask(e)}this.interShardMemory.tasks=this.interShardMemory.tasks.filter(e=>"pending"===e.status||"active"===e.status||5e3>Game.time-e.createdAt)}handleColonizeTask(e){var t;e.status="active";const r=null!==(t=e.targetRoom)&&void 0!==t?t:"unknown";de.info(`Processing colonize task: ${r} from ${e.sourceShard}`,{subsystem:"Shard"})}handleReinforceTask(e){var t;e.status="active";const r=null!==(t=e.targetRoom)&&void 0!==t?t:"unknown";de.info(`Processing reinforce task: ${r} from ${e.sourceShard}`,{subsystem:"Shard"})}handleTransferTask(e){e.status="active",de.info("Processing transfer task from "+e.sourceShard,{subsystem:"Shard"})}handleEvacuateTask(e){var t;e.status="active";const r=null!==(t=e.targetRoom)&&void 0!==t?t:"unknown";de.info(`Processing evacuate task: ${r} to ${e.targetShard}`,{subsystem:"Shard"})}scanForPortals(){var e,t;const r=null!==(t=null===(e=Game.shard)||void 0===e?void 0:e.name)&&void 0!==t?t:"shard0",o=this.interShardMemory.shards[r];if(o){for(const e in Game.rooms){const t=Game.rooms[e].find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_PORTAL});for(const r of t){const t=r.destination;if(t&&"shard"in t){const n=t.shard,s=t.room,i=o.portals.find(t=>t.sourceRoom===e&&t.targetShard===n);if(i)i.lastScouted=Game.time,i.isStable=void 0===r.ticksToDecay,void 0!==r.ticksToDecay&&(i.decayTick=Game.time+r.ticksToDecay);else{const t={sourceRoom:e,sourcePos:{x:r.pos.x,y:r.pos.y},targetShard:n,targetRoom:s,threatRating:0,lastScouted:Game.time,isStable:void 0===r.ticksToDecay,traversalCount:0};void 0!==r.ticksToDecay&&(t.decayTick=Game.time+r.ticksToDecay),o.portals.push(t),de.info(`Discovered portal in ${e} to ${n}/${s}`,{subsystem:"Shard"})}}}}o.portals=o.portals.filter(e=>!e.decayTick||e.decayTick>Game.time)}}autoAssignShardRole(){var e,t;const r=null!==(t=null===(e=Game.shard)||void 0===e?void 0:e.name)&&void 0!==t?t:"shard0",o=this.interShardMemory.shards[r];if(!o)return;const n=o.health,s=Object.values(this.interShardMemory.shards);let i=o.role;n.warIndex>50?i="war":3>n.roomCount&&4>n.avgRCL?i="frontier":70>=n.economyIndex||3>n.roomCount||6>n.avgRCL?s.length>1&&2>n.roomCount&&3>n.avgRCL?i="backup":2>n.roomCount||4>n.avgRCL||(i="core"):i="resource","frontier"!==o.role||3>n.roomCount||5>n.avgRCL||(i="core",de.info("Transitioning from frontier to core shard",{subsystem:"Shard"})),"war"===o.role&&20>n.warIndex&&(i=n.economyIndex>70&&n.roomCount>=3?"resource":2>n.roomCount?"frontier":"core",de.info("War ended, transitioning to "+i,{subsystem:"Shard"})),i!==o.role&&(o.role=i,de.info("Auto-assigned shard role: "+i,{subsystem:"Shard"}))}calculateCpuEfficiency(e){if(!e.cpuHistory||0===e.cpuHistory.length)return 1;let t=0;for(const r of e.cpuHistory)r.cpuLimit>0&&(t+=r.cpuUsed/r.cpuLimit);return t/e.cpuHistory.length}calculateShardWeight(e,t,r){let o=Cr[e.role];const n=t===r?Game.cpu.bucket:e.health.bucketLevel;2e3>n?o*=.8:5e3>n?o*=.9:n>9e3&&(o*=1.1);const s=this.calculateCpuEfficiency(e);return s>.95?o*=1.15:.6>s&&(o*=.85),"war"===e.role&&e.health.warIndex>50&&(o*=1.2),o}distributeCpuLimits(){var e,t;try{const r=this.interShardMemory.shards,o=Object.keys(r),n=Game.cpu.shardLimits?Object.values(Game.cpu.shardLimits).reduce((e,t)=>e+t,0):this.config.defaultCpuLimit*o.length,s=null!==(t=null===(e=Game.shard)||void 0===e?void 0:e.name)&&void 0!==t?t:"shard0",i={};let a=0;for(const e of o){const t=r[e];if(!t)continue;const o=this.calculateShardWeight(t,e,s);i[e]=o,a+=o}const c={};for(const e of o)i[e]&&(c[e]=Math.max(5,Math.round(i[e]/a*n)));if(Game.cpu.shardLimits){const e=Game.cpu.shardLimits,t=o.some(t=>{var r,o;return Math.abs((null!==(r=e[t])&&void 0!==r?r:0)-(null!==(o=c[t])&&void 0!==o?o:0))>1});t&&Game.cpu.setShardLimits(c)===OK&&de.info("Updated shard CPU limits: "+JSON.stringify(c),{subsystem:"Shard"})}}catch(e){const t=e instanceof Error?e.message:e+"";de.debug("Could not set shard limits: "+t,{subsystem:"Shard"})}}syncInterShardMemory(){try{this.interShardMemory.lastSync=Game.time;const e=this.validateInterShardMemory();e.valid||(de.warn("InterShardMemory validation failed: "+e.errors.join(", "),{subsystem:"Shard"}),this.repairInterShardMemory());const t=ar(this.interShardMemory);if(t.length>lr){de.warn(`InterShardMemory size exceeds limit: ${t.length}/102400`,{subsystem:"Shard"}),this.trimInterShardMemory();const e=ar(this.interShardMemory);return e.length>lr?(de.error(`InterShardMemory still too large after trim: ${e.length}/102400`,{subsystem:"Shard"}),void this.emergencyTrim()):void InterShardMemory.setLocal(e)}InterShardMemory.setLocal(t),Game.time%50==0&&this.verifySyncIntegrity()}catch(e){const t=e instanceof Error?e.message:e+"";de.error("Failed to sync InterShardMemory: "+t,{subsystem:"Shard"}),this.attemptSyncRecovery()}}validateInterShardMemory(){const e=[];if("number"!=typeof this.interShardMemory.version&&e.push("Invalid version"),"object"!=typeof this.interShardMemory.shards)e.push("Invalid shards object");else for(const[t,r]of Object.entries(this.interShardMemory.shards))r.health&&"number"==typeof r.health.lastUpdate||e.push(`Shard ${t} has invalid health data`),Array.isArray(r.portals)||e.push(`Shard ${t} has invalid portals array`),Array.isArray(r.activeTasks)||e.push(`Shard ${t} has invalid activeTasks array`);return Array.isArray(this.interShardMemory.tasks)||e.push("Invalid tasks array"),"number"!=typeof this.interShardMemory.lastSync&&e.push("Invalid lastSync"),{valid:0===e.length,errors:e}}repairInterShardMemory(){"number"!=typeof this.interShardMemory.version&&(this.interShardMemory.version=1),"object"!=typeof this.interShardMemory.shards&&(this.interShardMemory.shards={});for(const[e,t]of Object.entries(this.interShardMemory.shards))t.health&&"number"==typeof t.health.lastUpdate||(this.interShardMemory.shards[e]=sr(e)),Array.isArray(t.portals)||(t.portals=[]),Array.isArray(t.activeTasks)||(t.activeTasks=[]);Array.isArray(this.interShardMemory.tasks)||(this.interShardMemory.tasks=[]),this.interShardMemory.globalTargets||(this.interShardMemory.globalTargets={targetPowerLevel:0}),"number"!=typeof this.interShardMemory.lastSync&&(this.interShardMemory.lastSync=Game.time),de.info("Repaired InterShardMemory structure",{subsystem:"Shard"})}verifySyncIntegrity(){var e,t;try{const r=InterShardMemory.getLocal();if(!r)return void de.warn("InterShardMemory verification failed: no data present",{subsystem:"Shard"});const o=cr(r);if(!o)return void de.warn("InterShardMemory verification failed: deserialization failed",{subsystem:"Shard"});const n=null!==(t=null===(e=Game.shard)||void 0===e?void 0:e.name)&&void 0!==t?t:"shard0";o.shards[n]||de.warn(`InterShardMemory verification failed: current shard ${n} not found`,{subsystem:"Shard"})}catch(e){const t=e instanceof Error?e.message:e+"";de.warn("InterShardMemory verification failed: "+t,{subsystem:"Shard"})}}attemptSyncRecovery(){var e,t;try{de.info("Attempting InterShardMemory recovery",{subsystem:"Shard"});const r=InterShardMemory.getLocal();if(r){const e=cr(r);if(e)return this.interShardMemory=e,void de.info("Recovered InterShardMemory from storage",{subsystem:"Shard"})}const o=null!==(t=null===(e=Game.shard)||void 0===e?void 0:e.name)&&void 0!==t?t:"shard0";this.interShardMemory={version:1,shards:{},globalTargets:{targetPowerLevel:0},tasks:[],lastSync:0,checksum:0},this.interShardMemory.shards[o]=sr(o),de.info("Recreated InterShardMemory with current shard only",{subsystem:"Shard"})}catch(e){const t=e instanceof Error?e.message:e+"";de.error("InterShardMemory recovery failed: "+t,{subsystem:"Shard"})}}emergencyTrim(){var e,t;const r=null!==(t=null===(e=Game.shard)||void 0===e?void 0:e.name)&&void 0!==t?t:"shard0",o=this.interShardMemory.shards[r];o&&(this.interShardMemory.shards={[r]:o},this.interShardMemory.tasks=this.interShardMemory.tasks.filter(e=>e.sourceShard===r||e.targetShard===r),o.portals=o.portals.sort((e,t)=>t.lastScouted-e.lastScouted).slice(0,10),de.warn("Emergency trim applied to InterShardMemory",{subsystem:"Shard"}))}trimInterShardMemory(){this.interShardMemory.tasks=this.interShardMemory.tasks.filter(e=>"pending"===e.status||"active"===e.status||1e3>Game.time-e.createdAt);for(const e in this.interShardMemory.shards){const t=this.interShardMemory.shards[e];t&&(t.portals=t.portals.filter(e=>1e4>Game.time-e.lastScouted))}}logShardStatus(){var e,t;const r=null!==(t=null===(e=Game.shard)||void 0===e?void 0:e.name)&&void 0!==t?t:"shard0",o=this.interShardMemory.shards[r];if(!o)return;const n=o.health;de.info(`Shard ${r} (${o.role}): ${n.roomCount} rooms, RCL ${n.avgRCL}, CPU: ${n.cpuCategory}, Eco: ${n.economyIndex}%, War: ${n.warIndex}%`,{subsystem:"Shard"})}createTask(e,t,r,o=50){var n,s;const i=null!==(s=null===(n=Game.shard)||void 0===n?void 0:n.name)&&void 0!==s?s:"shard0",a={id:`${Game.time}-${Math.random().toString(36).substring(2,11)}`,type:e,sourceShard:i,targetShard:t,priority:o,status:"pending",createdAt:Game.time};r&&(a.targetRoom=r),this.interShardMemory.tasks.push(a),de.info(`Created inter-shard task: ${e} to ${t}`,{subsystem:"Shard"})}getCurrentShardState(){var e,t;const r=null!==(t=null===(e=Game.shard)||void 0===e?void 0:e.name)&&void 0!==t?t:"shard0";return this.interShardMemory.shards[r]}getAllShards(){return Object.values(this.interShardMemory.shards)}getPortalsToShard(e){var t,r;const o=null!==(r=null===(t=Game.shard)||void 0===t?void 0:t.name)&&void 0!==r?r:"shard0",n=this.interShardMemory.shards[o];return n?n.portals.filter(t=>t.targetShard===e):[]}setShardRole(e){var t,r;const o=null!==(r=null===(t=Game.shard)||void 0===t?void 0:t.name)&&void 0!==r?r:"shard0",n=this.interShardMemory.shards[o];n&&(n.role=e,de.info("Set shard role to: "+e,{subsystem:"Shard"}))}createResourceTransferTask(e,t,r,o,n=50){var s,i;const a=null!==(i=null===(s=Game.shard)||void 0===s?void 0:s.name)&&void 0!==i?i:"shard0",c={id:`${Game.time}-transfer-${Math.random().toString(36).substring(2,11)}`,type:"transfer",sourceShard:a,targetShard:e,targetRoom:t,resourceType:r,resourceAmount:o,priority:n,status:"pending",createdAt:Game.time,progress:0};this.interShardMemory.tasks.push(c),de.info(`Created resource transfer task: ${o} ${r} to ${e}/${t}`,{subsystem:"Shard"})}getOptimalPortalRoute(e,t){var r,o,n,s;const i=null!==(o=null===(r=Game.shard)||void 0===r?void 0:r.name)&&void 0!==o?o:"shard0",a=this.interShardMemory.shards[i];if(!a)return null;const c=a.portals.filter(t=>t.targetShard===e);if(0===c.length)return null;const l=c.map(e=>{var r;let o=100;e.isStable&&(o+=50),o-=15*e.threatRating,o+=Math.min(2*(null!==(r=e.traversalCount)&&void 0!==r?r:0),20),t&&(o-=2*Game.map.getRoomLinearDistance(t,e.sourceRoom));const n=Game.time-e.lastScouted;return 1e3>n?o+=10:n>5e3&&(o-=10),{portal:e,score:o}});return l.sort((e,t)=>t.score-e.score),null!==(s=null===(n=l[0])||void 0===n?void 0:n.portal)&&void 0!==s?s:null}recordPortalTraversal(e,t,r){var o,n,s;const i=null!==(n=null===(o=Game.shard)||void 0===o?void 0:o.name)&&void 0!==n?n:"shard0",a=this.interShardMemory.shards[i];if(!a)return;const c=a.portals.find(r=>r.sourceRoom===e&&r.targetShard===t);c&&(r?(c.traversalCount=(null!==(s=c.traversalCount)&&void 0!==s?s:0)+1,c.threatRating=Math.max(0,c.threatRating-.1)):c.threatRating=Math.min(3,c.threatRating+.5))}updateTaskProgress(e,t,r){const o=this.interShardMemory.tasks.find(t=>t.id===e);o&&(o.progress=Math.min(100,Math.max(0,t)),o.updatedAt=Game.time,r&&(o.status=r))}getActiveTransferTasks(){var e,t;const r=null!==(t=null===(e=Game.shard)||void 0===e?void 0:e.name)&&void 0!==t?t:"shard0";return this.interShardMemory.tasks.filter(e=>!("transfer"!==e.type||e.sourceShard!==r&&e.targetShard!==r||"pending"!==e.status&&"active"!==e.status))}cancelTask(e){const t=this.interShardMemory.tasks.find(t=>t.id===e);t&&(t.status="failed",t.updatedAt=Game.time,de.info("Cancelled task "+e,{subsystem:"Shard"}))}getSyncStatus(){const e=ar(this.interShardMemory).length,t=e/lr*100,r=Game.time-this.interShardMemory.lastSync,o=92160>e&&500>r;let n=0;for(const e of Object.values(this.interShardMemory.shards))n+=e.portals.length;return{lastSync:this.interShardMemory.lastSync,ticksSinceSync:r,memorySize:e,sizePercent:Math.round(100*t)/100,shardsTracked:Object.keys(this.interShardMemory.shards).length,activeTasks:this.interShardMemory.tasks.filter(e=>"pending"===e.status||"active"===e.status).length,totalPortals:n,isHealthy:o}}forceSync(){de.info("Forcing InterShardMemory sync with validation",{subsystem:"Shard"}),this.syncInterShardMemory()}getMemoryStats(){const e=ar(this.interShardMemory).length,t=ar({...this.interShardMemory,tasks:[],globalTargets:{targetPowerLevel:0}}).length,r=JSON.stringify(this.interShardMemory.tasks).length;let o=0;for(const e of Object.values(this.interShardMemory.shards))o+=JSON.stringify(e.portals).length;return{size:e,limit:lr,percent:Math.round(e/lr*1e4)/100,breakdown:{shards:t,tasks:r,portals:o,other:e-t-r}}}};Q([gr("empire:shard","Shard Manager",{priority:Be.LOW,interval:100,minBucket:0,cpuBudget:.02})],vr.prototype,"run",null),vr=Q([hr()],vr);const Sr=new vr,_r=new class{constructor(){Memory.crossShardTransfers||(Memory.crossShardTransfers={requests:{},lastUpdate:Game.time}),this.memory=Memory.crossShardTransfers}run(){var e,t;this.cleanupOldRequests();const r=Sr.getActiveTransferTasks();for(const o of r){if("transfer"!==o.type||!o.resourceType||!o.resourceAmount)continue;if(this.memory.requests[o.id])continue;const r=null!==(t=null===(e=Game.shard)||void 0===e?void 0:e.name)&&void 0!==t?t:"shard0";o.sourceShard===r&&this.createTransferRequest(o)}for(const e in this.memory.requests){const t=this.memory.requests[e];t&&this.processTransferRequest(t)}this.memory.lastUpdate=Game.time}createTransferRequest(e){if(!e.resourceType||!e.resourceAmount||!e.targetRoom)return;const t=Sr.getOptimalPortalRoute(e.targetShard);if(!t)return void de.warn(`No portal found to ${e.targetShard}, cannot create transfer request`,{subsystem:"CrossShardTransfer"});const r=this.findSourceRoom(e.resourceType,e.resourceAmount);if(!r)return void de.warn(`No room with sufficient ${e.resourceType} for transfer`,{subsystem:"CrossShardTransfer"});const o={taskId:e.id,resourceType:e.resourceType,amount:e.resourceAmount,sourceRoom:r,targetShard:e.targetShard,targetRoom:e.targetRoom,portalRoom:t.sourceRoom,priority:e.priority,status:"queued",assignedCreeps:[],transferred:0};this.memory.requests[e.id]=o,de.info(`Created transfer request: ${e.resourceAmount} ${e.resourceType} from ${r} to ${e.targetShard}/${e.targetRoom}`,{subsystem:"CrossShardTransfer"})}findSourceRoom(e,t){const r=Object.values(Game.rooms).filter(e=>{var t;return(null===(t=e.controller)||void 0===t?void 0:t.my)&&e.terminal&&e.storage});for(const o of r){const r=o.terminal,n=o.storage;if(r&&r.store.getUsedCapacity(e)>=t)return o.name;if(n&&n.store.getUsedCapacity(e)>=t)return o.name}return null}processTransferRequest(e){switch(e.status){case"queued":this.handleQueuedRequest(e);break;case"gathering":this.handleGatheringRequest(e);break;case"moving":this.handleMovingRequest(e);break;case"transferring":this.handleTransferringRequest(e)}const t=Math.round(e.transferred/e.amount*100);Sr.updateTaskProgress(e.taskId,t)}handleQueuedRequest(e){var t;const r=e.amount-e.transferred,o=e.assignedCreeps.map(e=>Game.creeps[e]).filter(e=>void 0!==e).reduce((e,t)=>e+t.carryCapacity,0);if(o>=r)return e.status="gathering",void de.info(`Transfer request ${e.taskId} moving to gathering phase`,{subsystem:"CrossShardTransfer"});const n=Game.rooms[e.sourceRoom];if(!n||!(null===(t=n.controller)||void 0===t?void 0:t.my))return void de.warn(`Source room ${e.sourceRoom} not available for spawning carriers`,{subsystem:"CrossShardTransfer"});const s=r-o,i=n.energyCapacityAvailable;let a;try{a=function(e){const{role:t}=e;switch(t){case"harvester":case"staticMiner":case"mineralHarvester":case"remoteHarvester":return function(e){const{maxEnergy:t}=e;let r=Math.min(10,Math.floor(t/100));r=Math.max(2,r);let o=Math.max(1,Math.ceil((r+1)/2)),n=100*r+50+50*o;for(;n>t&&r>2;)r--,o=Math.max(1,Math.ceil((r+1)/2)),n=100*r+50+50*o;if(n>t)for(;o>1&&n>t;)o--,n=100*r+50+50*o;const s=[];for(let e=0;r>e;e++)s.push(WORK);for(let e=0;1>e;e++)s.push(CARRY);for(let e=0;o>e;e++)s.push(MOVE);const i=rr(s);return{parts:s,cost:i,minCapacity:i}}(e);case"hauler":case"carrier":case"queenCarrier":case"remoteHauler":case"interRoomCarrier":case"crossShardCarrier":return function(e){const{maxEnergy:t,distance:r=10,hasRoads:o=!1,energyPerTick:n=10}=e,s=o?2:1;let i=Math.ceil(2*n*r/50),a=Math.ceil(i/s),c=50*i+50*a;c>t&&(i=Math.max(2,Math.floor(i*(t/c))),a=Math.ceil(i/s),c=50*i+50*a),i=Math.max(2,Math.min(25,i)),a=Math.max(1,Math.min(25,a));const l=[];for(let e=0;i>e;e++)l.push(CARRY);for(let e=0;a>e;e++)l.push(MOVE);return{parts:l,cost:rr(l),minCapacity:rr(l)}}(e);case"upgrader":return function(e){const{maxEnergy:t}=e,r=Math.max(1,Math.min(15,3*Math.floor(t/450))),o=Math.max(1,Math.ceil(r/3)),n=Math.max(1,Math.ceil((r+o)/2)),s=[];for(let e=0;r>e;e++)s.push(WORK);for(let e=0;o>e;e++)s.push(CARRY);for(let e=0;n>e;e++)s.push(MOVE);return{parts:s,cost:rr(s),minCapacity:rr(s)}}(e);case"builder":case"engineer":case"remoteWorker":default:return function(e){const{maxEnergy:t}=e,r=Math.max(1,Math.min(16,Math.floor(t/200))),o=r,n=r,s=[];for(let e=0;r>e;e++)s.push(WORK);for(let e=0;o>e;e++)s.push(CARRY);for(let e=0;n>e;e++)s.push(MOVE);return{parts:s,cost:rr(s),minCapacity:rr(s)}}(e);case"guard":case"soldier":return function(e){const{maxEnergy:t,willBoost:r=!1}=e;let o,n,s;if(r){const e=Math.max(1,Math.floor(t/580));o=Math.min(10,e),n=Math.min(20,4*e),s=Math.min(30,5*e)}else{const e=Math.max(1,Math.floor(t/580));o=Math.max(1,e),n=Math.max(1,4*e),s=Math.max(1,5*e)}const i=[];for(let e=0;o>e;e++)i.push(TOUGH);for(let e=0;n>e;e++)i.push(ATTACK);for(let e=0;s>e;e++)i.push(MOVE);return{parts:i,cost:rr(i),minCapacity:rr(i)}}(e);case"ranger":return function(e){const{maxEnergy:t,willBoost:r=!1}=e;let o,n,s;if(r){const e=Math.floor(t/210);o=Math.min(5,Math.floor(.1*e)),n=Math.min(25,Math.floor(.6*e)),s=Math.min(20,Math.ceil(.3*e))}else{const e=Math.floor(t/210);o=Math.max(1,Math.min(5,Math.floor(.1*e))),n=Math.max(1,Math.min(20,Math.floor(.5*e))),s=Math.max(1,Math.min(20,Math.ceil(.4*e)))}const i=[];for(let e=0;o>e;e++)i.push(TOUGH);for(let e=0;n>e;e++)i.push(RANGED_ATTACK);for(let e=0;s>e;e++)i.push(MOVE);return{parts:i,cost:rr(i),minCapacity:rr(i)}}(e);case"healer":return function(e){const{maxEnergy:t}=e,r=Math.max(1,Math.min(25,Math.floor(t/300))),o=r,n=[];for(let e=0;r>e;e++)n.push(HEAL);for(let e=0;o>e;e++)n.push(MOVE);return{parts:n,cost:rr(n),minCapacity:rr(n)}}(e)}}({maxEnergy:i,role:"crossShardCarrier"})}catch(e){return void de.error("Failed to optimize body for crossShardCarrier: "+e,{subsystem:"CrossShardTransfer"})}const c=50*a.parts.filter(e=>e===CARRY).length,l=Math.min(Math.ceil(s/c),3);let u=or.NORMAL;u=80>e.priority?50>e.priority?or.LOW:or.NORMAL:or.HIGH;for(let t=0;l>t;t++){const r={transferRequestId:e.taskId,portalRoom:e.portalRoom,targetShard:e.targetShard,workflowState:"gathering"},o={id:`crossShardCarrier_${e.taskId}_${t}_${Game.time}`,roomName:e.sourceRoom,role:"crossShardCarrier",family:"economy",body:a,priority:u,createdAt:Game.time,targetRoom:e.targetRoom,additionalMemory:r};nr.addRequest(o),de.info(`Requested spawn of crossShardCarrier for transfer ${e.taskId} (${t+1}/${l})`,{subsystem:"CrossShardTransfer"})}de.debug(`Transfer request ${e.taskId} needs ${s} carry capacity, requested ${l} carriers`,{subsystem:"CrossShardTransfer"})}handleGatheringRequest(e){const t=e.assignedCreeps.map(e=>Game.creeps[e]).filter(e=>void 0!==e);0!==t.length?t.every(t=>t.store.getUsedCapacity(e.resourceType)>0)&&(e.status="moving",de.info(`Transfer request ${e.taskId} moving to portal`,{subsystem:"CrossShardTransfer"})):e.status="queued"}handleMovingRequest(e){const t=e.assignedCreeps.map(e=>Game.creeps[e]).filter(e=>void 0!==e);if(0===t.length)return e.status="failed",void Sr.updateTaskProgress(e.taskId,e.transferred,"failed");t.filter(t=>t.room.name===e.portalRoom).length>0&&(e.status="transferring",de.info(`Transfer request ${e.taskId} reached portal, transferring`,{subsystem:"CrossShardTransfer"}))}handleTransferringRequest(e){0===e.assignedCreeps.map(e=>Game.creeps[e]).filter(e=>void 0!==e).length&&(e.status="complete",e.transferred=e.amount,Sr.updateTaskProgress(e.taskId,100,"complete"),Sr.recordPortalTraversal(e.portalRoom,e.targetShard,!0),de.info(`Transfer request ${e.taskId} completed`,{subsystem:"CrossShardTransfer"}))}cleanupOldRequests(){for(const e in this.memory.requests){const t=this.memory.requests[e];t&&("complete"!==t.status&&"failed"!==t.status||5e3>=Game.time-this.memory.lastUpdate||delete this.memory.requests[e])}}getCreepRequest(e){for(const t in this.memory.requests){const r=this.memory.requests[t];if(r&&r.assignedCreeps.includes(e))return r}return null}assignCreep(e,t){const r=this.memory.requests[e];r&&!r.assignedCreeps.includes(t)&&(r.assignedCreeps.push(t),de.info(`Assigned creep ${t} to transfer request ${e}`,{subsystem:"CrossShardTransfer"}))}getActiveRequests(){return Object.values(this.memory.requests).filter(e=>"complete"!==e.status&&"failed"!==e.status)}getPrioritizedRequests(){return this.getActiveRequests().filter(e=>"queued"===e.status).sort((e,t)=>t.priority-e.priority)}},br=new Map;let Or=-1,Ur=null;function Mr(e,t=!1){var r,o;Or===Game.time&&Ur===Game.creeps||(br.clear(),Or=Game.time,Ur=Game.creeps);const n=t?e+"_active":e,s=br.get(n);if(s&&s instanceof Map)return s;const i=new Map;for(const n in Game.creeps){const s=Game.creeps[n],a=s.memory;if(a.homeRoom===e){if(t&&s.spawning)continue;const e=null!==(r=a.role)&&void 0!==r?r:"unknown";i.set(e,(null!==(o=i.get(e))&&void 0!==o?o:0)+1)}}return br.set(n,i),i}function Ar(e,t,r){let o=0;for(const n of Object.values(Game.creeps)){const s=n.memory;s.homeRoom===e&&s.role===t&&s.targetRoom===r&&o++}return o}function wr(e,t,r){var o,n,s;const i=null!==(o=r.remoteAssignments)&&void 0!==o?o:[];if(0===i.length)return null;for(const r of i){const o=Ar(e,t,r),i=Game.rooms[r];let a;if(a="remoteHarvester"===t?i?it(i).length:2:"remoteHauler"===t&&i?er(e,r,it(i).length,null!==(s=null===(n=Game.rooms[e])||void 0===n?void 0:n.energyCapacityAvailable)&&void 0!==s?s:800).recommendedHaulers:2,a>o)return r}return null}function kr(e,t,r,o){var n;if("remoteHarvester"===e||"remoteHauler"===e){const n=wr(o,e,r);return!!n&&(t.targetRoom=n,!0)}if("remoteWorker"===e){const s=null!==(n=r.remoteAssignments)&&void 0!==n?n:[];if(s.length>0){let r=1/0,n=[];for(const t of s){const s=Ar(o,e,t);r>s?(r=s,n=[t]):s===r&&n.push(t)}const i=n.length>1?n[Game.time%n.length]:n[0];return t.targetRoom=i,!0}return!1}return!0}function Nr(e,t,r,o=!1){var n,s,i;const a=yt[t];if(!a)return!1;if("larvaWorker"===t&&!o)return!1;if("remoteHarvester"===t||"remoteHauler"===t)return null!==wr(e,t,r);if("remoteWorker"===t){if(0===(null!==(n=r.remoteAssignments)&&void 0!==n?n:[]).length)return!1;const t=function(e,t){Or===Game.time&&Ur===Game.creeps||(br.clear(),Or=Game.time,Ur=Game.creeps);const r=`${e}:${t}`,o=br.get(r);if("number"==typeof o)return o;let n=0;for(const r in Game.creeps){const o=Game.creeps[r].memory;o.homeRoom===e&&o.role===t&&n++}return br.set(r,n),n}(e,"remoteWorker");return t<a.maxPerRoom}if("remoteGuard"===t){const o=null!==(s=r.remoteAssignments)&&void 0!==s?s:[];if(0===o.length)return!1;for(const r of o){const o=Game.rooms[r];if(!o)continue;const n=st(o,FIND_HOSTILE_CREEPS).filter(e=>e.body.some(e=>e.type===ATTACK||e.type===RANGED_ATTACK||e.type===WORK));if(n.length>0){const o=Ar(e,t,r);if(Math.min(a.maxPerRoom,Math.ceil(n.length/2))>o)return!0}}return!1}const c=null!==(i=Mr(e).get(t))&&void 0!==i?i:0;let l=a.maxPerRoom;if("upgrader"===t&&r.clusterId){const t=Wt.getCluster(r.clusterId);if((null==t?void 0:t.focusRoom)===e){const t=Game.rooms[e];(null==t?void 0:t.controller)&&(l=t.controller.level>3?t.controller.level>6?6:4:2)}}if(c>=l)return!1;const u=Game.rooms[e];if(!u)return!1;if("scout"===t)return 1>r.danger&&"defensive"!==r.posture&&"war"!==r.posture&&"siege"!==r.posture&&(0===c||"expand"===r.posture&&c<a.maxPerRoom);if("claimer"===t){const e=Wt.getEmpire(),t=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my}),o=t.length<Game.gcl.level,n=e.claimQueue.some(e=>!e.claimed),s=function(e,t){var r,o,n,s;const i=null!==(r=t.remoteAssignments)&&void 0!==r?r:[];if(0===i.length)return!1;const a=function(){const e=Object.values(Game.spawns);return e.length>0?e[0].owner.username:""}();for(const e of i){const t=Game.rooms[e];if(null==t?void 0:t.controller){const r=t.controller;if(r.owner)continue;const i=(null===(o=r.reservation)||void 0===o?void 0:o.username)===a,c=null!==(s=null===(n=r.reservation)||void 0===n?void 0:n.ticksToEnd)&&void 0!==s?s:0;if((!i||3e3>c)&&!Object.values(Game.creeps).some(t=>{const r=t.memory;return"claimer"===r.role&&r.targetRoom===e&&"reserve"===r.task}))return!0}else if(!Object.values(Game.creeps).some(t=>{const r=t.memory;return"claimer"===r.role&&r.targetRoom===e&&"reserve"===r.task}))return!0}return!1}(0,r);return!(!o||!n)||!!s}if("mineralHarvester"===t){const e=u.find(FIND_MINERALS)[0];if(!e)return!1;if(!e.pos.lookFor(LOOK_STRUCTURES).find(e=>e.structureType===STRUCTURE_EXTRACTOR))return!1;if(0===e.mineralAmount)return!1}if("labTech"===t&&3>u.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LAB}).length)return!1;if("factoryWorker"===t&&0===u.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_FACTORY}).length)return!1;if("queenCarrier"===t&&!u.storage)return!1;if("builder"===t&&0===u.find(FIND_MY_CONSTRUCTION_SITES).length&&c>0)return!1;if("interRoomCarrier"===t){if(!r.clusterId)return!1;const e=Wt.getCluster(r.clusterId);if(!e||!e.resourceRequests||0===e.resourceRequests.length)return!1;if(!e.resourceRequests.some(e=>{if(e.fromRoom!==u.name)return!1;const t=e.assignedCreeps.filter(e=>Game.creeps[e]).length;return e.amount-e.delivered>500&&2>t}))return!1}if("crossShardCarrier"===t){const e=_r.getActiveRequests();if(0===e.length)return!1;if(!e.some(e=>{if(e.sourceRoom!==u.name)return!1;const t=e.assignedCreeps||[],r=e.amount-e.transferred;let o=0,n=0;for(const e of t){const t=Game.creeps[e];t&&(o+=t.carryCapacity,n++)}return r>o&&3>n}))return!1}return!0}function Pr(e){var t,r;return(null!==(t=e.get("harvester"))&&void 0!==t?t:0)+(null!==(r=e.get("larvaWorker"))&&void 0!==r?r:0)}function Ir(e){const t=it(e);return[{role:"larvaWorker",minCount:1},{role:"harvester",minCount:1},{role:"hauler",minCount:1},{role:"harvester",minCount:Math.max(t.length,1)},{role:"queenCarrier",minCount:1,condition:e=>!!e.storage},{role:"upgrader",minCount:1}]}function xr(e,t){var r,o;const n=Mr(e,!0);if(0===Pr(n))return!0;if(0===function(e){var t,r;return(null!==(t=e.get("hauler"))&&void 0!==t?t:0)+(null!==(r=e.get("larvaWorker"))&&void 0!==r?r:0)}(n)&&(null!==(r=n.get("harvester"))&&void 0!==r?r:0)>0)return!0;const s=Mr(e,!1),i=Ir(t);for(const e of i)if((!e.condition||e.condition(t))&&(null!==(o=s.get(e.role))&&void 0!==o?o:0)<e.minCount)return!0;return!1}const $r=me("CollectionPoint"),Gr="collectionPoint";function Lr(e,t){const r=Ze.get(e.name,{namespace:Gr,ttl:500});if(r)return new RoomPosition(r.x,r.y,e.name);if(t.collectionPoint){const r=t.collectionPoint.x,o=t.collectionPoint.y;if("number"==typeof r&&"number"==typeof o&&!isNaN(r)&&!isNaN(o)&&r>=0&&50>r&&o>=0&&50>o){const t=new RoomPosition(r,o,e.name);if(function(e,t){const r=e.getTerrain();if(!function(e,t,r){return r.get(t.x,t.y)!==TERRAIN_MASK_WALL&&!e.lookForAt(LOOK_STRUCTURES,t.x,t.y).some(e=>e.structureType!==STRUCTURE_ROAD&&e.structureType!==STRUCTURE_CONTAINER&&(e.structureType!==STRUCTURE_RAMPART||!e.my))}(e,t,r))return!1;const o=e.find(FIND_MY_SPAWNS);if(0===o.length)return!1;const n=t.getRangeTo(o[0].pos);return n>=5&&15>=n}(e,t))return Ze.set(e.name,{x:r,y:o},{namespace:Gr,ttl:500}),t}}const o=function(e){var t;const r=e.find(FIND_MY_SPAWNS);if(0===r.length)return null;const o=r[0],n=e.storage,s=e.controller,i=new Map,a=new Map,c=e.find(FIND_STRUCTURES);for(const e of c){const t=`${e.pos.x},${e.pos.y}`;e.structureType===STRUCTURE_ROAD&&i.set(t,!0),e.structureType!==STRUCTURE_ROAD&&e.structureType!==STRUCTURE_CONTAINER&&(e.structureType!==STRUCTURE_RAMPART||!e.my)&&a.set(t,!0)}const l=[],u=e.getTerrain();for(let r=5;15>=r;r++){const c=o.pos.x,m=o.pos.y;for(let o=-r;r>=o;o++){for(let d=-r;r>=d;d++){if(Math.max(Math.abs(o),Math.abs(d))!==r)continue;const p=c+o,g=m+d;if(3>p||p>46||3>g||g>46)continue;const f=new RoomPosition(p,g,e.name);if(!Fr(f,u,a))continue;let h=0;if(h-=Math.abs(r-8),n&&(h-=.5*f.getRangeTo(n.pos)),s&&(h-=.3*f.getRangeTo(s.pos)),null!==(t=i.get(`${p},${g}`))&&void 0!==t&&t&&(h-=5),l.push({pos:f,score:h}),Dr(l.length,r))break}if(Dr(l.length,r))break}if(Dr(l.length,r))break}return l.sort((e,t)=>t.score-e.score),l.length>0?l[0].pos:null}(e);return o?(t.collectionPoint={x:o.x,y:o.y},Ze.set(e.name,{x:o.x,y:o.y},{namespace:Gr,ttl:500}),$r.info(`Calculated new collection point at ${o.x},${o.y}`,e.name)):(t.collectionPoint=void 0,Ze.invalidate(e.name,Gr),$r.warn("Failed to calculate collection point for room",e.name)),o}function Dr(e,t){return e>=50&&t>=8}function Fr(e,t,r){var o;if(t.get(e.x,e.y)===TERRAIN_MASK_WALL)return!1;const n=`${e.x},${e.y}`;return!(null!==(o=r.get(n))&&void 0!==o&&o)}const Br=me("TargetDistribution"),Hr="targetAssignment";function Wr(e){const t=Ze.get(e,{namespace:Hr,ttl:1});if(t)return t;const r={assignments:{}};return Ze.set(e,r,{namespace:Hr,ttl:1}),r}function Yr(e,t,r){if(0===t.length)return null;if(1===t.length)return Kr(e,t[0],r),t[0];const o=Wr(e.room.name);let n=null,s=1/0,i=1/0;for(const a of t){const t=`${r}:${a.id}`,c=(o.assignments[t]||[]).length,l=e.pos.getRangeTo(a.pos);(s>c||c===s&&i>l)&&(n=a,s=c,i=l)}return n&&(Kr(e,n,r),Br.debug(`${e.name} assigned to ${r} ${n.id} at ${n.pos} (${s} other creeps assigned, distance: ${i})`)),n}function Kr(e,t,r){const o=Wr(e.room.name),n=`${r}:${t.id}`,s=o.assignments[n]||[];s.includes(e.name)||(s.push(e.name),o.assignments[n]=s,Ze.set(e.room.name,o,{namespace:Hr,ttl:1}))}function jr(e,t){let r=null;for(const o of e.bodies)o.cost>t||r&&o.cost<=r.cost||(r=o);return r}function Vr(e){return`${e}_${Game.time}_${Math.floor(1e3*Math.random())}`}function qr(e,t){var r,o,n,s;const i=at(e,STRUCTURE_SPAWN).find(e=>!e.spawning);if(!i)return;const a=e.energyCapacityAvailable,c=e.energyAvailable,l=0===Pr(Mr(e.name,!0)),u=l?c:a;if(l&&150>c&&(de.warn(`WORKFORCE COLLAPSE: ${c} energy available, need 150 to spawn minimal larvaWorker. Room will recover once energy reaches 150.`,{subsystem:"spawn",room:e.name}),qe.emit("spawn.emergency",{roomName:e.name,energyAvailable:c,message:"Critical workforce collapse - waiting for energy to spawn minimal creep",source:"SpawnManager"})),xr(e.name,e)&&Game.time%10==0){const t=Mr(e.name,!0),n=Mr(e.name,!1),s=null!==(r=t.get("larvaWorker"))&&void 0!==r?r:0,i=null!==(o=t.get("harvester"))&&void 0!==o?o:0;de.info(`BOOTSTRAP MODE: ${Pr(t)} active energy producers (${s} larva, ${i} harvest), ${Pr(n)} total. Energy: ${c}/${a}`,{subsystem:"spawn",room:e.name})}if(xr(e.name,e)){const r=function(e,t,r){var o;if(0===Pr(Mr(e,!0)))return de.info("Bootstrap: Spawning larvaWorker (emergency - no active energy producers)",{subsystem:"spawn",room:e}),"larvaWorker";const n=Mr(e,!1),s=Ir(t);de.info(`Bootstrap: Checking ${s.length} roles in order`,{subsystem:"spawn",room:e,meta:{totalCreeps:n.size,creepCounts:Array.from(n.entries())}});for(const i of s){if(i.condition&&!i.condition(t)){de.info(`Bootstrap: Skipping ${i.role} (condition not met)`,{subsystem:"spawn",room:e});continue}const s=null!==(o=n.get(i.role))&&void 0!==o?o:0;if(s<i.minCount){const t=Nr(e,i.role,r,!0);if(de.info(`Bootstrap: Role ${i.role} needs spawning (current: ${s}, min: ${i.minCount}, needsRole: ${t})`,{subsystem:"spawn",room:e}),t)return i.role;de.warn(`Bootstrap: Role ${i.role} blocked by needsRole check (current: ${s}/${i.minCount})`,{subsystem:"spawn",room:e})}}return de.info("Bootstrap: No role needs spawning",{subsystem:"spawn",room:e}),null}(e.name,e,t);if(!r)return;const o=yt[r];if(!o)return;let l=jr(o,u);if(l&&c>=l.cost);else if(l=jr(o,c),!l)return void de.info(`Bootstrap: No affordable body for ${r} (available: ${c}, min needed: ${null!==(s=null===(n=o.bodies[0])||void 0===n?void 0:n.cost)&&void 0!==s?s:"unknown"})`,{subsystem:"spawn",room:e.name});const m=Vr(r),d={role:o.role,family:o.family,homeRoom:e.name,version:1};if(!kr(r,d,t,e.name))return;let p;try{p=i.spawnCreep(l.parts,m,{memory:d})}catch(t){return void de.error(`EXCEPTION during spawn attempt for ${r}: ${t}`,{subsystem:"spawn",room:e.name,meta:{error:t+"",role:r,bodyCost:l.cost,bodyParts:l.parts.length}})}if(p===OK)de.info(`BOOTSTRAP SPAWN: ${r} (${m}) with ${l.parts.length} parts, cost ${l.cost}. Recovery in progress.`,{subsystem:"spawn",room:e.name}),qe.emit("spawn.completed",{roomName:e.name,creepName:m,role:r,cost:l.cost,source:"SpawnManager"});else{const t=p===ERR_NOT_ENOUGH_ENERGY?"ERR_NOT_ENOUGH_ENERGY":p===ERR_NAME_EXISTS?"ERR_NAME_EXISTS":p===ERR_BUSY?"ERR_BUSY":p===ERR_NOT_OWNER?"ERR_NOT_OWNER":p===ERR_INVALID_ARGS?"ERR_INVALID_ARGS":p===ERR_RCL_NOT_ENOUGH?"ERR_RCL_NOT_ENOUGH":`UNKNOWN(${p})`;de.warn(`BOOTSTRAP SPAWN FAILED: ${r} (${m}) - ${t}. Body: ${l.parts.length} parts, cost: ${l.cost}, available: ${c}`,{subsystem:"spawn",room:e.name,meta:{errorCode:p,errorName:t,role:r,bodyCost:l.cost,energyAvailable:c,energyCapacity:a}})}return}const m=function(e,t){var r,o;const n=Mr(e.name),s=function(e){switch(e){case"eco":return{harvester:1.5,hauler:1.2,upgrader:1.3,builder:1,queenCarrier:1,guard:.3,remoteGuard:.8,healer:.1,scout:1,claimer:.8,engineer:.8,remoteHarvester:1.2,remoteHauler:1.2,interRoomCarrier:1};case"expand":return{harvester:1.2,hauler:1,upgrader:.8,builder:1,queenCarrier:.8,guard:.3,remoteGuard:1,scout:1.5,claimer:1.5,remoteWorker:1.5,engineer:.5,remoteHarvester:1.5,remoteHauler:1.5,interRoomCarrier:1.2};case"defensive":return{harvester:1,hauler:1,upgrader:.5,builder:.5,queenCarrier:1,guard:2,remoteGuard:1.8,healer:1.5,ranger:1,scout:0,engineer:1.2,remoteHarvester:.5,remoteHauler:.5,interRoomCarrier:1.5};case"war":return{harvester:.8,hauler:.8,upgrader:.3,builder:.3,queenCarrier:1,guard:2.5,healer:2,soldier:2,ranger:1.5,scout:0,engineer:.5,remoteHarvester:.3,remoteHauler:.3,interRoomCarrier:.5};case"siege":return{harvester:.5,hauler:.5,upgrader:.1,builder:.1,queenCarrier:1,guard:3,healer:2.5,soldier:2.5,siegeUnit:2,ranger:1,scout:0,engineer:.2,remoteHarvester:.1,remoteHauler:.1};case"evacuate":return{hauler:2,queenCarrier:1.5};case"nukePrep":return{harvester:1,hauler:1,upgrader:.5,builder:.5,queenCarrier:1,guard:1.5,scout:.5,engineer:2,remoteHarvester:.5,remoteHauler:.5};default:return{harvester:1,hauler:1,upgrader:1,builder:1,queenCarrier:1,scout:1,remoteHarvester:1,remoteHauler:1}}}(t.posture),i=[];for(const[a,c]of Object.entries(yt)){if(!Nr(e.name,a,t))continue;const l=c.priority,u=null!==(r=s[a])&&void 0!==r?r:.5,m=Zt(a,t.pheromones),d=Qt(e,t,a),p=null!==(o=n.get(a))&&void 0!==o?o:0,g=(l+d)*u*m*(c.maxPerRoom>0?Math.max(.1,1-p/c.maxPerRoom):.1);i.push({role:a,score:g})}return i.sort((e,t)=>t.score-e.score),i.map(e=>e.role)}(e,t);for(const r of m){const o=yt[r];if(!o)continue;const n=jr(o,u);if(!n)continue;if(c<n.cost)continue;const s=Vr(r),a={role:o.role,family:o.family,homeRoom:e.name,version:1};if(!kr(r,a,t,e.name))continue;if("interRoomCarrier"===r&&t.clusterId){const r=Wt.getCluster(t.clusterId);if(r){const t=r.resourceRequests.find(t=>{if(t.fromRoom!==e.name)return!1;const r=t.assignedCreeps.filter(e=>Game.creeps[e]).length;return t.amount-t.delivered>500&&2>r});t&&(a.transferRequest={fromRoom:t.fromRoom,toRoom:t.toRoom,resourceType:t.resourceType,amount:t.amount},t.assignedCreeps.push(s))}}const l=i.spawnCreep(n.parts,s,{memory:a});if(l===OK)return void qe.emit("spawn.completed",{roomName:e.name,creepName:s,role:r,cost:n.cost,source:"SpawnManager"});if(l!==ERR_NOT_ENOUGH_ENERGY){const t=l===ERR_NAME_EXISTS?"ERR_NAME_EXISTS":l===ERR_BUSY?"ERR_BUSY":l===ERR_NOT_OWNER?"ERR_NOT_OWNER":l===ERR_INVALID_ARGS?"ERR_INVALID_ARGS":l===ERR_RCL_NOT_ENOUGH?"ERR_RCL_NOT_ENOUGH":`UNKNOWN(${l})`;return void de.warn(`Spawn failed for ${r}: ${t}. Body: ${n.parts.length} parts, cost: ${n.cost}`,{subsystem:"spawn",room:e.name,meta:{errorCode:l,errorName:t,role:r,bodyCost:n.cost}})}}m.length>0&&Game.time%20==0?de.info(`Waiting for energy: ${m.length} roles need spawning, waiting for optimal bodies. Energy: ${c}/${a}`,{subsystem:"spawn",room:e.name,meta:{topRoles:m.slice(0,3).join(", "),energyAvailable:c,energyCapacity:a}}):0===m.length&&Game.time%100==0&&de.info(`No spawns needed: All roles fully staffed. Energy: ${c}/${a}`,{subsystem:"spawn",room:e.name,meta:{energyAvailable:c,energyCapacity:a,activeCreeps:Mr(e.name,!0).size}})}function zr(e){return null!==e&&"object"==typeof e&&"pos"in e&&e.pos instanceof RoomPosition&&"room"in e&&e.room instanceof Room}const Xr=new Set(["harvester","upgrader","mineralHarvester","depositHarvester","factoryWorker","labTech","builder"]);function Qr(e,t,r,o){const n=o instanceof Error?o.message:o+"";de.warn(`SafeFind error in ${e}(${t+""}) at ${r}: ${n}`,{subsystem:"SafeFind"})}function Zr(e,t,r){try{return e.find(t,r)}catch(r){return Qr("room.find",t,e.name,r),[]}}function Jr(e,t,r){try{return e.findClosestByRange(t,r)}catch(r){return Qr("pos.findClosestByRange",t,`${e.roomName}:${e.x+""},${e.y+""}`,r),null}}const eo=me("CreepContext"),to={[STRUCTURE_SPAWN]:100,[STRUCTURE_EXTENSION]:90,[STRUCTURE_TOWER]:80,[STRUCTURE_RAMPART]:75,[STRUCTURE_WALL]:70,[STRUCTURE_STORAGE]:70,[STRUCTURE_CONTAINER]:60,[STRUCTURE_ROAD]:30},ro=new Map;function oo(e){e._allStructuresLoaded||(e.allStructures=e.room.find(FIND_STRUCTURES),e._allStructuresLoaded=!0)}function no(e){return void 0===e._prioritizedSites&&(e._prioritizedSites=e.room.find(FIND_MY_CONSTRUCTION_SITES).sort((e,t)=>{var r,o;const n=null!==(r=to[e.structureType])&&void 0!==r?r:50;return(null!==(o=to[t.structureType])&&void 0!==o?o:50)-n})),e._prioritizedSites}function so(e){return void 0===e._repairTargets&&(oo(e),e._repairTargets=e.allStructures.filter(e=>e.hits<.75*e.hitsMax&&e.structureType!==STRUCTURE_WALL)),e._repairTargets}let io=()=>{};function ao(e){var t,r;const o=e.room,n=e.memory,s=function(e){const t=ro.get(e.name);if(t&&t.tick===Game.time)return t;const r={tick:Game.time,room:e,hostiles:Zr(e,FIND_HOSTILE_CREEPS),myStructures:e.find(FIND_MY_STRUCTURES),allStructures:[]};return ro.set(e.name,r),r}(o);void 0===n.working&&(n.working=e.store.getUsedCapacity()>0,eo.debug(`${e.name} initialized working=${n.working} from carry state`,{creep:e.name}));const i=null!==(t=n.homeRoom)&&void 0!==t?t:o.name;return{creep:e,room:o,memory:n,get swarmState(){return function(e){var t;const r=null===(t=Memory.rooms)||void 0===t?void 0:t[e];return null==r?void 0:r.swarm}(o.name)},get squadMemory(){return function(e){if(!e)return;const t=Memory.squads;return null==t?void 0:t[e]}(n.squadId)},homeRoom:i,isInHomeRoom:o.name===i,isFull:0===e.store.getFreeCapacity(),isEmpty:0===e.store.getUsedCapacity(),isWorking:null!==(r=n.working)&&void 0!==r&&r,get assignedSource(){return function(e){return e.sourceId?Game.getObjectById(e.sourceId):null}(n)},get assignedMineral(){var e;const t=function(e){return void 0===e._minerals&&(e._minerals=e.room.find(FIND_MINERALS)),e._minerals}(s);return null!==(e=t[0])&&void 0!==e?e:null},get energyAvailable(){return function(e){return void 0===e._activeSources&&(e._activeSources=e.room.find(FIND_SOURCES_ACTIVE)),e._activeSources}(s).length>0},get nearbyEnemies(){return s.hostiles.length>0&&function(e,t){for(const r of t){const t=Math.abs(e.x-r.pos.x),o=Math.abs(e.y-r.pos.y);if(10>=Math.max(t,o))return!0}return!1}(e.pos,s.hostiles)},get constructionSiteCount(){return no(s).length},get damagedStructureCount(){return so(s).length},get droppedResources(){return function(e){return void 0===e._droppedResources&&(e._droppedResources=e.room.find(FIND_DROPPED_RESOURCES,{filter:e=>e.resourceType===RESOURCE_ENERGY&&e.amount>50||e.resourceType!==RESOURCE_ENERGY&&e.amount>0})),e._droppedResources}(s)},get containers(){return function(e){return void 0===e._containers&&(oo(e),e._containers=e.allStructures.filter(e=>e.structureType===STRUCTURE_CONTAINER)),e._containers}(s)},get depositContainers(){return function(e){return void 0===e._depositContainers&&(oo(e),e._depositContainers=e.allStructures.filter(e=>e.structureType===STRUCTURE_CONTAINER)),e._depositContainers}(s)},get spawnStructures(){return function(e){return void 0===e._spawnStructures&&(e._spawnStructures=e.myStructures.filter(e=>e.structureType===STRUCTURE_SPAWN||e.structureType===STRUCTURE_EXTENSION)),e._spawnStructures}(s)},get towers(){return function(e){return void 0===e._towers&&(e._towers=e.myStructures.filter(e=>e.structureType===STRUCTURE_TOWER)),e._towers}(s)},storage:o.storage,terminal:o.terminal,hostiles:s.hostiles,get damagedAllies(){return function(e){return void 0===e._damagedAllies&&(e._damagedAllies=e.room.find(FIND_MY_CREEPS,{filter:e=>e.hits<e.hitsMax})),e._damagedAllies}(s)},get prioritizedSites(){return no(s)},get repairTargets(){return so(s)},get labs(){return function(e){return void 0===e._labs&&(e._labs=e.myStructures.filter(e=>e.structureType===STRUCTURE_LAB)),e._labs}(s)},get factory(){return function(e){return e._factoryChecked||(e._factory=e.myStructures.find(e=>e.structureType===STRUCTURE_FACTORY),e._factoryChecked=!0),e._factory}(s)},get tombstones(){return function(e){return void 0===e._tombstones&&(e._tombstones=e.room.find(FIND_TOMBSTONES)),e._tombstones}(s)},get mineralContainers(){return function(e){return void 0===e._mineralContainers&&(e._mineralContainers=e.room.find(FIND_STRUCTURES,{filter:e=>{if(e.structureType!==STRUCTURE_CONTAINER)return!1;const t=e;return Object.keys(t.store).some(e=>e!==RESOURCE_ENERGY&&t.store.getUsedCapacity(e)>0)}})),e._mineralContainers}(s)}}}var co,lo={},uo=function(){if(co)return lo;co=1,Object.defineProperty(lo,"__esModule",{value:!0});var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==u?u:"undefined"!=typeof self?self:{},t=function(e){return e&&e.Math===Math&&e},r=t("object"==typeof globalThis&&globalThis)||t("object"==typeof window&&window)||t("object"==typeof self&&self)||t("object"==typeof e&&e)||t("object"==typeof e&&e)||function(){return this}()||Function("","return this")(),o={},n=function(e){try{return!!e()}catch(e){return!0}},s=!n(function(){return 7!==Object.defineProperty({},1,{get:function(){return 7}})[1]}),i=!n(function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")}),a=function(){}.call,c=i?a.bind(a):function(){return a.apply(a,arguments)},l={},m={}.propertyIsEnumerable,d=Object.getOwnPropertyDescriptor,p=d&&!m.call({1:2},1);l.f=p?function(e){var t=d(this,e);return!!t&&t.enumerable}:m;var g,f,h=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},y=i,R=Function.prototype,E=R.call,T=y&&R.bind.bind(E,E),C=y?T:function(e){return function(){return E.apply(e,arguments)}},v=C,S=v({}.toString),_=v("".slice),b=function(e){return _(S(e),8,-1)},O=n,U=b,M=Object,A=C("".split),w=O(function(){return!M("z").propertyIsEnumerable(0)})?function(e){return"String"===U(e)?A(e,""):M(e)}:M,k=function(e){return null==e},N=k,P=TypeError,I=function(e){if(N(e))throw new P("Can't call method on "+e);return e},x=w,$=I,G=function(e){return x($(e))},L="object"==typeof document&&document.all,D=void 0===L&&void 0!==L?function(e){return"function"==typeof e||e===L}:function(e){return"function"==typeof e},F=D,B=function(e){return"object"==typeof e?null!==e:F(e)},H=r,W=D,Y=function(e,t){return 2>arguments.length?(r=H[e],W(r)?r:void 0):H[e]&&H[e][t];var r},K=C({}.isPrototypeOf),j=r.navigator,V=j&&j.userAgent,q=r,z=V?V+"":"",X=q.process,Q=q.Deno,Z=X&&X.versions||Q&&Q.version,J=Z&&Z.v8;J&&(f=(g=J.split("."))[0]>0&&4>g[0]?1:+(g[0]+g[1])),!f&&z&&((g=z.match(/Edge\/(\d+)/))&&74>g[1]||(g=z.match(/Chrome\/(\d+)/))&&(f=+g[1]));var ee=f,te=n,re=r.String,oe=!!Object.getOwnPropertySymbols&&!te(function(){var e=Symbol("symbol detection");return!re(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&ee&&41>ee}),ne=oe&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,se=Y,ie=D,ae=K,ce=Object,le=ne?function(e){return"symbol"==typeof e}:function(e){var t=se("Symbol");return ie(t)&&ae(t.prototype,ce(e))},ue=String,me=D,de=TypeError,pe=function(e){if(me(e))return e;throw new de(function(e){try{return ue(e)}catch(e){return"Object"}}(e)+" is not a function")},ge=pe,fe=k,he=c,ye=D,Re=B,Ee=TypeError,Te={exports:{}},Ce=r,ve=Object.defineProperty,Se=function(e,t){try{ve(Ce,e,{value:t,configurable:!0,writable:!0})}catch(r){Ce[e]=t}return t},_e=r,be=Se,Oe="__core-js_shared__",Ue=Te.exports=_e[Oe]||be(Oe,{});(Ue.versions||(Ue.versions=[])).push({version:"3.42.0",mode:"global",copyright:" 2014-2025 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.42.0/LICENSE",source:"https://github.com/zloirock/core-js"});var Me=Te.exports,Ae=Me,we=function(e,t){return Ae[e]||(Ae[e]=t||{})},ke=I,Ne=Object,Pe=function(e){return Ne(ke(e))},Ie=Pe,xe=C({}.hasOwnProperty),$e=Object.hasOwn||function(e,t){return xe(Ie(e),t)},Ge=C,Le=0,De=Math.random(),Fe=Ge(1..toString),Be=function(e){return"Symbol("+(void 0===e?"":e)+")_"+Fe(++Le+De,36)},He=we,We=$e,Ye=Be,Ke=oe,je=ne,Ve=r.Symbol,qe=He("wks"),ze=je?Ve.for||Ve:Ve&&Ve.withoutSetter||Ye,Xe=function(e){return We(qe,e)||(qe[e]=Ke&&We(Ve,e)?Ve[e]:ze("Symbol."+e)),qe[e]},Qe=c,Ze=B,Je=le,et=TypeError,tt=Xe("toPrimitive"),rt=le,ot=function(e){var t=function(e,t){if(!Ze(e)||Je(e))return e;var r,o,n=(o=e[tt],fe(o)?void 0:ge(o));if(n){if(void 0===t&&(t="default"),r=Qe(n,e,t),!Ze(r)||Je(r))return r;throw new et("Can't convert object to primitive value")}return void 0===t&&(t="number"),function(e,t){var r,o;if("string"===t&&ye(r=e.toString)&&!Re(o=he(r,e)))return o;if(ye(r=e.valueOf)&&!Re(o=he(r,e)))return o;if("string"!==t&&ye(r=e.toString)&&!Re(o=he(r,e)))return o;throw new Ee("Can't convert object to primitive value")}(e,t)}(e,"string");return rt(t)?t:t+""},nt=B,st=r.document,it=nt(st)&&nt(st.createElement),at=function(e){return it?st.createElement(e):{}},ct=at,lt=!s&&!n(function(){return 7!==Object.defineProperty(ct("div"),"a",{get:function(){return 7}}).a}),ut=s,mt=c,dt=l,pt=h,gt=G,ft=ot,ht=$e,yt=lt,Rt=Object.getOwnPropertyDescriptor;o.f=ut?Rt:function(e,t){if(e=gt(e),t=ft(t),yt)try{return Rt(e,t)}catch(e){}if(ht(e,t))return pt(!mt(dt.f,e,t),e[t])};var Et={},Tt=s&&n(function(){return 42!==Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype}),Ct=B,vt=String,St=TypeError,_t=function(e){if(Ct(e))return e;throw new St(vt(e)+" is not an object")},bt=s,Ot=lt,Ut=Tt,Mt=_t,At=ot,wt=TypeError,kt=Object.defineProperty,Nt=Object.getOwnPropertyDescriptor,Pt="enumerable",It="configurable",xt="writable";Et.f=bt?Ut?function(e,t,r){if(Mt(e),t=At(t),Mt(r),"function"==typeof e&&"prototype"===t&&"value"in r&&xt in r&&!r[xt]){var o=Nt(e,t);o&&o[xt]&&(e[t]=r.value,r={configurable:It in r?r[It]:o[It],enumerable:Pt in r?r[Pt]:o[Pt],writable:!1})}return kt(e,t,r)}:kt:function(e,t,r){if(Mt(e),t=At(t),Mt(r),Ot)try{return kt(e,t,r)}catch(e){}if("get"in r||"set"in r)throw new wt("Accessors not supported");return"value"in r&&(e[t]=r.value),e};var $t=Et,Gt=h,Lt=s?function(e,t,r){return $t.f(e,t,Gt(1,r))}:function(e,t,r){return e[t]=r,e},Dt={exports:{}},Ft=s,Bt=Function.prototype,Ht=Ft&&Object.getOwnPropertyDescriptor,Wt={CONFIGURABLE:$e(Bt,"name")&&(!Ft||Ft&&Ht(Bt,"name").configurable)},Yt=D,Kt=Me,jt=C(Function.toString);Yt(Kt.inspectSource)||(Kt.inspectSource=function(e){return jt(e)});var Vt,qt,zt,Xt=Kt.inspectSource,Qt=D,Zt=r.WeakMap,Jt=Qt(Zt)&&/native code/.test(Zt+""),er=Be,tr=we("keys"),rr=function(e){return tr[e]||(tr[e]=er(e))},or={},nr=Jt,sr=r,ir=Lt,ar=$e,cr=Me,lr=rr,ur=or,mr="Object already initialized",dr=sr.TypeError,pr=sr.WeakMap;if(nr||cr.state){var gr=cr.state||(cr.state=new pr);gr.get=gr.get,gr.has=gr.has,gr.set=gr.set,Vt=function(e,t){if(gr.has(e))throw new dr(mr);return t.facade=e,gr.set(e,t),t},qt=function(e){return gr.get(e)||{}},zt=function(e){return gr.has(e)}}else{var fr=lr("state");ur[fr]=!0,Vt=function(e,t){if(ar(e,fr))throw new dr(mr);return t.facade=e,ir(e,fr,t),t},qt=function(e){return ar(e,fr)?e[fr]:{}},zt=function(e){return ar(e,fr)}}var hr={get:qt,enforce:function(e){return zt(e)?qt(e):Vt(e,{})}},yr=C,Rr=n,Er=D,Tr=$e,Cr=s,vr=Wt.CONFIGURABLE,Sr=Xt,_r=hr.enforce,br=hr.get,Or=String,Ur=Object.defineProperty,Mr=yr("".slice),Ar=yr("".replace),wr=yr([].join),kr=Cr&&!Rr(function(){return 8!==Ur(function(){},"length",{value:8}).length}),Nr=(String+"").split("String"),Pr=Dt.exports=function(e,t,r){"Symbol("===Mr(Or(t),0,7)&&(t="["+Ar(Or(t),/^Symbol\(([^)]*)\).*$/,"$1")+"]"),r&&r.getter&&(t="get "+t),r&&r.setter&&(t="set "+t),(!Tr(e,"name")||vr&&e.name!==t)&&(Cr?Ur(e,"name",{value:t,configurable:!0}):e.name=t),kr&&r&&Tr(r,"arity")&&e.length!==r.arity&&Ur(e,"length",{value:r.arity});try{r&&Tr(r,"constructor")&&r.constructor?Cr&&Ur(e,"prototype",{writable:!1}):e.prototype&&(e.prototype=void 0)}catch(e){}var o=_r(e);return Tr(o,"source")||(o.source=wr(Nr,"string"==typeof t?t:"")),e};Function.prototype.toString=Pr(function(){return Er(this)&&br(this).source||Sr(this)},"toString");var Ir=Dt.exports,xr=D,$r=Et,Gr=Ir,Lr=Se,Dr={},Fr=Math.ceil,Br=Math.floor,Hr=Math.trunc||function(e){var t=+e;return(t>0?Br:Fr)(t)},Wr=function(e){var t=+e;return t!=t||0===t?0:Hr(t)},Yr=Wr,Kr=Math.max,jr=Math.min,Vr=Wr,qr=Math.min,zr=function(e){return t=e.length,(r=Vr(t))>0?qr(r,9007199254740991):0;var t,r},Xr=G,Qr=zr,Zr={indexOf:function(e,t,r){var o=Xr(e),n=Qr(o);if(0===n)return-1;for(var s=function(e,t){var r=Yr(e);return 0>r?Kr(r+t,0):jr(r,t)}(r,n);n>s;s++)if(s in o&&o[s]===t)return s||0;return-1}},Jr=$e,eo=G,to=Zr.indexOf,ro=or,oo=C([].push),no=function(e,t){var r,o=eo(e),n=0,s=[];for(r in o)!Jr(ro,r)&&Jr(o,r)&&oo(s,r);for(;t.length>n;)Jr(o,r=t[n++])&&(~to(s,r)||oo(s,r));return s},so=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],io=no,ao=so.concat("length","prototype");Dr.f=Object.getOwnPropertyNames||function(e){return io(e,ao)};var uo={};uo.f=Object.getOwnPropertySymbols;var mo=Y,po=Dr,go=uo,fo=_t,ho=C([].concat),yo=mo("Reflect","ownKeys")||function(e){var t=po.f(fo(e)),r=go.f;return r?ho(t,r(e)):t},Ro=$e,Eo=yo,To=o,Co=Et,vo=n,So=D,_o=/#|\.prototype\./,bo=function(e,t){var r=Uo[Oo(e)];return r===Ao||r!==Mo&&(So(t)?vo(t):!!t)},Oo=bo.normalize=function(e){return(e+"").replace(_o,".").toLowerCase()},Uo=bo.data={},Mo=bo.NATIVE="N",Ao=bo.POLYFILL="P",wo=bo,ko=r,No=o.f,Po=Lt,Io=function(e,t,r,o){o||(o={});var n=o.enumerable,s=void 0!==o.name?o.name:t;if(xr(r)&&Gr(r,s,o),o.global)n?e[t]=r:Lr(t,r);else{try{o.unsafe?e[t]&&(n=!0):delete e[t]}catch(e){}n?e[t]=r:$r.f(e,t,{value:r,enumerable:!1,configurable:!o.nonConfigurable,writable:!o.nonWritable})}return e},xo=Se,$o=function(e,t,r){for(var o=Eo(t),n=Co.f,s=To.f,i=0;i<o.length;i++){var a=o[i];Ro(e,a)||r&&Ro(r,a)||n(e,a,s(t,a))}},Go=wo,Lo=function(e,t){var r,o,n,s,i,a=e.target,c=e.global,l=e.stat;if(r=c?ko:l?ko[a]||xo(a,{}):ko[a]&&ko[a].prototype)for(o in t){if(s=t[o],n=e.dontCallGetSet?(i=No(r,o))&&i.value:r[o],!Go(c?o:a+(l?".":"#")+o,e.forced)&&void 0!==n){if(typeof s==typeof n)continue;$o(s,n)}(e.sham||n&&n.sham)&&Po(s,"sham",!0),Io(r,o,s,e)}},Do=b,Fo=Array.isArray||function(e){return"Array"===Do(e)},Bo=TypeError,Ho=b,Wo=C,Yo=function(e){if("Function"===Ho(e))return Wo(e)},Ko=pe,jo=i,Vo=Yo(Yo.bind),qo=Fo,zo=zr,Xo=function(e){if(e>9007199254740991)throw Bo("Maximum allowed index exceeded");return e},Qo=function(e,t,r,o,n,s,i,a){for(var c,l,u=n,m=0,d=!!i&&function(e,t){return Ko(e),void 0===t?e:jo?Vo(e,t):function(){return e.apply(t,arguments)}}(i,a);o>m;)m in r&&(c=d?d(r[m],m,t):r[m],s>0&&qo(c)?(l=zo(c),u=Qo(e,t,c,l,u,s-1)-1):(Xo(u+1),e[u]=c),u++),m++;return u},Zo=Qo,Jo={};Jo[Xe("toStringTag")]="z";var en=Jo+""=="[object z]",tn=D,rn=b,on=Xe("toStringTag"),nn=Object,sn="Arguments"===rn(function(){return arguments}()),an=C,cn=n,ln=D,un=en?rn:function(e){var t,r,o;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(e){}}(t=nn(e),on))?r:sn?rn(t):"Object"===(o=rn(t))&&tn(t.callee)?"Arguments":o},mn=Xt,dn=function(){},pn=Y("Reflect","construct"),gn=/^\s*(?:class|function)\b/,fn=an(gn.exec),hn=!gn.test(dn),yn=function(e){if(!ln(e))return!1;try{return pn(dn,[],e),!0}catch(e){return!1}},Rn=function(e){if(!ln(e))return!1;switch(un(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return hn||!!fn(gn,mn(e))}catch(e){return!0}};Rn.sham=!0;var En=!pn||cn(function(){var e;return yn(yn.call)||!yn(Object)||!yn(function(){e=!0})||e})?Rn:yn,Tn=Fo,Cn=En,vn=B,Sn=Xe("species"),_n=Array,bn=function(e,t){return new(function(e){var t;return Tn(e)&&(t=e.constructor,(Cn(t)&&(t===_n||Tn(t.prototype))||vn(t)&&null===(t=t[Sn]))&&(t=void 0)),void 0===t?_n:t}(e))(0===t?0:t)},On=Zo,Un=pe,Mn=Pe,An=zr,wn=bn;Lo({target:"Array",proto:!0},{flatMap:function(e){var t,r=Mn(this),o=An(r);return Un(e),(t=wn(r,0)).length=On(t,r,r,o,0,1,e,arguments.length>1?arguments[1]:void 0),t}});var kn={},Nn=no,Pn=so,In=s,xn=Tt,$n=Et,Gn=_t,Ln=G,Dn=Object.keys||function(e){return Nn(e,Pn)};kn.f=In&&!xn?Object.defineProperties:function(e,t){Gn(e);for(var r,o=Ln(t),n=Dn(t),s=n.length,i=0;s>i;)$n.f(e,r=n[i++],o[r]);return e};var Fn,Bn=Y("document","documentElement"),Hn=_t,Wn=kn,Yn=so,Kn=or,jn=Bn,Vn=at,qn="prototype",zn="script",Xn=rr("IE_PROTO"),Qn=function(){},Zn=function(e){return"<"+zn+">"+e+"</"+zn+">"},Jn=function(e){e.write(Zn("")),e.close();var t=e.parentWindow.Object;return e=null,t},es=function(){try{Fn=new ActiveXObject("htmlfile")}catch(e){}var e,t,r;es="undefined"!=typeof document?document.domain&&Fn?Jn(Fn):(t=Vn("iframe"),r="java"+zn+":",t.style.display="none",jn.appendChild(t),t.src=r+"",(e=t.contentWindow.document).open(),e.write(Zn("document.F=Object")),e.close(),e.F):Jn(Fn);for(var o=Yn.length;o--;)delete es[qn][Yn[o]];return es()};Kn[Xn]=!0;var ts=Xe,rs=Object.create||function(e,t){var r;return null!==e?(Qn[qn]=Hn(e),r=new Qn,Qn[qn]=null,r[Xn]=e):r=es(),void 0===t?r:Wn.f(r,t)},os=Et.f,ns=ts("unscopables"),ss=Array.prototype;void 0===ss[ns]&&os(ss,ns,{configurable:!0,value:rs(null)});var is=function(e){ss[ns][e]=!0};is("flatMap");var as=r,cs=C,ls=function(e,t){return cs(as[e].prototype[t])};ls("Array","flatMap");var us=Zo,ms=Pe,ds=zr,ps=Wr,gs=bn;Lo({target:"Array",proto:!0},{flat:function(){var e=arguments.length?arguments[0]:void 0,t=ms(this),r=ds(t),o=gs(t,0);return o.length=us(o,t,t,r,0,void 0===e?1:ps(e)),o}}),is("flat"),ls("Array","flat");const fs={DEFAULT_MOVE_OPTS:{avoidCreeps:!1,avoidObstacleStructures:!0,avoidSourceKeepers:!0,keepTargetInRoom:!0,repathIfStuck:3,roadCost:1,plainCost:2,swampCost:10,priority:1,defaultRoomCost:2,highwayRoomCost:1,sourceKeeperRoomCost:2,maxRooms:64,maxOps:1e5,maxOpsPerRoom:2e3},DEFAULT_VISUALIZE_OPTS:{fill:"transparent",stroke:"#fff",lineStyle:"dashed",strokeWidth:.15,opacity:.1},MEMORY_CACHE_PATH:"_cg",MEMORY_CACHE_EXPIRATION_PATH:"_cge",MEMORY_PORTAL_PATH:"_cgp"},hs=new Map,ys=new Map,Rs={set(e,t,r){hs.set(e,t),void 0!==r&&ys.set(e,r)},get:e=>hs.get(e),expires:e=>ys.get(e),delete(e){hs.delete(e)},with:()=>Rs,clean(){for(const[e,t]of ys)Game.time<t||(Rs.delete(e),ys.delete(e))}};var Es=(()=>{const e=15,t=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536,131072,262144,524288,1048576,2097152,4194304,8388608,16777216,33554432,67108864,134217728,268435456,536870912,1073741824,2147483648,4294967296,8589934592,17179869184,34359738368,68719476736,137438953472,274877906944,549755813888,1099511627776,2199023255552,4398046511104,8796093022208,17592186044416,35184372088832,70368744177664,0x800000000000,281474976710656,562949953421312,0x4000000000000,0x8000000000000,4503599627370496,9007199254740992],r=32768;class o extends RangeError{constructor(e){super("[utf15][RangeError]: "+e)}}class n extends TypeError{constructor(e){super("[utf15][TypeError]: "+e)}}const s=(e,t,...r)=>{if(!e)throw new t(r.reduce((e,t)=>e+t+" ",""))},i=e=>(s((e=+e)>=0&&r>e,o,"x out of bounds:",e),e+48),a=e=>(s((e=+e)>=0&&65535>=e,o,"x out of bounds:",e),e-48);function c(r,o){const a=Array.isArray(this.depth),c=a?0:this.depth,l=a?this.depth:[];s(c||l.length===o.length,n,"Wrong depths array length:",l,o),a||(r+=String.fromCodePoint(i(o.length)));let u=0,m=0;for(let n=0,s=o.length;s>n;++n){const s=o[n],a=c||l[n];for(let o=0;a>o;){const n=Math.min(e-u,a-o);let c=Math.floor(s/t[o]);c%=t[n],c*=t[u],m+=c,o+=n,u+=n,u===e&&(r+=String.fromCodePoint(i(m)),u=m=0)}}return 0!==u&&(r+=String.fromCodePoint(i(m))),r}function l(r,o){s(!this.meta||o.depth>0||0===o.depth&&Array.isArray(this.depth),n,"Array decoding error (check inputs and codec config)"),o.depth=o.depth||this.depth;const i=Array.isArray(o.depth);let c=0,l=0;const u=i?o.depth.length:a(r.codePointAt(c++)),m=i?0:o.depth,d=i?o.depth:[],p=Array(u);let g=0,f=a(r.codePointAt(c++));for(;u>l;){const o=m||d[l];let n=0,s=0;for(;o>s;){const i=Math.min(e-g,o-s);let m=Math.floor(f/t[g]);if(m%=t[i],m*=t[s],n+=m,s+=i,g+=i,g===e){if(l+1===u&&s===o)break;f=a(r.codePointAt(c++)),g=0}}s>0&&(p[l++]=n)}return[p,c]}return{Codec:class{constructor(e){e=e||{},this.meta=+!!e.meta,this.array=+!!e.array,this.depth=e.depth||53,(e=>{let t=!1;if(t=t||isNaN(e.meta)||0!==e.meta&&1!==e.meta,t=t||isNaN(e.array)||0!==e.array&&1!==e.array,t||(()=>{const r=Array.isArray(e.depth);if(t=t||r&&!e.array,t)return;const o=e=>isNaN(e)||0>=e||e>53;r?e.depth.forEach((r,n)=>{e.depth[n]=+e.depth[n],t=t||o(r)}):(e.depth=+e.depth,t=t||o(e.depth))})(),t){let t="[JSON.stringify() ERROR]";try{t=JSON.stringify(e)}finally{}s(0,n,"Codec config is invalid:",t)}})(this)}encode(o){s((+Array.isArray(o)|+!!o.BYTES_PER_ELEMENT)^!this.array,n,"Incompatible codec (array <=> single value), arg =",o);let a="";if(this.meta&&(a=((e,t)=>{const r=Array.isArray(t.depth)?0:t.depth;return e+String.fromCodePoint(i(t.array),i(r))})(a,this)),this.array)a=c.call(this,a,o);else{let n=+o%t[this.depth];const s=Math.ceil(this.depth/e);for(let e=0;s>e;++e){const e=i(n%r);a+=String.fromCodePoint(e),n=Math.floor(n/r)}}return a}decode(r,o){let i=null,c=0;if(this.meta?[r,c]=((e,t,r)=>(r=r||0,t.array=a(e.codePointAt(r)),t.depth=a(e.codePointAt(r+1)),[e.slice(r+2),2]))(r,i={}):i=this,s(i.array^!this.array,n,"Incompatible codec (array <=> single value), str =",r),this.array){const e=l.call(this,r,i);return o&&(o.length=c+e[1]),e[0]}let u=0,m=0;const d=Math.ceil(i.depth/e);for(let o=0;d>o;++o)u+=a(r.codePointAt(o))*t[m],m+=e;return o&&(o.length=c+d),u}},MAX_DEPTH:53}})();const Ts=new Es.Codec({array:!1}),Cs={key:"ns",serialize(e){if(void 0!==e)return Ts.encode(e)},deserialize(e){if(void 0!==e)return Ts.decode(e)}},vs=(e,t)=>`cg_${e.key}_${t}`,Ss=(e,t)=>Object.assign(Object.assign({},e),{get(r){var o;const n=e.get(r);if(n)try{const e=null!==(o=Rs.get(vs(t,n)))&&void 0!==o?o:t.deserialize(n);return void 0!==e&&Rs.set(vs(t,n),e,Game.time+CREEP_LIFE_TIME),e}catch(o){return e.delete(r),void Rs.delete(vs(t,n))}},set(r,o,n){const s=e.get(r);s&&Rs.delete(vs(t,s));const i=t.serialize(o);i?(e.set(r,i,n),Rs.set(vs(t,i),o,Game.time+CREEP_LIFE_TIME)):e.delete(r)},delete(r){const o=e.get(r);o&&Rs.delete(vs(t,o)),e.delete(r)},with:t=>Ss(e,t)});function _s(){var e,t;return null!==(e=Memory[t=fs.MEMORY_CACHE_PATH])&&void 0!==e||(Memory[t]={}),Memory[fs.MEMORY_CACHE_PATH]}function bs(){var e,t;return null!==(e=Memory[t=fs.MEMORY_CACHE_EXPIRATION_PATH])&&void 0!==e||(Memory[t]={}),Memory[fs.MEMORY_CACHE_EXPIRATION_PATH]}const Os={set(e,t,r){if(_s()[e]=t,void 0!==r){const t=Cs.serialize(r);t&&(bs()[e]=t)}},get:e=>_s()[e],expires:e=>Cs.deserialize(bs()[e]),delete(e){delete _s()[e]},with:e=>Ss(Os,e),clean(){const e=bs();for(const t in e){const r=Cs.deserialize(e[t]);void 0===r||Game.time<r||(Os.delete(t),delete e[t])}}},Us=(e,t,r=1/0)=>{let o=new Map,n=Game.time;return(...s)=>{Game.time<n+r||(n=Game.time,o=new Map);const i=e(...s);return o.has(i)||o.set(i,t(...s)),o.get(i)}},Ms=(e,t)=>Us(e,t,1),As=Us(e=>e,e=>{for(let t=2;t<e.length;t++)if("N"===e[t]||"S"===e[t]){const r=e[0],o=e[t];let n=parseInt(e.slice(1,t)),s=parseInt(e.slice(t+1));return"W"===r&&(n=-n-1),"N"===o&&(s=-s-1),n+=128,s+=128,n<<8|s}throw Error("Invalid room name "+e)}),ws=(e,t,r)=>{const o=Object.create(RoomPosition.prototype);return o.__packedPos=As(r)<<16|e<<8|t,o},ks=(e,t,r)=>{const o=Object.create(RoomPosition.prototype);return o.__packedPos=4294901760&e.__packedPos|t<<8|r,o},Ns=(e,t,r)=>{const o=e.__packedPos>>8&255,n=255&e.__packedPos,s=Object.create(RoomPosition.prototype);return s.__packedPos=4294901760&e.__packedPos|o+t<<8|n+r,s},Ps=new Es.Codec({array:!1,depth:28}),Is=new Es.Codec({array:!0,depth:12}),xs=new Es.Codec({depth:3,array:!0}),$s=new Es.Codec({array:!0,depth:16}),Gs=["WN","EN","WS","ES"],Ls=e=>{const t=(65280&e.__packedPos)>>8,r=255&e.__packedPos,o=e.__packedPos>>>4&4294963200|t<<6|r;return Ps.encode(o)},Ds=function(e){const t=Ps.decode(e),r=t<<4&4294901760|(4032&t)>>6<<8|63&t,o=Object.create(RoomPosition.prototype);if(o.__packedPos=r,o.x>49||o.y>49)throw Error("Invalid room position");return o},Fs=e=>Hs([e]),Bs=e=>Ws(e)[0],Hs=e=>Is.encode(e.map(e=>e.x<<6|e.y)),Ws=e=>Is.decode(e).map(e=>{const t={x:(4032&e)>>6,y:63&e};if(t.x>49||t.y>49)throw Error("Invalid packed coord");return t}),Ys=e=>e.map(e=>Ls(e)).join(""),Ks=e=>{var t;return null===(t=e.match(/.{1,2}/g))||void 0===t?void 0:t.map(e=>Ds(e))},js=e=>{let t=e.match(/^([WE])([0-9]+)([NS])([0-9]+)$/);if(!t)throw Error("Invalid room name");let[,r,o,n,s]=t;return{wx:"W"==r?~+o:+o,wy:"N"==n?~+s:+s}},Vs=(e,t)=>`${0>e?"W":"E"}${e=0>e?~e:e}${0>t?"N":"S"}${t=0>t?~t:t}`,qs=e=>{let{x:t,y:r,roomName:o}=e;if(0>t||t>=50)throw new RangeError("x value "+t+" not in range");if(0>r||r>=50)throw new RangeError("y value "+r+" not in range");if("sim"==o)throw new RangeError("Sim room does not have world position");let{wx:n,wy:s}=js(o);return{x:50*+n+t,y:50*+s+r}},zs=e=>{let[t,r]=[Math.floor(e.x/50),e.x%50],[o,n]=[Math.floor(e.y/50),e.y%50];0>t&&0>r&&(r=49-~r),0>o&&0>n&&(n=49-~n);let s=Vs(t,o);return ws(r,n,s)},Xs=(e,t)=>{if(e.roomName===t.roomName)return e.getRangeTo(t);let r=qs(e),o=qs(t);return Math.max(Math.abs(r.x-o.x),Math.abs(r.y-o.y))};function Qs(e,t){const r=[{x:0,y:-1},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:-1,y:-1}][t-1];let o=e.x+r.x,n=e.y+r.y,s=e.roomName;if(0>o){const{wx:t,wy:r}=js(e.roomName);s=Vs(t-1,r),o=49}else if(o>49){const{wx:t,wy:r}=js(e.roomName);s=Vs(t+1,r),o=0}else if(0>n){const{wx:t,wy:r}=js(e.roomName);s=Vs(t,r-1),n=49}else if(n>49){const{wx:t,wy:r}=js(e.roomName);s=Vs(t,r+1),n=0}return s===e.roomName?ks(e,o,n):ws(o,n,s)}const Zs=e=>$s.encode(e.map(e=>{const[t,r,o,n,s]=e.split(/([A-Z])([0-9]+)([A-Z])([0-9]+)/);return Gs.indexOf(r+n)<<14|parseInt(o)<<7|parseInt(s)})),Js=e=>$s.decode(e).map(e=>{const t=e>>14,r=e>>7&127,o=127&e,[n,s]=Gs[t].split("");return`${n}${r}${s}${o}`}),ei=e=>Zs([e]),ti=e=>Js(e)[0],ri=new Es.Codec({array:!1,depth:15}),oi={key:"mts",serialize(e){if(void 0!==e)return`${Ls(e.pos)}${ri.encode(e.range)}`},deserialize(e){if(void 0!==e)return{pos:Ds(e.slice(0,2)),range:ri.decode(e.slice(2))}}},ni={key:"mtls",serialize(e){if(void 0!==e)return e.map(e=>oi.serialize(e)).join("")},deserialize(e){if(void 0===e)return;const t=[];for(let r=0;r<e.length;r+=3){const o=oi.deserialize(e.slice(r,r+3));o&&t.push(o)}return t}},si={key:"ps",serialize(e){if(void 0!==e)return Ls(e)},deserialize(e){if(void 0!==e)return Ds(e)}},ii={key:"pls",serialize(e){if(void 0!==e)return Ys(e)},deserialize(e){if(void 0!==e)return Ks(e)}},ai={key:"cs",serialize(e){if(void 0!==e)return Fs(e)},deserialize(e){if(void 0!==e)return Bs(e)}},ci={key:"cls",serialize(e){if(void 0!==e)return Hs(e)},deserialize(e){if(void 0!==e)return Ws(e)}};function li(){Os.clean(),Rs.clean()}const ui={HeapCache:Rs,MemoryCache:Os};class mi extends Set{constructor(){super(...arguments),this.map=new Map}add(e){return this.map.set(e.__packedPos,e),this}delete(e){return this.map.delete(e.__packedPos)}has(e){return this.map.has(e.__packedPos)}clear(){this.map.clear()}*entries(){for(const e of this.map.values())yield[e,e]}values(){return this.map.values()}keys(){return this.map.values()}[Symbol.iterator](){return this.map.values()}get size(){return this.map.size}}const di=e=>0===e.x||0===e.y||49===e.x||49===e.y,pi=Us((e,t=!0,r=!1)=>{let o=`${t}${r}`;return Array.isArray(e)?e.length&&"pos"in e[0]?o+=e.map(e=>`${e.pos.__packedPos}_${e.range}`).join(","):o+=e.map(e=>e.__packedPos).join(","):o+="pos"in e?"range"in e?`${e.pos.__packedPos}_${e.range}`:e.pos.__packedPos+"_1":e.__packedPos+"_1",o},(e,t=!0,r=!1)=>{let o=[];if(Array.isArray(e)?e.length&&"pos"in e[0]?o.push(...e):o.push(...e.map(e=>({pos:e,range:0}))):"pos"in e?"range"in e?o.push(e):o.push({pos:e.pos,range:1}):o.push({pos:e,range:1}),t&&(o=o.flatMap(gi)),r){const e=new mi;for(const{pos:r,range:n}of o)Ri(r,n+1).filter(e=>!!Ti(e,!0,!1)&&(!t||e.roomName===r.roomName&&!di(e))).forEach(t=>e.add(t));for(const t of e)o.some(e=>e.pos.inRangeTo(t,e.range))&&e.delete(t);o=[...e].map(e=>({pos:e,range:0}))}return o});function gi({pos:e,range:t}){if(0===t||e.x>t&&49-e.x>t&&e.y>t&&49-e.y>t)return[{pos:e,range:t}];const r=Math.max(1,e.x-t),o=Math.min(48,e.x+t),n=Math.max(1,e.y-t),s=Math.min(48,e.y+t),i=o-r+1,a=s-n+1,c=Math.floor((Math.min(i,a)-1)/2),l=Math.floor(i/(c+1)),u=Math.floor(a/(c+1)),m=new Set(Array(l).fill(0).map((e,t)=>Math.min(o-c,r+c+t*(2*c+1)))),d=new Set(Array(u).fill(0).map((e,t)=>Math.min(s-c,n+c+t*(2*c+1)))),p=[];for(const t of m)for(const r of d)p.push({pos:ks(e,t,r),range:c});return p}const fi=(e=1)=>{let t=Array(2*e+1).fill(0).map((t,r)=>r-e);return t.flatMap(e=>t.map(t=>({x:e,y:t}))).filter(e=>!(0===e.x&&0===e.y))},hi=e=>yi(e,1),yi=(e,t,r=!1)=>{if(0===t)return[e];let o=[];return o=fi(t).map(t=>0>e.x+t.x||e.x+t.x>49||0>e.y+t.y||e.y+t.y>49?null:Ns(e,t.x,t.y)).filter(e=>null!==e),r&&o.push(e),o},Ri=(e,t)=>{const r=qs(e);let o=[];for(let e=r.x-t;e<=r.x+t;e++)o.push(zs({x:e,y:r.y-t})),o.push(zs({x:e,y:r.y+t}));for(let e=r.y-t+1;e<=r.y+t-1;e++)o.push(zs({x:r.x-t,y:e})),o.push(zs({x:r.x+t,y:e}));return o},Ei=(e,t=!1)=>hi(e).filter(e=>Ti(e,t)),Ti=(e,t=!1,r=!1)=>{let o;try{o=Game.map.getRoomTerrain(e.roomName)}catch(e){return!1}return!(o.get(e.x,e.y)===TERRAIN_MASK_WALL||Game.rooms[e.roomName]&&e.look().some(e=>!(t||e.type!==LOOK_CREEPS&&e.type!==LOOK_POWER_CREEPS)||!(r||!e.constructionSite||!e.constructionSite.my||!OBSTACLE_OBJECT_TYPES.includes(e.constructionSite.structureType))||!(r||!e.structure||!(OBSTACLE_OBJECT_TYPES.includes(e.structure.structureType)||e.structure instanceof StructureRampart&&!e.structure.my))))},Ci=e=>{let t=e.match(/^[WE]([0-9]+)[NS]([0-9]+)$/);if(!t)throw Error("Invalid room name");return+t[1]%10==0||+t[2]%10==0},vi=e=>{let t=e.match(/^[WE]([0-9]+)[NS]([0-9]+)$/);if(!t)throw Error("Invalid room name");let r=+t[1]%10,o=+t[2]%10;return!(5===r&&5===o||4>r||r>6||4>o||o>6)},Si=(e,t,r)=>r?e.slice(0,t):e.slice(t+1),_i=e=>"_ck"+e;function bi(e){vi(e)&&!Os.get(_i(e))&&Os.with(ii).set(_i(e),[...Game.rooms[e].find(FIND_SOURCES),...Game.rooms[e].find(FIND_MINERALS)].map(e=>e.pos))}class Oi extends Map{get(e){return super.get(e.x<<6|e.y)}set(e,t){return super.set(e.x<<6|e.y,t),this}delete(e){return super.delete(e.x<<6|e.y)}has(e){return super.has(e.x<<6|e.y)}*entries(){for(const[e,t]of super.entries()){const r={x:e>>6,y:63&e};yield[r,t]}}values(){return super.values()}*keys(){for(const e of super.keys()){const t={x:e>>6,y:63&e};yield t}}[Symbol.iterator](){return this.entries()}}class Ui extends Oi{constructor(){super(...arguments),this.reversed=new Oi}set(e,t){return this.reversed.set(t,e),super.set(e,t)}delete(e){const t=this.get(e);return t&&this.reversed.delete(t),super.delete(e)}clear(){this.reversed.clear(),super.clear()}}var Mi,Ai,wi,ki;const Ni=new Es.Codec({array:!1,depth:30}),Pi=new Map;null!==(Mi=Memory[ki=fs.MEMORY_PORTAL_PATH])&&void 0!==Mi||(Memory[ki]=[]);for(const e of Memory[fs.MEMORY_PORTAL_PATH]){const t=$i(e),r=null!==(Ai=Pi.get(t.room1))&&void 0!==Ai?Ai:new Map;r.set(t.room2,t),Pi.set(t.room1,r);const o=null!==(wi=Pi.get(t.room2))&&void 0!==wi?wi:new Map;o.set(t.room1,t),Pi.set(t.room2,o)}function Ii(e){var t,r,o,n,s;if(!Ci(e)&&!(e=>{let t=e.match(/^[WE]([0-9]+)[NS]([0-9]+)$/);if(!t)throw Error("Invalid room name");return+t[1]%10==5&&+t[2]%10==5})(e))return;const i=new Set;for(const o of function(e){var t;if(!Game.rooms[e])return[];const r=new Map;for(const o of Game.rooms[e].find(FIND_STRUCTURES,{filter:{structureType:STRUCTURE_PORTAL}})){if(!(o.destination instanceof RoomPosition))continue;const n=null!==(t=r.get(o.destination.roomName))&&void 0!==t?t:{room1:e,room2:o.destination.roomName,portalMap:new Ui};r.set(o.destination.roomName,n),n.portalMap.set(o.pos,o.destination),o.ticksToDecay?n.expires=Game.time+o.ticksToDecay:delete n.expires}return[...r.values()]}(e))(null!==(t=Pi.get(o.room1))&&void 0!==t?t:new Map).set(o.room2,o),(null!==(r=Pi.get(o.room2))&&void 0!==r?r:new Map).set(o.room1,o),i.add(o.room2);const a=Pi.get(e);for(const t of null!==(o=null==a?void 0:a.keys())&&void 0!==o?o:[])i.has(t)||(null===(n=Pi.get(e))||void 0===n||n.delete(t),null===(s=Pi.get(t))||void 0===s||s.delete(e))}function xi(e){var t;let r="";return r+=ei(e.room1),r+=ei(e.room2),r+=Ni.encode(null!==(t=e.expires)&&void 0!==t?t:0),r+=Hs([...e.portalMap.entries()].flat()),r}function $i(e){const t=ti(e.slice(0,3)),r=ti(e.slice(3,6)),o=Ni.decode(e.slice(6,8)),n=new Ui,s=Ws(e.slice(8));for(let e=0;e<s.length;e+=2)n.set(s[e],s[e+1]);return{room1:t,room2:r,expires:0!==o?o:void 0,portalMap:n}}function Gi(e){var t;const r=new Set(Object.values(null!==(t=Game.map.describeExits(e))&&void 0!==t?t:{})),o=Pi.get(e);if(!o)return[...r];for(const e of o.values())r.add(e.room2);return[...r]}const Li=new Es.Codec({array:!1,depth:15}),Di=(e,t)=>{var r;if(!e||!e.length)throw Error("Empty id");let o=e;o.length%3!=0&&(o=o.padStart(3*Math.ceil(o.length/3),"0"));let n="";for(let e=0;e<o.length;e+=3)n+=Li.encode(parseInt(o.slice(e,e+3),16));return null!==(r=n+t)&&void 0!==r?r:""},Fi=(e,t)=>Di(e.id,t);var Bi=Object.freeze({__proto__:null,creepKey:Fi,objectIdKey:Di,roomKey:(e,t)=>ei(e)+(null!=t?t:"")});const Hi=(e,t)=>r=>{var o;if(t&&!t.includes(r))return!1;let n=null===(o=e.roomCallback)||void 0===o?void 0:o.call(e,r);return!1===n?n:((e,t,r)=>{var o,n,s,i,a,c,l;if(r.avoidCreeps&&(null===(o=Game.rooms[t])||void 0===o||o.find(FIND_CREEPS).forEach(t=>e.set(t.pos.x,t.pos.y,255)),null===(n=Game.rooms[t])||void 0===n||n.find(FIND_POWER_CREEPS).forEach(t=>e.set(t.pos.x,t.pos.y,255))),r.avoidSourceKeepers&&function(e,t){var r;const o=null!==(r=Os.with(ii).get(_i(e)))&&void 0!==r?r:[];for(const e of o)yi(e,5,!0).forEach(e=>t.set(e.x,e.y,255))}(t,e),(r.avoidObstacleStructures||r.roadCost)&&(r.avoidObstacleStructures&&(null===(s=Game.rooms[t])||void 0===s||s.find(FIND_MY_CONSTRUCTION_SITES).forEach(t=>{OBSTACLE_OBJECT_TYPES.includes(t.structureType)&&e.set(t.pos.x,t.pos.y,255)})),null===(i=Game.rooms[t])||void 0===i||i.find(FIND_STRUCTURES).forEach(t=>{r.avoidObstacleStructures&&(OBSTACLE_OBJECT_TYPES.includes(t.structureType)||t.structureType===STRUCTURE_RAMPART&&!t.my&&!t.isPublic)&&e.set(t.pos.x,t.pos.y,255),r.roadCost&&t instanceof StructureRoad&&0===e.get(t.pos.x,t.pos.y)&&e.set(t.pos.x,t.pos.y,r.roadCost)})),r.avoidTargets){const o=Game.map.getRoomTerrain(t);for(const n of r.avoidTargets(t))for(const t of yi(n.pos,n.range,!0))if(o.get(t.x,t.y)!==TERRAIN_MASK_WALL){const o=254-t.getRangeTo(n.pos)*(null!==(a=r.avoidTargetGradient)&&void 0!==a?a:0);e.set(t.x,t.y,Math.max(e.get(t.x,t.y),o))}}return r.ignorePortals||[...null!==(l=null===(c=Pi.get(t))||void 0===c?void 0:c.values())&&void 0!==l?l:[]].flatMap(e=>t===e.room1?[...e.portalMap.keys()]:[...e.portalMap.reversed.keys()]).forEach(t=>e.set(t.x,t.y,255)),e})(n instanceof PathFinder.CostMatrix?n.clone():new PathFinder.CostMatrix,r,e)};function Wi(e,t){const r=Game.map.getRoomTerrain(e);let o=!1;for(let e=0;25>e;e++){const{x:n,y:s}=Yi(t,e);if(r.get(n,s)!==TERRAIN_MASK_WALL){o=!0;break}}let n=!1;for(let e=25;49>e;e++){const{x:o,y:s}=Yi(t,e);if(r.get(o,s)!==TERRAIN_MASK_WALL){n=!0;break}}return[o,n]}function Yi(e,t){return e===FIND_EXIT_TOP?{x:t,y:0}:e===FIND_EXIT_BOTTOM?{x:t,y:49}:e===FIND_EXIT_LEFT?{x:0,y:t}:{x:49,y:t}}class Ki{constructor(){this.queue=[]}put(e,t){let r=this.queue.findIndex(([e])=>e>t);-1===r&&(r=this.queue.length),this.queue.splice(r,0,[t,e])}take(){var e;return null===(e=this.queue.shift())||void 0===e?void 0:e[1]}*[Symbol.iterator](){for(const[e,t]of this.queue)yield t}}const ji=Ms((e,t)=>e+t,(e,t)=>{const{wx:r,wy:o}=js(e),{wx:n,wy:s}=js(t);return Math.abs(r-n)+Math.abs(o-s)}),Vi=Ms(e=>e,e=>{let t=1/0;for(const r of Pi.keys())t=Math.min(t,ji(e,r));return t});function qi(e,t){return Math.min(ji(e,t),Vi(e)+Vi(t))}function zi(e,t,r){var o,n,s,i,a,c,l,u;let m=Object.assign(Object.assign({},fs.DEFAULT_MOVE_OPTS),r);(null==r?void 0:r.creepMovementInfo)&&(m=Object.assign(Object.assign({},m),function(e){const t={roadCost:fs.DEFAULT_MOVE_OPTS.roadCost||1,plainCost:fs.DEFAULT_MOVE_OPTS.plainCost||2,swampCost:fs.DEFAULT_MOVE_OPTS.swampCost||10};let r=e.usedCapacity,o=0,n=0,s=0;for(let t=e.body.length-1;t>=0;t--){const i=e.body[t];if(i.type!==MOVE&&i.type!==CARRY)s++;else{if(0>=i.hits)continue;if(i.type===MOVE){let e=1;i.boost&&(e=BOOSTS[MOVE][i.boost].fatigue),o+=1*e}else if(r>0&&i.type===CARRY){let e=1;i.boost&&(e=BOOSTS[CARRY][i.boost].capacity),r-=CARRY_CAPACITY*e,n++}}}if(o>0){const e=Math.max((n+s)/(2*o),.1),r=Math.ceil(e),i=Math.ceil(2*e),a=Math.ceil(10*e),c=(...e)=>[...e].reduce((e,t)=>{return r=e,(o=t)?c(o,r%o):r;var r,o}),l=c(r,i,a);t.roadCost=r/l,t.plainCost=i/l,t.swampCost=a/l}return t}(r.creepMovementInfo)));const d=t.reduce((e,{pos:t})=>e.includes(t.roomName)?e:[t.roomName,...e],[]);let p=function(e,t,r){const o=Object.assign(Object.assign({},fs.DEFAULT_MOVE_OPTS),r),n=Us((e,t)=>e+t,(e,t)=>{var r;const n=null===(r=o.routeCallback)||void 0===r?void 0:r.call(o,e,t);return void 0!==n?n:Ci(e)?o.highwayRoomCost:vi(e)?o.sourceKeeperRoomCost:o.defaultRoomCost}),s=function(e,t,r,o){var n,s;if(t.includes(e))return[];const i=null!==(n=null==r?void 0:r.routeCallback)&&void 0!==n?n:()=>1,a=new Ki;a.put(e,0);const c=new Map,l=new Map;c.set(e,e),l.set(e,0);let u=a.take();for(;u&&!t.includes(u);){for(const e of Gi(u)){const r=l.get(u)+i(u,e);if(r!==1/0&&(!l.has(e)||r<l.get(e))){l.set(e,r);const o=r+Math.min(...t.map(t=>qi(e,t)));a.put(e,o),c.set(e,u)}}u=a.take()}if(u&&t.includes(u)){const t=[];let r=[{room:u}];for(;u!==e;){const e=c.get(u),n=null===(s=Pi.get(e))||void 0===s?void 0:s.get(u);if(n&&!o)t.unshift(r),r=[{room:e,portalSet:n}];else{const t=Game.map.findExit(e,u);r.unshift({room:e,exit:t===ERR_NO_PATH?void 0:t})}u=e}return t.unshift(r),t}return ERR_NO_PATH}(e,t,{routeCallback:n},o.avoidPortals);if(s!==ERR_NO_PATH)return s.map(e=>{var t;const r=function(e,t,r){var o;let n=new Set(e.map(({room:e})=>e));const s=r.maxRooms;for(let i=0;i<e.length-1&&n.size<s&&e[i].exit;i++){if(e[i].exit!==e[i+1].exit){const r=Game.map.describeExits(e[i].room)[e[i+1].exit];r&&Game.map.findExit(r,e[i+1].room)>0&&t(r,e[i].room)!==1/0&&n.add(r)}if(!(e[i].exit!==e[i+1].exit&&e[i+1].exit||(null===(o=e[i+2])||void 0===o?void 0:o.exit)&&e[i].exit!==e[i+2].exit)){if(n.size>=r.maxRooms-1)continue;const o=Wi(e[i].room,e[i].exit);if(o.every(e=>e))continue;let s;if(o[0]||e[i].exit!==FIND_EXIT_TOP&&e[i].exit!==FIND_EXIT_BOTTOM?o[1]||e[i].exit!==FIND_EXIT_TOP&&e[i].exit!==FIND_EXIT_BOTTOM?o[0]||e[i].exit!==FIND_EXIT_LEFT&&e[i].exit!==FIND_EXIT_RIGHT?o[1]||e[i].exit!==FIND_EXIT_LEFT&&e[i].exit!==FIND_EXIT_RIGHT||(s=FIND_EXIT_BOTTOM):s=FIND_EXIT_TOP:s=FIND_EXIT_RIGHT:s=FIND_EXIT_LEFT,!s)throw Error("Invalid exit tile state: "+e[i].exit+JSON.stringify(o));const a=Game.map.describeExits(e[i].room)[s],c=Game.map.describeExits(e[i+1].room)[s];a&&c&&Game.map.findExit(a,c)>0&&t(a,e[i].room)!==1/0&&t(c,e[i+1].room)!==1/0&&(n.add(a),n.add(c))}}const i=[...n];for(;n.size<s;){const e=i.shift();if(!e)break;const r=Game.map.describeExits(e);if(r)for(const o of Object.values(r))n.has(o)||t(o,e)!==1/0&&(n.add(o),i.push(o))}return[...n]}(e,n,o);return{rooms:r,portalSet:null===(t=e[e.length-1])||void 0===t?void 0:t.portalSet}})}(e.roomName,d,m);if((null==p?void 0:p.length)&&1!==p.length){let r=e;const o=[];for(const e of p)if(e.portalSet){const t=e.rooms.includes(e.portalSet.room1)?e.portalSet.room1:e.portalSet.room2,n=(t===e.portalSet.room1?[...e.portalSet.portalMap.keys()]:[...e.portalSet.portalMap.values()]).map(e=>({pos:new RoomPosition(e.x,e.y,t),range:1})),s=PathFinder.search(r,n,Object.assign(Object.assign({},m),{maxOps:Math.min(null!==(l=m.maxOps)&&void 0!==l?l:1e5,(null!==(u=m.maxOpsPerRoom)&&void 0!==u?u:2e3)*e.rooms.length),roomCallback:Hi(m,e.rooms)}));if(!s.path.length||s.incomplete)return;const i=n.find(e=>e.pos.isNearTo(s.path[s.path.length-1])).pos;if(o.push(...s.path,i),e.portalSet.room1===t){const t=e.portalSet.portalMap.get(i);if(!t)throw Error(`Portal ${i} not found in portalSet ${JSON.stringify(e.portalSet)}`);r=new RoomPosition(t.x,t.y,e.portalSet.room2)}else{const t=e.portalSet.portalMap.reversed.get(i);if(!t)throw Error(`Portal ${i} not found in portalSet ${JSON.stringify(e.portalSet)}`);r=new RoomPosition(t.x,t.y,e.portalSet.room1)}}else{const n=PathFinder.search(r,t,Object.assign(Object.assign({},m),{maxOps:Math.min(null!==(a=m.maxOps)&&void 0!==a?a:1e5,(null!==(c=m.maxOpsPerRoom)&&void 0!==c?c:2e3)*e.rooms.length),roomCallback:Hi(m,e.rooms)}));if(!n.path.length||n.incomplete)return;o.push(...n.path)}return o}{const r=null===(o=null==p?void 0:p[0])||void 0===o?void 0:o.rooms,a=PathFinder.search(e,t,Object.assign(Object.assign({},m),{maxOps:Math.min(null!==(n=m.maxOps)&&void 0!==n?n:1e5,(null!==(s=m.maxOpsPerRoom)&&void 0!==s?s:2e3)*(null!==(i=null==r?void 0:r.length)&&void 0!==i?i:1)),roomCallback:Hi(m,r)}));if(!a.path.length||a.incomplete)return;return a.path}}let Xi=new Map,Qi=0;function Zi(e){var t;return Game.time!==Qi&&(Qi=Game.time,Xi=new Map),Xi.set(e,null!==(t=Xi.get(e))&&void 0!==t?t:{creep:new Map,priority:new Map,targets:new Map,pullers:new Set,pullees:new Set,prefersToStay:new Set,blockedSquares:new Set}),Xi.get(e)}function Ji(e,t=!1){var r,o,n,s;"fatigue"in e.creep&&e.creep.fatigue&&!t&&(e.targets=[e.creep.pos]),null!==(r=e.targetCount)&&void 0!==r||(e.targetCount=e.targets.length);const i=Zi(e.creep.pos.roomName);!function(e){var t,r,o,n;if(!e)return;null!==(t=e.targetCount)&&void 0!==t||(e.targetCount=e.targets.length);const s=Zi(e.creep.pos.roomName);s.creep.delete(e.creep.id),null===(o=null===(r=s.priority.get(e.priority))||void 0===r?void 0:r.get(e.targets.length))||void 0===o||o.delete(e.creep.id);for(const t of e.targets){const r=Ls(t);null===(n=s.targets.get(r))||void 0===n||n.delete(e.creep.id)}}(i.creep.get(e.creep.id)),i.creep.set(e.creep.id,e);const a=null!==(o=i.priority.get(e.priority))&&void 0!==o?o:new Map;i.priority.set(e.priority,a);const c=null!==(n=a.get(e.targets.length))&&void 0!==n?n:new Map;a.set(e.targets.length,c),c.set(e.creep.id,e);for(const t of e.targets){const r=Ls(t),o=null!==(s=i.targets.get(r))&&void 0!==s?s:new Map;i.targets.set(r,o),o.set(e.creep.id,e)}e.targets.length&&e.targets[0].isEqualTo(e.creep.pos)&&i.prefersToStay.add(Ls(e.creep.pos))}function ea(e,t,r){var o,n,s;const i=Zi(e.creep.pos.roomName),a=null!==(o=i.priority.get(e.priority))&&void 0!==o?o:new Map;null===(n=a.get(t))||void 0===n||n.delete(e.creep.id),i.priority.set(e.priority,a);const c=null!==(s=a.get(r))&&void 0!==s?s:new Map;a.set(r,c),c.set(e.creep.id,e)}const ta=e=>{const t=Game.cpu.getUsed();return e(),Math.max(0,Game.cpu.getUsed()-t)},ra="_crr";function oa(){const e=Os.with(Cs).get(ra);return!(!e||Game.time-2>e)}let na=[];function sa(e,t){var r,o,n,s,i,a,c,l;const u=Game.cpu.getUsed();let m=0;const d=Zi(e),p=d.blockedSquares;if(null==t?void 0:t.visualize)for(const{creep:e,targets:t,priority:r}of d.creep.values())t.forEach(t=>{t.isEqualTo(e.pos)?Game.rooms[e.pos.roomName].visual.circle(e.pos,{radius:.5,stroke:"orange",fill:"transparent"}):Game.rooms[e.pos.roomName].visual.line(e.pos,t,{color:"orange"})});for(const r of Game.rooms[e].find(FIND_MY_CREEPS).concat(Game.rooms[e].find(FIND_MY_POWER_CREEPS)))d.creep.has(r.id)||d.pullees.has(r.id)||d.pullers.has(r.id)||(Ji({creep:r,priority:0,targets:[r.pos,...Ei(r.pos,!0)]}),(null==t?void 0:t.visualize)&&Game.rooms[r.pos.roomName].visual.circle(r.pos,{radius:1,stroke:"red",fill:"transparent "}));for(const e of d.pullers){const t=Game.getObjectById(e);if(!t)continue;const s=Ls(t.pos);p.add(s);for(const t of null!==(o=null===(r=d.targets.get(s))||void 0===r?void 0:r.values())&&void 0!==o?o:[]){if(t.creep.id===e)continue;null!==(n=t.targetCount)&&void 0!==n||(t.targetCount=t.targets.length);const r=t.targetCount;t.targetCount-=1,ea(t,r,t.targetCount)}}const g=[...d.priority.entries()].sort((e,t)=>t[0]-e[0]);for(const[e,r]of g)for(;r.size;){const e=Math.min(...r.keys()),o=r.get(e);if(!o)break;o.size||r.delete(e);const n=[...o.values()];for(;n.length;){const e=n.shift();if(!e)break;if(e.resolved){o.delete(e.creep.id);continue}let r;(null==t?void 0:t.visualize)&&e.targets.forEach(t=>{t.isEqualTo(e.creep.pos)?Game.rooms[e.creep.pos.roomName].visual.circle(e.creep.pos,{radius:.5,stroke:"yellow",strokeWidth:.2,fill:"transparent",opacity:.2}):Game.rooms[e.creep.pos.roomName].visual.line(e.creep.pos,t,{color:"yellow",width:.2})});for(const t of e.targets){const o=Ls(t);if(!p.has(o)||e.creep.pos.isEqualTo(t)&&d.pullers.has(e.creep.id)){if(e.creep.pos.isEqualTo(t)||!d.prefersToStay.has(o)){r=t;break}null!=r||(r=t)}}if(o.delete(e.creep.id),!r){(null==t?void 0:t.visualize)&&Game.rooms[e.creep.pos.roomName].visual.line(e.creep.pos.x-.5,e.creep.pos.y-.5,e.creep.pos.x+.5,e.creep.pos.y+.5,{color:"red"}).line(e.creep.pos.x-.5,e.creep.pos.y+.5,e.creep.pos.x+.5,e.creep.pos.y-.5,{color:"red"});continue}m+=ta(()=>e.creep.move(e.creep.pos.getDirectionTo(r))),e.resolved=!0,(null==t?void 0:t.visualize)&&Game.rooms[e.creep.pos.roomName].visual.line(e.creep.pos,r,{color:"green",width:.5});const u=Ls(r);p.add(u);for(const e of null!==(i=null===(s=d.targets.get(u))||void 0===s?void 0:s.values())&&void 0!==i?i:[]){if(e.resolved)continue;null!==(a=e.targetCount)&&void 0!==a||(e.targetCount=e.targets.length);const t=e.targetCount;e.targetCount-=1,ea(e,t,e.targetCount)}if(!r.isEqualTo(e.creep.pos)&&!d.pullers.has(e.creep.id)){const o=Ls(e.creep.pos),s=[...null!==(l=null===(c=d.targets.get(o))||void 0===c?void 0:c.values())&&void 0!==l?l:[]].filter(t=>t!==e&&2>t.targets.length),i=s.find(e=>!e.resolved&&(null==r?void 0:r.isEqualTo(e.creep.pos))&&!d.pullers.has(e.creep.id));i&&((null==t?void 0:t.visualize)&&Game.rooms[i.creep.pos.roomName].visual.circle(i.creep.pos,{radius:.2,fill:"green"}),s.filter(e=>e.resolved).forEach(e=>{(null==t?void 0:t.visualize)&&Game.rooms[e.creep.pos.roomName].visual.circle(e.creep.pos,{radius:.2,fill:"red"})}),p.delete(o),n.unshift(i))}}}const f=Math.max(0,Game.cpu.getUsed()-u);na.push(m/f),na.length>1500&&(na=na.slice(-1500))}function ia(e,t,r=1){return e.pos?oa()?(Ji({creep:e,targets:t,priority:r}),OK):t[0].isEqualTo(e.pos)?OK:e.move(e.pos.getDirectionTo(t[0])):ERR_INVALID_ARGS}const aa=e=>"_poi_"+e,ca="_cpi";function la(e,t,r,o){var n;const s=Object.assign(Object.assign({},fs.DEFAULT_MOVE_OPTS),o),i=null!==(n=s.cache)&&void 0!==n?n:Os,a=pi(r,null==o?void 0:o.keepTargetInRoom,null==o?void 0:o.flee);if(null==o?void 0:o.visualizePathStyle){const e=Object.assign(Object.assign({},fs.DEFAULT_VISUALIZE_OPTS),o.visualizePathStyle);for(const t of a)new RoomVisual(t.pos.roomName).rect(t.pos.x-t.range-.5,t.pos.y-t.range-.5,2*t.range+1,2*t.range+1,e)}const c=i.with(ii).get(aa(e));if(c)return c;const l=zi(t,a,Object.assign(Object.assign({},s),{flee:!1}));if(l){const t=s.reusePath?Game.time+s.reusePath+1:void 0;i.with(ii).set(aa(e),l,t)}return l}function ua(e,t){var r;return(null!==(r=null==t?void 0:t.cache)&&void 0!==r?r:Os).with(ii).get(aa(e))}function ma(e,t){var r;(null!==(r=null==t?void 0:t.cache)&&void 0!==r?r:Os).delete(aa(e))}function da(e,t,r){var o,n,s,i;const a=(null!==(o=null==r?void 0:r.cache)&&void 0!==o?o:Os).with(ii).get(aa(t));if(!e.pos)return ERR_INVALID_ARGS;if(!a)return ERR_NO_PATH;if((null==r?void 0:r.reverse)&&e.pos.isEqualTo(a[0])||!(null==r?void 0:r.reverse)&&e.pos.isEqualTo(a[a.length-1]))return OK;let c=Rs.get(Fi(e,ca));if(void 0!==c){let t=Math.max(0,Math.min(a.length-1,(null==r?void 0:r.reverse)?c-1:c+1));(null===(n=a[t])||void 0===n?void 0:n.isEqualTo(e.pos))?c=t:(null===(s=a[c])||void 0===s?void 0:s.isEqualTo(e.pos))||(c=void 0)}if(void 0===c){const t=a.findIndex(t=>t.isEqualTo(e.pos));-1!==t&&(c=t)}if(void 0!==c||(null==r?void 0:r.reverse)||Xs(a[0],e.pos)>1||(c=-1),void 0===c&&(null==r?void 0:r.reverse)&&1>=Xs(a[a.length-1],e.pos)&&(c=a.length),void 0===c)return ERR_NOT_FOUND;Rs.set(Fi(e,ca),c);let l=Math.max(0,Math.min(a.length-1,(null==r?void 0:r.reverse)?c-1:c+1));if(null==r?void 0:r.visualizePathStyle){const t=Object.assign(Object.assign({},fs.DEFAULT_VISUALIZE_OPTS),r.visualizePathStyle),o=Si(a,c,null==r?void 0:r.reverse);null===(i=e.room)||void 0===i||i.visual.poly(o.filter(t=>{var r;return t.roomName===(null===(r=e.room)||void 0===r?void 0:r.name)}),t)}return ia(e,[a[l]],null==r?void 0:r.priority)}const pa=(e,t)=>0!==e.length&&0!==t.length&&e.some(e=>t.some(t=>e.inRangeTo(t.pos,t.range))),ga="_csp",fa="_cst",ha=(e,t)=>{if(!e.pos)return!1;if("fatigue"in e&&e.fatigue>0)return!1;const r=Rs.get(Fi(e,ga)),o=Rs.get(Fi(e,fa));return Rs.set(Fi(e,ga),e.pos),r&&o&&e.pos.isEqualTo(r)?o+t<Game.time:(Rs.set(Fi(e,fa),Game.time),!1)},ya={key:"js",serialize(e){if(void 0!==e)return JSON.stringify(e)},deserialize(e){if(void 0!==e)return JSON.parse(e)}},Ra="_cp",Ea="_ct",Ta="_co",Ca=["avoidCreeps","avoidObstacleStructures","flee","plainCost","swampCost","roadCost"];function va(e,t=ui.HeapCache){ma(Fi(e,Ra),{cache:t}),t.delete(Fi(e,Ea)),t.delete(Fi(e,Ta))}const Sa=(e,t,r,o={avoidCreeps:!0})=>{var n,s,i,a;if(!e.pos)return ERR_INVALID_ARGS;let c=Object.assign(Object.assign({},fs.DEFAULT_MOVE_OPTS),r);const l=null!==(n=null==r?void 0:r.cache)&&void 0!==n?n:ui.HeapCache;let u=pi(t,c.keepTargetInRoom,c.flee),m=!1,d=l.with(ni).get(Fi(e,Ea));for(const{pos:t,range:o}of u){if(!m&&t.inRangeTo(e.pos,o)&&e.pos.roomName===t.roomName){if(!(null==r?void 0:r.flee)){va(e,l);const t=Hi(c)(e.pos.roomName);return ia(e,[e.pos,...Ei(e.pos,!0).filter(e=>u.some(t=>t.pos.inRangeTo(e,t.range))&&(!t||255!==t.get(e.x,e.y)))],c.priority),OK}m=!0}d&&!d.some(e=>e&&t.isEqualTo(e.pos)&&o===e.range)&&(va(e,l),d=void 0)}const p=l.with(ya).get(Fi(e,Ta));p&&!Ca.some(e=>c[e]!==p[e])||va(e,l);const g=[null==r?void 0:r.roadCost,null==r?void 0:r.plainCost,null==r?void 0:r.swampCost].some(e=>void 0!==e);"body"in e&&!g&&(c=Object.assign(Object.assign({},c),{creepMovementInfo:{usedCapacity:e.store.getUsedCapacity(),body:e.body}}));const f=c.reusePath?Game.time+c.reusePath+1:void 0;l.with(ni).set(Fi(e,Ea),u,f),l.with(ya).set(Fi(e,Ta),Ca.reduce((e,t)=>(e[t]=c[t],e),{}),f);const h=ua(Fi(e,Ra),{cache:l}),y=Rs.get(Fi(e,"_cpi")),R=h&&Si(h,null!=y?y:0),E=null!==(i=null===(s=c.avoidTargets)||void 0===s?void 0:s.call(c,e.pos.roomName))&&void 0!==i?i:[];if(c.repathIfStuck&&h&&ha(e,c.repathIfStuck))ma(Fi(e,Ra),{cache:l}),c=Object.assign(Object.assign({},c),o);else if((null==R?void 0:R.length)&&pa(R,E)){let t=0;R.forEach((e,r)=>{E.some(t=>t.pos.inRangeTo(e,t.range))&&(t=r)});const r=R.slice(t),o=zi(e.pos,r.map(e=>({pos:e,range:0})),Object.assign(Object.assign({},c),{cache:l,flee:!1}));if(o){let t;for(let e=0;e<r.length;e++)if(o[o.length-1].inRangeTo(r[e],1))t=e;else if(void 0!==t)break;void 0===t?ma(Fi(e,Ra),{cache:l}):l.with(ii).set(aa(Fi(e,Ra)),o.concat(r.slice(t)),f)}else ma(Fi(e,Ra),{cache:l})}const T=la(Fi(e,Ra),e.pos,t,Object.assign(Object.assign({},c),{cache:l}));if(!T)return ERR_NO_PATH;if(T&&(null===(a=T[T.length-2])||void 0===a?void 0:a.isEqualTo(e.pos))){let t=Hi(c)(e.pos.roomName);const o=t instanceof PathFinder.CostMatrix?e=>254>t.get(e.x,e.y):()=>!0,n=(null==r?void 0:r.flee)?e=>u.every(t=>t.pos.getRangeTo(e)>=t.range):e=>u.some(t=>t.pos.inRangeTo(e,t.range)),s=Ei(e.pos,!0).filter(e=>n(e)&&o(e));if(s.length)return ia(e,s,c.priority),OK}let C=da(e,Fi(e,Ra),Object.assign(Object.assign({},c),{reverse:!1,cache:l}));return C===ERR_NOT_FOUND&&(va(e,l),la(Fi(e,Ra),e.pos,u,Object.assign(Object.assign({},c),{cache:l})),C=da(e,Fi(e,Ra),Object.assign(Object.assign({},c),{reverse:!1,cache:l}))),C},_a="_rsi";return lo.CachingStrategies=ui,lo.CoordListSerializer=ci,lo.CoordSerializer=ai,lo.Keys=Bi,lo.MoveTargetListSerializer=ni,lo.MoveTargetSerializer=oi,lo.NumberSerializer=Cs,lo.PositionListSerializer=ii,lo.PositionSerializer=si,lo.adjacentWalkablePositions=Ei,lo.blockSquare=function(e){Zi(e.roomName).blockedSquares.add(Ls(e))},lo.cachePath=la,lo.cachedPathKey=aa,lo.calculateAdjacencyMatrix=fi,lo.calculateAdjacentPositions=hi,lo.calculateNearbyPositions=yi,lo.calculatePositionsAtRange=Ri,lo.cleanAllCaches=li,lo.clearCachedPath=va,lo.compressPath=e=>{const t=[],r=e[0];if(!r)return"";let o=r;for(const r of e.slice(1)){if(1!==Xs(o,r))throw Error("Cannot compress path unless each RoomPosition is adjacent to the previous one");t.push(o.getDirectionTo(r)),o=r}return Ls(r)+xs.encode(t)},lo.config=fs,lo.decompressPath=e=>{let t=Ds(e.slice(0,2));const r=[t],o=xs.decode(e.slice(2));for(const e of o)t=Qs(t,e),r.push(t);return r},lo.fastRoomPosition=ws,lo.fixEdgePosition=gi,lo.follow=function(e,t){e.move(t),t.pull(e),function(e,t){const r=Zi(e.pos.roomName);r.pullers.add(e.id),r.pullees.add(t.id)}(t,e)},lo.followPath=da,lo.fromGlobalPosition=zs,lo.generatePath=zi,lo.getCachedPath=ua,lo.getMoveIntents=Zi,lo.getRangeTo=Xs,lo.globalPosition=qs,lo.isExit=di,lo.isPositionWalkable=Ti,lo.move=ia,lo.moveByPath=function(e,t,r){var o,n,s,i;const a=null!==(o=null==r?void 0:r.repathIfStuck)&&void 0!==o?o:fs.DEFAULT_MOVE_OPTS.repathIfStuck,c=null!==(i=null===(s=null!==(n=null==r?void 0:r.avoidTargets)&&void 0!==n?n:fs.DEFAULT_MOVE_OPTS.avoidTargets)||void 0===s?void 0:s(e.pos.roomName))&&void 0!==i?i:[];let l=Rs.get(Fi(e,_a));const u=ua(t,r);if((a||c.length)&&void 0!==l){let t=null==u?void 0:u.findIndex(t=>t.isEqualTo(e.pos));-1===t&&(t=void 0),void 0===t||((null==r?void 0:r.reverse)?t>l:l>t)||(Rs.delete(Fi(e,_a)),l=void 0)}let m=ERR_NOT_FOUND;if(void 0===l&&(m=da(e,t,r)),m!==ERR_NOT_FOUND){const t=Rs.get(Fi(e,"_cpi"));if(!(a&&ha(e,a)||u&&pa(Si(u,null!=t?t:0,null==r?void 0:r.reverse),c)))return m;void 0!==t&&(l=(null==r?void 0:r.reverse)?t-1:t+2,Rs.set(Fi(e,_a),l))}let d=ua(t,r);return d?(void 0!==l&&(d=Si(d,l,null==r?void 0:r.reverse)),0===d.length?ERR_NO_PATH:Sa(e,d,r)):ERR_NO_PATH},lo.moveTo=Sa,lo.normalizeTargets=pi,lo.offsetRoomPosition=Ns,lo.packCoord=Fs,lo.packCoordList=Hs,lo.packPos=Ls,lo.packPosList=Ys,lo.packRoomName=ei,lo.packRoomNames=Zs,lo.posAtDirection=Qs,lo.preTick=function(){li(),function(){for(const e in Game.rooms)bi(e),Ii(e);!function(){var e,t;const r=new Set;Memory[fs.MEMORY_PORTAL_PATH]=[];for(const o of Pi.values())for(const n of o.values())r.has(n)||(r.add(n),n.expires&&n.expires<Game.time?(null===(e=Pi.get(n.room1))||void 0===e||e.delete(n.room2),null===(t=Pi.get(n.room2))||void 0===t||t.delete(n.room1)):Memory[fs.MEMORY_PORTAL_PATH].push(xi(n)))}()}()},lo.reconcileTraffic=function(e){for(const t of[...Xi.keys()])Game.rooms[t]&&sa(t,e);Os.with(Cs).set(ra,Game.time)},lo.reconciledRecently=oa,lo.resetCachedPath=ma,lo.roomNameFromCoords=Vs,lo.roomNameToCoords=js,lo.sameRoomPosition=ks,lo.unpackCoord=Bs,lo.unpackCoordList=Ws,lo.unpackPos=Ds,lo.unpackPosList=Ks,lo.unpackRoomName=ti,lo.unpackRoomNames=Js,lo}();const mo=me("TargetAssignmentManager"),po=new Map;function go(e){const t=po.get(e.name);if(t&&10>Game.time-t.tick)return t;const r=function(e){const t={tick:Game.time,sources:new Map,harvesterToSource:new Map,buildTargets:[],builderToTarget:new Map,upgraders:new Set},r=e.find(FIND_MY_CREEPS),o=[],n=[];for(const e of r){const r=e.memory.role;"harvester"===r||"staticMiner"===r?o.push(e):"builder"===r?n.push(e):"upgrader"===r&&t.upgraders.add(e.id)}return function(e,t,r){const o=it(e);if(0===o.length)return;for(const e of o){const t=2;r.sources.set(e.id,{sourceId:e.id,assignedHarvesters:[],maxHarvesters:t})}const n=[];for(const e of t){const t=e.memory.targetId;n.push({creep:e,currentSource:null!=t?t:null})}for(const{creep:e,currentSource:t}of n){if(t){const o=r.sources.get(t);if(o&&o.assignedHarvesters.length<o.maxHarvesters){o.assignedHarvesters.push(e.id),r.harvesterToSource.set(e.id,t);continue}}let o=null,n=1/0;for(const e of r.sources.values()){const t=e.assignedHarvesters.length;t<e.maxHarvesters&&n>t&&(o=e,n=t)}o&&(o.assignedHarvesters.push(e.id),r.harvesterToSource.set(e.id,o.sourceId))}}(e,o,t),function(e,t,r){const o=ct(e),n=function(e){var t;const r=Wt.getSwarmState(e.name);if(!r||!r.remoteAssignments||0===r.remoteAssignments.length)return[];const o=[];for(const e of r.remoteAssignments){const r=Game.rooms[e];if(!r)continue;if((null===(t=r.controller)||void 0===t?void 0:t.owner)&&!r.controller.my)continue;const n=ct(r);o.push(...n)}return o}(e),s=[...o,...n];if(0===s.length)return;const i=s.map(t=>({site:t,priority:fo(t,e.name)})).sort((e,t)=>t.priority-e.priority);for(const{site:e,priority:t}of i)r.buildTargets.push({targetId:e.id,assignedBuilders:[],priority:t});let a=0;for(const e of t){if(0===r.buildTargets.length)break;const t=r.buildTargets[a];t.assignedBuilders.push(e.id),r.builderToTarget.set(e.id,t.targetId),a=(a+1)%r.buildTargets.length}}(e,n,t),t}(e);return po.set(e.name,r),mo.debug("Calculated fresh assignments for "+e.name,{meta:{sources:r.sources.size,buildTargets:r.buildTargets.length,upgraders:r.upgraders.size}}),r}function fo(e,t){var r;if((null===(r=e.room)||void 0===r?void 0:r.name)!==t)switch(e.structureType){case STRUCTURE_CONTAINER:return 100;case STRUCTURE_ROAD:return 80;case STRUCTURE_RAMPART:return 40;case STRUCTURE_WALL:return 30;default:return 60}switch(e.structureType){case STRUCTURE_SPAWN:return 95;case STRUCTURE_EXTENSION:return 90;case STRUCTURE_TOWER:return 85;case STRUCTURE_STORAGE:return 75;case STRUCTURE_LINK:return 70;case STRUCTURE_CONTAINER:return 65;case STRUCTURE_ROAD:return 50;case STRUCTURE_RAMPART:return 40;case STRUCTURE_WALL:return 30;default:return 60}}const ho={minBucket:0,criticalEnergyThreshold:300,mediumEnergyThreshold:1e3,lowEnergyThreshold:3e3,surplusEnergyThreshold:1e4,minTransferAmount:500,maxRequestsPerRoom:3,requestTimeout:500,focusRoomMediumThreshold:5e3,focusRoomLowThreshold:15e3},yo=new class{constructor(e={}){this.config={...ho,...e}}processCluster(e){if(Game.cpu.bucket<this.config.minBucket)return;this.cleanupRequests(e);const t=this.getRoomStatuses(e).filter(e=>!e.hasTerminal);2>t.length||this.createTransferRequests(e,t)}cleanupRequests(e){e.resourceRequests=e.resourceRequests.filter(t=>{if(Game.time-t.createdAt>this.config.requestTimeout)return de.debug(`Resource request from ${t.fromRoom} to ${t.toRoom} expired`,{subsystem:"ResourceSharing"}),!1;if(t.delivered>=t.amount)return de.info(`Resource transfer completed: ${t.delivered} ${t.resourceType} from ${t.fromRoom} to ${t.toRoom}`,{subsystem:"ResourceSharing"}),!1;if(!e.memberRooms.includes(t.toRoom)||!e.memberRooms.includes(t.fromRoom))return!1;if(Game.rooms[t.toRoom]){const e=Wt.getSwarmState(t.toRoom);if(e&&0===e.metrics.energyNeed)return de.debug(`Resource request from ${t.fromRoom} to ${t.toRoom} no longer needed`,{subsystem:"ResourceSharing"}),!1}return!0})}getRoomStatuses(e){var t;const r=[];for(const o of e.memberRooms){const n=Game.rooms[o];if(!n||!(null===(t=n.controller)||void 0===t?void 0:t.my))continue;const s=Wt.getSwarmState(o);if(!s)continue;const i=e.focusRoom===o,{energyAvailable:a,energyCapacity:c}=this.calculateRoomEnergy(n),l=this.calculateEnergyNeed(n,a,s,i);let u=0;i?u=0:a>this.config.surplusEnergyThreshold&&(u=a-this.config.mediumEnergyThreshold);let m=0;3===l?m=this.config.criticalEnergyThreshold-a:2===l?m=this.config.mediumEnergyThreshold-a:1===l&&(m=this.config.lowEnergyThreshold-a),m=Math.max(m,i&&l>0?2*this.config.minTransferAmount:this.config.minTransferAmount),r.push({roomName:o,hasTerminal:void 0!==n.terminal&&n.terminal.my,energyAvailable:a,energyCapacity:c,energyNeed:l,canProvide:u,needsAmount:m}),s.metrics.energyAvailable=a,s.metrics.energyCapacity=c,s.metrics.energyNeed=l}return r}calculateRoomEnergy(e){let t=0,r=0;e.storage&&(t+=e.storage.store.getUsedCapacity(RESOURCE_ENERGY),r+=e.storage.store.getCapacity());const o=e.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_CONTAINER});for(const e of o)t+=e.store.getUsedCapacity(RESOURCE_ENERGY),r+=e.store.getCapacity();return{energyAvailable:t,energyCapacity:r}}calculateEnergyNeed(e,t,r,o=!1){return t<this.config.criticalEnergyThreshold?(e.find(FIND_MY_SPAWNS).length>0&&e.energyAvailable,3):o?t<this.config.focusRoomMediumThreshold?2:t<this.config.focusRoomLowThreshold?1:0:t<this.config.mediumEnergyThreshold?2:t<this.config.lowEnergyThreshold?1:0}createTransferRequests(e,t){const r=t.filter(e=>e.energyNeed>0).sort((e,t)=>t.energyNeed-e.energyNeed),o=t.filter(e=>e.canProvide>0).sort((e,t)=>t.canProvide-e.canProvide);if(0!==r.length&&0!==o.length)for(const t of r){if(e.resourceRequests.filter(e=>e.toRoom===t.roomName).length>=this.config.maxRequestsPerRoom)continue;let r=null,n=1/0;for(const s of o){if(s.roomName===t.roomName)continue;if(e.resourceRequests.some(e=>e.fromRoom===s.roomName&&e.toRoom===t.roomName))continue;const o=Game.map.getRoomLinearDistance(s.roomName,t.roomName);n>o&&s.canProvide>=this.config.minTransferAmount&&(n=o,r=s)}if(r&&3>=n){const o=Math.min(t.needsAmount,r.canProvide),s={toRoom:t.roomName,fromRoom:r.roomName,resourceType:RESOURCE_ENERGY,amount:o,priority:t.energyNeed,createdAt:Game.time,assignedCreeps:[],delivered:0};e.resourceRequests.push(s),de.info(`Created resource transfer: ${o} energy from ${r.roomName} to ${t.roomName} (priority ${s.priority}, distance ${n})`,{subsystem:"ResourceSharing"}),r.canProvide-=o}}}getRequestsForRoom(e,t){return e.resourceRequests.filter(e=>e.toRoom===t||e.fromRoom===t)}updateRequestProgress(e,t,r){if(t>=0&&t<e.resourceRequests.length){const o=e.resourceRequests[t];o.delivered+=r,de.debug(`Updated transfer progress: ${o.delivered}/${o.amount} from ${o.fromRoom} to ${o.toRoom}`,{subsystem:"ResourceSharing"})}}},Ro={1:{guards:1,rangers:1,healers:0,siegeUnits:0},2:{guards:2,rangers:2,healers:1,siegeUnits:0},3:{guards:3,rangers:3,healers:2,siegeUnits:1}};function Eo(e,t){let r=e.coreRoom,o=1/0;for(const n of e.memberRooms){const e=Game.map.getRoomLinearDistance(n,t);o>e&&(o=e,r=n)}return r}function To(e,t){const r=function(e){var t;const r=Math.min(3,Math.max(1,e.urgency)),o=null!==(t=Ro[r])&&void 0!==t?t:Ro[2];return{guards:Math.max(o.guards,e.guardsNeeded),rangers:Math.max(o.rangers,e.rangersNeeded),healers:Math.max(o.healers,e.healersNeeded),siegeUnits:o.siegeUnits}}(t),o=`defense_${t.roomName}_${Game.time}`,n=Eo(e,t.roomName),s={id:o,type:"defense",members:[],rallyRoom:n,targetRooms:[t.roomName],state:"gathering",createdAt:Game.time};return de.info(`Created defense squad ${o} for ${t.roomName}: ${r.guards}G/${r.rangers}R/${r.healers}H rally at ${n}`,{subsystem:"Squad"}),s}function Co(e){const t=Game.time-e.createdAt;if("gathering"===e.state&&t>300)return de.warn(`Squad ${e.id} timed out during formation (${t} ticks)`,{subsystem:"Squad"}),!0;if(0===e.members.length&&t>50)return de.info(`Squad ${e.id} has no members, dissolving`,{subsystem:"Squad"}),!0;if("attacking"===e.state){const r=e.targetRooms[0];if(r){const o=Game.rooms[r];if(o&&0===o.find(FIND_HOSTILE_CREEPS).length&&t>100)return de.info(`Squad ${e.id} mission complete, no more hostiles`,{subsystem:"Squad"}),!0}}return!1}function vo(e){const t=e.members.length;e.members=e.members.filter(e=>Game.creeps[e]),e.members.length<t&&de.debug(`Squad ${e.id} lost ${t-e.members.length} members`,{subsystem:"Squad"});const r=e.members.map(e=>Game.creeps[e]).filter(e=>!!e);if(0===r.length)return;const o=e.targetRooms[0];if(o)switch(e.state){case"gathering":r.every(t=>t.room.name===e.rallyRoom)&&(e.state="moving",de.info(`Squad ${e.id} gathered, moving to ${o}`,{subsystem:"Squad"}));break;case"moving":r.some(e=>e.room.name===o)&&(e.state="attacking",de.info(`Squad ${e.id} reached ${o}, engaging`,{subsystem:"Squad"}));break;case"attacking":Game.time-e.createdAt>50&&3>r.length&&(e.state="retreating",de.warn(`Squad ${e.id} retreating - heavy casualties`,{subsystem:"Squad"}));break;case"retreating":r.every(t=>t.room.name===e.rallyRoom)&&(e.state="dissolving",de.info(`Squad ${e.id} retreated to ${e.rallyRoom}, dissolving`,{subsystem:"Squad"}))}}RESOURCE_CATALYZED_GHODIUM_ALKALIDE,RESOURCE_CATALYZED_UTRIUM_ACID,RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE,RESOURCE_CATALYZED_GHODIUM_ALKALIDE,RESOURCE_CATALYZED_UTRIUM_ACID,RESOURCE_CATALYZED_KEANIUM_ALKALIDE,RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE,RESOURCE_CATALYZED_GHODIUM_ALKALIDE,RESOURCE_CATALYZED_UTRIUM_ACID,RESOURCE_CATALYZED_ZYNTHIUM_ACID,RESOURCE_CATALYZED_KEANIUM_ALKALIDE,RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE;const So={0:0,1:5e3,2:15e3,3:5e4};function _o(e,t){let r=So[t];const o=Wt.getClusters();for(const t in o)o[t].defenseRequests.some(t=>t.roomName===e&&t.urgency>=2)&&(r+=1e4);return r}function bo(e,t,r){let o,n=0;for(const s of e.memberRooms){if(s===t)continue;const e=Game.rooms[s];if(!e||!e.storage)continue;const i=Wt.getSwarmState(s);if(!i)continue;const a=e.storage.store.getUsedCapacity(RESOURCE_ENERGY)-_o(s,i.danger);a>r&&a>n&&(n=a,o=s)}if(!o)return de.warn(`No available energy source for emergency routing to ${t} (need ${r})`,{subsystem:"MilitaryPool"}),{success:!1};const s=Game.rooms[o],i=Game.rooms[t];return(null==s?void 0:s.terminal)&&(null==i?void 0:i.terminal)?s.terminal.send(RESOURCE_ENERGY,r,t)===OK?(de.info(`Emergency energy routed: ${r} from ${o} to ${t}`,{subsystem:"MilitaryPool"}),{success:!0,sourceRoom:o}):{success:!1}:(de.info(`Creating hauler transfer request: ${r} energy from ${o} to ${t}`,{subsystem:"MilitaryPool"}),e.resourceRequests.push({toRoom:t,fromRoom:o,resourceType:RESOURCE_ENERGY,amount:r,priority:5,createdAt:Game.time,assignedCreeps:[],delivered:0}),{success:!0,sourceRoom:o})}const Oo={harassment:{composition:{harassers:3,soldiers:0,rangers:1,healers:0,siegeUnits:0},targetPriority:{workers:100,military:50,spawns:20,towers:10,extensions:15,storage:10,defenses:5,labs:5},minEnergy:5e4,useBoosts:!1,retreatThreshold:.5,creepSize:"small",engagement:{engageTowers:!1,maxTowers:0,prioritizeDefenses:!1}},raid:{composition:{harassers:1,soldiers:2,rangers:3,healers:2,siegeUnits:0},targetPriority:{military:100,towers:80,spawns:90,workers:60,extensions:50,storage:40,labs:30,defenses:20},minEnergy:1e5,useBoosts:!1,retreatThreshold:.4,creepSize:"medium",engagement:{engageTowers:!0,maxTowers:2,prioritizeDefenses:!1}},siege:{composition:{harassers:0,soldiers:2,rangers:4,healers:3,siegeUnits:2},targetPriority:{towers:100,spawns:100,military:90,defenses:80,storage:70,labs:60,extensions:50,workers:40},minEnergy:2e5,useBoosts:!0,retreatThreshold:.3,creepSize:"large",engagement:{engageTowers:!0,maxTowers:6,prioritizeDefenses:!0}}};function Uo(e,t){var r,o,n,s;if(!t)return de.debug(`No intel for ${e}, defaulting to harassment`,{subsystem:"Doctrine"}),"harassment";const i=null!==(r=t.towerCount)&&void 0!==r?r:0,a=null!==(o=t.spawnCount)&&void 0!==o?o:0,c=null!==(n=t.rcl)&&void 0!==n?n:0,l=3*i+2*a+1.5*(null!==(s=t.militaryPresence)&&void 0!==s?s:0)+.5*c;return 20>l&&7>c?10>l&&5>c?(de.info(`Selected HARASSMENT doctrine for ${e} (threat: ${l})`,{subsystem:"Doctrine"}),"harassment"):(de.info(`Selected RAID doctrine for ${e} (threat: ${l})`,{subsystem:"Doctrine"}),"raid"):(de.info(`Selected SIEGE doctrine for ${e} (threat: ${l})`,{subsystem:"Doctrine"}),"siege")}function Mo(e,t){var r;const o=Oo[t];let n=0;for(const t of e.memberRooms){const e=Game.rooms[t];if(!e||!(null===(r=e.controller)||void 0===r?void 0:r.my))continue;const o=e.storage,s=e.terminal;o&&(n+=o.store.energy),s&&(n+=s.store.energy)}const s=n>=o.minEnergy;return s||de.debug(`Cannot launch ${t}: insufficient energy (${n}/${o.minEnergy})`,{subsystem:"Doctrine"}),s}const Ao={rclWeight:10,resourceWeight:5,strategicWeight:3,distancePenalty:2,weakDefenseBonus:20,strongDefensePenalty:15,warTargetBonus:50};function wo(e,t,r,o){var n,s;let i=0;i+=e.controllerLevel*o.rclWeight,6>e.controllerLevel?4>e.controllerLevel||(i+=2*o.resourceWeight):i+=5*o.resourceWeight,i+=e.sources*o.strategicWeight,i-=t*o.distancePenalty;const a=null!==(n=e.towerCount)&&void 0!==n?n:0,c=null!==(s=e.spawnCount)&&void 0!==s?s:0;return 0!==a||c>1?4>a&&(2>a||2>c)||(i-=o.strongDefensePenalty):i+=o.weakDefenseBonus,r&&(i+=o.warTargetBonus),2>e.threatLevel||r||(i-=10*e.threatLevel),Math.max(0,i)}function ko(e,t){let r=1/0;for(const o of e.memberRooms){const e=Game.map.getRoomLinearDistance(o,t);r>e&&(r=e)}return r}const No={move:50,work:100,carry:50,attack:80,ranged_attack:150,heal:250,claim:600,tough:10},Po=new Map;function Io(e,t,r){const o=Math.min(r,3e3);switch(e){case"harasser":return xo([MOVE,ATTACK],o,[MOVE,ATTACK]);case"soldier":return xo([TOUGH,MOVE,ATTACK,MOVE,ATTACK],o,[TOUGH,MOVE,ATTACK]);case"ranger":return xo([TOUGH,MOVE,RANGED_ATTACK],o,[MOVE,RANGED_ATTACK]);case"healer":return xo([TOUGH,MOVE,HEAL],o,[MOVE,HEAL]);case"siegeUnit":return xo([TOUGH,MOVE,WORK],o,[TOUGH,MOVE,WORK]);default:return[MOVE,ATTACK]}}function xo(e,t,r){const o=[...e];let n=e.reduce((e,t)=>e+No[t],0);const s=r.reduce((e,t)=>e+No[t],0);for(;t>=n+s&&50>o.length;)o.push(...r),n+=s;return o.slice(0,50)}function $o(e){switch(e){case"soldier":return[{compound:RESOURCE_CATALYZED_UTRIUM_ALKALIDE,parts:[ATTACK]}];case"ranger":return[{compound:RESOURCE_CATALYZED_KEANIUM_ALKALIDE,parts:[RANGED_ATTACK]}];case"healer":return[{compound:RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE,parts:[HEAL]}];case"siegeUnit":return[{compound:RESOURCE_CATALYZED_ZYNTHIUM_ACID,parts:[WORK]}];default:return[]}}const Go=new Map;function Lo(e){e.lastUpdate=Game.time;const t=Wt.getCluster(e.clusterId);if(!t)return e.state="failed",void de.error(`Cluster ${e.clusterId} not found for operation ${e.id}`,{subsystem:"Offensive"});switch(e.state){case"forming":!function(e){e.squadIds.every(e=>!function(e){return Po.has(e)}(e))&&(e.state="executing",de.info(`Operation ${e.id} entering execution phase`,{subsystem:"Offensive"})),Game.time-e.createdAt>1e3&&(e.state="failed",de.warn(`Operation ${e.id} formation timed out`,{subsystem:"Offensive"}))}(e);break;case"executing":!function(e,t){for(const r of e.squadIds){const o=t.squads.find(e=>e.id===r);if(o&&(vo(o),Co(o))){de.info(`Squad ${r} dissolving, operation ${e.id} may complete`,{subsystem:"Offensive"});const o=t.squads.findIndex(e=>e.id===r);0>o||t.squads.splice(o,1)}}0===e.squadIds.filter(e=>t.squads.some(t=>t.id===e)).length&&(e.state="complete",de.info(`Operation ${e.id} complete`,{subsystem:"Offensive"}))}(e,t)}}function Do(e,t){if(!e)return null;switch(t){case"defense":return function(e){const t=e.find(FIND_MY_SPAWNS),r=e.storage;if(0===t.length)return null;const o=r?r.pos:t[0].pos,n=[];for(let t=-5;5>=t;t++)for(let r=-5;5>=r;r++){const s=o.x+t,i=o.y+r;if(2>s||s>47||2>i||i>47)continue;const a=Fo(e,new RoomPosition(s,i,e.name),"defense");a.score>0&&n.push(a)}if(n.sort((e,t)=>t.score-e.score),0===n.length)return{roomName:e.name,x:25,y:25,purpose:"defense",createdAt:Game.time};const s=n[0];return{roomName:e.name,x:s.position.x,y:s.position.y,purpose:"defense",createdAt:Game.time}}(e);case"offense":return function(e){const t=e.find(FIND_EXIT);if(0===t.length)return null;const r={top:t.filter(e=>5>e.y),bottom:t.filter(e=>e.y>44),left:t.filter(e=>5>e.x),right:t.filter(e=>e.x>44)};let o=[],n=1/0;for(const[e,t]of Object.entries(r)){if(0===t.length)continue;const e=t[0].getRangeTo(25,25);n>e&&(n=e,o=t)}if(0===o.length)return{roomName:e.name,x:25,y:25,purpose:"offense",createdAt:Game.time};const s=o[Math.floor(o.length/2)],i=[];for(let t=-3;3>=t;t++)for(let r=-3;3>=r;r++){const o=s.x+t,n=s.y+r;if(2>o||o>47||2>n||n>47)continue;const a=Fo(e,new RoomPosition(o,n,e.name),"offense");a.score>0&&i.push(a)}if(i.sort((e,t)=>t.score-e.score),0===i.length){const t=Math.max(2,Math.min(47,s.x)),r=Math.max(2,Math.min(47,s.y));return{roomName:e.name,x:t,y:r,purpose:"offense",createdAt:Game.time}}const a=i[0];return{roomName:e.name,x:a.position.x,y:a.position.y,purpose:"offense",createdAt:Game.time}}(e);case"staging":return function(e){const t=[];for(let r=10;40>=r;r+=5)for(let o=10;40>=o;o+=5){const n=Fo(e,new RoomPosition(r,o,e.name),"staging");n.score>0&&t.push(n)}if(t.sort((e,t)=>t.score-e.score),0===t.length)return{roomName:e.name,x:25,y:25,purpose:"staging",createdAt:Game.time};const r=t[0];return{roomName:e.name,x:r.position.x,y:r.position.y,purpose:"staging",createdAt:Game.time}}(e);case"retreat":return function(e){const t=e.find(FIND_MY_SPAWNS);if(0===t.length)return{roomName:e.name,x:25,y:25,purpose:"retreat",createdAt:Game.time};const r=t[0];return{roomName:e.name,x:r.pos.x,y:r.pos.y,purpose:"retreat",createdAt:Game.time}}(e);default:return null}}function Fo(e,t,r){let o=0,n=0,s=0,i=0,a=0;const c=e.getTerrain().get(t.x,t.y);if(c===TERRAIN_MASK_WALL)return{position:t,score:0,terrain:0,safety:0,centrality:0,exitAccess:0};if(n=0===c?10:5,o+=n,e.lookForAt(LOOK_STRUCTURES,t).some(e=>e.structureType!==STRUCTURE_ROAD&&e.structureType!==STRUCTURE_RAMPART))return{position:t,score:0,terrain:0,safety:0,centrality:0,exitAccess:0};const l=e.find(FIND_HOSTILE_CREEPS);if(l.length>0){const e=Math.min(...l.map(e=>t.getRangeTo(e)));s=Math.min(10,e)}else s=10;o+=2*s;const u=Math.sqrt(Math.pow(t.x-25,2)+Math.pow(t.y-25,2));i=Math.max(0,"defense"===r||"retreat"===r?10-u/2:5-Math.abs(u-15)/2),o+=i;const m=Math.min(t.x,t.y,49-t.x,49-t.y);return a="offense"===r||"staging"===r?Math.max(0,10-m/2):Math.min(10,m/2.5),o+=a,{position:t,score:o,terrain:n,safety:s,centrality:i,exitAccess:a}}var Bo,Ho={},Wo={};function Yo(){return Bo||(Bo=1,function(e){function t(t){return e.NON_AGGRESSION_PACT_PLAYERS.includes(t)}function r(e){return t(e.owner.username)}function o(e){var r;return!!(null===(r=e.owner)||void 0===r?void 0:r.username)&&t(e.owner.username)}function n(e){var t;const o=e.filter(e=>!r(e)),n=e.length-o.length;return n>0&&console.log(`[Alliance] Filtered ${n} allied creeps from hostile detection in ${null===(t=e[0])||void 0===t?void 0:t.room.name}`),o}function s(e){var t;const r=e.filter(e=>!o(e)),n=e.length-r.length;return n>0&&console.log(`[Alliance] Filtered ${n} allied structures from hostile detection in ${null===(t=e[0])||void 0===t?void 0:t.room.name}`),r}function i(e){return n(e.find(FIND_HOSTILE_CREEPS))}function a(e){return s(e.find(FIND_HOSTILE_STRUCTURES))}Object.defineProperty(e,"__esModule",{value:!0}),e.NON_AGGRESSION_PACT_PLAYERS=void 0,e.isAllyPlayer=t,e.isAllyCreep=r,e.isAllyStructure=o,e.filterAllyCreeps=n,e.filterAllyStructures=s,e.getActualHostileCreeps=i,e.getActualHostileStructures=a,e.hasActualHostiles=function(e){const t=i(e),r=a(e);return t.length>0||r.length>0},e.NON_AGGRESSION_PACT_PLAYERS=["TooAngel","TedRoastBeef"]}(Wo)),Wo}var Ko,jo={},Vo=m(pe),qo=m(Et);function zo(){if(Ko)return jo;Ko=1,Object.defineProperty(jo,"__esModule",{value:!0}),jo.assessThreat=function(e){const t=e.find(FIND_HOSTILE_CREEPS),n=(0,r.filterAllyCreeps)(t);if(0===n.length)return{roomName:e.name,dangerLevel:0,threatScore:0,hostileCount:0,totalHostileHitPoints:0,totalHostileDPS:0,healerCount:0,rangedCount:0,meleeCount:0,boostedCount:0,dismantlerCount:0,estimatedDefenderCost:0,assistanceRequired:!1,assistancePriority:0,recommendedResponse:"monitor"};let s=0,a=0,c=0,l=0,m=0,d=0,p=0,g=0;for(const e of n){let t=0,r=0,o=0,n=0;for(const s of e.body)if(0!==s.hits)switch(s.type){case ATTACK:t++;break;case RANGED_ATTACK:r++;break;case HEAL:o++;break;case WORK:n++}a+=30*t+10*r,c+=e.hits,e.body.some(e=>e.boost)&&(l++,s+=200),o>0&&(m++,s+=100),r>0&&d++,t>0&&p++,5>n||(g++,s+=150),s+=10*(t+r)}const f=e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_TOWER}).reduce((e,t)=>{if(10>t.store.getUsedCapacity(RESOURCE_ENERGY))return e;const r=n.reduce((e,r)=>e+t.pos.getRangeTo(r.pos),0);return e+o(r/n.length)},0),h=a>1.5*f,y=Math.min(100,Math.max(0,(a-f)/10)),R=u(a);let E,T=i(s);return E=100>s?"monitor":500>s&&!h?"defend":h&&1e3>s?"assist":s>1e3||l>3?"safemode":"defend",e.find(FIND_NUKES).length>0&&(s+=500,E="safemode",T=3),{roomName:e.name,dangerLevel:T,threatScore:s,hostileCount:n.length,totalHostileHitPoints:c,totalHostileDPS:a,healerCount:m,rangedCount:d,meleeCount:p,boostedCount:l,dismantlerCount:g,estimatedDefenderCost:R,assistanceRequired:h,assistancePriority:y,recommendedResponse:E}},jo.calculateTowerDamage=o,jo.calculateDangerLevel=i,jo.estimateDefenderCost=u,jo.logThreatAnalysis=function(t){e.logger.info(`Threat Assessment for ${t.roomName}: Danger=${t.dangerLevel}, Score=${t.threatScore}, Hostiles=${t.hostileCount}, DPS=${t.totalHostileDPS}, Response=`+t.recommendedResponse,{subsystem:"Defense",room:t.roomName,meta:{threat:{dangerLevel:t.dangerLevel,threatScore:t.threatScore,hostileCount:t.hostileCount,boostedCount:t.boostedCount,healerCount:t.healerCount,dismantlerCount:t.dismantlerCount,recommendedResponse:t.recommendedResponse}}})};const e=Vo,t=qo,r=Yo();function o(e){return e>5?20>e?600-30*(e-5):150:600}const n=300,s=800;function i(e){return 0===e?0:n>e?1:s>e?2:3}function a(e){let t=0;for(const r of e)r===ATTACK?t+=30:r===RANGED_ATTACK&&(t+=10);return t}function c(e){const r=t.ROLE_DEFINITIONS[e];return r?r.bodies.map(e=>({parts:e.parts,cost:e.cost,dps:a(e.parts)})).sort((e,t)=>e.cost-t.cost):[]}function l(e){if(0===e.length)return{dpsPerEnergy:300/1300,avgCost:1300,avgDps:300};const t=e.reduce((e,t)=>e+t.cost,0),r=e.reduce((e,t)=>e+t.dps,0),o=t/e.length,n=r/e.length;return{dpsPerEnergy:n/o,avgCost:o,avgDps:n}}function u(e,t,r){if(void 0===t||void 0===r){const e=c("guard"),o=c("ranger"),n=l(e),s=l(o),i=(n.avgDps+s.avgDps)/2,a=(n.avgCost+s.avgCost)/2;t=null!=t?t:i,r=null!=r?r:a}return t>0||(t=300,r=1300),Math.ceil(e/t)*r}return jo}var Xo,Qo,Zo={},Jo={};function en(){return Xo||(Xo=1,Object.defineProperty(Jo,"__esModule",{value:!0}),Jo.calculateWallRepairTarget=function(e,t){var r,o;const n=null!==(r={1:0,2:3e5,3:1e6,4:3e6,5:1e7,6:3e7,7:1e8,8:3e8}[e])&&void 0!==r?r:0;if(0===n)return 0;const s=null!==(o={0:.3,1:.5,2:.8,3:1}[t])&&void 0!==o?o:1;return Math.floor(n*s)}),Jo}var tn,rn={};function on(){if(tn)return rn;tn=1,Object.defineProperty(rn,"__esModule",{value:!0}),rn.findRoomExits=r,rn.identifyChokePoints=function(e,t){var r;const o=[],n=new Map;for(const e of t){const t=null!==(r=n.get(e.exitDirection))&&void 0!==r?r:[];t.push(e),n.set(e.exitDirection,t)}for(const e of n.values()){const t=[...e].sort((e,t)=>e.x===t.x?e.y-t.y:e.x-t.x);let r=0;for(let e=1;e<=t.length;e++){const n=t[e-1],s=t[e];if(!s||n&&s&&(Math.abs(s.x-n.x)>1||Math.abs(s.y-n.y)>1)){const n=e-r,s=t.slice(r,e);if(n>=2&&4>=n)for(const e of s)e.isChokePoint=!0,o.push(e);r=e}}}return o},rn.calculatePerimeterPositions=o,rn.placePerimeterDefense=function(t,r,n=3,s=!0){if(2>r)return 0;const i=o(t.name),a=t.find(FIND_MY_CONSTRUCTION_SITES),c=t.find(FIND_STRUCTURES);if(a.length>=10)return 0;let l=0;const u=Math.min(n,10-a.length),m=c.filter(e=>e.structureType===STRUCTURE_WALL).length+a.filter(e=>e.structureType===STRUCTURE_WALL).length,d=c.filter(e=>e.structureType===STRUCTURE_RAMPART).length+a.filter(e=>e.structureType===STRUCTURE_RAMPART).length,p=2>r?0:2500,g=2>r?0:2500;if(r>=2&&u>l&&p>m)for(const r of i.walls){if(l>=u)break;if(m+l>=p)break;const o=c.some(e=>e.pos.x===r.x&&e.pos.y===r.y&&(e.structureType===STRUCTURE_WALL||e.structureType===STRUCTURE_RAMPART)),n=a.some(e=>e.pos.x===r.x&&e.pos.y===r.y&&(e.structureType===STRUCTURE_WALL||e.structureType===STRUCTURE_RAMPART));o||n||t.createConstructionSite(r.x,r.y,STRUCTURE_WALL)===OK&&(l++,e.logger.debug(`Placed perimeter wall at (${r.x},${r.y})`,{subsystem:"Defense"}))}if(r>=3)for(const t of i.ramparts){const r=c.some(e=>e.pos.x===t.x&&e.pos.y===t.y&&e.structureType===STRUCTURE_RAMPART),o=a.some(e=>e.pos.x===t.x&&e.pos.y===t.y&&e.structureType===STRUCTURE_RAMPART);if(!r&&!o){const r=c.find(e=>e.pos.x===t.x&&e.pos.y===t.y&&e.structureType===STRUCTURE_WALL);if(r){const o=r.destroy();o===OK?e.logger.info(`Removed wall at gap position (${t.x},${t.y}) to allow friendly passage`,{subsystem:"Defense"}):e.logger.warn(`Failed to destroy wall at gap position (${t.x},${t.y}): ${o}`,{subsystem:"Defense"})}}}if(r>=3&&u>l&&g>d)for(const r of i.ramparts){if(l>=u)break;if(d+l>=g)break;const o=c.some(e=>e.pos.x===r.x&&e.pos.y===r.y&&e.structureType===STRUCTURE_RAMPART),n=a.some(e=>e.pos.x===r.x&&e.pos.y===r.y&&e.structureType===STRUCTURE_RAMPART),s=c.some(e=>e.pos.x===r.x&&e.pos.y===r.y&&e.structureType===STRUCTURE_WALL);o||n||s||t.createConstructionSite(r.x,r.y,STRUCTURE_RAMPART)===OK&&(l++,e.logger.debug(`Placed perimeter rampart gap at (${r.x},${r.y})`,{subsystem:"Defense"}))}return l},rn.getPerimeterStats=function(e){const t=o(e.name),r=e.find(FIND_STRUCTURES),n=t.walls.length,s=t.ramparts.length,i=r.filter(e=>e.structureType===STRUCTURE_WALL),a=r.filter(e=>e.structureType===STRUCTURE_RAMPART);let c=0;for(const e of i)t.walls.some(t=>t.x===e.pos.x&&t.y===e.pos.y)&&c++;let l=0;for(const e of a)t.ramparts.some(t=>t.x===e.pos.x&&t.y===e.pos.y)&&l++;return{totalWallPositions:n,totalGapPositions:s,wallsBuilt:c,rampartsBuilt:l,wallCoveragePercent:n>0?Math.round(c/n*100):0,gapCoveragePercent:s>0?Math.round(l/s*100):0}};const e=Vo,t=4;function r(e){const t=[],r=Game.map.getRoomTerrain(e),o=Game.rooms[e],n=new Set;if(o){const e=o.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_WALL||e.structureType===STRUCTURE_RAMPART});for(const t of e)n.add(`${t.pos.x},${t.pos.y}`)}for(let e=0;50>e;e++)r.get(e,0)===TERRAIN_MASK_WALL||n.has(e+",0")||t.push({x:e,y:0,exitDirection:"top",isChokePoint:!1});for(let e=0;50>e;e++)r.get(e,49)===TERRAIN_MASK_WALL||n.has(e+",49")||t.push({x:e,y:49,exitDirection:"bottom",isChokePoint:!1});for(let e=1;49>e;e++)r.get(0,e)===TERRAIN_MASK_WALL||n.has("0,"+e)||t.push({x:0,y:e,exitDirection:"left",isChokePoint:!1});for(let e=1;49>e;e++)r.get(49,e)===TERRAIN_MASK_WALL||n.has("49,"+e)||t.push({x:49,y:e,exitDirection:"right",isChokePoint:!1});return t}function o(e){var o;const n=Game.map.getRoomTerrain(e),s=[],i=[],a=r(e),c=new Map;for(const e of a){const t=null!==(o=c.get(e.exitDirection))&&void 0!==o?o:[];t.push(e),c.set(e.exitDirection,t)}for(const[e,r]of c){const o=[...r].sort((e,t)=>e.x===t.x?e.y-t.y:e.x-t.x),a=[];let c=[];for(let e=0;e<o.length;e++){const t=o[e],r=o[e-1];!(r&&1>=Math.abs(t.x-r.x)&&1>=Math.abs(t.y-r.y))&&c.length>0&&(a.push(c),c=[]),c.push(t)}c.length>0&&a.push(c);for(const r of a){const o=Math.floor(r.length/2);for(let a=0;a<r.length;a++){const c=r[a];let l=c.x,u=c.y;switch(e){case"top":u=2;break;case"bottom":u=47;break;case"left":l=2;break;case"right":l=47}n.get(l,u)!==TERRAIN_MASK_WALL&&(r.length<t||a!==o&&a!==o-1?s.push({x:l,y:u,exitDirection:e,isChokePoint:!1}):i.push({x:l,y:u,exitDirection:e,isChokePoint:!1}))}}}return{walls:s,ramparts:i}}return rn}var nn={};const sn={recalculateInterval:1e3,maxPathOps:2e3,includeRemoteRoads:!0},an=new Map;function cn(e,t,r={}){var o,n,s;const i={...sn,...r},a=an.get(e.name);if(a&&Game.time-a.lastCalculated<i.recalculateInterval)return a;const c=new Set,l=null!==(n=null===(o=e.controller)||void 0===o?void 0:o.level)&&void 0!==n?n:0,u=e.find(FIND_SOURCES),m=e.controller,d=e.storage,p=e.find(FIND_MINERALS)[0],g=null!==(s=null==d?void 0:d.pos)&&void 0!==s?s:t;for(const t of u){const r=pn(g,t.pos,e.name,i.maxPathOps);for(const e of r)c.add(`${e.x},${e.y}`)}if(m){const t=pn(g,m.pos,e.name,i.maxPathOps);for(const e of t)c.add(`${e.x},${e.y}`)}if(p&&l>=6){const t=pn(g,p.pos,e.name,i.maxPathOps);for(const e of t)c.add(`${e.x},${e.y}`)}if(!d){for(const r of u){const o=pn(t,r.pos,e.name,i.maxPathOps);for(const e of o)c.add(`${e.x},${e.y}`)}if(m){const r=pn(t,m.pos,e.name,i.maxPathOps);for(const e of r)c.add(`${e.x},${e.y}`)}}const f={roomName:e.name,positions:c,lastCalculated:Game.time};return an.set(e.name,f),de.debug(`Calculated road network for ${e.name}: ${c.size} positions`,{subsystem:"RoadNetwork"}),f}function ln(e,t){const r=e=>{const t=e.match(/([WE])(\d+)([NS])(\d+)/);return t?{x:("W"===t[1]?-1:1)*parseInt(t[2],10),y:("N"===t[3]?1:-1)*parseInt(t[4],10)}:null},o=r(e),n=r(t);if(!o||!n)return null;const s=n.x-o.x,i=n.y-o.y;return s>0?"right":0>s?"left":i>0?"top":0>i?"bottom":null}function un(e,t){const r=[],o=Game.map.getRoomTerrain(e);switch(t){case"top":for(let t=0;50>t;t++)o.get(t,0)!==TERRAIN_MASK_WALL&&r.push(new RoomPosition(t,0,e));break;case"bottom":for(let t=0;50>t;t++)o.get(t,49)!==TERRAIN_MASK_WALL&&r.push(new RoomPosition(t,49,e));break;case"left":for(let t=0;50>t;t++)o.get(0,t)!==TERRAIN_MASK_WALL&&r.push(new RoomPosition(0,t,e));break;case"right":for(let t=0;50>t;t++)o.get(49,t)!==TERRAIN_MASK_WALL&&r.push(new RoomPosition(49,t,e))}return r}function mn(e,t){if(0===t.length)return null;let r=t[0],o=e.getRangeTo(r);for(const n of t){const t=e.getRangeTo(n);o>t&&(o=t,r=n)}return r}function dn(e,t,r={}){var o,n,s;const i={...sn,...r},a=new Map;if(!i.includeRemoteRoads)return a;const c=e.storage,l=e.find(FIND_MY_SPAWNS)[0],u=null!==(o=null==c?void 0:c.pos)&&void 0!==o?o:null==l?void 0:l.pos;if(!u)return a;for(const r of t)try{const t=ln(e.name,r);if(!t){de.warn(`Cannot determine exit direction from ${e.name} to ${r}`,{subsystem:"RoadNetwork"});continue}const o=un(e.name,t);if(0===o.length){de.warn(`No valid exit positions found in ${e.name} towards ${r}`,{subsystem:"RoadNetwork"});continue}const c=mn(u,o);if(!c)continue;const l=PathFinder.search(u,{pos:c,range:0},{plainCost:2,swampCost:10,maxOps:i.maxPathOps,roomCallback:t=>t===e.name&&gn(t)});if(!l.incomplete)for(const e of l.path)a.has(e.roomName)||a.set(e.roomName,new Set),null===(n=a.get(e.roomName))||void 0===n||n.add(`${e.x},${e.y}`);const m=new RoomPosition(25,25,r),d=PathFinder.search(u,{pos:m,range:20},{plainCost:2,swampCost:10,maxOps:i.maxPathOps,roomCallback:e=>gn(e)});if(!d.incomplete)for(const e of d.path)a.has(e.roomName)||a.set(e.roomName,new Set),null===(s=a.get(e.roomName))||void 0===s||s.add(`${e.x},${e.y}`)}catch(e){const t=e instanceof Error?e.message:e+"";de.warn(`Failed to calculate remote road to ${r}: ${t}`,{subsystem:"RoadNetwork"})}return a}function pn(e,t,r,o){const n=[],s=PathFinder.search(e,{pos:t,range:1},{plainCost:2,swampCost:10,maxOps:o,roomCallback:e=>e===r&&gn(e)});if(!s.incomplete)for(const e of s.path)e.roomName===r&&n.push({x:e.x,y:e.y});return n}function gn(e){const t=Game.rooms[e],r=new PathFinder.CostMatrix;if(!t)return r;const o=t.find(FIND_STRUCTURES);for(const e of o)e.structureType===STRUCTURE_ROAD?r.set(e.pos.x,e.pos.y,1):e.structureType===STRUCTURE_CONTAINER||e.structureType===STRUCTURE_RAMPART&&"my"in e&&e.my||r.set(e.pos.x,e.pos.y,255);const n=t.find(FIND_MY_CONSTRUCTION_SITES);for(const e of n)e.structureType===STRUCTURE_ROAD?r.set(e.pos.x,e.pos.y,1):e.structureType!==STRUCTURE_CONTAINER&&r.set(e.pos.x,e.pos.y,255);return r}function fn(e,t){return!(e.x>t&&e.x<49-t&&e.y>t&&e.y<49-t)}function hn(e,t,r,o=[]){var n;const s=new Set,i=e.getTerrain();for(const e of r){const r=t.x+e.x,o=t.y+e.y;1>r||r>48||1>o||o>48||i.get(r,o)===TERRAIN_MASK_WALL||s.add(`${r},${o}`)}const a=cn(e,t);for(const e of a.positions)s.add(e);const c=e.storage,l=e.find(FIND_MY_SPAWNS)[0],u=null!==(n=null==c?void 0:c.pos)&&void 0!==n?n:null==l?void 0:l.pos;if(u){const t=function(e,t,r={}){const o={...sn,...r},n=new Set,s=["top","bottom","left","right"];for(const r of s)try{const s=un(e.name,r);if(0===s.length)continue;const i=mn(t,s);if(!i)continue;const a=PathFinder.search(t,{pos:i,range:0},{plainCost:2,swampCost:10,maxOps:o.maxPathOps,roomCallback:t=>t===e.name&&gn(t)});if(a.incomplete)de.warn(`Incomplete path when calculating exit road for ${r} in ${e.name} (target exit: ${i.x},${i.y}). Path length: ${a.path.length}`,{subsystem:"RoadNetwork"});else for(const t of a.path)t.roomName===e.name&&n.add(`${t.x},${t.y}`)}catch(t){const o=t instanceof Error?t.message:t+"";de.warn(`Failed to calculate exit road for ${r} in ${e.name}: ${o}`,{subsystem:"RoadNetwork"})}return n}(e,u);for(const e of t)s.add(e)}if(o.length>0){const t=dn(e,o).get(e.name);if(t)for(const e of t)s.add(e)}const m=function(e,t=10){const r=new Set,o=e.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_ROAD}),n=e.find(FIND_CONSTRUCTION_SITES,{filter:e=>e.structureType===STRUCTURE_ROAD});for(const e of o)fn(e.pos,t)&&r.add(`${e.pos.x},${e.pos.y}`);for(const e of n)fn(e.pos,t)&&r.add(`${e.pos.x},${e.pos.y}`);return r}(e);for(const e of m)s.add(e);return s}function yn(e,t,r=3){const o=e.find(FIND_MY_CONSTRUCTION_SITES);if(o.length>=10)return 0;const n=cn(e,t),s=e.getTerrain(),i=e.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_ROAD}),a=new Set(i.map(e=>`${e.pos.x},${e.pos.y}`)),c=new Set(o.filter(e=>e.structureType===STRUCTURE_ROAD).map(e=>`${e.pos.x},${e.pos.y}`));let l=0;for(const t of n.positions){if(l>=r)break;if(o.length+l>=10)break;if(a.has(t))continue;if(c.has(t))continue;const[n,i]=t.split(","),u=parseInt(n,10),m=parseInt(i,10);s.get(u,m)!==TERRAIN_MASK_WALL&&e.createConstructionSite(u,m,STRUCTURE_ROAD)===OK&&l++}return l}var Rn,En,Tn,Cn,vn,Sn,_n,bn,On=m(Object.freeze({__proto__:null,calculateRemoteRoads:dn,calculateRoadNetwork:cn,clearAllRoadNetworkCaches:function(){an.clear()},clearRoadNetworkCache:function(e){an.delete(e)},getCachedRoadNetwork:function(e){return an.get(e)},getValidRoadPositions:hn,isValidRoadPosition:function(e,t,r,o,n,s=[]){return hn(e,o,n,s).has(`${t},${r}`)},placeRoadConstructionSites:yn})),Un={},Mn=m(Er),An=m(ze),wn={},kn={},Nn=m(Yt),Pn={},In=m(Xt),xn={},$n={},Gn=(bn||(bn=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.EvacuationManager=e.evacuationManager=e.SafeModeManager=e.safeModeManager=e.EmergencyLevel=e.EmergencyResponseManager=e.emergencyResponseManager=e.coordinateClusterDefense=e.clusterDefenseCoordinator=e.ClusterDefenseCoordinator=e.checkAndExecuteRetreat=e.DefenseCoordinator=e.defenseCoordinator=e.placeRoadAwarePerimeterDefense=e.placePerimeterDefense=e.calculateWallRepairTarget=e.placeRampartsOnCriticalStructures=e.logThreatAnalysis=e.estimateDefenderCost=e.calculateDangerLevel=e.calculateTowerDamage=e.assessThreat=e.hasActualHostiles=e.getActualHostileStructures=e.getActualHostileCreeps=e.filterAllyStructures=e.filterAllyCreeps=e.isAllyStructure=e.isAllyCreep=e.isAllyPlayer=e.NON_AGGRESSION_PACT_PLAYERS=void 0;var t=Yo();Object.defineProperty(e,"NON_AGGRESSION_PACT_PLAYERS",{enumerable:!0,get:function(){return t.NON_AGGRESSION_PACT_PLAYERS}}),Object.defineProperty(e,"isAllyPlayer",{enumerable:!0,get:function(){return t.isAllyPlayer}}),Object.defineProperty(e,"isAllyCreep",{enumerable:!0,get:function(){return t.isAllyCreep}}),Object.defineProperty(e,"isAllyStructure",{enumerable:!0,get:function(){return t.isAllyStructure}}),Object.defineProperty(e,"filterAllyCreeps",{enumerable:!0,get:function(){return t.filterAllyCreeps}}),Object.defineProperty(e,"filterAllyStructures",{enumerable:!0,get:function(){return t.filterAllyStructures}}),Object.defineProperty(e,"getActualHostileCreeps",{enumerable:!0,get:function(){return t.getActualHostileCreeps}}),Object.defineProperty(e,"getActualHostileStructures",{enumerable:!0,get:function(){return t.getActualHostileStructures}}),Object.defineProperty(e,"hasActualHostiles",{enumerable:!0,get:function(){return t.hasActualHostiles}});var r=zo();Object.defineProperty(e,"assessThreat",{enumerable:!0,get:function(){return r.assessThreat}}),Object.defineProperty(e,"calculateTowerDamage",{enumerable:!0,get:function(){return r.calculateTowerDamage}}),Object.defineProperty(e,"calculateDangerLevel",{enumerable:!0,get:function(){return r.calculateDangerLevel}}),Object.defineProperty(e,"estimateDefenderCost",{enumerable:!0,get:function(){return r.estimateDefenderCost}}),Object.defineProperty(e,"logThreatAnalysis",{enumerable:!0,get:function(){return r.logThreatAnalysis}});var o=function(){if(Qo)return Zo;Qo=1,Object.defineProperty(Zo,"__esModule",{value:!0}),Zo.placeRampartsOnCriticalStructures=function(r,o,a,c=5){const l={placed:0,needsRepair:0,totalCritical:0,protected:0};if(2>o)return l;const u=n(r,o);if(l.totalCritical=u.length,0===u.length)return l;const m=r.find(FIND_MY_CONSTRUCTION_SITES);if(m.length>=10)return l;const d=Math.min(c,10-m.length),p=r.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_RAMPART}),g=(0,t.calculateWallRepairTarget)(o,a),f=[];for(const e of u){const{x:t,y:o}=e.pos;if(s(r,t,o)){l.protected++;const e=p.find(e=>e.pos.x===t&&e.pos.y===o);e&&e.hits<g&&l.needsRepair++}else if(!i(r,t,o)){let t=10;e.structureType===STRUCTURE_SPAWN?t=100:e.structureType===STRUCTURE_STORAGE?t=90:e.structureType===STRUCTURE_TOWER?t=80:e.structureType===STRUCTURE_TERMINAL?t=70:e.structureType===STRUCTURE_LAB&&(t=60),2>a||(t+=50),f.push({structure:e,priority:t})}}f.sort((e,t)=>t.priority-e.priority);for(const{structure:t}of f){if(l.placed>=d)break;const{x:o,y:n}=t.pos,s=r.createConstructionSite(o,n,STRUCTURE_RAMPART);if(s===OK)l.placed++,e.logger.debug(`Placed rampart on ${t.structureType} at (${o},${n})`,{subsystem:"Defense"});else if(s===ERR_FULL)break}return(l.placed>0||f.length>0)&&e.logger.info(`Rampart automation for ${r.name}: ${l.protected}/${l.totalCritical} protected, `+l.placed+" placed, "+(f.length-l.placed)+" pending",{subsystem:"Defense"}),l},Zo.getEmergencyRampartRepairs=function(e,r,o,n=5){const s=.25*(0,t.calculateWallRepairTarget)(r,o),i=e.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_RAMPART&&e.hits<s});return i.sort((e,t)=>e.hits-t.hits),i.slice(0,n)},Zo.getCriticalRampartRepairs=function(e,r,o,s=10){const i=(0,t.calculateWallRepairTarget)(r,o),a=n(e,r),c=[];for(const t of a){const{x:r,y:o}=t.pos,n=e.lookForAt(LOOK_STRUCTURES,r,o).find(e=>e.structureType===STRUCTURE_RAMPART);if(n&&n.hits<i){let e=10;t.structureType===STRUCTURE_SPAWN?e=100:t.structureType===STRUCTURE_STORAGE?e=90:t.structureType===STRUCTURE_TOWER?e=80:t.structureType===STRUCTURE_TERMINAL&&(e=70),e*=1-n.hits/i,c.push({rampart:n,priority:e})}}return c.sort((e,t)=>t.priority-e.priority),c.slice(0,s).map(e=>e.rampart)},Zo.getRampartCoverageStats=function(e,r,o){const s=n(e,r),i=(0,t.calculateWallRepairTarget)(r,o);let a=0,c=0;for(const t of s){const{x:r,y:o}=t.pos,n=e.lookForAt(LOOK_STRUCTURES,r,o).find(e=>e.structureType===STRUCTURE_RAMPART);n&&(a++,n.hits<i&&c++)}const l=s.length-a,u=s.length>0?Math.round(a/s.length*100):0;return{totalCritical:s.length,protected:a,unprotected:l,needsRepair:c,coveragePercent:u}};const e=Vo,t=en(),r=[STRUCTURE_SPAWN,STRUCTURE_STORAGE,STRUCTURE_TERMINAL,STRUCTURE_TOWER,STRUCTURE_LAB,STRUCTURE_FACTORY,STRUCTURE_POWER_SPAWN,STRUCTURE_NUKER,STRUCTURE_OBSERVER],o=[STRUCTURE_SPAWN,STRUCTURE_TOWER,STRUCTURE_STORAGE];function n(e,t){const n=e.find(FIND_MY_STRUCTURES),s=4>t?o:r;return n.filter(e=>s.includes(e.structureType))}function s(e,t,r){return e.lookForAt(LOOK_STRUCTURES,t,r).some(e=>e.structureType===STRUCTURE_RAMPART)}function i(e,t,r){return e.lookForAt(LOOK_CONSTRUCTION_SITES,t,r).some(e=>e.structureType===STRUCTURE_RAMPART)}return Zo}();Object.defineProperty(e,"placeRampartsOnCriticalStructures",{enumerable:!0,get:function(){return o.placeRampartsOnCriticalStructures}});var n=en();Object.defineProperty(e,"calculateWallRepairTarget",{enumerable:!0,get:function(){return n.calculateWallRepairTarget}});var s=on();Object.defineProperty(e,"placePerimeterDefense",{enumerable:!0,get:function(){return s.placePerimeterDefense}});var i=function(){if(Rn)return nn;Rn=1,Object.defineProperty(nn,"__esModule",{value:!0}),nn.calculateRoadAwarePerimeter=s,nn.placeRoadAwarePerimeterDefense=function(t,r,i,a,c=3,l=[]){if(2>a)return{sitesPlaced:0,wallsRemoved:0};const u=s(t,r,i,l),m=t.find(FIND_MY_CONSTRUCTION_SITES),d=t.find(FIND_STRUCTURES);if(m.length>=o)return{sitesPlaced:0,wallsRemoved:0};let p=0,g=0;const f=Math.min(c,o-m.length),h=d.filter(e=>e.structureType===STRUCTURE_WALL).length+m.filter(e=>e.structureType===STRUCTURE_WALL).length,y=d.filter(e=>e.structureType===STRUCTURE_RAMPART).length+m.filter(e=>e.structureType===STRUCTURE_RAMPART).length,R=2>a?0:n,E=2>a?0:n;if(a>=3&&u.wallsToRemove.length>0)for(const t of u.wallsToRemove){const r=d.find(e=>e.structureType===STRUCTURE_WALL&&e.pos.x===t.x&&e.pos.y===t.y);if(r&&!d.some(e=>e.structureType===STRUCTURE_RAMPART&&e.pos.x===t.x&&e.pos.y===t.y)){const o=r.destroy();o===OK?(g++,e.logger.info(`Removed wall at (${t.x},${t.y}) to allow road passage`,{subsystem:"Defense"})):e.logger.warn(`Failed to remove wall at (${t.x},${t.y}): ${o}`,{subsystem:"Defense"})}}if(a>=2&&f>p&&R>h)for(const r of u.walls){if(p>=f)break;if(h+p>=R)break;const o=d.some(e=>e.pos.x===r.x&&e.pos.y===r.y&&(e.structureType===STRUCTURE_WALL||e.structureType===STRUCTURE_RAMPART)),n=m.some(e=>e.pos.x===r.x&&e.pos.y===r.y&&(e.structureType===STRUCTURE_WALL||e.structureType===STRUCTURE_RAMPART));o||n||t.createConstructionSite(r.x,r.y,STRUCTURE_WALL)===OK&&(p++,e.logger.debug(`Placed perimeter wall at (${r.x},${r.y})`,{subsystem:"Defense"}))}if(a>=3&&f>p&&E>y)for(const r of u.ramparts){if(p>=f)break;if(y+p>=E)break;const o=d.some(e=>e.pos.x===r.x&&e.pos.y===r.y&&e.structureType===STRUCTURE_RAMPART),n=m.some(e=>e.pos.x===r.x&&e.pos.y===r.y&&e.structureType===STRUCTURE_RAMPART),s=d.some(e=>e.pos.x===r.x&&e.pos.y===r.y&&e.structureType===STRUCTURE_WALL);o||n||s||t.createConstructionSite(r.x,r.y,STRUCTURE_RAMPART)===OK&&(p++,u.roadCrossings.some(e=>e.x===r.x&&e.y===r.y)?e.logger.debug(`Placed rampart at road crossing (${r.x},${r.y})`,{subsystem:"Defense"}):e.logger.debug(`Placed rampart gap at (${r.x},${r.y})`,{subsystem:"Defense"}))}return{sitesPlaced:p,wallsRemoved:g}},nn.getRoadAwarePerimeterStats=function(e,t,r,o=[]){const n=s(e,t,r,o),i=e.find(FIND_STRUCTURES),a=n.walls.length,c=n.ramparts.length,l=n.roadCrossings.length,u=n.wallsToRemove.length,m=i.filter(e=>e.structureType===STRUCTURE_WALL),d=i.filter(e=>e.structureType===STRUCTURE_RAMPART);let p=0;for(const e of m)n.walls.some(t=>t.x===e.pos.x&&t.y===e.pos.y)&&p++;let g=0;for(const e of d)n.ramparts.some(t=>t.x===e.pos.x&&t.y===e.pos.y)&&g++;return{totalWallPositions:a,totalRampartPositions:c,roadCrossings:l,wallsBuilt:p,rampartsBuilt:g,wallsBlockingRoads:u,wallCoveragePercent:a>0?Math.round(p/a*100):0,rampartCoveragePercent:c>0?Math.round(g/c*100):0}};const e=Vo,t=On,r=on(),o=10,n=2500;function s(e,o,n,s=[]){const i=(0,t.getValidRoadPositions)(e,o,n,s),a=(0,r.calculatePerimeterPositions)(e.name),c=[],l=[],u=[...a.ramparts];for(const e of a.walls){const t=`${e.x},${e.y}`;i.has(t)?(c.push(e),u.push(e)):l.push(e)}const m=[],d=e.find(FIND_STRUCTURES);for(const e of d)if(e.structureType===STRUCTURE_WALL){const t=`${e.pos.x},${e.pos.y}`;i.has(t)&&m.push({x:e.pos.x,y:e.pos.y})}return{walls:l,ramparts:u,roadCrossings:c,wallsToRemove:m}}return nn}();Object.defineProperty(e,"placeRoadAwarePerimeterDefense",{enumerable:!0,get:function(){return i.placeRoadAwarePerimeterDefense}});var a=function(){if(En)return Un;En=1;var e=Un&&Un.__decorate||function(e,t,r,o){var n,s=arguments.length,i=3>s?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(3>s?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(Un,"__esModule",{value:!0}),Un.defenseCoordinator=Un.DefenseCoordinator=void 0;const t=Vo,r=Mn,o=An,n=zo(),s=Yo();let i=class{constructor(){this.assignments=new Map}getDefenseRequestsFromMemory(){var e;return null!==(e=Memory.defenseRequests)&&void 0!==e?e:[]}setDefenseRequestsInMemory(e){Memory.defenseRequests=e}run(){const e=this.getDefenseRequestsFromMemory();this.cleanupAssignments();for(const t of e)this.processDefenseRequest(t)}processDefenseRequest(e){const t=Game.rooms[e.roomName];if(!t)return;const r=(0,n.assessThreat)(t),o=Math.max(e.urgency,r.dangerLevel,r.assistanceRequired?3:0),s=this.getAssignedDefenders(e.roomName,"guard"),i=this.getAssignedDefenders(e.roomName,"ranger"),a=r.assistanceRequired?Math.max(0,Math.ceil(r.totalHostileDPS/300)-s.length):0,c=r.assistanceRequired?Math.max(0,Math.ceil(r.totalHostileDPS/300)-i.length):0,l=Math.max(0,e.guardsNeeded-s.length,a),u=Math.max(0,e.rangersNeeded-i.length,c);0===l&&0===u||(l>0&&this.assignDefenders(e.roomName,"guard",l,o),u>0&&this.assignDefenders(e.roomName,"ranger",u,o))}assignDefenders(e,r,o,n){const s=this.findHelperRooms(e,n);let i=0;for(const n of s){if(i>=o)break;const s=n.find(FIND_MY_CREEPS,{filter:e=>{const t=e.memory;return t.role===r&&!t.assistTarget&&!this.assignments.has(e.name)}}),a=Math.min(s.length,2,o-i);for(let o=0;a>o;o++){const a=s[o];if(!a)continue;const c=Game.map.getRoomLinearDistance(n.name,e),l=Game.time+50*c,u={creepName:a.name,targetRoom:e,assignedAt:Game.time,eta:l};this.assignments.set(a.name,u),a.memory.assistTarget=e,i++,t.logger.info(`Assigned ${r} ${a.name} from ${n.name} to assist ${e} (ETA: ${l-Game.time} ticks)`,{subsystem:"Defense"})}}i>0&&t.logger.info(`Defense coordination: Assigned ${i}/${o} ${r}s to ${e}`,{subsystem:"Defense"})}findHelperRooms(e,t){return Object.values(Game.rooms).filter(t=>{var r;return(null===(r=t.controller)||void 0===r?void 0:r.my)&&t.name!==e}).map(r=>{let o=0;o-=10*Game.map.getRoomLinearDistance(e,r.name),o+=20*r.find(FIND_MY_CREEPS,{filter:e=>{const t=e.memory,r=t.role;return("guard"===r||"ranger"===r)&&!t.assistTarget}}).length;const n=r.find(FIND_HOSTILE_CREEPS),i=(0,s.filterAllyCreeps)(n);return o-=30*i.length,i.length>0&&3>t&&(o-=1e3),{room:r,score:o}}).filter(e=>e.score>-500).sort((e,t)=>t.score-e.score).map(e=>e.room)}getAssignedDefenders(e,t){const r=[];for(const[o,n]of this.assignments.entries()){if(n.targetRoom!==e)continue;const s=Game.creeps[o];if(s){if(t&&s.memory.role!==t)continue;r.push(n)}}return r}cleanupAssignments(){const e=[];for(const[r,o]of this.assignments.entries()){const n=Game.creeps[r];if(n){if(n.room.name===o.targetRoom){const i=n.room.find(FIND_HOSTILE_CREEPS);0===(0,s.filterAllyCreeps)(i).length&&(delete n.memory.assistTarget,e.push(r),t.logger.debug(`Released ${r} from defense assistance (no hostiles in ${o.targetRoom})`,{subsystem:"Defense"}))}Game.time-o.assignedAt>1e3&&(delete n.memory.assistTarget,e.push(r),t.logger.debug("Removed stale defense assignment for "+r,{subsystem:"Defense"}))}else e.push(r)}for(const t of e)this.assignments.delete(t)}getAssignmentsForRoom(e){return this.getAssignedDefenders(e)}getAllAssignments(){return Array.from(this.assignments.values())}cancelAssignment(e){if(this.assignments.get(e)){const r=Game.creeps[e];r&&delete r.memory.assistTarget,this.assignments.delete(e),t.logger.info("Cancelled defense assignment for "+e,{subsystem:"Defense"})}}};return Un.DefenseCoordinator=i,e([(0,r.MediumFrequencyProcess)("cluster:defense","Defense Coordinator",{priority:o.ProcessPriority.HIGH,interval:3,minBucket:0,cpuBudget:.05})],i.prototype,"run",null),Un.DefenseCoordinator=i=e([(0,r.ProcessClass)()],i),Un.defenseCoordinator=new i,Un}();Object.defineProperty(e,"defenseCoordinator",{enumerable:!0,get:function(){return a.defenseCoordinator}}),Object.defineProperty(e,"DefenseCoordinator",{enumerable:!0,get:function(){return a.DefenseCoordinator}});var c=function(){if(Tn)return wn;Tn=1,Object.defineProperty(wn,"__esModule",{value:!0}),wn.shouldRetreat=r,wn.executeRetreat=o,wn.checkAndExecuteRetreat=function(e){return!!r(e,(0,t.assessThreat)(e.room))&&(o(e),!0)};const e=Vo,t=zo();function r(t,r){if("retreat"===r.recommendedResponse||"safemode"===r.recommendedResponse)return!0;const o=t.room.find(FIND_MY_CREEPS,{filter:e=>{const t=e.memory;return"defender"===t.role||"rangedDefender"===t.role||"guard"===t.role||"ranger"===t.role}});if(r.hostileCount>3*o.length)return e.logger.info(`Creep ${t.name} retreating: heavily outnumbered (${r.hostileCount} hostiles vs ${o.length} defenders)`,{subsystem:"Defense",room:t.room.name,creep:t.name}),!0;const n=t.room.find(FIND_MY_CREEPS,{filter:e=>"healer"===e.memory.role});return t.hits<.3*t.hitsMax&&r.healerCount>0&&0===n.length?(e.logger.info(`Creep ${t.name} retreating: damaged (${t.hits}/${t.hitsMax}) facing ${r.healerCount} enemy healers without friendly healer support`,{subsystem:"Defense",room:t.room.name,creep:t.name}),!0):r.boostedCount>0&&o.length<2*r.boostedCount&&(e.logger.info(`Creep ${t.name} retreating: facing ${r.boostedCount} boosted hostiles without sufficient support`,{subsystem:"Defense",room:t.room.name,creep:t.name}),!0)}function o(e){var t;const r=e.room.find(FIND_MY_SPAWNS)[0];if(r){const t=e.moveTo(r,{range:3,visualizePathStyle:{stroke:"#ffaa00"}});if(t===OK||t===ERR_TIRED)return}const o=Game.map.describeExits(e.room.name);if(o){const r={[TOP]:FIND_EXIT_TOP,[BOTTOM]:FIND_EXIT_BOTTOM,[LEFT]:FIND_EXIT_LEFT,[RIGHT]:FIND_EXIT_RIGHT},n=[];for(const[s,i]of Object.entries(o)){const o=+s,a=Game.rooms[i];if(!(null===(t=null==a?void 0:a.controller)||void 0===t?void 0:t.my))continue;const c=r[o];if(!c)continue;const l=e.room.find(c);l.length>0&&n.push(...l)}if(n.length>0){const t=e.pos.findClosestByPath(n);if(t)return void e.moveTo(t,{visualizePathStyle:{stroke:"#ffaa00"}})}}const n=e.pos.findClosestByPath(FIND_EXIT);n&&e.moveTo(n,{visualizePathStyle:{stroke:"#ff0000"}})}return wn}();Object.defineProperty(e,"checkAndExecuteRetreat",{enumerable:!0,get:function(){return c.checkAndExecuteRetreat}});var l=(Cn||(Cn=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.clusterDefenseCoordinator=e.ClusterDefenseCoordinator=void 0,e.coordinateClusterDefense=function(t){const o=function(e){return r.memoryManager.getOrInitSwarmState(e).clusterId}(t);o&&e.clusterDefenseCoordinator.coordinateDefense(o)};const t=Vo,r=Nn,o=zo();class n{coordinateDefense(e){const n=function(e){const t=r.memoryManager.getCluster(e);return t?t.memberRooms:[]}(e);if(0===n.length)return;const s=[];for(const e of n){const t=Game.rooms[e];if(!t)continue;const r=(0,o.assessThreat)(t);s.push(r),2>r.dangerLevel||(0,o.logThreatAnalysis)(r)}const i=s.filter(e=>e.assistanceRequired).sort((e,t)=>t.assistancePriority-e.assistancePriority);for(const r of i){const o=this.findAvailableDefenders(n,r.roomName);o.length>0&&(this.sendDefenders(o,r.roomName),t.logger.info(`Cluster Defense: Sending ${o.length} defenders to ${r.roomName}`,{subsystem:"Defense",room:r.roomName,meta:{cluster:e,targetRoom:r.roomName,threatScore:r.threatScore,priority:r.assistancePriority}}))}this.coordinateSafeMode(s)}findAvailableDefenders(e,t){const r=[];for(const n of e){if(n===t)continue;const e=Game.rooms[n];if(e&&0===(0,o.assessThreat)(e).dangerLevel){const t=e.find(FIND_MY_CREEPS,{filter:e=>{const t=e.memory;return("defender"===t.role||"rangedDefender"===t.role||"guard"===t.role||"ranger"===t.role)&&!t.assistTarget}});r.push(...t)}}return r}sendDefenders(e,t){for(const r of e)r.memory.assistTarget=t}coordinateSafeMode(e){var r;const o=e.filter(e=>"safemode"===e.recommendedResponse);if(0===o.length)return;const n=o.reduce((e,t)=>t.threatScore>e.threatScore?t:e),s=Game.rooms[n.roomName];if((null===(r=null==s?void 0:s.controller)||void 0===r?void 0:r.my)&&s.controller.safeModeAvailable>0&&!s.controller.safeMode&&!s.controller.safeModeCooldown){const e=s.controller.activateSafeMode();e===OK?t.logger.warn("Activated safe mode in "+n.roomName,{subsystem:"Defense",room:n.roomName,meta:{threatScore:n.threatScore,hostiles:n.hostileCount,dangerLevel:n.dangerLevel}}):t.logger.error(`Failed to activate safe mode in ${n.roomName}: ${e}`,{subsystem:"Defense",room:n.roomName,meta:{errorCode:e}})}}}e.ClusterDefenseCoordinator=n,e.clusterDefenseCoordinator=new n}(kn)),kn);Object.defineProperty(e,"ClusterDefenseCoordinator",{enumerable:!0,get:function(){return l.ClusterDefenseCoordinator}}),Object.defineProperty(e,"clusterDefenseCoordinator",{enumerable:!0,get:function(){return l.clusterDefenseCoordinator}}),Object.defineProperty(e,"coordinateClusterDefense",{enumerable:!0,get:function(){return l.coordinateClusterDefense}});var u=function(){if(vn)return Pn;vn=1,Object.defineProperty(Pn,"__esModule",{value:!0}),Pn.emergencyResponseManager=Pn.EmergencyResponseManager=Pn.EmergencyLevel=void 0;const e=Vo,t=In,r=Yo();var o;!function(e){e[e.NONE=0]="NONE",e[e.LOW=1]="LOW",e[e.MEDIUM=2]="MEDIUM",e[e.HIGH=3]="HIGH",e[e.CRITICAL=4]="CRITICAL"}(o||(Pn.EmergencyLevel=o={}));class n{constructor(){this.emergencyStates=new Map}assess(t,r){const n=this.emergencyStates.get(t.name),s=this.calculateEmergencyLevel(t,r);if(s===o.NONE&&!n)return{level:o.NONE,startedAt:Game.time,assistanceRequested:!1,boostsAllocated:!1,lastEscalation:0};let i;return n?(i=n,i.level=s):(i={level:s,startedAt:Game.time,assistanceRequested:!1,boostsAllocated:!1,lastEscalation:0},this.emergencyStates.set(t.name,i)),s===o.NONE?(n&&(e.logger.info("Emergency resolved in "+t.name,{subsystem:"Defense"}),this.emergencyStates.delete(t.name)),i):(n&&s>n.level&&(e.logger.warn(`Emergency escalated in ${t.name}: Level ${n.level}  ${s}`,{subsystem:"Defense"}),i.lastEscalation=Game.time),this.executeEmergencyResponse(t,r,i),i)}calculateEmergencyLevel(e,n){if(0===n.danger)return o.NONE;const s=e.find(FIND_HOSTILE_CREEPS),i=(0,r.filterAllyCreeps)(s),a=(0,t.analyzeDefenderNeeds)(e),c=(0,t.getCurrentDefenders)(e);if(e.find(FIND_MY_STRUCTURES,{filter:e=>(e.structureType===STRUCTURE_SPAWN||e.structureType===STRUCTURE_STORAGE||e.structureType===STRUCTURE_TERMINAL)&&e.hits<.3*e.hitsMax}).length>0)return o.CRITICAL;const l=i.filter(e=>e.body.some(e=>e.boost)),u=a.guards-c.guards+(a.rangers-c.rangers);return l.length>0&&u>=2?o.HIGH:5>i.length||0!==c.guards||0!==c.rangers?2>n.danger||1>u?1>n.danger?o.NONE:o.LOW:o.MEDIUM:o.HIGH}executeEmergencyResponse(e,t,r){r.level!==o.HIGH&&r.level!==o.CRITICAL||r.assistanceRequested||this.requestDefenseAssistance(e,t)&&(r.assistanceRequested=!0),r.level<o.MEDIUM||r.boostsAllocated||!e.controller||6>e.controller.level||(this.allocateBoostsForDefense(e,t),r.boostsAllocated=!0),this.updateDefensePosture(e,t,r)}requestDefenseAssistance(r,o){var n;if(!(0,t.needsDefenseAssistance)(r,o))return!1;const s=(0,t.createDefenseRequest)(r,o);if(!s)return!1;const i=Memory,a=(null!==(n=i.defenseRequests)&&void 0!==n?n:[]).filter(e=>e.roomName!==r.name||500>Game.time-e.createdAt);return a.push(s),i.defenseRequests=a,e.logger.warn(`Defense assistance requested for ${r.name}: ${s.guardsNeeded} guards, ${s.rangersNeeded} rangers - ${s.threat}`,{subsystem:"Defense"}),!0}allocateBoostsForDefense(t,r){var o;const n=Memory,s=null!==(o=n.boostDefensePriority)&&void 0!==o?o:{};s[t.name]=!0,n.boostDefensePriority=s,e.logger.info("Allocated boost priority for defenders in "+t.name,{subsystem:"Defense"})}updateDefensePosture(t,r,n){switch(n.level){case o.CRITICAL:"evacuate"!==r.posture&&(r.posture="war",r.pheromones.war=100,r.pheromones.defense=100,e.logger.warn(t.name+" posture: CRITICAL DEFENSE",{subsystem:"Defense"}));break;case o.HIGH:"war"!==r.posture&&"evacuate"!==r.posture&&(r.posture="defensive",r.pheromones.defense=80,r.pheromones.war=40,e.logger.info(t.name+" posture: HIGH DEFENSE",{subsystem:"Defense"}));break;case o.MEDIUM:"eco"!==r.posture&&"expand"!==r.posture||(r.posture="defensive",r.pheromones.defense=60,e.logger.info(t.name+" posture: MEDIUM DEFENSE",{subsystem:"Defense"}));break;case o.LOW:"eco"!==r.posture&&"expand"!==r.posture||(r.pheromones.defense=30,e.logger.debug(t.name+": LOW DEFENSE alert",{subsystem:"Defense"}))}}getDefenseRequests(){var e;const t=Memory,r=null!==(e=t.defenseRequests)&&void 0!==e?e:[],o=r.filter(e=>500>Game.time-e.createdAt);return o.length!==r.length&&(t.defenseRequests=o),o}clearDefenseRequest(e){var t;const r=Memory,o=(null!==(t=r.defenseRequests)&&void 0!==t?t:[]).filter(t=>t.roomName!==e);r.defenseRequests=o}getEmergencyState(e){return this.emergencyStates.get(e)}hasEmergency(e){const t=this.emergencyStates.get(e);return void 0!==t&&t.level>o.NONE}getActiveEmergencies(){const e=[];for(const[t,r]of this.emergencyStates.entries())r.level>o.NONE&&e.push({roomName:t,state:r});return e.sort((e,t)=>t.state.level-e.state.level)}}return Pn.EmergencyResponseManager=n,Pn.emergencyResponseManager=new n,Pn}();Object.defineProperty(e,"emergencyResponseManager",{enumerable:!0,get:function(){return u.emergencyResponseManager}}),Object.defineProperty(e,"EmergencyResponseManager",{enumerable:!0,get:function(){return u.EmergencyResponseManager}}),Object.defineProperty(e,"EmergencyLevel",{enumerable:!0,get:function(){return u.EmergencyLevel}});var m=function(){if(Sn)return xn;Sn=1,Object.defineProperty(xn,"__esModule",{value:!0}),xn.safeModeManager=xn.SafeModeManager=void 0;const e=Vo,t=Yo();class r{checkSafeMode(t,r){var o,n,s,i,a;if(!(null===(o=t.controller)||void 0===o?void 0:o.safeMode)&&!(null===(n=t.controller)||void 0===n?void 0:n.safeModeCooldown)&&0!==(null!==(i=null===(s=t.controller)||void 0===s?void 0:s.safeModeAvailable)&&void 0!==i?i:0)&&this.shouldTriggerSafeMode(t,r)){const r=null===(a=t.controller)||void 0===a?void 0:a.activateSafeMode();if(r===OK)e.logger.warn("SAFE MODE ACTIVATED in "+t.name,{subsystem:"Defense"});else{const o=void 0!==r?r+"":"undefined";e.logger.error(`Failed to activate safe mode in ${t.name}: ${o}`,{subsystem:"Defense"})}}}shouldTriggerSafeMode(r,o){if(2>o.danger)return!1;const n=r.find(FIND_MY_SPAWNS);for(const t of n)if(t.hits<.2*t.hitsMax)return e.logger.warn(`Spawn ${t.name} critical: ${t.hits}/${t.hitsMax}`,{subsystem:"Defense"}),!0;if(r.storage&&r.storage.hits<.2*r.storage.hitsMax)return e.logger.warn(`Storage critical: ${r.storage.hits}/${r.storage.hitsMax}`,{subsystem:"Defense"}),!0;if(r.terminal&&r.terminal.hits<.2*r.terminal.hitsMax)return e.logger.warn(`Terminal critical: ${r.terminal.hits}/${r.terminal.hitsMax}`,{subsystem:"Defense"}),!0;const s=r.find(FIND_HOSTILE_CREEPS),i=(0,t.filterAllyCreeps)(s),a=r.find(FIND_MY_CREEPS,{filter:e=>{const t=e.memory.role;return"guard"===t||"ranger"===t||"soldier"===t}});if(i.length>3*a.length)return e.logger.warn(`Overwhelmed: ${i.length} hostiles vs ${a.length} defenders`,{subsystem:"Defense"}),!0;const c=i.filter(e=>e.body.some(e=>e.boost));return c.length>0&&a.length<2*c.length&&(e.logger.warn("Boosted hostiles detected: "+c.length,{subsystem:"Defense"}),!0)}}return xn.SafeModeManager=r,xn.safeModeManager=new r,xn}();Object.defineProperty(e,"safeModeManager",{enumerable:!0,get:function(){return m.safeModeManager}}),Object.defineProperty(e,"SafeModeManager",{enumerable:!0,get:function(){return m.SafeModeManager}});var d=function(){if(_n)return $n;_n=1;var e=$n&&$n.__decorate||function(e,t,r,o){var n,s=arguments.length,i=3>s?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(3>s?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty($n,"__esModule",{value:!0}),$n.evacuationManager=$n.EvacuationManager=void 0;const t=Vo,r=Nn,o=Mn,n=An,s=Yo(),i={triggerDangerLevel:3,nukeEvacuationLeadTime:5e3,minStorageEnergy:5e4,priorityResources:[RESOURCE_ENERGY,RESOURCE_POWER,RESOURCE_GHODIUM,RESOURCE_CATALYZED_GHODIUM_ACID,RESOURCE_CATALYZED_UTRIUM_ACID,RESOURCE_CATALYZED_LEMERGIUM_ACID,RESOURCE_CATALYZED_KEANIUM_ACID,RESOURCE_CATALYZED_ZYNTHIUM_ACID,RESOURCE_OPS],maxTransfersPerTick:2};let a=class{constructor(e={}){this.evacuations=new Map,this.lastTransferTick=0,this.transfersThisTick=0,this.config={...i,...e}}run(){Game.time!==this.lastTransferTick&&(this.transfersThisTick=0,this.lastTransferTick=Game.time),this.checkEvacuationTriggers();for(const e of this.evacuations.values())e.complete||this.processEvacuation(e);for(const[e,t]of this.evacuations.entries())t.complete&&Game.time-t.startedAt>1e3&&this.evacuations.delete(e)}checkEvacuationTriggers(){var e,o,n,i;for(const a in Game.rooms){const c=Game.rooms[a];if(!(null===(e=c.controller)||void 0===e?void 0:e.my))continue;if(this.evacuations.has(a))continue;const l=r.memoryManager.getSwarmState(a);if(!l)continue;const u=c.find(FIND_NUKES);if(u.length>0){const e=u.reduce((e,t)=>{var r,o;return(null!==(r=e.timeToLand)&&void 0!==r?r:1/0)<(null!==(o=t.timeToLand)&&void 0!==o?o:1/0)?e:t});if((null!==(o=e.timeToLand)&&void 0!==o?o:1/0)<=this.config.nukeEvacuationLeadTime){l.nukeDetected||(l.nukeDetected=!0);const r=u.length;t.logger.warn(`Triggering evacuation for ${a}: ${r} nuke(s) detected, impact in ${null!==(n=e.timeToLand)&&void 0!==n?n:0} ticks`,{subsystem:"Evacuation"}),this.startEvacuation(a,"nuke",Game.time+(null!==(i=e.timeToLand)&&void 0!==i?i:0));continue}}if(l.danger>=this.config.triggerDangerLevel&&"siege"===l.posture){const e=c.find(FIND_HOSTILE_CREEPS),t=(0,s.filterAllyCreeps)(e),r=c.find(FIND_MY_CREEPS,{filter:e=>{const t=e.body.map(e=>e.type);return t.includes(ATTACK)||t.includes(RANGED_ATTACK)}});if(t.length>3*r.length){this.startEvacuation(a,"siege");continue}}}}startEvacuation(e,o,n){var s;if(this.evacuations.has(e))return!1;const i=Game.rooms[e];if(!i||!(null===(s=i.controller)||void 0===s?void 0:s.my))return!1;const a=this.findEvacuationTarget(e);if(!a)return t.logger.error(`Cannot evacuate ${e}: no valid target room found`,{subsystem:"Evacuation"}),!1;const c={roomName:e,reason:o,startedAt:Game.time,targetRoom:a,resourcesEvacuated:[],creepsRecalled:[],progress:0,complete:!1,deadline:n};this.evacuations.set(e,c);const l=r.memoryManager.getSwarmState(e);return l&&(l.posture="evacuate"),t.logger.warn(`Starting evacuation of ${e} (${o}), target: ${a}`+(n?`, deadline: ${n-Game.time} ticks`:""),{subsystem:"Evacuation"}),!0}findEvacuationTarget(e){var t,r;const o=Object.values(Game.rooms).filter(t=>{var r;return(null===(r=t.controller)||void 0===r?void 0:r.my)&&t.name!==e});if(0===o.length)return null;const n=o.map(t=>{var r,o;let n=0;if(!t.terminal)return{room:t,score:-1e3};n-=10*Game.map.getRoomLinearDistance(e,t.name);const i=t.terminal.store.getFreeCapacity();if(n+=10*Math.min(100,i/1e4),n+=5*(null!==(o=null===(r=t.controller)||void 0===r?void 0:r.level)&&void 0!==o?o:0),t.storage){n+=50;const e=t.storage.store.getFreeCapacity();n+=5*Math.min(100,e/5e4)}const a=t.find(FIND_HOSTILE_CREEPS),c=(0,s.filterAllyCreeps)(a);return c.length>0&&(n-=20*c.length),{room:t,score:n}}).filter(e=>e.score>-500).sort((e,t)=>t.score-e.score);return n.length>0&&null!==(r=null===(t=n[0])||void 0===t?void 0:t.room.name)&&void 0!==r?r:null}processEvacuation(e){const r=Game.rooms[e.roomName],o=Game.rooms[e.targetRoom];if(!r)return e.complete=!0,void t.logger.error(`Lost room ${e.roomName} during evacuation`,{subsystem:"Evacuation"});this.transfersThisTick<this.config.maxTransfersPerTick&&this.transferResources(e,r,o),this.recallCreeps(e,r),e.progress=this.calculateProgress(e,r),100>e.progress||(e.complete=!0,t.logger.info(`Evacuation of ${e.roomName} complete: `+e.resourcesEvacuated.reduce((e,t)=>e+t.amount,0)+" resources, "+e.creepsRecalled.length+" creeps",{subsystem:"Evacuation"})),e.deadline&&Game.time>=e.deadline&&(e.complete=!0,t.logger.warn(`Evacuation of ${e.roomName} reached deadline`,{subsystem:"Evacuation"}))}transferResources(e,r,o){const n=r.terminal,s=null==o?void 0:o.terminal;if(!n||!s)return;const i=Game.map.getRoomLinearDistance(r.name,e.targetRoom),a=e=>Math.ceil(e*(1-Math.exp(-i/30)));for(const o of this.config.priorityResources){const i=n.store.getUsedCapacity(o);if(0>=i)continue;const c=s.store.getFreeCapacity(o);if(0>=c)continue;const l=a(i),u=n.store.getUsedCapacity(RESOURCE_ENERGY);if(o!==RESOURCE_ENERGY&&l>u)continue;const m=Math.min(i,c,5e4);if(m>0&&n.send(o,m,e.targetRoom)===OK)return e.resourcesEvacuated.push({resourceType:o,amount:m}),this.transfersThisTick++,void t.logger.debug(`Evacuated ${m} ${o} from ${r.name} to ${e.targetRoom}`,{subsystem:"Evacuation"})}for(const t of Object.keys(n.store)){if(this.config.priorityResources.includes(t))continue;const r=n.store.getUsedCapacity(t);if(0>=r)continue;const o=s.store.getFreeCapacity(t);if(0>=o)continue;const i=a(r),c=n.store.getUsedCapacity(RESOURCE_ENERGY);if(t!==RESOURCE_ENERGY&&i>c)continue;const l=Math.min(r,o,5e4);if(l>0&&n.send(t,l,e.targetRoom)===OK)return e.resourcesEvacuated.push({resourceType:t,amount:l}),void this.transfersThisTick++}}recallCreeps(e,t){for(const r of t.find(FIND_MY_CREEPS)){const t=r.memory;t.evacuating||(t.evacuating=!0,t.evacuationTarget=e.targetRoom,e.creepsRecalled.push(r.name))}}calculateProgress(e,t){const r=t.terminal,o=t.storage;let n=0,s=0;r&&(n+=1e5,s+=r.store.getUsedCapacity()),o&&(n+=o.store.getCapacity(),s+=o.store.getUsedCapacity());const i=n>0?Math.min(100,(n-s)/n*100):100,a=t.find(FIND_MY_CREEPS).length,c=e.creepsRecalled.length>0?Math.min(100,(e.creepsRecalled.length-a)/e.creepsRecalled.length*100):100;return Math.round((i+c)/2)}cancelEvacuation(e){const o=this.evacuations.get(e);if(!o)return;this.evacuations.delete(e);for(const e of o.creepsRecalled){const t=Game.creeps[e];if(t){const e=t.memory;delete e.evacuating,delete e.evacuationTarget}}const n=r.memoryManager.getSwarmState(e);n&&(n.posture="eco"),t.logger.info(`Evacuation of ${e} cancelled`,{subsystem:"Evacuation"})}getEvacuationState(e){return this.evacuations.get(e)}isEvacuating(e){const t=this.evacuations.get(e);return void 0!==t&&!t.complete}getActiveEvacuations(){return Array.from(this.evacuations.values()).filter(e=>!e.complete)}};return $n.EvacuationManager=a,e([(0,o.MediumFrequencyProcess)("cluster:evacuation","Evacuation Manager",{priority:n.ProcessPriority.HIGH,interval:5,minBucket:0,cpuBudget:.02})],a.prototype,"run",null),$n.EvacuationManager=a=e([(0,o.ProcessClass)()],a),$n.evacuationManager=new a,$n}();Object.defineProperty(e,"evacuationManager",{enumerable:!0,get:function(){return d.evacuationManager}}),Object.defineProperty(e,"EvacuationManager",{enumerable:!0,get:function(){return d.EvacuationManager}})}(Ho)),Ho);const Ln={updateInterval:10,minBucket:0,resourceBalanceThreshold:1e4,minTerminalEnergy:5e4};let Dn=class{constructor(e={}){this.lastRun=new Map,this.config={...Ln,...e}}run(){const e=Wt.getClusters();for(const t in e){const r=e[t];if(this.shouldRunCluster(t))try{this.runCluster(r),this.lastRun.set(t,Game.time)}catch(e){const r=e instanceof Error?e.message:e+"";de.error(`Cluster ${t} error: ${r}`,{subsystem:"Cluster"})}}}shouldRunCluster(e){var t;const r=null!==(t=this.lastRun.get(e))&&void 0!==t?t:0;return Game.time-r>=this.config.updateInterval}runCluster(e){const t=Game.cpu.getUsed();Ye.unifiedStats.measureSubsystem(`cluster:${e.id}:metrics`,()=>{this.updateClusterMetrics(e)}),Ye.unifiedStats.measureSubsystem(`cluster:${e.id}:defense`,()=>{this.processDefenseRequests(e),Gn.coordinateClusterDefense(e.id)}),Ye.unifiedStats.measureSubsystem(`cluster:${e.id}:terminals`,()=>{this.balanceTerminalResources(e)}),Ye.unifiedStats.measureSubsystem(`cluster:${e.id}:resourceSharing`,()=>{yo.processCluster(e)}),Ye.unifiedStats.measureSubsystem(`cluster:${e.id}:squads`,()=>{this.updateSquads(e)}),Ye.unifiedStats.measureSubsystem(`cluster:${e.id}:offensive`,()=>{this.updateOffensiveOperations(e)}),Ye.unifiedStats.measureSubsystem(`cluster:${e.id}:rallyPoints`,()=>{!function(e){e.rallyPoints=e.rallyPoints.filter(t=>!(!t.lastUsed||Game.time-t.lastUsed>=1e3)||!!e.squads.some(e=>e.rallyRoom===t.roomName&&"dissolving"!==e.state)||"defense"===t.purpose);for(const t of e.memberRooms){const r=Game.rooms[t];if(r&&!e.rallyPoints.find(e=>e.roomName===t&&"defense"===e.purpose)){const o=Do(r,"defense");o&&(e.rallyPoints.push(o),de.debug(`Created defense rally point for ${t} at ${o.x},${o.y}`,{subsystem:"RallyPoint"}))}}}(e)}),Ye.unifiedStats.measureSubsystem(`cluster:${e.id}:militaryResources`,()=>{!function(e){for(const t of e.memberRooms){const e=Wt.getSwarmState(t);if(!e)continue;const r=_o(t,e.danger);r>0&&Game.time%100==0&&de.debug(`Military energy reservation for ${t}: ${r} (danger ${e.danger})`,{subsystem:"MilitaryPool"})}}(e)}),Ye.unifiedStats.measureSubsystem(`cluster:${e.id}:role`,()=>{this.updateClusterRole(e)}),Ye.unifiedStats.measureSubsystem(`cluster:${e.id}:focusRoom`,()=>{this.updateFocusRoom(e)}),e.lastUpdate=Game.time;const r=Game.cpu.getUsed()-t;r>1&&Game.time%50==0&&de.debug(`Cluster ${e.id} tick: ${r.toFixed(2)} CPU`,{subsystem:"Cluster"})}updateClusterMetrics(e){let t=0,r=0,o=0,n=0,s=0;for(const i of e.memberRooms){const e=Wt.getSwarmState(i);if(!e)continue;t+=e.metrics.energyHarvested,r+=e.metrics.energySpawning+e.metrics.energyConstruction+e.metrics.energyRepair,o+=25*e.danger;const a=Game.rooms[i];(null==a?void 0:a.storage)?n+=a.storage.store.getUsedCapacity(RESOURCE_ENERGY)/a.storage.store.getCapacity()*100:n+=e.metrics.energyHarvested>0?50:0,s++}s>0&&(e.metrics.energyIncome=t/s,e.metrics.energyConsumption=r/s,e.metrics.energyBalance=e.metrics.energyIncome-e.metrics.energyConsumption,e.metrics.warIndex=Math.min(100,o/s),e.metrics.economyIndex=Math.min(100,n/s)),e.metrics.militaryReadiness=this.calculateMilitaryReadiness(e)}calculateMilitaryReadiness(e){var t;let r=0,o=0;for(const n of e.memberRooms){const e=Game.rooms[n];if(!e||!(null===(t=e.controller)||void 0===t?void 0:t.my))continue;r+=e.find(FIND_MY_CREEPS,{filter:e=>"military"===e.memory.family}).length;const s=e.controller.level;o+=Math.max(2,Math.floor(s/2))}return 0===o?0:Math.min(100,Math.round(r/o*100))}balanceTerminalResources(e){const t=[];for(const r of e.memberRooms){const e=Game.rooms[r];(null==e?void 0:e.terminal)&&e.terminal.my&&t.push({room:e,terminal:e.terminal})}if(t.length>=2&&(this.balanceResource(t,RESOURCE_ENERGY),Game.time%50==0)){const e=[RESOURCE_HYDROGEN,RESOURCE_OXYGEN,RESOURCE_UTRIUM,RESOURCE_LEMERGIUM,RESOURCE_KEANIUM,RESOURCE_ZYNTHIUM,RESOURCE_CATALYST];for(const r of e)this.balanceResource(t,r)}}balanceResource(e,t){let r=0;for(const{terminal:o}of e)r+=o.store.getUsedCapacity(t);const o=r/e.length,n=e.filter(e=>e.terminal.store.getUsedCapacity(t)>o+this.config.resourceBalanceThreshold),s=e.filter(e=>e.terminal.store.getUsedCapacity(t)<o-this.config.resourceBalanceThreshold);if(0!==n.length&&0!==s.length)for(const e of n)if(!(e.terminal.cooldown>0||t===RESOURCE_ENERGY&&e.terminal.store.getUsedCapacity(RESOURCE_ENERGY)<this.config.minTerminalEnergy+this.config.resourceBalanceThreshold))for(const r of s){const n=Math.min(e.terminal.store.getUsedCapacity(t)-o,o-r.terminal.store.getUsedCapacity(t),1e4);if(n>1e3&&e.terminal.send(t,n,r.room.name)===OK){de.debug(`Transferred ${n} ${t} from ${e.room.name} to ${r.room.name}`,{subsystem:"Cluster"});break}}}updateSquads(e){for(const t of e.squads)vo(t),Co(t)&&(t.state="dissolving");e.squads=e.squads.filter(e=>"dissolving"!==e.state),this.autoCreateDefenseSquads(e)}autoCreateDefenseSquads(e){const t=e.defenseRequests.filter(t=>!e.squads.some(e=>"defense"===e.type&&e.targetRooms.includes(t.roomName))&&t.urgency>=2);for(const r of t){const t=To(e,r);e.squads.push(t)}}updateOffensiveOperations(e){Game.time%100==0&&function(e){if("war"!==e.role&&"mixed"!==e.role)return;const t=Array.from(Go.values()).filter(t=>t.clusterId===e.id&&"complete"!==t.state&&"failed"!==t.state);if(t.length>=2)return void de.debug(`Cluster ${e.id} at max operations (${t.length})`,{subsystem:"Offensive"});const r=function(e,t=10,r=5,o={}){var n,s;const i={...Ao,...o},a=[],c=Wt.getEmpire(),l=c.knownRooms,u=new Set(c.warTargets);for(const r in l){const o=l[r];if(!o.scouted)continue;if("self"===o.owner)continue;if(o.isHighway||o.isSK)continue;const c=ko(e,r);if(c>t)continue;const m=null!==(s=null===(n=Memory.lastAttacked)||void 0===n?void 0:n[r])&&void 0!==s?s:0;if(5e3>Game.time-m)continue;const d=wo(o,c,u.has(r),i);let p="neutral";o.owner&&(p=u.has(o.owner)||u.has(r)?"enemy":"hostile");const g=Uo(r,{towerCount:o.towerCount,spawnCount:o.spawnCount,rcl:o.controllerLevel,owner:o.owner});a.push({roomName:r,score:d,distance:c,doctrine:g,type:p,intel:o})}a.sort((e,t)=>t.score-e.score);const m=a.slice(0,r);return m.length>0&&de.info(`Found ${m.length} attack targets for cluster ${e.id}: `+m.map(e=>`${e.roomName}(${e.score.toFixed(0)})`).join(", "),{subsystem:"AttackTarget"}),m}(e,10,3);if(0===r.length)return void de.debug("No attack targets found for cluster "+e.id,{subsystem:"Offensive"});const o=r[0];Mo(e,o.doctrine)?function(e,t,r){if(!function(e){const t=Wt.getEmpire().knownRooms[e];return t?5e3>=Game.time-t.lastSeen||(de.warn(`Intel for ${e} is stale (${Game.time-t.lastSeen} ticks old)`,{subsystem:"AttackTarget"}),!1):(de.warn("No intel for target "+e,{subsystem:"AttackTarget"}),!1)}(t))return de.warn("Invalid target "+t,{subsystem:"Offensive"}),null;const o=Wt.getEmpire().knownRooms[t],n=null!=r?r:Uo(t,{towerCount:null==o?void 0:o.towerCount,spawnCount:null==o?void 0:o.spawnCount,rcl:null==o?void 0:o.controllerLevel,owner:null==o?void 0:o.owner});if(!Mo(e,n))return de.warn(`Cannot launch ${n} operation on ${t} - insufficient resources`,{subsystem:"Offensive"}),null;const s=`op_${e.id}_${t}_${Game.time}`,i={id:s,clusterId:e.id,targetRoom:t,doctrine:n,squadIds:[],state:"planning",createdAt:Game.time,lastUpdate:Game.time};Go.set(s,i);const a=function(e,t,r,o){const n=function(e,t){var r,o;const n={guards:2,rangers:3,healers:2,siegeUnits:1};if(t){const e=null!==(r=t.towerCount)&&void 0!==r?r:0,s=null!==(o=t.spawnCount)&&void 0!==o?o:0;3>e||(n.healers+=1),2>e||2>s||(n.siegeUnits+=1),2>s||(n.guards+=1)}return n}(0,o),s=`${r}_${t}_${Game.time}`,i=Eo(e,t);let a=.3;"harass"===r?a=.5:"raid"===r?a=.4:"siege"===r&&(a=.3);const c={id:s,type:r,members:[],rallyRoom:i,targetRooms:[t],state:"gathering",createdAt:Game.time,retreatThreshold:a};return de.info(`Created ${r} squad ${s} for ${t}: ${n.guards}G/${n.rangers}R/${n.healers}H/${n.siegeUnits}S rally at ${i}`,{subsystem:"Squad"}),c}(e,t,"harassment"===n?"harass":n,{towerCount:null==o?void 0:o.towerCount,spawnCount:null==o?void 0:o.spawnCount});var c;e.squads.push(a),i.squadIds.push(a.id),function(e,t){const r=t.id;if(Po.has(r))return void de.debug(`Squad ${r} already forming`,{subsystem:"SquadFormation"});let o;if("defense"===t.type)o={harassers:0,soldiers:2,rangers:2,healers:1,siegeUnits:0};else{const e="harass"===t.type?"harassment":t.type;o=Oo[e].composition}const n={};o.harassers>0&&(n.harasser=o.harassers),o.soldiers>0&&(n.soldier=o.soldiers),o.rangers>0&&(n.ranger=o.rangers),o.healers>0&&(n.healer=o.healers),o.siegeUnits>0&&(n.siegeUnit=o.siegeUnits);const s={squadId:r,targetComposition:n,currentComposition:{},spawnRequests:new Set,formationStarted:Game.time};Po.set(r,s);const i=Game.rooms[t.rallyRoom];i?(function(e,t,r,o){let n=!1;if("defense"!==t.type){const e="harass"===t.type?"harassment":t.type;n=Oo[e].useBoosts}let s=or.NORMAL;"siege"===t.type?s=or.HIGH:"defense"===t.type&&(s=or.EMERGENCY);const i=(r,i)=>{for(let a=0;i>a;a++){const i=Io(r,0,e.energyCapacityAvailable),c=i.reduce((e,t)=>e+No[t],0),l=n?$o(r):[],u={id:`${t.id}_${r}_${a}_${Game.time}`,roomName:e.name,role:r,family:"military",body:{parts:i,cost:c,minCapacity:c},priority:s,targetRoom:t.targetRooms[0],boostRequirements:l.length>0?l.map(e=>({resourceType:e.compound,bodyParts:i.filter(t=>e.parts.includes(t))})):void 0,createdAt:Game.time,additionalMemory:{squadId:t.id}};nr.addRequest(u),o.spawnRequests.add(u.id)}};r.harassers>0&&i("harasser",r.harassers),r.soldiers>0&&i("soldier",r.soldiers),r.rangers>0&&i("ranger",r.rangers),r.healers>0&&i("healer",r.healers),r.siegeUnits>0&&i("siegeUnit",r.siegeUnits)}(i,t,o,s),de.info(`Started forming squad ${r}: ${JSON.stringify(n)}`,{subsystem:"SquadFormation"})):de.warn(`Rally room ${t.rallyRoom} not visible for squad ${r}`,{subsystem:"SquadFormation"})}(0,a),i.state="forming",c=t,Memory.lastAttacked||(Memory.lastAttacked={}),Memory.lastAttacked[c]=Game.time,de.info(`Marked ${c} as attacked at tick ${Game.time}`,{subsystem:"AttackTarget"}),de.info(`Launched ${n} operation ${s} on ${t} with squad ${a.id}`,{subsystem:"Offensive"})}(e,o.roomName,o.doctrine):de.info(`Cluster ${e.id} cannot launch ${o.doctrine} doctrine (insufficient resources)`,{subsystem:"Offensive"})}(e),function(){!function(){const e=Game.time;for(const[t,r]of Po.entries()){const o=e-r.formationStarted;o>500&&(de.warn(`Squad ${t} formation timed out after ${o} ticks`,{subsystem:"SquadFormation"}),Po.delete(t))}}();for(const[e,t]of Go.entries())Lo(t);!function(){for(const[e,t]of Go.entries()){const r=Game.time-t.createdAt;"complete"!==t.state&&"failed"!==t.state||5e3>=r||(Go.delete(e),de.debug("Cleaned up operation "+e,{subsystem:"Offensive"}))}}()}()}updateClusterRole(e){const{warIndex:t,economyIndex:r}=e.metrics;e.role=t>50?"war":r>70&&20>t?"economic":40>r?"frontier":"mixed"}updateFocusRoom(e){var t,r;const o=[];for(const r of e.memberRooms){const e=Game.rooms[r];e&&(null===(t=e.controller)||void 0===t?void 0:t.my)&&o.push({roomName:r,rcl:e.controller.level})}if(0!==o.length){if(e.focusRoom){const t=Game.rooms[e.focusRoom];8===(null===(r=null==t?void 0:t.controller)||void 0===r?void 0:r.level)&&(de.info(`Focus room ${e.focusRoom} reached RCL 8, selecting next room`,{subsystem:"Cluster"}),e.focusRoom=void 0),t||(de.warn(`Focus room ${e.focusRoom} no longer valid, selecting new focus`,{subsystem:"Cluster"}),e.focusRoom=void 0)}if(!e.focusRoom){const t=o.filter(e=>8>e.rcl);if(0===t.length)return;t.sort((e,t)=>e.rcl!==t.rcl?e.rcl-t.rcl:e.roomName.localeCompare(t.roomName)),e.focusRoom=t[0].roomName,de.info(`Selected ${e.focusRoom} (RCL ${t[0].rcl}) as focus room for upgrading`,{subsystem:"Cluster"})}}}createCluster(e){const t="cluster_"+e,r=Wt.getCluster(t,e);if(!r)throw Error("Failed to create cluster for "+e);return de.info(`Created cluster ${t} with core room ${e}`,{subsystem:"Cluster"}),r}addRoomToCluster(e,t,r=!1){const o=Wt.getCluster(e);o?r?o.remoteRooms.includes(t)||(o.remoteRooms.push(t),de.info(`Added remote room ${t} to cluster ${e}`,{subsystem:"Cluster"})):o.memberRooms.includes(t)||(o.memberRooms.push(t),de.info(`Added member room ${t} to cluster ${e}`,{subsystem:"Cluster"})):de.error(`Cluster ${e} not found`,{subsystem:"Cluster"})}processDefenseRequests(e){var t;e.defenseRequests=e.defenseRequests.filter(e=>{const t=Game.time-e.createdAt;if(t>500)return de.debug(`Defense request for ${e.roomName} expired (${t} ticks old)`,{subsystem:"Cluster"}),!1;const r=Game.rooms[e.roomName];return!(!r||0===r.find(FIND_HOSTILE_CREEPS).length&&(de.info(`Defense request for ${e.roomName} resolved - no more hostiles`,{subsystem:"Cluster"}),1))});for(const t of e.defenseRequests)if(t.urgency>=3){const r=Game.rooms[t.roomName];r&&r.storage&&1e4>r.storage.store.getUsedCapacity(RESOURCE_ENERGY)&&bo(e,t.roomName,2e4)}for(const r of e.memberRooms){const o=Game.rooms[r];if(!o||!(null===(t=o.controller)||void 0===t?void 0:t.my))continue;const n=Wt.getSwarmState(r);if(n&&qt(o,n)){const t=e.defenseRequests.find(e=>e.roomName===r);if(t){const e=zt(o,n);e&&e.urgency>t.urgency&&(t.urgency=e.urgency,t.guardsNeeded=e.guardsNeeded,t.rangersNeeded=e.rangersNeeded,t.healersNeeded=e.healersNeeded,t.threat=e.threat)}else{const t=zt(o,n);t&&e.defenseRequests.push({...t,assignedCreeps:[]})}}}this.assignDefendersToRequests(e)}assignDefendersToRequests(e){if(0===e.defenseRequests.length)return;const t=[...e.defenseRequests].sort((e,t)=>t.urgency-e.urgency),r=[];for(const o of t){if(!Game.rooms[o.roomName])continue;for(const t of e.memberRooms){if(t===o.roomName)continue;const e=Game.rooms[t];if(!e)continue;const n=e.find(FIND_MY_CREEPS);for(const s of n){const n=s.memory;if("military"!==n.family)continue;if(n.assistTarget)continue;if(o.assignedCreeps.includes(s.name))continue;const i=o.guardsNeeded>0,a=o.rangersNeeded>0,c=o.healersNeeded>0,l="guard"===n.role,u="ranger"===n.role,m="healer"===n.role;if(i&&l||a&&u||c&&m){const n=Game.map.getRoomLinearDistance(t,o.roomName);r.push({creep:s,room:e,distance:n,targetRoom:o.roomName})}}}r.sort((e,t)=>e.distance-t.distance);const t=o.guardsNeeded+o.rangersNeeded+o.healersNeeded,n=Math.min(t,r.length);for(let e=0;n>e;e++){const t=r[e];t&&(t.creep.memory.assistTarget=o.roomName,o.assignedCreeps.push(t.creep.name),de.info(`Assigned ${t.creep.name} (${t.creep.memory.role}) from ${t.room.name} to assist ${o.roomName} (distance: ${t.distance})`,{subsystem:"Cluster"}),"guard"===t.creep.memory.role&&o.guardsNeeded--,"ranger"===t.creep.memory.role&&o.rangersNeeded--,"healer"===t.creep.memory.role&&o.healersNeeded--)}for(let e=r.length-1;e>=0;e--)o.assignedCreeps.includes(r[e].creep.name)&&r.splice(e,1)}}};Q([pr("cluster:manager","Cluster Manager",{priority:Be.MEDIUM,interval:10,minBucket:0,cpuBudget:.03})],Dn.prototype,"run",null),Dn=Q([hr()],Dn);const Fn=new Dn;var Bn,Hn,Wn={},Yn={},Kn={},jn={},Vn=m(Ct);function qn(){if(Hn)return jn;Hn=1;var e=jn&&jn.__decorate||function(e,t,r,o){var n,s=arguments.length,i=3>s?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(3>s?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(jn,"__esModule",{value:!0}),jn.marketManager=jn.MarketManager=void 0;const t=Nn,r=Vo,o=Mn,n=An,s=Vn,i={updateInterval:100,priceUpdateInterval:500,minBucket:0,minCredits:1e4,emergencyCredits:5e3,tradingCredits:5e4,warPriceMultiplier:2,buyPriceThreshold:.85,sellPriceThreshold:1.15,maxPriceHistory:30,rollingAverageWindow:10,lowPriceMultiplier:.9,highPriceMultiplier:1.1,trendChangeThreshold:.05,buyOpportunityAdjustment:1.02,sellOpportunityAdjustment:.98,sellThresholds:{[RESOURCE_ENERGY]:5e5,[RESOURCE_HYDROGEN]:2e4,[RESOURCE_OXYGEN]:2e4,[RESOURCE_UTRIUM]:2e4,[RESOURCE_LEMERGIUM]:2e4,[RESOURCE_KEANIUM]:2e4,[RESOURCE_ZYNTHIUM]:2e4,[RESOURCE_CATALYST]:2e4},buyThresholds:{[RESOURCE_ENERGY]:1e5,[RESOURCE_HYDROGEN]:5e3,[RESOURCE_OXYGEN]:5e3,[RESOURCE_UTRIUM]:5e3,[RESOURCE_LEMERGIUM]:5e3,[RESOURCE_KEANIUM]:5e3,[RESOURCE_ZYNTHIUM]:5e3,[RESOURCE_CATALYST]:5e3},trackedResources:[RESOURCE_ENERGY,RESOURCE_HYDROGEN,RESOURCE_OXYGEN,RESOURCE_UTRIUM,RESOURCE_LEMERGIUM,RESOURCE_KEANIUM,RESOURCE_ZYNTHIUM,RESOURCE_CATALYST,RESOURCE_GHODIUM,RESOURCE_POWER],criticalResources:[RESOURCE_ENERGY,RESOURCE_GHODIUM],emergencyBuyThreshold:5e3,orderExtensionAge:5e3,maxTransportCostRatio:.3};let a=class{constructor(e={}){this.lastRun=0,this.config={...i,...e}}run(){this.lastRun=Game.time,this.ensureMarketMemory(),Game.time%this.config.priceUpdateInterval===0&&this.updatePriceTracking(),this.updateOrderStats(),this.reconcilePendingArbitrage(),this.handleEmergencyBuying(),this.cancelOldOrders(),this.manageExistingOrders(),this.updateBuyOrders(),this.updateSellOrders(),this.checkArbitrageOpportunities(),this.executeDeal(),Game.time%200==0&&this.balanceResourcesAcrossRooms()}ensureMarketMemory(){const e=t.memoryManager.getEmpire();e.market||(e.market=(0,s.createDefaultMarketMemory)()),e.market.orders||(e.market.orders={}),void 0===e.market.totalProfit&&(e.market.totalProfit=0),e.market.lastBalance||(e.market.lastBalance=0),e.market.pendingArbitrage||(e.market.pendingArbitrage=[]),void 0===e.market.completedArbitrage&&(e.market.completedArbitrage=0),void 0===e.market.arbitrageProfit&&(e.market.arbitrageProfit=0)}updatePriceTracking(){const e=t.memoryManager.getEmpire();if(e.market){for(const e of this.config.trackedResources)this.updateResourcePrice(e);e.market.lastScan=Game.time,r.logger.debug(`Updated market prices for ${this.config.trackedResources.length} resources`,{subsystem:"Market"})}}updateResourcePrice(e){const r=t.memoryManager.getEmpire();if(!r.market)return;const o=Game.market.getHistory(e);if(0===o.length)return;const n=o[o.length-1];let s=r.market.resources[e];s||(s={resource:e,priceHistory:[],avgPrice:n.avgPrice,trend:0,lastUpdate:Game.time},r.market.resources[e]=s);const i={tick:Game.time,avgPrice:n.avgPrice,lowPrice:n.avgPrice*this.config.lowPriceMultiplier,highPrice:n.avgPrice*this.config.highPriceMultiplier};s.priceHistory.push(i),s.priceHistory.length>this.config.maxPriceHistory&&s.priceHistory.shift();const a=s.priceHistory.slice(-this.config.rollingAverageWindow);if(s.avgPrice=a.reduce((e,t)=>e+t.avgPrice,0)/a.length,s.priceHistory.length>=5){const e=s.priceHistory.slice(-5,-2).reduce((e,t)=>e+t.avgPrice,0)/3,t=(s.priceHistory.slice(-3).reduce((e,t)=>e+t.avgPrice,0)/3-e)/e;t>this.config.trendChangeThreshold?s.trend=1:t<-this.config.trendChangeThreshold?s.trend=-1:s.trend=0}if(a.length>=5){const e=s.avgPrice,t=a.reduce((t,r)=>t+Math.pow(r.avgPrice-e,2),0)/a.length,r=Math.sqrt(t);s.volatility=r/e}if(s.priceHistory.length>=3){const e=s.priceHistory.slice(-3),t=(e[2].avgPrice-e[0].avgPrice)/2;s.predictedPrice=e[2].avgPrice+t}s.lastUpdate=Game.time}getMarketData(e){var r;return null===(r=t.memoryManager.getEmpire().market)||void 0===r?void 0:r.resources[e]}isBuyOpportunity(e){const t=this.getMarketData(e);if(!t)return!1;const r=Game.market.getHistory(e);if(0===r.length)return!1;const o=r[r.length-1].avgPrice;return t.avgPrice*this.config.buyPriceThreshold>=o}isSellOpportunity(e){const t=this.getMarketData(e);if(!t)return!1;const r=Game.market.getHistory(e);return 0!==r.length&&r[r.length-1].avgPrice>=t.avgPrice*this.config.sellPriceThreshold}cancelOldOrders(){const e=Game.market.orders;for(const t in e){const o=e[t];Game.time-o.created>1e4&&(Game.market.cancelOrder(t),r.logger.info(`Cancelled old order: ${o.type} ${o.resourceType}`,{subsystem:"Market"})),100>o.remainingAmount&&Game.market.cancelOrder(t)}}updateBuyOrders(){var e,o,n;const s=t.memoryManager.getEmpire().objectives.warMode,i={};for(const t in Game.rooms){const r=Game.rooms[t];if(r.terminal&&(null===(e=r.controller)||void 0===e?void 0:e.my))for(const e in r.terminal.store)i[e]=(null!==(o=i[e])&&void 0!==o?o:0)+r.terminal.store[e]}for(const e in this.config.buyThresholds){const t=this.config.buyThresholds[e],o=null!==(n=i[e])&&void 0!==n?n:0;if(t>o){const n=this.isBuyOpportunity(e);s||n?this.createBuyOrder(e,t-o,s,n):r.logger.debug(`Skipping buy for ${e}: waiting for better price`,{subsystem:"Market"})}}}createBuyOrder(e,t,o,n){var s;if(Object.values(Game.market.orders).filter(t=>t.type===ORDER_BUY&&t.resourceType===e).length>0)return;const i=Game.market.getHistory(e);if(0===i.length)return;const a=i[i.length-1].avgPrice,c=this.getMarketData(e);let l;if(l=o?a*this.config.warPriceMultiplier:n&&c?a*this.config.buyOpportunityAdjustment:null!==(s=null==c?void 0:c.avgPrice)&&void 0!==s?s:a*this.config.highPriceMultiplier,Game.market.credits<this.config.minCredits)return;const u=Object.values(Game.rooms).find(e=>{var t;return e.terminal&&(null===(t=e.controller)||void 0===t?void 0:t.my)});if((null==u?void 0:u.terminal)&&Game.market.createOrder({type:ORDER_BUY,resourceType:e,price:l,totalAmount:Math.min(t,1e4),roomName:u.name})===OK){const s=n?" (LOW PRICE!)":o?" (WAR MODE)":"";r.logger.info(`Created buy order: ${t} ${e} at ${l.toFixed(3)} credits${s}`,{subsystem:"Market"})}}sellSurplusFromTerminal(e,o,n){var s;const i=Game.rooms[e];if(!(null==i?void 0:i.terminal)||!(null===(s=i.controller)||void 0===s?void 0:s.my))return r.logger.warn(`Cannot sell from ${e}: no terminal or not owned`,{subsystem:"Market"}),!1;const a=i.terminal.store.getUsedCapacity(o);if(n>a)return r.logger.debug(`Cannot sell ${n} ${o} from ${e}: only ${a} available`,{subsystem:"Market"}),!1;const c=t.memoryManager.getEmpire();if(!c.market){const t=.5;return Game.market.createOrder({type:ORDER_SELL,resourceType:o,price:t,totalAmount:n,roomName:e})===OK}const l=c.market.resources[o];let u=.5;if(null==l?void 0:l.avgPrice)u=.95*l.avgPrice;else{const e=Game.market.getAllOrders({type:ORDER_BUY,resourceType:o});e.length>0&&(e.sort((e,t)=>t.price-e.price),u=e[0].price)}const m=Game.market.createOrder({type:ORDER_SELL,resourceType:o,price:u,totalAmount:n,roomName:e});return m===OK?(r.logger.info(`Created surplus sell order: ${n} ${o} from ${e} at ${u.toFixed(3)} credits/unit`,{subsystem:"Market"}),!0):(r.logger.warn(`Failed to create sell order: ${m} for ${n} ${o} from ${e}`,{subsystem:"Market"}),!1)}updateSellOrders(){var e,t,o;const n={};for(const r in Game.rooms){const o=Game.rooms[r];if(o.terminal&&(null===(e=o.controller)||void 0===e?void 0:e.my))for(const e in o.terminal.store)n[e]=(null!==(t=n[e])&&void 0!==t?t:0)+o.terminal.store[e]}for(const e in this.config.sellThresholds){const t=this.config.sellThresholds[e],s=null!==(o=n[e])&&void 0!==o?o:0;if(s>t){const o=this.isSellOpportunity(e);o?this.createSellOrder(e,s-t,o):r.logger.debug(`Holding ${e} surplus: waiting for better price`,{subsystem:"Market"})}}}createSellOrder(e,t,o){var n;if(Object.values(Game.market.orders).filter(t=>t.type===ORDER_SELL&&t.resourceType===e).length>0)return;const s=Game.market.getHistory(e);if(0===s.length)return;const i=s[s.length-1].avgPrice,a=this.getMarketData(e);let c;c=o&&a?i*this.config.sellOpportunityAdjustment:null!==(n=null==a?void 0:a.avgPrice)&&void 0!==n?n:i*this.config.lowPriceMultiplier;const l=Object.values(Game.rooms).find(t=>{var r;return t.terminal&&(null===(r=t.controller)||void 0===r?void 0:r.my)&&t.terminal.store[e]>1e3});if((null==l?void 0:l.terminal)&&Game.market.createOrder({type:ORDER_SELL,resourceType:e,price:c,totalAmount:Math.min(t,1e4),roomName:l.name})===OK){const n=o?" (HIGH PRICE!)":"";r.logger.info(`Created sell order: ${t} ${e} at ${c.toFixed(3)} credits${n}`,{subsystem:"Market"})}}updateOrderStats(){var e,o;const n=t.memoryManager.getEmpire();if(!(null===(e=n.market)||void 0===e?void 0:e.orders))return;const s=Game.market.orders;for(const e in n.market.orders){const t=n.market.orders[e],i=s[e];if(i){if(void 0!==i.totalAmount){const e=i.totalAmount-i.remainingAmount,r=e-t.totalTraded;r>0&&(t.totalTraded=e,t.totalValue+=r*i.price)}}else{if(t.totalTraded>0){const e="sell"===t.type?t.totalValue:-t.totalValue;n.market.totalProfit=(null!==(o=n.market.totalProfit)&&void 0!==o?o:0)+e,r.logger.info(`Order completed: ${t.resource} ${t.type} - Traded: ${t.totalTraded}, Value: ${t.totalValue.toFixed(0)}, Profit: ${e.toFixed(0)}`,{subsystem:"Market"})}delete n.market.orders[e]}}}executeDeal(){if(Game.time%50==0&&t.memoryManager.getEmpire().objectives.warMode){const e=[RESOURCE_CATALYZED_GHODIUM_ACID,RESOURCE_CATALYZED_ZYNTHIUM_ALKALIDE,RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE,RESOURCE_CATALYZED_KEANIUM_ALKALIDE];for(const t of e){const e=Game.market.getAllOrders({type:ORDER_SELL,resourceType:t});if(e.length>0){e.sort((e,t)=>e.price-t.price);const o=e[0],n=Object.values(Game.rooms).find(e=>{var t;return e.terminal&&(null===(t=e.controller)||void 0===t?void 0:t.my)});if(n&&10>o.price){const e=Math.min(o.amount,1e3);Game.market.deal(o.id,e,n.name)===OK&&r.logger.info(`Bought ${e} ${t} for ${o.price.toFixed(3)} credits/unit`,{subsystem:"Market"})}}}}}handleEmergencyBuying(){var e,t,r;if(Game.market.credits<this.config.emergencyCredits)return;const o={};for(const r in Game.rooms){const n=Game.rooms[r];if(n.terminal&&(null===(e=n.controller)||void 0===e?void 0:e.my))for(const e in n.terminal.store)o[e]=(null!==(t=o[e])&&void 0!==t?t:0)+n.terminal.store[e]}for(const e of this.config.criticalResources){const t=null!==(r=o[e])&&void 0!==r?r:0;t<this.config.emergencyBuyThreshold&&this.executeEmergencyBuy(e,this.config.emergencyBuyThreshold-t)}}executeEmergencyBuy(e,t){const o=Game.market.getAllOrders({type:ORDER_SELL,resourceType:e});if(0===o.length)return;const n=Object.values(Game.rooms).find(e=>{var t;return e.terminal&&(null===(t=e.controller)||void 0===t?void 0:t.my)});if(!(null==n?void 0:n.terminal))return;o.sort((e,t)=>(e.roomName?e.price+Game.market.calcTransactionCost(1e3,n.name,e.roomName)/1e3:e.price)-(t.roomName?t.price+Game.market.calcTransactionCost(1e3,n.name,t.roomName)/1e3:t.price));const s=o[0],i=Math.min(t,s.amount,1e4);Game.market.deal(s.id,i,n.name)===OK&&r.logger.warn(`EMERGENCY BUY: ${i} ${e} at ${s.price.toFixed(3)} credits/unit`,{subsystem:"Market"})}manageExistingOrders(){const e=Game.market.orders;for(const t in e){const o=e[t];if(Game.time-o.created<this.config.orderExtensionAge)continue;const n=o.resourceType;if("token"===n)continue;if(!this.config.trackedResources.includes(n))continue;if(!this.getMarketData(n))continue;const s=Game.market.getHistory(n);if(0===s.length)continue;const i=s[s.length-1].avgPrice;if(o.type===ORDER_BUY){const e=i*this.config.buyOpportunityAdjustment;o.price<.9*e&&o.remainingAmount>1e3&&(Game.market.extendOrder(t,Math.min(5e3,o.remainingAmount)),r.logger.debug(`Extended buy order for ${o.resourceType}: +${o.remainingAmount} at ${o.price.toFixed(3)}`,{subsystem:"Market"}))}if(o.type===ORDER_SELL){const e=i*this.config.sellOpportunityAdjustment;o.price>1.1*e&&o.remainingAmount>1e3&&(Game.market.extendOrder(t,Math.min(5e3,o.remainingAmount)),r.logger.debug(`Extended sell order for ${o.resourceType}: +${o.remainingAmount} at ${o.price.toFixed(3)}`,{subsystem:"Market"}))}}}reconcilePendingArbitrage(){var e,o,n,s,i;const a=t.memoryManager.getEmpire().market;if(!(null==a?void 0:a.pendingArbitrage)||0===a.pendingArbitrage.length)return;const c=[];for(const t of a.pendingArbitrage){const l=Game.rooms[t.destinationRoom],u=null==l?void 0:l.terminal;if(!u||!(null===(e=null==l?void 0:l.controller)||void 0===e?void 0:e.my)){c.push(t);continue}if(Game.time<t.expectedArrival||u.cooldown>0){c.push(t);continue}const m=null!==(o=u.store[t.resource])&&void 0!==o?o:0;if(m<t.amount){c.push(t);continue}let d=!1;if(t.sellOrderId){const e=Game.market.getOrderById(t.sellOrderId);if(e&&e.remainingAmount>0&&e.roomName){const o=Math.min(t.amount,e.remainingAmount,m),c=Game.market.calcTransactionCost(o,u.room.name,e.roomName);if(u.store[RESOURCE_ENERGY]>=c&&Game.market.deal(e.id,o,u.room.name)===OK){const c=(e.price-t.buyPrice)*o;a.totalProfit=(null!==(n=a.totalProfit)&&void 0!==n?n:0)+c,a.arbitrageProfit=(null!==(s=a.arbitrageProfit)&&void 0!==s?s:0)+c,a.completedArbitrage=(null!==(i=a.completedArbitrage)&&void 0!==i?i:0)+1,r.logger.info(`Arbitrage complete: sold ${o} ${t.resource} from ${u.room.name} at ${e.price.toFixed(3)}, profit ${c.toFixed(2)}`,{subsystem:"Market"}),d=!0}}}d||Game.market.createOrder({type:ORDER_SELL,resourceType:t.resource,price:t.targetSellPrice,totalAmount:t.amount,roomName:u.room.name})===OK&&(r.logger.info(`Arbitrage posted sell order: ${t.amount} ${t.resource} at ${t.targetSellPrice.toFixed(3)} from ${u.room.name}`,{subsystem:"Market"}),d=!0),d||c.push(t)}a.pendingArbitrage=c}checkArbitrageOpportunities(){var e,o,n,s;if(Game.cpu.bucket<this.config.minBucket)return;if(Game.market.credits<this.config.tradingCredits)return;const i=t.memoryManager.getEmpire().market,a=Object.values(Game.rooms).filter(e=>{var t;return e.terminal&&(null===(t=e.controller)||void 0===t?void 0:t.my)});if(!i||0===a.length)return;const c=e=>{var t,r;return null!==(r=null!==(t=e.remainingAmount)&&void 0!==t?t:e.amount)&&void 0!==r?r:0};for(const t of this.config.trackedResources){const l=Game.market.getAllOrders({type:ORDER_BUY,resourceType:t}).filter(e=>e.remainingAmount>0&&e.roomName),u=Game.market.getAllOrders({type:ORDER_SELL,resourceType:t}).filter(e=>e.remainingAmount>0&&e.roomName);if(0===l.length||0===u.length)continue;l.sort((e,t)=>t.price-e.price),u.sort((e,t)=>e.price-t.price);const m=l[0],d=u[0];if(!m.roomName||!d.roomName)continue;if(null===(e=i.pendingArbitrage)||void 0===e?void 0:e.some(e=>e.buyOrderId===d.id||e.sellOrderId===m.id))continue;const p=Math.min(c(m),c(d),5e3);if(p>0)for(const e of a){const a=e.terminal;if(p>(null!==(o=a.store.getFreeCapacity(t))&&void 0!==o?o:0))continue;const c=Game.market.calcTransactionCost(p,e.name,d.roomName),l=(c+Game.market.calcTransactionCost(p,e.name,m.roomName))/p,u=m.price-d.price-l;if(0>=u)continue;if(l/d.price>this.config.maxTransportCostRatio)continue;if(a.store[RESOURCE_ENERGY]<c)continue;const g=d.price*p;if(Game.market.credits-g<this.config.minCredits)continue;if(Game.market.deal(d.id,p,e.name)!==OK)continue;const f={id:`${t}-${Game.time}-${d.id}`,resource:t,amount:p,buyOrderId:d.id,sellOrderId:m.id,targetSellPrice:m.price,destinationRoom:e.name,expectedArrival:Game.time+(null!==(n=a.cooldown)&&void 0!==n?n:0)+1,buyPrice:d.price,transportCost:c};null===(s=i.pendingArbitrage)||void 0===s||s.push(f),r.logger.info(`Arbitrage started: bought ${p} ${t} at ${d.price.toFixed(3)} to sell @ ${m.price.toFixed(3)} (profit/unit ~${u.toFixed(2)})`,{subsystem:"Market"});break}}}balanceResourcesAcrossRooms(){var e;const t=Object.values(Game.rooms).filter(e=>{var t;return e.terminal&&(null===(t=e.controller)||void 0===t?void 0:t.my)});if(t.length>=2)for(const o of this.config.trackedResources){const n=[];for(const r of t){if(!r.terminal)continue;const t=null!==(e=r.terminal.store[o])&&void 0!==e?e:0;n.push({room:r,amount:t})}if(2>n.length)continue;const s=n.reduce((e,t)=>e+t.amount,0)/n.length;n.sort((e,t)=>t.amount-e.amount);const i=n[0],a=n[n.length-1],c=i.amount-a.amount;if(c>.5*s&&i.amount>5e3&&i.room.terminal&&a.room.terminal){const e=Math.min(Math.floor(c/2),1e4),t=Game.market.calcTransactionCost(e,i.room.name,a.room.name);(o===RESOURCE_ENERGY&&.1*e>t||o!==RESOURCE_ENERGY&&1e3>t)&&i.room.terminal.send(o,e,a.room.name)===OK&&r.logger.info(`Balanced ${e} ${o}: ${i.room.name} -> ${a.room.name} (cost: ${t} energy)`,{subsystem:"Market"})}}}};return jn.MarketManager=a,e([(0,o.LowFrequencyProcess)("empire:market","Market Manager",{priority:n.ProcessPriority.LOW,interval:100,minBucket:0,cpuBudget:.02})],a.prototype,"run",null),jn.MarketManager=a=e([(0,o.ProcessClass)()],a),jn.marketManager=new a,jn}var zn,Xn,Qn={};function Zn(){if(zn)return Qn;zn=1,Object.defineProperty(Qn,"__esModule",{value:!0}),Qn.terminalRouter=Qn.TerminalRouter=void 0;const e=Vo;class t{constructor(){this.costCache=new Map,this.COST_CACHE_TTL=100,this.MAX_HOPS=3}buildTerminalGraph(){var e;const t=[];for(const r in Game.rooms){const o=Game.rooms[r];o&&(null===(e=o.controller)||void 0===e?void 0:e.my)&&o.terminal&&o.terminal.my&&o.terminal.isActive()&&t.push({roomName:r,terminal:o.terminal})}return t}calculateTransferCost(e,t,r){const o=`${t}:${r}:${e}`,n=this.costCache.get(o);if(n&&Game.time-n.timestamp<this.COST_CACHE_TTL)return n.cost;const s=Game.market.calcTransactionCost(e,t,r);return this.costCache.set(o,{cost:s,timestamp:Game.time}),s}findOptimalRoute(t,r,o){var n,s,i;const a=this.calculateTransferCost(o,t,r);let c={path:[t,r],cost:a,isDirect:!0};const l=this.buildTerminalGraph();if(3>l.length)return c;const u=new Map,m=new Map,d=new Set;for(const e of l)u.set(e.roomName,1/0),d.add(e.roomName);for(u.set(t,0);d.size>0;){let e=null,t=1/0;for(const r of d){const o=null!==(n=u.get(r))&&void 0!==n?n:1/0;t>o&&(t=o,e=r)}if(!e||t===1/0)break;if(e===r)break;if(d.delete(e),this.getPathLength(e,m)<this.MAX_HOPS)for(const t of l){if(!d.has(t.roomName))continue;if(t.roomName===e)continue;const r=this.calculateTransferCost(o,e,t.roomName),n=(null!==(s=u.get(e))&&void 0!==s?s:1/0)+r;(null!==(i=u.get(t.roomName))&&void 0!==i?i:1/0)>n&&(u.set(t.roomName,n),m.set(t.roomName,e))}}const p=u.get(r);if(void 0!==p&&a>p){const o=this.reconstructPath(r,m);o.length>0&&o[0]===t&&(c={path:o,cost:p,isDirect:!1},e.logger.debug(`Multi-hop route found: ${o.join(" -> ")} (cost: ${p} vs direct: ${a})`,{subsystem:"TerminalRouter"}))}return c}getPathLength(e,t){let r=0,o=e;for(;void 0!==o&&t.has(o)&&(r++,o=t.get(o),r<=this.MAX_HOPS););return r}reconstructPath(e,t){const r=[];let o=e;for(;void 0!==o;)r.unshift(o),o=t.get(o);return r}clearOldCache(){const e=Game.time-this.COST_CACHE_TTL;for(const[t,r]of this.costCache.entries())r.timestamp<e&&this.costCache.delete(t)}getNextHop(e,t){const r=e.path.indexOf(t);return-1===r||r===e.path.length-1?null:e.path[r+1]||null}}return Qn.TerminalRouter=t,Qn.terminalRouter=new t,Qn}var Jn,es,ts,rs={},os={},ns=(ts||(ts=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.MarketTrendAnalyzer=e.marketManager=e.MarketManager=e.factoryManager=e.FactoryManager=e.terminalRouter=e.TerminalRouter=e.terminalManager=e.TerminalManager=e.linkManager=e.LinkManager=void 0;var t=function(){if(Bn)return Yn;Bn=1;var e=Yn&&Yn.__decorate||function(e,t,r,o){var n,s=arguments.length,i=3>s?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(3>s?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(Yn,"__esModule",{value:!0}),Yn.linkManager=Yn.LinkManager=void 0;const t=Vo,r=An,o=Mn,n={minBucket:0,minSourceLinkEnergy:400,controllerLinkMaxEnergy:700,transferThreshold:100,storageLinkReserve:100};var s;!function(e){e.SOURCE="source",e.CONTROLLER="controller",e.STORAGE="storage",e.UNKNOWN="unknown"}(s||(s={}));let i=class{constructor(e={}){this.config={...n,...e}}run(){if(Game.cpu.bucket<this.config.minBucket)return;const e=Object.values(Game.rooms).filter(e=>{var t;return(null===(t=e.controller)||void 0===t?void 0:t.my)&&e.controller.level>=5});for(const t of e)this.processRoomLinks(t)}processRoomLinks(e){const t=e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LINK});if(2>t.length)return;const r=this.classifyLinks(e,t),o=r.filter(e=>e.role===s.SOURCE),n=r.filter(e=>e.role===s.CONTROLLER),i=r.filter(e=>e.role===s.STORAGE);this.executeTransfers(e,o,n,i)}classifyLinks(e,t){const r=e.controller,o=e.storage,n=e.find(FIND_SOURCES);return t.map(e=>{if(r&&2>=e.pos.getRangeTo(r))return{link:e,role:s.CONTROLLER,priority:100};if(o&&2>=e.pos.getRangeTo(o))return{link:e,role:s.STORAGE,priority:50};for(const t of n)if(2>=e.pos.getRangeTo(t))return{link:e,role:s.SOURCE,priority:10};return{link:e,role:s.UNKNOWN,priority:25}})}executeTransfers(e,r,o,n){const i=r.filter(e=>e.link.store.getUsedCapacity(RESOURCE_ENERGY)>=this.config.minSourceLinkEnergy&&0===e.link.cooldown).sort((e,t)=>t.link.store.getUsedCapacity(RESOURCE_ENERGY)-e.link.store.getUsedCapacity(RESOURCE_ENERGY));if(0===i.length)return;const a=[...o,...n].filter(e=>e.link.store.getFreeCapacity(RESOURCE_ENERGY)>this.config.transferThreshold).sort((e,t)=>t.priority-e.priority);if(0!==a.length)for(const r of i){if(r.link.cooldown>0)continue;let o=null;for(const e of a)if(e.link.store.getFreeCapacity(RESOURCE_ENERGY)>=this.config.transferThreshold){if(e.role===s.CONTROLLER&&e.link.store.getUsedCapacity(RESOURCE_ENERGY)<this.config.controllerLinkMaxEnergy){o=e;break}if(e.role!==s.STORAGE)!o&&e.link.store.getFreeCapacity(RESOURCE_ENERGY)>this.config.transferThreshold&&(o=e);else if(e.link.store.getUsedCapacity(RESOURCE_ENERGY)<this.config.storageLinkReserve){o=e;break}}if(!o)continue;const n=r.link.store.getUsedCapacity(RESOURCE_ENERGY),i=r.link.transferEnergy(o.link,n);i===OK?t.logger.debug(`Link transfer: ${n} energy from ${r.link.pos} to ${o.link.pos} (${o.role})`,{subsystem:"Link",room:e.name}):i!==ERR_TIRED&&i!==ERR_FULL&&t.logger.warn(`Link transfer failed: ${i} from ${r.link.pos} to ${o.link.pos}`,{subsystem:"Link",room:e.name})}}getLinkRole(e){const t=e.room,r=t.controller,o=t.storage,n=t.find(FIND_SOURCES);if(r&&2>=e.pos.getRangeTo(r))return s.CONTROLLER;if(o&&2>=e.pos.getRangeTo(o))return s.STORAGE;for(const t of n)if(2>=e.pos.getRangeTo(t))return s.SOURCE;return s.UNKNOWN}hasLinkNetwork(e){var t;if(!(null===(t=e.controller)||void 0===t?void 0:t.my)||5>e.controller.level)return!1;const r=e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LINK});if(2>r.length)return!1;const o=this.classifyLinks(e,r),n=o.some(e=>e.role===s.SOURCE),i=o.some(e=>e.role===s.CONTROLLER||e.role===s.STORAGE);return n&&i}};return Yn.LinkManager=i,e([(0,o.MediumFrequencyProcess)("link:manager","Link Manager",{priority:r.ProcessPriority.MEDIUM,interval:5,minBucket:0,cpuBudget:.05})],i.prototype,"run",null),Yn.LinkManager=i=e([(0,o.ProcessClass)()],i),Yn.linkManager=new i,Yn}();Object.defineProperty(e,"LinkManager",{enumerable:!0,get:function(){return t.LinkManager}}),Object.defineProperty(e,"linkManager",{enumerable:!0,get:function(){return t.linkManager}});var r=function(){if(Xn)return Kn;Xn=1;var e=Kn&&Kn.__decorate||function(e,t,r,o){var n,s=arguments.length,i=3>s?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(3>s?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(Kn,"__esModule",{value:!0}),Kn.terminalManager=Kn.TerminalManager=void 0;const t=Vo,r=An,o=Mn,n=Nn,s=qn(),i=Zn(),a={minBucket:0,minStorageEnergy:5e4,terminalEnergyTarget:2e4,terminalEnergyMax:5e4,energySendThreshold:1e5,energyRequestThreshold:3e4,minTransferAmount:5e3,maxTransferCostRatio:.1,capacityWarningThreshold:.8,capacityClearanceThreshold:.9,emergencyDangerThreshold:2,emergencyEnergyAmount:2e4,energySurplusThreshold:5e4,mineralSurplusThreshold:5e3};let c=class{constructor(e={}){this.transferQueue=[],this.config={...a,...e}}requestTransfer(e,r,o,n,s=3){if(this.transferQueue.some(t=>t.fromRoom===e&&t.toRoom===r&&t.resourceType===o))return t.logger.debug(`Transfer already queued: ${n} ${o} from ${e} to ${r}`,{subsystem:"Terminal"}),!1;const i=Game.rooms[e],a=Game.rooms[r];return i&&a&&i.terminal&&a.terminal?(this.transferQueue.push({fromRoom:e,toRoom:r,resourceType:o,amount:n,priority:s}),t.logger.info(`Queued transfer request: ${n} ${o} from ${e} to ${r} (priority: ${s})`,{subsystem:"Terminal"}),!0):(t.logger.warn("Cannot queue transfer: rooms or terminals not available",{subsystem:"Terminal"}),!1)}run(){if(Game.cpu.bucket<this.config.minBucket)return;const e=Object.values(Game.rooms).filter(e=>{var t;return(null===(t=e.controller)||void 0===t?void 0:t.my)&&e.terminal&&e.terminal.my&&e.terminal.isActive()});2>e.length||(i.terminalRouter.clearOldCache(),this.cleanTransferQueue(),this.checkEmergencyTransfers(e),this.monitorTerminalCapacity(e),this.balanceEnergy(e),this.balanceMinerals(e),this.executeTransfers(e))}cleanTransferQueue(){this.transferQueue=this.transferQueue.filter(e=>{const t=Game.rooms[e.fromRoom],r=Game.rooms[e.toRoom];return!!(t&&r&&t.terminal&&r.terminal)})}checkEmergencyTransfers(e){var r,o;for(const s of e){if(!(null===(r=s.controller)||void 0===r?void 0:r.my))continue;const a=n.memoryManager.getSwarmState(s.name);if(a&&a.danger>=this.config.emergencyDangerThreshold){const r=s.storage,n=s.terminal;if((null!==(o=null==r?void 0:r.store.getUsedCapacity(RESOURCE_ENERGY))&&void 0!==o?o:0)+n.store.getUsedCapacity(RESOURCE_ENERGY)<this.config.energyRequestThreshold/2){const r=e.filter(e=>{var t;return e.name!==s.name&&(null===(t=e.controller)||void 0===t?void 0:t.my)&&e.storage&&e.storage.store.getUsedCapacity(RESOURCE_ENERGY)>this.config.energySendThreshold}).sort((e,t)=>Game.map.getRoomLinearDistance(s.name,e.name)-Game.map.getRoomLinearDistance(s.name,t.name));if(r.length>0&&r[0]){const e=r[0];if(!this.transferQueue.some(e=>e.toRoom===s.name&&e.resourceType===RESOURCE_ENERGY&&e.isEmergency)){const r=i.terminalRouter.findOptimalRoute(e.name,s.name,this.config.emergencyEnergyAmount);r&&(this.transferQueue.push({fromRoom:e.name,toRoom:s.name,resourceType:RESOURCE_ENERGY,amount:this.config.emergencyEnergyAmount,priority:10,route:r,isEmergency:!0}),t.logger.warn(`Emergency energy transfer queued: ${this.config.emergencyEnergyAmount} from ${e.name} to ${s.name} (danger: ${a.danger})`,{subsystem:"Terminal"}))}}}}}}monitorTerminalCapacity(e){for(const r of e){const e=r.terminal,o=e.store.getCapacity(),n=e.store.getUsedCapacity(),s=n/o;s>=this.config.capacityWarningThreshold&&s<this.config.capacityClearanceThreshold&&Game.time%100==0&&t.logger.warn(`Terminal ${r.name} at ${(100*s).toFixed(1)}% capacity (${n}/${o})`,{subsystem:"Terminal"}),s<this.config.capacityClearanceThreshold||this.clearExcessTerminalResources(r,e)}}clearExcessTerminalResources(e,r){var o,a;t.logger.info(`Auto-clearing terminal ${e.name} (${(r.store.getUsedCapacity()/r.store.getCapacity()*100).toFixed(1)}% full)`,{subsystem:"Terminal"});const c=n.memoryManager.getClusters();let l;for(const t in c){const r=c[t];if(r.memberRooms.includes(e.name)){let e=0;for(const t of r.memberRooms){const r=Game.rooms[t];(null===(o=null==r?void 0:r.controller)||void 0===o?void 0:o.my)&&r.controller.level>e&&(e=r.controller.level,l=t)}break}}const u=Object.keys(r.store);for(const o of u){const n=r.store.getUsedCapacity(o);if(0===n)continue;const c=o===RESOURCE_ENERGY?this.config.energySurplusThreshold:this.config.mineralSurplusThreshold;if(n>c){const r=n-c;if(l&&l!==e.name){const n=null===(a=Game.rooms[l])||void 0===a?void 0:a.terminal;if(n&&n.store.getFreeCapacity()>r){const n=i.terminalRouter.findOptimalRoute(e.name,l,r);if(n){this.transferQueue.push({fromRoom:e.name,toRoom:l,resourceType:o,amount:r,priority:5,route:n}),t.logger.info(`Queued clearance transfer: ${r} ${o} from ${e.name} to hub ${l}`,{subsystem:"Terminal"});continue}}}Game.time%10==0&&s.marketManager.sellSurplusFromTerminal(e.name,o,r)&&t.logger.info(`Sold ${r} ${o} from ${e.name} terminal via market`,{subsystem:"Terminal"})}}}balanceEnergy(e){const r=e.map(e=>{var t;const r=e.storage,o=e.terminal,n=null!==(t=null==r?void 0:r.store.getUsedCapacity(RESOURCE_ENERGY))&&void 0!==t?t:0,s=o.store.getUsedCapacity(RESOURCE_ENERGY),i=n+s;return{room:e,terminal:o,totalEnergy:i,storageEnergy:n,terminalEnergy:s,needsEnergy:i<this.config.energyRequestThreshold,hasExcess:i>this.config.energySendThreshold&&n>this.config.minStorageEnergy}}),o=r.filter(e=>e.needsEnergy).sort((e,t)=>e.totalEnergy-t.totalEnergy),n=r.filter(e=>e.hasExcess).sort((e,t)=>t.totalEnergy-e.totalEnergy);for(const e of o)for(const r of n){if(r.room.name===e.room.name)continue;if(this.transferQueue.some(t=>t.fromRoom===r.room.name&&t.toRoom===e.room.name&&t.resourceType===RESOURCE_ENERGY))continue;const o=Math.min(Math.floor((r.totalEnergy-this.config.energySendThreshold)/2),this.config.energyRequestThreshold-e.totalEnergy,r.terminal.store.getUsedCapacity(RESOURCE_ENERGY));if(o<this.config.minTransferAmount)continue;const n=i.terminalRouter.findOptimalRoute(r.room.name,e.room.name,o);if(!n)continue;const s=n.cost/o;if(s>this.config.maxTransferCostRatio){t.logger.debug(`Skipping terminal transfer from ${r.room.name} to ${e.room.name}: cost ratio ${s.toFixed(2)} too high`,{subsystem:"Terminal"});continue}this.transferQueue.push({fromRoom:r.room.name,toRoom:e.room.name,resourceType:RESOURCE_ENERGY,amount:o,priority:2,route:n});const a=n.isDirect?"direct":`multi-hop (${n.path.length} hops)`;t.logger.info(`Queued energy transfer: ${o} from ${r.room.name} to ${e.room.name} (${a}, cost: ${n.cost})`,{subsystem:"Terminal"});break}}balanceMinerals(e){const r=new Map;for(const t of e){const e=t.terminal,o=Object.keys(e.store);for(const n of o){if(n===RESOURCE_ENERGY)continue;const o=e.store.getUsedCapacity(n);0!==o&&(r.has(n)||r.set(n,[]),r.get(n).push({room:t,amount:o}))}}for(const[e,o]of r.entries()){if(2>o.length)continue;o.sort((e,t)=>t.amount-e.amount);const r=o[0],n=o[o.length-1],s=r.amount-n.amount;if(5e3>s)continue;if(this.transferQueue.some(t=>t.fromRoom===r.room.name&&t.toRoom===n.room.name&&t.resourceType===e))continue;const i=Math.min(Math.floor(s/2),r.amount-1e3);1e3>i||(this.transferQueue.push({fromRoom:r.room.name,toRoom:n.room.name,resourceType:e,amount:i,priority:1}),t.logger.info(`Queued mineral transfer: ${i} ${e} from ${r.room.name} to ${n.room.name}`,{subsystem:"Terminal"}))}}executeTransfers(e){this.transferQueue.sort((e,t)=>t.priority-e.priority);const r=new Set;for(const o of this.transferQueue){if(r.has(o.fromRoom))continue;const n=e.find(e=>e.name===o.fromRoom);if(!n||!n.terminal)continue;const s=n.terminal;if(s.cooldown>0)continue;const a=s.store.getUsedCapacity(o.resourceType);if(a<o.amount){t.logger.debug(`Terminal transfer cancelled: insufficient ${o.resourceType} in ${o.fromRoom} (need ${o.amount}, have ${a})`,{subsystem:"Terminal"}),this.transferQueue=this.transferQueue.filter(e=>e!==o);continue}let c=o.toRoom;if(o.route&&!o.route.isDirect){const e=i.terminalRouter.getNextHop(o.route,o.fromRoom);e&&(c=e)}const l=s.send(o.resourceType,o.amount,c,"Terminal auto-balance"+(o.isEmergency?" [EMERGENCY]":""));if(l===OK){const e=o.route&&!o.route.isDirect,n=c===o.toRoom;t.logger.info(`Terminal transfer executed: ${o.amount} ${o.resourceType} from ${o.fromRoom} to ${c}${e&&!n?` (hop to ${o.toRoom})`:""}${o.isEmergency?" [EMERGENCY]":""}`,{subsystem:"Terminal"}),r.add(o.fromRoom),e&&!n?o.fromRoom=c:this.transferQueue=this.transferQueue.filter(e=>e!==o)}else t.logger.warn(`Terminal transfer failed: ${l} for ${o.amount} ${o.resourceType} from ${o.fromRoom} to ${c}`,{subsystem:"Terminal"}),this.transferQueue=this.transferQueue.filter(e=>e!==o)}}queueTransfer(e,t,r,o,n=1){this.transferQueue.push({fromRoom:e,toRoom:t,resourceType:r,amount:o,priority:n})}balanceCompoundsAcrossCluster(e,r){var o;const n=new Map;for(const t of e){const e=Game.rooms[t];if(null==e?void 0:e.terminal)for(const s of r){const r=null!==(o=e.terminal.store[s])&&void 0!==o?o:0;n.has(s)||n.set(s,[]),n.get(s).push({roomName:t,amount:r,terminal:e.terminal})}}for(const[e,r]of n.entries()){if(2>r.length)continue;const o=r.reduce((e,t)=>e+t.amount,0)/r.length;r.sort((e,t)=>e.amount-t.amount);const n=r.filter(e=>e.amount<.7*o),s=r.filter(e=>e.amount>1.3*o);for(const r of s)for(const s of n){const n=Math.min(Math.floor((r.amount-o)/2),Math.floor((o-s.amount)/2),3e3),i=e===RESOURCE_CATALYZED_UTRIUM_ACID||e===RESOURCE_CATALYZED_KEANIUM_ALKALIDE||e===RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE||e===RESOURCE_CATALYZED_GHODIUM_ACID||e===RESOURCE_CATALYZED_ZYNTHIUM_ALKALIDE||e===RESOURCE_CATALYZED_GHODIUM_ALKALIDE;(i?300:500)>n||(this.queueTransfer(r.roomName,s.roomName,e,n,i?8:5),t.logger.info(`Queued compound balance: ${n} ${e} from ${r.roomName} to ${s.roomName}`,{subsystem:"Terminal"}),r.amount-=n,s.amount+=n)}}}};return Kn.TerminalManager=c,e([(0,o.MediumFrequencyProcess)("terminal:manager","Terminal Manager",{priority:r.ProcessPriority.MEDIUM,interval:20,minBucket:0,cpuBudget:.1})],c.prototype,"run",null),Kn.TerminalManager=c=e([(0,o.ProcessClass)()],c),Kn.terminalManager=new c,Kn}();Object.defineProperty(e,"TerminalManager",{enumerable:!0,get:function(){return r.TerminalManager}}),Object.defineProperty(e,"terminalManager",{enumerable:!0,get:function(){return r.terminalManager}});var o=Zn();Object.defineProperty(e,"TerminalRouter",{enumerable:!0,get:function(){return o.TerminalRouter}}),Object.defineProperty(e,"terminalRouter",{enumerable:!0,get:function(){return o.terminalRouter}});var n=function(){if(Jn)return rs;Jn=1;var e=rs&&rs.__decorate||function(e,t,r,o){var n,s=arguments.length,i=3>s?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(3>s?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(rs,"__esModule",{value:!0}),rs.factoryManager=rs.FactoryManager=void 0;const t=Vo,r=An,o=Mn,n={minBucket:0,minStorageEnergy:8e4,inputBufferAmount:2e3,outputBufferAmount:5e3},s={[RESOURCE_UTRIUM_BAR]:{[RESOURCE_UTRIUM]:500,[RESOURCE_ENERGY]:200},[RESOURCE_LEMERGIUM_BAR]:{[RESOURCE_LEMERGIUM]:500,[RESOURCE_ENERGY]:200},[RESOURCE_ZYNTHIUM_BAR]:{[RESOURCE_ZYNTHIUM]:500,[RESOURCE_ENERGY]:200},[RESOURCE_KEANIUM_BAR]:{[RESOURCE_KEANIUM]:500,[RESOURCE_ENERGY]:200},[RESOURCE_GHODIUM_MELT]:{[RESOURCE_GHODIUM]:500,[RESOURCE_ENERGY]:200},[RESOURCE_OXIDANT]:{[RESOURCE_OXYGEN]:500,[RESOURCE_ENERGY]:200},[RESOURCE_REDUCTANT]:{[RESOURCE_HYDROGEN]:500,[RESOURCE_ENERGY]:200},[RESOURCE_PURIFIER]:{[RESOURCE_CATALYST]:500,[RESOURCE_ENERGY]:200},[RESOURCE_BATTERY]:{[RESOURCE_ENERGY]:600}},i={[RESOURCE_BATTERY]:10,[RESOURCE_UTRIUM_BAR]:5,[RESOURCE_LEMERGIUM_BAR]:5,[RESOURCE_ZYNTHIUM_BAR]:5,[RESOURCE_KEANIUM_BAR]:5,[RESOURCE_GHODIUM_MELT]:4,[RESOURCE_OXIDANT]:3,[RESOURCE_REDUCTANT]:3,[RESOURCE_PURIFIER]:3};let a=class{constructor(e={}){this.config={...n,...e}}run(){if(Game.cpu.bucket<this.config.minBucket)return;const e=Object.values(Game.rooms).filter(e=>{var t;return!!(null===(t=e.controller)||void 0===t?void 0:t.my)&&e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_FACTORY}).length>0});for(const t of e)this.processFactory(t)}processFactory(e){const r=e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_FACTORY});if(0===r.length)return;const o=r[0];if(!o)return;if(o.cooldown>0)return;const n=e.storage;if(!n)return;if(n.store.getUsedCapacity(RESOURCE_ENERGY)<this.config.minStorageEnergy)return;const i=this.selectProduction(e,o,n);if(!i)return;const a=s[i];if(!a)return;let c=!0;for(const[e,t]of Object.entries(a))if(t>o.store.getUsedCapacity(e)){c=!1;break}if(c){const r=o.produce(i);r===OK?t.logger.info(`Factory in ${e.name} producing ${i}`,{subsystem:"Factory"}):r!==ERR_TIRED&&t.logger.debug(`Factory production failed in ${e.name}: ${r}`,{subsystem:"Factory"})}}selectProduction(e,t,r){var o;const n=[];for(const[e,a]of Object.entries(s)){const s=e;let c=!0,l=0;for(const[e,t]of Object.entries(a)){const o=e,n=r.store.getUsedCapacity(o);if(2*t>n){c=!1;break}l+=n/(10*t)}if(!c)continue;const u=t.store.getUsedCapacity(s)+r.store.getUsedCapacity(s);if(u>this.config.outputBufferAmount)continue;const m=null!==(o=i[s])&&void 0!==o?o:1,d=m*l*(1-u/this.config.outputBufferAmount);n.push({commodity:s,priority:m,score:d})}return 0===n.length?null:(n.sort((e,t)=>t.score-e.score),n[0].commodity)}getRequiredInputs(e,t){const r=t.storage;if(!r)return[];const o=this.selectProduction(t,e,r);if(!o)return[];const n=s[o];if(!n)return[];const i=[];for(const[t,r]of Object.entries(n)){const o=t,n=e.store.getUsedCapacity(o),s=Math.max(0,this.config.inputBufferAmount-n);s>0&&i.push({resource:o,amount:Math.min(s,2*r)})}return i}hasOutputsToRemove(e){for(const t of Object.keys(s))if(e.store.getUsedCapacity(t)>0)return!0;return!1}canOperateWithoutLabConflict(e){if(!e.terminal)return!1;const t=e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LAB});return t.filter(e=>e.cooldown>0).length<t.length/2||0===t.length}};return rs.FactoryManager=a,e([(0,o.MediumFrequencyProcess)("factory:manager","Factory Manager",{priority:r.ProcessPriority.LOW,interval:30,minBucket:0,cpuBudget:.05})],a.prototype,"run",null),rs.FactoryManager=a=e([(0,o.ProcessClass)()],a),rs.factoryManager=new a,rs}();Object.defineProperty(e,"FactoryManager",{enumerable:!0,get:function(){return n.FactoryManager}}),Object.defineProperty(e,"factoryManager",{enumerable:!0,get:function(){return n.factoryManager}});var s=qn();Object.defineProperty(e,"MarketManager",{enumerable:!0,get:function(){return s.MarketManager}}),Object.defineProperty(e,"marketManager",{enumerable:!0,get:function(){return s.marketManager}});var i=function(){if(es)return os;es=1;var e=os&&os.__decorate||function(e,t,r,o){var n,s=arguments.length,i=3>s?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(3>s?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(os,"__esModule",{value:!0}),os.MarketTrendAnalyzer=void 0;const t=Mn,r=An,o=Vo,n=Nn,s={updateInterval:500,minBucket:0,maxCpuBudget:.02,trackedResources:[RESOURCE_ENERGY,RESOURCE_HYDROGEN,RESOURCE_OXYGEN,RESOURCE_UTRIUM,RESOURCE_LEMERGIUM,RESOURCE_KEANIUM,RESOURCE_ZYNTHIUM,RESOURCE_CATALYST,RESOURCE_GHODIUM],highVolatilityThreshold:.3,opportunityConfidenceThreshold:.7};let i=class{constructor(e={}){this.lastRun=0,this.supplyDemandCache=new Map,this.opportunities=[],this.config={...s,...e}}run(){const e=Game.cpu.getUsed();this.lastRun=Game.time;for(const e of this.config.trackedResources){const t=this.analyzeSupplyDemand(e);t&&this.supplyDemandCache.set(e,t)}this.detectTradingOpportunities();const t=Game.cpu.getUsed()-e;Game.time%1e3==0&&o.logger.info(`Market trend analysis completed in ${t.toFixed(2)} CPU, ${this.opportunities.length} opportunities detected`,{subsystem:"MarketTrends"})}analyzeSupplyDemand(e){const t=Game.market.getAllOrders({resourceType:e});if(0===t.length)return null;const r=t.filter(e=>e.type===ORDER_BUY),o=t.filter(e=>e.type===ORDER_SELL),n=r.reduce((e,t)=>e+t.amount,0),s=o.reduce((e,t)=>e+t.amount,0),i=r.length>0?r.reduce((e,t)=>e+t.price,0)/r.length:0,a=o.length>0?o.reduce((e,t)=>e+t.price,0)/o.length:0,c=Math.min(100,s/(n+s)*100),l=Math.min(100,n/(n+s)*100),u=a>0?(a-i)/a:0;return{resource:e,supplyScore:c,demandScore:l,sentiment:(l-c)/100,tightness:1-Math.min(1,(n+s)/1e6)*(1-Math.min(1,10*u)),lastUpdate:Game.time}}detectTradingOpportunities(){var e,t,r,s,i,a,c;const l=n.memoryManager.getEmpire(),u=[];for(const n of this.config.trackedResources){const m=null===(e=l.market)||void 0===e?void 0:e.resources[n];if(!m)continue;const d=this.supplyDemandCache.get(n);if(!d)continue;if(-1===m.trend&&-.3>d.sentiment){const e=Math.abs(d.sentiment)*(1-(null!==(t=m.volatility)&&void 0!==t?t:.5));e<this.config.opportunityConfidenceThreshold||u.push({resource:n,type:"buy",expectedValue:1e4*(m.avgPrice-(null!==(r=m.predictedPrice)&&void 0!==r?r:m.avgPrice)),confidence:e,action:`Buy ${n} at current price (falling trend, oversupply)`,urgency:this.calculateUrgency(e,Math.abs(d.sentiment)),createdAt:Game.time})}if(1===m.trend&&d.sentiment>.3){const e=d.sentiment*(1-(null!==(s=m.volatility)&&void 0!==s?s:.5));e<this.config.opportunityConfidenceThreshold||u.push({resource:n,type:"sell",expectedValue:1e4*((null!==(i=m.predictedPrice)&&void 0!==i?i:m.avgPrice)-m.avgPrice),confidence:e,action:`Sell ${n} at current price (rising trend, high demand)`,urgency:this.calculateUrgency(e,d.sentiment),createdAt:Game.time})}const p=Game.market.getAllOrders({resourceType:n}),g=p.filter(e=>e.type===ORDER_BUY).sort((e,t)=>t.price-e.price)[0],f=p.filter(e=>e.type===ORDER_SELL).sort((e,t)=>e.price-t.price)[0];if(g&&f&&g.price>1.1*f.price){const e=(g.price-f.price)*Math.min(g.amount,f.amount),t=.9;u.push({resource:n,type:"arbitrage",expectedValue:e,confidence:t,action:`Arbitrage ${n}: buy at ${f.price.toFixed(3)}, sell at ${g.price.toFixed(3)}`,urgency:3,createdAt:Game.time})}(null!==(a=m.volatility)&&void 0!==a?a:0)<this.config.highVolatilityThreshold||o.logger.warn(`High volatility detected for ${n}: ${(100*(null!==(c=m.volatility)&&void 0!==c?c:0)).toFixed(1)}%`,{subsystem:"MarketTrends"})}this.opportunities=u;for(const e of u)2>e.urgency||o.logger.info(`Trading opportunity: ${e.action}, expected value: ${e.expectedValue.toFixed(0)} credits, confidence: ${(100*e.confidence).toFixed(0)}%`,{subsystem:"MarketTrends"})}calculateUrgency(e,t){const r=e*Math.abs(t);return.8>r?.6>r?.4>r?0:1:2:3}getSupplyDemand(e){return this.supplyDemandCache.get(e)}getOpportunities(){return this.opportunities}getOpportunitiesForResource(e){return this.opportunities.filter(t=>t.resource===e)}getUrgentOpportunities(){return this.opportunities.filter(e=>e.urgency>=2)}getMarketSentiment(e){var t;const r=this.supplyDemandCache.get(e);return null!==(t=null==r?void 0:r.sentiment)&&void 0!==t?t:0}isMarketTight(e){var t;const r=this.supplyDemandCache.get(e);return(null!==(t=null==r?void 0:r.tightness)&&void 0!==t?t:0)>.7}};return os.MarketTrendAnalyzer=i,e([(0,t.LowFrequencyProcess)("empire:marketTrends","Market Trend Analyzer",{priority:r.ProcessPriority.LOW,interval:500,minBucket:0,cpuBudget:.02})],i.prototype,"run",null),os.MarketTrendAnalyzer=i=e([(0,t.ProcessClass)()],i),os}();Object.defineProperty(e,"MarketTrendAnalyzer",{enumerable:!0,get:function(){return i.MarketTrendAnalyzer}})}(Wn)),Wn);function ss(e){var t;return e?null!==(t={X:15,Z:12,K:12,L:10,U:10,O:8,H:8}[e])&&void 0!==t?t:5:0}function is(e){const t=Wt.getEmpire();let r=0;const o=ms(e);for(const e of o){const o=t.knownRooms[e];o&&(o.owner&&!ps(o.owner)&&(r+=30),2>o.threatLevel||(r+=10*o.threatLevel),o.towerCount&&o.towerCount>0&&(r+=5*o.towerCount))}return r}function as(e){return"plains"===e?15:"swamp"===e?-10:0}function cs(e){const t=ms(e);for(const e of t){const t=ds(e);if(t&&(t.x%10==0||t.y%10==0))return!0}return!1}function ls(e){const t=Wt.getEmpire(),r=ms(e);for(const e of r){const r=t.knownRooms[e];if(r&&r.hasPortal)return 10}return 0}function us(e,t,r){return 0===t.length?0:r>2?r>3?r>5?0:5:15:25}function ms(e){const t=ds(e);if(!t)return[];const{x:r,y:o,xDir:n,yDir:s}=t,i=[];for(let e=-1;1>=e;e++)for(let t=-1;1>=t;t++){if(0===e&&0===t)continue;const a=r+e,c=o+t;let l=n,u=s,m=a,d=c;0>a&&(l="E"===n?"W":"E",m=Math.abs(a)-1),0>c&&(u="N"===s?"S":"N",d=Math.abs(c)-1),i.push(`${l}${m}${u}${d}`)}return i}function ds(e){const t=e.match(/^([WE])(\d+)([NS])(\d+)$/);return t?{xDir:t[1],x:parseInt(t[2],10),yDir:t[3],y:parseInt(t[4],10)}:null}function ps(e){return!1}function gs(e,t){const r=[],o=ds(e);if(!o)return[];const{x:n,y:s,xDir:i,yDir:a}=o;for(let e=-t;t>=e;e++)for(let o=-t;t>=o;o++){if(0===e&&0===o)continue;const t=n+e,c=s+o;let l=i,u=a,m=t,d=c;0>t&&(l="E"===i?"W":"E",m=Math.abs(t)-1),0>c&&(u="N"===a?"S":"N",d=Math.abs(c)-1),r.push(`${l}${m}${u}${d}`)}return r}function fs(e,t,r,o){var n;const s=Game.map.getRoomLinearDistance(t,e);if(!Number.isFinite(s)||0>=s)throw Error(`calculateRemoteProfitability: invalid distance ${s} between ${t} and ${e}`);if(0>=r.sources)throw Error(`calculateRemoteProfitability: intel.sources must be positive, got ${r.sources} for ${e}`);if(void 0!==r.threatLevel&&null!==r.threatLevel&&(0>r.threatLevel||r.threatLevel>3))throw Error(`calculateRemoteProfitability: intel.threatLevel must be in [0, 3], got ${r.threatLevel} for ${e}`);const i=10*r.sources,a=100*s,c=(650+450*r.sources)/(1500/a)/a,l=5e3*r.sources+15e3*s,u=l/5e4,m=i*(null!==(n=[0,.1,.3,.6][r.threatLevel])&&void 0!==n?n:0),d=i-c-u-m,p=c+u,g=p>0?d/p:0;return{roomName:e,sourceId:o,energyPerTick:i,carrierCostPerTick:c,pathDistance:s,infrastructureCost:l,threatCost:m,netProfitPerTick:d,roi:g,profitabilityScore:(f={distance:s,threatCost:m,roi:g,netProfitPerTick:d},Math.max(0,Math.min(100,50-2*f.distance+f.netProfitPerTick/10-(f.threatCost>0?10:0)+5*f.roi))),isProfitable:g>2&&d>0};var f}const hs={updateInterval:30,minBucket:0,maxCpuBudget:.05,minGclForExpansion:2,maxExpansionDistance:10,minExpansionScore:50,intelRefreshInterval:100,minStableRcl:4,gclNotifyThreshold:90,roomDiscoveryInterval:100,maxRoomDiscoveryDistance:5,maxRoomsToDiscoverPerTick:50};let ys=class{constructor(e={}){this.lastRun=0,this.config={...hs,...e}}run(){const e=Game.cpu.getUsed(),t=Wt.getEmpire();this.lastRun=Game.time,t.lastUpdate=Game.time,Ye.unifiedStats.measureSubsystem("empire:expansion",()=>{this.updateExpansionQueue(t)}),Ye.unifiedStats.measureSubsystem("empire:powerBanks",()=>{this.updatePowerBanks(t)}),Ye.unifiedStats.measureSubsystem("empire:warTargets",()=>{this.updateWarTargets(t)}),Ye.unifiedStats.measureSubsystem("empire:objectives",()=>{this.updateObjectives(t)}),Ye.unifiedStats.measureSubsystem("empire:intelRefresh",()=>{this.refreshRoomIntel(t)}),Ye.unifiedStats.measureSubsystem("empire:roomDiscovery",()=>{this.discoverNearbyRooms(t)}),Ye.unifiedStats.measureSubsystem("empire:gclTracking",()=>{this.trackGCLProgress(t)}),Ye.unifiedStats.measureSubsystem("empire:expansionReadiness",()=>{this.checkExpansionReadiness(t)}),Ye.unifiedStats.measureSubsystem("empire:nukeCandidates",()=>{this.refreshNukeCandidates(t)}),Ye.unifiedStats.measureSubsystem("empire:clusterHealth",()=>{this.monitorClusterHealth()}),Ye.unifiedStats.measureSubsystem("empire:powerBankProfitability",()=>{this.assessPowerBankProfitability(t)});const r=Game.cpu.getUsed()-e;Game.time%100==0&&de.info(`Empire tick completed in ${r.toFixed(2)} CPU`,{subsystem:"Empire"})}cleanupClaimQueue(e,t){const r=e.claimQueue.length;e.claimQueue=e.claimQueue.filter(e=>!t.has(e.roomName)||(de.info(`Removing ${e.roomName} from claim queue - now owned`,{subsystem:"Empire"}),!1)),e.claimQueue.length<r&&de.info(`Cleaned up claim queue: removed ${r-e.claimQueue.length} owned room(s)`,{subsystem:"Empire"})}updateExpansionQueue(e){const t=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my}),r=new Set(t.map(e=>e.name)),o=Game.gcl.level,n=Object.values(Game.spawns);if(n.length>0&&n[0].owner){const r=n[0].owner.username;for(const o of t){const t=e.knownRooms[o.name];t&&t.owner!==r&&(t.owner=r,de.info(`Updated room intel for ${o.name} - now owned by ${r}`,{subsystem:"Empire"}))}}if(this.cleanupClaimQueue(e,r),t.length>=o)return;if(o<this.config.minGclForExpansion)return;if(e.objectives.expansionPaused)return;const s=[];for(const r in e.knownRooms){const o=e.knownRooms[r];if(o.owner||o.reserver)continue;if(!o.scouted)continue;const n=this.scoreExpansionCandidate(o,t);n<this.config.minExpansionScore||s.push({roomName:o.name,score:n,distance:this.getMinDistanceToOwned(o.name,t),claimed:!1,lastEvaluated:Game.time})}s.sort((e,t)=>t.score-e.score),e.claimQueue=s.slice(0,10),s.length>0&&Game.time%100==0&&de.info(`Expansion queue updated: ${s.length} candidates, top score: ${s[0].score}`,{subsystem:"Empire"})}scoreExpansionCandidate(e,t){let r=0;2===e.sources?r+=40:1===e.sources&&(r+=20),r+=ss(e.mineralType);const o=this.getMinDistanceToOwned(e.name,t);return o>this.config.maxExpansionDistance?0:(r-=5*o,r-=is(e.name),r-=15*e.threatLevel,r+=as(e.terrain),cs(e.name)&&(r+=10),r+=ls(e.name),e.controllerLevel>0&&!e.owner&&(r+=2*e.controllerLevel),r+=us(e.name,t,o),e.isHighway?0:(e.isSK&&(r-=50),Math.max(0,r)))}getMinDistanceToOwned(e,t){let r=1/0;for(const o of t){const t=Game.map.getRoomLinearDistance(e,o.name);r>t&&(r=t)}return r}updatePowerBanks(e){var t;e.powerBanks=e.powerBanks.filter(e=>e.decayTick>Game.time);for(const r in Game.rooms){const o=Game.rooms[r].find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_POWER_BANK});for(const n of o)e.powerBanks.find(e=>e.roomName===r&&e.pos.x===n.pos.x&&e.pos.y===n.pos.y)||(e.powerBanks.push({roomName:r,pos:{x:n.pos.x,y:n.pos.y},power:n.power,decayTick:Game.time+(null!==(t=n.ticksToDecay)&&void 0!==t?t:5e3),active:!1}),de.info(`Power bank discovered in ${r}: ${n.power} power`,{subsystem:"Empire"}))}}updateWarTargets(e){if(e.warTargets=e.warTargets.filter(t=>{var r,o;const n=e.knownRooms[t];return!!n&&n.owner!==(null!==(o=null===(r=Object.values(Game.spawns)[0])||void 0===r?void 0:r.owner.username)&&void 0!==o?o:"")}),e.objectives.warMode)for(const t in e.knownRooms){const r=e.knownRooms[t];2>r.threatLevel||e.warTargets.includes(t)||(e.warTargets.push(t),de.warn(`Added war target: ${t} (threat level ${r.threatLevel})`,{subsystem:"Empire"}))}}updateObjectives(e){const t=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my});e.objectives.targetRoomCount=Game.gcl.level,e.objectives.targetPowerLevel=Math.min(25,3*t.length),e.warTargets.length>0&&!e.objectives.warMode&&(e.objectives.warMode=!0,de.warn("War mode enabled due to active war targets",{subsystem:"Empire"})),0===e.warTargets.length&&e.objectives.warMode&&(e.objectives.warMode=!1,de.info("War mode disabled - no active war targets",{subsystem:"Empire"}))}getNextExpansionTarget(){const e=Wt.getEmpire().claimQueue.filter(e=>!e.claimed);return e.length>0?e[0]:null}markExpansionClaimed(e){const t=Wt.getEmpire().claimQueue.find(t=>t.roomName===e);t&&(t.claimed=!0,de.info("Marked expansion target as claimed: "+e,{subsystem:"Empire"}))}refreshRoomIntel(e){if(Game.time%this.config.intelRefreshInterval!==0)return;let t=0;for(const r in Game.rooms){const o=Game.rooms[r];e.knownRooms[r]?(this.updateRoomIntel(e.knownRooms[r],o),t++):(e.knownRooms[r]=this.createRoomIntel(o),t++)}t>0&&Game.time%500==0&&de.info(`Refreshed intel for ${t} rooms`,{subsystem:"Empire"})}discoverNearbyRooms(e){if(Game.time%this.config.roomDiscoveryInterval!==0)return;const t=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my});if(0===t.length)return;let r=0;for(const o of t){const t=gs(o.name,this.config.maxRoomDiscoveryDistance);for(const o of t){if(r>=this.config.maxRoomsToDiscoverPerTick)return void de.debug(`Reached discovery limit of ${this.config.maxRoomsToDiscoverPerTick} rooms per tick`,{subsystem:"Empire"});e.knownRooms[o]||(e.knownRooms[o]=this.createStubIntel(o),r++)}}r>0&&de.info(`Discovered ${r} nearby rooms for scouting`,{subsystem:"Empire"})}createStubIntel(e){const t=ds(e);return{name:e,lastSeen:0,sources:0,controllerLevel:0,threatLevel:0,scouted:!1,terrain:"mixed",isHighway:!!t&&(t.x%10==0||t.y%10==0),isSK:!!t&&!(t.x%10!=4&&t.x%10!=5&&t.x%10!=6||t.y%10!=4&&t.y%10!=5&&t.y%10!=6)}}createRoomIntel(e){var t,r,o;const n=e.find(FIND_SOURCES),s=e.find(FIND_MINERALS)[0],i=e.controller;let a=0,c=0;const l=new Room.Terrain(e.name);for(let e=0;50>e;e++)for(let t=0;50>t;t++){const r=l.get(e,t);r===TERRAIN_MASK_SWAMP?c++:0===r&&a++}const u=c>a?"swamp":a>c?"plains":"mixed";return{name:e.name,lastSeen:Game.time,sources:n.length,controllerLevel:null!==(t=null==i?void 0:i.level)&&void 0!==t?t:0,owner:null===(r=null==i?void 0:i.owner)||void 0===r?void 0:r.username,reserver:null===(o=null==i?void 0:i.reservation)||void 0===o?void 0:o.username,mineralType:null==s?void 0:s.mineralType,threatLevel:0,scouted:!0,terrain:u,isHighway:!1,isSK:!1,towerCount:e.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_TOWER}).length,spawnCount:e.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_SPAWN}).length}}updateRoomIntel(e,t){var r,o,n;e.lastSeen=Game.time;const s=t.controller;s&&(e.controllerLevel=null!==(r=s.level)&&void 0!==r?r:0,e.owner=null===(o=s.owner)||void 0===o?void 0:o.username,e.reserver=null===(n=s.reservation)||void 0===n?void 0:n.username);const i=t.find(FIND_HOSTILE_CREEPS).filter(e=>e.body.some(e=>e.type===ATTACK||e.type===RANGED_ATTACK||e.type===WORK));5>i.length?2>i.length?i.length>0?e.threatLevel=1:e.threatLevel=0:e.threatLevel=2:e.threatLevel=3,e.towerCount=t.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_TOWER}).length,e.spawnCount=t.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_SPAWN}).length}trackGCLProgress(e){const t=Game.gcl.progress/Game.gcl.progressTotal*100;t<this.config.gclNotifyThreshold||Game.time%500!=0||de.info(`GCL ${Game.gcl.level} progress: ${t.toFixed(1)}% (${Game.gcl.progress}/${Game.gcl.progressTotal})`,{subsystem:"Empire"}),e.objectives.targetRoomCount=Game.gcl.level}checkExpansionReadiness(e){const t=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my});if(t.length>=Game.gcl.level)return;const r=t.filter(e=>{var t,r;const o=null!==(r=null===(t=e.controller)||void 0===t?void 0:t.level)&&void 0!==r?r:0,n=void 0!==e.storage;return o>=this.config.minStableRcl&&n});if(0===r.length)return void(e.objectives.expansionPaused||(e.objectives.expansionPaused=!0,de.info("Expansion paused: waiting for stable room (RCL >= 4 with storage)",{subsystem:"Empire"})));const o=r.reduce((e,t)=>{var r,o;return e+(null!==(o=null===(r=t.storage)||void 0===r?void 0:r.store[RESOURCE_ENERGY])&&void 0!==o?o:0)},0)/r.length;5e4>o?e.objectives.expansionPaused||(e.objectives.expansionPaused=!0,de.info(`Expansion paused: insufficient energy reserves (${o.toFixed(0)} < 50000)`,{subsystem:"Empire"})):e.objectives.expansionPaused&&(e.objectives.expansionPaused=!1,de.info(`Expansion resumed: ${r.length} stable rooms with ${o.toFixed(0)} avg energy`,{subsystem:"Empire"}))}refreshNukeCandidates(e){if(Game.time%500==0&&(e.nukeCandidates=e.nukeCandidates.filter(e=>!e.launched||5e4>=Game.time-e.launchTick),e.objectives.warMode&&0!==e.warTargets.length)){for(const t of e.warTargets){const r=e.knownRooms[t];if(!r||!r.scouted)continue;const o=e.nukeCandidates.find(e=>e.roomName===t);if(o&&!o.launched)continue;const n=this.scoreNukeCandidate(r);50>n||(e.nukeCandidates.push({roomName:t,score:n,launched:!1,launchTick:0}),de.info(`Added nuke candidate: ${t} (score: ${n})`,{subsystem:"Empire"}))}e.nukeCandidates.sort((e,t)=>t.score-e.score),e.nukeCandidates=e.nukeCandidates.slice(0,10)}}scoreNukeCandidate(e){var t,r;let o=0;return o+=10*e.controllerLevel,o+=15*(null!==(t=e.towerCount)&&void 0!==t?t:0),o+=20*(null!==(r=e.spawnCount)&&void 0!==r?r:0),e.isSK||e.isHighway?0:o}monitorClusterHealth(){if(Game.time%50!=0)return;const e=Wt.getClusters(),t=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my});for(const r in e){const o=e[r],n=t.filter(e=>o.memberRooms.includes(e.name));if(0===n.length)continue;const s=n.reduce((e,t)=>{var r,o,n,s;return e+(null!==(o=null===(r=t.storage)||void 0===r?void 0:r.store[RESOURCE_ENERGY])&&void 0!==o?o:0)+(null!==(s=null===(n=t.terminal)||void 0===n?void 0:n.store[RESOURCE_ENERGY])&&void 0!==s?s:0)},0)/n.length,i=Game.cpu.getUsed()/t.length,a=i>2;3e4>s&&Game.time%500==0&&de.warn(`Cluster ${r} has low energy: ${s.toFixed(0)} avg (threshold: 30000)`,{subsystem:"Empire"}),a&&Game.time%500==0&&de.warn(`Cluster ${r} has high CPU usage: ${i.toFixed(2)} per room`,{subsystem:"Empire"}),o.metrics||(o.metrics={energyIncome:0,energyConsumption:0,energyBalance:0,warIndex:0,economyIndex:0});const c=Math.min(100,s/1e5*100),l=n.length/o.memberRooms.length*100;o.metrics.economyIndex=Math.round((c+l)/2),40>o.metrics.economyIndex&&Game.time%500==0&&de.warn(`Cluster ${r} economy index low: ${o.metrics.economyIndex} - consider rebalancing`,{subsystem:"Empire"})}}assessPowerBankProfitability(e){var t,r;if(Game.time%100!=0)return;const o=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my});if(0!==o.length)for(const n of e.powerBanks){if(n.active)continue;let e=1/0,s=null;for(const t of o){const r=Game.map.getRoomLinearDistance(t.name,n.roomName);e>r&&(e=r,s=t)}if(!s)continue;const i=n.decayTick-Game.time,a=100*e+n.power/2,c=i>1.5*a&&5>=e&&n.power>=1e3&&(null!==(r=null===(t=s.controller)||void 0===t?void 0:t.level)&&void 0!==r?r:0)>=7;c||Game.time%500!=0?c&&Game.time%500==0&&de.info(`Profitable power bank in ${n.roomName}: power=${n.power}, distance=${e}, timeRemaining=${i}`,{subsystem:"Empire"}):de.debug(`Power bank in ${n.roomName} not profitable: power=${n.power}, distance=${e}, timeRemaining=${i}, requiredTime=`+a.toFixed(0),{subsystem:"Empire"})}}};Q([gr("empire:manager","Empire Manager",{priority:Be.MEDIUM,interval:30,minBucket:0,cpuBudget:.05})],ys.prototype,"run",null),ys=Q([hr()],ys);const Rs=new ys,Es={updateInterval:20,minBucket:0,maxRemoteDistance:2,maxRemotesPerRoom:4,minRemoteSources:1,minRclForRemotes:3,minRclForClaiming:4,minGclProgressForClaim:.7,clusterExpansionDistance:5,minStableRoomPercentage:.6};let Ts=class{constructor(e={}){this.lastRun=0,this.cachedUsername="",this.usernameLastTick=0,this.config={...Es,...e}}run(){const e=Wt.getEmpire();this.lastRun=Game.time,this.monitorExpansionProgress(e),this.updateRemoteAssignments(e),this.isExpansionReady(e)&&this.assignClaimerTargets(e),this.assignReserverTargets()}updateRemoteAssignments(e){var t,r,o;const n=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my});for(const s of n){const n=Wt.getSwarmState(s.name);if(!n)continue;if((null!==(r=null===(t=s.controller)||void 0===t?void 0:t.level)&&void 0!==r?r:0)<this.config.minRclForRemotes)continue;const i=null!==(o=n.remoteAssignments)&&void 0!==o?o:[],a=this.validateRemoteAssignments(i,e,s.name),c=this.calculateRemoteCapacity(s,n);if(a.length<c){const t=this.findRemoteCandidates(s.name,e,a),r=c-a.length,o=t.slice(0,r);for(const e of o)a.includes(e)||(a.push(e),de.info(`Assigned remote room ${e} to ${s.name}`,{subsystem:"Expansion"}))}JSON.stringify(a)!==JSON.stringify(n.remoteAssignments)&&(n.remoteAssignments=a)}}calculateRemoteCapacity(e,t){var r,o;const n=null!==(o=null===(r=e.controller)||void 0===r?void 0:r.level)&&void 0!==o?o:0;if(t.danger>=2)return Math.min(1,this.config.maxRemotesPerRoom);const s=e.storage;return s&&1e4>s.store.getUsedCapacity(RESOURCE_ENERGY)||4>n?Math.min(1,this.config.maxRemotesPerRoom):4===n?Math.min(2,this.config.maxRemotesPerRoom):7>n?Math.min(3,this.config.maxRemotesPerRoom):this.config.maxRemotesPerRoom}validateRemoteAssignments(e,t,r){return e.filter(e=>{const o=t.knownRooms[e];if(!o)return!0;let n=null;o.owner&&(de.info(`Removing remote ${e} - now owned by ${o.owner}`,{subsystem:"Expansion"}),n="claimed");const s=this.getMyUsername();if(!n&&o.reserver&&o.reserver!==s&&(de.info(`Removing remote ${e} - reserved by ${o.reserver}`,{subsystem:"Expansion"}),n="hostile"),n||3>o.threatLevel||(de.info(`Removing remote ${e} - threat level ${o.threatLevel}`,{subsystem:"Expansion"}),n="hostile"),!n){const t=Game.map.getRoomLinearDistance(r,e);t>this.config.maxRemoteDistance&&(de.info(`Removing remote ${e} - too far (${t})`,{subsystem:"Expansion"}),n="unreachable")}return!n||(qe.emit("remote.lost",{homeRoom:r,remoteRoom:e,reason:n,source:r}),!1)})}findRemoteCandidates(e,t,r){const o=[],n=this.getMyUsername();for(const s in t.knownRooms){if(r.includes(s))continue;if(this.isRemoteAssignedElsewhere(s,e))continue;const i=t.knownRooms[s];if(!i.scouted)continue;if(i.owner)continue;if(i.reserver&&i.reserver!==n)continue;if(i.isHighway||i.isSK)continue;if(i.sources<this.config.minRemoteSources)continue;if(i.threatLevel>=2)continue;const a=Game.map.getRoomLinearDistance(e,s);if(1>a||a>this.config.maxRemoteDistance)continue;const c=fs(s,e,i);if(!c.isProfitable){Game.time%1e3==0&&de.debug(`Skipping remote ${s} - not profitable (ROI: ${c.roi.toFixed(2)})`,{subsystem:"Expansion"});continue}const l=this.scoreRemoteCandidate(i,a);o.push({roomName:s,score:l})}return o.sort((e,t)=>t.score-e.score),o.map(e=>e.roomName)}scoreRemoteCandidate(e,t){let r=0;return r+=50*e.sources,r-=20*t,r-=30*e.threatLevel,"plains"===e.terrain?r+=10:"swamp"===e.terrain&&(r-=10),r}scoreClaimCandidate(e,t,r){let o=0;return 2===e.sources?o+=40:1===e.sources&&(o+=20),o+=ss(e.mineralType),o-=5*t,o-=is(e.name),o-=15*e.threatLevel,o+=as(e.terrain),cs(e.name)&&(o+=10),o+=ls(e.name),e.controllerLevel>0&&!e.owner&&(o+=2*e.controllerLevel),o+=us(e.name,r,t),o}isRemoteAssignedElsewhere(e,t){var r;const o=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my});for(const n of o){if(n.name===t)continue;const o=Wt.getSwarmState(n.name);if(null===(r=null==o?void 0:o.remoteAssignments)||void 0===r?void 0:r.includes(e))return!0}return!1}assignClaimerTargets(e){const t=this.getNextExpansionTarget(e);if(!t)return;if(Object.values(Game.creeps).some(e=>{const r=e.memory;return"claimer"===r.role&&r.targetRoom===t.roomName&&"claim"===r.task}))return;let r=!1;for(const e of Object.values(Game.creeps)){const o=e.memory;if("claimer"===o.role&&!o.targetRoom){o.targetRoom=t.roomName,o.task="claim",de.info(`Assigned claim target ${t.roomName} to ${e.name}`,{subsystem:"Expansion"}),t.claimed=!0,r=!0;break}}r||this.requestClaimerSpawn(t.roomName,e)}requestClaimerSpawn(e,t){const r=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my}).filter(e=>{var t,r;return(null!==(r=null===(t=e.controller)||void 0===t?void 0:t.level)&&void 0!==r?r:0)>=this.config.minRclForClaiming});if(0===r.length)return;let o=null,n=999;for(const t of r){const r=Game.map.getRoomLinearDistance(t.name,e);n>r&&(n=r,o=t)}if(!o)return;const s=Wt.getSwarmState(o.name);s&&"defensive"!==s.posture&&"evacuate"!==s.posture&&2>s.danger&&"expand"!==s.posture&&(s.posture="expand",de.info(`Set ${o.name} to expand posture for claiming ${e} (distance: ${n})`,{subsystem:"Expansion"}))}assignReserverTargets(){var e;for(const t of Object.values(Game.creeps)){const r=t.memory;if("claimer"!==r.role||r.targetRoom)continue;const o=r.homeRoom;if(!o)continue;const n=Wt.getSwarmState(o);if(null===(e=null==n?void 0:n.remoteAssignments)||void 0===e?void 0:e.length)for(const e of n.remoteAssignments)if(!this.hasReserverAssigned(e)){r.targetRoom=e,r.task="reserve",de.info(`Assigned reserve target ${e} to ${t.name}`,{subsystem:"Expansion"});break}}}hasReserverAssigned(e){for(const t of Object.values(Game.creeps)){const r=t.memory;if("claimer"===r.role&&r.targetRoom===e&&"reserve"===r.task)return!0}return!1}isExpansionReady(e){if(e.objectives.expansionPaused)return!1;const t=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my});if(t.length>=Game.gcl.level)return!1;const r=Game.gcl.progress/Game.gcl.progressTotal;if(r<this.config.minGclProgressForClaim)return Game.time%500==0&&de.info(`Waiting for GCL progress: ${(100*r).toFixed(1)}% (need ${(100*this.config.minGclProgressForClaim).toFixed(0)}%)`,{subsystem:"Expansion"}),!1;const o=t.filter(e=>{var t,r;return(null!==(r=null===(t=e.controller)||void 0===t?void 0:t.level)&&void 0!==r?r:0)>=this.config.minRclForClaiming}),n=o.length/t.length;return n>=this.config.minStableRoomPercentage||(Game.time%500==0&&de.info(`Waiting for room stability: ${o.length}/${t.length} rooms stable (${(100*n).toFixed(0)}%, need ${(100*this.config.minStableRoomPercentage).toFixed(0)}%)`,{subsystem:"Expansion"}),!1)}getNextExpansionTarget(e){const t=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my});if(t.length>=Game.gcl.level)return null;const r=e.claimQueue.filter(e=>!e.claimed);if(0===r.length)return null;const o=r.map(e=>{const r=this.getMinDistanceToOwned(e.roomName,t),o=r>this.config.clusterExpansionDistance?0:100;return{...e,clusterScore:e.score+o,distanceToCluster:r}});if(o.sort((e,t)=>t.clusterScore-e.clusterScore),Game.time%100==0&&o.length>0){const e=o[0];de.info(`Next expansion target: ${e.roomName} (score: ${e.score}, cluster bonus: ${e.clusterScore-e.score}, distance: ${e.distanceToCluster})`,{subsystem:"Expansion"})}return o[0]}getMinDistanceToOwned(e,t){if(0===t.length)return 999;let r=999;for(const o of t){const t=Game.map.getRoomLinearDistance(e,o.name);r>t&&(r=t)}return r}getMyUsername(){if(this.usernameLastTick!==Game.time||!this.cachedUsername){const e=Object.values(Game.spawns);e.length>0&&(this.cachedUsername=e[0].owner.username),this.usernameLastTick=Game.time}return this.cachedUsername}performSafetyAnalysis(e,t){const r=[],o=gs(e,2);for(const e of o){const o=t.knownRooms[e];o&&(o.owner&&!ps(o.owner)&&r.push(`Hostile player ${o.owner} in ${e}`),o.towerCount&&o.towerCount>0&&r.push(`${o.towerCount} towers in ${e}`),o.spawnCount&&o.spawnCount>0&&r.push(`${o.spawnCount} spawns in ${e}`),2>o.threatLevel||r.push(`Threat level ${o.threatLevel} in ${e}`))}return function(e){const t=Wt.getEmpire(),r=ms(e),o=new Set;for(const e of r){const r=t.knownRooms[e];(null==r?void 0:r.owner)&&!ps(r.owner)&&o.add(r.owner)}return o.size>=2}(e)&&r.push("Room is in potential war zone between hostile players"),{isSafe:0===r.length,threatDescription:r.length>0?r.join("; "):"No threats detected"}}monitorExpansionProgress(e){var t;const r=Game.time;for(const o of e.claimQueue){if(!o.claimed)continue;const n=r-o.lastEvaluated;if(n>5e3){const r=Game.rooms[o.roomName];if(null===(t=null==r?void 0:r.controller)||void 0===t?void 0:t.my){de.info(`Expansion to ${o.roomName} completed successfully`,{subsystem:"Expansion"}),this.removeFromClaimQueue(e,o.roomName);continue}de.warn(`Expansion to ${o.roomName} timed out after ${n} ticks`,{subsystem:"Expansion"}),this.cancelExpansion(e,o.roomName,"timeout");continue}if(!Object.values(Game.creeps).some(e=>{const t=e.memory;return"claimer"===t.role&&t.targetRoom===o.roomName&&"claim"===t.task})&&n>1e3){de.warn(`No active claimer for ${o.roomName} expansion`,{subsystem:"Expansion"}),this.cancelExpansion(e,o.roomName,"claimer_died");continue}const s=e.knownRooms[o.roomName];if((null==s?void 0:s.owner)&&s.owner!==this.getMyUsername()){de.warn(`${o.roomName} claimed by ${s.owner} before we could claim it`,{subsystem:"Expansion"}),this.cancelExpansion(e,o.roomName,"hostile_claim");continue}const i=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my}),a=i.reduce((e,t)=>{var r,o;return e+(null!==(o=null===(r=t.storage)||void 0===r?void 0:r.store.getUsedCapacity(RESOURCE_ENERGY))&&void 0!==o?o:0)},0),c=i.length>0?a/i.length:0;2e4>c&&(de.warn(`Cancelling expansion to ${o.roomName} due to low energy (avg: ${c})`,{subsystem:"Expansion"}),this.cancelExpansion(e,o.roomName,"low_energy"))}}cancelExpansion(e,t,r){this.removeFromClaimQueue(e,t);for(const e of Object.values(Game.creeps)){const r=e.memory;"claimer"===r.role&&r.targetRoom===t&&"claim"===r.task&&(r.targetRoom=void 0,r.task=void 0,de.info(`Cleared target for ${e.name} due to expansion cancellation`,{subsystem:"Expansion"}))}de.info(`Cancelled expansion to ${t}, reason: ${r}`,{subsystem:"Expansion"})}removeFromClaimQueue(e,t){const r=e.claimQueue.findIndex(e=>e.roomName===t);-1!==r&&e.claimQueue.splice(r,1)}addRemoteRoom(e,t){const r=Wt.getSwarmState(e);return r?(r.remoteAssignments||(r.remoteAssignments=[]),r.remoteAssignments.includes(t)?(de.warn(`Remote ${t} already assigned to ${e}`,{subsystem:"Expansion"}),!1):(r.remoteAssignments.push(t),de.info(`Manually added remote ${t} to ${e}`,{subsystem:"Expansion"}),!0)):(de.error(`Cannot add remote: ${e} not found`,{subsystem:"Expansion"}),!1)}removeRemoteRoom(e,t){const r=Wt.getSwarmState(e);if(!(null==r?void 0:r.remoteAssignments))return!1;const o=r.remoteAssignments.indexOf(t);return-1!==o&&(r.remoteAssignments.splice(o,1),de.info(`Manually removed remote ${t} from ${e}`,{subsystem:"Expansion"}),!0)}};Q([pr("expansion:manager","Expansion Manager",{priority:Be.LOW,interval:20,minBucket:0,cpuBudget:.02})],Ts.prototype,"run",null),Ts=Q([hr()],Ts);const Cs=new Ts,vs={updateInterval:500,minGhodium:5e3,minEnergy:3e5,minScore:35,siegeCoordinationWindow:1e3,nukeFlightTime:5e4,terminalPriority:5,donorRoomBuffer:1e3,salvoSyncWindow:10,roiThreshold:2,counterNukeWarThreshold:60},Ss=1e7,_s=5e6,bs={[STRUCTURE_SPAWN]:15e3,[STRUCTURE_TOWER]:5e3,[STRUCTURE_STORAGE]:3e4,[STRUCTURE_TERMINAL]:1e5,[STRUCTURE_LAB]:5e4,[STRUCTURE_NUKER]:1e5,[STRUCTURE_POWER_SPAWN]:1e5,[STRUCTURE_OBSERVER]:8e3,[STRUCTURE_EXTENSION]:3e3,[STRUCTURE_LINK]:5e3};let Os=class{constructor(e={}){this.lastRun=0,this.nukerReadyLogged=new Set,this.config={...vs,...e}}run(){this.lastRun=Game.time,this.initializeNukeTracking(),this.detectIncomingNukes(),this.processCounterNukeStrategies(),this.manageNukeResources(),this.loadNukers(),this.evaluateNukeCandidates(),this.updateNukeEconomics(),this.coordinateWithSieges(),this.coordinateNukeSalvos(),this.launchNukes(),this.cleanupNukeTracking()}loadNukers(){var e;for(const t in Game.rooms){const r=Game.rooms[t];if(!(null===(e=r.controller)||void 0===e?void 0:e.my))continue;const o=r.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_NUKER})[0];if(!o)continue;const n=o.store.getFreeCapacity(RESOURCE_ENERGY),s=o.store.getFreeCapacity(RESOURCE_GHODIUM);(n>0||s>0)&&de.debug(`Nuker in ${t} needs ${n} energy, ${s} ghodium`,{subsystem:"Nuke"})}}evaluateNukeCandidates(){const e=Wt.getEmpire();if(e.nukeCandidates=[],e.objectives.warMode){for(const t of e.warTargets){const r=this.scoreNukeCandidate(t);r.score<this.config.minScore||(e.nukeCandidates.push({roomName:t,score:r.score,launched:!1,launchTick:0}),de.info(`Nuke candidate: ${t} (score: ${r.score}) - ${r.reasons.join(", ")}`,{subsystem:"Nuke"}))}e.nukeCandidates.sort((e,t)=>t.score-e.score)}}scoreNukeCandidate(e){let t=0;const r=[],o=Wt.getEmpire().knownRooms[e];if(!o)return{roomName:e,score:0,reasons:["No intel"]};o.controllerLevel&&(t+=3*o.controllerLevel,r.push("RCL "+o.controllerLevel)),o.towerCount&&(t+=5*o.towerCount,r.push(o.towerCount+" towers")),o.spawnCount&&(t+=10*o.spawnCount,r.push(o.spawnCount+" spawns")),o.owner&&""!==o.owner&&(t+=30,r.push("Owned room"));const n=Wt.getSwarmState(e);if(n){const e=Math.floor(n.pheromones.war/10);e>0&&(t+=e,r.push("War intensity: "+n.pheromones.war))}o.isHighway&&(t+=10,r.push("Highway (strategic)")),2>o.threatLevel||(t+=20,r.push("High threat"));const s=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my});if(s.length>0){const o=Math.min(...s.map(t=>Game.map.getRoomLinearDistance(e,t.name)));t-=2*o,r.push(o+" rooms away")}Wt.getEmpire().warTargets.includes(e)&&(t+=15,r.push("War target"));const i=new RoomPosition(25,25,e),a=this.calculateNukeROI(e,i);return a<this.config.roiThreshold?(t-=20,r.push(`Low ROI: ${a.toFixed(1)}x`)):(t+=Math.min(20,Math.floor(5*a)),r.push(`ROI: ${a.toFixed(1)}x`)),{roomName:e,score:t,reasons:r}}launchNukes(){var e;const t=Wt.getEmpire();if(!t.objectives.warMode)return;const r=[];for(const t in Game.rooms){const o=Game.rooms[t];if(!(null===(e=o.controller)||void 0===e?void 0:e.my))continue;const n=o.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_NUKER})[0];!n||n.store.getUsedCapacity(RESOURCE_ENERGY)<this.config.minEnergy||n.store.getUsedCapacity(RESOURCE_GHODIUM)<this.config.minGhodium||r.push(n)}if(0!==r.length)for(const e of t.nukeCandidates)if(!e.launched){for(const o of r){if(Game.map.getRoomLinearDistance(o.room.name,e.roomName)>10)continue;const n=new RoomPosition(25,25,e.roomName),s=this.predictNukeImpact(e.roomName,n),i=this.calculateNukeROI(e.roomName,n);if(i<this.config.roiThreshold){de.warn(`Skipping nuke launch on ${e.roomName}: ROI ${i.toFixed(2)}x below threshold ${this.config.roiThreshold}x`,{subsystem:"Nuke"});continue}const a=o.launchNuke(n);if(a===OK){e.launched=!0,e.launchTick=Game.time;const a={id:`${o.room.name}-${e.roomName}-${Game.time}`,sourceRoom:o.room.name,targetRoom:e.roomName,targetPos:{x:n.x,y:n.y},launchTick:Game.time,impactTick:Game.time+this.config.nukeFlightTime,estimatedDamage:s.estimatedDamage,estimatedValue:s.estimatedValue};t.nukesInFlight||(t.nukesInFlight=[]),t.nukesInFlight.push(a),t.nukeEconomics||(t.nukeEconomics={nukesLaunched:0,totalEnergyCost:0,totalGhodiumCost:0,totalDamageDealt:0,totalValueDestroyed:0}),t.nukeEconomics.nukesLaunched++,t.nukeEconomics.totalEnergyCost+=3e5,t.nukeEconomics.totalGhodiumCost+=5e3,t.nukeEconomics.totalDamageDealt+=s.estimatedDamage,t.nukeEconomics.totalValueDestroyed+=s.estimatedValue,t.nukeEconomics.lastLaunchTick=Game.time,de.warn(`NUKE LAUNCHED from ${o.room.name} to ${e.roomName}! Impact in ${this.config.nukeFlightTime} ticks. Predicted damage: ${(s.estimatedDamage/1e6).toFixed(1)}M hits, value: ${(s.estimatedValue/1e3).toFixed(0)}k, ROI: ${i.toFixed(2)}x`,{subsystem:"Nuke"});const c=r.indexOf(o);c>-1&&r.splice(c,1);break}de.error("Failed to launch nuke: "+a,{subsystem:"Nuke"})}if(0===r.length)break}}detectIncomingNukes(){var e;const t=Wt.getEmpire();t.incomingNukes||(t.incomingNukes=[]);for(const r in Game.rooms){const o=Game.rooms[r];if(!(null===(e=o.controller)||void 0===e?void 0:e.my))continue;const n=Wt.getSwarmState(r);if(!n)continue;const s=o.find(FIND_NUKES);if(s.length>0)for(const e of s){e.pos.x,e.pos.y,e.launchRoomName;const s=t.incomingNukes.find(t=>t.roomName===r&&t.landingPos.x===e.pos.x&&t.landingPos.y===e.pos.y);if(s)s.timeToLand=e.timeToLand||0;else{const s={roomName:r,landingPos:{x:e.pos.x,y:e.pos.y},impactTick:Game.time+(e.timeToLand||0),timeToLand:e.timeToLand||0,detectedAt:Game.time,evacuationTriggered:!1,sourceRoom:e.launchRoomName},i=this.identifyThreatenedStructures(o,e.pos);s.threatenedStructures=i,t.incomingNukes.push(s),n.nukeDetected||(n.nukeDetected=!0,n.pheromones.defense=Math.min(100,n.pheromones.defense+50),n.pheromones.siege=Math.min(100,n.pheromones.siege+30),n.danger=3,de.warn(`INCOMING NUKE DETECTED in ${r}! Landing at (${e.pos.x}, ${e.pos.y}), impact in ${e.timeToLand} ticks. Source: ${e.launchRoomName||"unknown"}. Threatened structures: `+i.length,{subsystem:"Nuke"}),n.eventLog.push({type:"nuke_incoming",time:Game.time,details:`Impact in ${e.timeToLand} ticks at (${e.pos.x},${e.pos.y})`}),n.eventLog.length>20&&n.eventLog.shift()),i.some(e=>e.includes(STRUCTURE_SPAWN)||e.includes(STRUCTURE_STORAGE)||e.includes(STRUCTURE_TERMINAL))&&!s.evacuationTriggered&&(this.triggerEvacuation(o,s),s.evacuationTriggered=!0)}}else n.nukeDetected&&(n.nukeDetected=!1,de.info("Nuke threat cleared in "+r,{subsystem:"Nuke"}))}}identifyThreatenedStructures(e,t){const r=[],o=e.lookForAtArea(LOOK_STRUCTURES,Math.max(0,t.y-2),Math.max(0,t.x-2),Math.min(49,t.y+2),Math.min(49,t.x+2),!0);for(const e of o){const o=e.structure,n=Math.abs(o.pos.x-t.x),s=Math.abs(o.pos.y-t.y),i=Math.max(n,s);if(2>=i){const e=0===i?Ss:_s;o.hits>e||r.push(`${o.structureType}-${o.pos.x},${o.pos.y}`)}}return r}triggerEvacuation(e,t){const r=Wt.getSwarmState(e.name);r&&(5e3>t.timeToLand?(r.posture="evacuate",de.warn(`EVACUATION TRIGGERED for ${e.name}: Critical structures threatened by nuke!`,{subsystem:"Nuke"})):("war"!==r.posture&&"evacuate"!==r.posture&&(r.posture="defensive"),de.warn(`NUKE DEFENSE PREPARATION in ${e.name}: Critical structures in blast radius`,{subsystem:"Nuke"})),r.pheromones.defense=100)}manageNukeResources(){var e,t;if(Wt.getEmpire().objectives.warMode)for(const r in Game.rooms){const o=Game.rooms[r];if(!(null===(e=o.controller)||void 0===e?void 0:e.my))continue;const n=o.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_NUKER})[0];if(!n)continue;const s=o.terminal;if(!s||!s.my)continue;const i=n.store.getFreeCapacity(RESOURCE_ENERGY),a=n.store.getFreeCapacity(RESOURCE_GHODIUM);if(a>0){const e=null!==(t=s.store.getUsedCapacity(RESOURCE_GHODIUM))&&void 0!==t?t:0;a>e&&this.requestResourceTransfer(r,RESOURCE_GHODIUM,a-e)}const c=r+"-nuker";0===i&&0===a?this.nukerReadyLogged.has(c)||(de.info(`Nuker in ${r} is fully loaded and ready to launch`,{subsystem:"Nuke"}),this.nukerReadyLogged.add(c)):this.nukerReadyLogged.delete(c)}}requestResourceTransfer(e,t,r){const o=this.findDonorRoom(e,t,r);o?(this.terminalManager||(this.terminalManager=require("@ralphschuler/screeps-economy").terminalManager),this.terminalManager.requestTransfer(o,e,t,r,this.config.terminalPriority)&&de.info(`Requested ${r} ${t} transfer from ${o} to ${e} for nuker`,{subsystem:"Nuke"})):de.debug(`No donor room found for ${r} ${t} to ${e}`,{subsystem:"Nuke"})}findDonorRoom(e,t,r){var o,n,s,i;const a=[];for(const s in Game.rooms){const i=Game.rooms[s];if(!(null===(o=i.controller)||void 0===o?void 0:o.my)||s===e)continue;const c=i.terminal;if(!c||!c.my)continue;const l=null!==(n=c.store.getUsedCapacity(t))&&void 0!==n?n:0;if(l<r+this.config.donorRoomBuffer)continue;const u=Game.map.getRoomLinearDistance(s,e);a.push({room:s,amount:l,distance:u})}return 0===a.length?null:(a.sort((e,t)=>e.distance-t.distance),null!==(i=null===(s=a[0])||void 0===s?void 0:s.room)&&void 0!==i?i:null)}coordinateWithSieges(){var e;const t=Wt.getEmpire();if(!t.objectives.warMode)return;if(!t.nukesInFlight||0===t.nukesInFlight.length)return;for(const e of t.nukesInFlight){const t=e.impactTick-Game.time;e.siegeSquadId||t>this.config.siegeCoordinationWindow||0>=t||this.deploySiegeSquadForNuke(e)&&de.info(`Siege squad deployment coordinated with nuke on ${e.targetRoom}, impact in ${t} ticks`,{subsystem:"Nuke"})}const r=Wt.getClusters();for(const o of Object.values(r)){if(!o.squads||0===o.squads.length)continue;const r=o.squads.filter(e=>"siege"===e.type);for(const o of r){if("moving"!==o.state&&"attacking"!==o.state)continue;const r=o.targetRooms[0];if(!r)continue;const n=null===(e=t.nukesInFlight)||void 0===e?void 0:e.find(e=>e.targetRoom===r);n&&!n.siegeSquadId&&(n.siegeSquadId=o.id,de.info(`Linked siege squad ${o.id} with nuke on ${r}`,{subsystem:"Nuke"}))}}}deploySiegeSquadForNuke(e){var t;const r=Wt.getClusters();let o=null;for(const t of Object.values(r)){const r=Game.map.getRoomLinearDistance(t.coreRoom,e.targetRoom);o&&r>=o.distance||(o={id:t.id,distance:r})}if(!o)return de.warn(`Cannot deploy siege squad for nuke on ${e.targetRoom}: No clusters available`,{subsystem:"Nuke"}),!1;const n=r[o.id];if(!n)return!1;const s=null===(t=n.squads)||void 0===t?void 0:t.find(t=>"siege"===t.type&&t.targetRooms.includes(e.targetRoom));if(s)return e.siegeSquadId=s.id,!0;const i=Wt.getSwarmState(e.targetRoom);i&&(i.pheromones.siege=Math.min(100,i.pheromones.siege+80),i.pheromones.war=Math.min(100,i.pheromones.war+60),de.info(`Siege pheromones increased for ${e.targetRoom} to coordinate with nuke strike`,{subsystem:"Nuke"}));const a=`siege-nuke-${e.targetRoom}-${Game.time}`,c={id:a,type:"siege",members:[],rallyRoom:n.coreRoom,targetRooms:[e.targetRoom],state:"gathering",createdAt:Game.time,retreatThreshold:.3};return n.squads||(n.squads=[]),n.squads.push(c),e.siegeSquadId=a,de.warn(`SIEGE SQUAD DEPLOYED: Squad ${a} will coordinate with nuke on ${e.targetRoom}`,{subsystem:"Nuke"}),!0}estimateSquadEta(e,t){const r=e.members.map(e=>Game.creeps[e]).filter(e=>null!=e);if(0===r.length)return 50*Game.map.getRoomLinearDistance(e.rallyRoom,t);const o=r.map(e=>50*Game.map.getRoomLinearDistance(e.room.name,t));return Math.min(...o)}initializeNukeTracking(){const e=Wt.getEmpire();e.nukesInFlight||(e.nukesInFlight=[]),e.incomingNukes||(e.incomingNukes=[]),e.nukeEconomics||(e.nukeEconomics={nukesLaunched:0,totalEnergyCost:0,totalGhodiumCost:0,totalDamageDealt:0,totalValueDestroyed:0})}coordinateNukeSalvos(){const e=Wt.getEmpire();if(!e.nukesInFlight||0===e.nukesInFlight.length)return;const t=new Map;for(const r of e.nukesInFlight){const e=t.get(r.targetRoom)||[];e.push(r),t.set(r.targetRoom,e)}for(const[e,r]of t.entries()){if(2>r.length)continue;const t=r.map(e=>e.impactTick),o=Math.min(...t),n=Math.max(...t)-o;if(n>this.config.salvoSyncWindow)de.warn(`Nukes on ${e} not synchronized (spread: ${n} ticks > ${this.config.salvoSyncWindow})`,{subsystem:"Nuke"});else{const t=r[0].salvoId||`salvo-${e}-${o}`;for(const e of r)e.salvoId=t;de.info(`Nuke salvo ${t} coordinated: ${r.length} nukes on ${e}, impact spread: ${n} ticks`,{subsystem:"Nuke"})}}}predictNukeImpact(e,t){const r={estimatedDamage:0,estimatedValue:0,threatenedStructures:[]},o=Game.rooms[e];if(!o){const t=Wt.getEmpire().knownRooms[e];if(t){const e=5*(t.towerCount||0)+10*(t.spawnCount||0)+5;r.estimatedDamage=Ss+_s*e,r.estimatedValue=.01*r.estimatedDamage}return r}const n=o.lookForAtArea(LOOK_STRUCTURES,Math.max(0,t.y-2),Math.max(0,t.x-2),Math.min(49,t.y+2),Math.min(49,t.x+2),!0);for(const e of n){const o=e.structure,n=Math.abs(o.pos.x-t.x),s=Math.abs(o.pos.y-t.y),i=0===Math.max(n,s)?Ss:_s;o.hits>i?r.estimatedDamage+=i:(r.estimatedDamage+=o.hits,r.threatenedStructures.push(`${o.structureType}-${o.pos.x},${o.pos.y}`),r.estimatedValue+=this.estimateStructureValue(o))}return r}estimateStructureValue(e){return bs[e.structureType]||1e3}processCounterNukeStrategies(){var e;const t=Wt.getEmpire();if(t.incomingNukes&&0!==t.incomingNukes.length)for(const r of t.incomingNukes){if(!r.sourceRoom)continue;if(t.warTargets.includes(r.sourceRoom))continue;const o=t.knownRooms[r.sourceRoom];if(!o)continue;if(8>o.controllerLevel)continue;const n=Wt.getSwarmState(r.roomName);if(n&&n.pheromones.war>=this.config.counterNukeWarThreshold)if(this.canAffordNuke()){if(!t.warTargets.includes(r.sourceRoom)){t.warTargets.push(r.sourceRoom),de.warn(`COUNTER-NUKE AUTHORIZED: ${r.sourceRoom} added to war targets for nuke retaliation`,{subsystem:"Nuke"});for(const t in Game.rooms)if(null===(e=Game.rooms[t].controller)||void 0===e?void 0:e.my){const e=Wt.getSwarmState(t);e&&(e.pheromones.war=Math.min(100,e.pheromones.war+30))}}}else de.warn(`Counter-nuke desired against ${r.sourceRoom} but insufficient resources`,{subsystem:"Nuke"})}}canAffordNuke(){var e;let t=0,r=0;for(const o in Game.rooms){const n=Game.rooms[o];(null===(e=n.controller)||void 0===e?void 0:e.my)&&(n.storage&&(t+=n.storage.store.getUsedCapacity(RESOURCE_ENERGY)||0),n.terminal&&(t+=n.terminal.store.getUsedCapacity(RESOURCE_ENERGY)||0,r+=n.terminal.store.getUsedCapacity(RESOURCE_GHODIUM)||0))}return t>=6e5&&r>=1e4}updateNukeEconomics(){var e;const t=Wt.getEmpire();if(!t.nukeEconomics)return;const r=t.nukeEconomics,o=r.totalEnergyCost+r.totalGhodiumCost;if(o>0){const t=r.totalValueDestroyed;r.lastROI=t/o,r.nukesLaunched>0&&r.nukesLaunched%5==0&&de.info(`Nuke economics: ${r.nukesLaunched} nukes, ROI: ${null===(e=r.lastROI)||void 0===e?void 0:e.toFixed(2)}x, Value destroyed: ${(r.totalValueDestroyed/1e3).toFixed(0)}k`,{subsystem:"Nuke"})}}cleanupNukeTracking(){const e=Wt.getEmpire();if(e.nukesInFlight&&(e.nukesInFlight=e.nukesInFlight.filter(e=>e.impactTick>Game.time)),e.incomingNukes){const t=e.incomingNukes.length;e.incomingNukes=e.incomingNukes.filter(e=>e.impactTick>Game.time);const r=t-e.incomingNukes.length;r>0&&de.info(`Cleaned up ${r} impacted nuke alert(s)`,{subsystem:"Nuke"})}}calculateNukeROI(e,t){const r=this.predictNukeImpact(e,t);return 0===r.estimatedValue?0:r.estimatedValue/305e3}};Q([gr("empire:nuke","Nuke Manager",{priority:Be.LOW,interval:500,minBucket:0,cpuBudget:.01})],Os.prototype,"run",null),Os=Q([hr()],Os);const Us=new Os,Ms={updateInterval:200,minBucket:0,minCreditsForPixels:5e5,creditReserve:1e5,minEnergySurplus:5e5,energyThresholdPerRoom:1e5,maxPixelPrice:5e3,targetPixelPrice:2e3,maxPixelsPerTransaction:10,purchaseCooldown:1e3,minBaseMineralReserve:1e4,criticalResourceThresholds:{[RESOURCE_GHODIUM]:5e3},enabled:!0};let As=class{constructor(e={}){this.lastRun=0,this.config={...Ms,...e}}run(){this.config.enabled&&(this.lastRun=Game.time,this.ensurePixelBuyingMemory(),this.isPurchaseCooldownComplete()&&(this.hasSurplusResources()?this.hasEnoughCredits()?(this.attemptPixelPurchase(),this.updateMemory()):de.debug("Pixel buying skipped: insufficient credits",{subsystem:"PixelBuying"}):de.debug("Pixel buying skipped: no resource surplus",{subsystem:"PixelBuying"})))}ensurePixelBuyingMemory(){const e=Wt.getEmpire();if(!e.market)return;const t=e.market;t.pixelBuying||(t.pixelBuying={lastPurchaseTick:0,totalPixelsPurchased:0,totalCreditsSpent:0,purchaseHistory:[],lastScan:0})}getPixelBuyingMemory(){const e=Wt.getEmpire();if(e.market)return e.market.pixelBuying}isPurchaseCooldownComplete(){const e=this.getPixelBuyingMemory();return!e||Game.time-e.lastPurchaseTick>=this.config.purchaseCooldown}hasSurplusResources(){var e,t;const r=this.calculateTotalResources(),o=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my}).length,n=o*this.config.energyThresholdPerRoom;if(r.energy<n+this.config.minEnergySurplus)return de.debug(`Pixel buying: energy below surplus (${r.energy} < ${n+this.config.minEnergySurplus})`,{subsystem:"PixelBuying"}),!1;for(const[t,o]of Object.entries(this.config.criticalResourceThresholds)){const n=null!==(e=r[t])&&void 0!==e?e:0;if(o>n)return de.debug(`Pixel buying: ${t} below threshold (${n} < ${o})`,{subsystem:"PixelBuying"}),!1}const s=[RESOURCE_HYDROGEN,RESOURCE_OXYGEN,RESOURCE_UTRIUM,RESOURCE_LEMERGIUM,RESOURCE_KEANIUM,RESOURCE_ZYNTHIUM,RESOURCE_CATALYST];for(const e of s){const o=null!==(t=r[e])&&void 0!==t?t:0;if(o<this.config.minBaseMineralReserve)return de.debug(`Pixel buying: ${e} below reserve (${o} < ${this.config.minBaseMineralReserve})`,{subsystem:"PixelBuying"}),!1}return!0}hasEnoughCredits(){return Game.market.credits-this.config.creditReserve>=this.config.minCreditsForPixels}calculateTotalResources(){var e,t,r,o,n;const s={};for(const i in Game.rooms){const a=Game.rooms[i];if(null===(e=a.controller)||void 0===e?void 0:e.my){if(a.terminal)for(const e in a.terminal.store){const o=e;s[o]=(null!==(t=s[o])&&void 0!==t?t:0)+(null!==(r=a.terminal.store[o])&&void 0!==r?r:0)}if(a.storage)for(const e in a.storage.store){const t=e;s[t]=(null!==(o=s[t])&&void 0!==o?o:0)+(null!==(n=a.storage.store[t])&&void 0!==n?n:0)}}}return s}attemptPixelPurchase(){const e=Game.market.getAllOrders({type:ORDER_SELL,resourceType:PIXEL});if(0===e.length)return void de.debug("No pixel sell orders available",{subsystem:"PixelBuying"});const t=e.filter(e=>e.price<=this.config.maxPixelPrice&&e.amount>0).sort((e,t)=>e.price-t.price);if(0===t.length)return void de.debug(`No pixel orders below max price (${this.config.maxPixelPrice})`,{subsystem:"PixelBuying"});const r=t[0],o=r.price<=this.config.targetPixelPrice;if(!o&&Game.time%1e3!=0)return void de.debug(`Pixel price (${r.price}) above target (${this.config.targetPixelPrice}), waiting`,{subsystem:"PixelBuying"});const n=Object.values(Game.rooms).find(e=>{var t;return e.terminal&&(null===(t=e.controller)||void 0===t?void 0:t.my)&&!e.terminal.cooldown});if(!(null==n?void 0:n.terminal))return void de.debug("No terminal available for pixel purchase",{subsystem:"PixelBuying"});const s=Game.market.credits-this.config.creditReserve,i=Math.floor(s/r.price),a=Math.min(this.config.maxPixelsPerTransaction,r.amount,i);if(0>=a)return void de.debug("Cannot afford any pixels after reserve",{subsystem:"PixelBuying"});const c=r.roomName?Game.market.calcTransactionCost(a,n.name,r.roomName):0;if(n.terminal.store[RESOURCE_ENERGY]<c)return void de.debug(`Not enough energy for pixel transaction (need ${c})`,{subsystem:"PixelBuying"});const l=Game.market.deal(r.id,a,n.name);if(l===OK){const e=a*r.price;this.recordPurchase({tick:Game.time,amount:a,pricePerUnit:r.price,totalCost:e,orderId:r.id,fromRoom:n.name}),de.info(`Purchased ${a} pixels at ${r.price.toFixed(2)} credits each (total: ${e.toFixed(0)} credits)${o?" (GOOD PRICE!)":""}`,{subsystem:"PixelBuying"})}else de.warn("Failed to purchase pixels: error code "+l,{subsystem:"PixelBuying"})}recordPurchase(e){const t=this.getPixelBuyingMemory();if(t)for(t.lastPurchaseTick=e.tick,t.totalPixelsPurchased+=e.amount,t.totalCreditsSpent+=e.totalCost,t.purchaseHistory.push(e);t.purchaseHistory.length>50;)t.purchaseHistory.shift()}updateMemory(){const e=this.getPixelBuyingMemory();e&&(e.lastScan=Game.time)}getStats(){const e=this.getPixelBuyingMemory();if(e)return{totalPurchased:e.totalPixelsPurchased,totalSpent:e.totalCreditsSpent,averagePrice:e.totalPixelsPurchased>0?e.totalCreditsSpent/e.totalPixelsPurchased:0,lastPurchaseTick:e.lastPurchaseTick,recentPurchases:e.purchaseHistory.slice(-10)}}canBuyPixels(){const e=[];if(this.config.enabled||e.push("Pixel buying is disabled"),!this.isPurchaseCooldownComplete()){const t=this.getPixelBuyingMemory(),r=t?this.config.purchaseCooldown-(Game.time-t.lastPurchaseTick):0;e.push(`On cooldown (${r} ticks remaining)`)}return this.hasSurplusResources()||e.push("No resource surplus"),this.hasEnoughCredits()||e.push(`Insufficient credits (need ${this.config.minCreditsForPixels} above ${this.config.creditReserve} reserve)`),{canBuy:0===e.length,reasons:e}}updateConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}enable(){this.config.enabled=!0,de.info("Pixel buying enabled",{subsystem:"PixelBuying"})}disable(){this.config.enabled=!1,de.info("Pixel buying disabled",{subsystem:"PixelBuying"})}};Q([gr("empire:pixelBuying","Pixel Buying Manager",{priority:Be.IDLE,interval:200,minBucket:0,cpuBudget:.01})],As.prototype,"run",null),As=Q([hr()],As);const ws=new As,ks={enabled:!0,fullBucketTicksRequired:25,bucketMax:1e4,cpuCostPerPixel:1e4,minBucketAfterGeneration:0};let Ns=class{constructor(e={}){this.config={...ks,...e}}run(){if(!this.config.enabled)return;this.ensurePixelGenerationMemory();const e=this.getPixelGenerationMemory();e&&(Game.cpu.bucket<this.config.bucketMax?(e.consecutiveFullTicks=0,e.bucketFullSince=0):(0===e.consecutiveFullTicks&&(e.bucketFullSince=Game.time),e.consecutiveFullTicks++),this.shouldGeneratePixel(e)&&this.generatePixel(e))}ensurePixelGenerationMemory(){const e=global;e._pixelGenerationMemory||(e._pixelGenerationMemory={bucketFullSince:0,consecutiveFullTicks:0,totalPixelsGenerated:0,lastGenerationTick:0})}getPixelGenerationMemory(){return global._pixelGenerationMemory}shouldGeneratePixel(e){return e.consecutiveFullTicks>=this.config.fullBucketTicksRequired&&Game.cpu.bucket>=this.config.bucketMax&&Game.cpu.bucket>=this.config.cpuCostPerPixel}generatePixel(e){const t=Game.cpu.generatePixel();if(t===OK){e.totalPixelsGenerated++,e.lastGenerationTick=Game.time;const t=e.bucketFullSince>0?Game.time-e.bucketFullSince:e.consecutiveFullTicks;e.consecutiveFullTicks=0,e.bucketFullSince=0,de.info(`Generated pixel from CPU bucket (total generated: ${e.totalPixelsGenerated})`,{subsystem:"PixelGeneration",meta:{bucket:Game.cpu.bucket,ticksWaited:t}})}else de.warn("Failed to generate pixel: error code "+t,{subsystem:"PixelGeneration",meta:{bucket:Game.cpu.bucket,result:t}})}getStats(){var e,t,r,o;const n=this.getPixelGenerationMemory(),s=!!n&&this.shouldGeneratePixel(n),i=n?Math.max(0,this.config.fullBucketTicksRequired-n.consecutiveFullTicks):this.config.fullBucketTicksRequired;return{enabled:this.config.enabled,totalGenerated:null!==(e=null==n?void 0:n.totalPixelsGenerated)&&void 0!==e?e:0,lastGenerationTick:null!==(t=null==n?void 0:n.lastGenerationTick)&&void 0!==t?t:0,bucketFullSince:null!==(r=null==n?void 0:n.bucketFullSince)&&void 0!==r?r:0,consecutiveFullTicks:null!==(o=null==n?void 0:n.consecutiveFullTicks)&&void 0!==o?o:0,canGenerate:s,ticksUntilGeneration:i}}enable(){this.config.enabled=!0,de.info("Pixel generation enabled",{subsystem:"PixelGeneration"})}disable(){this.config.enabled=!1,de.info("Pixel generation disabled",{subsystem:"PixelGeneration"})}updateConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}};Q([gr("empire:pixelGeneration","Pixel Generation Manager",{priority:Be.IDLE,interval:1,minBucket:0,cpuBudget:.01})],Ns.prototype,"run",null),Ns=Q([hr()],Ns);const Ps=new Ns,Is={minPower:1e3,maxDistance:5,minTicksRemaining:3e3,healerRatio:.5,minBucket:0,maxConcurrentOps:2};let xs=class{constructor(e={}){this.operations=new Map,this.lastScan=0,this.config={...Is,...e}}run(){50>Game.time-this.lastScan||(this.scanForPowerBanks(),this.lastScan=Game.time),this.updateOperations(),this.evaluateOpportunities(),Game.time%100==0&&this.operations.size>0&&this.logStatus()}scanForPowerBanks(){var e,t;const r=Wt.getEmpire();for(const o in Game.rooms){const n=Game.rooms[o],s=o.match(/^[WE](\d+)[NS](\d+)$/);if(!s)continue;const i=parseInt(s[1],10),a=parseInt(s[2],10);if(i%10!=0&&a%10!=0)continue;const c=n.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_POWER_BANK});for(const n of c){const s=r.powerBanks.find(e=>e.roomName===o&&e.pos.x===n.pos.x&&e.pos.y===n.pos.y);if(s)s.power=n.power,s.decayTick=Game.time+(null!==(t=n.ticksToDecay)&&void 0!==t?t:5e3);else{const t={roomName:o,pos:{x:n.pos.x,y:n.pos.y},power:n.power,decayTick:Game.time+(null!==(e=n.ticksToDecay)&&void 0!==e?e:5e3),active:!1};r.powerBanks.push(t),n.power<this.config.minPower||de.info(`Power bank discovered in ${o}: ${n.power} power`,{subsystem:"PowerBank"})}}}r.powerBanks=r.powerBanks.filter(e=>e.decayTick>Game.time)}updateOperations(){for(const[e,t]of this.operations)switch(t.state){case"scouting":this.updateScoutingOp(t);break;case"attacking":this.updateAttackingOp(t);break;case"collecting":this.updateCollectingOp(t);break;case"complete":case"failed":Game.time-t.startedAt>1e4&&this.operations.delete(e)}}updateScoutingOp(e){var t;const r=Game.rooms[e.roomName];if(!r)return;const o=r.find(FIND_STRUCTURES,{filter:t=>t.structureType===STRUCTURE_POWER_BANK&&t.pos.x===e.pos.x&&t.pos.y===e.pos.y})[0];if(!o)return e.state="failed",void de.warn(`Power bank in ${e.roomName} disappeared`,{subsystem:"PowerBank"});e.power=o.power,e.decayTick=Game.time+(null!==(t=o.ticksToDecay)&&void 0!==t?t:0),e.assignedCreeps.attackers.length>0&&(e.state="attacking",de.info("Starting attack on power bank in "+e.roomName,{subsystem:"PowerBank"}))}updateAttackingOp(e){var t;const r=Game.rooms[e.roomName];if(e.assignedCreeps.attackers=e.assignedCreeps.attackers.filter(e=>Game.creeps[e]),e.assignedCreeps.healers=e.assignedCreeps.healers.filter(e=>Game.creeps[e]),!r)return void(0===e.assignedCreeps.attackers.length&&0===e.assignedCreeps.healers.length&&(e.state="failed"));const o=r.find(FIND_STRUCTURES,{filter:t=>t.structureType===STRUCTURE_POWER_BANK&&t.pos.x===e.pos.x&&t.pos.y===e.pos.y})[0];if(!o)return e.state="collecting",void de.info(`Power bank destroyed in ${e.roomName}, collecting power`,{subsystem:"PowerBank"});const n=null!==(t=e.lastHits)&&void 0!==t?t:2e6;e.lastHits=o.hits,n>o.hits&&(e.damageDealt+=n-o.hits);const s=e.decayTick-Game.time,i=e.damageDealt/Math.max(1,Game.time-e.startedAt),a=o.hits/Math.max(1,i);a>.9*s&&de.warn(`Power bank in ${e.roomName} may decay before completion (${Math.round(a)} > ${s})`,{subsystem:"PowerBank"}),e.estimatedCompletion=Game.time+Math.round(a)}updateCollectingOp(e){const t=Game.rooms[e.roomName];if(e.assignedCreeps.carriers=e.assignedCreeps.carriers.filter(e=>Game.creeps[e]),!t)return void(0===e.assignedCreeps.carriers.length&&(e.state="failed"));const r=t.find(FIND_DROPPED_RESOURCES,{filter:e=>e.resourceType===RESOURCE_POWER}),o=t.find(FIND_RUINS,{filter:e=>e.store.getUsedCapacity(RESOURCE_POWER)>0});0===r.length&&0===o.length&&(e.state="complete",de.info(`Power bank operation complete in ${e.roomName}: ${e.powerCollected} power collected`,{subsystem:"PowerBank"}))}evaluateOpportunities(){var e,t;if(Array.from(this.operations.values()).filter(e=>"complete"!==e.state&&"failed"!==e.state).length>=this.config.maxConcurrentOps)return;const r=Wt.getEmpire(),o=Object.values(Game.rooms).filter(e=>{var t;return(null===(t=e.controller)||void 0===t?void 0:t.my)&&e.controller.level>=7});if(0===o.length)return;const n=r.powerBanks.filter(e=>!(e.active||this.operations.has(e.roomName)||e.power<this.config.minPower||e.decayTick-Game.time<this.config.minTicksRemaining||this.getMinDistanceToOwned(e.roomName,o)>this.config.maxDistance)).map(e=>({entry:e,score:this.scorePowerBank(e,o)})).sort((e,t)=>t.score-e.score);if(n.length>0&&(null!==(t=null===(e=n[0])||void 0===e?void 0:e.score)&&void 0!==t?t:0)>0){const e=n[0];this.startOperation(e.entry,o)}}scorePowerBank(e,t){let r=0;r+=.01*e.power;const o=e.decayTick-Game.time;return o>4e3&&(r+=50),o>5e3&&(r+=30),r-=20*this.getMinDistanceToOwned(e.roomName,t),3e3>e.power||(r+=50),5e3>e.power||(r+=50),r}getMinDistanceToOwned(e,t){let r=1/0;for(const o of t){const t=Game.map.getRoomLinearDistance(e,o.name);r>t&&(r=t)}return r}startOperation(e,t){let r=null,o=1/0;for(const n of t){const t=Game.map.getRoomLinearDistance(e.roomName,n.name);o>t&&(o=t,r=n)}if(!r)return;const n={roomName:e.roomName,pos:e.pos,power:e.power,decayTick:e.decayTick,homeRoom:r.name,state:"scouting",assignedCreeps:{attackers:[],healers:[],carriers:[]},damageDealt:0,powerCollected:0,startedAt:Game.time,estimatedCompletion:0};this.operations.set(e.roomName,n),e.active=!0,de.info(`Started power bank operation in ${e.roomName} (${e.power} power, home: ${r.name})`,{subsystem:"PowerBank"})}assignCreep(e,t,r){const o=this.operations.get(t);if(!o)return!1;switch(r){case"attacker":o.assignedCreeps.attackers.includes(e)||o.assignedCreeps.attackers.push(e);break;case"healer":o.assignedCreeps.healers.includes(e)||o.assignedCreeps.healers.push(e);break;case"carrier":o.assignedCreeps.carriers.includes(e)||o.assignedCreeps.carriers.push(e)}return!0}recordPowerCollected(e,t){const r=this.operations.get(e);r&&(r.powerCollected+=t)}getActiveOperations(){return Array.from(this.operations.values()).filter(e=>"complete"!==e.state&&"failed"!==e.state)}getOperation(e){return this.operations.get(e)}getRequiredCreeps(e){const t=e.decayTick-Game.time,r=2e6-e.damageDealt,o=Math.ceil(r/(.8*t)/600),n=Math.ceil(o*this.config.healerRatio),s=Math.ceil(e.power/2e3);return{attackers:Math.max(1,o),healers:Math.max(1,n),carriers:Math.max(1,s)}}requestSpawns(e){let t=0,r=0,o=0;for(const[n,s]of this.operations){if(s.homeRoom!==e)continue;if("complete"===s.state||"failed"===s.state)continue;const n=this.getRequiredCreeps(s),i={attackers:s.assignedCreeps.attackers.filter(e=>Game.creeps[e]).length,healers:s.assignedCreeps.healers.filter(e=>Game.creeps[e]).length,carriers:s.assignedCreeps.carriers.filter(e=>Game.creeps[e]).length};"attacking"!==s.state&&"scouting"!==s.state||(t+=Math.max(0,n.attackers-i.attackers),r+=Math.max(0,n.healers-i.healers)),"collecting"!==s.state&&"attacking"!==s.state||(o+=Math.max(0,n.carriers-i.carriers))}return{powerHarvesters:t,healers:r,powerCarriers:o}}getProfitability(e,t){const r=Game.map.getRoomLinearDistance(e.roomName,t);e.decayTick,Game.time;const o=50*r+1667,n=7200+.1*o,s=10*e.power-n,i=o>0?s/o:0;return{power:e.power,energyCost:n,netProfit:s,profitPerTick:i}}logStatus(){const e=Array.from(this.operations.values()).filter(e=>"complete"!==e.state&&"failed"!==e.state);for(const t of e)de.info(`Power bank op ${t.roomName}: ${t.state}, ${t.assignedCreeps.attackers.length}A/${t.assignedCreeps.healers.length}H/${t.assignedCreeps.carriers.length}C, ${Math.round(t.damageDealt/1e3)}k damage, ${t.powerCollected} collected`,{subsystem:"PowerBank"})}};Q([gr("empire:powerBank","Power Bank Harvesting",{priority:Be.LOW,interval:50,minBucket:0,cpuBudget:.02})],xs.prototype,"run",null),xs=Q([hr()],xs);const $s=new xs,Gs={minGPL:1,minPowerReserve:1e4,energyPerPower:50,minEnergyReserve:1e5,gplMilestones:[1,2,5,10,15,20]},Ls=[PWR_GENERATE_OPS,PWR_OPERATE_SPAWN,PWR_OPERATE_EXTENSION,PWR_OPERATE_TOWER,PWR_OPERATE_LAB,PWR_OPERATE_STORAGE,PWR_REGEN_SOURCE,PWR_OPERATE_FACTORY],Ds=[PWR_GENERATE_OPS,PWR_OPERATE_SPAWN,PWR_SHIELD,PWR_DISRUPT_SPAWN,PWR_DISRUPT_TOWER,PWR_FORTIFY,PWR_OPERATE_TOWER,PWR_DISRUPT_TERMINAL];let Fs=class{constructor(e={}){this.assignments=new Map,this.gplState=null,this.lastGPLUpdate=0,this.config={...Gs,...e}}run(){this.updateGPLState(),this.managePowerProcessing(),this.manageAssignments(),this.checkPowerUpgrades(),this.checkRespawnNeeds(),Game.time%100==0&&this.logStatus()}updateGPLState(){var e,t,r,o,n;if(!Game.gpl)return void(this.gplState=null);const s=Game.gpl.level,i=Game.gpl.progress,a=Game.gpl.progressTotal;let c=0;this.gplState&&this.gplState.currentProgress<i&&(c=i-this.gplState.currentProgress);const l=a-i,u=null!==(t=null===(e=this.gplState)||void 0===e?void 0:e.powerProcessedThisTick)&&void 0!==t?t:1,m=u>0?Math.ceil(l/u):1/0,d=null!==(r=this.config.gplMilestones.find(e=>e>s))&&void 0!==r?r:s+1;this.gplState={currentLevel:s,currentProgress:i,progressNeeded:a,powerProcessedThisTick:c,totalPowerProcessed:(null!==(n=null===(o=this.gplState)||void 0===o?void 0:o.totalPowerProcessed)&&void 0!==n?n:0)+c,ticksToNextLevel:m,targetMilestone:d,lastUpdate:Game.time},this.lastGPLUpdate!==s&&s>0&&(de.info("GPL milestone reached: Level "+s,{subsystem:"PowerCreep"}),this.lastGPLUpdate=s)}managePowerProcessing(){const e=this.evaluatePowerProcessing();for(const t of e){if(!t.shouldProcess)continue;const e=Game.rooms[t.roomName];if(!e)continue;const r=e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_POWER_SPAWN})[0];if(!r)continue;const o=r.store.getUsedCapacity(RESOURCE_POWER)>0,n=r.store.getUsedCapacity(RESOURCE_ENERGY)>=50;o&&n&&r.processPower()===OK&&de.debug(`Processing power in ${t.roomName}: ${t.reason}`,{subsystem:"PowerCreep"})}}evaluatePowerProcessing(){var e,t,r;const o=[],n=Object.values(Game.rooms).filter(e=>{var t;return(null===(t=e.controller)||void 0===t?void 0:t.my)&&e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_POWER_SPAWN}).length>0});for(const s of n){const n=s.storage,i=s.terminal;if(!n&&!i)continue;const a=(null!==(e=null==n?void 0:n.store.getUsedCapacity(RESOURCE_POWER))&&void 0!==e?e:0)+(null!==(t=null==i?void 0:i.store.getUsedCapacity(RESOURCE_POWER))&&void 0!==t?t:0),c=null!==(r=null==n?void 0:n.store.getUsedCapacity(RESOURCE_ENERGY))&&void 0!==r?r:0;let l=!1,u="",m=0;100>a?(l=!1,u="Insufficient power (<100)"):c<this.config.minEnergyReserve?(l=!1,u=`Insufficient energy (<${this.config.minEnergyReserve})`):this.gplState&&this.gplState.currentLevel<this.gplState.targetMilestone?(l=!0,u=`GPL progression: ${this.gplState.currentLevel}  ${this.gplState.targetMilestone}`,m=100-Math.abs(this.gplState.currentLevel-this.gplState.targetMilestone)):a>this.config.minPowerReserve?(l=!0,u=`Excess power (${a} > ${this.config.minPowerReserve})`,m=50):(l=!1,u="Power reserved for power banks"),o.push({roomName:s.name,shouldProcess:l,reason:u,powerAvailable:a,energyAvailable:c,priority:m})}return o.sort((e,t)=>t.priority-e.priority)}manageAssignments(){for(const e in Game.powerCreeps){const t=Game.powerCreeps[e];if(!t)continue;let r=this.assignments.get(e);r?(r.level=t.level,r.spawned=void 0!==t.ticksToLive,r.spawned&&!r.lastRespawnTick&&(r.lastRespawnTick=Game.time)):(r=this.createAssignment(t),this.assignments.set(e,r))}this.considerNewPowerCreeps()}createAssignment(e){var t,r;e.powers[PWR_OPERATE_SPAWN];const o=void 0!==e.powers[PWR_DISRUPT_SPAWN]?"powerWarrior":"powerQueen",n=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my});let s=null!==(r=null===(t=n[0])||void 0===t?void 0:t.name)&&void 0!==r?r:"";if("powerQueen"===o){const e=n.filter(e=>e.controller&&e.controller.level>=7).sort((e,t)=>{var r,o,n,s;const i=100*(null!==(o=null===(r=e.controller)||void 0===r?void 0:r.level)&&void 0!==o?o:0)+e.find(FIND_MY_STRUCTURES).length;return 100*(null!==(s=null===(n=t.controller)||void 0===n?void 0:n.level)&&void 0!==s?s:0)+t.find(FIND_MY_STRUCTURES).length-i})[0];e&&(s=e.name)}else{const e=n.map(e=>({room:e,swarm:Wt.getSwarmState(e.name)})).filter(e=>null!==e.swarm).sort((e,t)=>{const r=100*e.swarm.danger+e.swarm.metrics.hostileCount;return 100*t.swarm.danger+t.swarm.metrics.hostileCount-r})[0];e&&(s=e.room.name)}const i=this.generatePowerPath(o),a={name:e.name,className:e.className,role:o,assignedRoom:s,level:e.level,spawned:void 0!==e.ticksToLive,lastRespawnTick:void 0!==e.ticksToLive?Game.time:void 0,priority:"powerQueen"===o?100:80,powerPath:i},c=e.memory;return c.homeRoom=s,c.role=o,de.info(`Power creep ${e.name} assigned as ${o} to ${s}`,{subsystem:"PowerCreep"}),a}generatePowerPath(e){return("powerQueen"===e?Ls:Ds).filter(e=>{var t,r;const o=POWER_INFO[e];return o&&void 0!==o.level&&o.level[0]<=(null!==(r=null===(t=this.gplState)||void 0===t?void 0:t.currentLevel)&&void 0!==r?r:0)})}checkPowerUpgrades(){if(this.gplState)for(const[e,t]of this.assignments){const r=Game.powerCreeps[e];if(!r)continue;if(r.level>=this.gplState.currentLevel)continue;const o=this.selectNextPower(r,t);if(!o)continue;const n=r.upgrade(o);n===OK?(de.info(`Upgraded ${r.name} to level ${r.level+1} with ${o}`,{subsystem:"PowerCreep"}),t.level=r.level):n!==ERR_NOT_ENOUGH_RESOURCES&&de.warn(`Failed to upgrade ${r.name}: ${n}`,{subsystem:"PowerCreep"})}}selectNextPower(e,t){var r,o,n;const s=null!==(r=t.powerPath)&&void 0!==r?r:this.generatePowerPath(t.role);for(const t of s)if(!e.powers[t]){const e=POWER_INFO[t];if(e&&void 0!==e.level&&e.level[0]<=(null!==(n=null===(o=this.gplState)||void 0===o?void 0:o.currentLevel)&&void 0!==n?n:0))return t}return null}considerNewPowerCreeps(){if(!this.gplState||this.gplState.currentLevel<this.config.minGPL)return;const e=Object.keys(Game.powerCreeps).length,t=this.gplState.currentLevel;if(e>=t)return;const r=Array.from(this.assignments.values()).filter(e=>"powerQueen"===e.role).length,o=Array.from(this.assignments.values()).filter(e=>"powerWarrior"===e.role).length;if(Math.ceil(.7*t)>r||Math.floor(.3*t)>o){const e="operator_"+Game.time,t=POWER_CLASS.OPERATOR,r=PowerCreep.create(e,t);r===OK?de.info(`Created new power creep: ${e} (${t})`,{subsystem:"PowerCreep"}):de.warn("Failed to create power creep: "+r,{subsystem:"PowerCreep"})}}checkRespawnNeeds(){for(const[e,t]of this.assignments){const r=Game.powerCreeps[e];if(r)if(void 0===r.ticksToLive){const o=Game.rooms[t.assignedRoom];if(!o)continue;const n=o.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_POWER_SPAWN})[0];n&&r.spawn(n)===OK&&(de.info(`Power creep ${e} spawned at ${o.name}`,{subsystem:"PowerCreep"}),t.spawned=!0,t.lastRespawnTick=Game.time)}else if(500>r.ticksToLive){const t=r.room;if(!t)continue;const o=t.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_POWER_SPAWN})[0];o&&1>=r.pos.getRangeTo(o)&&r.renew(o)===OK&&de.debug(`Power creep ${e} renewed`,{subsystem:"PowerCreep"})}}}getGPLState(){return this.gplState}getAssignments(){return Array.from(this.assignments.values())}getAssignment(e){return this.assignments.get(e)}reassignPowerCreep(e,t){const r=this.assignments.get(e);if(!r)return!1;r.assignedRoom=t;const o=Game.powerCreeps[e];return o&&(o.memory.homeRoom=t),de.info(`Power creep ${e} reassigned to ${t}`,{subsystem:"PowerCreep"}),!0}logStatus(){if(!this.gplState)return;const e=Array.from(this.assignments.values()).filter(e=>e.spawned),t=e.filter(e=>"powerQueen"===e.role).length,r=e.filter(e=>"powerWarrior"===e.role).length;de.info(`Power System: GPL ${this.gplState.currentLevel} (${this.gplState.currentProgress}/${this.gplState.progressNeeded}), Operators: ${e.length}/${this.gplState.currentLevel} (${t} eco, ${r} combat)`,{subsystem:"PowerCreep"})}};Q([gr("empire:powerCreep","Power Creep Management",{priority:Be.LOW,interval:20,minBucket:0,cpuBudget:.03})],Fs.prototype,"run",null),Fs=Q([hr()],Fs);const Bs=new Fs;function Hs(e,t){var r,o;if((null===(r=e.controller)||void 0===r?void 0:r.owner)&&!e.controller.my)return{lost:!0,reason:"enemyOwned"};const n=function(){const e=Object.values(Game.spawns);return e.length>0?e[0].owner.username:""}();return(null===(o=e.controller)||void 0===o?void 0:o.reservation)&&e.controller.reservation.username!==n?{lost:!0,reason:"enemyReserved"}:2>e.find(FIND_HOSTILE_CREEPS).filter(e=>e.body.some(e=>e.type===ATTACK||e.type===RANGED_ATTACK||e.type===WORK)).length?{lost:!1}:{lost:!0,reason:"hostile"}}function Ws(e,t,r){var o;const n=Wt.getSwarmState(e);if(!n)return;const s=null!==(o=n.remoteAssignments)&&void 0!==o?o:[],i=s.indexOf(t);if(-1!==i){s.splice(i,1),n.remoteAssignments=s;const o=Wt.getEmpire().knownRooms[t];o&&(o.threatLevel=3,o.lastSeen=Game.time),de.warn(`Removed remote room ${t} from ${e} due to: ${r}`,{subsystem:"RemoteRoomManager"})}}function Ys(e){var t;const r=Wt.getSwarmState(e);if(!r)return;const o=null!==(t=r.remoteAssignments)&&void 0!==t?t:[];if(0!==o.length)for(const t of o){const r=Game.rooms[t];if(!r)continue;const o=Hs(r);o.lost&&o.reason&&Ws(e,t,o.reason)}}const Ks={updateInterval:50,minBucket:0,maxSitesPerRemotePerTick:2};let js=class{constructor(e={}){this.config={...Ks,...e}}run(){var e;const t=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my});for(const r of t){const t=Wt.getSwarmState(r.name);if(!t)continue;Ys(r.name);const o=null!==(e=t.remoteAssignments)&&void 0!==e?e:[];if(0!==o.length){for(const e of o)this.planRemoteInfrastructure(r,e);this.placeRemoteRoads(r,o)}}}planRemoteInfrastructure(e,t){const r=Game.rooms[t];if(!r)return;const o=r.controller,n=this.getMyUsername();if(o){if(o.owner&&o.owner.username!==n)return;if(o.reservation&&o.reservation.username!==n)return}const s=r.find(FIND_SOURCES);let i=0;for(const e of s){if(i>=this.config.maxSitesPerRemotePerTick)break;this.placeSourceContainer(r,e)&&i++}}placeSourceContainer(e,t){if(t.pos.findInRange(FIND_STRUCTURES,1,{filter:e=>e.structureType===STRUCTURE_CONTAINER}).length>0)return!1;if(t.pos.findInRange(FIND_CONSTRUCTION_SITES,1,{filter:e=>e.structureType===STRUCTURE_CONTAINER}).length>0)return!1;const r=this.findBestContainerPosition(t);if(!r)return de.warn(`Could not find valid position for container at source ${t.id} in ${e.name}`,{subsystem:"RemoteInfra"}),!1;if(e.find(FIND_CONSTRUCTION_SITES).length>=5)return!1;const o=e.createConstructionSite(r.x,r.y,STRUCTURE_CONTAINER);return o===OK?(de.info(`Placed container construction site at source ${t.id} in ${e.name}`,{subsystem:"RemoteInfra"}),!0):(de.debug(`Failed to place container at source ${t.id} in ${e.name}: ${o}`,{subsystem:"RemoteInfra"}),!1)}findBestContainerPosition(e){const t=e.room,r=t.getTerrain(),o=[];for(let n=-1;1>=n;n++)for(let s=-1;1>=s;s++){if(0===n&&0===s)continue;const i=e.pos.x+n,a=e.pos.y+s;if(1>i||i>48||1>a||a>48)continue;if(r.get(i,a)===TERRAIN_MASK_WALL)continue;if(new RoomPosition(i,a,t.name).lookFor(LOOK_STRUCTURES).length>0)continue;let c=0;for(let e=-1;1>=e;e++)for(let t=-1;1>=t;t++){if(0===e&&0===t)continue;const o=i+e,n=a+t;1>o||o>48||1>n||n>48||r.get(o,n)!==TERRAIN_MASK_WALL&&c++}o.push({x:i,y:a,score:c})}return 0===o.length?null:(o.sort((e,t)=>t.score-e.score),o[0])}placeRemoteRoads(e,t){const r=dn(e,t),o=r.get(e.name);o&&this.placeRoadsInRoom(e,o);for(const e of t){const t=Game.rooms[e];if(!t)continue;const o=r.get(e);o&&this.placeRoadsInRoom(t,o)}}placeRoadsInRoom(e,t){const r=e.find(FIND_CONSTRUCTION_SITES),o=e.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_ROAD});if(r.length>=5)return;const n=new Set(o.map(e=>`${e.pos.x},${e.pos.y}`)),s=new Set(r.filter(e=>e.structureType===STRUCTURE_ROAD).map(e=>`${e.pos.x},${e.pos.y}`)),i=e.getTerrain();let a=0;for(const o of t){if(a>=3)break;if(r.length+a>=5)break;if(n.has(o))continue;if(s.has(o))continue;const[t,c]=o.split(","),l=parseInt(t,10),u=parseInt(c,10);i.get(l,u)!==TERRAIN_MASK_WALL&&e.createConstructionSite(l,u,STRUCTURE_ROAD)===OK&&a++}a>0&&de.debug(`Placed ${a} remote road construction sites in ${e.name}`,{subsystem:"RemoteInfra"})}getMyUsername(){const e=Object.values(Game.spawns);return e.length>0?e[0].owner.username:""}};Q([pr("remote:infrastructure","Remote Infrastructure Manager",{priority:Be.LOW,interval:50,minBucket:0,cpuBudget:.05})],js.prototype,"run",null),js=Q([hr()],js);const Vs=new js,qs={updateInterval:50,minBucket:0,maxCpuBudget:.01};let zs=class{constructor(e={}){this.lastRun=0,this.config={...qs,...e}}run(){this.lastRun=Game.time;const e=InterShardMemory.getLocal();if(!e)return;const t=cr(e);if(!t)return;this.updateEnemyIntelligence(t);const r=ar(t);InterShardMemory.setLocal(r)}updateEnemyIntelligence(e){if(!e)return;const t=Wt.getEmpire(),r=new Map;if(e.globalTargets.enemies)for(const t of e.globalTargets.enemies)r.set(t.username,t);if(t.warTargets)for(const e of t.warTargets){const t=r.get(e);t?(t.lastSeen=Game.time,t.threatLevel=Math.max(t.threatLevel,1)):r.set(e,{username:e,rooms:[],threatLevel:1,lastSeen:Game.time,isAlly:!1})}if(t.knownRooms)for(const e in t.knownRooms){const o=t.knownRooms[e];if(o&&o.owner&&!o.owner.includes("Source Keeper")){const t=r.get(o.owner);t?(t.rooms.includes(e)||t.rooms.push(e),t.lastSeen=Math.max(t.lastSeen,o.lastSeen),t.threatLevel=Math.max(t.threatLevel,o.threatLevel)):r.set(o.owner,{username:o.owner,rooms:[e],threatLevel:o.threatLevel,lastSeen:o.lastSeen,isAlly:!1})}}if(e.globalTargets.enemies=Array.from(r.values()),Game.time%500==0){const t=e.globalTargets.enemies.length,r=e.globalTargets.enemies.filter(e=>e.threatLevel>=2).length;de.info(`Cross-shard intel: ${t} enemies tracked, ${r} high threat`,{subsystem:"CrossShardIntel"})}}getGlobalEnemies(){const e=InterShardMemory.getLocal();if(!e)return[];const t=cr(e);return t&&t.globalTargets.enemies||[]}};Q([gr("empire:crossShardIntel","Cross-Shard Intel",{priority:Be.LOW,interval:50,minBucket:0,cpuBudget:.01})],zs.prototype,"run",null),zs=Q([hr()],zs);const Xs=new zs;function Qs(e){var t;if(!e.controller)return null;const r=function(e){if(!e)return null;try{const t=JSON.parse(e);if("quest"===t.type&&t.id&&t.origin&&"string"==typeof t.info)return t}catch(e){}return null}(null===(t=e.controller.sign)||void 0===t?void 0:t.text);if(!r)return null;const o=e.terminal;return{roomName:e.name,lastSeen:Game.time,hasTerminal:void 0!==o&&!o.my,availableQuests:[r.id]}}function Zs(){var e;return(null===(e=Memory.tooangel)||void 0===e?void 0:e.npcRooms)||{}}function Js(e){const t=Memory;t.tooangel||(t.tooangel={}),t.tooangel.npcRooms||(t.tooangel.npcRooms={});const r=t.tooangel.npcRooms[e.roomName];if(r){const t=new Set([...r.availableQuests,...e.availableQuests]);e.availableQuests=Array.from(t)}t.tooangel.npcRooms[e.roomName]=e}function ei(){const e=Memory;return e.tooangel||(e.tooangel={enabled:!0,reputation:{value:0,lastUpdated:0},npcRooms:{},activeQuests:{},completedQuests:[],lastProcessedTick:0}),e.tooangel.reputation||(e.tooangel.reputation={value:0,lastUpdated:0}),e.tooangel.npcRooms||(e.tooangel.npcRooms={}),e.tooangel.activeQuests||(e.tooangel.activeQuests={}),e.tooangel.completedQuests||(e.tooangel.completedQuests=[]),e.tooangel}function ti(){var e;return(null===(e=ei().reputation)||void 0===e?void 0:e.value)||0}function ri(e){try{const t=JSON.parse(e);if("reputation"===t.type&&"number"==typeof t.reputation)return t.reputation}catch(e){}return null}function oi(e){var t,r;const o=ei(),n=(null===(t=o.reputation)||void 0===t?void 0:t.lastRequestedAt)||0;if(1e3>Game.time-n)return de.debug(`Reputation request on cooldown (${1e3-(Game.time-n)} ticks remaining)`,{subsystem:"TooAngel"}),!1;let s;if(e)s=Game.rooms[e];else for(const e in Game.rooms){const t=Game.rooms[e];if((null===(r=t.controller)||void 0===r?void 0:r.my)&&t.terminal&&t.terminal.my){s=t;break}}if(!s||!s.terminal||!s.terminal.my)return de.warn("No terminal available to request reputation",{subsystem:"TooAngel"}),!1;const i=function(e){const t=Zs();let r=null,o=1/0;for(const n in t){const s=Game.map.getRoomLinearDistance(e,n);o>s&&(o=s,r=t[n])}return r}(s.name);if(!i||!i.hasTerminal)return de.warn("No TooAngel NPC room with terminal found",{subsystem:"TooAngel"}),!1;const a=s.terminal,c=a.store[RESOURCE_ENERGY];if(100>c)return de.warn(`Insufficient energy for reputation request: ${c} < 100`,{subsystem:"TooAngel"}),!1;const l=a.send(RESOURCE_ENERGY,100,i.roomName,JSON.stringify({type:"reputation"}));return l===OK?(de.info(`Sent reputation request to ${i.roomName} from ${s.name}`,{subsystem:"TooAngel"}),o.reputation.lastRequestedAt=Game.time,!0):(de.warn("Failed to send reputation request: "+l,{subsystem:"TooAngel"}),!1)}const ni={MAX_ACTIVE_QUESTS:3,MIN_APPLICATION_ENERGY:100,DEADLINE_BUFFER:500,SUPPORTED_TYPES:["buildcs"]};function si(e){try{const t=JSON.parse(e);if("quest"===t.type&&t.id&&t.room&&t.quest&&"number"==typeof t.end)return t.result||t.end>Game.time?t:(de.debug(`Ignoring quest ${t.id} with past deadline: ${t.end} (current: ${Game.time})`,{subsystem:"TooAngel"}),null)}catch(e){}return null}function ii(){return ei().activeQuests||{}}function ai(){const e=ii();return Object.values(e).filter(e=>"active"===e.status||"applied"===e.status).length<ni.MAX_ACTIVE_QUESTS}function ci(e){return ni.SUPPORTED_TYPES.includes(e)}function li(e,t,r){var o;if(!ai())return de.debug("Cannot accept more quests (at max capacity)",{subsystem:"TooAngel"}),!1;let n;if(r)n=Game.rooms[r];else{let e=1/0;for(const r in Game.rooms){const s=Game.rooms[r];if((null===(o=s.controller)||void 0===o?void 0:o.my)&&s.terminal&&s.terminal.my){const o=Game.map.getRoomLinearDistance(r,t);e>o&&(e=o,n=s)}}}if(!n||!n.terminal||!n.terminal.my)return de.warn("No terminal available to apply for quest",{subsystem:"TooAngel"}),!1;const s=n.terminal,i=s.store[RESOURCE_ENERGY];if(i<ni.MIN_APPLICATION_ENERGY)return de.warn(`Insufficient energy for quest application: ${i} < ${ni.MIN_APPLICATION_ENERGY}`,{subsystem:"TooAngel"}),!1;const a={type:"quest",id:e,action:"apply"},c=s.send(RESOURCE_ENERGY,ni.MIN_APPLICATION_ENERGY,t,JSON.stringify(a));return c===OK?(de.info(`Applied for quest ${e} from ${n.name} to ${t}`,{subsystem:"TooAngel"}),ei().activeQuests[e]={id:e,type:"buildcs",status:"applied",targetRoom:"",originRoom:t,deadline:0,appliedAt:Game.time},!0):(de.warn("Failed to apply for quest: "+c,{subsystem:"TooAngel"}),!1)}function ui(e){const t=ei(),r=t.activeQuests[e.id];r?("won"===e.result?(de.info(`Quest ${e.id} completed successfully!`,{subsystem:"TooAngel"}),r.status="completed"):(de.warn(`Quest ${e.id} failed`,{subsystem:"TooAngel"}),r.status="failed"),r.completedAt=Game.time,t.completedQuests.includes(e.id)||t.completedQuests.push(e.id)):de.warn("Received completion for unknown quest: "+e.id,{subsystem:"TooAngel"})}function mi(e){var t;const r=Game.rooms[e.targetRoom];if(!r)return void de.debug(`Cannot execute buildcs quest ${e.id}: room ${e.targetRoom} not visible`,{subsystem:"TooAngel"});if(function(e){const t=Game.rooms[e];return!!t&&0===t.find(FIND_CONSTRUCTION_SITES).length}(e.targetRoom))return de.info(`Quest ${e.id} (buildcs) completed! All construction sites built in ${e.targetRoom}`,{subsystem:"TooAngel"}),function(e){var t;const r=function(e){return ii()[e]||null}(e);if(!r)return de.warn("Cannot notify completion for unknown quest: "+e,{subsystem:"TooAngel"}),!1;let o;for(const e in Game.rooms){const r=Game.rooms[e];if((null===(t=r.controller)||void 0===t?void 0:t.my)&&r.terminal&&r.terminal.my){o=r;break}}if(!o||!o.terminal)return!1;const n={type:"quest",id:e,room:r.targetRoom,quest:r.type,end:r.deadline,result:"won"};o.terminal.send(RESOURCE_ENERGY,100,r.originRoom,JSON.stringify(n))===OK&&de.info(`Notified quest completion: ${e} (won)`,{subsystem:"TooAngel"})}(e.id),e.status="completed",void(e.completedAt=Game.time);const o=r.find(FIND_CONSTRUCTION_SITES);de.debug(`Quest ${e.id} (buildcs): ${o.length} construction sites remaining in ${e.targetRoom}`,{subsystem:"TooAngel"});const n=e.assignedCreeps||[],s=[];for(const e of n){const t=Game.creeps[e];t&&s.push(t)}if(3>s.length&&o.length>0)for(const r in Game.rooms){const o=Game.rooms[r];if(!(null===(t=o.controller)||void 0===t?void 0:t.my))continue;const i=o.find(FIND_MY_CREEPS,{filter:e=>{const t=e.memory,r=t.role;return!("larvaWorker"!==r&&"builder"!==r||t.questId||t.assistTarget)}});for(const t of i)if(t.memory.questId=e.id,s.push(t),n.push(t.name),de.info(`Assigned ${t.name} to quest ${e.id} (buildcs)`,{subsystem:"TooAngel"}),s.length>=3)break;if(s.length>=3)break}e.assignedCreeps=n;for(const t of s){const r=t.memory;r.questId=e.id,r.questTarget=e.targetRoom,r.questAction="build"}}let di=class{constructor(){this.lastScanTick=0,this.lastReputationRequestTick=0,this.lastQuestDiscoveryTick=0}isEnabled(){var e,t;return null===(t=null===(e=Memory.tooangel)||void 0===e?void 0:e.enabled)||void 0===t||t}enable(){const e=Memory;e.tooangel||(e.tooangel={}),e.tooangel.enabled=!0,de.info("TooAngel integration enabled",{subsystem:"TooAngel"})}disable(){const e=Memory;e.tooangel||(e.tooangel={}),e.tooangel.enabled=!1,de.info("TooAngel integration disabled",{subsystem:"TooAngel"})}run(){if(this.isEnabled()&&Game.cpu.bucket>=2e3)try{!function(){if(!Game.market.incomingTransactions)return;const e=ei();for(const t of Game.market.incomingTransactions){if(t.order)continue;if(!t.description)continue;const r=ri(t.description);null!==r&&(de.info("Received reputation update from TooAngel: "+r,{subsystem:"TooAngel"}),e.reputation={value:r,lastUpdated:Game.time})}}(),function(){if(!Game.market.incomingTransactions)return;const e=ei();for(const t of Game.market.incomingTransactions){if(t.order)continue;if(!t.description)continue;const r=si(t.description);if(r){if(de.info(`Received quest ${r.id}: ${r.quest} in ${r.room} (deadline: ${r.end})`,{subsystem:"TooAngel"}),r.result){ui(r);continue}const o=e.activeQuests[r.id];e.activeQuests[r.id]={id:r.id,type:r.quest,status:"completed"===(null==o?void 0:o.status)||"failed"===(null==o?void 0:o.status)?o.status:"active",targetRoom:r.room,originRoom:r.origin||t.from,deadline:r.end,appliedAt:null==o?void 0:o.appliedAt,receivedAt:Game.time,assignedCreeps:[]},ci(r.quest)||(de.warn("Received unsupported quest type: "+r.quest,{subsystem:"TooAngel"}),e.activeQuests[r.id].status="failed")}}}(),function(){var e;const t=(null===(e=Memory.tooangel)||void 0===e?void 0:e.activeQuests)||{};for(const e in t){const r=t[e];r.assignedCreeps&&(r.assignedCreeps=r.assignedCreeps.filter(e=>void 0!==Game.creeps[e]))}}(),function(){var e;const t=(null===(e=Memory.tooangel)||void 0===e?void 0:e.activeQuests)||{};for(const e in t){const r=t[e];"active"===r.status&&(r.deadline>0&&Game.time>r.deadline?(de.warn(`Quest ${e} missed deadline (${r.deadline})`,{subsystem:"TooAngel"}),r.status="failed",r.completedAt=Game.time):"buildcs"===r.type?mi(r):(de.warn("Unsupported quest type for execution: "+r.type,{subsystem:"TooAngel"}),r.status="failed",r.completedAt=Game.time))}}(),function(){const e=ei().activeQuests||{};for(const t in e){const r=e[t];r.deadline>0&&Game.time>=r.deadline-ni.DEADLINE_BUFFER&&("active"!==r.status&&"applied"!==r.status||(de.warn(`Quest ${t} expired (deadline: ${r.deadline}, current: ${Game.time})`,{subsystem:"TooAngel"}),r.status="failed",r.completedAt=Game.time)),("completed"===r.status||"failed"===r.status)&&r.completedAt&&Game.time-r.completedAt>1e4&&delete e[t]}}(),500>Game.time-this.lastScanTick||(this.scanForNPCs(),this.lastScanTick=Game.time),2e3>Game.time-this.lastReputationRequestTick||(this.updateReputation(),this.lastReputationRequestTick=Game.time),1e3>Game.time-this.lastQuestDiscoveryTick||(this.discoverQuests(),this.lastQuestDiscoveryTick=Game.time)}catch(e){const t="tooangel_error_"+Game.time%100;Memory[t]||(de.error("TooAngel manager error: "+e,{subsystem:"TooAngel"}),Memory[t]=!0)}}scanForNPCs(){const e=function(){const e=[];for(const t in Game.rooms){const r=Qs(Game.rooms[t]);r&&(de.info("Detected TooAngel NPC room: "+t,{subsystem:"TooAngel"}),e.push(r))}return e}();for(const t of e)Js(t);e.length>0&&de.info(`Scanned ${e.length} TooAngel NPC rooms`,{subsystem:"TooAngel"})}updateReputation(){oi()}discoverQuests(){!function(){if(!ai())return;const e=Zs(),t=ii();for(const r in e){const o=e[r];for(const e of o.availableQuests)if(!t[e])return de.info(`Auto-applying for quest ${e} from ${r}`,{subsystem:"TooAngel"}),void li(e,r)}}()}getReputation(){return ti()}getActiveQuests(){return ii()}applyForQuest(e,t,r){return li(e,t,r)}getStatus(){const e=this.getReputation(),t=this.getActiveQuests(),r=Object.values(t).filter(e=>"active"===e.status).length,o=Object.values(t).filter(e=>"applied"===e.status).length,n=[];if(n.push("=== TooAngel Integration ==="),n.push("Enabled: "+this.isEnabled()),n.push("Reputation: "+e),n.push("Active Quests: "+r),n.push("Applied Quests: "+o),n.push(""),Object.keys(t).length>0){n.push("Quests:");for(const e in t){const r=t[e],o=r.deadline-Game.time;n.push(`  ${e}: ${r.type} in ${r.targetRoom} (${r.status}, ${o} ticks left)`)}}return n.join("\n")}};Q([gr("empire:tooangel","TooAngel Manager",{priority:Be.LOW,interval:10})],di.prototype,"run",null),di=Q([hr()],di);const pi=new di,gi={updateInterval:5,decayFactors:{expand:.95,harvest:.9,build:.92,upgrade:.93,defense:.97,war:.98,siege:.99,logistics:.91,nukeTarget:.99},diffusionRates:{expand:.3,harvest:.1,build:.15,upgrade:.1,defense:.4,war:.5,siege:.6,logistics:.2,nukeTarget:.1},maxValue:100,minValue:0};class fi{constructor(e=10){this.maxSamples=e,this.values=[],this.sum=0}add(e){if(this.values.push(e),this.sum+=e,this.values.length>this.maxSamples){const e=this.values.shift();this.sum-=null!=e?e:0}return this.get()}get(){return this.values.length>0?this.sum/this.values.length:0}reset(){this.values=[],this.sum=0}}const hi=new class{constructor(e={}){this.trackers=new Map,this.config={...gi,...e}}getTracker(e){let t=this.trackers.get(e);return t||(t={energyHarvested:new fi(10),energySpawning:new fi(10),energyConstruction:new fi(10),energyRepair:new fi(10),energyTower:new fi(10),controllerProgress:new fi(10),hostileCount:new fi(5),damageReceived:new fi(5),idleWorkers:new fi(10),lastControllerProgress:0},this.trackers.set(e,t)),t}updateMetrics(e,t){var r;const o=this.getTracker(e.name),n="sources_"+e.name,s=global[n];let i;s&&s.tick===Game.time?i=s.sources:(i=e.find(FIND_SOURCES),global[n]={sources:i,tick:Game.time});let a=0,c=0;for(const e of i)a+=e.energyCapacity,c+=e.energy;const l=a-c;if(o.energyHarvested.add(l),null===(r=e.controller)||void 0===r?void 0:r.my){const t=e.controller.progress-o.lastControllerProgress;t>0&&1e5>t&&o.controllerProgress.add(t),o.lastControllerProgress=e.controller.progress}const u=Zr(e,FIND_HOSTILE_CREEPS);o.hostileCount.add(u.length);let m=0;for(const e of u)for(const t of e.body)t.hits>0&&(t.type===ATTACK?m+=30:t.type===RANGED_ATTACK&&(m+=10));o.damageReceived.add(m),t.metrics.energyHarvested=o.energyHarvested.get(),t.metrics.controllerProgress=o.controllerProgress.get(),t.metrics.hostileCount=Math.round(o.hostileCount.get()),t.metrics.damageReceived=o.damageReceived.get()}updatePheromones(e,t){if(Game.time<e.nextUpdateTick)return;const r=e.pheromones;for(const e of Object.keys(r)){const t=this.config.decayFactors[e];r[e]=this.clamp(r[e]*t)}this.calculateContributions(e,t),e.nextUpdateTick=Game.time+this.config.updateInterval,e.lastUpdate=Game.time}calculateContributions(e,t){var r;const o=e.pheromones,n=this.getTracker(t.name),s="sources_"+t.name,i=global[s];let a;if(i&&i.tick===Game.time?a=i.sources:(a=t.find(FIND_SOURCES),global[s]={sources:a,tick:Game.time}),a.length>0){const e=a.reduce((e,t)=>e+t.energy,0)/a.length;o.harvest=this.clamp(o.harvest+e/3e3*10)}const c=t.find(FIND_MY_CONSTRUCTION_SITES);if(c.length>0&&(o.build=this.clamp(o.build+Math.min(2*c.length,20))),null===(r=t.controller)||void 0===r?void 0:r.my){const e=t.controller.progress/t.controller.progressTotal;.5>e&&(o.upgrade=this.clamp(o.upgrade+15*(1-e)))}const l=n.hostileCount.get();if(l>0&&(o.defense=this.clamp(o.defense+10*l)),2>e.danger||(o.war=this.clamp(o.war+10*e.danger)),3>e.danger||(o.siege=this.clamp(o.siege+20)),t.storage){const e=t.find(FIND_MY_SPAWNS),r=e.reduce((e,t)=>e+t.store.getUsedCapacity(RESOURCE_ENERGY),0);150*e.length>r&&(o.logistics=this.clamp(o.logistics+10))}const u=n.energyHarvested.get()-e.metrics.energySpawning;u>0&&0===e.danger&&(o.expand=this.clamp(o.expand+Math.min(u/100,10)))}clamp(e){return Math.max(this.config.minValue,Math.min(this.config.maxValue,e))}onHostileDetected(e,t,r){e.danger=r,e.pheromones.defense=this.clamp(e.pheromones.defense+5*t),2>r||(e.pheromones.war=this.clamp(e.pheromones.war+10*r)),3>r||(e.pheromones.siege=this.clamp(e.pheromones.siege+20)),de.info(`Hostile detected: ${t} hostiles, danger=${r}`,{room:e.role,subsystem:"Pheromone"})}updateDangerFromThreat(e,t,r){e.danger=r,e.pheromones.defense=this.clamp(t/10),2>r||(e.pheromones.war=this.clamp(e.pheromones.war+10*r)),3>r||(e.pheromones.siege=this.clamp(e.pheromones.siege+20))}diffuseDangerToCluster(e,t,r){var o;for(const n of r){if(n===e)continue;const r=Game.rooms[n];if(!(null===(o=null==r?void 0:r.controller)||void 0===o?void 0:o.my))continue;const s=r.memory.swarm;if(!s)continue;const i=this.clamp(t/10),a=s.pheromones.defense,c=.05*Math.max(0,i-a);s.pheromones.defense=this.clamp(a+c)}}onStructureDestroyed(e,t){e.pheromones.defense=this.clamp(e.pheromones.defense+5),e.pheromones.build=this.clamp(e.pheromones.build+10),t!==STRUCTURE_SPAWN&&t!==STRUCTURE_STORAGE&&t!==STRUCTURE_TOWER||(e.danger=Math.min(3,e.danger+1),e.pheromones.siege=this.clamp(e.pheromones.siege+15))}onNukeDetected(e){e.danger=3,e.pheromones.siege=this.clamp(e.pheromones.siege+50),e.pheromones.defense=this.clamp(e.pheromones.defense+30)}onRemoteSourceLost(e){e.pheromones.expand=this.clamp(e.pheromones.expand-10),e.pheromones.defense=this.clamp(e.pheromones.defense+5)}applyDiffusion(e){const t=[];for(const[r,o]of e){const n=this.getNeighborRoomNames(r);for(const s of n){if(!e.get(s))continue;const n=["defense","war","expand","siege"];for(const e of n){const n=o.pheromones[e];if(n>1){const o=this.config.diffusionRates[e];t.push({source:r,target:s,type:e,amount:n*o*.5,sourceIntensity:n})}}}}for(const r of t){const t=e.get(r.target);if(t){const e=t.pheromones[r.type]+r.amount;t.pheromones[r.type]=this.clamp(Math.min(e,r.sourceIntensity))}}}getNeighborRoomNames(e){const t=e.match(/^([WE])(\d+)([NS])(\d+)$/);if(!t)return[];const[,r,o,n,s]=t;if(!(r&&o&&n&&s))return[];const i=parseInt(o,10),a=parseInt(s,10),c=[];return"N"===n?c.push(`${r}${i}N${a+1}`):a>0?c.push(`${r}${i}S${a-1}`):c.push(`${r}${i}N0`),"S"===n?c.push(`${r}${i}S${a+1}`):a>0?c.push(`${r}${i}N${a-1}`):c.push(`${r}${i}S0`),"E"===r?c.push(`E${i+1}${n}${a}`):i>0?c.push(`W${i-1}${n}${a}`):c.push(`E0${n}${a}`),"W"===r?c.push(`W${i+1}${n}${a}`):i>0?c.push(`E${i-1}${n}${a}`):c.push(`W0${n}${a}`),c}getDominantPheromone(e){let t=null,r=1;for(const o of Object.keys(e))e[o]>r&&(r=e[o],t=o);return t}},yi=new class{constructor(){this.configs=new Map}initialize(e){var t;const r=Game.rooms[e];if(!r||!(null===(t=r.controller)||void 0===t?void 0:t.my))return;const o=r.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LAB});if(0===o.length)return void this.configs.delete(e);let n=this.configs.get(e);n||(n={roomName:e,labs:[],lastUpdate:Game.time,isValid:!1},this.configs.set(e,n)),this.updateLabEntries(n,o),n.isValid||this.autoAssignRoles(n,o)}updateLabEntries(e,t){e.labs=e.labs.filter(e=>t.some(t=>t.id===e.labId));for(const r of t)e.labs.find(e=>e.labId===r.id)||e.labs.push({labId:r.id,role:"unassigned",pos:{x:r.pos.x,y:r.pos.y},lastConfigured:Game.time});e.lastUpdate=Game.time}autoAssignRoles(e,t){var r,o,n,s;if(3>t.length)return void(e.isValid=!1);const i=new Map;for(const e of t){const r=[];for(const o of t)e.id===o.id||e.pos.getRangeTo(o)>2||r.push(o.id);i.set(e.id,r)}const a=t.map(e=>{var t,r;return{lab:e,reach:null!==(r=null===(t=i.get(e.id))||void 0===t?void 0:t.length)&&void 0!==r?r:0}}).sort((e,t)=>t.reach-e.reach);if(3>a.length||2>(null!==(o=null===(r=a[0])||void 0===r?void 0:r.reach)&&void 0!==o?o:0))return e.isValid=!1,void de.warn(`Lab layout in ${e.roomName} is not optimal for reactions`,{subsystem:"Labs"});const c=null===(n=a[0])||void 0===n?void 0:n.lab,l=null===(s=a[1])||void 0===s?void 0:s.lab;if(c&&l){for(const t of e.labs)if(t.labId===c.id)t.role="input1",t.lastConfigured=Game.time;else if(t.labId===l.id)t.role="input2",t.lastConfigured=Game.time;else{const e=2>=c.pos.getRangeTo(Game.getObjectById(t.labId)),r=2>=l.pos.getRangeTo(Game.getObjectById(t.labId));t.role=e&&r?"output":"boost",t.lastConfigured=Game.time}e.isValid=!0,e.lastUpdate=Game.time,de.info(`Auto-assigned lab roles in ${e.roomName}: `+e.labs.filter(e=>"input1"===e.role).length+" input1, "+e.labs.filter(e=>"input2"===e.role).length+" input2, "+e.labs.filter(e=>"output"===e.role).length+" output, "+e.labs.filter(e=>"boost"===e.role).length+" boost",{subsystem:"Labs"})}else e.isValid=!1}getConfig(e){return this.configs.get(e)}getLabsByRole(e,t){const r=this.configs.get(e);return r?r.labs.filter(e=>e.role===t).map(e=>Game.getObjectById(e.labId)).filter(e=>null!==e):[]}getInputLabs(e){var t,r;const o=this.configs.get(e);if(!o)return{};const n=o.labs.find(e=>"input1"===e.role),s=o.labs.find(e=>"input2"===e.role);return{input1:n&&null!==(t=Game.getObjectById(n.labId))&&void 0!==t?t:void 0,input2:s&&null!==(r=Game.getObjectById(s.labId))&&void 0!==r?r:void 0}}getOutputLabs(e){return this.getLabsByRole(e,"output")}getBoostLabs(e){return this.getLabsByRole(e,"boost")}setActiveReaction(e,t,r,o){const n=this.configs.get(e);if(!n||!n.isValid)return!1;n.activeReaction={input1:t,input2:r,output:o};const s=n.labs.find(e=>"input1"===e.role),i=n.labs.find(e=>"input2"===e.role);s&&(s.resourceType=t),i&&(i.resourceType=r);for(const e of n.labs.filter(e=>"output"===e.role))e.resourceType=o;return n.lastUpdate=Game.time,de.info(`Set active reaction in ${e}: ${t} + ${r} -> ${o}`,{subsystem:"Labs"}),!0}clearActiveReaction(e){const t=this.configs.get(e);if(t){delete t.activeReaction;for(const e of t.labs)delete e.resourceType;t.lastUpdate=Game.time}}setLabRole(e,t,r,o){const n=this.configs.get(e);if(!n)return!1;const s=n.labs.find(e=>e.labId===t);return!!s&&(s.role=r,s.resourceType=o,s.lastConfigured=Game.time,this.validateConfig(n),!0)}validateConfig(e){const t=e.labs.some(e=>"input1"===e.role),r=e.labs.some(e=>"input2"===e.role),o=e.labs.some(e=>"output"===e.role);if(e.isValid=t&&r&&o,e.isValid){const t=e.labs.find(e=>"input1"===e.role),r=e.labs.find(e=>"input2"===e.role),o=e.labs.filter(e=>"output"===e.role);if(t&&r&&o.length>0){const n=Game.getObjectById(t.labId),s=Game.getObjectById(r.labId);if(n&&s){const t=o.some(e=>{const t=Game.getObjectById(e.labId);return t&&2>=n.pos.getRangeTo(t)&&2>=s.pos.getRangeTo(t)});e.isValid=t}else e.isValid=!1}}}runReactions(e){const t=this.configs.get(e);if(!t||!t.isValid||!t.activeReaction)return 0;const{input1:r,input2:o}=this.getInputLabs(e);if(!r||!o)return 0;const n=this.getOutputLabs(e);let s=0;for(const e of n)0===e.cooldown&&e.runReaction(r,o)===OK&&s++;return s}saveToMemory(e){const t=this.configs.get(e);if(!t)return;const r=Memory.rooms[e];if(r){r.labConfig=t;const o=`memory:room:${e}:labConfig`;bt.set(o,t,vt)}}loadFromMemory(e){const t=`memory:room:${e}:labConfig`;let r=bt.get(t);if(!r){const o=Memory.rooms[e],n=null==o?void 0:o.labConfig;n&&(bt.set(t,n,vt),r=n)}r&&this.configs.set(e,r)}getConfiguredRooms(){return Array.from(this.configs.keys())}hasValidConfig(e){var t;const r=this.configs.get(e);return null!==(t=null==r?void 0:r.isValid)&&void 0!==t&&t}};let Ri=class{cleanupMemory(){for(const e in Memory.creeps)Game.creeps[e]||delete Memory.creeps[e]}checkMemorySize(){const e=RawMemory.get().length,t=e/2097152*100;t>90?de.error(`Memory usage critical: ${t.toFixed(1)}% (${e}/2097152 bytes)`,{subsystem:"Memory"}):t>75&&de.warn(`Memory usage high: ${t.toFixed(1)}% (${e}/2097152 bytes)`,{subsystem:"Memory"})}updateMemorySegmentStats(){Ye.memorySegmentStats.run()}runPheromoneDiffusion(){const e=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my}),t=new Map;for(const r of e){const e=Wt.getSwarmState(r.name);e&&t.set(r.name,e)}hi.applyDiffusion(t)}initializeLabConfigs(){const e=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my});for(const t of e)yi.initialize(t.name)}precacheRoomPaths(){}};Q([gr("core:memoryCleanup","Memory Cleanup",{priority:Be.LOW,interval:50,cpuBudget:.01})],Ri.prototype,"cleanupMemory",null),Q([fr("core:memorySizeCheck","Memory Size Check",{interval:100,cpuBudget:.005})],Ri.prototype,"checkMemorySize",null),Q([pr("core:memorySegmentStats","Memory Segment Stats",{priority:Be.IDLE,interval:10,cpuBudget:.01})],Ri.prototype,"updateMemorySegmentStats",null),Q([pr("cluster:pheromoneDiffusion","Pheromone Diffusion",{priority:Be.MEDIUM,interval:10,cpuBudget:.02})],Ri.prototype,"runPheromoneDiffusion",null),Q([gr("room:labConfig","Lab Config Manager",{priority:Be.LOW,interval:200,cpuBudget:.01})],Ri.prototype,"initializeLabConfigs",null),Q([fr("room:pathCachePrecache","Path Cache Precache (Disabled)",{interval:1e3,cpuBudget:.01})],Ri.prototype,"precacheRoomPaths",null),Ri=Q([hr()],Ri);const Ei=new Ri;var Ti,Ci={},vi={};function Si(){return Ti||(Ti=1,Object.defineProperty(vi,"__esModule",{value:!0}),vi.VisualizationLayer=void 0,function(e){e[e.None=0]="None",e[e.Pheromones=1]="Pheromones",e[e.Paths=2]="Paths",e[e.Traffic=4]="Traffic",e[e.Defense=8]="Defense",e[e.Economy=16]="Economy",e[e.Construction=32]="Construction",e[e.Performance=64]="Performance"}(e||(vi.VisualizationLayer=e={}))),vi;var e}var _i,bi,Oi={},Ui={};function Mi(){if(_i)return Ui;function e(e){try{return JSON.stringify(e)}catch(t){try{return e+""}catch{return"[Unserializable]"}}}return _i=1,Object.defineProperty(Ui,"__esModule",{value:!0}),Ui.createLogger=function(t){return{info(r,o){o?console.log(`[${t}] ${r}`,e(o)):console.log(`[${t}] ${r}`)},warn(r,o){o?console.log(`[${t}] WARN: ${r}`,e(o)):console.log(`[${t}] WARN: ${r}`)},error(r,o){o?console.log(`[${t}] ERROR: ${r}`,e(o)):console.log(`[${t}] ERROR: ${r}`)},debug(r,o){o?console.log(`[${t}] DEBUG: ${r}`,e(o)):console.log(`[${t}] DEBUG: ${r}`)}}},Ui}function Ai(){if(bi)return Oi;bi=1,Object.defineProperty(Oi,"__esModule",{value:!0}),Oi.visualizationManager=Oi.VisualizationManager=void 0,Oi.getVisualizationManager=n;const e=Si(),t=(0,Mi().createLogger)("VisualizationManager");class r{config;perfSamples={};constructor(){this.config=this.loadConfig()}loadConfig(){const e=Memory;return e.visualConfig||(e.visualConfig=this.createDefaultConfig()),e.visualConfig}saveConfig(){Memory.visualConfig=this.config}createDefaultConfig(){return{enabledLayers:e.VisualizationLayer.Pheromones|e.VisualizationLayer.Defense,mode:"presentation",layerCosts:{pheromones:0,paths:0,traffic:0,defense:0,economy:0,construction:0},totalCost:0,cache:{terrain:{},structures:{}},lastCacheClear:Game.time}}isLayerEnabled(e){return 0!==(this.config.enabledLayers&e)}enableLayer(e){this.config.enabledLayers|=e,this.saveConfig()}disableLayer(e){this.config.enabledLayers&=~e,this.saveConfig()}toggleLayer(e){this.config.enabledLayers^=e,this.saveConfig()}setMode(r){switch(this.config.mode=r,r){case"debug":this.config.enabledLayers=e.VisualizationLayer.Pheromones|e.VisualizationLayer.Paths|e.VisualizationLayer.Traffic|e.VisualizationLayer.Defense|e.VisualizationLayer.Economy|e.VisualizationLayer.Construction|e.VisualizationLayer.Performance;break;case"presentation":this.config.enabledLayers=e.VisualizationLayer.Pheromones|e.VisualizationLayer.Defense|e.VisualizationLayer.Economy;break;case"minimal":this.config.enabledLayers=e.VisualizationLayer.Defense;break;case"performance":this.config.enabledLayers=e.VisualizationLayer.None}this.saveConfig(),t.info("Visualization mode set to: "+r)}updateFromFlags(){const r=Game.flags,o={viz_pheromones:e.VisualizationLayer.Pheromones,viz_paths:e.VisualizationLayer.Paths,viz_traffic:e.VisualizationLayer.Traffic,viz_defense:e.VisualizationLayer.Defense,viz_economy:e.VisualizationLayer.Economy,viz_construction:e.VisualizationLayer.Construction,viz_performance:e.VisualizationLayer.Performance};for(const[n,s]of Object.entries(o))Object.values(r).some(e=>e.name===n)&&!this.isLayerEnabled(s)&&(this.enableLayer(s),t.info(`Enabled layer ${e.VisualizationLayer[s]} via flag`))}trackLayerCost(e,r){this.perfSamples[e]||(this.perfSamples[e]=[]),this.perfSamples[e].push(r),this.perfSamples[e].length>10&&this.perfSamples[e].shift();const o=this.perfSamples[e],n=o.reduce((e,t)=>e+t,0)/o.length;this.config.layerCosts[e]=n,this.config.totalCost=Object.values(this.config.layerCosts).reduce((e,t)=>e+t,0);const s=Game.cpu.limit,i=this.config.totalCost/s*100;i>10&&t.warn(`Visualization using ${i.toFixed(1)}% of CPU budget`)}getCachedTerrain(e){const t=this.config.cache.terrain[e];return!t||Game.time>t.ttl?null:t.data}cacheTerrain(e,t){this.config.cache.terrain[e]={data:t,ttl:Game.time+100}}getCachedStructures(e){const t=this.config.cache.structures[e];return!t||Game.time>t.ttl?null:t.data}cacheStructures(e,t){this.config.cache.structures[e]={data:t,ttl:Game.time+100}}clearCache(e){e?(delete this.config.cache.terrain[e],delete this.config.cache.structures[e]):(this.config.cache={terrain:{},structures:{}},this.config.lastCacheClear=Game.time),this.saveConfig()}getConfig(){return{...this.config}}getPerformanceMetrics(){const e=Game.cpu.limit;return{totalCost:this.config.totalCost,layerCosts:{...this.config.layerCosts},percentOfBudget:this.config.totalCost/e*100}}measureCost(e){const t=Game.cpu.getUsed();return{result:e(),cost:Game.cpu.getUsed()-t}}}Oi.VisualizationManager=r;let o=null;function n(){return null===o&&(o=new r),o}return Oi.visualizationManager=n(),Oi}var wi,ki,Ni,Pi,Ii,xi={},$i={},Gi={},Li={},Di=(Ii||(Ii=1,function(e){var t=Ci&&Ci.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),r=Ci&&Ci.__exportStar||function(e,r){for(var o in e)"default"===o||{}.hasOwnProperty.call(r,o)||t(r,e,o)};Object.defineProperty(e,"__esModule",{value:!0}),e.createLogger=e.initializeRoomVisualExtensions=e.renderCompactBudgetStatus=e.renderBudgetDashboard=e.MapVisualizer=e.RoomVisualizer=e.VisualizationManager=e.getVisualizationManager=e.visualizationManager=void 0,r(Si(),e);var o=Ai();Object.defineProperty(e,"visualizationManager",{enumerable:!0,get:function(){return o.visualizationManager}}),Object.defineProperty(e,"getVisualizationManager",{enumerable:!0,get:function(){return o.getVisualizationManager}}),Object.defineProperty(e,"VisualizationManager",{enumerable:!0,get:function(){return o.VisualizationManager}});var n=function(){if(wi)return xi;wi=1,Object.defineProperty(xi,"__esModule",{value:!0}),xi.roomVisualizer=xi.RoomVisualizer=void 0;const e=Si(),t=Mi(),r=Ai();(0,t.createLogger)("RoomVisualizer");const o={showPheromones:!0,showPaths:!1,showCombat:!0,showResourceFlow:!1,showSpawnQueue:!0,showRoomStats:!0,showStructures:!1,opacity:.5},n={expand:"#00ff00",harvest:"#ffff00",build:"#ff8800",upgrade:"#0088ff",defense:"#ff0000",war:"#ff00ff",siege:"#880000",logistics:"#00ffff",nukeTarget:"#ff0088"};class s{config;memoryManager;constructor(e={},t){this.config={...o,...e},this.memoryManager=t}setMemoryManager(e){this.memoryManager=e}draw(t){const o=new RoomVisual(t.name),n=this.memoryManager?.getOrInitSwarmState(t.name);if(r.visualizationManager.updateFromFlags(),this.config.showRoomStats&&this.drawRoomStats(o,t,n),this.config.showPheromones&&r.visualizationManager.isLayerEnabled(e.VisualizationLayer.Pheromones)&&n){const{cost:e}=r.visualizationManager.measureCost(()=>{this.drawPheromoneBars(o,n),this.drawPheromoneHeatmap(o,n)});r.visualizationManager.trackLayerCost("pheromones",e)}if(this.config.showCombat&&r.visualizationManager.isLayerEnabled(e.VisualizationLayer.Defense)){const{cost:e}=r.visualizationManager.measureCost(()=>{this.drawCombatInfo(o,t)});r.visualizationManager.trackLayerCost("defense",e)}if(this.config.showSpawnQueue&&this.drawSpawnQueue(o,t),this.config.showResourceFlow&&r.visualizationManager.isLayerEnabled(e.VisualizationLayer.Economy)){const{cost:e}=r.visualizationManager.measureCost(()=>{this.drawResourceFlow(o,t)});r.visualizationManager.trackLayerCost("economy",e)}if(this.config.showPaths&&r.visualizationManager.isLayerEnabled(e.VisualizationLayer.Paths)){const{cost:e}=r.visualizationManager.measureCost(()=>{this.drawTrafficPaths(o,t)});r.visualizationManager.trackLayerCost("paths",e)}if(this.config.showStructures&&r.visualizationManager.isLayerEnabled(e.VisualizationLayer.Construction)){const{cost:e}=r.visualizationManager.measureCost(()=>{this.drawEnhancedStructures(o,t)});r.visualizationManager.trackLayerCost("construction",e)}n?.collectionPoint&&this.drawCollectionPoint(o,n),r.visualizationManager.isLayerEnabled(e.VisualizationLayer.Performance)&&this.drawPerformanceMetrics(o)}drawRoomStats(e,t,r){const o=.5;let n=.5;const s=.6;e.rect(0,0,8,6.5,{fill:"#000000",opacity:.7,stroke:"#ffffff",strokeWidth:.05});const i=t.controller?.level??0,a=t.controller?Math.round(t.controller.progress/t.controller.progressTotal*100)+"%":"N/A";e.text(`${t.name} | RCL ${i} (${a})`,o,n,{align:"left",font:"0.5 monospace",color:"#ffffff"}),n+=s;const c=t.energyAvailable,l=t.energyCapacityAvailable,u=l>0?Math.round(c/l*100):0;if(e.text(`Energy: ${c}/${l} (${u}%)`,o,n,{align:"left",font:"0.4 monospace",color:"#ffff00"}),n+=s,t.storage){const r=t.storage.store.getUsedCapacity(RESOURCE_ENERGY);e.text(`Storage: ${Math.round(r/1e3)}k energy`,o,n,{align:"left",font:"0.4 monospace",color:"#00ff00"}),n+=s}if(r){e.text("Stage: "+r.colonyLevel,o,n,{align:"left",font:"0.4 monospace",color:"#00ffff"}),n+=s;const t=["#00ff00","#ffff00","#ff8800","#ff0000"];e.text(`Posture: ${r.posture??"eco"} | Danger: ${r.danger??0}`,o,n,{align:"left",font:"0.4 monospace",color:t[r.danger??0]??"#ffffff"}),n+=s}const m=t.find(FIND_MY_CREEPS).length,d=t.find(FIND_HOSTILE_CREEPS).length;e.text(`Creeps: ${m} | Hostiles: ${d}`,o,n,{align:"left",font:"0.4 monospace",color:d>0?"#ff0000":"#ffffff"}),n+=s;const p=Game.cpu.getUsed().toFixed(1),g=Game.cpu.bucket;e.text(`CPU: ${p} | Bucket: ${g}`,o,n,{align:"left",font:"0.4 monospace",color:3e3>g?"#ff8800":"#ffffff"})}drawPheromoneBars(e,t){let r=.5;if(e.rect(41.5,0,8,5.5,{fill:"#000000",opacity:.7,stroke:"#ffffff",strokeWidth:.05}),e.text("Pheromones",45,r,{align:"center",font:"0.5 monospace",color:"#ffffff"}),r+=.6,t.pheromones)for(const[o,s]of Object.entries(t.pheromones)){const t=n[o]??"#888888",i=6*Math.min(1,s/100);e.rect(42,r,6,.4,{fill:"#333333",opacity:.8}),i>0&&e.rect(42,r,i,.4,{fill:t,opacity:this.config.opacity}),e.text(`${o}: ${Math.round(s)}`,41.8,r+.35,{align:"right",font:"0.35 monospace",color:t}),r+=.5}}static HEATMAP_MIN_THRESHOLD=10;drawPheromoneHeatmap(e,t){if(!t.pheromones)return;let r=null,o=s.HEATMAP_MIN_THRESHOLD;for(const[e,n]of Object.entries(t.pheromones))n>o&&(o=n,r=e);if(!r||s.HEATMAP_MIN_THRESHOLD>o)return;const i=n[r]??"#888888",a=.15*Math.min(1,o/100);e.rect(40,10,8,5,{fill:i,opacity:a}),e.text("Dominant: "+r,44,12.5,{align:"center",font:"0.5 monospace",color:i}),e.text("Intensity: "+Math.round(o),44,13.5,{align:"center",font:"0.4 monospace",color:"#ffffff"})}drawCombatInfo(e,t){const r=t.find(FIND_HOSTILE_CREEPS);for(const t of r){const r=this.calculateCreepThreat(t),o=r>30?"#ff0000":r>10?"#ff8800":"#ffff00",n=.4+r/100,s=.2+r/100*.3;e.circle(t.pos,{radius:n,fill:o,opacity:s,stroke:o,strokeWidth:.1}),e.text("T:"+r,t.pos.x,t.pos.y-.8,{font:"0.4 monospace",color:o}),r>20&&e.animatedPosition(t.pos.x,t.pos.y,{color:o,opacity:.8,radius:1,frames:8})}if(r.length>0){const r=t.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_TOWER});for(const t of r)e.circle(t.pos,{radius:5,fill:"#00ff00",opacity:.15,stroke:"#00ff00",strokeWidth:.05}),e.circle(t.pos,{radius:10,fill:"#ffff00",opacity:.08,stroke:"#ffff00",strokeWidth:.05})}}calculateCreepThreat(e){let t=0;for(const r of e.body)if(r.hits)switch(r.type){case ATTACK:t+=5*(r.boost?4:1);break;case RANGED_ATTACK:t+=4*(r.boost?4:1);break;case HEAL:t+=6*(r.boost?4:1);break;case TOUGH:t+=1*(r.boost?4:1);break;case WORK:t+=2*(r.boost?4:1)}return t}drawSpawnQueue(e,t){const r=t.find(FIND_MY_SPAWNS);for(const t of r)if(t.spawning){const r=Game.creeps[t.spawning.name],o=1-t.spawning.remainingTime/t.spawning.needTime,n=2,s=.3,i=t.pos.x-1,a=t.pos.y-1.5;e.rect(i,a,n,s,{fill:"#333333",opacity:.8}),e.rect(i,a,n*o,s,{fill:"#00ff00",opacity:.8});const c=r?.memory,l=c?.role??t.spawning.name;e.speech(l,t.pos.x,t.pos.y,{background:"#2ccf3b",textcolor:"#000000",textsize:.4,opacity:.9}),t.spawning.remainingTime>t.spawning.needTime-5&&e.animatedPosition(t.pos.x,t.pos.y,{color:"#00ff00",opacity:.6,radius:1.2,frames:10})}}drawResourceFlow(e,t){const r=t.storage;if(!r)return;const o=t.find(FIND_SOURCES);for(const t of o){this.drawFlowingArrow(e,t.pos,r.pos,"#ffff00",.3);const o=(t.pos.x+r.pos.x)/2,n=(t.pos.y+r.pos.y)/2;e.resource(RESOURCE_ENERGY,o,n,.2)}const n=t.find(FIND_MY_SPAWNS);for(const t of n)t.store.getFreeCapacity(RESOURCE_ENERGY)>0&&this.drawFlowingArrow(e,r.pos,t.pos,"#00ff00",.3);const s=t.controller;if(s&&this.drawFlowingArrow(e,r.pos,s.pos,"#00ffff",.3),r.store.getUsedCapacity()>0){let t=.8;const o=-.8,n=Object.keys(r.store).filter(e=>r.store[e]>1e3).sort((e,t)=>r.store[t]-r.store[e]).slice(0,3);for(const s of n)e.resource(s,r.pos.x+t,r.pos.y+o,.3),t+=.6}const i=t.terminal;if(i&&i.store.getUsedCapacity()>0){let t=.8;const r=-.8,o=Object.keys(i.store).filter(e=>i.store[e]>1e3).sort((e,t)=>i.store[t]-i.store[e]).slice(0,3);for(const n of o)e.resource(n,i.pos.x+t,i.pos.y+r,.3),t+=.6}}drawFlowingArrow(e,t,r,o,n){e.line(t,r,{color:o,opacity:.5*n,width:.1,lineStyle:"dashed"});const s=Game.time%20/20,i=t.x+(r.x-t.x)*s,a=t.y+(r.y-t.y)*s;e.circle(i,a,{radius:.15,fill:o,opacity:n})}drawArrow(e,t,r,o,n){e.line(t,r,{color:o,opacity:n,width:.1,lineStyle:"dashed"})}drawEnhancedStructures(e,t){const o=r.visualizationManager.getCachedStructures(t.name);if(o)for(const t of o){const r=this.getStructureDepthOpacity(t.type);e.structure(t.x,t.y,t.type,{opacity:r})}else{const o=t.find(FIND_STRUCTURES),n=[];for(const t of o){const r=this.getStructureDepthOpacity(t.structureType);e.structure(t.pos.x,t.pos.y,t.structureType,{opacity:r}),n.push({x:t.pos.x,y:t.pos.y,type:t.structureType})}r.visualizationManager.cacheStructures(t.name,n)}const n=t.find(FIND_MY_CONSTRUCTION_SITES);for(const t of n)e.structure(t.pos.x,t.pos.y,t.structureType,{opacity:.3})}getStructureDepthOpacity(e){switch(e){case STRUCTURE_RAMPART:return.8;case STRUCTURE_TOWER:return.9;case STRUCTURE_SPAWN:case STRUCTURE_STORAGE:case STRUCTURE_TERMINAL:return.85;case STRUCTURE_ROAD:return.3;case STRUCTURE_WALL:return.9;default:return.7}}drawPerformanceMetrics(e){const t=r.visualizationManager.getPerformanceMetrics(),o=.5;let n=7.5;const s=.5;e.rect(0,7,10,5.5,{fill:"#000000",opacity:.8,stroke:"#ffff00",strokeWidth:.05}),e.text("Visualization Performance",o,n,{align:"left",font:"0.5 monospace",color:"#ffff00"}),n+=s;const i=t.percentOfBudget>10?"#ff0000":"#00ff00";e.text(`Total: ${t.totalCost.toFixed(3)} CPU`,o,n,{align:"left",font:"0.4 monospace",color:i}),n+=s,e.text(`(${t.percentOfBudget.toFixed(1)}% of budget)`,o,n,{align:"left",font:"0.35 monospace",color:i}),n+=s,e.text("Layer Costs:",o,n,{align:"left",font:"0.4 monospace",color:"#ffffff"}),n+=s;for(const[r,s]of Object.entries(t.layerCosts))s>0&&(e.text(`  ${r}: ${s.toFixed(3)}`,o,n,{align:"left",font:"0.35 monospace",color:"#aaaaaa"}),n+=.4)}drawTrafficPaths(e,t){const r=t.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_ROAD});for(const t of r){const r=`hsl(${120-120*(1-t.hits/t.hitsMax)}, 100%, 50%)`;e.circle(t.pos,{radius:.2,fill:r,opacity:.5})}}drawBlueprint(e,t){for(const r of t)e.structure(r.pos.x,r.pos.y,r.type,{opacity:.4})}setConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}drawCollectionPoint(e,t){if(!t.collectionPoint)return;const{x:r,y:o}=t.collectionPoint;e.circle(r,o,{radius:.5,fill:"#00ff00",opacity:.3,stroke:"#00ff00",strokeWidth:.1}),e.text("",r,o+.25,{font:"0.6 monospace",color:"#00ff00",opacity:.8})}toggle(e){"boolean"==typeof this.config[e]&&(this.config[e]=!this.config[e])}}return xi.RoomVisualizer=s,xi.roomVisualizer=new s,xi}();Object.defineProperty(e,"RoomVisualizer",{enumerable:!0,get:function(){return n.RoomVisualizer}});var s=function(){if(ki)return $i;ki=1,Object.defineProperty($i,"__esModule",{value:!0}),$i.mapVisualizer=$i.MapVisualizer=void 0,(0,Mi().createLogger)("MapVisualizer");const e={showRoomStatus:!0,showConnections:!0,showThreats:!0,showExpansion:!1,showResourceFlow:!1,showHighways:!1,opacity:.6},t=["#00ff00","#ffff00","#ff8800","#ff0000"],r={eco:"#00ff00",expand:"#00ffff",defense:"#ffff00",war:"#ff8800",siege:"#ff0000",evacuate:"#ff00ff"};class o{config;memoryManager;constructor(t={},r){this.config={...e,...t},this.memoryManager=r}setMemoryManager(e){this.memoryManager=e}draw(){const e=Game.map.visual;this.config.showRoomStatus&&this.drawRoomStatus(e),this.config.showConnections&&this.drawConnections(e),this.config.showThreats&&this.drawThreats(e),this.config.showExpansion&&this.drawExpansionCandidates(e),this.config.showResourceFlow&&this.drawResourceFlow(e),this.config.showHighways&&this.drawHighways(e)}drawRoomStatus(e){for(const o of Object.values(Game.rooms)){if(!o.controller?.my)continue;const n=this.memoryManager?.getOrInitSwarmState(o.name),s=o.controller.level,i=n?.danger?Math.min(Math.max(n.danger,0),3):0,a=t[i]??"#ffffff",c={radius:10,fill:a,opacity:.5*this.config.opacity,stroke:a,strokeWidth:1};if(e.circle(new RoomPosition(25,25,o.name),c),e.text("RCL"+s,new RoomPosition(25,25,o.name),{color:"#ffffff",fontSize:8,align:"center"}),n&&n.posture&&"eco"!==n.posture){const t=r[n.posture]??"#ffffff";e.text(n.posture.toUpperCase(),new RoomPosition(25,30,o.name),{color:t,fontSize:6,align:"center"})}}}drawConnections(e){for(const t of Object.values(Game.rooms)){if(!t.controller?.my)continue;const r=this.memoryManager?.getOrInitSwarmState(t.name);if(r){if(r.remoteAssignments&&r.remoteAssignments.length>0)for(const o of r.remoteAssignments){const r={color:"#00ffff",opacity:.8*this.config.opacity,width:.5};e.line(new RoomPosition(25,25,t.name),new RoomPosition(25,25,o),r);const n={radius:5,fill:"#00ffff",opacity:.3*this.config.opacity};e.circle(new RoomPosition(25,25,o),n)}if(r&&("war"===r.posture||"siege"===r.posture)){const r=Object.values(Game.rooms).filter(e=>e.find(FIND_HOSTILE_CREEPS).length>0&&5>=Game.map.getRoomLinearDistance(t.name,e.name));for(const o of r){const r={color:"#ff0000",opacity:this.config.opacity,width:1};e.line(new RoomPosition(25,25,t.name),new RoomPosition(25,25,o.name),r)}}}}}drawThreats(e){for(const t of Object.values(Game.rooms)){const r=t.find(FIND_HOSTILE_CREEPS),o=t.find(FIND_HOSTILE_STRUCTURES);if(r.length>0||o.length>0){const n=r.length+2*o.length,s=n>10?"#ff0000":"#ff8800";e.rect(new RoomPosition(20,20,t.name),10,10,{fill:s,opacity:.5*this.config.opacity,stroke:s,strokeWidth:1}),e.text(""+n,new RoomPosition(25,25,t.name),{color:"#ffffff",fontSize:8,align:"center"})}if(t.find(FIND_NUKES).length>0){const r=t.find(FIND_NUKES);e.circle(new RoomPosition(25,25,t.name),{radius:15,fill:"#ff00ff",opacity:.7*this.config.opacity,stroke:"#ff00ff",strokeWidth:2}),e.text(""+r.length,new RoomPosition(25,25,t.name),{color:"#ffffff",fontSize:10,align:"center",backgroundColor:"#ff00ff",backgroundPadding:2})}}}drawExpansionCandidates(e){const t=Object.values(Game.rooms).filter(e=>e.controller?.my);for(const r of Object.values(Game.rooms))!r.controller||r.controller.my||r.controller.owner||t.some(e=>3>=Game.map.getRoomLinearDistance(e.name,r.name))&&(e.circle(new RoomPosition(25,25,r.name),{radius:8,fill:"#00ff00",opacity:.3*this.config.opacity,stroke:"#00ff00",strokeWidth:.5,lineStyle:"dashed"}),e.text("EXP",new RoomPosition(25,25,r.name),{color:"#00ff00",fontSize:6,align:"center"}))}drawResourceFlow(e){const t=Object.values(Game.rooms).filter(e=>e.controller?.my);for(const r of t){if(!r.terminal)continue;const t=Game.market.orders;for(const o in t){const n=t[o];n.roomName===r.name&&n.remainingAmount<n.amount&&e.circle(new RoomPosition(25,25,r.name),{radius:12,fill:"#ffff00",opacity:.2*this.config.opacity,stroke:"#ffff00",strokeWidth:.5})}}}drawHighways(e){for(const t of Object.values(Game.rooms)){const r=t.name.match(/[WE](\d+)[NS](\d+)/);if(!r)continue;const o=parseInt(r[1],10),n=parseInt(r[2],10);o%10!=0&&n%10!=0||(e.rect(new RoomPosition(0,0,t.name),50,50,{fill:"#444444",opacity:.2*this.config.opacity}),o%10==0&&n%10==0&&e.text("SK",new RoomPosition(25,25,t.name),{color:"#ff8800",fontSize:12,align:"center"}))}}drawRoomOverlay(e){const t=Game.map.visual;Game.rooms[e]&&(t.rect(new RoomPosition(0,0,e),50,50,{fill:"transparent",opacity:1,stroke:"#00ffff",strokeWidth:2}),t.text(e,new RoomPosition(25,5,e),{color:"#00ffff",fontSize:10,align:"center",backgroundColor:"#000000",backgroundPadding:2}))}setConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}toggle(e){const t=this.config[e];"boolean"==typeof t&&(this.config[e]=!t)}}return $i.MapVisualizer=o,$i.mapVisualizer=new o,$i}();Object.defineProperty(e,"MapVisualizer",{enumerable:!0,get:function(){return s.MapVisualizer}});var i=(Ni||(Ni=1,Object.defineProperty(Gi,"__esModule",{value:!0}),Gi.renderBudgetDashboard=function(e={}){const t=Game.cpu.getUsed();if(!e.kernel||!e.stats?.getAdaptiveBudgetInfo)return Game.cpu.getUsed()-t;const r=e.room||Object.keys(Game.rooms)[0];if(!r||!Game.rooms[r])return Game.cpu.getUsed()-t;const o=Game.rooms[r].visual,n=e.x??1,s=e.y??1,i=e.kernel.getConfig(),a=e.stats.getAdaptiveBudgetInfo(i.adaptiveBudgetConfig||{}),c=e.kernel.getProcesses().reduce((e,t)=>e+t.cpuBudget,0),l=e.kernel.getTickCpuUsed(),u=c>0?l/c:0;o.text(" CPU Budget Dashboard",n,s,{color:"#FFFFFF",font:.7,align:"left"});let m=s+1;const d=i.enableAdaptiveBudgets?"#00FF00":"#888888",p=i.enableAdaptiveBudgets?"ENABLED":"DISABLED";o.text("Adaptive Budgets: "+p,n,m,{color:d,font:.5,align:"left"}),m+=.7,o.text(`Rooms: ${a.roomCount} | Bucket: ${a.bucket}`,n,m,{color:"#CCCCCC",font:.5,align:"left"}),m+=.7,o.text(`Room Multiplier: ${a.roomMultiplier.toFixed(2)}x | Bucket Multiplier: ${a.bucketMultiplier.toFixed(2)}x`,n,m,{color:"#AAAAAA",font:.5,align:"left"}),m+=1;const g=.4,f=(e,t,r,s)=>{o.text(e,n,r,{color:"#FFFFFF",font:.5,align:"left"}),o.rect(n+3,r-.2,8,g,{fill:"#222222",opacity:.5});const i=8*Math.min(t,1);o.rect(n+3,r-.2,i,g,{fill:s,opacity:.8}),o.text((100*t).toFixed(1)+"%",n+3+8+.3,r,{color:"#FFFFFF",font:.4,align:"left"})};f("High Freq:",a.budgets.high,m,"#FF6B6B"),m+=.8,f("Medium Freq:",a.budgets.medium,m,"#FFD93D"),m+=.8,f("Low Freq:",a.budgets.low,m,"#6BCF7F"),m+=.8,m+=.3,o.text("Overall Utilization:",n,m,{color:"#FFFFFF",font:.5,align:"left"}),m+=.6,o.rect(n,m-.2,14,g,{fill:"#222222",opacity:.5});const h=u>.9?"#FF0000":u>.7?"#FFD93D":"#00FF00",y=14*Math.min(u,1);if(o.rect(n,m-.2,y,g,{fill:h,opacity:.8}),o.text((100*u).toFixed(1)+"%",n+8+6.5,m,{color:"#FFFFFF",font:.5,align:"left"}),m+=.7,o.text(`Allocated: ${c.toFixed(2)} | Used: ${l.toFixed(2)} | Available: ${e.kernel.getRemainingCpu().toFixed(2)}`,n,m,{color:"#AAAAAA",font:.4,align:"left"}),m+=1,!1!==e.showProcesses){o.text("Process Health:",n,m,{color:"#FFFFFF",font:.6,align:"left"}),m+=.7;const t=e.kernel.getProcesses(),r=t.filter(e=>80>e.stats.healthScore).sort((e,t)=>e.stats.healthScore-t.stats.healthScore).slice(0,e.maxProcesses??5);if(0===r.length)o.text(" All processes healthy",n,m,{color:"#00FF00",font:.4,align:"left"}),m+=.6;else for(const t of r){const r=30>t.stats.healthScore?"#FF0000":60>t.stats.healthScore?"#FFA500":"#FFD93D",s="suspended"===t.state?"":"",i=e.maxProcessNameLength??15,a=t.name.length>i?t.name.substring(0,i-1)+"":t.name;o.text(`${s} ${a}: ${t.stats.healthScore.toFixed(0)}%`,n,m,{color:r,font:.4,align:"left"}),m+=.6}const s=t.filter(e=>"suspended"===e.state).length;s>0&&(m+=.3,o.text(` ${s} process(es) suspended`,n,m,{color:"#FF6B6B",font:.4,align:"left"}))}return Game.cpu.getUsed()-t},Gi.renderCompactBudgetStatus=function(e,t,r){const o=Game.cpu.getUsed();if(!t||!r?.getAdaptiveBudgetInfo)return 0;const n=e||Object.keys(Game.rooms)[0];if(!n||!Game.rooms[n])return 0;const s=Game.rooms[n].visual,i=t.getConfig(),a=r.getAdaptiveBudgetInfo(i.adaptiveBudgetConfig||{}),c=t.getProcesses().reduce((e,t)=>e+t.cpuBudget,0),l=t.getTickCpuUsed(),u=c>0?l/c:0,m=u>.9?"#FF0000":u>.7?"#FFD93D":"#00FF00";return s.text(`CPU: ${(100*u).toFixed(0)}% | ${a.roomCount}R | ${a.bucket}B`,49,1,{color:m,font:.4,align:"right"}),Game.cpu.getUsed()-o}),Gi);Object.defineProperty(e,"renderBudgetDashboard",{enumerable:!0,get:function(){return i.renderBudgetDashboard}}),Object.defineProperty(e,"renderCompactBudgetStatus",{enumerable:!0,get:function(){return i.renderCompactBudgetStatus}});var a=function(){if(Pi)return Li;Pi=1,Object.defineProperty(Li,"__esModule",{value:!0}),Li.initializeRoomVisualExtensions=function(){};const e="#555555",t="#AAAAAA",r="#FFE87B",o="#F53547",n="#181818",s="#8FBB93";let i=!1;return"undefined"==typeof RoomVisual||i||(i=!0,RoomVisual.prototype.structure=function(i,a,c,l={}){const u={opacity:1,...l};switch(c){case STRUCTURE_EXTENSION:this.circle(i,a,{radius:.5,fill:n,stroke:s,strokeWidth:.05,opacity:u.opacity}),this.circle(i,a,{radius:.35,fill:e,opacity:u.opacity});break;case STRUCTURE_SPAWN:this.circle(i,a,{radius:.65,fill:n,stroke:"#CCCCCC",strokeWidth:.1,opacity:u.opacity}),this.circle(i,a,{radius:.4,fill:r,opacity:u.opacity});break;case STRUCTURE_POWER_SPAWN:this.circle(i,a,{radius:.65,fill:n,stroke:o,strokeWidth:.1,opacity:u.opacity}),this.circle(i,a,{radius:.4,fill:r,opacity:u.opacity});break;case STRUCTURE_TOWER:this.circle(i,a,{radius:.6,fill:n,stroke:s,strokeWidth:.05,opacity:u.opacity}),this.circle(i,a,{radius:.45,fill:e,opacity:u.opacity}),this.rect(i-.2,a-.3,.4,.6,{fill:t,opacity:u.opacity});break;case STRUCTURE_STORAGE:{const e=[[-.45,-.55],[0,-.65],[.45,-.55],[.55,0],[.45,.55],[0,.65],[-.45,.55],[-.55,0]];this.poly(e.map(e=>[e[0]+i,e[1]+a]),{stroke:s,strokeWidth:.05,fill:n,opacity:u.opacity}),this.rect(i-.35,a-.45,.7,.9,{fill:r,opacity:.6*u.opacity});break}case STRUCTURE_TERMINAL:{const r=[[-.45,-.55],[0,-.65],[.45,-.55],[.55,0],[.45,.55],[0,.65],[-.45,.55],[-.55,0]];this.poly(r.map(e=>[e[0]+i,e[1]+a]),{stroke:s,strokeWidth:.05,fill:n,opacity:u.opacity}),this.circle(i,a,{radius:.3,fill:t,opacity:u.opacity}),this.rect(i-.15,a-.15,.3,.3,{fill:e,opacity:u.opacity});break}case STRUCTURE_LAB:this.circle(i,a,{radius:.55,fill:n,stroke:s,strokeWidth:.05,opacity:u.opacity}),this.circle(i,a,{radius:.4,fill:e,opacity:u.opacity}),this.rect(i-.15,a+.1,.3,.25,{fill:t,opacity:u.opacity});break;case STRUCTURE_LINK:this.circle(i,a,{radius:.5,fill:n,stroke:s,strokeWidth:.05,opacity:u.opacity}),this.circle(i,a,{radius:.35,fill:t,opacity:u.opacity});break;case STRUCTURE_NUKER:this.circle(i,a,{radius:.65,fill:n,stroke:"#ff0000",strokeWidth:.1,opacity:u.opacity}),this.circle(i,a,{radius:.4,fill:"#ff0000",opacity:.6*u.opacity});break;case STRUCTURE_OBSERVER:this.circle(i,a,{radius:.6,fill:n,stroke:s,strokeWidth:.05,opacity:u.opacity}),this.circle(i,a,{radius:.4,fill:"#00ffff",opacity:.6*u.opacity});break;case STRUCTURE_CONTAINER:this.rect(i-.45,a-.45,.9,.9,{fill:n,stroke:s,strokeWidth:.05,opacity:u.opacity}),this.rect(i-.35,a-.35,.7,.7,{fill:"transparent",stroke:e,strokeWidth:.05,opacity:u.opacity});break;case STRUCTURE_ROAD:this.circle(i,a,{radius:.175,fill:"#666",opacity:u.opacity});break;case STRUCTURE_RAMPART:this.rect(i-.45,a-.45,.9,.9,{fill:"transparent",stroke:"#00ff00",strokeWidth:.1,opacity:u.opacity});break;case STRUCTURE_WALL:this.rect(i-.45,a-.45,.9,.9,{fill:n,stroke:t,strokeWidth:.05,opacity:u.opacity});break;case STRUCTURE_EXTRACTOR:this.circle(i,a,{radius:.6,fill:n,stroke:s,strokeWidth:.05,opacity:u.opacity}),this.circle(i,a,{radius:.45,fill:e,opacity:u.opacity});break;default:this.circle(i,a,{radius:.5,fill:e,stroke:s,strokeWidth:.05,opacity:u.opacity})}},RoomVisual.prototype.speech=function(e,t,r,o={}){const n=o.background??"#2ccf3b",s=o.textcolor??"#000000",i=o.textsize??.5,a=o.textfont??"Times New Roman",c=o.opacity??1,l=i,u=e.length*l*.4+.4,m=l+.4;this.rect(t-u/2,r-1-m,u,m,{fill:n,opacity:.9*c});const d=[[t-.1,r-1],[t+.1,r-1],[t,r-.6]];this.poly(d,{fill:n,opacity:.9*c,stroke:"transparent"}),this.text(e,t,r-1-m/2+.1,{color:s,font:`${l} ${a}`,opacity:c})},RoomVisual.prototype.animatedPosition=function(e,t,r={}){const o=r.color??"#ff0000",n=r.opacity??1,s=r.radius??.75,i=r.frames??6,a=Game.time%i,c=s*(1-a/i),l=n*(a/i);this.circle(e,t,{radius:c,fill:"transparent",stroke:o,strokeWidth:.1,opacity:l})},RoomVisual.prototype.resource=function(e,t,s,i=.25){const a={[RESOURCE_ENERGY]:r,[RESOURCE_POWER]:o,[RESOURCE_HYDROGEN]:"#FFFFFF",[RESOURCE_OXYGEN]:"#DDDDDD",[RESOURCE_UTRIUM]:"#48C5E5",[RESOURCE_LEMERGIUM]:"#24D490",[RESOURCE_KEANIUM]:"#9269EC",[RESOURCE_ZYNTHIUM]:"#D9B478",[RESOURCE_CATALYST]:"#F26D6F",[RESOURCE_GHODIUM]:"#FFFFFF"}[e]??"#CCCCCC";this.circle(t,s,{radius:i,fill:n,opacity:.9}),this.circle(t,s,{radius:.8*i,fill:a,opacity:.8});const c=e.length>2?e.substring(0,2).toUpperCase():e;this.text(c,t,s+.03,{color:n,font:1.2*i+" monospace",align:"center",opacity:.9})}),Li}();Object.defineProperty(e,"initializeRoomVisualExtensions",{enumerable:!0,get:function(){return a.initializeRoomVisualExtensions}});var c=Mi();Object.defineProperty(e,"createLogger",{enumerable:!0,get:function(){return c.createLogger}})}(Ci)),Ci);const Fi=me("NativeCallsTracker");function Bi(e,t,r){const o=e[t];if(!o)return;if(o.__nativeCallsTrackerWrapped)return;const n=Object.getOwnPropertyDescriptor(e,t);if(n&&!1===n.configurable)Fi.warn("Cannot wrap method - property is not configurable",{meta:{methodName:t}});else try{const n=function(...e){return Ye.unifiedStats.recordNativeCall(r),o.apply(this,e)};n.__nativeCallsTrackerWrapped=!0,Object.defineProperty(e,t,{value:n,writable:!0,enumerable:!0,configurable:!0})}catch(e){Fi.warn("Failed to wrap method",{meta:{methodName:t,error:e+""}})}}function Hi(e){e._metrics||(e._metrics={tasksCompleted:0,energyTransferred:0,energyHarvested:0,buildProgress:0,repairProgress:0,upgradeProgress:0,damageDealt:0,healingDone:0})}function Wi(e){return Hi(e),e._metrics}function Yi(e,t){Wi(e).damageDealt+=t}const Ki=me("OpportunisticActions");function ji(){return Game.cpu.bucket>=2e3}const Vi=me("ActionExecutor"),qi="#ffaa00",zi="#ffffff",Xi="#ff0000",Qi="#00ff00",Zi="#0000ff";function Ji(e,t,r){var o,n;if(!t||!t.type)return Vi.warn(e.name+" received invalid action, clearing state"),void delete r.memory.state;const s=function(e,t){if("idle"===t.type)return t;let r=function(e,t){if(!ji())return t;if(50>e.store.getFreeCapacity())return t;if("pickup"===t.type||"withdraw"===t.type)return t;const r=e.pos.findInRange(FIND_DROPPED_RESOURCES,3,{filter:e=>e.resourceType===RESOURCE_ENERGY&&e.amount>=50});if(r.length>0){const t=r.reduce((t,r)=>e.pos.getRangeTo(r)<e.pos.getRangeTo(t)?r:t);if(e.pos.isNearTo(t))return Ki.debug(`${e.name} opportunistically picking up ${t.amount} energy at ${t.pos}`),{type:"pickup",target:t}}return t}(e,t);return r.type!==t.type||(r=function(e,t){if(!ji())return t;if(0===e.store.getUsedCapacity(RESOURCE_ENERGY))return t;if("transfer"===t.type)return t;const r=e.pos.findInRange(FIND_MY_STRUCTURES,1,{filter:e=>e.structureType===STRUCTURE_SPAWN||e.structureType===STRUCTURE_EXTENSION?e.store.getFreeCapacity(RESOURCE_ENERGY)>0:e.structureType===STRUCTURE_TOWER&&e.store.getFreeCapacity(RESOURCE_ENERGY)>=100});if(r.length>0){const t=r.sort((e,t)=>{const r=e.structureType===STRUCTURE_SPAWN?3:e.structureType===STRUCTURE_EXTENSION?2:1;return(t.structureType===STRUCTURE_SPAWN?3:t.structureType===STRUCTURE_EXTENSION?2:1)-r})[0];return Ki.debug(`${e.name} opportunistically transferring to ${t.structureType} at ${t.pos}`),{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}return t}(e,r),r.type!==t.type||(r=function(e,t){if(!ji())return t;if(0===e.getActiveBodyparts(WORK))return t;if(0===e.store.getUsedCapacity(RESOURCE_ENERGY))return t;if("repair"===t.type)return t;const r=e.pos.findInRange(FIND_STRUCTURES,3,{filter:e=>e.hits<.5*e.hitsMax&&e.structureType!==STRUCTURE_WALL&&e.structureType!==STRUCTURE_RAMPART});if(r.length>0){const t=r.reduce((t,r)=>e.pos.getRangeTo(r)<e.pos.getRangeTo(t)?r:t);if(e.pos.isNearTo(t)&&t.hits<.3*t.hitsMax)return Ki.debug(`${e.name} opportunistically repairing ${t.structureType} at ${t.pos} (${t.hits}/${t.hitsMax})`),{type:"repair",target:t}}return t}(e,r))),r}(e,t);t.type!==s.type&&Vi.debug(`${e.name} opportunistic action: ${t.type}  ${s.type}`),"idle"===s.type?Vi.warn(`${e.name} (${r.memory.role}) executing IDLE action`):Vi.debug(`${e.name} (${r.memory.role}) executing ${s.type}`);let i=!1;switch(s.type){case"harvest":i=ea(e,()=>e.harvest(s.target),s.target,qi,s.type);break;case"harvestMineral":i=ea(e,()=>e.harvest(s.target),s.target,"#00ff00",s.type);break;case"harvestDeposit":i=ea(e,()=>e.harvest(s.target),s.target,"#00ffff",s.type);break;case"pickup":i=ea(e,()=>e.pickup(s.target),s.target,qi,s.type);break;case"withdraw":i=ea(e,()=>e.withdraw(s.target,s.resourceType),s.target,qi,s.type);break;case"transfer":i=ea(e,()=>e.transfer(s.target,s.resourceType),s.target,zi,s.type,{resourceType:s.resourceType});break;case"drop":e.drop(s.resourceType);break;case"build":i=ea(e,()=>e.build(s.target),s.target,"#ffffff",s.type);break;case"repair":i=ea(e,()=>e.repair(s.target),s.target,"#ffff00",s.type);break;case"upgrade":i=ea(e,()=>e.upgradeController(s.target),s.target,zi,s.type);break;case"dismantle":i=ea(e,()=>e.dismantle(s.target),s.target,Xi,s.type);break;case"attack":ea(e,()=>e.attack(s.target),s.target,Xi,s.type);break;case"rangedAttack":ea(e,()=>e.rangedAttack(s.target),s.target,Xi,s.type);break;case"heal":ea(e,()=>e.heal(s.target),s.target,Qi,s.type);break;case"rangedHeal":e.rangedHeal(s.target),uo.moveTo(e,s.target,{visualizePathStyle:{stroke:Qi}})===ERR_NO_PATH&&(i=!0);break;case"claim":ea(e,()=>e.claimController(s.target),s.target,Qi,s.type);break;case"reserve":ea(e,()=>e.reserveController(s.target),s.target,Qi,s.type);break;case"attackController":ea(e,()=>e.attackController(s.target),s.target,Xi,s.type);break;case"moveTo":uo.moveTo(e,s.target,{visualizePathStyle:{stroke:Zi}})===ERR_NO_PATH&&(i=!0);break;case"moveToRoom":{const t=new RoomPosition(25,25,s.roomName);uo.moveTo(e,{pos:t,range:20},{visualizePathStyle:{stroke:Zi},maxRooms:16})===ERR_NO_PATH&&(i=!0);break}case"flee":{const t=s.from.map(e=>({pos:e,range:10}));uo.moveTo(e,t,{flee:!0})===ERR_NO_PATH&&(i=!0);break}case"wait":if(uo.isExit(e.pos)){const t=new RoomPosition(25,25,e.pos.roomName);uo.moveTo(e,t,{priority:2});break}e.pos.isEqualTo(s.position)||uo.moveTo(e,s.position)===ERR_NO_PATH&&(i=!0);break;case"requestMove":uo.moveTo(e,s.target,{visualizePathStyle:{stroke:Zi},priority:5})===ERR_NO_PATH&&(i=!0);break;case"idle":{if(uo.isExit(e.pos)){const t=new RoomPosition(25,25,e.pos.roomName);uo.moveTo(e,t,{priority:2});break}const t=Game.rooms[e.pos.roomName];if(t&&(null===(o=t.controller)||void 0===o?void 0:o.my)){const r=Lr(t,Wt.getOrInitSwarmState(t.name));if(r&&!e.pos.isEqualTo(r)){uo.moveTo(e,r,{visualizePathStyle:{stroke:"#888888"},priority:2})===ERR_NO_PATH&&(i=!0);break}}const r=((null===(n=Game.rooms[e.pos.roomName])||void 0===n?void 0:n.find(FIND_MY_SPAWNS))||[]).find(t=>e.pos.inRangeTo(t.pos,1));r&&uo.moveTo(e,{pos:r.pos,range:3},{flee:!0,priority:2});break}}i&&(delete r.memory.state,uo.clearCachedPath(e),pt(e)),function(e){const t=0===e.creep.store.getUsedCapacity(),r=0===e.creep.store.getFreeCapacity();void 0===e.memory.working&&(e.memory.working=!t),t&&(e.memory.working=!1),r&&(e.memory.working=!0)}(r)}function ea(e,t,r,o,n,s){const i=t();if(i===ERR_NOT_IN_RANGE){const t=uo.moveTo(e,r,{visualizePathStyle:{stroke:o}});return t!==OK&&Vi.info("Movement attempt returned non-OK result",{room:e.pos.roomName,creep:e.name,meta:{action:null!=n?n:"rangeAction",moveResult:t,target:r.pos.toString()}}),t===ERR_NO_PATH}return i===OK&&n&&function(e,t,r,o){var n,s,i,a,c,l;switch(Hi(e.memory),t){case"harvest":case"harvestMineral":case"harvestDeposit":a=2*e.body.filter(e=>e.type===WORK&&e.hits>0).length,Wi(e.memory).energyHarvested+=a;break;case"transfer":{const t=null!==(n=null==o?void 0:o.resourceType)&&void 0!==n?n:RESOURCE_ENERGY,a=Math.min(e.store.getUsedCapacity(t),null!==(i=null===(s=r.store)||void 0===s?void 0:s.getFreeCapacity(t))&&void 0!==i?i:0);a>0&&function(e,t){Wi(e).energyTransferred+=t}(e.memory,a);break}case"build":{const t=5*e.body.filter(e=>e.type===WORK&&e.hits>0).length;c=e.memory,l=t,Wi(c).buildProgress+=l;break}case"repair":{const t=100*e.body.filter(e=>e.type===WORK&&e.hits>0).length;!function(e,t){Wi(e).repairProgress+=t}(e.memory,t);break}case"attack":{const t=30*e.body.filter(e=>e.type===ATTACK&&e.hits>0).length;Yi(e.memory,t);break}case"rangedAttack":{const t=e.body.filter(e=>e.type===RANGED_ATTACK&&e.hits>0).length,o=e.pos.getRangeTo(r);let n=0;o>1?o>2?o>3||(n=1*t):n=4*t:n=10*t,Yi(e.memory,n);break}case"heal":case"rangedHeal":{const r=e.body.filter(e=>e.type===HEAL&&e.hits>0).length,o="heal"===t?12*r:4*r;!function(e,t){Wi(e).healingDone+=t}(e.memory,o);break}case"upgrade":{const t=e.body.filter(e=>e.type===WORK&&e.hits>0).length;!function(e,t){Wi(e).upgradeProgress+=t}(e.memory,t);break}}}(e,n,r,s),(i===ERR_FULL||i===ERR_NOT_ENOUGH_RESOURCES||i===ERR_INVALID_TARGET)&&(Vi.info("Clearing state after action error",{room:e.pos.roomName,creep:e.name,meta:{action:null!=n?n:"rangeAction",result:i,target:r.pos.toString()}}),!0)}function ta(e){const t=0===e.creep.store.getUsedCapacity(),r=0===e.creep.store.getFreeCapacity();void 0===e.memory.working&&(e.memory.working=!t);const o=e.memory.working;t?e.memory.working=!1:r&&(e.memory.working=!0);const n=e.memory.working;return o!==n&&gt(e.creep),n}function ra(e){e.memory.working=!1,gt(e.creep)}const oa=me("EnergyCollection");function na(e){if(e.droppedResources.length>0){const t=dt(e.creep,e.droppedResources,"energy_drop",5);if(t)return oa.debug(`${e.creep.name} (${e.memory.role}) selecting dropped resource at ${t.pos}`),{type:"pickup",target:t}}const t=e.containers.filter(e=>e.store.getUsedCapacity(RESOURCE_ENERGY)>100);if(t.length>0){const r=Yr(e.creep,t,"energy_container");if(r)return oa.debug(`${e.creep.name} (${e.memory.role}) selecting container ${r.id} at ${r.pos} with ${r.store.getUsedCapacity(RESOURCE_ENERGY)} energy`),{type:"withdraw",target:r,resourceType:RESOURCE_ENERGY};{oa.warn(`${e.creep.name} (${e.memory.role}) found ${t.length} containers but distribution returned null, falling back to closest`);const r=e.creep.pos.findClosestByRange(t);if(r)return oa.debug(`${e.creep.name} (${e.memory.role}) using fallback container ${r.id} at ${r.pos}`),{type:"withdraw",target:r,resourceType:RESOURCE_ENERGY}}}if(e.storage&&e.storage.store.getUsedCapacity(RESOURCE_ENERGY)>0)return oa.debug(`${e.creep.name} (${e.memory.role}) selecting storage at ${e.storage.pos}`),{type:"withdraw",target:e.storage,resourceType:RESOURCE_ENERGY};const r=it(e.room).filter(e=>e.energy>0);if(r.length>0){const t=Yr(e.creep,r,"energy_source");if(t)return oa.debug(`${e.creep.name} (${e.memory.role}) selecting source ${t.id} at ${t.pos}`),{type:"harvest",target:t};{oa.warn(`${e.creep.name} (${e.memory.role}) found ${r.length} sources but distribution returned null, falling back to closest`);const t=e.creep.pos.findClosestByRange(r);if(t)return oa.debug(`${e.creep.name} (${e.memory.role}) using fallback source ${t.id} at ${t.pos}`),{type:"harvest",target:t}}}return oa.warn(`${e.creep.name} (${e.memory.role}) findEnergy returning idle - no energy sources available`),{type:"idle"}}function sa(e){const t=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_SPAWN&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0);if(t.length>0){const r=dt(e.creep,t,"deliver_spawn",5);if(r)return{type:"transfer",target:r,resourceType:RESOURCE_ENERGY}}const r=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_EXTENSION&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0);if(r.length>0){const t=dt(e.creep,r,"deliver_ext",5);if(t)return{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}const o=e.towers.filter(e=>e.store.getFreeCapacity(RESOURCE_ENERGY)>=100);if(o.length>0){const t=dt(e.creep,o,"deliver_tower",10);if(t)return{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}if(e.storage&&e.storage.store.getFreeCapacity(RESOURCE_ENERGY)>0)return{type:"transfer",target:e.storage,resourceType:RESOURCE_ENERGY};const n=e.depositContainers.filter(e=>e.store.getFreeCapacity(RESOURCE_ENERGY)>0);if(n.length>0){const t=dt(e.creep,n,"deliver_cont",10);if(t)return{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}return null}const ia=me("LarvaWorkerBehavior");function aa(e){if(ta(e)){ia.debug(`${e.creep.name} larvaWorker working with ${e.creep.store.getUsedCapacity(RESOURCE_ENERGY)} energy`);const t=sa(e);if(t)return ia.debug(`${e.creep.name} larvaWorker delivering via ${t.type}`),t;const r=function(e){var t;const r=Wt.getSwarmState(e.room.name);return null!==(t=null==r?void 0:r.pheromones)&&void 0!==t?t:null}(e.creep);if(r){if(function(e){return e.build>15}(r)&&e.prioritizedSites.length>0)return{type:"build",target:e.prioritizedSites[0]};if(function(e){return e.upgrade>15}(r)&&e.room.controller)return{type:"upgrade",target:e.room.controller}}if(e.prioritizedSites.length>0)return ia.debug(e.creep.name+" larvaWorker building site"),{type:"build",target:e.prioritizedSites[0]};if(e.room.controller)return{type:"upgrade",target:e.room.controller};if(e.isEmpty)return ia.warn(e.creep.name+" larvaWorker idle (empty, working=true, no targets) - this indicates a bug"),{type:"idle"};ia.debug(e.creep.name+" larvaWorker has energy but no targets, switching to collection mode"),ra(e)}return na(e)}const ca=me("HarvesterBehavior"),la=me("HaulerBehavior"),ua=new class{getLabResourceNeeds(e){var t,r,o;if(!Game.rooms[e])return[];const n=yi.getConfig(e);if(!n||!n.isValid)return[];const s=[],{input1:i,input2:a}=yi.getInputLabs(e);if(i&&n.activeReaction){const e=null!==(t=i.store[n.activeReaction.input1])&&void 0!==t?t:0;1e3>e&&s.push({labId:i.id,resourceType:n.activeReaction.input1,amount:2e3-e,priority:10})}if(a&&n.activeReaction){const e=null!==(r=a.store[n.activeReaction.input2])&&void 0!==r?r:0;1e3>e&&s.push({labId:a.id,resourceType:n.activeReaction.input2,amount:2e3-e,priority:10})}const c=yi.getBoostLabs(e);for(const e of c){const t=n.labs.find(t=>t.labId===e.id);if(null==t?void 0:t.resourceType){const r=null!==(o=e.store[t.resourceType])&&void 0!==o?o:0;1e3>r&&s.push({labId:e.id,resourceType:t.resourceType,amount:1500-r,priority:8})}}return s}getLabOverflow(e){var t,r;if(!Game.rooms[e])return[];const o=yi.getConfig(e);if(!o)return[];const n=[],s=yi.getOutputLabs(e);for(const e of s){const r=e.mineralType;if(!r)continue;const s=null!==(t=e.store[r])&&void 0!==t?t:0,i=o.activeReaction&&r!==o.activeReaction.output;(s>2e3||i&&s>0)&&n.push({labId:e.id,resourceType:r,amount:s,priority:i?10:5})}const{input1:i,input2:a}=yi.getInputLabs(e),c=[i,a].filter(e=>void 0!==e);for(const e of c){const t=e.mineralType;if(!t)continue;const s=o.labs.find(t=>t.labId===e.id),i=null==s?void 0:s.resourceType;if(i&&t!==i){const o=null!==(r=e.store[t])&&void 0!==r?r:0;o>0&&n.push({labId:e.id,resourceType:t,amount:o,priority:9})}}return n}areLabsReady(e,t){var r,o;const n=yi.getConfig(e);if(!n||!n.isValid)return!1;const{input1:s,input2:i}=yi.getInputLabs(e);if(!s||!i)return!1;if(500>(null!==(r=s.store[t.input1])&&void 0!==r?r:0))return!1;if(500>(null!==(o=i.store[t.input2])&&void 0!==o?o:0))return!1;const a=yi.getOutputLabs(e);if(0===a.length)return!1;for(const e of a){const t=e.store.getFreeCapacity();if(null===t||100>t)return!1}return!0}clearReactions(e){yi.clearActiveReaction(e),de.info("Cleared active reactions in "+e,{subsystem:"Labs"})}setActiveReaction(e,t,r,o){const n=yi.setActiveReaction(e,t,r,o);return n&&de.info(`Set active reaction: ${t} + ${r} -> ${o}`,{subsystem:"Labs",room:e}),n}runReactions(e){return yi.runReactions(e)}hasAvailableBoostLabs(e){return yi.getBoostLabs(e).length>0}prepareBoostLab(e,t){var r;const o=yi.getConfig(e);if(!o)return null;const n=yi.getBoostLabs(e);for(const e of n)if(e.mineralType===t&&(null!==(r=e.store[t])&&void 0!==r?r:0)>=30)return e.id;for(const e of n)if(!e.mineralType){const r=o.labs.find(t=>t.labId===e.id);return r&&(r.resourceType=t,o.lastUpdate=Game.time),e.id}return null}scheduleBoostedCreepUnboost(e){const t=Game.rooms[e];if(!t)return 0;const r=t.find(FIND_MY_CREEPS,{filter:e=>e.body.some(e=>e.boost)&&e.ticksToLive&&50>=e.ticksToLive});let o=0;for(const e of r)this.handleUnboost(e,t)&&o++;return o}handleUnboost(e,t){if(!e.body.some(e=>e.boost))return!1;if(!e.ticksToLive||e.ticksToLive>50)return!1;const r=t.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LAB});if(0===r.length)return!1;for(const o of r){const r=o.store.getFreeCapacity();if(null!==r&&r>=50){if(!e.pos.isNearTo(o))return e.moveTo(o),!1;if(o.unboostCreep(e)===OK)return de.info(`Unboosted ${e.name}, recovered resources`,{subsystem:"Labs",room:t.name}),!0}}return!1}getLabTaskStatus(e){const t=yi.getConfig(e);return t&&t.isValid?t.activeReaction?"reacting":this.getLabResourceNeeds(e).length>0?"loading":this.getLabOverflow(e).length>0?"unloading":"idle":"idle"}initialize(e){yi.initialize(e),yi.loadFromMemory(e)}save(e){yi.saveToMemory(e)}},ma={larvaWorker:aa,harvester:function(e){let t=function(e){const t=go(e.room).harvesterToSource.get(e.id);return t?Game.getObjectById(t):null}(e.creep);if(t||(t=e.assignedSource),t||(t=function(e){var t,r;const o=it(e.room);if(0===o.length)return null;const n="sourceCounts_"+e.room.name,s="sourceCounts_tick_"+e.room.name,i=global,a=i[n],c=i[s];let l;if(a&&c===Game.time)l=a;else{l=new Map;for(const e of o)l.set(e.id,0);for(const e in Game.creeps){const r=Game.creeps[e].memory;"harvester"===r.role&&r.sourceId&&l.has(r.sourceId)&&l.set(r.sourceId,(null!==(t=l.get(r.sourceId))&&void 0!==t?t:0)+1)}i[n]=l,i[s]=Game.time}let u=null,m=1/0;for(const e of o){const t=null!==(r=l.get(e.id))&&void 0!==r?r:0;m>t&&(m=t,u=e)}return u&&(e.memory.sourceId=u.id),u}(e),ca.debug(`${e.creep.name} harvester assigned to source ${null==t?void 0:t.id}`)),!t)return ca.warn(e.creep.name+" harvester has no source to harvest"),{type:"idle"};if(!e.creep.pos.isNearTo(t))return{type:"moveTo",target:t};const r=e.creep.store.getCapacity(),o=e.creep.store.getFreeCapacity()>0;if(null===r||0===r||o)return{type:"harvest",target:t};const n=function(e){var t;const r=null!==(t=e.memory)&&void 0!==t?t:{};if(r.nearbyContainerId&&r.nearbyContainerTick&&50>Game.time-r.nearbyContainerTick){const e=Game.getObjectById(r.nearbyContainerId);if(e)return e.store.getFreeCapacity(RESOURCE_ENERGY)>0?e:void 0;delete r.nearbyContainerId,delete r.nearbyContainerTick}const o=e.pos.findInRange(FIND_STRUCTURES,1,{filter:e=>e.structureType===STRUCTURE_CONTAINER})[0];return o?(r.nearbyContainerId=o.id,r.nearbyContainerTick=Game.time,o.store.getFreeCapacity(RESOURCE_ENERGY)>0?o:void 0):(delete r.nearbyContainerId,void delete r.nearbyContainerTick)}(e.creep);if(n)return ca.debug(`${e.creep.name} harvester transferring to container ${n.id}`),{type:"transfer",target:n,resourceType:RESOURCE_ENERGY};const s=function(e){var t;const r=null!==(t=e.memory)&&void 0!==t?t:{};if(r.nearbyLinkId&&r.nearbyLinkTick&&50>Game.time-r.nearbyLinkTick){const e=Game.getObjectById(r.nearbyLinkId);if(e)return e.store.getFreeCapacity(RESOURCE_ENERGY)>0?e:void 0;delete r.nearbyLinkId,delete r.nearbyLinkTick}const o=e.pos.findInRange(FIND_MY_STRUCTURES,1,{filter:e=>e.structureType===STRUCTURE_LINK})[0];return o?(r.nearbyLinkId=o.id,r.nearbyLinkTick=Game.time,o.store.getFreeCapacity(RESOURCE_ENERGY)>0?o:void 0):(delete r.nearbyLinkId,void delete r.nearbyLinkTick)}(e.creep);return s?(ca.debug(`${e.creep.name} harvester transferring to link ${s.id}`),{type:"transfer",target:s,resourceType:RESOURCE_ENERGY}):(ca.debug(e.creep.name+" harvester dropping energy on ground"),{type:"drop",resourceType:RESOURCE_ENERGY})},hauler:function(e){var t;const r=ta(e);if(la.debug(`${e.creep.name} hauler state: working=${r}, energy=${e.creep.store.getUsedCapacity(RESOURCE_ENERGY)}/${e.creep.store.getCapacity()}`),r){const r=Object.keys(e.creep.store)[0];if(0===e.creep.store.getUsedCapacity(RESOURCE_ENERGY)&&r&&r!==RESOURCE_ENERGY){const o=null!==(t=e.terminal)&&void 0!==t?t:e.storage;if(o)return{type:"transfer",target:o,resourceType:r}}const o=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_SPAWN&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0);if(o.length>0){const t=dt(e.creep,o,"hauler_spawn",10);if(t)return la.debug(`${e.creep.name} hauler delivering to spawn ${t.id}`),{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}const n=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_EXTENSION&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0);if(n.length>0){const t=dt(e.creep,n,"hauler_ext",10);if(t)return{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}const s=e.towers.filter(e=>e.store.getFreeCapacity(RESOURCE_ENERGY)>=100);if(s.length>0){const t=dt(e.creep,s,"hauler_tower",15);if(t)return{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}if(e.storage&&e.storage.store.getFreeCapacity(RESOURCE_ENERGY)>0)return{type:"transfer",target:e.storage,resourceType:RESOURCE_ENERGY};const i=e.depositContainers.filter(e=>e.store.getFreeCapacity(RESOURCE_ENERGY)>0);if(i.length>0){const t=dt(e.creep,i,"hauler_cont",15);if(t)return{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}if(e.isEmpty)return la.warn(e.creep.name+" hauler idle (empty, working=true, no targets)"),{type:"idle"};la.debug(e.creep.name+" hauler has energy but no targets, switching to collection mode"),ra(e)}if(e.droppedResources.length>0){const t=dt(e.creep,e.droppedResources,"hauler_drop",5);if(t)return{type:"pickup",target:t}}const o=e.tombstones.filter(e=>e.store.getUsedCapacity()>0);if(o.length>0){const t=dt(e.creep,o,"hauler_tomb",10);if(t){if(t.store.getUsedCapacity(RESOURCE_ENERGY)>0)return{type:"withdraw",target:t,resourceType:RESOURCE_ENERGY};const e=Object.keys(t.store).find(e=>e!==RESOURCE_ENERGY&&t.store.getUsedCapacity(e)>0);if(e)return{type:"withdraw",target:t,resourceType:e}}}const n=e.containers.filter(e=>e.store.getUsedCapacity(RESOURCE_ENERGY)>100);if(n.length>0){const t=Yr(e.creep,n,"energy_container");if(t)return la.debug(`${e.creep.name} hauler withdrawing from container ${t.id} with ${t.store.getUsedCapacity(RESOURCE_ENERGY)} energy`),{type:"withdraw",target:t,resourceType:RESOURCE_ENERGY};{la.warn(`${e.creep.name} hauler found ${n.length} containers but distribution returned null, falling back to closest`);const t=e.creep.pos.findClosestByRange(n);if(t)return la.debug(`${e.creep.name} hauler using fallback container ${t.id}`),{type:"withdraw",target:t,resourceType:RESOURCE_ENERGY}}}if(e.mineralContainers.length>0){const t=Yr(e.creep,e.mineralContainers,"mineral_container");if(t){const e=Object.keys(t.store).find(e=>e!==RESOURCE_ENERGY&&t.store.getUsedCapacity(e)>0);if(e)return{type:"withdraw",target:t,resourceType:e}}else{la.warn(`${e.creep.name} hauler found ${e.mineralContainers.length} mineral containers but distribution returned null, falling back to closest`);const t=e.creep.pos.findClosestByRange(e.mineralContainers);if(t){const r=Object.keys(t.store).find(e=>e!==RESOURCE_ENERGY&&t.store.getUsedCapacity(e)>0);if(r)return la.debug(`${e.creep.name} hauler using fallback mineral container ${t.id}`),{type:"withdraw",target:t,resourceType:r}}}}return e.storage&&e.storage.store.getUsedCapacity(RESOURCE_ENERGY)>0?(la.debug(e.creep.name+" hauler withdrawing from storage"),{type:"withdraw",target:e.storage,resourceType:RESOURCE_ENERGY}):(la.warn(e.creep.name+" hauler idle (no energy sources found)"),{type:"idle"})},builder:function(e){if(ta(e)){const t=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_SPAWN&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0);if(t.length>0){const r=dt(e.creep,t,"builder_spawn",5);if(r)return{type:"transfer",target:r,resourceType:RESOURCE_ENERGY}}const r=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_EXTENSION&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0);if(r.length>0){const t=dt(e.creep,r,"builder_ext",5);if(t)return{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}const o=e.towers.filter(e=>e.store.getFreeCapacity(RESOURCE_ENERGY)>=100);if(o.length>0){const t=dt(e.creep,o,"builder_tower",10);if(t)return{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}let n=function(e){const t=go(e.room).builderToTarget.get(e.id);return t?Game.getObjectById(t):null}(e.creep);return n?{type:"build",target:n}:e.prioritizedSites.length>0?{type:"build",target:e.prioritizedSites[0]}:e.room.controller?{type:"upgrade",target:e.room.controller}:{type:"idle"}}return na(e)},upgrader:function(e){if(ta(e)){const t=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_SPAWN&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0);if(t.length>0){const r=dt(e.creep,t,"upgrader_spawn",5);if(r)return{type:"transfer",target:r,resourceType:RESOURCE_ENERGY}}const r=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_EXTENSION&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0);if(r.length>0){const t=dt(e.creep,r,"upgrader_ext",5);if(t)return{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}const o=e.towers.filter(e=>e.store.getFreeCapacity(RESOURCE_ENERGY)>=100);if(o.length>0){const t=dt(e.creep,o,"upgrader_tower",10);if(t)return{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}return e.room.controller?{type:"upgrade",target:e.room.controller}:{type:"idle"}}const t=e.room.controller;if(t){const e=t.pos.findInRange(FIND_MY_STRUCTURES,2,{filter:e=>e.structureType===STRUCTURE_LINK&&e.store.getUsedCapacity(RESOURCE_ENERGY)>50});if(e.length>0)return{type:"withdraw",target:e.reduce((e,t)=>e.store.getUsedCapacity(RESOURCE_ENERGY)>t.store.getUsedCapacity(RESOURCE_ENERGY)?e:t),resourceType:RESOURCE_ENERGY}}const r="upgrader_nearby_containers",o=e.creep.memory,n=o[r];let s=[];if(n&&30>Game.time-n.tick?s=n.ids.map(e=>Game.getObjectById(e)).filter(e=>null!==e):(s=e.creep.pos.findInRange(FIND_STRUCTURES,3,{filter:e=>e.structureType===STRUCTURE_CONTAINER&&e.store.getUsedCapacity(RESOURCE_ENERGY)>50}),o[r]={ids:s.map(e=>e.id),tick:Game.time}),s.length>0){const t=dt(e.creep,s,"upgrader_nearby",30);if(t)return{type:"withdraw",target:t,resourceType:RESOURCE_ENERGY}}if(e.storage&&e.storage.store.getUsedCapacity(RESOURCE_ENERGY)>1e3)return{type:"withdraw",target:e.storage,resourceType:RESOURCE_ENERGY};const i=e.containers.filter(e=>e.store.getUsedCapacity(RESOURCE_ENERGY)>100);if(i.length>0){const t=dt(e.creep,i,"upgrader_cont",30);if(t)return{type:"withdraw",target:t,resourceType:RESOURCE_ENERGY}}const a=it(e.room).filter(e=>e.energy>0);if(a.length>0){const t=dt(e.creep,a,"upgrader_source",30);if(t)return{type:"harvest",target:t}}return{type:"idle"}},queenCarrier:function(e){return ta(e)?sa(e)||(e.storage?{type:"moveTo",target:e.storage}:{type:"idle"}):e.storage&&e.storage.store.getUsedCapacity(RESOURCE_ENERGY)>0?{type:"withdraw",target:e.storage,resourceType:RESOURCE_ENERGY}:e.terminal&&e.terminal.store.getUsedCapacity(RESOURCE_ENERGY)>0?{type:"withdraw",target:e.terminal,resourceType:RESOURCE_ENERGY}:{type:"idle"}},mineralHarvester:function(e){var t;const r=st(e.room,FIND_MINERALS)[0];if(!r)return{type:"idle"};if(!r.pos.lookFor(LOOK_STRUCTURES).find(e=>e.structureType===STRUCTURE_EXTRACTOR))return{type:"idle"};if(0===r.mineralAmount)return e.storage?{type:"moveTo",target:e.storage}:{type:"idle"};if(e.isFull){const r=Object.keys(e.creep.store)[0],o=e.creep.pos.findInRange(FIND_STRUCTURES,1,{filter:e=>e.structureType===STRUCTURE_CONTAINER&&e.store.getFreeCapacity(r)>0})[0];if(o)return{type:"transfer",target:o,resourceType:r};const n=null!==(t=e.terminal)&&void 0!==t?t:e.storage;if(n)return{type:"transfer",target:n,resourceType:r}}return{type:"harvestMineral",target:r}},depositHarvester:function(e){var t;if(!e.memory.targetId){const t=st(e.room,FIND_DEPOSITS);if(t.length>0){const r=t.reduce((e,t)=>e.cooldown<t.cooldown?e:t);e.memory.targetId=r.id}}if(!e.memory.targetId)return{type:"idle"};const r=Game.getObjectById(e.memory.targetId);if(!r||null===(o=r)||"object"!=typeof o||!("depositType"in o)||!("cooldown"in o)||"structureType"in o)return delete e.memory.targetId,{type:"idle"};var o;const n=r;if(n.cooldown>100)return delete e.memory.targetId,{type:"idle"};if(e.isFull){const r=Game.rooms[e.homeRoom];if(r){const o=null!==(t=r.terminal)&&void 0!==t?t:r.storage;if(o)return{type:"transfer",target:o,resourceType:Object.keys(e.creep.store)[0]}}return{type:"moveToRoom",roomName:e.homeRoom}}return{type:"harvestDeposit",target:n}},labTech:function(e){var t,r;if(0===e.labs.length)return{type:"idle"};const o=e.labs.slice(0,2),n=e.labs.slice(2);if(e.creep.store.getUsedCapacity()>0){const r=Object.keys(e.creep.store)[0],n=[RESOURCE_HYDROGEN,RESOURCE_OXYGEN,RESOURCE_UTRIUM,RESOURCE_LEMERGIUM,RESOURCE_KEANIUM,RESOURCE_ZYNTHIUM,RESOURCE_CATALYST];if(r!==RESOURCE_ENERGY&&!n.includes(r)){const o=null!==(t=e.terminal)&&void 0!==t?t:e.storage;if(o)return{type:"transfer",target:o,resourceType:r}}for(const e of o){const t=e.store.getFreeCapacity(r);if(null!==t&&t>0)return{type:"transfer",target:e,resourceType:r}}}for(const e of n){const t=e.mineralType;if(t&&e.store.getUsedCapacity(t)>100)return{type:"withdraw",target:e,resourceType:t}}const s=null!==(r=e.terminal)&&void 0!==r?r:e.storage;if(s){const e=[RESOURCE_HYDROGEN,RESOURCE_OXYGEN,RESOURCE_UTRIUM,RESOURCE_LEMERGIUM,RESOURCE_KEANIUM,RESOURCE_ZYNTHIUM,RESOURCE_CATALYST];for(const t of o)for(const r of e)if(s.store.getUsedCapacity(r)>0&&t.store.getFreeCapacity(r)>0)return{type:"withdraw",target:s,resourceType:r}}return{type:"idle"}},labSupply:function(e){return function(e){var t,r;const o=null!==(t=e.memory.working)&&void 0!==t&&t;e.isEmpty&&(e.memory.working=!1),e.isFull&&(e.memory.working=!0);const n=null!==(r=e.memory.working)&&void 0!==r&&r;return o!==n&&(gt(e.creep),delete e.memory.targetId),n}(e)?function(e){if(e.memory.targetId){const t=Game.getObjectById(e.memory.targetId);if(t&&t.structureType===STRUCTURE_LAB){const r=t,o=Object.keys(e.creep.store).find(t=>e.creep.store[t]>0);if(o)return{type:"transfer",target:r,resourceType:o}}delete e.memory.targetId}const t=ua.getLabResourceNeeds(e.room.name);if(0===t.length)return{type:"idle"};t.sort((e,t)=>t.priority-e.priority);const r=t[0];if(!r)return{type:"idle"};const o=Object.keys(e.creep.store).find(t=>e.creep.store[t]>0);if(o&&o!==r.resourceType&&e.terminal)return{type:"transfer",target:e.terminal,resourceType:o};const n=Game.getObjectById(r.labId);return n?(e.memory.targetId=r.labId,{type:"transfer",target:n,resourceType:r.resourceType}):{type:"idle"}}(e):function(e){var t;const r=ua.getLabOverflow(e.room.name);if(r.length>0){r.sort((e,t)=>t.priority-e.priority);const e=r[0];if(e){const t=Game.getObjectById(e.labId);if(t)return{type:"withdraw",target:t,resourceType:e.resourceType}}}const o=ua.getLabResourceNeeds(e.room.name);if(o.length>0&&e.terminal){o.sort((e,t)=>t.priority-e.priority);const r=o[0];if(r&&(null!==(t=e.terminal.store[r.resourceType])&&void 0!==t?t:0)>0)return e.memory.targetId=r.labId,{type:"withdraw",target:e.terminal,resourceType:r.resourceType}}return{type:"idle"}}(e)},factoryWorker:function(e){var t;if(!e.factory)return{type:"idle"};if(ta(e)){const t=Object.keys(e.creep.store)[0];return{type:"transfer",target:e.factory,resourceType:t}}const r=null!==(t=e.terminal)&&void 0!==t?t:e.storage;if(!r)return{type:"idle"};const o=[RESOURCE_UTRIUM_BAR,RESOURCE_LEMERGIUM_BAR,RESOURCE_KEANIUM_BAR,RESOURCE_ZYNTHIUM_BAR,RESOURCE_GHODIUM_MELT,RESOURCE_OXIDANT,RESOURCE_REDUCTANT,RESOURCE_PURIFIER,RESOURCE_BATTERY];for(const t of o)if(e.factory.store.getUsedCapacity(t)>100)return{type:"withdraw",target:e.factory,resourceType:t};if(5e3>e.factory.store.getUsedCapacity(RESOURCE_ENERGY)&&r.store.getUsedCapacity(RESOURCE_ENERGY)>1e4)return{type:"withdraw",target:r,resourceType:RESOURCE_ENERGY};const n=[RESOURCE_UTRIUM,RESOURCE_LEMERGIUM,RESOURCE_KEANIUM,RESOURCE_ZYNTHIUM,RESOURCE_OXYGEN,RESOURCE_HYDROGEN,RESOURCE_CATALYST,RESOURCE_GHODIUM];for(const t of n)if(1e3>e.factory.store.getUsedCapacity(t)&&r.store.getUsedCapacity(t)>500)return{type:"withdraw",target:r,resourceType:t};return{type:"idle"}},remoteHarvester:function(e){const t=e.memory.targetRoom;if(!t||t===e.memory.homeRoom)return{type:"idle"};if(e.nearbyEnemies&&e.hostiles.length>0){const r=e.hostiles.filter(t=>5>=e.creep.pos.getRangeTo(t)&&(t.getActiveBodyparts(ATTACK)>0||t.getActiveBodyparts(RANGED_ATTACK)>0));if(r.length>0)return e.room.name===t?{type:"moveToRoom",roomName:e.memory.homeRoom}:{type:"flee",from:r.map(e=>e.pos)}}if(e.room.name!==t)return{type:"moveToRoom",roomName:t};let r=e.assignedSource;if(r||(r=function(e){const t=it(e.room);if(0===t.length)return null;const r=t[0];return r&&(e.memory.sourceId=r.id),r}(e)),!r)return{type:"idle"};if(!e.creep.pos.isNearTo(r))return{type:"moveTo",target:r};const o=e.creep.store.getCapacity(),n=e.creep.store.getFreeCapacity()>0;if(null===o||0===o||n)return{type:"harvest",target:r};const s=function(e,t){const r=e.memory;if(r.remoteContainerId&&r.remoteContainerTick&&50>Game.time-r.remoteContainerTick){const e=Game.getObjectById(r.remoteContainerId);if(e)return e;delete r.remoteContainerId,delete r.remoteContainerTick}const o=t.pos.findInRange(FIND_STRUCTURES,2,{filter:e=>e.structureType===STRUCTURE_CONTAINER})[0];return o?(r.remoteContainerId=o.id,r.remoteContainerTick=Game.time):(delete r.remoteContainerId,delete r.remoteContainerTick),o}(e.creep,r);return s?{type:"transfer",target:s,resourceType:RESOURCE_ENERGY}:{type:"drop",resourceType:RESOURCE_ENERGY}},remoteHauler:function(e){const t=ta(e),r=e.memory.targetRoom,o=e.memory.homeRoom;if(!r||r===o)return{type:"idle"};if(e.nearbyEnemies&&e.hostiles.length>0){const r=e.hostiles.filter(t=>5>=e.creep.pos.getRangeTo(t)&&(t.getActiveBodyparts(ATTACK)>0||t.getActiveBodyparts(RANGED_ATTACK)>0));if(r.length>0)return t&&e.room.name!==o?{type:"moveToRoom",roomName:o}:{type:"flee",from:r.map(e=>e.pos)}}if(t){if(e.room.name!==o)return{type:"moveToRoom",roomName:o};const t=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_SPAWN&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0);if(t.length>0){const r=dt(e.creep,t,"remoteHauler_spawn",5);if(r)return{type:"transfer",target:r,resourceType:RESOURCE_ENERGY}}const n=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_EXTENSION&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0);if(n.length>0){const t=dt(e.creep,n,"remoteHauler_ext",5);if(t)return{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}const s=e.towers.filter(e=>e.store.getFreeCapacity(RESOURCE_ENERGY)>=100);if(s.length>0){const t=dt(e.creep,s,"remoteHauler_tower",10);if(t)return{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}if(e.storage&&e.storage.store.getFreeCapacity(RESOURCE_ENERGY)>0)return{type:"transfer",target:e.storage,resourceType:RESOURCE_ENERGY};const i=e.depositContainers.filter(e=>e.store.getFreeCapacity(RESOURCE_ENERGY)>0);if(i.length>0){const t=dt(e.creep,i,"remoteHauler_cont",10);if(t)return{type:"transfer",target:t,resourceType:RESOURCE_ENERGY}}return e.isEmpty||e.room.name!==o?{type:"idle"}:(ra(e),{type:"moveToRoom",roomName:r})}{if(e.room.name!==r)return{type:"moveToRoom",roomName:r};const t=.3*e.creep.store.getCapacity(RESOURCE_ENERGY),o=st(e.room,FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_CONTAINER&&e.store.getUsedCapacity(RESOURCE_ENERGY)>=t,filterKey:"remoteContainers"});if(o.length>0){const t=dt(e.creep,o,"remoteHauler_remoteCont",10);if(t)return{type:"withdraw",target:t,resourceType:RESOURCE_ENERGY}}const n=lt(e.room,RESOURCE_ENERGY).filter(e=>e.amount>50);if(n.length>0){const t=dt(e.creep,n,"remoteHauler_remoteDrop",3);if(t)return{type:"pickup",target:t}}if(0===o.length){const t=st(e.room,FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_CONTAINER,filterKey:"containers"});if(t.length>0){const r=dt(e.creep,t,"remoteHauler_waitCont",20);if(r&&e.creep.pos.getRangeTo(r)>2)return{type:"moveTo",target:r}}}return{type:"idle"}}},interRoomCarrier:function(e){const t=e.memory;if(!t.transferRequest)return{type:"idle"};const{fromRoom:r,toRoom:o,resourceType:n}=t.transferRequest;if(e.creep.store.getUsedCapacity(n)>0){if(e.room.name!==o)return{type:"moveToRoom",roomName:o};const t=Game.rooms[o];if(!t)return{type:"moveToRoom",roomName:o};if(t.storage)return{type:"transfer",target:t.storage,resourceType:n};const r=st(t,FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_CONTAINER&&e.store.getFreeCapacity(n)>0,filterKey:"container_"+n});if(r.length>0){const t=dt(e.creep,r,"interRoomCarrier_targetCont",10);if(t)return{type:"transfer",target:t,resourceType:n}}const s=at(t,STRUCTURE_SPAWN);return s.length>0?e.creep.pos.isNearTo(s[0])?{type:"drop",resourceType:n}:{type:"moveTo",target:s[0].pos}:{type:"idle"}}{if(e.room.name!==r)return{type:"moveToRoom",roomName:r};const t=Game.rooms[r];if(!t)return{type:"moveToRoom",roomName:r};if(t.storage&&t.storage.store.getUsedCapacity(n)>0)return{type:"withdraw",target:t.storage,resourceType:n};const o=st(t,FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_CONTAINER&&e.store.getUsedCapacity(n)>0,filterKey:"container_"+n});if(o.length>0){const t=dt(e.creep,o,"interRoomCarrier_sourceCont",10);if(t)return{type:"withdraw",target:t,resourceType:n}}return{type:"idle"}}}};function da(e){var t;return(null!==(t=ma[e.memory.role])&&void 0!==t?t:aa)(e)}const pa=me("MilitaryBehaviors"),ga="patrol";function fa(e){const t=e.find(FIND_MY_SPAWNS),r=t.length,o=e.name,n=Ze.get(o,{namespace:ga});if(n&&n.metadata.spawnCount===r)return n.waypoints.map(e=>new RoomPosition(e.x,e.y,e.roomName));const s=e.name,i=[];for(const e of t)i.push(new RoomPosition(e.pos.x+3,e.pos.y+3,s)),i.push(new RoomPosition(e.pos.x-3,e.pos.y-3,s));i.push(new RoomPosition(10,5,s)),i.push(new RoomPosition(25,5,s)),i.push(new RoomPosition(39,5,s)),i.push(new RoomPosition(10,44,s)),i.push(new RoomPosition(25,44,s)),i.push(new RoomPosition(39,44,s)),i.push(new RoomPosition(5,10,s)),i.push(new RoomPosition(5,25,s)),i.push(new RoomPosition(5,39,s)),i.push(new RoomPosition(44,10,s)),i.push(new RoomPosition(44,25,s)),i.push(new RoomPosition(44,39,s)),i.push(new RoomPosition(10,10,s)),i.push(new RoomPosition(39,10,s)),i.push(new RoomPosition(10,39,s)),i.push(new RoomPosition(39,39,s)),i.push(new RoomPosition(25,25,s));const a=i.map(e=>({x:Math.max(2,Math.min(47,e.x)),y:Math.max(2,Math.min(47,e.y)),roomName:s})).filter(t=>e.getTerrain().get(t.x,t.y)!==TERRAIN_MASK_WALL).map(e=>new RoomPosition(e.x,e.y,e.roomName)),c={waypoints:a.map(e=>({x:e.x,y:e.y,roomName:e.roomName})),metadata:{spawnCount:r}};return Ze.set(o,c,{namespace:ga,ttl:1e3}),a}function ha(e,t){var r;if(0===t.length)return null;const o=e.memory;void 0===o.patrolIndex&&(o.patrolIndex=0);const n=t[o.patrolIndex%t.length];return n&&2>=e.pos.getRangeTo(n)&&(o.patrolIndex=(o.patrolIndex+1)%t.length),null!==(r=t[o.patrolIndex%t.length])&&void 0!==r?r:null}function ya(e){var t,r;if(0===e.hostiles.length)return null;const o=e.hostiles.map(e=>{let t=0;if(t+=100*e.getActiveBodyparts(HEAL),t+=50*e.getActiveBodyparts(RANGED_ATTACK),t+=40*e.getActiveBodyparts(ATTACK),t+=60*e.getActiveBodyparts(CLAIM),t+=30*e.getActiveBodyparts(WORK),t>0)for(const r of e.body)if(r.boost){t+=20;break}return{hostile:e,score:t}});return o.sort((e,t)=>t.score-e.score),null!==(r=null===(t=o[0])||void 0===t?void 0:t.hostile)&&void 0!==r?r:null}function Ra(e,t){return e.getActiveBodyparts(t)>0}function Ea(e,t){if(!e.swarmState)return null;const r=Lr(e.room,e.swarmState);return r&&e.creep.pos.getRangeTo(r)>2?(pa.debug(`${e.creep.name} ${t} moving to collection point at ${r.x},${r.y}`),{type:"moveTo",target:r}):null}function Ta(e){var t;return null===(t=Memory.squads)||void 0===t?void 0:t[e]}function Ca(e){const t=e.creep.memory;if(Gn.checkAndExecuteRetreat(e.creep))return{type:"idle"};if(t.assistTarget){if(e.creep.room.name!==t.assistTarget)return{type:"moveToRoom",roomName:t.assistTarget};if(0===e.hostiles.length){if(delete t.assistTarget,e.creep.room.name!==e.homeRoom)return{type:"moveToRoom",roomName:e.homeRoom}}else{const t=ya(e);if(t){const r=e.creep.pos.getRangeTo(t),o=Ra(e.creep,RANGED_ATTACK),n=Ra(e.creep,ATTACK);return o&&3>=r?{type:"rangedAttack",target:t}:n&&1>=r?{type:"attack",target:t}:{type:"moveTo",target:t}}}}if(e.creep.room.name!==e.homeRoom)return{type:"moveToRoom",roomName:e.homeRoom};const r=ya(e);if(r){const t=e.creep.pos.getRangeTo(r),o=Ra(e.creep,RANGED_ATTACK),n=Ra(e.creep,ATTACK);return o&&3>=t?{type:"rangedAttack",target:r}:n&&1>=t?{type:"attack",target:r}:{type:"moveTo",target:r}}const o=fa(e.room),n=ha(e.creep,o);if(n)return{type:"moveTo",target:n};const s=e.creep.pos.findClosestByRange(FIND_MY_SPAWNS);return s&&e.creep.pos.getRangeTo(s)>5?{type:"moveTo",target:s}:{type:"idle"}}function va(e){const t=e.creep.memory;if(e.creep.hits<.5*e.creep.hitsMax)return{type:"heal",target:e.creep};if(t.targetRoom){if(e.room.name!==t.targetRoom)return{type:"moveToRoom",roomName:t.targetRoom};const r=e.room.find(FIND_MY_CREEPS,{filter:e=>{const r=e.memory;return"powerHarvester"===r.role&&r.targetRoom===t.targetRoom}});if(r.length>0){r.sort((e,t)=>(e.hitsMax>0?e.hits/e.hitsMax:1)-(t.hitsMax>0?t.hits/t.hitsMax:1));const t=r[0],o=e.creep.pos.getRangeTo(t);return o>3?{type:"moveTo",target:t}:o>1?{type:"rangedHeal",target:t}:{type:"heal",target:t}}const o=e.room.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_POWER_BANK})[0];if(!o&&0===r.length)return delete t.targetRoom,{type:"moveToRoom",roomName:e.homeRoom};if(o&&e.creep.pos.getRangeTo(o)>3)return{type:"moveTo",target:o}}if(t.assistTarget){const r=Game.rooms[t.assistTarget];if(!r)return{type:"moveToRoom",roomName:t.assistTarget};if(0===r.find(FIND_HOSTILE_CREEPS).length)return delete t.assistTarget,{type:"idle"};if(e.creep.room.name!==t.assistTarget)return{type:"moveToRoom",roomName:t.assistTarget}}const r=e.creep.pos.findInRange(FIND_MY_CREEPS,3,{filter:e=>e.hits<e.hitsMax});if(r.length>0){r.sort((e,t)=>(e.hitsMax>0?e.hits/e.hitsMax:1)-(t.hitsMax>0?t.hits/t.hitsMax:1));const t=r[0];return e.creep.pos.getRangeTo(t)>1?{type:"rangedHeal",target:t}:{type:"heal",target:t}}const o=e.room.find(FIND_MY_CREEPS,{filter:e=>{const t=e.memory;return"military"===t.family&&"healer"!==t.role}});if(o.length>0){const t=dt(e.creep,o,"healer_follow",5);if(t)return{type:"moveTo",target:t}}const n=fa(e.room),s=ha(e.creep,n);return s?{type:"moveTo",target:s}:{type:"idle"}}function Sa(e){var t;if(e.memory.squadId){const t=Ta(e.memory.squadId);if(t)return Oa(e,t)}if(.3>e.creep.hits/e.creep.hitsMax){if(e.room.name!==e.homeRoom)return{type:"moveToRoom",roomName:e.homeRoom};const t=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_SPAWN);return t.length>0&&e.creep.pos.getRangeTo(t[0])>3?{type:"moveTo",target:t[0]}:{type:"idle"}}const r=null!==(t=e.memory.targetRoom)&&void 0!==t?t:e.homeRoom;if(e.room.name!==r)return{type:"moveToRoom",roomName:r};const o=ya(e);if(o){const t=e.creep.pos.getRangeTo(o),r=Ra(e.creep,RANGED_ATTACK),n=Ra(e.creep,ATTACK);return r&&3>=t?{type:"rangedAttack",target:o}:n&&1>=t?{type:"attack",target:o}:{type:"moveTo",target:o}}const n=Jr(e.creep.pos,FIND_HOSTILE_STRUCTURES,{filter:e=>e.structureType!==STRUCTURE_CONTROLLER});if(n)return{type:"attack",target:n};const s=fa(e.room),i=ha(e.creep,s);if(i)return{type:"moveTo",target:i};const a=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_SPAWN);if(a.length>0){const t=dt(e.creep,a,"soldier_spawn",20);if(t&&e.creep.pos.getRangeTo(t)>5)return{type:"moveTo",target:t}}return{type:"idle"}}function _a(e){var t;if(e.memory.squadId){const t=Ta(e.memory.squadId);if(t)return Oa(e,t)}if(.3>e.creep.hits/e.creep.hitsMax){if(e.room.name!==e.homeRoom)return{type:"moveToRoom",roomName:e.homeRoom};const t=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_SPAWN);return t.length>0&&e.creep.pos.getRangeTo(t[0])>3?{type:"moveTo",target:t[0]}:{type:"idle"}}const r=null!==(t=e.memory.targetRoom)&&void 0!==t?t:e.homeRoom;if(e.room.name!==r)return{type:"moveToRoom",roomName:r};const o=Jr(e.creep.pos,FIND_HOSTILE_SPAWNS);if(o)return{type:"dismantle",target:o};const n=Jr(e.creep.pos,FIND_HOSTILE_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_TOWER});if(n)return{type:"dismantle",target:n};const s=e.room.find(FIND_STRUCTURES,{filter:t=>{var r;return t.structureType===STRUCTURE_WALL?1e5>t.hits&&!(null===(r=e.room.controller)||void 0===r?void 0:r.my):t.structureType===STRUCTURE_RAMPART&&1e5>t.hits&&!t.my}});if(s.length>0){const t=dt(e.creep,s,"siege_wall",10);if(t)return{type:"dismantle",target:t}}const i=Jr(e.creep.pos,FIND_HOSTILE_STRUCTURES,{filter:e=>e.structureType!==STRUCTURE_CONTROLLER});if(i)return{type:"dismantle",target:i};const a=Ea(e,"siegeUnit");if(a)return a;const c=fa(e.room),l=ha(e.creep,c);return l?{type:"moveTo",target:l}:{type:"idle"}}function ba(e){const t=e.creep.memory;if(Gn.checkAndExecuteRetreat(e.creep))return{type:"idle"};if(.3>e.creep.hits/e.creep.hitsMax){if(t.assistTarget&&delete t.assistTarget,e.room.name!==e.homeRoom)return{type:"moveToRoom",roomName:e.homeRoom};const r=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_SPAWN);return r.length>0&&e.creep.pos.getRangeTo(r[0])>3?{type:"moveTo",target:r[0]}:{type:"idle"}}if(t.assistTarget){const r=Game.rooms[t.assistTarget];if(!r)return{type:"moveToRoom",roomName:t.assistTarget};{if(0===r.find(FIND_HOSTILE_CREEPS).length)return delete t.assistTarget,{type:"idle"};if(e.creep.room.name!==t.assistTarget)return{type:"moveToRoom",roomName:t.assistTarget};const o=ya(e);if(o){const t=e.creep.pos.getRangeTo(o);return 3>t?{type:"flee",from:[o.pos]}:t>3?{type:"moveTo",target:o}:{type:"rangedAttack",target:o}}}}if(e.memory.squadId){const t=Ta(e.memory.squadId);if(t)return Oa(e,t)}const r=ya(e);if(r){const t=e.creep.pos.getRangeTo(r);return 3>t?{type:"flee",from:[r.pos]}:t>3?{type:"moveTo",target:r}:{type:"rangedAttack",target:r}}const o=fa(e.room),n=ha(e.creep,o);if(n)return{type:"moveTo",target:n};const s=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_SPAWN);if(s.length>0){const t=dt(e.creep,s,"harasser_home_spawn",20);if(t&&e.creep.pos.getRangeTo(t)>10)return{type:"moveTo",target:t}}return{type:"idle"}}function Oa(e,t){var r;switch(t.state){case"gathering":if(e.room.name!==t.rallyRoom)return{type:"moveToRoom",roomName:t.rallyRoom};const o=new RoomPosition(25,25,t.rallyRoom);return e.creep.pos.getRangeTo(o)>3?{type:"moveTo",target:o}:{type:"idle"};case"moving":{const r=t.targetRooms[0];return r&&e.room.name!==r?(()=>{const r=t.members.filter(t=>{const r=Game.creeps[t];return r&&r.room.name===e.room.name}).length,o=t.members.length;return Math.max(2,.5*o)>r})()?{type:"idle"}:{type:"moveToRoom",roomName:r}:{type:"idle"}}case"attacking":const n=e.creep.hits/e.creep.hitsMax;if((null!==(r=t.retreatThreshold)&&void 0!==r?r:.3)>n&&e.room.name!==t.rallyRoom)return{type:"moveToRoom",roomName:t.rallyRoom};switch(e.memory.role){case"soldier":case"guard":default:return Sa(e);case"healer":return va(e);case"siegeUnit":return _a(e);case"ranger":return ba(e)}case"retreating":return e.room.name!==t.rallyRoom?{type:"moveToRoom",roomName:t.rallyRoom}:{type:"moveTo",target:new RoomPosition(25,25,t.rallyRoom)};case"dissolving":return e.room.name!==e.homeRoom?{type:"moveToRoom",roomName:e.homeRoom}:(delete e.memory.squadId,{type:"idle"});default:return{type:"idle"}}}const Ua={guard:Ca,remoteGuard:function(e){const t=e.creep.memory;if(!t.targetRoom){if(e.creep.room.name!==e.homeRoom)return{type:"moveToRoom",roomName:e.homeRoom};const t=fa(e.room),r=ha(e.creep,t);return r?{type:"moveTo",target:r}:{type:"idle"}}if(e.creep.room.name!==t.targetRoom)return{type:"moveToRoom",roomName:t.targetRoom};const r=e.room.find(FIND_HOSTILE_CREEPS).filter(e=>e.body.some(e=>e.type===ATTACK||e.type===RANGED_ATTACK||e.type===WORK));if(0===r.length){if(e.creep.room.name!==e.homeRoom)return{type:"moveToRoom",roomName:e.homeRoom};const t=fa(e.room),r=ha(e.creep,t);return r?{type:"moveTo",target:r}:{type:"idle"}}const o=function(e,t){if(0===t.length)return null;const r=[t.filter(e=>e.body.some(e=>e.boost)),t.filter(e=>Ra(e,HEAL)),t.filter(e=>Ra(e,RANGED_ATTACK)),t.filter(e=>Ra(e,ATTACK)),t];for(const t of r)if(t.length>0)return e.creep.pos.findClosestByRange(t);return null}(e,r);if(o){const t=e.creep.pos.getRangeTo(o),r=Ra(e.creep,RANGED_ATTACK),n=Ra(e.creep,ATTACK);return r&&3>=t?{type:"rangedAttack",target:o}:n&&1>=t?{type:"attack",target:o}:{type:"moveTo",target:o}}const n=e.room.find(FIND_SOURCES);if(n.length>0){const t=e.creep.pos.findClosestByRange(n);if(t&&e.creep.pos.getRangeTo(t)>3)return{type:"moveTo",target:t}}return{type:"idle"}},healer:va,soldier:Sa,siegeUnit:_a,harasser:function(e){const t=e.memory.targetRoom;if(.4>e.creep.hits/e.creep.hitsMax){if(e.room.name!==e.homeRoom)return{type:"moveToRoom",roomName:e.homeRoom};const t=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_SPAWN);return t.length>0&&e.creep.pos.getRangeTo(t[0])>3?{type:"moveTo",target:t[0]}:{type:"idle"}}if(!t)return Ea(e,"harasser (no target)")||{type:"idle"};if(e.room.name!==t)return{type:"moveToRoom",roomName:t};const r=e.hostiles.filter(t=>5>e.creep.pos.getRangeTo(t)&&t.body.some(e=>e.type===ATTACK||e.type===RANGED_ATTACK));if(r.length>0)return{type:"flee",from:r.map(e=>e.pos)};const o=e.hostiles.filter(e=>e.body.some(e=>e.type===WORK||e.type===CARRY));if(o.length>0){const t=o.reduce((t,r)=>e.creep.pos.getRangeTo(t)<e.creep.pos.getRangeTo(r)?t:r),r=e.creep.pos.getRangeTo(t);return r>1?r>3?{type:"moveTo",target:t}:{type:"rangedAttack",target:t}:{type:"attack",target:t}}if(e.room.name!==e.homeRoom)return{type:"moveToRoom",roomName:e.homeRoom};const n=Ea(e,"harasser (no targets)");if(n)return n;const s=fa(e.room),i=ha(e.creep,s);return i?{type:"moveTo",target:i}:{type:"idle"}},ranger:ba};function Ma(e){var t;return(null!==(t=Ua[e.memory.role])&&void 0!==t?t:Ca)(e)}function Aa(e,t){var r,o,n,s,i,a,c;const l=t.knownRooms,u=l[e.name],m=null!==(r=null==u?void 0:u.lastSeen)&&void 0!==r?r:0,d=Game.time-m;if(u&&2e3>d){u.lastSeen=Game.time;const t=Zr(e,FIND_HOSTILE_CREEPS);return u.threatLevel=t.length>5?3:t.length>2?2:t.length>0?1:0,void(e.controller&&(u.controllerLevel=null!==(o=e.controller.level)&&void 0!==o?o:0,(null===(n=e.controller.owner)||void 0===n?void 0:n.username)&&(u.owner=e.controller.owner.username),(null===(s=e.controller.reservation)||void 0===s?void 0:s.username)&&(u.reserver=e.controller.reservation.username)))}const p=e.find(FIND_SOURCES),g=e.find(FIND_MINERALS)[0],f=e.controller,h=Zr(e,FIND_HOSTILE_CREEPS),y=e.getTerrain();let R=0,E=0;for(let e=5;50>e;e+=10)for(let t=5;50>t;t+=10){const r=y.get(e,t);r===TERRAIN_MASK_SWAMP?R++:0===r&&E++}const T=R>2*E?"swamp":E>2*R?"plains":"mixed",C=e.name.match(/^[WE](\d+)[NS](\d+)$/),v=!!C&&(parseInt(C[1],10)%10==0||parseInt(C[2],10)%10==0),S=e.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_KEEPER_LAIR}).length>0,_={name:e.name,lastSeen:Game.time,sources:p.length,controllerLevel:null!==(i=null==f?void 0:f.level)&&void 0!==i?i:0,threatLevel:h.length>5?3:h.length>2?2:h.length>0?1:0,scouted:!0,terrain:T,isHighway:v,isSK:S};(null===(a=null==f?void 0:f.owner)||void 0===a?void 0:a.username)&&(_.owner=f.owner.username),(null===(c=null==f?void 0:f.reservation)||void 0===c?void 0:c.username)&&(_.reserver=f.reservation.username),(null==g?void 0:g.mineralType)&&(_.mineralType=g.mineralType),l[e.name]=_}function wa(e){return{type:"moveTo",target:new RoomPosition(25,25,e)}}function ka(e){const t=Wt.getEmpire();if(uo.isExit(e.creep.pos))return wa(e.room.name);const r=e.memory.lastExploredRoom;let o=e.memory.targetRoom;if(!o){if(o=function(e,t,r){var o,n,s;const i=t.knownRooms,a=Game.map.describeExits(e);if(!a)return;const c=[];for(const[,e]of Object.entries(a)){if(r&&e===r)continue;const t=null!==(n=null===(o=i[e])||void 0===o?void 0:o.lastSeen)&&void 0!==n?n:0;Game.time-t>1e3&&c.push({room:e,lastSeen:t})}return c.sort((e,t)=>e.lastSeen-t.lastSeen),null===(s=c[0])||void 0===s?void 0:s.room}(e.room.name,t,r),!o)return delete e.memory.targetRoom,delete e.memory.lastExploredRoom,{type:"idle"};e.memory.targetRoom=o}if(o&&e.room.name!==o)return{type:"moveToRoom",roomName:o};if(o&&e.room.name===o){const r=function(e){const t=[new RoomPosition(5,5,e.name),new RoomPosition(44,5,e.name),new RoomPosition(5,44,e.name),new RoomPosition(44,44,e.name),new RoomPosition(25,25,e.name)],r=e.getTerrain();for(const e of t)if(r.get(e.x,e.y)!==TERRAIN_MASK_WALL)return e;return null}(e.room);if(r){const o=3;return e.creep.pos.getRangeTo(r)>o?{type:"moveTo",target:r}:(Aa(e.room,t),e.memory.lastExploredRoom=e.room.name,delete e.memory.targetRoom,{type:"idle"})}return Aa(e.room,t),e.memory.lastExploredRoom=e.room.name,delete e.memory.targetRoom,{type:"idle"}}return{type:"idle"}}io=function(){};const Na={scout:ka,claimer:function(e){const t=e.memory.targetRoom;if(!t){const t=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_SPAWN);if(t.length>0){const r=dt(e.creep,t,"claimer_spawn",20);if(r)return{type:"moveTo",target:r}}return{type:"idle"}}if(uo.isExit(e.creep.pos))return wa(e.room.name);if(e.room.name!==t)return{type:"moveToRoom",roomName:t};const r=e.room.controller;if(!r)return{type:"idle"};const o=e.memory.task;return"claim"===o?{type:"claim",target:r}:"attack"===o?{type:"attackController",target:r}:{type:"reserve",target:r}},engineer:function(e){var t,r;if(e.isEmpty&&(e.memory.working=!1),e.isFull&&(e.memory.working=!0),e.memory.working){const o=e.repairTargets.filter(e=>(e.structureType===STRUCTURE_SPAWN||e.structureType===STRUCTURE_TOWER||e.structureType===STRUCTURE_STORAGE)&&e.hits<.5*e.hitsMax);if(o.length>0){const t=dt(e.creep,o,"engineer_critical",5);if(t)return{type:"repair",target:t}}const n=e.repairTargets.filter(e=>(e.structureType===STRUCTURE_ROAD||e.structureType===STRUCTURE_CONTAINER)&&e.hits<.75*e.hitsMax);if(n.length>0){const t=dt(e.creep,n,"engineer_infra",5);if(t)return{type:"repair",target:t}}const s=null!==(r=null===(t=e.swarmState)||void 0===t?void 0:t.danger)&&void 0!==r?r:0,i=0===s?1e5:1===s?3e5:2===s?5e6:5e7,a=e.repairTargets.filter(e=>e.structureType===STRUCTURE_RAMPART&&e.hits<i);if(a.length>0){const t=dt(e.creep,a,"engineer_rampart",5);if(t)return{type:"repair",target:t}}const c=e.repairTargets.filter(e=>e.structureType===STRUCTURE_WALL&&e.hits<i);if(c.length>0){const t=dt(e.creep,c,"engineer_wall",5);if(t)return{type:"repair",target:t}}return e.prioritizedSites.length>0?{type:"build",target:e.prioritizedSites[0]}:{type:"idle"}}if(e.storage&&e.storage.store.getUsedCapacity(RESOURCE_ENERGY)>0)return{type:"withdraw",target:e.storage,resourceType:RESOURCE_ENERGY};const o=e.containers.filter(e=>e.store.getUsedCapacity(RESOURCE_ENERGY)>100);if(o.length>0){const t=dt(e.creep,o,"engineer_cont",15);if(t)return{type:"withdraw",target:t,resourceType:RESOURCE_ENERGY}}return{type:"idle"}},remoteWorker:function(e){var t;const r=null!==(t=e.memory.targetRoom)&&void 0!==t?t:e.homeRoom;if(e.isEmpty&&(e.memory.working=!1),e.isFull&&(e.memory.working=!0),e.memory.working){if(e.room.name!==e.homeRoom)return{type:"moveToRoom",roomName:e.homeRoom};if(e.storage)return{type:"transfer",target:e.storage,resourceType:RESOURCE_ENERGY};const t=e.spawnStructures.filter(e=>e.structureType===STRUCTURE_SPAWN);if(t.length>0){const r=dt(e.creep,t,"remoteWorker_spawn",5);if(r)return{type:"transfer",target:r,resourceType:RESOURCE_ENERGY}}return{type:"idle"}}if(e.room.name!==r)return{type:"moveToRoom",roomName:r};const o=e.creep.pos.findClosestByRange(FIND_SOURCES_ACTIVE);return o?{type:"harvest",target:o}:{type:"idle"}},linkManager:function(e){const t=e.room.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LINK});if(2>t.length||!e.storage)return{type:"idle"};const r=t.find(t=>2>=t.pos.getRangeTo(e.storage));return r?r.store.getUsedCapacity(RESOURCE_ENERGY)>400?e.creep.store.getFreeCapacity()>0?{type:"withdraw",target:r,resourceType:RESOURCE_ENERGY}:{type:"transfer",target:e.storage,resourceType:RESOURCE_ENERGY}:e.creep.pos.getRangeTo(e.storage)>2?{type:"moveTo",target:e.storage}:{type:"idle"}:{type:"idle"}},terminalManager:function(e){if(!e.terminal||!e.storage)return{type:"idle"};const t=e.terminal.store.getUsedCapacity(RESOURCE_ENERGY),r=e.storage.store.getUsedCapacity(RESOURCE_ENERGY);if(e.creep.store.getUsedCapacity()>0){const r=Object.keys(e.creep.store)[0];return r===RESOURCE_ENERGY?5e4>t?{type:"transfer",target:e.terminal,resourceType:RESOURCE_ENERGY}:{type:"transfer",target:e.storage,resourceType:RESOURCE_ENERGY}:{type:"transfer",target:e.terminal,resourceType:r}}if(4e4>t&&r>2e4)return{type:"withdraw",target:e.storage,resourceType:RESOURCE_ENERGY};if(t>6e4)return{type:"withdraw",target:e.terminal,resourceType:RESOURCE_ENERGY};for(const t of Object.keys(e.storage.store))if(t!==RESOURCE_ENERGY&&e.storage.store.getUsedCapacity(t)>5e3)return{type:"withdraw",target:e.storage,resourceType:t};return e.creep.pos.getRangeTo(e.storage)>2?{type:"moveTo",target:e.storage}:{type:"idle"}}};function Pa(e){var t;return(null!==(t=Na[e.memory.role])&&void 0!==t?t:ka)(e)}function Ia(e,t){const r=e.effects;return void 0!==r&&Array.isArray(r)&&r.some(e=>e.effect===t)}function xa(e){const t=e.memory.targetRoom;if(!t)return{type:"idle"};if(e.room.name!==t)return{type:"moveToRoom",roomName:t};const r=st(e.room,FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_POWER_BANK,filterKey:"powerBank"})[0];if(!r)return delete e.memory.targetRoom,{type:"moveToRoom",roomName:e.homeRoom};if(e.creep.hits<.5*e.creep.hitsMax){const r=st(e.room,FIND_MY_CREEPS,{filter:e=>"healer"===e.memory.role&&e.memory.targetRoom===t,filterKey:"healer_"+t});if(r.length>0){const t=e.creep.pos.findClosestByRange(r);if(t&&e.creep.pos.getRangeTo(t)>1)return{type:"moveTo",target:t}}}return e.creep.attack(r)===ERR_NOT_IN_RANGE?{type:"moveTo",target:r}:{type:"idle"}}const $a={powerHarvester:xa,powerCarrier:function(e){const t=e.memory.targetRoom;if(e.creep.store.getUsedCapacity(RESOURCE_POWER)>0){if(e.room.name!==e.homeRoom)return{type:"moveToRoom",roomName:e.homeRoom};const t=Game.rooms[e.homeRoom];if(t){const r=at(t,STRUCTURE_POWER_SPAWN)[0];if(r&&r.store.getFreeCapacity(RESOURCE_POWER)>0)return{type:"transfer",target:r,resourceType:RESOURCE_POWER};if(e.storage)return{type:"transfer",target:e.storage,resourceType:RESOURCE_POWER}}return{type:"idle"}}if(!t)return{type:"idle"};if(e.room.name!==t)return{type:"moveToRoom",roomName:t};const r=lt(e.room,RESOURCE_POWER)[0];if(r)return{type:"pickup",target:r};const o=st(e.room,FIND_RUINS,{filter:e=>e.store.getUsedCapacity(RESOURCE_POWER)>0,filterKey:"powerRuin"})[0];if(o)return{type:"withdraw",target:o,resourceType:RESOURCE_POWER};const n=st(e.room,FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_POWER_BANK,filterKey:"powerBank"})[0];return n?e.creep.pos.getRangeTo(n)>3?{type:"moveTo",target:n}:{type:"idle"}:(delete e.memory.targetRoom,{type:"moveToRoom",roomName:e.homeRoom})}};function Ga(e){var t;return(null!==(t=$a[e.memory.role])&&void 0!==t?t:xa)(e)}const La=me("StateMachine");function Da(e,t){var r;const o=e.memory.state,n=function(e){if(!e)return{valid:!1,reason:"noState"};const t=Game.time-e.startTick;return t>e.timeout?{valid:!1,reason:"expired",meta:{age:t,timeout:e.timeout}}:e.targetId&&!Game.getObjectById(e.targetId)?{valid:!1,reason:"missingTarget",meta:{targetId:e.targetId}}:{valid:!0}}(o);if(o&&n.valid)if(function(e,t){if(!e)return!0;switch(e.action){case"harvest":case"harvestMineral":case"pickup":case"withdraw":return!!t.isFull||!(!e.targetId||Game.getObjectById(e.targetId));case"harvestDeposit":if(t.isFull)return!0;if(e.targetId){const t=Game.getObjectById(e.targetId);if(!t)return!0;if("object"==typeof t&&"cooldown"in t&&t.cooldown>100)return!0}return!1;case"transfer":case"build":return!!t.isEmpty||!(!e.targetId||Game.getObjectById(e.targetId));case"repair":if(t.isEmpty)return!0;if(e.targetId){const t=Game.getObjectById(e.targetId);if(!t)return!0;if("object"==typeof(r=t)&&null!==r&&"hits"in r&&"hitsMax"in r&&t.hits>=t.hitsMax)return!0}return!1;case"upgrade":return t.isEmpty;case"moveToRoom":return void 0!==e.targetRoom&&t.room.name===e.targetRoom;case"moveTo":if(e.targetId){const r=Game.getObjectById(e.targetId);if(r&&"object"==typeof r&&"pos"in r){const e=r;return t.creep.pos.inRangeTo(e.pos,1)}}if(e.targetPos){const r=new RoomPosition(e.targetPos.x,e.targetPos.y,e.targetPos.roomName);return t.creep.pos.inRangeTo(r,1)}return!1;case"idle":return!0;default:return!1}var r}(o,e))La.info("State completed, evaluating new action",{room:e.creep.pos.roomName,creep:e.creep.name,meta:{action:o.action,role:e.memory.role}}),delete e.memory.state;else{const t=function(e){var t,r;let o=null;if(e.targetId){const t=Game.getObjectById(e.targetId);if(!t)return null;if("object"!=typeof t||!("pos"in t)||!("room"in t))return null;o=t}switch(e.action){case"harvest":return o?{type:"harvest",target:o}:null;case"harvestMineral":return o?{type:"harvestMineral",target:o}:null;case"harvestDeposit":return o?{type:"harvestDeposit",target:o}:null;case"pickup":return o?{type:"pickup",target:o}:null;case"withdraw":return o&&(null===(t=e.data)||void 0===t?void 0:t.resourceType)?{type:"withdraw",target:o,resourceType:e.data.resourceType}:null;case"transfer":return o&&(null===(r=e.data)||void 0===r?void 0:r.resourceType)?{type:"transfer",target:o,resourceType:e.data.resourceType}:null;case"build":return o?{type:"build",target:o}:null;case"repair":return o?{type:"repair",target:o}:null;case"upgrade":return o?{type:"upgrade",target:o}:null;case"moveTo":return o?{type:"moveTo",target:o}:e.targetPos?{type:"moveTo",target:new RoomPosition(e.targetPos.x,e.targetPos.y,e.targetPos.roomName)}:null;case"moveToRoom":return e.targetRoom?{type:"moveToRoom",roomName:e.targetRoom}:null;case"idle":return{type:"idle"};default:return null}}(o);if(t)return t;La.info("State reconstruction failed, re-evaluating behavior",{room:e.creep.pos.roomName,creep:e.creep.name,meta:{action:o.action,role:e.memory.role}}),delete e.memory.state}else o&&(La.info("State invalid, re-evaluating behavior",{room:e.creep.pos.roomName,creep:e.creep.name,meta:{action:o.action,role:e.memory.role,invalidReason:n.reason,...n.meta}}),delete e.memory.state);const s=t(e);return s&&s.type?("idle"!==s.type?(e.memory.state=function(e){const t={action:e.type,startTick:Game.time,timeout:25};if("target"in e&&e.target&&"id"in e.target&&(t.targetId=e.target.id),"moveToRoom"===e.type&&(t.targetRoom=e.roomName),"moveTo"===e.type){const r="pos"in e.target?e.target.pos:e.target;t.targetPos={x:r.x,y:r.y,roomName:r.roomName}}return"withdraw"!==e.type&&"transfer"!==e.type||(t.data={resourceType:e.resourceType}),t}(s),La.info("Committed new state action",{room:e.creep.pos.roomName,creep:e.creep.name,meta:{action:s.type,role:e.memory.role,targetId:null===(r=e.memory.state)||void 0===r?void 0:r.targetId}})):La.info("Behavior returned idle action",{room:e.creep.pos.roomName,creep:e.creep.name,meta:{role:e.memory.role}}),s):(La.warn("Behavior returned invalid action, defaulting to idle",{room:e.creep.pos.roomName,creep:e.creep.name,meta:{role:e.memory.role}}),{type:"idle"})}function Fa(e){const t=function(e){var t;if(!e.room)return null;const r=e.room,o=null!==(t=e.memory.homeRoom)&&void 0!==t?t:r.name,n=at(r,STRUCTURE_LAB),s=at(r,STRUCTURE_SPAWN),i=at(r,STRUCTURE_EXTENSION),a=at(r,STRUCTURE_FACTORY)[0],c=at(r,STRUCTURE_POWER_SPAWN)[0],l=[];for(const t of Object.keys(e.powers)){const r=e.powers[t];r&&0===r.cooldown&&l.push(t)}return{powerCreep:e,room:r,homeRoom:o,isInHomeRoom:r.name===o,storage:r.storage,terminal:r.terminal,factory:a,labs:n,spawns:s,extensions:i,powerSpawn:c,availablePowers:l,ops:e.store.getUsedCapacity(RESOURCE_OPS)}}(e);t&&function(e,t){var r;switch(t.type){case"usePower":(t.target?e.usePower(t.power,t.target):e.usePower(t.power))===ERR_NOT_IN_RANGE&&t.target&&uo.moveTo(e,t.target);break;case"moveTo":uo.moveTo(e,t.target);break;case"moveToRoom":{const r=new RoomPosition(25,25,t.roomName);uo.moveTo(e,{pos:r,range:20},{maxRooms:16});break}case"renewSelf":e.renew(t.spawn)===ERR_NOT_IN_RANGE&&uo.moveTo(e,t.spawn);break;case"enableRoom":(null===(r=e.room)||void 0===r?void 0:r.controller)&&e.enableRoom(e.room.controller)===ERR_NOT_IN_RANGE&&uo.moveTo(e,e.room.controller)}}(e,function(e){return"powerWarrior"===e.powerCreep.memory.role?function(e){if(void 0!==e.powerCreep.ticksToLive&&1e3>e.powerCreep.ticksToLive&&e.powerSpawn)return{type:"renewSelf",spawn:e.powerSpawn};const t=e.availablePowers,r=Zr(e.room,FIND_HOSTILE_CREEPS),o=Zr(e.room,FIND_HOSTILE_STRUCTURES);if(e.room.controller&&!e.room.controller.isPowerEnabled)return{type:"enableRoom"};if(t.includes(PWR_GENERATE_OPS)&&20>e.ops)return{type:"usePower",power:PWR_GENERATE_OPS};if(t.includes(PWR_SHIELD)&&e.ops>=10&&r.length>0){const t=st(e.room,FIND_MY_CREEPS,{filter:e=>"military"===e.memory.family&&e.hits<.7*e.hitsMax,filterKey:"damagedMilitary"})[0];if(t)return{type:"usePower",power:PWR_SHIELD,target:t}}if(t.includes(PWR_DISRUPT_SPAWN)&&e.ops>=10){const t=Zr(e.room,FIND_HOSTILE_SPAWNS,{filter:e=>!Ia(e,PWR_DISRUPT_SPAWN)})[0];if(t)return{type:"usePower",power:PWR_DISRUPT_SPAWN,target:t}}if(t.includes(PWR_DISRUPT_TOWER)&&e.ops>=10){const t=Zr(e.room,FIND_HOSTILE_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_TOWER&&!Ia(e,PWR_DISRUPT_TOWER)})[0];if(t)return{type:"usePower",power:PWR_DISRUPT_TOWER,target:t}}if(t.includes(PWR_OPERATE_TOWER)&&e.ops>=10&&r.length>0){const t=st(e.room,FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_TOWER&&!Ia(e,PWR_OPERATE_TOWER),filterKey:"towerNoEffect"})[0];if(t)return{type:"usePower",power:PWR_OPERATE_TOWER,target:t}}if(t.includes(PWR_FORTIFY)&&e.ops>=5&&r.length>0){const t=[...e.spawns,e.storage,e.terminal].filter(e=>void 0!==e);for(const r of t){if(!r)continue;const t=e.room.lookForAt(LOOK_STRUCTURES,r.pos).find(e=>e.structureType===STRUCTURE_RAMPART);if(t&&t.hits<.5*t.hitsMax)return{type:"usePower",power:PWR_FORTIFY,target:t}}const r=st(e.room,FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_RAMPART&&5e5>e.hits,filterKey:"lowRampart"})[0];if(r)return{type:"usePower",power:PWR_FORTIFY,target:r}}if(t.includes(PWR_DISRUPT_TERMINAL)&&e.ops>=50){const e=o.find(e=>e.structureType===STRUCTURE_TERMINAL&&!Ia(e,PWR_DISRUPT_TERMINAL));if(e)return{type:"usePower",power:PWR_DISRUPT_TERMINAL,target:e}}if(t.includes(PWR_GENERATE_OPS)&&100>e.ops)return{type:"usePower",power:PWR_GENERATE_OPS};if(!e.isInHomeRoom)return{type:"moveToRoom",roomName:e.homeRoom};if(r.length>0){const t=e.powerCreep.pos.findClosestByRange(r);if(t&&e.powerCreep.pos.getRangeTo(t)>5)return{type:"moveTo",target:t}}return{type:"idle"}}(e):function(e){if(void 0!==e.powerCreep.ticksToLive&&1e3>e.powerCreep.ticksToLive&&e.powerSpawn)return{type:"renewSelf",spawn:e.powerSpawn};const t=e.availablePowers;if(e.room.controller&&!e.room.controller.isPowerEnabled)return{type:"enableRoom"};if(t.includes(PWR_GENERATE_OPS)&&20>e.ops)return{type:"usePower",power:PWR_GENERATE_OPS};if(t.includes(PWR_OPERATE_SPAWN)&&e.ops>=100){const t=e.spawns.find(e=>{const t=e;return null!==t.spawning&&!Ia(t,PWR_OPERATE_SPAWN)});if(t)return{type:"usePower",power:PWR_OPERATE_SPAWN,target:t}}if(t.includes(PWR_OPERATE_EXTENSION)&&e.ops>=2&&e.extensions.reduce((e,t)=>e+t.store.getFreeCapacity(RESOURCE_ENERGY),0)>1e3&&e.storage&&e.storage.store.getUsedCapacity(RESOURCE_ENERGY)>1e4&&!Ia(e.storage,PWR_OPERATE_EXTENSION))return{type:"usePower",power:PWR_OPERATE_EXTENSION,target:e.storage};if(t.includes(PWR_OPERATE_TOWER)&&e.ops>=10&&st(e.room,FIND_HOSTILE_CREEPS).length>0){const t=st(e.room,FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_TOWER&&!Ia(e,PWR_OPERATE_TOWER),filterKey:"towerNoEffect"});if(t.length>0)return{type:"usePower",power:PWR_OPERATE_TOWER,target:t[0]}}if(t.includes(PWR_OPERATE_LAB)&&e.ops>=10){const t=e.labs.find(e=>0===e.cooldown&&e.mineralType&&!Ia(e,PWR_OPERATE_LAB));if(t)return{type:"usePower",power:PWR_OPERATE_LAB,target:t}}if(t.includes(PWR_OPERATE_FACTORY)&&e.ops>=100&&e.factory&&0===e.factory.cooldown&&!Ia(e.factory,PWR_OPERATE_FACTORY))return{type:"usePower",power:PWR_OPERATE_FACTORY,target:e.factory};if(t.includes(PWR_OPERATE_STORAGE)&&e.ops>=100&&e.storage&&e.storage.store.getUsedCapacity()>.85*e.storage.store.getCapacity()&&!Ia(e.storage,PWR_OPERATE_STORAGE))return{type:"usePower",power:PWR_OPERATE_STORAGE,target:e.storage};if(t.includes(PWR_REGEN_SOURCE)&&e.ops>=100){const t=st(e.room,FIND_SOURCES,{filter:e=>0===e.energy&&e.ticksToRegeneration>100,filterKey:"depletedSource"})[0];if(t)return{type:"usePower",power:PWR_REGEN_SOURCE,target:t}}return t.includes(PWR_GENERATE_OPS)&&100>e.ops?{type:"usePower",power:PWR_GENERATE_OPS}:e.isInHomeRoom?e.storage&&e.powerCreep.pos.getRangeTo(e.storage)>3?{type:"moveTo",target:e.storage}:{type:"idle"}:{type:"moveToRoom",roomName:e.homeRoom}}(e)}(t))}const Ba={harvester:Be.CRITICAL,queenCarrier:Be.CRITICAL,hauler:Be.HIGH,guard:Be.HIGH,healer:Be.HIGH,soldier:Be.HIGH,ranger:Be.HIGH,siegeUnit:Be.HIGH,harasser:Be.HIGH,powerQueen:Be.HIGH,powerWarrior:Be.HIGH,larvaWorker:Be.HIGH,builder:Be.MEDIUM,upgrader:Be.MEDIUM,interRoomCarrier:Be.MEDIUM,scout:Be.MEDIUM,claimer:Be.MEDIUM,engineer:Be.MEDIUM,remoteHarvester:Be.MEDIUM,powerHarvester:Be.MEDIUM,powerCarrier:Be.MEDIUM,remoteHauler:Be.LOW,remoteWorker:Be.LOW,linkManager:Be.LOW,terminalManager:Be.LOW,mineralHarvester:Be.LOW,labTech:Be.IDLE,factoryWorker:Be.IDLE};function Ha(e){var t;return null!==(t=Ba[e])&&void 0!==t?t:Be.MEDIUM}const Wa=new class{constructor(){this.registeredCreeps=new Set,this.lastSyncTick=-1}syncCreepProcesses(){if(this.lastSyncTick===Game.time)return;this.lastSyncTick=Game.time;const e=new Set;let t=0,r=0,o=0;const n=Object.keys(Game.creeps).length;for(const r in Game.creeps){const n=Game.creeps[r];n.spawning?o++:(e.add(r),this.registeredCreeps.has(r)||(this.registerCreepProcess(n),t++))}for(const t of this.registeredCreeps)e.has(t)||(this.unregisterCreepProcess(t),r++);const s=5>n;(t>0||r>0||Game.time%10==0||s)&&de.info(`CreepProcessManager: ${e.size} active, ${o} spawning, ${n} total (registered: ${t}, unregistered: ${r})`,{subsystem:"CreepProcessManager",meta:{activeCreeps:e.size,spawningCreeps:o,totalCreeps:n,registeredThisTick:t,unregisteredThisTick:r}})}registerCreepProcess(e){const t=e.memory.role,r=Ha(t),o="creep:"+e.name;qe.registerProcess({id:o,name:`Creep ${e.name} (${t})`,priority:r,frequency:"high",interval:1,minBucket:this.getMinBucketForPriority(r),cpuBudget:this.getCpuBudgetForPriority(r),execute:()=>{const t=Game.creeps[e.name];t&&!t.spawning&&function(e){const t=e.memory;if(e.spawning)return;if("military"!==t.family&&void 0!==e.ticksToLive&&50>e.ticksToLive&&0===e.store.getUsedCapacity())return;const r=Game.rooms[t.homeRoom],o=r&&function(e){return 5>Object.values(Game.creeps).filter(t=>t.memory.homeRoom===e.name).length}(r);if((Game.time%10==0||o)&&de.info(`Executing role for creep ${e.name} (${t.role})`,{subsystem:"CreepProcessManager",creep:e.name}),function(e){const t=e.memory;if(!Xr.has(t.role))return!1;const r=t.state;if(!r||!r.startTick)return!1;if(3>Game.time-r.startTick)return!1;switch(t.role){case"harvester":return function(e,t){if("harvest"!==t.action&&"transfer"!==t.action)return!1;if(!t.targetId)return!1;const r=Game.getObjectById(t.targetId);if(!r||!zr(r))return!1;if(!e.pos.isNearTo(r.pos))return!1;if("harvest"===t.action){const t=e.store.getCapacity();if(null!==t&&t>0&&0===e.store.getFreeCapacity())return!1}return"transfer"!==t.action||e.store.getUsedCapacity(RESOURCE_ENERGY)>=40}(e,r);case"upgrader":return function(e,t){if("upgrade"!==t.action&&"withdraw"!==t.action)return!1;if(!t.targetId)return!1;const r=Game.getObjectById(t.targetId);return!(!r||!zr(r)||!e.pos.inRangeTo(r.pos,3)||"upgrade"===t.action&&0===e.store.getUsedCapacity(RESOURCE_ENERGY)||"withdraw"===t.action&&0===e.store.getFreeCapacity(RESOURCE_ENERGY))}(e,r);case"mineralHarvester":return function(e,t){if("harvestMineral"!==t.action)return!1;if(!t.targetId)return!1;const r=Game.getObjectById(t.targetId);return!(!r||!zr(r)||!e.pos.isNearTo(r.pos)||0===e.store.getFreeCapacity())}(e,r);case"builder":return function(e,t){if("build"!==t.action)return!1;if(!t.targetId)return!1;const r=Game.getObjectById(t.targetId);return!(!r||!zr(r)||!e.pos.inRangeTo(r.pos,3)||0===e.store.getUsedCapacity(RESOURCE_ENERGY))}(e,r);case"depositHarvester":case"factoryWorker":case"labTech":return!0;default:return!1}}(e)){const r=function(e){const t=e.memory.state;if(!t||!t.targetId)return!1;const r=Game.getObjectById(t.targetId);if(!r||!zr(r))return!1;switch(t.action){case"harvest":return"energy"in r&&"energyCapacity"in r&&"ticksToRegeneration"in r&&e.harvest(r)===OK;case"harvestMineral":return"mineralType"in r&&"mineralAmount"in r&&"ticksToRegeneration"in r&&e.harvest(r)===OK;case"transfer":return!(!("store"in r)||!r.store||"object"!=typeof r.store)&&e.transfer(r,RESOURCE_ENERGY)===OK;case"withdraw":return!(!("store"in r)||!r.store||"object"!=typeof r.store)&&e.withdraw(r,RESOURCE_ENERGY)===OK;case"upgrade":return"level"in r&&"progress"in r&&"my"in r&&e.upgradeController(r)===OK;case"build":return"progressTotal"in r&&"progress"in r&&e.build(r)===OK;case"repair":return"hits"in r&&"hitsMax"in r&&e.repair(r)===OK;default:return!1}}(e);if(r)return;delete t.state}const n=function(e){var t;return null!==(t=e.memory.family)&&void 0!==t?t:"economy"}(e),s=t.role;try{Ye.unifiedStats.measureSubsystem("role:"+s,()=>{switch(n){case"economy":default:!function(e){const t=ao(e);Ji(e,Da(t,da),t)}(e);break;case"military":!function(e){const t=ao(e);Ji(e,Da(t,Ma),t)}(e);break;case"utility":!function(e){const t=ao(e);Ji(e,Da(t,Pa),t)}(e);break;case"power":!function(e){const t=ao(e);Ji(e,Da(t,Ga),t)}(e)}})}catch(t){de.error(`EXCEPTION in role execution for ${e.name} (${s}/${n}): ${t}`,{subsystem:"CreepProcessManager",creep:e.name,meta:{error:t+"",stack:t instanceof Error?t.stack:void 0,role:s,family:n,pos:`${e.pos.x},${e.pos.y} in ${e.room.name}`}})}}(t)}}),this.registeredCreeps.add(e.name),de.info(`Registered creep process: ${e.name} (${t}) with priority ${r}`,{subsystem:"CreepProcessManager"})}unregisterCreepProcess(e){const t="creep:"+e;qe.unregisterProcess(t),this.registeredCreeps.delete(e),de.info("Unregistered creep process: "+e,{subsystem:"CreepProcessManager"})}getMinBucketForPriority(e){return 0}getCpuBudgetForPriority(e){return e<Be.CRITICAL?e<Be.HIGH?e<Be.MEDIUM?.006:.008:.01:.012}getStats(){var e,t;const r={};for(const o of this.registeredCreeps){const n=Game.creeps[o];if(n){const o=Ha(n.memory.role),s=null!==(e=Be[o])&&void 0!==e?e:"UNKNOWN";r[s]=(null!==(t=r[s])&&void 0!==t?t:0)+1}}return{totalCreeps:Object.keys(Game.creeps).length,registeredCreeps:this.registeredCreeps.size,creepsByPriority:r}}forceResync(){this.lastSyncTick=-1,this.syncCreepProcesses()}reset(){this.registeredCreeps.clear(),this.lastSyncTick=-1}},Ya={seedNest:{rcl:1},foragingExpansion:{rcl:3,minRooms:1,minRemoteRooms:1,minTowerCount:1},matureColony:{rcl:4,requiresStorage:!0,requiresTerminal:!0,requiresLabs:!0,minLabCount:3,minTowerCount:2},fortifiedHive:{rcl:7,requiresTerminal:!0,requiresLabs:!0,minLabCount:6,requiresFactory:!0,requiresPowerSpawn:!0,minTowerCount:4},empireDominance:{rcl:8,requiresNuker:!0,requiresObserver:!0,requiresTerminal:!0,requiresLabs:!0,minLabCount:8,requiresFactory:!0,requiresPowerSpawn:!0,minGcl:10,minRooms:3,minRemoteRooms:2,minTowerCount:6}},Ka={eco:{economy:.75,military:.05,utility:.15,power:.05},expand:{economy:.55,military:.15,utility:.25,power:.05},defensive:{economy:.45,military:.35,utility:.15,power:.05},war:{economy:.3,military:.5,utility:.1,power:.1},siege:{economy:.2,military:.6,utility:.1,power:.1},evacuate:{economy:.1,military:.1,utility:.8,power:0},nukePrep:{economy:.4,military:.3,utility:.2,power:.1}},ja={eco:{upgrade:80,build:60,repair:40,spawn:70,terminal:50,labs:30},expand:{upgrade:60,build:80,repair:50,spawn:75,terminal:60,labs:40},defensive:{upgrade:30,build:50,repair:80,spawn:90,terminal:40,labs:60},war:{upgrade:10,build:30,repair:70,spawn:95,terminal:70,labs:80},siege:{upgrade:5,build:20,repair:90,spawn:100,terminal:50,labs:90},evacuate:{upgrade:0,build:5,repair:10,spawn:50,terminal:80,labs:10},nukePrep:{upgrade:20,build:40,repair:95,spawn:80,terminal:30,labs:70}},Va=new class{constructor(){this.STRUCTURE_CACHE_NAMESPACE="evolution:structures",this.structureCacheTtl=20}determineEvolutionStage(e,t,r){var o,n,s,i;const a=null!==(n=null===(o=t.controller)||void 0===o?void 0:o.level)&&void 0!==n?n:0,c=Game.gcl.level,l=this.getStructureCounts(t),u=null!==(i=null===(s=e.remoteAssignments)||void 0===s?void 0:s.length)&&void 0!==i?i:0;return this.meetsThreshold("empireDominance",a,r,c,l,u)?"empireDominance":this.meetsThreshold("fortifiedHive",a,r,c,l,u)?"fortifiedHive":this.meetsThreshold("matureColony",a,r,c,l,u)?"matureColony":this.meetsThreshold("foragingExpansion",a,r,c,l,u)?"foragingExpansion":"seedNest"}meetsThreshold(e,t,r,o,n,s){var i,a;const c=Ya[e],l=null!==(i=n[STRUCTURE_TOWER])&&void 0!==i?i:0,u=null!==(a=n[STRUCTURE_LAB])&&void 0!==a?a:0;return!(t<c.rcl||c.minRooms&&r<c.minRooms||c.minGcl&&o<c.minGcl||c.minRemoteRooms&&s<c.minRemoteRooms||c.minTowerCount&&l<c.minTowerCount||c.requiresStorage&&!n[STRUCTURE_STORAGE]||c.requiresTerminal&&t>=6&&!n[STRUCTURE_TERMINAL]||c.requiresLabs&&0===u||c.minLabCount&&t>=6&&u<c.minLabCount||c.requiresFactory&&t>=7&&!n[STRUCTURE_FACTORY]||c.requiresPowerSpawn&&t>=7&&!n[STRUCTURE_POWER_SPAWN]||c.requiresObserver&&t>=8&&!n[STRUCTURE_OBSERVER]||c.requiresNuker&&t>=8&&!n[STRUCTURE_NUKER])}getStructureCounts(e){var t;const r=Ze.get(e.name,{namespace:this.STRUCTURE_CACHE_NAMESPACE,ttl:this.structureCacheTtl});if(r)return r;const o={},n=e.find(FIND_MY_STRUCTURES);for(const e of n){const r=e.structureType;o[r]=(null!==(t=o[r])&&void 0!==t?t:0)+1}return Ze.set(e.name,o,{namespace:this.STRUCTURE_CACHE_NAMESPACE,ttl:this.structureCacheTtl}),o}updateEvolutionStage(e,t,r){const o=this.determineEvolutionStage(e,t,r);return o!==e.colonyLevel&&(de.info(`Room evolution: ${e.colonyLevel} -> ${o}`,{room:t.name,subsystem:"Evolution"}),e.colonyLevel=o,!0)}updateMissingStructures(e,t){var r,o,n,s,i,a,c,l,u,m,d,p;const g=this.getStructureCounts(t),f=null!==(o=null===(r=t.controller)||void 0===r?void 0:r.level)&&void 0!==o?o:0,h=Ya[e.colonyLevel],y=h.requiresLabs&&f>=6,R=y?null!==(n=h.minLabCount)&&void 0!==n?n:3:0,E=h.requiresFactory&&f>=7,T=h.requiresTerminal&&f>=6,C=h.requiresStorage&&f>=4,v=h.requiresPowerSpawn&&f>=7,S=h.requiresObserver&&f>=8,_=h.requiresNuker&&f>=8;e.missingStructures={spawn:0===(null!==(s=g[STRUCTURE_SPAWN])&&void 0!==s?s:0),storage:!!C&&0===(null!==(i=g[STRUCTURE_STORAGE])&&void 0!==i?i:0),terminal:!!T&&0===(null!==(a=g[STRUCTURE_TERMINAL])&&void 0!==a?a:0),labs:!!y&&(null!==(c=g[STRUCTURE_LAB])&&void 0!==c?c:0)<R,nuker:!!_&&0===(null!==(l=g[STRUCTURE_NUKER])&&void 0!==l?l:0),factory:!!E&&0===(null!==(u=g[STRUCTURE_FACTORY])&&void 0!==u?u:0),extractor:f>=6&&0===(null!==(m=g[STRUCTURE_EXTRACTOR])&&void 0!==m?m:0),powerSpawn:!!v&&0===(null!==(d=g[STRUCTURE_POWER_SPAWN])&&void 0!==d?d:0),observer:!!S&&0===(null!==(p=g[STRUCTURE_OBSERVER])&&void 0!==p?p:0)}}},qa=new class{determinePosture(e,t){if(t)return t;const{pheromones:r,danger:o}=e;return 3>o?2>o?r.siege>30?"siege":r.war>25?"war":r.defense>20?"defensive":r.nukeTarget>40?"nukePrep":r.expand>30&&0===o?"expand":1>o?"eco":"defensive":"war":"siege"}updatePosture(e,t,r){const o=this.determinePosture(e,t);if(o!==e.posture){const t=e.posture,n=null!=r?r:e.role;return de.info(`Posture change: ${t} -> ${o}`,{room:n,subsystem:"Posture"}),e.posture=o,qe.emit("posture.change",{roomName:n,oldPosture:t,newPosture:o,source:"PostureManager"}),!0}return!1}getSpawnProfile(e){return Ka[e]}getResourcePriorities(e){return ja[e]}allowsBuilding(e){return"evacuate"!==e&&"siege"!==e}allowsUpgrading(e){return"evacuate"!==e&&"siege"!==e&&"war"!==e}isCombatPosture(e){return"defensive"===e||"war"===e||"siege"===e}allowsExpansion(e){return"eco"===e||"expand"===e}};function za(e){var t;const r={1:{spawn:1,extension:0,road:2500,constructedWall:0},2:{spawn:1,extension:5,road:2500,constructedWall:2500,rampart:2500,container:5},3:{spawn:1,extension:10,road:2500,constructedWall:2500,rampart:2500,container:5,tower:1},4:{spawn:1,extension:20,road:2500,constructedWall:2500,rampart:2500,container:5,tower:1,storage:1},5:{spawn:1,extension:30,road:2500,constructedWall:2500,rampart:2500,container:5,tower:2,storage:1,link:2},6:{spawn:1,extension:40,road:2500,constructedWall:2500,rampart:2500,container:5,tower:2,storage:1,link:3,terminal:1,extractor:1,lab:3},7:{spawn:2,extension:50,road:2500,constructedWall:2500,rampart:2500,container:5,tower:3,storage:1,link:4,terminal:1,extractor:1,lab:6,factory:1},8:{spawn:3,extension:60,road:2500,constructedWall:2500,rampart:2500,container:5,tower:6,storage:1,link:6,terminal:1,extractor:1,lab:10,factory:1,nuker:1,observer:1,powerSpawn:1}};return null!==(t=r[e])&&void 0!==t?t:r[1]}const Xa={name:"seedNest",rcl:1,type:"spread",minSpaceRadius:3,anchor:{x:25,y:25},structures:[{x:0,y:0,structureType:STRUCTURE_SPAWN},{x:-2,y:0,structureType:STRUCTURE_EXTENSION},{x:2,y:0,structureType:STRUCTURE_EXTENSION},{x:0,y:-2,structureType:STRUCTURE_EXTENSION},{x:0,y:2,structureType:STRUCTURE_EXTENSION},{x:-2,y:-2,structureType:STRUCTURE_EXTENSION}],roads:[{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-1,y:0},{x:1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1}],ramparts:[]},Qa={name:"foragingExpansion",rcl:3,type:"spread",minSpaceRadius:4,anchor:{x:25,y:25},structures:[{x:0,y:0,structureType:STRUCTURE_SPAWN},{x:0,y:-4,structureType:STRUCTURE_TOWER},{x:4,y:4,structureType:STRUCTURE_STORAGE},{x:-2,y:0,structureType:STRUCTURE_EXTENSION},{x:2,y:0,structureType:STRUCTURE_EXTENSION},{x:0,y:-2,structureType:STRUCTURE_EXTENSION},{x:0,y:2,structureType:STRUCTURE_EXTENSION},{x:-2,y:-2,structureType:STRUCTURE_EXTENSION},{x:2,y:-2,structureType:STRUCTURE_EXTENSION},{x:-2,y:2,structureType:STRUCTURE_EXTENSION},{x:2,y:2,structureType:STRUCTURE_EXTENSION},{x:-4,y:0,structureType:STRUCTURE_EXTENSION},{x:4,y:0,structureType:STRUCTURE_EXTENSION},{x:0,y:4,structureType:STRUCTURE_EXTENSION},{x:-1,y:-3,structureType:STRUCTURE_EXTENSION},{x:1,y:-3,structureType:STRUCTURE_EXTENSION},{x:-3,y:-1,structureType:STRUCTURE_EXTENSION},{x:3,y:-1,structureType:STRUCTURE_EXTENSION},{x:-3,y:1,structureType:STRUCTURE_EXTENSION},{x:3,y:1,structureType:STRUCTURE_EXTENSION},{x:-1,y:3,structureType:STRUCTURE_EXTENSION},{x:1,y:3,structureType:STRUCTURE_EXTENSION},{x:-3,y:-3,structureType:STRUCTURE_EXTENSION}],roads:[{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-1,y:0},{x:1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:-2,y:-1},{x:2,y:-1},{x:-2,y:1},{x:2,y:1},{x:-1,y:-2},{x:1,y:-2},{x:-1,y:2},{x:1,y:2},{x:0,y:-3},{x:0,y:3},{x:-3,y:0},{x:3,y:0},{x:3,y:3},{x:4,y:3},{x:3,y:4}],ramparts:[]},Za={name:"matureColony",rcl:5,type:"spread",minSpaceRadius:6,anchor:{x:25,y:25},structures:[{x:0,y:0,structureType:STRUCTURE_SPAWN},{x:4,y:0,structureType:STRUCTURE_SPAWN},{x:0,y:4,structureType:STRUCTURE_STORAGE},{x:2,y:4,structureType:STRUCTURE_TERMINAL},{x:0,y:-4,structureType:STRUCTURE_TOWER},{x:-4,y:0,structureType:STRUCTURE_TOWER},{x:4,y:-4,structureType:STRUCTURE_TOWER},{x:-2,y:0,structureType:STRUCTURE_EXTENSION},{x:2,y:0,structureType:STRUCTURE_EXTENSION},{x:0,y:-2,structureType:STRUCTURE_EXTENSION},{x:0,y:2,structureType:STRUCTURE_EXTENSION},{x:-2,y:-2,structureType:STRUCTURE_EXTENSION},{x:2,y:-2,structureType:STRUCTURE_EXTENSION},{x:-2,y:2,structureType:STRUCTURE_EXTENSION},{x:2,y:2,structureType:STRUCTURE_EXTENSION},{x:-1,y:-3,structureType:STRUCTURE_EXTENSION},{x:1,y:-3,structureType:STRUCTURE_EXTENSION},{x:-3,y:-1,structureType:STRUCTURE_EXTENSION},{x:3,y:-1,structureType:STRUCTURE_EXTENSION},{x:-3,y:1,structureType:STRUCTURE_EXTENSION},{x:3,y:1,structureType:STRUCTURE_EXTENSION},{x:-1,y:3,structureType:STRUCTURE_EXTENSION},{x:1,y:3,structureType:STRUCTURE_EXTENSION},{x:-4,y:-2,structureType:STRUCTURE_EXTENSION},{x:-4,y:2,structureType:STRUCTURE_EXTENSION},{x:-2,y:-4,structureType:STRUCTURE_EXTENSION},{x:2,y:-4,structureType:STRUCTURE_EXTENSION},{x:-3,y:-3,structureType:STRUCTURE_EXTENSION},{x:3,y:-3,structureType:STRUCTURE_EXTENSION},{x:-3,y:3,structureType:STRUCTURE_EXTENSION},{x:-6,y:0,structureType:STRUCTURE_EXTENSION},{x:-6,y:-2,structureType:STRUCTURE_EXTENSION},{x:6,y:-2,structureType:STRUCTURE_EXTENSION},{x:6,y:2,structureType:STRUCTURE_EXTENSION},{x:-4,y:-4,structureType:STRUCTURE_EXTENSION},{x:4,y:2,structureType:STRUCTURE_EXTENSION},{x:6,y:0,structureType:STRUCTURE_EXTENSION},{x:-3,y:5,structureType:STRUCTURE_LAB},{x:-4,y:4,structureType:STRUCTURE_LAB},{x:-5,y:5,structureType:STRUCTURE_LAB},{x:-2,y:4,structureType:STRUCTURE_LINK}],roads:[{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-1,y:0},{x:1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:3,y:-1},{x:3,y:0},{x:3,y:1},{x:4,y:-1},{x:4,y:1},{x:5,y:-1},{x:5,y:0},{x:5,y:1},{x:-2,y:-1},{x:2,y:-1},{x:-2,y:1},{x:2,y:1},{x:-1,y:-2},{x:1,y:-2},{x:-1,y:2},{x:1,y:2},{x:0,y:-3},{x:0,y:3},{x:-3,y:0},{x:3,y:0}],ramparts:[{x:0,y:0},{x:4,y:0},{x:0,y:4},{x:1,y:4}]},Ja={name:"fortifiedHive",rcl:7,type:"spread",minSpaceRadius:7,anchor:{x:25,y:25},structures:[{x:0,y:0,structureType:STRUCTURE_SPAWN},{x:-5,y:-1,structureType:STRUCTURE_SPAWN},{x:5,y:-1,structureType:STRUCTURE_SPAWN},{x:0,y:4,structureType:STRUCTURE_STORAGE},{x:2,y:4,structureType:STRUCTURE_TERMINAL},{x:0,y:-4,structureType:STRUCTURE_TOWER},{x:-4,y:-2,structureType:STRUCTURE_TOWER},{x:4,y:-2,structureType:STRUCTURE_TOWER},{x:-4,y:2,structureType:STRUCTURE_TOWER},{x:4,y:2,structureType:STRUCTURE_TOWER},{x:0,y:6,structureType:STRUCTURE_TOWER},{x:-2,y:4,structureType:STRUCTURE_FACTORY},{x:-4,y:4,structureType:STRUCTURE_LAB},{x:-3,y:5,structureType:STRUCTURE_LAB},{x:-4,y:6,structureType:STRUCTURE_LAB},{x:-5,y:5,structureType:STRUCTURE_LAB},{x:-6,y:4,structureType:STRUCTURE_LAB},{x:-6,y:6,structureType:STRUCTURE_LAB},{x:-2,y:6,structureType:STRUCTURE_LAB},{x:-5,y:3,structureType:STRUCTURE_LAB},{x:-7,y:5,structureType:STRUCTURE_LAB},{x:-3,y:7,structureType:STRUCTURE_LAB},{x:4,y:4,structureType:STRUCTURE_NUKER},{x:6,y:0,structureType:STRUCTURE_OBSERVER},{x:-1,y:5,structureType:STRUCTURE_POWER_SPAWN},{x:1,y:5,structureType:STRUCTURE_LINK},{x:5,y:-3,structureType:STRUCTURE_LINK},{x:-5,y:-3,structureType:STRUCTURE_LINK},{x:-2,y:0,structureType:STRUCTURE_EXTENSION},{x:2,y:0,structureType:STRUCTURE_EXTENSION},{x:0,y:-2,structureType:STRUCTURE_EXTENSION},{x:0,y:2,structureType:STRUCTURE_EXTENSION},{x:-2,y:-2,structureType:STRUCTURE_EXTENSION},{x:2,y:-2,structureType:STRUCTURE_EXTENSION},{x:-2,y:2,structureType:STRUCTURE_EXTENSION},{x:2,y:2,structureType:STRUCTURE_EXTENSION},{x:-3,y:-1,structureType:STRUCTURE_EXTENSION},{x:3,y:-1,structureType:STRUCTURE_EXTENSION}],roads:[{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-1,y:0},{x:1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:-6,y:-2},{x:-5,y:-2},{x:-4,y:-2},{x:-6,y:-1},{x:-4,y:-1},{x:-6,y:0},{x:-5,y:0},{x:-4,y:0},{x:4,y:-2},{x:5,y:-2},{x:6,y:-2},{x:4,y:-1},{x:6,y:-1},{x:4,y:0},{x:5,y:0},{x:6,y:0},{x:-3,y:0},{x:3,y:0},{x:0,y:-3},{x:0,y:3},{x:-2,y:-1},{x:2,y:-1},{x:-2,y:1},{x:2,y:1},{x:-1,y:-2},{x:1,y:-2},{x:-1,y:2},{x:1,y:2}],ramparts:[{x:0,y:0},{x:-5,y:-1},{x:5,y:-1},{x:0,y:4},{x:2,y:4},{x:0,y:-4},{x:-4,y:-2},{x:4,y:-2},{x:-4,y:2},{x:4,y:2},{x:0,y:6},{x:4,y:4},{x:-1,y:5}]},ec={name:"compactBunker",rcl:8,type:"bunker",minSpaceRadius:6,anchor:{x:25,y:25},structures:[{x:0,y:0,structureType:STRUCTURE_STORAGE},{x:-1,y:1,structureType:STRUCTURE_TERMINAL},{x:1,y:1,structureType:STRUCTURE_FACTORY},{x:0,y:-2,structureType:STRUCTURE_SPAWN},{x:-2,y:1,structureType:STRUCTURE_SPAWN},{x:2,y:1,structureType:STRUCTURE_SPAWN},{x:0,y:2,structureType:STRUCTURE_POWER_SPAWN},{x:-2,y:-1,structureType:STRUCTURE_NUKER},{x:-3,y:-2,structureType:STRUCTURE_TOWER},{x:3,y:-2,structureType:STRUCTURE_TOWER},{x:-4,y:0,structureType:STRUCTURE_TOWER},{x:4,y:0,structureType:STRUCTURE_TOWER},{x:-3,y:3,structureType:STRUCTURE_TOWER},{x:3,y:3,structureType:STRUCTURE_TOWER},{x:-2,y:3,structureType:STRUCTURE_LAB},{x:-1,y:3,structureType:STRUCTURE_LAB},{x:-3,y:4,structureType:STRUCTURE_LAB},{x:-2,y:4,structureType:STRUCTURE_LAB},{x:-1,y:4,structureType:STRUCTURE_LAB},{x:0,y:3,structureType:STRUCTURE_LAB},{x:0,y:4,structureType:STRUCTURE_LAB},{x:1,y:3,structureType:STRUCTURE_LAB},{x:1,y:4,structureType:STRUCTURE_LAB},{x:2,y:3,structureType:STRUCTURE_LAB},{x:2,y:-1,structureType:STRUCTURE_OBSERVER},{x:-1,y:-1,structureType:STRUCTURE_LINK},{x:1,y:-1,structureType:STRUCTURE_LINK},{x:-3,y:1,structureType:STRUCTURE_LINK},{x:3,y:1,structureType:STRUCTURE_LINK},{x:-1,y:-3,structureType:STRUCTURE_LINK},{x:1,y:-3,structureType:STRUCTURE_LINK},{x:-2,y:-2,structureType:STRUCTURE_EXTENSION},{x:0,y:-4,structureType:STRUCTURE_EXTENSION},{x:2,y:-2,structureType:STRUCTURE_EXTENSION},{x:-4,y:-2,structureType:STRUCTURE_EXTENSION},{x:4,y:-2,structureType:STRUCTURE_EXTENSION},{x:-4,y:2,structureType:STRUCTURE_EXTENSION},{x:4,y:2,structureType:STRUCTURE_EXTENSION},{x:-4,y:-4,structureType:STRUCTURE_EXTENSION},{x:-2,y:-4,structureType:STRUCTURE_EXTENSION},{x:2,y:-4,structureType:STRUCTURE_EXTENSION},{x:4,y:-4,structureType:STRUCTURE_EXTENSION},{x:-6,y:-2,structureType:STRUCTURE_EXTENSION},{x:6,y:-2,structureType:STRUCTURE_EXTENSION},{x:-6,y:0,structureType:STRUCTURE_EXTENSION},{x:6,y:0,structureType:STRUCTURE_EXTENSION},{x:-6,y:2,structureType:STRUCTURE_EXTENSION},{x:6,y:2,structureType:STRUCTURE_EXTENSION},{x:-4,y:4,structureType:STRUCTURE_EXTENSION},{x:4,y:4,structureType:STRUCTURE_EXTENSION},{x:-2,y:6,structureType:STRUCTURE_EXTENSION},{x:0,y:6,structureType:STRUCTURE_EXTENSION},{x:2,y:6,structureType:STRUCTURE_EXTENSION},{x:-6,y:-4,structureType:STRUCTURE_EXTENSION},{x:-4,y:-6,structureType:STRUCTURE_EXTENSION},{x:-2,y:-6,structureType:STRUCTURE_EXTENSION},{x:0,y:-6,structureType:STRUCTURE_EXTENSION},{x:2,y:-6,structureType:STRUCTURE_EXTENSION},{x:4,y:-6,structureType:STRUCTURE_EXTENSION},{x:6,y:-4,structureType:STRUCTURE_EXTENSION},{x:-6,y:4,structureType:STRUCTURE_EXTENSION},{x:6,y:4,structureType:STRUCTURE_EXTENSION},{x:-6,y:6,structureType:STRUCTURE_EXTENSION},{x:-4,y:6,structureType:STRUCTURE_EXTENSION},{x:4,y:6,structureType:STRUCTURE_EXTENSION},{x:6,y:6,structureType:STRUCTURE_EXTENSION},{x:-5,y:-5,structureType:STRUCTURE_EXTENSION},{x:-3,y:-5,structureType:STRUCTURE_EXTENSION},{x:-1,y:-5,structureType:STRUCTURE_EXTENSION},{x:1,y:-5,structureType:STRUCTURE_EXTENSION},{x:3,y:-5,structureType:STRUCTURE_EXTENSION},{x:5,y:-5,structureType:STRUCTURE_EXTENSION},{x:-5,y:-3,structureType:STRUCTURE_EXTENSION},{x:5,y:-3,structureType:STRUCTURE_EXTENSION},{x:-5,y:-1,structureType:STRUCTURE_EXTENSION},{x:5,y:-1,structureType:STRUCTURE_EXTENSION},{x:-5,y:1,structureType:STRUCTURE_EXTENSION},{x:5,y:1,structureType:STRUCTURE_EXTENSION},{x:-5,y:3,structureType:STRUCTURE_EXTENSION},{x:5,y:3,structureType:STRUCTURE_EXTENSION},{x:-5,y:5,structureType:STRUCTURE_EXTENSION},{x:-3,y:5,structureType:STRUCTURE_EXTENSION},{x:-1,y:5,structureType:STRUCTURE_EXTENSION},{x:1,y:5,structureType:STRUCTURE_EXTENSION},{x:3,y:5,structureType:STRUCTURE_EXTENSION},{x:5,y:5,structureType:STRUCTURE_EXTENSION}],roads:[{x:-1,y:0},{x:1,y:0},{x:0,y:-1},{x:0,y:1},{x:-1,y:-2},{x:1,y:-2},{x:-2,y:0},{x:2,y:0},{x:-2,y:2},{x:2,y:2},{x:0,y:-3},{x:0,y:3},{x:-3,y:0},{x:3,y:0},{x:-1,y:2},{x:1,y:2},{x:-3,y:-1},{x:3,y:-1},{x:-4,y:-1},{x:4,y:-1},{x:-4,y:1},{x:4,y:1},{x:-3,y:2},{x:3,y:2},{x:-3,y:3},{x:3,y:3}],ramparts:[{x:0,y:0},{x:-1,y:1},{x:1,y:1},{x:0,y:-2},{x:-2,y:1},{x:2,y:1},{x:0,y:2},{x:-2,y:-1},{x:2,y:-1},{x:-3,y:-2},{x:3,y:-2},{x:-4,y:0},{x:4,y:0},{x:-3,y:3},{x:3,y:3},{x:-2,y:3},{x:-1,y:3},{x:-4,y:-2},{x:4,y:-2},{x:-4,y:2},{x:4,y:2},{x:-2,y:-2},{x:2,y:-2}]};function tc(e,t,r){const o=e.getTerrain();for(let e=-1;1>=e;e++)for(let n=-1;1>=n;n++){const s=t+e,i=r+n;if(1>s||s>48||1>i||i>48)return!1;if(o.get(s,i)===TERRAIN_MASK_WALL)return!1}return!0}function rc(e,t,r){var o;const n=e.getTerrain(),s=null!==(o=r.minSpaceRadius)&&void 0!==o?o:7;let i=0,a=0;if(t.x<s||t.x>49-s||t.y<s||t.y>49-s)return{fits:!1,reason:`Anchor too close to room edge (needs ${s} tile margin)`};for(const e of r.structures){const r=t.x+e.x,o=t.y+e.y;if(1>r||r>48||1>o||o>48)return{fits:!1,reason:`Structure ${e.structureType} at (${e.x},${e.y}) would be outside room bounds`};a++,n.get(r,o)===TERRAIN_MASK_WALL&&i++}for(const e of r.roads){const r=t.x+e.x,o=t.y+e.y;1>r||r>48||1>o||o>48||(a++,n.get(r,o)===TERRAIN_MASK_WALL&&i++)}const c=a>0?i/a*100:0;return"bunker"===r.type&&c>10?{fits:!1,reason:`Too many walls in blueprint area (${c.toFixed(1)}% walls, max 10% for bunker)`,wallCount:i,totalTiles:a}:"spread"===r.type&&c>25?{fits:!1,reason:`Too many walls in blueprint area (${c.toFixed(1)}% walls, max 25% for spread layout)`,wallCount:i,totalTiles:a}:{fits:!0,wallCount:i,totalTiles:a}}function oc(e,t){var r;const o=e.controller;if(!o)return null;const n=e.find(FIND_SOURCES);let s=o.pos.x,i=o.pos.y;for(const e of n)s+=e.pos.x,i+=e.pos.y;const a=Math.round(s/(n.length+1)),c=Math.round(i/(n.length+1)),l=null!==(r=t.minSpaceRadius)&&void 0!==r?r:7,u=[];for(let r=0;15>=r;r++){for(let s=-r;r>=s;s++)for(let i=-r;r>=i;i++){if(Math.abs(s)!==r&&Math.abs(i)!==r&&r>0)continue;const m=a+s,d=c+i;if(l>m||m>49-l||l>d||d>49-l)continue;const p=new RoomPosition(m,d,e.name),g=rc(e,p,t);if(g.fits){let e=1e3;const t=p.getRangeTo(o);4>t||t>8?4>t?e-=50:t>12&&(e-=30):e+=100;let r=0;for(const e of n)r+=p.getRangeTo(e);const s=r/n.length;5>s||s>10?5>s&&(e-=20):e+=80;const i=Math.abs(m-25)+Math.abs(d-25);if(10>i?e+=50:i>20&&(e-=30),void 0!==g.wallCount&&void 0!==g.totalTiles){const t=g.wallCount/g.totalTiles*100;e+=Math.max(0,50-2*t)}u.push({pos:p,score:e})}}if(u.length>0)return u.sort((e,t)=>t.score-e.score),u[0].pos}return null}function nc(e,t){var r;const o=za(t),n={};let s=e.structures.filter(e=>{var t,r;const s=e.structureType,i=null!==(t=o[s])&&void 0!==t?t:0,a=null!==(r=n[s])&&void 0!==r?r:0;return i>a&&(n[s]=a+1,!0)});const i=null!==(r=o[STRUCTURE_EXTENSION])&&void 0!==r?r:0;return i>0&&(s=function(e,t){const r=t-e.filter(e=>e.structureType===STRUCTURE_EXTENSION).length;if(0>=r)return e;const o=function(){const e=[],t=[{x:-2,y:0},{x:2,y:0},{x:0,y:-2},{x:0,y:2},{x:-2,y:-2},{x:2,y:-2},{x:-2,y:2},{x:2,y:2},{x:-1,y:-3},{x:1,y:-3},{x:-1,y:3},{x:1,y:3},{x:-3,y:-1},{x:3,y:-1},{x:-3,y:1},{x:3,y:1},{x:-4,y:0},{x:4,y:0},{x:0,y:-4},{x:0,y:4},{x:-3,y:-3},{x:3,y:-3},{x:-3,y:3},{x:3,y:3},{x:-4,y:-2},{x:4,y:-2},{x:-4,y:2},{x:4,y:2},{x:-2,y:-4},{x:2,y:-4},{x:-2,y:4},{x:2,y:4},{x:-1,y:-5},{x:1,y:-5},{x:-1,y:5},{x:1,y:5},{x:-5,y:-1},{x:5,y:-1},{x:-5,y:1},{x:5,y:1},{x:-4,y:-4},{x:4,y:-4},{x:-4,y:4},{x:4,y:4},{x:-3,y:-5},{x:3,y:-5},{x:-3,y:5},{x:3,y:5},{x:-5,y:-3},{x:5,y:-3},{x:-5,y:3},{x:5,y:3},{x:-6,y:0},{x:6,y:0},{x:0,y:-6},{x:0,y:6},{x:-6,y:-2},{x:6,y:-2},{x:-6,y:2},{x:6,y:2},{x:-2,y:-6},{x:2,y:-6},{x:-2,y:6},{x:2,y:6},{x:-5,y:-5},{x:5,y:-5},{x:-5,y:5},{x:5,y:5},{x:-4,y:-6},{x:4,y:-6},{x:-4,y:6},{x:4,y:6},{x:-6,y:-4},{x:6,y:-4},{x:-6,y:4},{x:6,y:4}];for(let r=0;Math.min(80,t.length)>r;r++)e.push({x:t[r].x,y:t[r].y,structureType:STRUCTURE_EXTENSION});return e}(),n=new Set(e.map(e=>`${e.x},${e.y}`)),s=o.filter(e=>!n.has(`${e.x},${e.y}`)).slice(0,r);return[...e,...s]}(s,i)),s}function sc(e){return function(e){return 7>e?5>e?3>e?Xa:Qa:Za:Ja}(e)}function ic(e,t){if(t>=8){const t=oc(e,ec);if(t)return{blueprint:ec,anchor:t};const r=oc(e,Ja);if(r)return{blueprint:Ja,anchor:r}}if(t>=7){const t=oc(e,Ja);if(t)return{blueprint:Ja,anchor:t}}if(t>=5){const t=oc(e,Za);if(t)return{blueprint:Za,anchor:t}}if(t>=3){const t=oc(e,Qa);if(t)return{blueprint:Qa,anchor:t}}const r=oc(e,Xa);if(r)return{blueprint:Xa,anchor:r};const o=function(e){const t=e.controller;if(!t)return null;const r=e.find(FIND_SOURCES),o=e.getTerrain();let n=t.pos.x,s=t.pos.y;for(const e of r)n+=e.pos.x,s+=e.pos.y;const i=Math.round(n/(r.length+1)),a=Math.round(s/(r.length+1));for(let r=0;15>r;r++)for(let n=-r;r>=n;n++)for(let s=-r;r>=s;s++){if(Math.abs(n)!==r&&Math.abs(s)!==r)continue;const c=i+n,l=a+s;if(!(3>c||c>46||3>l||l>46)&&tc(e,c,l)){if(Math.max(Math.abs(c-t.pos.x),Math.abs(l-t.pos.y))>20)continue;if(o.get(c,l)===TERRAIN_MASK_WALL)continue;return new RoomPosition(c,l,e.name)}}return null}(e);return o?{blueprint:Xa,anchor:o}:null}const ac=[STRUCTURE_EXTENSION,STRUCTURE_ROAD,STRUCTURE_TOWER,STRUCTURE_LAB,STRUCTURE_LINK,STRUCTURE_FACTORY,STRUCTURE_OBSERVER,STRUCTURE_NUKER,STRUCTURE_POWER_SPAWN,STRUCTURE_EXTRACTOR],cc=new Set(ac);var lc,uc={},mc={};function dc(){return lc||(lc=1,Object.defineProperty(mc,"__esModule",{value:!0}),mc.noopLogger=void 0,mc.noopLogger={info:()=>{},warn:()=>{},error:()=>{},debug:()=>{}}),mc}var pc,gc={};function fc(){return pc||(pc=1,Object.defineProperty(e=gc,"__esModule",{value:!0}),e.REACTIONS=void 0,e.getReaction=function(t){return e.REACTIONS[t]},e.calculateReactionChain=function(t,r){const o=[],n=new Set,s=t=>{var i,a,c;if(n.has(t))return!0;n.add(t);const l=e.REACTIONS[t];return l?!(100>(null!==(a=r[l.input1])&&void 0!==a?a:0)&&!s(l.input1)||100>(null!==(c=r[l.input2])&&void 0!==c?c:0)&&!s(l.input2)||(o.push(l),0)):(null!==(i=r[t])&&void 0!==i?i:0)>0};return s(t),o},e.hasResourcesForReaction=function(e,t,r=100){var o,n;const s=null!==(o=e.store[t.input1])&&void 0!==o?o:0,i=null!==(n=e.store[t.input2])&&void 0!==n?n:0;return s>=r&&i>=r},e.REACTIONS={[RESOURCE_HYDROXIDE]:{product:RESOURCE_HYDROXIDE,input1:RESOURCE_HYDROGEN,input2:RESOURCE_OXYGEN,priority:10},[RESOURCE_ZYNTHIUM_KEANITE]:{product:RESOURCE_ZYNTHIUM_KEANITE,input1:RESOURCE_ZYNTHIUM,input2:RESOURCE_KEANIUM,priority:10},[RESOURCE_UTRIUM_LEMERGITE]:{product:RESOURCE_UTRIUM_LEMERGITE,input1:RESOURCE_UTRIUM,input2:RESOURCE_LEMERGIUM,priority:10},[RESOURCE_GHODIUM]:{product:RESOURCE_GHODIUM,input1:RESOURCE_ZYNTHIUM_KEANITE,input2:RESOURCE_UTRIUM_LEMERGITE,priority:15},[RESOURCE_UTRIUM_HYDRIDE]:{product:RESOURCE_UTRIUM_HYDRIDE,input1:RESOURCE_UTRIUM,input2:RESOURCE_HYDROGEN,priority:20},[RESOURCE_UTRIUM_OXIDE]:{product:RESOURCE_UTRIUM_OXIDE,input1:RESOURCE_UTRIUM,input2:RESOURCE_OXYGEN,priority:20},[RESOURCE_KEANIUM_HYDRIDE]:{product:RESOURCE_KEANIUM_HYDRIDE,input1:RESOURCE_KEANIUM,input2:RESOURCE_HYDROGEN,priority:20},[RESOURCE_KEANIUM_OXIDE]:{product:RESOURCE_KEANIUM_OXIDE,input1:RESOURCE_KEANIUM,input2:RESOURCE_OXYGEN,priority:20},[RESOURCE_LEMERGIUM_HYDRIDE]:{product:RESOURCE_LEMERGIUM_HYDRIDE,input1:RESOURCE_LEMERGIUM,input2:RESOURCE_HYDROGEN,priority:20},[RESOURCE_LEMERGIUM_OXIDE]:{product:RESOURCE_LEMERGIUM_OXIDE,input1:RESOURCE_LEMERGIUM,input2:RESOURCE_OXYGEN,priority:20},[RESOURCE_ZYNTHIUM_HYDRIDE]:{product:RESOURCE_ZYNTHIUM_HYDRIDE,input1:RESOURCE_ZYNTHIUM,input2:RESOURCE_HYDROGEN,priority:20},[RESOURCE_ZYNTHIUM_OXIDE]:{product:RESOURCE_ZYNTHIUM_OXIDE,input1:RESOURCE_ZYNTHIUM,input2:RESOURCE_OXYGEN,priority:20},[RESOURCE_GHODIUM_HYDRIDE]:{product:RESOURCE_GHODIUM_HYDRIDE,input1:RESOURCE_GHODIUM,input2:RESOURCE_HYDROGEN,priority:20},[RESOURCE_GHODIUM_OXIDE]:{product:RESOURCE_GHODIUM_OXIDE,input1:RESOURCE_GHODIUM,input2:RESOURCE_OXYGEN,priority:20},[RESOURCE_UTRIUM_ACID]:{product:RESOURCE_UTRIUM_ACID,input1:RESOURCE_UTRIUM_HYDRIDE,input2:RESOURCE_HYDROXIDE,priority:30},[RESOURCE_UTRIUM_ALKALIDE]:{product:RESOURCE_UTRIUM_ALKALIDE,input1:RESOURCE_UTRIUM_OXIDE,input2:RESOURCE_HYDROXIDE,priority:30},[RESOURCE_KEANIUM_ACID]:{product:RESOURCE_KEANIUM_ACID,input1:RESOURCE_KEANIUM_HYDRIDE,input2:RESOURCE_HYDROXIDE,priority:30},[RESOURCE_KEANIUM_ALKALIDE]:{product:RESOURCE_KEANIUM_ALKALIDE,input1:RESOURCE_KEANIUM_OXIDE,input2:RESOURCE_HYDROXIDE,priority:30},[RESOURCE_LEMERGIUM_ACID]:{product:RESOURCE_LEMERGIUM_ACID,input1:RESOURCE_LEMERGIUM_HYDRIDE,input2:RESOURCE_HYDROXIDE,priority:30},[RESOURCE_LEMERGIUM_ALKALIDE]:{product:RESOURCE_LEMERGIUM_ALKALIDE,input1:RESOURCE_LEMERGIUM_OXIDE,input2:RESOURCE_HYDROXIDE,priority:30},[RESOURCE_ZYNTHIUM_ACID]:{product:RESOURCE_ZYNTHIUM_ACID,input1:RESOURCE_ZYNTHIUM_HYDRIDE,input2:RESOURCE_HYDROXIDE,priority:30},[RESOURCE_ZYNTHIUM_ALKALIDE]:{product:RESOURCE_ZYNTHIUM_ALKALIDE,input1:RESOURCE_ZYNTHIUM_OXIDE,input2:RESOURCE_HYDROXIDE,priority:30},[RESOURCE_GHODIUM_ACID]:{product:RESOURCE_GHODIUM_ACID,input1:RESOURCE_GHODIUM_HYDRIDE,input2:RESOURCE_HYDROXIDE,priority:30},[RESOURCE_GHODIUM_ALKALIDE]:{product:RESOURCE_GHODIUM_ALKALIDE,input1:RESOURCE_GHODIUM_OXIDE,input2:RESOURCE_HYDROXIDE,priority:30},[RESOURCE_CATALYZED_UTRIUM_ACID]:{product:RESOURCE_CATALYZED_UTRIUM_ACID,input1:RESOURCE_UTRIUM_ACID,input2:RESOURCE_CATALYST,priority:40},[RESOURCE_CATALYZED_UTRIUM_ALKALIDE]:{product:RESOURCE_CATALYZED_UTRIUM_ALKALIDE,input1:RESOURCE_UTRIUM_ALKALIDE,input2:RESOURCE_CATALYST,priority:40},[RESOURCE_CATALYZED_KEANIUM_ACID]:{product:RESOURCE_CATALYZED_KEANIUM_ACID,input1:RESOURCE_KEANIUM_ACID,input2:RESOURCE_CATALYST,priority:40},[RESOURCE_CATALYZED_KEANIUM_ALKALIDE]:{product:RESOURCE_CATALYZED_KEANIUM_ALKALIDE,input1:RESOURCE_KEANIUM_ALKALIDE,input2:RESOURCE_CATALYST,priority:40},[RESOURCE_CATALYZED_LEMERGIUM_ACID]:{product:RESOURCE_CATALYZED_LEMERGIUM_ACID,input1:RESOURCE_LEMERGIUM_ACID,input2:RESOURCE_CATALYST,priority:40},[RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE]:{product:RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE,input1:RESOURCE_LEMERGIUM_ALKALIDE,input2:RESOURCE_CATALYST,priority:40},[RESOURCE_CATALYZED_ZYNTHIUM_ACID]:{product:RESOURCE_CATALYZED_ZYNTHIUM_ACID,input1:RESOURCE_ZYNTHIUM_ACID,input2:RESOURCE_CATALYST,priority:40},[RESOURCE_CATALYZED_ZYNTHIUM_ALKALIDE]:{product:RESOURCE_CATALYZED_ZYNTHIUM_ALKALIDE,input1:RESOURCE_ZYNTHIUM_ALKALIDE,input2:RESOURCE_CATALYST,priority:40},[RESOURCE_CATALYZED_GHODIUM_ACID]:{product:RESOURCE_CATALYZED_GHODIUM_ACID,input1:RESOURCE_GHODIUM_ACID,input2:RESOURCE_CATALYST,priority:40},[RESOURCE_CATALYZED_GHODIUM_ALKALIDE]:{product:RESOURCE_CATALYZED_GHODIUM_ALKALIDE,input1:RESOURCE_GHODIUM_ALKALIDE,input2:RESOURCE_CATALYST,priority:40}}),gc;var e}var hc,yc,Rc={},Ec={};function Tc(){return hc||(hc=1,Object.defineProperty(e=Ec,"__esModule",{value:!0}),e.BASE_STOCKPILE_TARGETS=void 0,e.getStockpileTarget=function(t,r){var o,n,s;const i=null!==(o=e.BASE_STOCKPILE_TARGETS[t])&&void 0!==o?o:1e3,a=null!==(n=r.pheromones.war)&&void 0!==n?n:0,c=null!==(s=r.pheromones.siege)&&void 0!==s?s:0,l=Math.max(a,c),u=l>50?1+l/100*.5:1;return"war"!==r.posture&&"siege"!==r.posture&&50>=l||t!==RESOURCE_CATALYZED_UTRIUM_ACID&&t!==RESOURCE_CATALYZED_KEANIUM_ALKALIDE&&t!==RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE&&t!==RESOURCE_CATALYZED_GHODIUM_ACID?"war"!==r.posture&&"siege"!==r.posture||t!==RESOURCE_CATALYZED_GHODIUM_ALKALIDE&&t!==RESOURCE_CATALYZED_ZYNTHIUM_ALKALIDE?i:.5*i:i*Math.min(1.5*u,1.75)},e.getTargetCompounds=function(e){const t=[];return t.push(RESOURCE_GHODIUM,RESOURCE_HYDROXIDE),"war"!==e.posture&&"siege"!==e.posture&&2>e.danger?t.push(RESOURCE_CATALYZED_GHODIUM_ALKALIDE,RESOURCE_CATALYZED_ZYNTHIUM_ALKALIDE,RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE):t.push(RESOURCE_CATALYZED_UTRIUM_ACID,RESOURCE_CATALYZED_KEANIUM_ALKALIDE,RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE,RESOURCE_CATALYZED_GHODIUM_ACID),t},e.BASE_STOCKPILE_TARGETS={[RESOURCE_CATALYZED_UTRIUM_ACID]:3e3,[RESOURCE_CATALYZED_KEANIUM_ALKALIDE]:3e3,[RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE]:3e3,[RESOURCE_CATALYZED_GHODIUM_ACID]:3e3,[RESOURCE_CATALYZED_GHODIUM_ALKALIDE]:2e3,[RESOURCE_CATALYZED_ZYNTHIUM_ALKALIDE]:2e3,[RESOURCE_GHODIUM]:5e3,[RESOURCE_HYDROXIDE]:5e3}),Ec;var e}var Cc,vc,Sc,_c={},bc={},Oc=(Sc||(Sc=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.LabConfigManager=e.calculateBoostCost=e.getBoostConfig=e.BOOST_CONFIGS=e.getTargetCompounds=e.getStockpileTarget=e.BASE_STOCKPILE_TARGETS=e.ChemistryManager=e.hasResourcesForReaction=e.calculateReactionChain=e.getReaction=e.REACTIONS=e.noopLogger=void 0;var t=dc();Object.defineProperty(e,"noopLogger",{enumerable:!0,get:function(){return t.noopLogger}});var r=fc();Object.defineProperty(e,"REACTIONS",{enumerable:!0,get:function(){return r.REACTIONS}}),Object.defineProperty(e,"getReaction",{enumerable:!0,get:function(){return r.getReaction}}),Object.defineProperty(e,"calculateReactionChain",{enumerable:!0,get:function(){return r.calculateReactionChain}}),Object.defineProperty(e,"hasResourcesForReaction",{enumerable:!0,get:function(){return r.hasResourcesForReaction}});var o=function(){if(yc)return Rc;yc=1,Object.defineProperty(Rc,"__esModule",{value:!0}),Rc.ChemistryManager=void 0;const e=dc(),t=fc(),r=Tc();return Rc.ChemistryManager=class{constructor(t={}){var r;this.logger=null!==(r=t.logger)&&void 0!==r?r:e.noopLogger}getReaction(e){return t.REACTIONS[e]}calculateReactionChain(e,r){return(0,t.calculateReactionChain)(e,r)}hasResourcesForReaction(e,r,o=100){return(0,t.hasResourcesForReaction)(e,r,o)}planReactions(e,o){var n;if(3>e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LAB}).length)return null;const s=e.terminal;if(!s)return null;const i=(0,r.getTargetCompounds)(o);for(const a of i){if(!t.REACTIONS[a])continue;const i=null!==(n=s.store[a])&&void 0!==n?n:0;if((0,r.getStockpileTarget)(a,o)>i){const t={};for(const[e,r]of Object.entries(s.store))t[e]=r;const r=this.calculateReactionChain(a,t);for(const e of r)if(this.hasResourcesForReaction(s,e,1e3))return e;r.length>0&&this.logger.debug(`Cannot produce ${a}: missing inputs in reaction chain`,{subsystem:"Chemistry",room:e.name})}}return null}scheduleCompoundProduction(e,o){var n;const s=[];for(const i of e){const e=i.terminal;if(!e)continue;const a=(0,r.getTargetCompounds)(o);for(const c of a){const a=t.REACTIONS[c];if(!a)continue;const l=null!==(n=e.store[c])&&void 0!==n?n:0,u=(0,r.getStockpileTarget)(c,o),m=u-l;if(m>0){const t=m/u,r=a.priority*(1+Math.min(t,.5)),o={};for(const[t,r]of Object.entries(e.store))o[t]=r;const n=this.calculateReactionChain(c,o);for(const t of n)if(this.hasResourcesForReaction(e,t,1e3)){s.push({room:i,reaction:t,priority:r});break}}}}return s.sort((e,t)=>t.priority-e.priority),s}executeReaction(e,t){const r=e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LAB});if(3>r.length)return;const o=r[0],n=r[1];if(!o||!n)return;const s=r.slice(2);(o.mineralType!==t.input1||500>o.store[t.input1])&&this.logger.debug(`Lab ${o.id} needs ${t.input1}`,{subsystem:"Chemistry"}),(n.mineralType!==t.input2||500>n.store[t.input2])&&this.logger.debug(`Lab ${n.id} needs ${t.input2}`,{subsystem:"Chemistry"});for(const e of s){if(e.cooldown>0)continue;const r=e.store.getFreeCapacity();null!==r&&100>r?this.logger.debug(`Lab ${e.id} is full, needs unloading`,{subsystem:"Chemistry"}):e.runReaction(o,n)===OK&&this.logger.debug(`Produced ${t.product} in lab ${e.id}`,{subsystem:"Chemistry"})}}},Rc}();Object.defineProperty(e,"ChemistryManager",{enumerable:!0,get:function(){return o.ChemistryManager}});var n=Tc();Object.defineProperty(e,"BASE_STOCKPILE_TARGETS",{enumerable:!0,get:function(){return n.BASE_STOCKPILE_TARGETS}}),Object.defineProperty(e,"getStockpileTarget",{enumerable:!0,get:function(){return n.getStockpileTarget}}),Object.defineProperty(e,"getTargetCompounds",{enumerable:!0,get:function(){return n.getTargetCompounds}});var s=(Cc||(Cc=1,function(e){function t(t){return e.BOOST_CONFIGS.find(e=>e.role===t)}Object.defineProperty(e,"__esModule",{value:!0}),e.BOOST_CONFIGS=void 0,e.getBoostConfig=t,e.calculateBoostCost=function(e,r){const o=t(e);return o?{mineral:30*r*o.boosts.length,energy:20*r*o.boosts.length}:{mineral:0,energy:0}},e.BOOST_CONFIGS=[{role:"soldier",boosts:[RESOURCE_CATALYZED_UTRIUM_ACID,RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE],minDanger:2},{role:"ranger",boosts:[RESOURCE_CATALYZED_KEANIUM_ALKALIDE,RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE],minDanger:2},{role:"healer",boosts:[RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE,RESOURCE_CATALYZED_ZYNTHIUM_ALKALIDE],minDanger:2},{role:"siegeUnit",boosts:[RESOURCE_CATALYZED_GHODIUM_ACID,RESOURCE_CATALYZED_LEMERGIUM_ALKALIDE],minDanger:1}]}(_c)),_c);Object.defineProperty(e,"BOOST_CONFIGS",{enumerable:!0,get:function(){return s.BOOST_CONFIGS}}),Object.defineProperty(e,"getBoostConfig",{enumerable:!0,get:function(){return s.getBoostConfig}}),Object.defineProperty(e,"calculateBoostCost",{enumerable:!0,get:function(){return s.calculateBoostCost}});var i=function(){if(vc)return bc;vc=1,Object.defineProperty(bc,"__esModule",{value:!0}),bc.LabConfigManager=void 0;const e=dc();return bc.LabConfigManager=class{constructor(t={}){var r;this.configs=new Map,this.logger=null!==(r=t.logger)&&void 0!==r?r:e.noopLogger}initialize(e){var t;const r=Game.rooms[e];if(!r||!(null===(t=r.controller)||void 0===t?void 0:t.my))return;const o=r.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LAB});if(0===o.length)return void this.configs.delete(e);let n=this.configs.get(e);n||(n={roomName:e,labs:[],lastUpdate:Game.time,isValid:!1},this.configs.set(e,n)),this.updateLabEntries(n,o),n.isValid||this.autoAssignRoles(n,o)}updateLabEntries(e,t){e.labs=e.labs.filter(e=>t.some(t=>t.id===e.labId));for(const r of t)e.labs.find(e=>e.labId===r.id)||e.labs.push({labId:r.id,role:"unassigned",pos:{x:r.pos.x,y:r.pos.y},lastConfigured:Game.time});e.lastUpdate=Game.time}autoAssignRoles(e,t){var r,o,n,s;if(3>t.length)return void(e.isValid=!1);const i=new Map;for(const e of t){const r=[];for(const o of t)e.id===o.id||e.pos.getRangeTo(o)>2||r.push(o.id);i.set(e.id,r)}const a=t.map(e=>{var t,r;return{lab:e,reach:null!==(r=null===(t=i.get(e.id))||void 0===t?void 0:t.length)&&void 0!==r?r:0}}).sort((e,t)=>t.reach-e.reach);if(3>a.length||2>(null!==(o=null===(r=a[0])||void 0===r?void 0:r.reach)&&void 0!==o?o:0))return e.isValid=!1,void this.logger.warn(`Lab layout in ${e.roomName} is not optimal for reactions`,{subsystem:"Labs"});const c=null===(n=a[0])||void 0===n?void 0:n.lab,l=null===(s=a[1])||void 0===s?void 0:s.lab;if(c&&l){for(const t of e.labs)if(t.labId===c.id)t.role="input1",t.lastConfigured=Game.time;else if(t.labId===l.id)t.role="input2",t.lastConfigured=Game.time;else{const e=2>=c.pos.getRangeTo(Game.getObjectById(t.labId)),r=2>=l.pos.getRangeTo(Game.getObjectById(t.labId));t.role=e&&r?"output":"boost",t.lastConfigured=Game.time}e.isValid=!0,e.lastUpdate=Game.time,this.logger.info(`Auto-assigned lab roles in ${e.roomName}: `+e.labs.filter(e=>"input1"===e.role).length+" input1, "+e.labs.filter(e=>"input2"===e.role).length+" input2, "+e.labs.filter(e=>"output"===e.role).length+" output, "+e.labs.filter(e=>"boost"===e.role).length+" boost",{subsystem:"Labs"})}else e.isValid=!1}getConfig(e){return this.configs.get(e)}getLabsByRole(e,t){const r=this.configs.get(e);return r?r.labs.filter(e=>e.role===t).map(e=>Game.getObjectById(e.labId)).filter(e=>null!==e):[]}getInputLabs(e){var t,r;const o=this.configs.get(e);if(!o)return{};const n=o.labs.find(e=>"input1"===e.role),s=o.labs.find(e=>"input2"===e.role);return{input1:n&&null!==(t=Game.getObjectById(n.labId))&&void 0!==t?t:void 0,input2:s&&null!==(r=Game.getObjectById(s.labId))&&void 0!==r?r:void 0}}getOutputLabs(e){return this.getLabsByRole(e,"output")}getBoostLabs(e){return this.getLabsByRole(e,"boost")}setActiveReaction(e,t,r,o){const n=this.configs.get(e);if(!n||!n.isValid)return!1;n.activeReaction={input1:t,input2:r,output:o};const s=n.labs.find(e=>"input1"===e.role),i=n.labs.find(e=>"input2"===e.role);s&&(s.resourceType=t),i&&(i.resourceType=r);for(const e of n.labs.filter(e=>"output"===e.role))e.resourceType=o;return n.lastUpdate=Game.time,this.logger.info(`Set active reaction in ${e}: ${t} + ${r} -> ${o}`,{subsystem:"Labs"}),!0}clearActiveReaction(e){const t=this.configs.get(e);if(t){delete t.activeReaction;for(const e of t.labs)delete e.resourceType;t.lastUpdate=Game.time}}runReactions(e){const t=this.configs.get(e);if(!t||!t.isValid||!t.activeReaction)return 0;const{input1:r,input2:o}=this.getInputLabs(e);if(!r||!o)return 0;const n=this.getOutputLabs(e);let s=0;for(const e of n)0===e.cooldown&&e.runReaction(r,o)===OK&&s++;return s}hasValidConfig(e){var t;const r=this.configs.get(e);return null!==(t=null==r?void 0:r.isValid)&&void 0!==t&&t}exportConfig(e){return this.configs.get(e)}importConfig(e){this.configs.set(e.roomName,e)}},bc}();Object.defineProperty(e,"LabConfigManager",{enumerable:!0,get:function(){return i.LabConfigManager}})}(uc)),uc);function Uc(e){let t;switch(e.posture){case"defensive":case"nukePrep":t="defense";break;default:t=e.posture}return{currentTick:Game.time,danger:e.danger,posture:t,pheromones:{war:e.pheromones.war,siege:e.pheromones.siege}}}const Mc={info:(e,t)=>de.info(e,t),warn:(e,t)=>de.warn(e,t),error:(e,t)=>de.error(e,t),debug:(e,t)=>de.debug(e,t)},Ac=new class{constructor(){this.manager=new Oc.ChemistryManager({logger:Mc})}getReaction(e){return this.manager.getReaction(e)}calculateReactionChain(e,t){return this.manager.calculateReactionChain(e,t)}hasResourcesForReaction(e,t,r=100){return this.manager.hasResourcesForReaction(e,t,r)}planReactions(e,t){const r=Uc(t);return this.manager.planReactions(e,r)}scheduleCompoundProduction(e,t){const r=Uc(t);return this.manager.scheduleCompoundProduction(e,r)}executeReaction(e,t){this.manager.executeReaction(e,t)}};function wc(e){switch(e){case ERR_NOT_OWNER:return"not owner of lab";case ERR_NOT_FOUND:return"no suitable body parts";case ERR_NOT_ENOUGH_RESOURCES:return"not enough compound";case ERR_INVALID_TARGET:return"invalid creep target";case ERR_NOT_IN_RANGE:return"creep not in range";case ERR_RCL_NOT_ENOUGH:return"RCL too low";default:return"error code "+e}}const kc=new class{shouldBoost(e,t){var r;const o=e.memory;if(o.boosted)return!1;const n=Oc.getBoostConfig(o.role);if(!n)return!1;const s=!0===(null!==(r=Memory.boostDefensePriority)&&void 0!==r?r:{})[e.room.name]?Math.max(1,n.minDanger-1):n.minDanger;return t.danger>=s&&!t.missingStructures.labs}boostCreep(e,t){const r=e.memory,o=Oc.getBoostConfig(r.role);if(!o)return!1;const n=t.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LAB}),s=[];for(const t of o.boosts){if(e.body.some(e=>e.boost===t))continue;s.push(t);const r=n.find(e=>e.mineralType===t&&e.store[t]>=30);if(!r)return de.debug(`Lab not ready with ${t} for ${e.name}`,{subsystem:"Boost"}),!1;if(!e.pos.isNearTo(r))return e.moveTo(r,{visualizePathStyle:{stroke:"#ffaa00"}}),!1;{const o=r.boostCreep(e);if(o===OK)de.info(`Boosted ${e.name} with ${t}`,{subsystem:"Boost"});else if(o!==ERR_NOT_FOUND)return de.error(`Failed to boost ${e.name}: ${wc(o)}`,{subsystem:"Boost"}),!1}}return 0===s.length&&(r.boosted=!0,de.info(`${e.name} fully boosted (all ${o.boosts.length} boosts applied)`,{subsystem:"Boost"}),!0)}areBoostLabsReady(e,t){const r=Oc.getBoostConfig(t);if(!r)return!0;const o=e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LAB});for(const e of r.boosts)if(!o.find(t=>t.mineralType===e&&t.store[e]>=30))return!1;return!0}getMissingBoosts(e,t){const r=Oc.getBoostConfig(t);if(!r)return[];const o=e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LAB}),n=[];for(const e of r.boosts)o.find(t=>t.mineralType===e&&t.store[e]>=30)||n.push(e);return n}prepareLabs(e,t){if(2>t.danger)return;const r=e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LAB});if(3>r.length)return;const o=r.slice(2),n=new Set,s=[Oc.getBoostConfig("soldier"),Oc.getBoostConfig("ranger"),Oc.getBoostConfig("healer"),Oc.getBoostConfig("siegeUnit")].filter(e=>void 0!==e&&t.danger>=e.minDanger);for(const e of s)for(const t of e.boosts)n.add(t);let i=0;for(const e of n){if(i>=o.length)break;const t=o[i];(t.mineralType!==e||1e3>t.store[e])&&de.debug(`Lab ${t.id} needs ${e} for boosting`,{subsystem:"Boost"}),i++}}calculateBoostCost(e,t){return Oc.calculateBoostCost(e,t)}analyzeBoostROI(e,t,r,o){if(!Oc.getBoostConfig(e))return{worthwhile:!1,roi:0,reasoning:"No boost config for role"};const n=this.calculateBoostCost(e,t),s=n.mineral+.1*n.energy;let i=0;switch(e){case"soldier":i=120*Math.floor(t/3)*r;break;case"ranger":i=40*Math.floor(t/3)*r;break;case"healer":i=48*Math.floor(t/3)*r;break;case"siegeUnit":i=200*Math.floor(t/3)*r;break;default:i=10*t*r}i*=1+.5*o;const a=i/s,c=a>1.5,l=c?`High ROI: ${a.toFixed(2)}x (gain: ${i.toFixed(0)}, cost: ${s.toFixed(0)})`:`Low ROI: ${a.toFixed(2)}x (gain: ${i.toFixed(0)}, cost: ${s.toFixed(0)})`;return{worthwhile:c,roi:a,reasoning:l}}};function Nc(e){return e>=2&&3>=e}const Pc={enablePheromones:!0,enableEvolution:!0,enableSpawning:!0,enableConstruction:!0,enableTowers:!0,enableProcessing:!0},Ic=new Map,xc=new Map;function $c(e){const t=Ic.get(e.name);if(t&&t.tick===Game.time)return t;const r=e.find(FIND_MY_STRUCTURES),o={tick:Game.time,towers:r.filter(e=>e.structureType===STRUCTURE_TOWER),spawns:r.filter(e=>e.structureType===STRUCTURE_SPAWN),links:r.filter(e=>e.structureType===STRUCTURE_LINK),factory:r.find(e=>e.structureType===STRUCTURE_FACTORY),powerSpawn:r.find(e=>e.structureType===STRUCTURE_POWER_SPAWN),sources:e.find(FIND_SOURCES),constructionSites:e.find(FIND_MY_CONSTRUCTION_SITES)};return Ic.set(e.name,o),o}class Gc{constructor(e,t={}){this.roomName=e,this.config={...Pc,...t}}run(e){var t,r,o;const n=Ye.unifiedStats.startRoom(this.roomName),s=Game.rooms[this.roomName];if(!s||!(null===(t=s.controller)||void 0===t?void 0:t.my))return void Ye.unifiedStats.endRoom(this.roomName,n);!function(e){var t;if(!(null===(t=e.controller)||void 0===t?void 0:t.my))return;e.storage&&Ze.set(e.storage.id,e.storage,{namespace:et,ttl:10}),e.terminal&&Ze.set(e.terminal.id,e.terminal,{namespace:et,ttl:10}),e.controller&&Ze.set(e.controller.id,e.controller,{namespace:et,ttl:10});const r=e.find(FIND_SOURCES);for(const e of r)Ze.set(e.id,e,{namespace:et,ttl:5})}(s);const i=Wt.getOrInitSwarmState(this.roomName);if(this.config.enablePheromones&&Game.time%5==0&&hi.updateMetrics(s,i),this.updateThreatAssessment(s,i),Gn.emergencyResponseManager.assess(s,i),Gn.safeModeManager.checkSafeMode(s,i),this.config.enableEvolution&&(Va.updateEvolutionStage(i,s,e),Va.updateMissingStructures(i,s)),qa.updatePosture(i),this.config.enablePheromones&&hi.updatePheromones(i,s),this.config.enableTowers&&this.runTowerControl(s,i),this.config.enableConstruction&&qa.allowsBuilding(i.posture)){const e=Nc(null!==(o=null===(r=s.controller)||void 0===r?void 0:r.level)&&void 0!==o?o:1)?5:10;Game.time%e===0&&this.runConstruction(s,i)}this.config.enableProcessing&&Game.time%5==0&&this.runResourceProcessing(s,i);const a=Game.cpu.getUsed()-n;Ye.unifiedStats.recordRoom(s,a),Ye.unifiedStats.endRoom(this.roomName,n)}updateThreatAssessment(e,t){var r,o;if(Game.time%5==0){const t=$c(e),r=t.spawns.length+t.towers.length,o=xc.get(this.roomName);o&&o.lastTick<Game.time&&r<o.lastStructureCount&&(t.spawns.length<o.lastSpawns.length&&qe.emit("structure.destroyed",{roomName:this.roomName,structureType:STRUCTURE_SPAWN,structureId:"unknown",source:this.roomName}),t.towers.length<o.lastTowers.length&&qe.emit("structure.destroyed",{roomName:this.roomName,structureType:STRUCTURE_TOWER,structureId:"unknown",source:this.roomName})),xc.set(this.roomName,{lastStructureCount:r,lastSpawns:[...t.spawns],lastTowers:[...t.towers],lastTick:Game.time})}const n=Zr(e,FIND_HOSTILE_CREEPS);0>=n.length&&0>=t.danger||Zr(e,FIND_HOSTILE_STRUCTURES,{filter:e=>e.structureType!==STRUCTURE_CONTROLLER});for(const e of n)for(const t of e.body)t.hits>0&&(t.type===ATTACK||(t.type,RANGED_ATTACK));if(n.length>0){const r=Gn.assessThreat(e),o=r.dangerLevel;if(o>t.danger){if(hi.updateDangerFromThreat(t,r.threatScore,r.dangerLevel),t.clusterId){const o=Wt.getCluster(t.clusterId);o&&hi.diffuseDangerToCluster(e.name,r.threatScore,o.memberRooms)}Wt.addRoomEvent(this.roomName,"hostileDetected",`${n.length} hostiles, danger=${o}, score=${r.threatScore}`);for(const e of n)qe.emit("hostile.detected",{roomName:this.roomName,hostileId:e.id,hostileOwner:e.owner.username,bodyParts:e.body.length,threatLevel:o,source:this.roomName})}t.danger=o}else t.danger>0&&(qe.emit("hostile.cleared",{roomName:this.roomName,source:this.roomName}),t.danger=0);if(Game.time%10==0){const n=e.find(FIND_NUKES);if(n.length>0){if(!t.nukeDetected){hi.onNukeDetected(t);const e=null!==(o=null===(r=n[0])||void 0===r?void 0:r.launchRoomName)&&void 0!==o?o:"unidentified source";Wt.addRoomEvent(this.roomName,"nukeDetected",`${n.length} nuke(s) incoming from ${e}`),t.nukeDetected=!0;for(const e of n)qe.emit("nuke.detected",{roomName:this.roomName,nukeId:e.id,landingTick:Game.time+e.timeToLand,launchRoomName:e.launchRoomName,source:this.roomName})}}else t.nukeDetected=!1}}runTowerControl(e,t){var r,o;const n=$c(e).towers;if(0===n.length)return;const s=Zr(e,FIND_HOSTILE_CREEPS),i=s.length>0?this.selectTowerTarget(s):null;for(const a of n)if(a.store.getUsedCapacity(RESOURCE_ENERGY)>=10)if(i)a.attack(i);else{if("siege"!==t.posture){const e=a.pos.findClosestByRange(FIND_MY_CREEPS,{filter:e=>e.hits<e.hitsMax});if(e){a.heal(e);continue}}if(!qa.isCombatPosture(t.posture)){const e=a.pos.findClosestByRange(FIND_STRUCTURES,{filter:e=>e.hits<.8*e.hitsMax&&e.structureType!==STRUCTURE_WALL&&e.structureType!==STRUCTURE_RAMPART});if(e){a.repair(e);continue}}if(!qa.isCombatPosture(t.posture)&&0===s.length){const n=null!==(o=null===(r=e.controller)||void 0===r?void 0:r.level)&&void 0!==o?o:1,s=Gn.calculateWallRepairTarget(n,t.danger),i=a.pos.findClosestByRange(FIND_STRUCTURES,{filter:e=>(e.structureType===STRUCTURE_WALL||e.structureType===STRUCTURE_RAMPART)&&e.hits<s});i&&a.repair(i)}}}selectTowerTarget(e){var t;return null!==(t=e.sort((e,t)=>{const r=this.getHostilePriority(e);return this.getHostilePriority(t)-r})[0])&&void 0!==t?t:null}getHostilePriority(e){let t=0;if(t+=100*e.getActiveBodyparts(HEAL),t+=50*e.getActiveBodyparts(RANGED_ATTACK),t+=40*e.getActiveBodyparts(ATTACK),t+=60*e.getActiveBodyparts(CLAIM),t+=30*e.getActiveBodyparts(WORK),t>0)for(const r of e.body)if(r.boost){t+=20;break}return t}runConstruction(e,t){var r,o,n;const s=$c(e),i=s.constructionSites;if(i.length>=10)return;const a=null!==(o=null===(r=e.controller)||void 0===r?void 0:r.level)&&void 0!==o?o:1,c=s.spawns[0];let l=null==c?void 0:c.pos;if(!c){if(1===a&&0===i.length){const t=ic(e,a);t&&e.createConstructionSite(t.anchor.x,t.anchor.y,STRUCTURE_SPAWN)}return}const u=ic(e,a);if(u)l=u.anchor;else{if(!sc(a))return;l=c.pos}const m=null!==(n=null==u?void 0:u.blueprint)&&void 0!==n?n:sc(a);if(!m||!l)return;if(!qa.isCombatPosture(t.posture)){const r=function(e,t,r,o=1,n=[]){const s=function(e,t,r,o=[]){var n,s,i;const a=null!==(s=null===(n=e.controller)||void 0===n?void 0:n.level)&&void 0!==s?s:1,c=nc(r,a),l=e.getTerrain(),u=[],m=new Map;for(const e of c){const r=t.x+e.x,o=t.y+e.y;if(1>r||r>48||1>o||o>48)continue;if(l.get(r,o)===TERRAIN_MASK_WALL)continue;const n=`${r},${o}`;m.has(e.structureType)||m.set(e.structureType,new Set),null===(i=m.get(e.structureType))||void 0===i||i.add(n)}const d=hn(e,t,r.roads,o);if(m.set(STRUCTURE_ROAD,d),a>=6){const t=e.find(FIND_MINERALS);if(t.length>0){const e=t[0],r=new Set;r.add(`${e.pos.x},${e.pos.y}`),m.set(STRUCTURE_EXTRACTOR,r)}}const p=e.find(FIND_STRUCTURES,{filter:e=>cc.has(e.structureType)&&(!0===e.my||e.structureType===STRUCTURE_ROAD)});for(const e of p){const t=`${e.pos.x},${e.pos.y}`,r=e.structureType,o=m.get(r);o&&o.has(t)||u.push({structure:e,reason:`${e.structureType} at ${t} is not in blueprint`})}return u}(e,t,r,n);let i=0;for(const{structure:e,reason:t}of s){if(i>=o)break;e.destroy()===OK&&(i++,de.info("Destroyed misplaced structure: "+t,{subsystem:"Blueprint",room:e.room.name,meta:{structureType:e.structureType,pos:e.pos.toString(),reason:t}}))}return i}(e,l,m,1,t.remoteAssignments);if(r>0){const e=1===r?"structure":"structures";Wt.addRoomEvent(this.roomName,"structureDestroyed",`${r} misplaced ${e} destroyed for blueprint compliance`)}}let d={sitesPlaced:0,wallsRemoved:0};if(a>=2&&8>i.length){const r=Nc(a)?5:3;d=Gn.placeRoadAwarePerimeterDefense(e,l,m.roads,a,r,t.remoteAssignments),d.wallsRemoved>0&&Wt.addRoomEvent(this.roomName,"wallRemoved",d.wallsRemoved+" wall(s) removed to allow road passage")}const p=function(e,t,r){var o,n,s,i,a,c;const l=null!==(n=null===(o=e.controller)||void 0===o?void 0:o.level)&&void 0!==n?n:1,u=nc(r,l),m=e.getTerrain(),d=[];if(l>=6){const r=e.find(FIND_MINERALS);if(r.length>0){const e=r[0];d.push({x:e.pos.x-t.x,y:e.pos.y-t.y,structureType:STRUCTURE_EXTRACTOR})}}const p=[...u,...d];let g=0;const f=e.find(FIND_MY_CONSTRUCTION_SITES),h=e.find(FIND_STRUCTURES);if(f.length>=10)return 0;const y={};for(const e of h){const t=e.structureType;y[t]=(null!==(s=y[t])&&void 0!==s?s:0)+1}for(const e of f){const t=e.structureType;y[t]=(null!==(i=y[t])&&void 0!==i?i:0)+1}const R=za(l);for(const r of p){const o=null!==(a=y[r.structureType])&&void 0!==a?a:0;if(o>=(null!==(c=R[r.structureType])&&void 0!==c?c:0))continue;const n=t.x+r.x,s=t.y+r.y;if(!(1>n||n>48||1>s||s>48||m.get(n,s)===TERRAIN_MASK_WALL||h.some(e=>e.pos.x===n&&e.pos.y===s&&e.structureType===r.structureType)||f.some(e=>e.pos.x===n&&e.pos.y===s&&e.structureType===r.structureType)||e.createConstructionSite(n,s,r.structureType)!==OK||(g++,y[r.structureType]=o+1,3>g&&10>f.length+g)))break}if(3>g&&10>f.length+g)for(const o of r.roads){const r=t.x+o.x,n=t.y+o.y;if(!(1>r||r>48||1>n||n>48||m.get(r,n)===TERRAIN_MASK_WALL||h.some(e=>e.pos.x===r&&e.pos.y===n&&e.structureType===STRUCTURE_ROAD)||f.some(e=>e.pos.x===r&&e.pos.y===n&&e.structureType===STRUCTURE_ROAD)||e.createConstructionSite(r,n,STRUCTURE_ROAD)!==OK||(g++,3>g&&10>f.length+g)))break}return g}(e,l,m),g=yn(e,l,2);let f={placed:0};if(a>=2&&9>i.length){const r=2>t.danger?2:3;f=Gn.placeRampartsOnCriticalStructures(e,a,t.danger,r),f.placed>0&&Wt.addRoomEvent(this.roomName,"rampartPlaced",f.placed+" rampart(s) placed on critical structures")}t.metrics.constructionSites=i.length+p+g+d.sitesPlaced+f.placed}runResourceProcessing(e,t){var r,o;const n=null!==(o=null===(r=e.controller)||void 0===r?void 0:r.level)&&void 0!==o?o:0;6>n||this.runLabs(e),7>n||this.runFactory(e),8>n||this.runPowerSpawn(e),this.runLinks(e)}runLabs(e){const t=Wt.getSwarmState(e.name);if(!t)return;ua.initialize(e.name),kc.prepareLabs(e,t);const r=Ac.planReactions(e,t);if(r){const t={product:r.product,input1:r.input1,input2:r.input2,amountNeeded:1e3,priority:r.priority};if(ua.areLabsReady(e.name,t)){const t=yi.getConfig(e.name),o=null==t?void 0:t.activeReaction;o&&o.input1===r.input1&&o.input2===r.input2&&o.output===r.product||ua.setActiveReaction(e.name,r.input1,r.input2,r.product),Ac.executeReaction(e,r)}else de.debug(`Labs not ready for reaction: ${r.input1} + ${r.input2} -> ${r.product}`,{subsystem:"Labs",room:e.name})}ua.save(e.name)}runFactory(e){const t=$c(e).factory;if(!t||t.cooldown>0)return;const r=[RESOURCE_UTRIUM,RESOURCE_LEMERGIUM,RESOURCE_KEANIUM,RESOURCE_ZYNTHIUM,RESOURCE_HYDROGEN,RESOURCE_OXYGEN];for(const e of r)if(t.store.getUsedCapacity(e)>=500&&t.store.getUsedCapacity(RESOURCE_ENERGY)>=200&&t.produce(RESOURCE_UTRIUM_BAR)===OK)break}runPowerSpawn(e){const t=$c(e).powerSpawn;t&&(1>t.store.getUsedCapacity(RESOURCE_POWER)||50>t.store.getUsedCapacity(RESOURCE_ENERGY)||t.processPower())}runLinks(e){const t=$c(e),r=t.links;if(2>r.length)return;const o=e.storage;if(!o)return;const n=r.find(e=>2>=e.pos.getRangeTo(o));if(!n)return;const s=t.sources,i=r.filter(e=>s.some(t=>2>=e.pos.getRangeTo(t))),a=e.controller,c=a?r.find(e=>3>=e.pos.getRangeTo(a)&&e.id!==n.id):void 0;for(const e of i)if(e.store.getUsedCapacity(RESOURCE_ENERGY)>=400&&0===e.cooldown&&n.store.getFreeCapacity(RESOURCE_ENERGY)>=400)return void e.transferEnergy(n);if(c&&0===n.cooldown){const e=400>c.store.getUsedCapacity(RESOURCE_ENERGY),t=n.store.getUsedCapacity(RESOURCE_ENERGY)>=400;e&&t&&n.transferEnergy(c)}}}const Lc=new class{constructor(){this.nodes=new Map}run(){var e;const t=global,r=t._ownedRooms,o=t._ownedRoomsTick;let n;n=r&&o===Game.time?r:Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my});const s=n.length;for(const e of n)this.nodes.has(e.name)||this.nodes.set(e.name,new Gc(e.name));for(const[t]of this.nodes){const r=Game.rooms[t];r&&(null===(e=r.controller)||void 0===e?void 0:e.my)||this.nodes.delete(t)}for(const e of this.nodes.values())try{e.run(s)}catch(t){const r=t instanceof Error?t.message:t+"",o=t instanceof Error&&t.stack?t.stack:void 0;de.error(`Error in room ${e.roomName}: ${r}`,{subsystem:"RoomManager",room:e.roomName,meta:{stack:o}})}}getNode(e){return this.nodes.get(e)}getAllNodes(){return Array.from(this.nodes.values())}runRoom(e){var t;if(!(null===(t=e.controller)||void 0===t?void 0:t.my))return;this.nodes.has(e.name)||this.nodes.set(e.name,new Gc(e.name));const r=global,o=r._ownedRooms,n=r._ownedRoomsTick;let s;s=o&&n===Game.time?o.length:Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my}).length;const i=this.nodes.get(e.name);try{i.run(s)}catch(t){const r=t instanceof Error?t.message:t+"",o=t instanceof Error&&t.stack?t.stack:void 0;de.error(`Error in room ${e.name}: ${r}`,{subsystem:"RoomManager",room:e.name,meta:{stack:o}})}}};function Dc(e){var t,r,o;return e.find(FIND_HOSTILE_CREEPS).length>0?Be.CRITICAL:(null===(t=e.controller)||void 0===t?void 0:t.my)?Be.HIGH:"ralphschuler"===(null===(o=null===(r=e.controller)||void 0===r?void 0:r.reservation)||void 0===o?void 0:o.username)?Be.MEDIUM:Be.LOW}function Fc(e){var t;if(!(null===(t=e.controller)||void 0===t?void 0:t.my))return.02;const r=e.controller.level;return e.find(FIND_HOSTILE_CREEPS).length>0?.12:r>3?r>6?.08:.06:.04}function Bc(e,t,r){var o;return t===Be.CRITICAL?{tickModulo:void 0,tickOffset:void 0}:t===Be.HIGH&&(null===(o=e.controller)||void 0===o?void 0:o.my)?{tickModulo:5,tickOffset:r%5}:t===Be.MEDIUM?{tickModulo:10,tickOffset:r%10}:t===Be.LOW?{tickModulo:20,tickOffset:r%20}:{tickModulo:void 0,tickOffset:void 0}}const Hc=new class{constructor(){this.registeredRooms=new Set,this.lastSyncTick=-1,this.roomIndices=new Map,this.nextRoomIndex=0}getRoomIndex(e){let t=this.roomIndices.get(e);return void 0===t&&(t=this.nextRoomIndex++,this.roomIndices.set(e,t)),t}syncRoomProcesses(){if(this.lastSyncTick===Game.time)return;this.lastSyncTick=Game.time;const e=new Set;for(const t in Game.rooms){const r=Game.rooms[t];e.add(t);const o="room:"+t,n=qe.getProcess(o),s=Dc(r),i=Fc(r);this.registeredRooms.has(t)?n&&(n.priority!==s||Math.abs(n.cpuBudget-i)>1e-4)&&this.updateRoomProcess(r,s,i):this.registerRoomProcess(r)}for(const t of this.registeredRooms)e.has(t)||this.unregisterRoomProcess(t)}registerRoomProcess(e){var t;const r=Dc(e),o=Fc(e),n="room:"+e.name,s=this.getRoomIndex(e.name),i=Bc(e,r,s);qe.registerProcess({id:n,name:`Room ${e.name}${(null===(t=e.controller)||void 0===t?void 0:t.my)?" (owned)":""}`,priority:r,frequency:"high",interval:1,tickModulo:i.tickModulo,tickOffset:i.tickOffset,minBucket:this.getMinBucketForPriority(r),cpuBudget:o,execute:()=>{const t=Game.rooms[e.name];t&&Lc.runRoom(t)}}),this.registeredRooms.add(e.name);const a=i.tickModulo?`(mod=${i.tickModulo}, offset=${i.tickOffset})`:"(every tick)";de.debug(`Registered room process: ${e.name} with priority ${r} ${a}`,{subsystem:"RoomProcessManager"})}updateRoomProcess(e,t,r){var o;const n="room:"+e.name,s=this.getRoomIndex(e.name),i=Bc(e,t,s);qe.unregisterProcess(n),qe.registerProcess({id:n,name:`Room ${e.name}${(null===(o=e.controller)||void 0===o?void 0:o.my)?" (owned)":""}`,priority:t,frequency:"high",interval:1,tickModulo:i.tickModulo,tickOffset:i.tickOffset,minBucket:this.getMinBucketForPriority(t),cpuBudget:r,execute:()=>{const t=Game.rooms[e.name];t&&Lc.runRoom(t)}});const a=i.tickModulo?`mod=${i.tickModulo}, offset=${i.tickOffset}`:"every tick";de.debug(`Updated room process: ${e.name} priority=${t} budget=${r} (${a})`,{subsystem:"RoomProcessManager"})}unregisterRoomProcess(e){const t="room:"+e;qe.unregisterProcess(t),this.registeredRooms.delete(e),this.roomIndices.delete(e),de.debug("Unregistered room process: "+e,{subsystem:"RoomProcessManager"})}getMinBucketForPriority(e){return 0}getStats(){var e,t,r;const o={};let n=0;for(const s of this.registeredRooms){const i=Game.rooms[s];if(i){const s=Dc(i),a=null!==(e=Be[s])&&void 0!==e?e:"UNKNOWN";o[a]=(null!==(t=o[a])&&void 0!==t?t:0)+1,(null===(r=i.controller)||void 0===r?void 0:r.my)&&n++}}return{totalRooms:Object.keys(Game.rooms).length,registeredRooms:this.registeredRooms.size,roomsByPriority:o,ownedRooms:n}}forceResync(){this.lastSyncTick=-1,this.syncRoomProcesses()}reset(){this.registeredRooms.clear(),this.roomIndices.clear(),this.nextRoomIndex=0,this.lastSyncTick=-1}};var Wc,Yc,Kc,jc,Vc={},qc={},zc={},Xc=(Kc||(Kc=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.PathCacheEventManager=e.PortalManager=void 0;var t=function(){if(Wc)return qc;Wc=1,Object.defineProperty(qc,"__esModule",{value:!0}),qc.PortalManager=void 0;const e=1e3,t="portals:";return qc.PortalManager=class{cache;logger;constructor(e,t){this.cache=e,this.logger=t}discoverPortalsInRoom(e){const t="portals:room:"+e,r=this.cache.get(t);if(void 0!==r)return this.logger.debug("Using cached portal data for room "+e,{subsystem:"PortalManager",room:e,meta:{portalCount:r?.length??0}}),r;const o=Game.rooms[e];if(!o)return this.cache.set(t,null,500),null;const n=o.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_PORTAL}),s=[];for(const e of n){if(!e.destination)continue;let t;if("shard"in e.destination&&"room"in e.destination)t={shard:e.destination.shard,room:e.destination.room};else{if(!("x"in e.destination&&"y"in e.destination&&"roomName"in e.destination))continue;t={room:e.destination.roomName}}s.push({pos:e.pos,destination:t,lastSeen:Game.time})}return this.cache.set(t,s,500),s.length>0&&this.logger.info(`Discovered ${s.length} portal(s) in room ${e}`,{subsystem:"PortalManager",room:e,meta:{portalCount:s.length,destinations:s.map(e=>e.destination.shard?`${e.destination.shard}:${e.destination.room}`:e.destination.room)}}),s}getPortalsToShard(e){const t=[];for(const r in Game.rooms){const o=this.discoverPortalsInRoom(r);if(o)for(const r of o)r.destination.shard===e&&t.push(r)}return t}findClosestPortalToShard(e,t){const r=this.getPortalsToShard(t);if(0===r.length)return null;let o=null,n=1/0;for(const t of r){const r=Game.map.getRoomLinearDistance(e.roomName,t.pos.roomName);n>r&&(n=r,o=t)}return o}publishPortalsToInterShardMemory(){try{const e=Game.shard?.name;if(!e)return!1;const r={};for(const e in Game.rooms){const t=this.discoverPortalsInRoom(e);if(!t||0===t.length)continue;const o=t.filter(e=>1e4>Game.time-e.lastSeen);0!==o.length&&(r[e]=o.map(e=>e.destination))}const o={shard:e,portals:r,lastUpdate:Game.time};let n={};try{const e=InterShardMemory.getLocal();e&&(n=JSON.parse(e))}catch{n={}}return n[t]=o,InterShardMemory.setLocal(JSON.stringify(n)),this.logger.debug("Published portal data to InterShardMemory",{subsystem:"PortalManager",meta:{portalCount:Object.keys(o.portals).length}}),!0}catch(e){return this.logger.error("Failed to publish to InterShardMemory: "+e,{subsystem:"PortalManager"}),!1}}isValidPortalData(e){if("object"!=typeof e||null===e)return!1;const t=e;if("string"!=typeof t.shard)return!1;if("number"!=typeof t.lastUpdate)return!1;if("object"!=typeof t.portals||null===t.portals)return!1;const r=t.portals;for(const e in r){const t=r[e];if(!Array.isArray(t))return!1;for(const e of t){if("object"!=typeof e||null===e)return!1;const t=e;if("string"!=typeof t.room)return!1;if(void 0!==t.shard&&"string"!=typeof t.shard)return!1}}return!0}getPortalDataFromInterShardMemory(e){try{const r=InterShardMemory.getRemote(e);if(!r)return null;let o;try{o=JSON.parse(r)}catch{return this.logger.warn("Invalid JSON from shard "+e,{subsystem:"PortalManager",meta:{shard:e}}),null}const n=o[t];return this.isValidPortalData(n)?(this.logger.debug("Retrieved portal data from shard "+e,{subsystem:"PortalManager",meta:{shard:e,portalCount:Object.keys(n.portals).length}}),n):(this.logger.warn("Invalid portal data structure from shard "+e,{subsystem:"PortalManager",meta:{shard:e}}),null)}catch(t){return this.logger.error("Failed to read from InterShardMemory: "+t,{subsystem:"PortalManager",meta:{shard:e}}),null}}findRouteToPortal(t,r){const o=`portal:route:${t}:${r}`,n=this.cache.get(o);if(void 0!==n)return n;const s=new RoomPosition(25,25,t),i=this.findClosestPortalToShard(s,r);if(!i)return this.cache.set(o,null,e),null;const a=Game.map.findRoute(t,i.pos.roomName);if(a===ERR_NO_PATH)return this.cache.set(o,null,e),null;const c=[t];for(const e of a)c.push(e.room);const l={rooms:c,portals:[i.pos],distance:c.length,calculatedAt:Game.time};return this.cache.set(o,l,e),l}findInterShardRoute(e,t,r,o){if(t===o){const t=Game.map.findRoute(e,r);if(t===ERR_NO_PATH)return null;const o=[e];for(const e of t)o.push(e.room);return{rooms:o,portals:[],distance:o.length,calculatedAt:Game.time}}return this.findRouteToPortal(e,o)}maintainPortalCache(){let e=0;return this.publishPortalsToInterShardMemory()&&e++,e}},qc}();Object.defineProperty(e,"PortalManager",{enumerable:!0,get:function(){return t.PortalManager}});var r=(Yc||(Yc=1,Object.defineProperty(zc,"__esModule",{value:!0}),zc.PathCacheEventManager=void 0,zc.PathCacheEventManager=class{logger;eventBus;pathCache;remoteMining;initialized=!1;constructor(e,t,r,o){this.logger=e,this.eventBus=t,this.pathCache=r,this.remoteMining=o}initializePathCacheEvents(){this.initialized?this.logger.warn("Path cache event handlers already initialized",{subsystem:"PathCacheEvents"}):(this.eventBus.on("construction.complete",e=>{const{roomName:t,structureType:r}=e;if(this.logger.debug(`Construction completed in ${t}: ${r}`,{room:t,meta:{structureType:r}}),this.pathCache.invalidateRoom(t),r===STRUCTURE_STORAGE){const e=Game.rooms[t];if(e){this.pathCache.cacheCommonRoutes(e);const r=this.remoteMining.getRemoteRoomsForRoom(e);r.length>0&&(this.remoteMining.precacheRemoteRoutes(e,r),this.logger.info("Cached remote routes after storage construction in "+t,{room:t,meta:{remoteRooms:r.length}})),this.logger.info("Cached common routes after storage construction in "+t,{room:t})}}}),this.eventBus.on("structure.destroyed",e=>{const{roomName:t,structureType:r}=e;this.logger.debug(`Structure destroyed in ${t}: ${r}`,{room:t,meta:{structureType:r}}),this.pathCache.invalidateRoom(t)}),this.initialized=!0,this.logger.info("Path cache event handlers initialized",{subsystem:"PathCacheEvents"}))}}),zc);Object.defineProperty(e,"PathCacheEventManager",{enumerable:!0,get:function(){return r.PathCacheEventManager}})}(Vc)),Vc);!function(e){e[e.CRITICAL=0]="CRITICAL",e[e.HIGH=1]="HIGH",e[e.MEDIUM=2]="MEDIUM",e[e.LOW=3]="LOW"}(jc||(jc={}));const Qc={bucketThresholds:{[jc.CRITICAL]:0,[jc.HIGH]:2e3,[jc.MEDIUM]:5e3,[jc.LOW]:8e3},defaultMaxCpu:5,logExecution:!1};class Zc{constructor(e){this.tasks=new Map,this.stats={totalTasks:0,tasksByPriority:{[jc.CRITICAL]:0,[jc.HIGH]:0,[jc.MEDIUM]:0,[jc.LOW]:0},executedThisTick:0,skippedThisTick:0,deferredThisTick:0,cpuUsed:0},this.config={...Qc,...e}}register(e){var t,r;const o={...e,lastRun:Game.time-e.interval,maxCpu:null!==(t=e.maxCpu)&&void 0!==t?t:this.config.defaultMaxCpu,skippable:null===(r=e.skippable)||void 0===r||r};this.tasks.set(e.id,o),this.updateStats()}unregister(e){this.tasks.delete(e),this.updateStats()}run(e){var t;const r=Game.cpu.getUsed(),o=Game.cpu.bucket,n=null!=e?e:1/0;this.stats.executedThisTick=0,this.stats.skippedThisTick=0,this.stats.deferredThisTick=0;const s=Array.from(this.tasks.values()).sort((e,t)=>e.priority-t.priority);let i=0;for(const e of s){if(Game.time-e.lastRun<e.interval)continue;if(e.priority!==jc.CRITICAL){const t=this.config.bucketThresholds[e.priority];if(t>o){this.stats.skippedThisTick++,this.config.logExecution&&de.debug(`Skipping task ${e.id} due to low bucket`,{subsystem:"Scheduler",meta:{taskId:e.id,bucket:o,threshold:t}});continue}}const r=null!==(t=e.maxCpu)&&void 0!==t?t:this.config.defaultMaxCpu;if(i+r>n&&e.skippable){this.stats.deferredThisTick++,this.config.logExecution&&de.debug(`Deferring task ${e.id} - budget exceeded`,{subsystem:"Scheduler",meta:{taskId:e.id,cpuUsed:i,cpuBudget:n}});continue}const s=Game.cpu.getUsed();try{e.execute(),e.lastRun=Game.time,this.stats.executedThisTick++;const t=Game.cpu.getUsed()-s;i+=t,this.config.logExecution&&de.debug("Executed task "+e.id,{subsystem:"Scheduler",meta:{taskId:e.id,cpuUsed:t.toFixed(2)}}),t>r&&de.warn(`Task ${e.id} exceeded CPU budget`,{subsystem:"Scheduler",meta:{taskId:e.id,cpuUsed:t.toFixed(2),cpuBudget:r}})}catch(t){de.error(`Error executing task ${e.id}: ${t+""}`,{subsystem:"Scheduler",meta:{taskId:e.id}}),e.lastRun=Game.time}if(i>n)break}return this.stats.cpuUsed=Game.cpu.getUsed()-r,{...this.stats}}forceRun(e){const t=this.tasks.get(e);if(!t)return!1;try{return t.execute(),t.lastRun=Game.time,de.info("Force-executed task "+e,{subsystem:"Scheduler",meta:{taskId:e}}),!0}catch(t){return de.error(`Error force-executing task ${e}: ${t+""}`,{subsystem:"Scheduler",meta:{taskId:e}}),!1}}resetTask(e){const t=this.tasks.get(e);t&&(t.lastRun=Game.time-t.interval)}getStats(){return{...this.stats}}getTasks(){return Array.from(this.tasks.values())}hasTask(e){return this.tasks.has(e)}clear(){this.tasks.clear(),this.updateStats()}updateStats(){this.stats.totalTasks=this.tasks.size,this.stats.tasksByPriority={[jc.CRITICAL]:0,[jc.HIGH]:0,[jc.MEDIUM]:0,[jc.LOW]:0};for(const e of this.tasks.values())this.stats.tasksByPriority[e.priority]++}}const Jc=function(){const e=global;return e._computationScheduler||(e._computationScheduler=new Zc),e._computationScheduler}();var el,tl,rl={},ol={},nl={};function sl(){return tl||(tl=1,Object.defineProperty(nl,"__esModule",{value:!0}),nl.getRemoteRoomsForRoom=function(e){const t=new Set;for(const r of Object.values(Game.creeps)){const o=r.memory;"remoteHarvester"!==o.role&&"remoteHauler"!==o.role||o.homeRoom!==e.name||!o.targetRoom||o.targetRoom===e.name||t.add(o.targetRoom)}return Array.from(t)},nl.getRemoteMiningRoomCallback=function(e,t){const r=Game.rooms[e];if(!r)return!0;const o=e.match(/\d+/g);if(!/^[WE]\d+[NS]\d+$/.test(e)||null===o||2!==o.length||parseInt(o[0],10)%10!=0&&parseInt(o[1],10)%10!=0){const o=r.find(FIND_HOSTILE_STRUCTURES,{filter:e=>e.structureType!==STRUCTURE_CONTROLLER&&e.structureType!==STRUCTURE_KEEPER_LAIR});if(o.length>0)return t&&t.debug(`Avoiding room ${e} with hostile structures`,{meta:{hostileCount:o.length}}),!1}const n=new PathFinder.CostMatrix,s=r.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_ROAD});for(const e of s)n.set(e.pos.x,e.pos.y,1);const i=r.find(FIND_CREEPS);for(const e of i)n.set(e.pos.x,e.pos.y,255);return n}),nl}var il,al,cl,ll,ul={},ml={},dl={},pl=(ll||(ll=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.RemoteMiningMovement=e.RemotePathScheduler=e.RemotePathCache=e.getRemoteMiningRoomCallback=e.getRemoteRoomsForRoom=e.TaskPriority=void 0;var t=function(){return el||(el=1,Object.defineProperty(ol,"__esModule",{value:!0}),ol.TaskPriority=void 0,function(e){e[e.CRITICAL=0]="CRITICAL",e[e.HIGH=1]="HIGH",e[e.MEDIUM=2]="MEDIUM",e[e.LOW=3]="LOW"}(e||(ol.TaskPriority=e={}))),ol;var e}();Object.defineProperty(e,"TaskPriority",{enumerable:!0,get:function(){return t.TaskPriority}});var r=sl();Object.defineProperty(e,"getRemoteRoomsForRoom",{enumerable:!0,get:function(){return r.getRemoteRoomsForRoom}}),Object.defineProperty(e,"getRemoteMiningRoomCallback",{enumerable:!0,get:function(){return r.getRemoteMiningRoomCallback}});var o=function(){if(il)return ul;il=1,Object.defineProperty(ul,"__esModule",{value:!0}),ul.RemotePathCache=void 0;const e=sl();return ul.RemotePathCache=class{pathCache;logger;constructor(e,t){this.pathCache=e,this.logger=t}getRemoteMiningPath(e,t,r){const o=this.pathCache.getCachedPath(e,t);return o?this.logger.debug(`Remote path cache hit: ${e.roomName}  ${t.roomName} (${r})`,{meta:{pathLength:o.length}}):this.logger.debug(`Remote path cache miss: ${e.roomName}  ${t.roomName} (${r})`),o}cacheRemoteMiningPath(e,t,r,o){this.pathCache.cachePath(e,t,r,{ttl:500}),this.logger.info(`Cached remote path: ${e.roomName}  ${t.roomName} (${o})`,{meta:{pathLength:r.length,ttl:500}})}precacheRemoteRoutes(t,r){const o=t.storage,n=t.find(FIND_MY_SPAWNS);if(!o&&0===n.length)return void this.logger.warn(`Cannot precache remote routes for ${t.name}: no storage or spawns`);let s=0;for(const t of r){const r=Game.rooms[t];if(!r){this.logger.debug(`Cannot precache routes to ${t}: room not visible`);continue}const i=r.find(FIND_SOURCES),a=r.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_CONTAINER});if(n.length>0){const t=n[0];for(const r of i){const o=PathFinder.search(t.pos,{pos:r.pos,range:1},{plainCost:2,swampCost:10,maxRooms:16,roomCallback:t=>(0,e.getRemoteMiningRoomCallback)(t,this.logger)});if(!o.incomplete&&o.path.length>0){const e=this.pathCache.convertRoomPositionsToPathSteps(o.path);this.cacheRemoteMiningPath(t.pos,r.pos,e,"harvester"),s++}}}if(o){const t=a.filter(e=>e.structureType===STRUCTURE_CONTAINER),r=t.length>0?t.map(e=>e.pos):i.map(e=>e.pos);for(const t of r){const r=PathFinder.search(t,{pos:o.pos,range:1},{plainCost:2,swampCost:10,maxRooms:16,roomCallback:t=>(0,e.getRemoteMiningRoomCallback)(t,this.logger)});if(!r.incomplete&&r.path.length>0){const e=this.pathCache.convertRoomPositionsToPathSteps(r.path);this.cacheRemoteMiningPath(t,o.pos,e,"hauler"),s++}}}}s>0&&this.logger.info(`Precached ${s} remote mining routes for ${t.name}`,{room:t.name,meta:{remoteRooms:r.length,routesCached:s}})}getOrCalculateRemotePath(t,r,o){const n=this.getRemoteMiningPath(t,r,o);if(n)return n;const s=PathFinder.search(t,{pos:r,range:1},{plainCost:2,swampCost:10,maxRooms:16,roomCallback:t=>(0,e.getRemoteMiningRoomCallback)(t,this.logger)});if(!s.incomplete&&s.path.length>0){const e=this.pathCache.convertRoomPositionsToPathSteps(s.path);return this.cacheRemoteMiningPath(t,r,e,o),e}return this.logger.warn(`Failed to calculate remote path: ${t.roomName}  ${r.roomName}`,{meta:{incomplete:s.incomplete}}),null}},ul}();Object.defineProperty(e,"RemotePathCache",{enumerable:!0,get:function(){return o.RemotePathCache}});var n=function(){if(al)return ml;al=1,Object.defineProperty(ml,"__esModule",{value:!0}),ml.RemotePathScheduler=void 0;const e=sl();return ml.RemotePathScheduler=class{logger;scheduler;pathCache;constructor(e,t,r){this.logger=e,this.scheduler=t,this.pathCache=r}precacheAllRemoteRoutes(){let t=0;for(const r of Object.values(Game.rooms)){if(!r.controller?.my)continue;if(!r.storage&&0===r.find(FIND_MY_SPAWNS).length)continue;const o=(0,e.getRemoteRoomsForRoom)(r);0!==o.length&&(this.pathCache.precacheRemoteRoutes(r,o),t+=o.length)}t>0&&this.logger.info(`Precached remote routes for ${t} remote rooms`,{meta:{routesCached:t}})}initialize(e=2){this.scheduler.scheduleTask("precache-remote-paths",500,()=>this.precacheAllRemoteRoutes(),e,5),this.logger.info("Remote path cache scheduler initialized")}},ml}();Object.defineProperty(e,"RemotePathScheduler",{enumerable:!0,get:function(){return n.RemotePathScheduler}});var s=function(){if(cl)return dl;cl=1,Object.defineProperty(dl,"__esModule",{value:!0}),dl.RemoteMiningMovement=void 0;const e=sl();return dl.RemoteMiningMovement=class{logger;pathCache;remotePaths;moveTo;constructor(e,t,r,o){this.logger=e,this.pathCache=t,this.remotePaths=r,this.moveTo=o}moveToWithRemoteCache(e,t,r,o={}){const n=t instanceof RoomPosition?t:t.pos,s=this.remotePaths.getRemoteMiningPath(e.pos,n,r);if(s&&s.length>0){this.logger.debug(`Using cached path for ${e.name} (${r})`,{meta:{pathLength:s.length}});const t=s[0],o=e.pos.x===t.x&&e.pos.y===t.y,n=!o&&1>=Math.abs(e.pos.x-t.x)&&1>=Math.abs(e.pos.y-t.y);if(o||n){const t=e.moveByPath(s);if(t===OK||t===ERR_TIRED)return t;this.logger.debug(`moveByPath failed for ${e.name}, falling back to moveTo`,{meta:{result:t,atFirstStep:o,adjacentToPath:n}})}}const i=this.moveTo(e,t,{...o,maxRooms:16});return i!==OK&&i!==ERR_TIRED||s||this.cachePathAfterMovement(e,n,r),i}cachePathAfterMovement(t,r,o){if(t.pos.roomName===r.roomName)return;const n=PathFinder.search(t.pos,{pos:r,range:1},{plainCost:2,swampCost:10,maxRooms:16,roomCallback:t=>(0,e.getRemoteMiningRoomCallback)(t,this.logger)});if(!n.incomplete&&n.path.length>0){const e=this.pathCache.convertRoomPositionsToPathSteps(n.path);this.remotePaths.cacheRemoteMiningPath(t.pos,r,e,o),this.logger.debug(`Cached new remote path for ${t.name} (${o})`,{meta:{pathLength:n.path.length}})}}moveRemoteHarvesterToSource(e,t){return this.moveToWithRemoteCache(e,t,"harvester",{visualizePathStyle:{stroke:"#ffaa00"}})}moveRemoteHaulerToStorage(e,t){return this.moveToWithRemoteCache(e,t,"hauler",{visualizePathStyle:{stroke:"#ffffff"}})}moveRemoteHaulerToRemote(e,t){const r=new RoomPosition(25,25,t);return this.moveToWithRemoteCache(e,r,"hauler",{visualizePathStyle:{stroke:"#ffffff"}})}},dl}();Object.defineProperty(e,"RemoteMiningMovement",{enumerable:!0,get:function(){return s.RemoteMiningMovement}})}(rl)),rl);const gl={debug:(e,t)=>me("RemoteMining").debug(e,t),info:(e,t)=>me("RemoteMining").info(e,t),warn:(e,t)=>me("RemoteMining").warn(e,t),error:(e,t)=>me("RemoteMining").error(e,t)},fl={getCachedPath:function(e,t){const r=rt(e,t),o=Ze.get(r,{namespace:tt});if(!o)return null;try{return Room.deserializePath(o)}catch(e){return Ze.invalidate(r,tt),null}},cachePath:ot,convertRoomPositionsToPathSteps:function(e){const t=[];for(let r=0;r<e.length;r++){const o=e[r],n=r>0?e[r-1]:null;let s=TOP,i=0,a=0;n&&n.roomName===o.roomName&&(i=o.x-n.x,a=o.y-n.y,-1===a&&0===i?s=TOP:-1===a&&1===i?s=TOP_RIGHT:0===a&&1===i?s=RIGHT:1===a&&1===i?s=BOTTOM_RIGHT:1===a&&0===i?s=BOTTOM:1===a&&-1===i?s=BOTTOM_LEFT:0===a&&-1===i?s=LEFT:-1===a&&-1===i&&(s=TOP_LEFT)),t.push({x:o.x,y:o.y,dx:i,dy:a,direction:s})}return t}},hl={scheduleTask:(e,t,r,o,n)=>{!function(e,t,r,o=jc.MEDIUM,n){Jc.register({id:e,interval:t,execute:r,priority:o,maxCpu:n,skippable:o!==jc.CRITICAL})}(e,t,r,o,n)}},yl=new pl.RemotePathCache(fl,gl),Rl=new pl.RemotePathScheduler(gl,hl,yl);new pl.RemoteMiningMovement(gl,fl,yl,uo.moveTo);class El{constructor(){this.logger=me("Pathfinding")}debug(e,t){this.logger.debug(e,t)}info(e,t){this.logger.info(e,t)}warn(e,t){this.logger.warn(e,t)}error(e,t){this.logger.error(e,t)}}new Xc.PortalManager(new class{get(e){return Wt.getHeapCache().get(e)}set(e,t,r){Wt.getHeapCache().set(e,t,r)}},new El);const Tl=new Xc.PathCacheEventManager(new El,new class{on(e,t){ve.on(e,t)}},new class{invalidateRoom(e){!function(e){const t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),r=RegExp(`^${t}:|:${t}:|:${t}$`);Ze.invalidatePattern(r,tt)}(e)}cacheCommonRoutes(e){!function(e){var t;if(!(null===(t=e.controller)||void 0===t?void 0:t.my))return;const r=e.storage;if(!r)return;const o=e.find(FIND_SOURCES);for(const t of o){const o=e.findPath(r.pos,t.pos,{ignoreCreeps:!0,serialize:!1});o.length>0&&(ot(r.pos,t.pos,o),ot(t.pos,r.pos,o))}if(e.controller){const t=e.findPath(r.pos,e.controller.pos,{ignoreCreeps:!0,range:3,serialize:!1});t.length>0&&ot(r.pos,e.controller.pos,t)}}(e)}},new class{getRemoteRoomsForRoom(e){return function(e){return pl.getRemoteRoomsForRoom(e)}(e)}precacheRemoteRoutes(e,t){!function(e,t){yl.precacheRemoteRoutes(e,t)}(e,t)}}),Cl=me("SS2TerminalComms");class vl{static parseTransaction(e){const t=e.match(/^([\da-zA-Z]{1,3})\|([\d]{1,2})\|(.+)$/);if(!t)return null;const r=t[1],o=parseInt(t[2],10);let n,s=t[3];if(0===o){const e=s.match(/^(\d{1,2})\|(.+)$/);e&&(n=parseInt(e[1],10),s=e[2])}return{msgId:r,packetId:o,finalPacket:n,messageChunk:s}}static processIncomingTransactions(){const e=[];if(this.cleanupExpiredBuffers(),!Game.market.incomingTransactions)return e;for(const t of Game.market.incomingTransactions){if(t.order)continue;if(!t.description||!t.sender)continue;const r=this.parseTransaction(t.description);if(!r)continue;const o=`${t.sender.username}:${r.msgId}`;let n=this.messageBuffers.get(o);if(!n){if(void 0===r.finalPacket)continue;n={msgId:r.msgId,sender:t.sender.username,finalPacket:r.finalPacket,packets:new Map,receivedAt:Game.time},this.messageBuffers.set(o,n)}if(n.packets.set(r.packetId,r.messageChunk),n.packets.size===n.finalPacket+1){const s=[];for(let e=0;e<=n.finalPacket;e++){const o=n.packets.get(e);if(!o){Cl.warn("Missing packet in multi-packet message",{meta:{packetId:e,messageId:r.msgId,sender:t.sender.username}});break}s.push(o)}if(s.length===n.finalPacket+1){const n=s.join("");e.push({sender:t.sender.username,message:n}),this.messageBuffers.delete(o),Cl.info("Received complete multi-packet message from "+t.sender.username,{meta:{messageId:r.msgId,packets:s.length,totalSize:n.length,sender:t.sender.username}})}}}return e.length>0&&Cl.debug(`Processed ${Game.market.incomingTransactions.length} terminal transactions, completed ${e.length} messages`),e}static splitMessage(e){if(e.length<=this.MAX_DESCRIPTION_LENGTH)return[e];const t=this.generateMessageId(),r=[],o=this.chunkMessage(e,this.MESSAGE_CHUNK_SIZE),n=o.length-1;for(let e=0;e<o.length;e++){let s;s=0===e?`${t}|${e}|${n}|${o[e]}`:`${t}|${e}|${o[e]}`,r.push(s)}return r}static sendMessage(e,t,r,o,n){const s=this.splitMessage(n);if(1===s.length)return e.send(r,o,t,s[0]);const i=this.extractMessageId(s[0]);return i?(this.queuePackets(e.id,t,r,o,s,i),Cl.info(`Queued ${s.length} packets for multi-packet message`,{meta:{terminalId:e.id,messageId:i,packets:s.length,targetRoom:t}}),OK):(Cl.error("Failed to extract message ID from first packet"),ERR_INVALID_ARGS)}static extractMessageId(e){const t=e.match(/^([\da-zA-Z]{1,3})\|/);return t?t[1]:null}static queuePackets(e,t,r,o,n,s){Memory.ss2PacketQueue||(Memory.ss2PacketQueue={});const i=`${e}:${s}`;Memory.ss2PacketQueue[i]={terminalId:e,targetRoom:t,resourceType:r,amount:o,packets:n,nextPacketIndex:0,queuedAt:Game.time}}static processQueue(){if(!Memory.ss2PacketQueue)return 0;this.cleanupExpiredQueue();let e=0;const t=[],r=Game.cpu.getUsed();for(const[o,n]of Object.entries(Memory.ss2PacketQueue)){if(Game.cpu.getUsed()-r>5){Cl.debug("Queue processing stopped due to CPU budget limit (5 CPU)");break}const s=Game.getObjectById(n.terminalId);if(!s){Cl.warn("Terminal not found for queue item, removing from queue",{meta:{queueKey:o,terminalId:n.terminalId}}),t.push(o);continue}if(s.cooldown>0)continue;const i=n.packets[n.nextPacketIndex];if(!i){Cl.warn(`No packet at index ${n.nextPacketIndex}, removing queue item`,{meta:{queueKey:o}}),t.push(o);continue}const a=s.send(n.resourceType,n.amount,n.targetRoom,i);if(a===OK){if(Memory.ss2PacketQueue[o].nextPacketIndex=n.nextPacketIndex+1,e++,Memory.ss2PacketQueue[o].nextPacketIndex>=n.packets.length){const e=this.extractMessageId(i);Cl.info("Completed sending multi-packet message",{meta:{messageId:e,packets:n.packets.length,targetRoom:n.targetRoom}}),t.push(o)}}else a===ERR_NOT_ENOUGH_RESOURCES?Cl.warn("Not enough resources to send packet, will retry next tick",{meta:{queueKey:o,resource:n.resourceType,amount:n.amount}}):(Cl.error(`Failed to send packet: ${a}, removing queue item`,{meta:{queueKey:o,result:a}}),t.push(o))}for(const e of t)delete Memory.ss2PacketQueue[e];return e>0&&Cl.debug(`Sent ${e} queued packets this tick`),e}static cleanupExpiredQueue(){if(!Memory.ss2PacketQueue)return;const e=Game.time,t=[];for(const[r,o]of Object.entries(Memory.ss2PacketQueue))if(e-o.queuedAt>this.QUEUE_TIMEOUT){const n=this.extractMessageId(o.packets[0]);Cl.warn(`Queue item timed out after ${e-o.queuedAt} ticks`,{meta:{messageId:n,queueKey:r,sentPackets:o.nextPacketIndex,totalPackets:o.packets.length}}),t.push(r)}for(const e of t)delete Memory.ss2PacketQueue[e]}static generateMessageId(){const e=this.MESSAGE_ID_CHARS;let t="",r=this.nextMessageId++;this.nextMessageId<e.length**3||(this.nextMessageId=0);for(let o=0;3>o;o++)t=e[r%e.length]+t,r=Math.floor(r/e.length);return t}static chunkMessage(e,t){const r=[];for(let o=0;o<e.length;o+=t)r.push(e.substring(o,o+t));return r}static cleanupExpiredBuffers(){const e=Game.time;for(const[t,r]of this.messageBuffers.entries())e-r.receivedAt>this.MESSAGE_TIMEOUT&&(Cl.warn("Message timed out",{meta:{messageId:r.msgId,sender:r.sender}}),this.messageBuffers.delete(t))}static parseJSON(e){try{return e.startsWith("{")||e.startsWith("[")?JSON.parse(e):null}catch(e){return Cl.error("Error parsing JSON",{meta:{error:e+""}}),null}}static formatJSON(e){return JSON.stringify(e)}}vl.MAX_DESCRIPTION_LENGTH=100,vl.MESSAGE_CHUNK_SIZE=91,vl.MESSAGE_TIMEOUT=1e3,vl.QUEUE_TIMEOUT=1e3,vl.MESSAGE_ID_CHARS="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",vl.messageBuffers=new Map,vl.nextMessageId=0;const Sl={lowBucketThreshold:2e3,highBucketThreshold:9e3,targetCpuUsage:.8,highFrequencyInterval:1,mediumFrequencyInterval:5,lowFrequencyInterval:20};new class{constructor(e={}){this.tasks=new Map,this.currentMode="normal",this.tickCpuUsed=0,this.config={...Sl,...e}}registerTask(e){this.tasks.set(e.name,{...e,lastRun:0})}unregisterTask(e){this.tasks.delete(e)}getBucketMode(){const e=qe.getBucketMode();return"critical"===e||"low"===e?"low":"high"===e?"high":"normal"}updateBucketMode(){const e=this.getBucketMode();e!==this.currentMode&&(de.info(`Bucket mode changed: ${this.currentMode} -> ${e}`,{subsystem:"Scheduler"}),this.currentMode=e)}getCpuLimit(){const e=Game.cpu.limit;return"low"===this.currentMode?.5*e:e*this.config.targetCpuUsage}hasCpuBudget(){return Game.cpu.getUsed()<this.getCpuLimit()}getRemainingCpu(){return Math.max(0,this.getCpuLimit()-Game.cpu.getUsed())}shouldRunTask(e){const t=Game.time-e.lastRun;return this.getIntervalForFrequency(e.frequency)<=t&&("low"!==this.currentMode||"high"===e.frequency)}getIntervalForFrequency(e){switch(e){case"high":return this.config.highFrequencyInterval;case"medium":return this.config.mediumFrequencyInterval;case"low":return this.config.lowFrequencyInterval}}run(){this.updateBucketMode(),this.tickCpuUsed=0;const e=Array.from(this.tasks.values()).sort((e,t)=>t.priority-e.priority);for(const t of e){if(!this.shouldRunTask(t))continue;const e=Game.cpu.getUsed();if(e+this.getCpuLimit()*t.cpuBudget>this.getCpuLimit()&&"high"!==t.frequency)continue;try{t.execute(),t.lastRun=Game.time}catch(e){const r=e instanceof Error?e.message:e+"";de.error(`Task ${t.name} failed: ${r}`,{subsystem:"Scheduler"})}const r=Game.cpu.getUsed()-e;if(this.tickCpuUsed+=r,!this.hasCpuBudget()){de.warn("CPU budget exhausted, skipping remaining tasks",{subsystem:"Scheduler"});break}}}getTickCpuUsed(){return this.tickCpuUsed}getCurrentMode(){return this.currentMode}getTasks(){return Array.from(this.tasks.values())}},FIND_STRUCTURES,FIND_MY_STRUCTURES,FIND_HOSTILE_STRUCTURES,FIND_SOURCES_ACTIVE,FIND_SOURCES,FIND_MINERALS,FIND_DEPOSITS,FIND_MY_CONSTRUCTION_SITES,FIND_CONSTRUCTION_SITES,FIND_CREEPS,FIND_MY_CREEPS,FIND_HOSTILE_CREEPS,FIND_DROPPED_RESOURCES,FIND_TOMBSTONES,FIND_RUINS,FIND_FLAGS,FIND_MY_SPAWNS,FIND_HOSTILE_SPAWNS,FIND_HOSTILE_CONSTRUCTION_SITES,FIND_NUKES,FIND_POWER_CREEPS,FIND_MY_POWER_CREEPS,FIND_HOSTILE_POWER_CREEPS,FIND_EXIT_TOP,FIND_EXIT_RIGHT,FIND_EXIT_BOTTOM,FIND_EXIT_LEFT,FIND_EXIT;const _l=new Di.RoomVisualizer({},Wt),bl=new Di.MapVisualizer({},Wt);let Ol=!1,Ul=!1;function Ml(){if(!_e().visualizations)return;const e=null!==(t=Ze.get("ownedRooms",{namespace:"game",ttl:1,compute:()=>Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my})}))&&void 0!==t?t:[];var t;for(const t of e)try{_l.draw(t)}catch(e){const r=e instanceof Error?e.message:e+"";de.error(`Visualization error in ${t.name}: ${r}`,{subsystem:"visualizations",room:t.name})}try{bl.draw()}catch(e){const t=e instanceof Error?e.message:e+"";de.error("Map visualization error: "+t,{subsystem:"visualizations"})}}class Al{status(e){var t,r;const o=yi.getConfig(e);if(!o)return"No lab configuration for "+e;let n=`=== Lab Status: ${e} ===\n`;n+=`Valid: ${o.isValid}\n`,n+=`Labs: ${o.labs.length}\n`,n+=`Last Update: ${Game.time-o.lastUpdate} ticks ago\n\n`,o.activeReaction&&(n+="Active Reaction:\n",n+=`  ${o.activeReaction.input1} + ${o.activeReaction.input2}  ${o.activeReaction.output}\n\n`),n+="Lab Assignments:\n";for(const e of o.labs){const o=Game.getObjectById(e.labId),s=null!==(t=null==o?void 0:o.mineralType)&&void 0!==t?t:"empty",i=null!==(r=null==o?void 0:o.store[s])&&void 0!==r?r:0;n+=`  ${e.role}: ${s} (${i}) @ (${e.pos.x},${e.pos.y})\n`}const s=ua.getLabResourceNeeds(e);if(s.length>0){n+="\nResource Needs:\n";for(const e of s)n+=`  ${e.resourceType}: ${e.amount} (priority ${e.priority})\n`}const i=ua.getLabOverflow(e);if(i.length>0){n+="\nOverflow (needs emptying):\n";for(const e of i)n+=`  ${e.resourceType}: ${e.amount} (priority ${e.priority})\n`}return n}setReaction(e,t,r,o){return ua.setActiveReaction(e,t,r,o)?`Set active reaction: ${t} + ${r}  ${o}`:"Failed to set reaction (check lab configuration)"}clear(e){return ua.clearReactions(e),"Cleared active reactions in "+e}boost(e,t){const r=Game.rooms[e];if(!r)return`Room ${e} not visible`;const o=kc.areBoostLabsReady(r,t),n=kc.getMissingBoosts(r,t);let s=`=== Boost Status: ${e} / ${t} ===\n`;if(s+=`Ready: ${o}\n`,n.length>0){s+="\nMissing Boosts:\n";for(const e of n)s+=`  - ${e}\n`}else s+="\nAll boosts ready!";return s}}Q([he({name:"labs.status",description:"Get lab status for a room",usage:"labs.status(roomName)",examples:["labs.status('E1S1')"],category:"Labs"})],Al.prototype,"status",null),Q([he({name:"labs.setReaction",description:"Set active reaction for a room",usage:"labs.setReaction(roomName, input1, input2, output)",examples:["labs.setReaction('E1S1', RESOURCE_HYDROGEN, RESOURCE_OXYGEN, RESOURCE_HYDROXIDE)"],category:"Labs"})],Al.prototype,"setReaction",null),Q([he({name:"labs.clear",description:"Clear active reaction for a room",usage:"labs.clear(roomName)",examples:["labs.clear('E1S1')"],category:"Labs"})],Al.prototype,"clear",null),Q([he({name:"labs.boost",description:"Check boost lab readiness for a role",usage:"labs.boost(roomName, role)",examples:["labs.boost('E1S1', 'soldier')"],category:"Labs"})],Al.prototype,"boost",null);class wl{data(e){const t=Game.market.getHistory(e);if(!t||0===t.length)return"No market history for "+e;const r=t[t.length-1];let o=`=== Market Data: ${e} ===\n`;if(o+=`Current Price: ${r.avgPrice.toFixed(3)} credits\n`,o+=`Volume: ${r.volume}\n`,o+=`Transactions: ${r.transactions}\n`,o+=`Date: ${r.date}\n`,t.length>=5){const e=t[t.length-5],n=(r.avgPrice-e.avgPrice)/e.avgPrice*100;o+=`\nTrend (5 days): ${n>5?" Rising":-5>n?" Falling":" Stable"} (${0>n?"":"+"}${n.toFixed(1)}%)\n`}return o}orders(){var e,t,r;const o=Object.values(Game.market.orders);if(0===o.length)return"No active market orders";let n=`=== Active Market Orders (${o.length}) ===\n`;n+="Type | Resource | Price | Remaining | Room\n",n+="-".repeat(70)+"\n";for(const s of o){const o=s.type===ORDER_BUY?"BUY ":"SELL",i=s.price.toFixed(3),a=null!==(t=null===(e=s.remainingAmount)||void 0===e?void 0:e.toString())&&void 0!==t?t:"?";n+=`${o} | ${s.resourceType} | ${i} | ${a} | ${null!==(r=s.roomName)&&void 0!==r?r:"N/A"}\n`}return n}profit(){let e="=== Market Profit ===\n";return e+=`Credits: ${Game.market.credits.toLocaleString()}\n`,e+="\nNote: Detailed profit tracking requires memory access\n",e}}Q([he({name:"market.data",description:"Get market data for a resource",usage:"market.data(resource)",examples:["market.data(RESOURCE_ENERGY)","market.data(RESOURCE_GHODIUM)"],category:"Market"})],wl.prototype,"data",null),Q([he({name:"market.orders",description:"List your active market orders",usage:"market.orders()",examples:["market.orders()"],category:"Market"})],wl.prototype,"orders",null),Q([he({name:"market.profit",description:"Show market trading profit statistics",usage:"market.profit()",examples:["market.profit()"],category:"Market"})],wl.prototype,"profit",null);class kl{gpl(){const e=Bs.getGPLState();if(!e)return"GPL tracking not available (no power unlocked)";let t="=== GPL Status ===\n";return t+=`Level: ${e.currentLevel}\n`,t+=`Progress: ${e.currentProgress} / ${e.progressNeeded}\n`,t+=`Completion: ${(e.currentProgress/e.progressNeeded*100).toFixed(1)}%\n`,t+=`Target Milestone: ${e.targetMilestone}\n`,t+=`Estimated Time: ${e.ticksToNextLevel===1/0?"N/A (no progress yet)":e.ticksToNextLevel.toLocaleString()+" ticks"}\n`,t+=`\nTotal Power Processed: ${e.totalPowerProcessed.toLocaleString()}\n`,t}creeps(){const e=Bs.getAssignments();if(0===e.length)return"No power creeps created yet";let t=`=== Power Creeps (${e.length}) ===\n`;t+="Name | Role | Room | Level | Spawned\n",t+="-".repeat(70)+"\n";for(const r of e){const e=r.spawned?"":"";t+=`${r.name} | ${r.role} | ${r.assignedRoom} | ${r.level} | ${e}\n`}return t}operations(){const e=$s.getActiveOperations();if(0===e.length)return"No active power bank operations";let t=`=== Power Bank Operations (${e.length}) ===\n`;for(const r of e)t+=`\nRoom: ${r.roomName}\n`,t+=`Power: ${r.power}\n`,t+=`State: ${r.state}\n`,t+=`Home: ${r.homeRoom}\n`,t+=`Attackers: ${r.assignedCreeps.attackers.length}\n`,t+=`Healers: ${r.assignedCreeps.healers.length}\n`,t+=`Carriers: ${r.assignedCreeps.carriers.length}\n`,t+=`Damage: ${Math.round(r.damageDealt/1e3)}k / 2000k\n`,t+=`Collected: ${r.powerCollected}\n`,t+=`Decay: ${r.decayTick-Game.time} ticks\n`;return t}assign(e,t){return Bs.reassignPowerCreep(e,t)?`Reassigned ${e} to ${t}`:`Failed to reassign ${e} (not found)`}create(e,t){const r="string"==typeof t&&"operator"===t.toLowerCase()?POWER_CLASS.OPERATOR:t;if(Game.powerCreeps[e])return`Power creep "${e}" already exists`;if(!Game.gpl||1>Game.gpl.level)return"GPL level too low (need GPL 1+)";const o=Object.keys(Game.powerCreeps).length;if(o>=Game.gpl.level)return`Cannot create power creep: ${o}/${Game.gpl.level} already created`;const n=PowerCreep.create(e,r);return n===OK?`Created power creep "${e}" (${r})`:"Failed to create power creep: "+n}spawn(e,t){var r;const o=Game.powerCreeps[e];if(!o)return`Power creep "${e}" not found`;if(void 0!==o.ticksToLive)return`Power creep "${e}" is already spawned (TTL: ${o.ticksToLive})`;const n=o.memory,s=null!==(r=null!=t?t:n.homeRoom)&&void 0!==r?r:Object.keys(Game.rooms)[0],i=Game.rooms[s];if(!i)return`Room "${s}" not visible`;const a=i.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_POWER_SPAWN})[0];if(!a)return"No power spawn found in "+s;const c=o.spawn(a);return c===OK?`Spawned power creep "${e}" at ${s}`:"Failed to spawn power creep: "+c}upgrade(e,t){const r=Game.powerCreeps[e];if(!r)return`Power creep "${e}" not found`;if(r.powers[t])return`Power creep "${e}" already has ${t}`;if(!POWER_INFO[t])return"Invalid power: "+t;if(r.level>=Game.gpl.level)return`Power creep is already at max level (${r.level}/${Game.gpl.level})`;const o=r.upgrade(t);return o===OK?`Upgraded ${e} to level ${r.level} with ${t}`:"Failed to upgrade: "+o}}Q([he({name:"power.gpl",description:"Show GPL (Global Power Level) status",usage:"power.gpl()",examples:["power.gpl()"],category:"Power"})],kl.prototype,"gpl",null),Q([he({name:"power.creeps",description:"List power creeps and their assignments",usage:"power.creeps()",examples:["power.creeps()"],category:"Power"})],kl.prototype,"creeps",null),Q([he({name:"power.operations",description:"List active power bank operations",usage:"power.operations()",examples:["power.operations()"],category:"Power"})],kl.prototype,"operations",null),Q([he({name:"power.assign",description:"Reassign a power creep to a different room",usage:"power.assign(powerCreepName, roomName)",examples:["power.assign('operator_eco', 'E2S2')"],category:"Power"})],kl.prototype,"assign",null),Q([he({name:"power.create",description:"Manually create a new power creep (automatic creation is also enabled)",usage:"power.create(name, className)",examples:["power.create('operator_eco', POWER_CLASS.OPERATOR)","power.create('my_operator', 'operator')"],category:"Power"})],kl.prototype,"create",null),Q([he({name:"power.spawn",description:"Manually spawn a power creep at a power spawn",usage:"power.spawn(powerCreepName, roomName?)",examples:["power.spawn('operator_eco')","power.spawn('operator_eco', 'E2S2')"],category:"Power"})],kl.prototype,"spawn",null),Q([he({name:"power.upgrade",description:"Manually upgrade a power creep with a specific power",usage:"power.upgrade(powerCreepName, power)",examples:["power.upgrade('operator_eco', PWR_OPERATE_SPAWN)","power.upgrade('operator_eco', PWR_OPERATE_TOWER)"],category:"Power"})],kl.prototype,"upgrade",null);const Nl=new Al,Pl=new wl,Il=new kl;class xl{status(){var e,t;const r=null!==(t=null===(e=Game.shard)||void 0===e?void 0:e.name)&&void 0!==t?t:"shard0",o=Sr.getCurrentShardState();if(!o)return"No shard state found for "+r;const n=o.health,s=[`=== Shard Status: ${r} ===`,"Role: "+o.role.toUpperCase(),`Rooms: ${n.roomCount} (Avg RCL: ${n.avgRCL})`,"Creeps: "+n.creepCount,`CPU: ${n.cpuCategory.toUpperCase()} (${Math.round(100*n.cpuUsage)}%)`,"Bucket: "+n.bucketLevel,`Economy Index: ${n.economyIndex}%`,`War Index: ${n.warIndex}%`,"Portals: "+o.portals.length,"Active Tasks: "+o.activeTasks.length,"Last Update: "+n.lastUpdate];return o.cpuLimit&&s.push("CPU Limit: "+o.cpuLimit),s.join("\n")}all(){const e=Sr.getAllShards();if(0===e.length)return"No shards tracked yet";const t=["=== All Shards ==="];for(const r of e){const e=r.health;t.push(`${r.name} [${r.role}]: ${e.roomCount} rooms, RCL ${e.avgRCL}, CPU ${e.cpuCategory} (${Math.round(100*e.cpuUsage)}%), Eco ${e.economyIndex}%, War ${e.warIndex}%`)}return t.join("\n")}setRole(e){const t=["core","frontier","resource","backup","war"];return t.includes(e)?(Sr.setShardRole(e),"Shard role set to: "+e.toUpperCase()):`Invalid role: ${e}. Valid roles: ${t.join(", ")}`}portals(e){var t,r,o;const n=null!==(r=null===(t=Game.shard)||void 0===t?void 0:t.name)&&void 0!==r?r:"shard0",s=Sr.getCurrentShardState();if(!s)return"No shard state found for "+n;let i=s.portals;if(e&&(i=i.filter(t=>t.targetShard===e)),0===i.length)return e?"No portals to "+e:"No portals discovered yet";const a=[e?`=== Portals to ${e} ===`:"=== All Portals ==="];for(const e of i){const t=e.isStable?"":"",r="".repeat(e.threatRating),n=null!==(o=e.traversalCount)&&void 0!==o?o:0,s=Game.time-e.lastScouted;a.push(`${e.sourceRoom}  ${e.targetShard}/${e.targetRoom} [${t}] ${r||""} (${n} uses, ${s}t ago)`)}return a.join("\n")}bestPortal(e,t){var r;const o=Sr.getOptimalPortalRoute(e,t);if(!o)return"No portal found to "+e;const n=o.isStable?"Stable":"Unstable",s=o.threatRating>0?` (Threat: ${o.threatRating})`:"";return`Best portal to ${e}:\n  Source: ${o.sourceRoom} (${o.sourcePos.x},${o.sourcePos.y})\n  Target: ${o.targetShard}/${o.targetRoom}\n  Status: ${n}${s}\n  Traversals: ${null!==(r=o.traversalCount)&&void 0!==r?r:0}\n  Last Scouted: ${Game.time-o.lastScouted} ticks ago`}createTask(e,t,r,o=50){const n=["colonize","reinforce","transfer","evacuate"];return n.includes(e)?(Sr.createTask(e,t,r,o),`Created ${e} task to ${t}${r?"/"+r:""} (priority: ${o})`):`Invalid task type: ${e}. Valid types: ${n.join(", ")}`}transferResource(e,t,r,o,n=50){return Sr.createResourceTransferTask(e,t,r,o,n),`Created resource transfer task:\n  ${o} ${r}  ${e}/${t}\n  Priority: `+n}transfers(){const e=_r.getActiveRequests();if(0===e.length)return"No active resource transfers";const t=["=== Active Resource Transfers ==="];for(const r of e){const e=Math.round(r.transferred/r.amount*100),o=r.assignedCreeps.length;t.push(`${r.taskId}: ${r.amount} ${r.resourceType}\n  ${r.sourceRoom}  ${r.targetShard}/${r.targetRoom}\n  Status: ${r.status.toUpperCase()} (${e}%)\n  Creeps: ${o}, Priority: ${r.priority}`)}return t.join("\n")}cpuHistory(){const e=Sr.getCurrentShardState();if(!e||!e.cpuHistory||0===e.cpuHistory.length)return"No CPU history available";const t=["=== CPU Allocation History ==="];for(const r of e.cpuHistory.slice(-10)){const e=Math.round(r.cpuUsed/r.cpuLimit*100);t.push(`Tick ${r.tick}: ${r.cpuUsed.toFixed(2)}/${r.cpuLimit} (${e}%) Bucket: `+r.bucketLevel)}return t.join("\n")}tasks(){var e;const t=Sr.getActiveTransferTasks();if(0===t.length)return"No active inter-shard tasks";const r=["=== Inter-Shard Tasks ==="];for(const o of t){const t=null!==(e=o.progress)&&void 0!==e?e:0;r.push(`${o.id} [${o.type.toUpperCase()}]\n  ${o.sourceShard}  ${o.targetShard}${o.targetRoom?"/"+o.targetRoom:""}\n  Status: ${o.status.toUpperCase()} (${t}%)\n  Priority: `+o.priority)}return r.join("\n")}syncStatus(){const e=Sr.getSyncStatus();return`=== InterShardMemory Sync Status ===\nStatus: ${e.isHealthy?" HEALTHY":" DEGRADED"}\nLast Sync: ${e.lastSync} (${e.ticksSinceSync} ticks ago)\nMemory Usage: ${e.memorySize} / 102400 bytes (${e.sizePercent}%)\nShards Tracked: ${e.shardsTracked}\nActive Tasks: ${e.activeTasks}\nTotal Portals: `+e.totalPortals}memoryStats(){const e=Sr.getMemoryStats();return`=== InterShardMemory Usage ===\nTotal: ${e.size} / ${e.limit} bytes (${e.percent}%)\n\nBreakdown:\n  Shards: ${e.breakdown.shards} bytes\n  Tasks: ${e.breakdown.tasks} bytes\n  Portals: ${e.breakdown.portals} bytes\n  Other: ${e.breakdown.other} bytes`}forceSync(){return Sr.forceSync(),"InterShardMemory sync forced. Check logs for results."}}Q([he({name:"shard.status",description:"Display current shard status and metrics",usage:"shard.status()",examples:["shard.status()"],category:"Shard"})],xl.prototype,"status",null),Q([he({name:"shard.all",description:"List all known shards with summary info",usage:"shard.all()",examples:["shard.all()"],category:"Shard"})],xl.prototype,"all",null),Q([he({name:"shard.setRole",description:"Manually set the role for the current shard",usage:"shard.setRole(role)",examples:["shard.setRole('core')","shard.setRole('frontier')","shard.setRole('resource')","shard.setRole('backup')","shard.setRole('war')"],category:"Shard"})],xl.prototype,"setRole",null),Q([he({name:"shard.portals",description:"List all known portals from the current shard",usage:"shard.portals(targetShard?)",examples:["shard.portals()","shard.portals('shard1')"],category:"Shard"})],xl.prototype,"portals",null),Q([he({name:"shard.bestPortal",description:"Find the optimal portal route to a target shard",usage:"shard.bestPortal(targetShard, fromRoom?)",examples:["shard.bestPortal('shard1')","shard.bestPortal('shard2', 'E1N1')"],category:"Shard"})],xl.prototype,"bestPortal",null),Q([he({name:"shard.createTask",description:"Create a cross-shard task",usage:"shard.createTask(type, targetShard, targetRoom?, priority?)",examples:["shard.createTask('colonize', 'shard1', 'E5N5', 80)","shard.createTask('reinforce', 'shard2', 'W1N1', 90)","shard.createTask('evacuate', 'shard0', 'E1N1', 100)"],category:"Shard"})],xl.prototype,"createTask",null),Q([he({name:"shard.transferResource",description:"Create a cross-shard resource transfer task",usage:"shard.transferResource(targetShard, targetRoom, resourceType, amount, priority?)",examples:["shard.transferResource('shard1', 'E5N5', 'energy', 50000, 70)","shard.transferResource('shard2', 'W1N1', 'U', 5000, 80)"],category:"Shard"})],xl.prototype,"transferResource",null),Q([he({name:"shard.transfers",description:"List active cross-shard resource transfers",usage:"shard.transfers()",examples:["shard.transfers()"],category:"Shard"})],xl.prototype,"transfers",null),Q([he({name:"shard.cpuHistory",description:"Display CPU allocation history for the current shard",usage:"shard.cpuHistory()",examples:["shard.cpuHistory()"],category:"Shard"})],xl.prototype,"cpuHistory",null),Q([he({name:"shard.tasks",description:"List all inter-shard tasks",usage:"shard.tasks()",examples:["shard.tasks()"],category:"Shard"})],xl.prototype,"tasks",null),Q([he({name:"shard.syncStatus",description:"Display InterShardMemory sync status and health",usage:"shard.syncStatus()",examples:["shard.syncStatus()"],category:"Shard"})],xl.prototype,"syncStatus",null),Q([he({name:"shard.memoryStats",description:"Display InterShardMemory size breakdown",usage:"shard.memoryStats()",examples:["shard.memoryStats()"],category:"Shard"})],xl.prototype,"memoryStats",null),Q([he({name:"shard.forceSync",description:"Force a full InterShardMemory sync with validation",usage:"shard.forceSync()",examples:["shard.forceSync()"],category:"Shard"})],xl.prototype,"forceSync",null);const $l=new xl,Gl={maxPredictionTicks:100,safetyMargin:.9,enableLogging:!1},Ll=new class{constructor(e={}){this.config={...Gl,...e}}predictEnergyInTicks(e,t){if(0>t)throw Error("Cannot predict negative ticks");t>this.config.maxPredictionTicks&&(de.warn(`Prediction horizon ${t} exceeds max ${this.config.maxPredictionTicks}, clamping`,{subsystem:"EnergyFlowPredictor"}),t=this.config.maxPredictionTicks);const r=this.calculateEnergyIncome(e),o=this.calculateEnergyConsumption(e),n=e.energyAvailable,s=r.total*this.config.safetyMargin-o.total,i=Math.max(0,n+s*t),a={current:n,predicted:i,income:r,consumption:o,netFlow:s,ticks:t};return this.config.enableLogging&&de.debug(`Energy prediction for ${e.name}: ${n}  ${i} (${t} ticks, ${s.toFixed(2)}/tick)`,{subsystem:"EnergyFlowPredictor"}),a}calculateEnergyIncome(e){const t=this.calculateHarvesterIncome(e),r=this.calculateMinerIncome(e),o=this.calculateLinkIncome(e);return{harvesters:t,miners:r,links:o,total:t+r+o}}calculateEnergyConsumption(e){const t=this.calculateUpgraderConsumption(e),r=this.calculateBuilderConsumption(e),o=this.calculateTowerConsumption(e),n=this.calculateSpawningConsumption(e),s=this.calculateRepairConsumption(e);return{upgraders:t,builders:r,towers:o,spawning:n,repairs:s,total:t+r+o+n+s}}calculateHarvesterIncome(e){const t=e.find(FIND_MY_CREEPS,{filter:e=>"harvester"===e.memory.role||"larvaWorker"===e.memory.role});let r=0;for(const e of t)r+=e.body.filter(e=>e.type===WORK&&e.hits>0).length;return 1*r}calculateMinerIncome(e){const t=e.find(FIND_MY_CREEPS,{filter:e=>"staticMiner"===e.memory.role||"miner"===e.memory.role});let r=0;for(const e of t)r+=e.body.filter(e=>e.type===WORK&&e.hits>0).length;return 1.8*r}calculateLinkIncome(e){return 0}calculateUpgraderConsumption(e){const t=e.find(FIND_MY_CREEPS,{filter:e=>"upgrader"===e.memory.role});let r=0;for(const e of t)r+=e.body.filter(e=>e.type===WORK&&e.hits>0).length;return.7*r}calculateBuilderConsumption(e){const t=e.find(FIND_MY_CREEPS,{filter:e=>"builder"===e.memory.role||"repairer"===e.memory.role});if(0===e.find(FIND_MY_CONSTRUCTION_SITES).length)return.1;let r=0;for(const e of t)r+=e.body.filter(e=>e.type===WORK&&e.hits>0).length;return 2.5*r}calculateTowerConsumption(e){const t=e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_TOWER});return 0===t.length?0:6*t.length}calculateSpawningConsumption(e){const t=e.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_SPAWN});if(0===t.length)return 0;const r=e.controller;let o=500;if(r&&r.my){const e=r.level;o=e>3?e>6?1500:750:300}const n=o/20;return t.length*n*.8}calculateRepairConsumption(e){return.5}getRecommendedSpawnDelay(e,t){const r=e.energyAvailable;if(r>=t)return 0;const o=this.predictEnergyInTicks(e,1);if(0>=o.netFlow)return 999;const n=Math.ceil((t-r)/o.netFlow);return Math.min(n,this.config.maxPredictionTicks)}canAffordInTicks(e,t,r){return this.predictEnergyInTicks(e,r).predicted>=t}getMaxAffordableInTicks(e,t){const r=this.predictEnergyInTicks(e,t);return Math.min(r.predicted,e.energyCapacityAvailable)}setConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}};class Dl{predictEnergy(e,t=50){const r=Game.rooms[e];if(!r)return`Room ${e} is not visible`;if(!r.controller||!r.controller.my)return`Room ${e} is not owned by you`;const o=Ll.predictEnergyInTicks(r,t);let n=`=== Energy Prediction: ${e} ===\n`;return n+=`Current Energy: ${o.current}\n`,n+=`Predicted (${t} ticks): ${Math.round(o.predicted)}\n`,n+=`Net Flow: ${o.netFlow.toFixed(2)} energy/tick\n\n`,n+="Income Breakdown (per tick):\n",n+=`  Harvesters: ${o.income.harvesters.toFixed(2)}\n`,n+=`  Static Miners: ${o.income.miners.toFixed(2)}\n`,n+=`  Links: ${o.income.links.toFixed(2)}\n`,n+=`  Total: ${o.income.total.toFixed(2)}\n\n`,n+="Consumption Breakdown (per tick):\n",n+=`  Upgraders: ${o.consumption.upgraders.toFixed(2)}\n`,n+=`  Builders: ${o.consumption.builders.toFixed(2)}\n`,n+=`  Towers: ${o.consumption.towers.toFixed(2)}\n`,n+=`  Spawning: ${o.consumption.spawning.toFixed(2)}\n`,n+=`  Repairs: ${o.consumption.repairs.toFixed(2)}\n`,n+=`  Total: ${o.consumption.total.toFixed(2)}\n`,n}showIncome(e){const t=Game.rooms[e];if(!t)return`Room ${e} is not visible`;const r=Ll.calculateEnergyIncome(t);let o=`=== Energy Income: ${e} ===\n`;return o+=`Harvesters: ${r.harvesters.toFixed(2)} energy/tick\n`,o+=`Static Miners: ${r.miners.toFixed(2)} energy/tick\n`,o+=`Links: ${r.links.toFixed(2)} energy/tick\n`,o+=`Total: ${r.total.toFixed(2)} energy/tick\n`,o}showConsumption(e){const t=Game.rooms[e];if(!t)return`Room ${e} is not visible`;const r=Ll.calculateEnergyConsumption(t);let o=`=== Energy Consumption: ${e} ===\n`;return o+=`Upgraders: ${r.upgraders.toFixed(2)} energy/tick\n`,o+=`Builders: ${r.builders.toFixed(2)} energy/tick\n`,o+=`Towers: ${r.towers.toFixed(2)} energy/tick\n`,o+=`Spawning: ${r.spawning.toFixed(2)} energy/tick\n`,o+=`Repairs: ${r.repairs.toFixed(2)} energy/tick\n`,o+=`Total: ${r.total.toFixed(2)} energy/tick\n`,o}canAfford(e,t,r=50){const o=Game.rooms[e];if(!o)return`Room ${e} is not visible`;const n=Ll.canAffordInTicks(o,t,r),s=Ll.predictEnergyInTicks(o,r);if(n)return` Room ${e} CAN afford ${t} energy within ${r} ticks (predicted: ${Math.round(s.predicted)})`;{const n=Ll.getRecommendedSpawnDelay(o,t);return 999>n?` Room ${e} CANNOT afford ${t} energy within ${r} ticks (would need ${n} ticks)`:` Room ${e} CANNOT afford ${t} energy (negative energy flow)`}}getSpawnDelay(e,t){const r=Game.rooms[e];if(!r)return`Room ${e} is not visible`;const o=Ll.getRecommendedSpawnDelay(r,t),n=r.energyAvailable;if(0===o)return` Room ${e} can spawn ${t} energy body NOW (current: ${n})`;if(999>o){const s=Ll.predictEnergyInTicks(r,o);return`Room ${e} needs to wait ${o} ticks to spawn ${t} energy body (current: ${n}, predicted: ${Math.round(s.predicted)})`}return` Room ${e} has negative energy flow, cannot spawn ${t} energy body`}}Q([he({name:"economy.energy.predict",description:"Predict energy availability for a room in N ticks",usage:"economy.energy.predict(roomName, ticks)",examples:["economy.energy.predict('W1N1', 50)","economy.energy.predict('E1S1', 100)"],category:"Economy"})],Dl.prototype,"predictEnergy",null),Q([he({name:"economy.energy.income",description:"Show energy income breakdown for a room",usage:"economy.energy.income(roomName)",examples:["economy.energy.income('W1N1')"],category:"Economy"})],Dl.prototype,"showIncome",null),Q([he({name:"economy.energy.consumption",description:"Show energy consumption breakdown for a room",usage:"economy.energy.consumption(roomName)",examples:["economy.energy.consumption('W1N1')"],category:"Economy"})],Dl.prototype,"showConsumption",null),Q([he({name:"economy.energy.canAfford",description:"Check if a room can afford a certain energy cost within N ticks",usage:"economy.energy.canAfford(roomName, cost, ticks)",examples:["economy.energy.canAfford('W1N1', 1000, 50)","economy.energy.canAfford('E1S1', 500, 25)"],category:"Economy"})],Dl.prototype,"canAfford",null),Q([he({name:"economy.energy.spawnDelay",description:"Get recommended spawn delay for a body cost",usage:"economy.energy.spawnDelay(roomName, cost)",examples:["economy.energy.spawnDelay('W1N1', 1000)","economy.energy.spawnDelay('E1S1', 500)"],category:"Economy"})],Dl.prototype,"getSpawnDelay",null);const Fl=new Dl;class Bl{status(){var e,t,r,o;const n=Wt.getEmpire(),s=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my}),i=(Game.gcl.progress/Game.gcl.progressTotal*100).toFixed(1),a=Game.gcl.level-s.length,c=a>0,l=n.objectives.expansionPaused,u=n.claimQueue.length,m=n.claimQueue.filter(e=>!e.claimed).length,d=n.claimQueue.filter(e=>e.claimed).length,p=Object.values(Game.creeps).filter(e=>{const t=e.memory;return"claimer"===t.role&&"claim"===t.task});let g=`=== Expansion System Status ===\n\nGCL: Level ${Game.gcl.level} (${i}% to next)\nOwned Rooms: ${s.length}/${Game.gcl.level}\nAvailable Room Slots: ${a}\n\nExpansion Status: ${l?"PAUSED ":c?"READY ":"AT GCL LIMIT"}\nClaim Queue: ${u} total (${m} unclaimed, ${d} in progress)\nActive Claimers: ${p.length}\n\n`;if(m>0){g+="=== Top Expansion Candidates ===\n";const e=n.claimQueue.filter(e=>!e.claimed).slice(0,5);for(const t of e){const e=Game.time-t.lastEvaluated;g+=`  ${t.roomName}: Score ${t.score.toFixed(0)}, Distance ${t.distance}, Age ${e} ticks\n`}g+="\n"}if(d>0){g+="=== Active Expansion Attempts ===\n";const e=n.claimQueue.filter(e=>e.claimed);for(const t of e){const e=Game.time-t.lastEvaluated,r=p.find(e=>e.memory.targetRoom===t.roomName),o=r?r.name+" en route":"No claimer assigned";g+=`  ${t.roomName}: ${o}, Age ${e} ticks\n`}g+="\n"}g+="=== Owned Room Distribution ===\n";const f=new Map;for(const o of s){const n=null!==(t=null===(e=o.controller)||void 0===e?void 0:e.level)&&void 0!==t?t:0;f.set(n,(null!==(r=f.get(n))&&void 0!==r?r:0)+1)}for(let e=8;e>=1;e--){const t=null!==(o=f.get(e))&&void 0!==o?o:0;t>0&&(g+=`  RCL ${e}: ${"".repeat(t)} (${t})\n`)}return g}pause(){return Wt.getEmpire().objectives.expansionPaused=!0,"Expansion paused. Use expansion.resume() to re-enable."}resume(){return Wt.getEmpire().objectives.expansionPaused=!1,"Expansion resumed."}addRemote(e,t){return Cs.addRemoteRoom(e,t)?`Added remote ${t} to ${e}`:"Failed to add remote (check logs for details)"}removeRemote(e,t){return Cs.removeRemoteRoom(e,t)?`Removed remote ${t} from ${e}`:`Remote ${t} not found in ${e}`}clearQueue(){const e=Wt.getEmpire(),t=e.claimQueue.length;return e.claimQueue=[],`Cleared ${t} candidates from claim queue. Queue will repopulate on next empire tick.`}}Q([he({name:"expansion.status",description:"Show expansion system status, GCL progress, and claim queue",usage:"expansion.status()",examples:["expansion.status()"],category:"Empire"})],Bl.prototype,"status",null),Q([he({name:"expansion.pause",description:"Pause autonomous expansion",usage:"expansion.pause()",examples:["expansion.pause()"],category:"Empire"})],Bl.prototype,"pause",null),Q([he({name:"expansion.resume",description:"Resume autonomous expansion",usage:"expansion.resume()",examples:["expansion.resume()"],category:"Empire"})],Bl.prototype,"resume",null),Q([he({name:"expansion.addRemote",description:"Manually add a remote room assignment",usage:"expansion.addRemote(homeRoom, remoteRoom)",examples:["expansion.addRemote('W1N1', 'W2N1')"],category:"Empire"})],Bl.prototype,"addRemote",null),Q([he({name:"expansion.removeRemote",description:"Manually remove a remote room assignment",usage:"expansion.removeRemote(homeRoom, remoteRoom)",examples:["expansion.removeRemote('W1N1', 'W2N1')"],category:"Empire"})],Bl.prototype,"removeRemote",null),Q([he({name:"expansion.clearQueue",description:"Clear the expansion claim queue",usage:"expansion.clearQueue()",examples:["expansion.clearQueue()"],category:"Empire"})],Bl.prototype,"clearQueue",null);const Hl=new Bl,Wl={status:()=>pi.getStatus(),enable:()=>(pi.enable(),"TooAngel integration enabled"),disable:()=>(pi.disable(),"TooAngel integration disabled"),reputation:()=>"Current TooAngel reputation: "+ti(),requestReputation:e=>oi(e)?"Reputation request sent"+(e?" from "+e:""):"Failed to send reputation request (check logs for details)",quests:()=>{var e;const t=ii(),r=["Active Quests:"];if(0===Object.keys(t).length)r.push("  No active quests");else for(const o in t){const n=t[o],s=n.deadline-Game.time,i=(null===(e=n.assignedCreeps)||void 0===e?void 0:e.length)||0;r.push(`  ${o}:`),r.push("    Type: "+n.type),r.push("    Target: "+n.targetRoom),r.push("    Status: "+n.status),r.push(`    Time left: ${s} ticks`),r.push("    Assigned creeps: "+i)}return r.join("\n")},npcs:()=>{const e=Zs(),t=["TooAngel NPC Rooms:"];if(0===Object.keys(e).length)t.push("  No NPC rooms discovered");else for(const r in e){const o=e[r];t.push(`  ${r}:`),t.push("    Has terminal: "+o.hasTerminal),t.push("    Available quests: "+o.availableQuests.length),t.push(`    Last seen: ${Game.time-o.lastSeen} ticks ago`)}return t.join("\n")},apply:(e,t,r)=>li(e,t,r)?`Applied for quest ${e}${r?" from "+r:""}`:"Failed to apply for quest (check logs for details)",help:()=>"TooAngel Console Commands:\n\n  tooangel.status()                    - Show current status\n  tooangel.enable()                    - Enable integration\n  tooangel.disable()                   - Disable integration\n  tooangel.reputation()                - Get current reputation\n  tooangel.requestReputation(fromRoom) - Request reputation update\n  tooangel.quests()                    - List active quests\n  tooangel.npcs()                      - List discovered NPC rooms\n  tooangel.apply(id, origin, fromRoom) - Apply for a quest\n  tooangel.help()                      - Show this help"};class Yl{status(){const e=Mt.checkMemoryUsage(),t=e.breakdown;let r=`Memory Status: ${e.status.toUpperCase()}\n`;return r+=`Usage: ${Mt.formatBytes(e.used)} / ${Mt.formatBytes(e.limit)} (${(100*e.percentage).toFixed(1)}%)\n\n`,r+="Breakdown:\n",r+=`  Empire:        ${Mt.formatBytes(t.empire)} (${(t.empire/t.total*100).toFixed(1)}%)\n`,r+=`  Rooms:         ${Mt.formatBytes(t.rooms)} (${(t.rooms/t.total*100).toFixed(1)}%)\n`,r+=`  Creeps:        ${Mt.formatBytes(t.creeps)} (${(t.creeps/t.total*100).toFixed(1)}%)\n`,r+=`  Clusters:      ${Mt.formatBytes(t.clusters)} (${(t.clusters/t.total*100).toFixed(1)}%)\n`,r+=`  SS2 Queue:     ${Mt.formatBytes(t.ss2PacketQueue)} (${(t.ss2PacketQueue/t.total*100).toFixed(1)}%)\n`,r+=`  Other:         ${Mt.formatBytes(t.other)} (${(t.other/t.total*100).toFixed(1)}%)\n`,r}analyze(e=10){const t=Mt.getLargestConsumers(e),r=At.getRecommendations();let o=`Top ${e} Memory Consumers:\n`;return t.forEach((e,t)=>{o+=`${t+1}. ${e.type}:${e.name} - ${Mt.formatBytes(e.size)}\n`}),r.length>0?(o+="\nRecommendations:\n",r.forEach(e=>{o+=`- ${e}\n`})):o+="\nNo recommendations at this time.\n",o}prune(){const e=At.pruneAll();let t="Memory Pruning Complete:\n";return t+=`  Dead creeps removed:        ${e.deadCreeps}\n`,t+=`  Event log entries removed:  ${e.eventLogs}\n`,t+=`  Stale intel removed:        ${e.staleIntel}\n`,t+=`  Market history removed:     ${e.marketHistory}\n`,t+=`  Total bytes saved:          ${Mt.formatBytes(e.bytesSaved)}\n`,t}segments(){const e=kt.getActiveSegments();let t="Memory Segments:\n\n";t+=`Active segments: ${e.length}/10\n`,e.length>0&&(t+=`  Loaded: [${e.join(", ")}]\n\n`),t+="Allocation Strategy:\n";for(const[r,o]of Object.entries(wt)){t+=`  ${r.padEnd(20)} ${o.start.toString().padStart(2)}-${o.end.toString().padEnd(2)}`;const n=e.filter(e=>e>=o.start&&e<=o.end);n.length>0&&(t+=` [${n.map(e=>{const t=kt.getSegmentSize(e);return`${e}:${Mt.formatBytes(t)}`}).join(", ")}]`),t+="\n"}return t}compress(e){const t=e.split(".");let r=Memory;for(const o of t){if(!r||"object"!=typeof r||!(o in r))return"Path not found: "+e;r=r[o]}if(!r)return"No data at path: "+e;const o=Gt.getCompressionStats(r);let n=`Compression Test for: ${e}\n`;return n+=`  Original size:    ${Mt.formatBytes(o.originalSize)}\n`,n+=`  Compressed size:  ${Mt.formatBytes(o.compressedSize)}\n`,n+=`  Bytes saved:      ${Mt.formatBytes(o.bytesSaved)}\n`,n+=`  Compression ratio: ${(100*o.ratio).toFixed(1)}%\n`,n+=`  Worth compressing: ${.9>o.ratio?"YES":"NO"}\n`,n}migrations(){const e=Dt.getCurrentVersion(),t=Dt.getLatestVersion(),r=Dt.getPendingMigrations();let o="Memory Migration Status:\n";return o+=`  Current version: ${e}\n`,o+=`  Latest version:  ${t}\n`,o+=`  Status: ${r.length>0?"PENDING":"UP TO DATE"}\n\n`,r.length>0&&(o+="Pending Migrations:\n",r.forEach(e=>{o+=`  v${e.version}: ${e.description}\n`}),o+="\nMigrations will run automatically on next tick.\n"),o}migrate(){const e=Dt.getCurrentVersion();Dt.runMigrations();const t=Dt.getCurrentVersion();return t>e?`Migrated from v${e} to v${t}`:`No migrations needed (current: v${t})`}reset(e){if("CONFIRM"!==e)return"WARNING: This will clear ALL memory!\nTo confirm, use: memory.reset('CONFIRM')";const t=Memory;for(const e in t)delete t[e];for(let e=0;100>e;e++)RawMemory.segments[e]="";return Wt.initialize(),"Memory reset complete. All data cleared (main memory + 100 segments)."}}Q([he({name:"memory.status",description:"Show current memory usage and status",usage:"memory.status()",examples:["memory.status()"],category:"Memory"})],Yl.prototype,"status",null),Q([he({name:"memory.analyze",description:"Analyze memory usage and show largest consumers",usage:"memory.analyze([topN])",examples:["memory.analyze()","memory.analyze(20)"],category:"Memory"})],Yl.prototype,"analyze",null),Q([he({name:"memory.prune",description:"Manually trigger memory pruning to clean stale data",usage:"memory.prune()",examples:["memory.prune()"],category:"Memory"})],Yl.prototype,"prune",null),Q([he({name:"memory.segments",description:"Show memory segment allocation and usage",usage:"memory.segments()",examples:["memory.segments()"],category:"Memory"})],Yl.prototype,"segments",null),Q([he({name:"memory.compress",description:"Test compression on a memory path",usage:"memory.compress(path)",examples:["memory.compress('empire.knownRooms')"],category:"Memory"})],Yl.prototype,"compress",null),Q([he({name:"memory.migrations",description:"Show migration status and pending migrations",usage:"memory.migrations()",examples:["memory.migrations()"],category:"Memory"})],Yl.prototype,"migrations",null),Q([he({name:"memory.migrate",description:"Manually trigger memory migrations",usage:"memory.migrate()",examples:["memory.migrate()"],category:"Memory"})],Yl.prototype,"migrate",null),Q([he({name:"memory.reset",description:"Clear all memory (DANGEROUS - requires confirmation)",usage:"memory.reset('CONFIRM')",examples:["memory.reset('CONFIRM')"],category:"Memory"})],Yl.prototype,"reset",null);const Kl=new Yl;var jl,Vl,ql,zl,Xl,Ql,Zl={},Jl={},eu={},tu={},ru={},ou={},nu={};function su(){if(zl)return nu;zl=1,Object.defineProperty(nu,"__esModule",{value:!0}),nu.cachedRoomFind=o,nu.invalidateRoomCache=function(e){const r=t();r.entries.get(e)&&(r.entries.delete(e),r.stats.invalidations++)},nu.invalidateFindType=function(e,o,n){const s=t(),i=s.entries.get(e);if(i){const e=r(o,n);i.delete(e),s.stats.invalidations++}},nu.invalidateStructureCache=function(e){const r=t(),o=r.entries.get(e);if(!o)return;const n=[FIND_STRUCTURES,FIND_MY_STRUCTURES,FIND_HOSTILE_STRUCTURES,FIND_MY_SPAWNS,FIND_MY_CONSTRUCTION_SITES,FIND_CONSTRUCTION_SITES];for(const e of n)for(const[t]of o)t.startsWith(e+"")&&(o.delete(t),r.stats.invalidations++)},nu.getRoomFindCacheStats=function(){const e=t();let r=0;for(const t of e.entries.values())r+=t.size;const o=e.stats.hits+e.stats.misses,n=o>0?e.stats.hits/o:0;return{rooms:e.entries.size,totalEntries:r,hits:e.stats.hits,misses:e.stats.misses,invalidations:e.stats.invalidations,hitRate:n}},nu.clearRoomFindCache=function(){const e=u;e._roomFindCache&&(e._roomFindCache.entries.clear(),e._roomFindCache.stats={hits:0,misses:0,invalidations:0})},nu.cachedFindSources=function(e){return o(e,FIND_SOURCES)},nu.cachedFindHostileCreeps=function(e){return o(e,FIND_HOSTILE_CREEPS)},nu.cachedFindStructures=function(e,t){return t?o(e,FIND_STRUCTURES,{filter:e=>e.structureType===t,filterKey:t}):o(e,FIND_STRUCTURES)},nu.cachedFindMyStructures=function(e,t){return t?o(e,FIND_MY_STRUCTURES,{filter:e=>e.structureType===t,filterKey:t}):o(e,FIND_MY_STRUCTURES)},nu.cachedFindConstructionSites=function(e,t=!0){return o(e,t?FIND_MY_CONSTRUCTION_SITES:FIND_CONSTRUCTION_SITES)},nu.cachedFindDroppedResources=function(e,t){return t?o(e,FIND_DROPPED_RESOURCES,{filter:e=>e.resourceType===t,filterKey:t}):o(e,FIND_DROPPED_RESOURCES)};const e={[FIND_SOURCES]:5e3,[FIND_MINERALS]:5e3,[FIND_DEPOSITS]:100,[FIND_STRUCTURES]:50,[FIND_MY_STRUCTURES]:50,[FIND_HOSTILE_STRUCTURES]:20,[FIND_MY_SPAWNS]:100,[FIND_MY_CONSTRUCTION_SITES]:20,[FIND_CONSTRUCTION_SITES]:20,[FIND_CREEPS]:5,[FIND_MY_CREEPS]:5,[FIND_HOSTILE_CREEPS]:3,[FIND_DROPPED_RESOURCES]:5,[FIND_TOMBSTONES]:10,[FIND_RUINS]:10,[FIND_FLAGS]:50,[FIND_NUKES]:20,[FIND_POWER_CREEPS]:10,[FIND_MY_POWER_CREEPS]:10};function t(){var e,t;const r=u;if(!r._roomFindCache||r._roomFindCache.tick!==Game.time){const o=null!==(t=null===(e=r._roomFindCache)||void 0===e?void 0:e.stats)&&void 0!==t?t:{hits:0,misses:0,invalidations:0};r._roomFindCache={tick:Game.time,entries:new Map,stats:o}}return r._roomFindCache}function r(e,t){return t?`${e}:${t}`:e+""}function o(o,n,s){var i,a;const c=t(),l=r(n,null==s?void 0:s.filterKey);let u=c.entries.get(o.name);u||(u=new Map,c.entries.set(o.name,u));const m=u.get(l);if(m&&Game.time-m.tick<m.ttl)return c.stats.hits++,m.results;let d;c.stats.misses++,d=(null==s?void 0:s.filter)?o.find(n,{filter:s.filter}):o.find(n);const p=null!==(a=null!==(i=null==s?void 0:s.ttl)&&void 0!==i?i:e[n])&&void 0!==a?a:20;return u.set(l,{results:d,tick:Game.time,ttl:p}),d}return nu}var iu,au,cu,lu,uu,mu,du,pu,gu,fu,hu,yu,Ru,Eu={},Tu={},Cu={},vu={},Su={},_u={},bu={},Ou={},Uu={},Mu={},Au={},wu={},ku={},Nu={};function Pu(){if(Ru)return Nu;Ru=1,Object.defineProperty(Nu,"__esModule",{value:!0}),Nu.random=function(){return o().next()},Nu.randomInt=n,Nu.shuffle=function(e){const t=[...e],r=o();for(let e=t.length-1;e>0;e--){const o=r.nextInt(0,e+1);[t[e],t[o]]=[t[o],t[e]]}return t},Nu.pick=function(e){return 0===e.length?void 0:e[n(0,e.length)]},Nu.createSeededRandom=function(t){const r=new e(t);return{next:()=>r.next(),nextInt:(e,t)=>r.nextInt(e,t)}},Nu.resetRandom=function(){t=null,r=-1};class e{constructor(e){this.state=e}next(){let e=this.state+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296}nextInt(e,t){return Math.floor(this.next()*(t-e))+e}reset(e){this.state=e}}let t=null,r=-1;function o(){const o="undefined"!=typeof Game?Game.time:0;return t&&r===o||(t=new e(2654435761*o),r=o),t}function n(e,t){return o().nextInt(e,t)}return Nu}var Iu,xu,$u,Gu,Lu={},Du={},Fu={},Bu={};function Hu(){if(Gu)return Bu;Gu=1,Object.defineProperty(Bu,"__esModule",{value:!0}),Bu.createElement=void 0,Bu.colorful=t,Bu.createLink=function(e,t,r=!0){return`<a href="${t}" target="${r?"_blank":"_self"}">${e}</a>`},Bu.log=function(e,r=[],o=null,n=!1){let s=r.length>0?`${r.join(" ")} `:"";s=t(s,o,!0);const i=`${s}${e}`;return console.log(i),n&&Game.notify(i),OK};const e={red:"#ef9a9a",green:"#6b9955",yellow:"#c5c599",blue:"#8dc5e3"};function t(t,r=null,o=!1){return`<text style="${[r?`color: ${e[r]};`:"",o?"font-weight: bolder;":""].join(" ")}">${t}</text>`}return Bu.createElement={customStyle:()=>"<style>      input {        background-color: #2b2b2b;        border: none;        border-bottom: 1px solid #888;        padding: 3px;        color: #ccc;      }      select {        border: none;        background-color: #2b2b2b;        color: #ccc;      }      button {        border: 1px solid #888;        cursor: pointer;        background-color: #2b2b2b;        color: #ccc;      }    </style>",input:e=>`${e.label||""} <input name="${e.name}" placeholder="${e.placeholder||""}"/>`,select(e){const t=[`${e.label||""} <select name="${e.name}">`];return t.push(...e.options.map(e=>` <option value="${e.value}">${e.label}</option>`)),t.push("</select>"),t.join("")},button(e){return`<button onclick="${t=e.command,`angular.element(document.body).injector().get('Console').sendCommand('(${t})()', 1)`}">${e.content}</button>`;var t},form(e,t,r){const o=e+Game.time.toString(),n=[this.customStyle(),`<form name='${o}'>`];n.push(...t.map(e=>{switch(e.type){case"input":return this.input(e)+"    ";case"select":return this.select(e)+"    "}}));const s=`(() => {\n      const form = document.forms['${o}']\n      let formDatas = {}\n      [${t.map(e=>`'${e.name}'`).toString()}].map(eleName => formDatas[eleName] = form[eleName].value)\n      angular.element(document.body).injector().get('Console').sendCommand(\`(${r.command})(\${JSON.stringify(formDatas)})\`, 1)\n    })()`;return n.push(`<button type="button" onclick="${s.replace(/\n/g,";")}">${r.content}</button>`),n.push("</form>"),n.join("")}},Bu}var Wu,Yu,Ku,ju,Vu,qu,zu={},Xu=(Ku||(Ku=1,Vu=Zl&&Zl.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),qu=Zl&&Zl.__exportStar||function(e,t){for(var r in e)"default"===r||{}.hasOwnProperty.call(t,r)||Vu(t,e,r)},Object.defineProperty(ju=Zl,"__esModule",{value:!0}),qu(function(){return Ql||(Ql=1,t=Jl&&Jl.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),r=Jl&&Jl.__exportStar||function(e,r){for(var o in e)"default"===o||{}.hasOwnProperty.call(r,o)||t(r,e,o)},Object.defineProperty(e=Jl,"__esModule",{value:!0}),r(function(){if(jl)return eu;function e(){const e=u;return e._bodyPartCache&&e._bodyPartCache.tick===Game.time||(e._bodyPartCache={tick:Game.time,data:new Map}),e._bodyPartCache}function t(t){var r,o;const n=e(),s=n.data.get(t.name);if(s)return s;const i=new Map,a=new Map;let c=0,l=0,u=0,m=0,d=0;for(const e of t.body)i.set(e.type,(null!==(r=i.get(e.type))&&void 0!==r?r:0)+1),e.hits>0&&(a.set(e.type,(null!==(o=a.get(e.type))&&void 0!==o?o:0)+1),e.type===ATTACK?c+=30:e.type===RANGED_ATTACK?c+=10:e.type===HEAL?l+=12:e.type===CARRY&&(d+=50),e.type===MOVE?u++:m++);const p={counts:i,activeCounts:a,damagePotential:c,healPotential:l,moveParts:u,nonMoveParts:m,carryCapacity:d};return n.data.set(t.name,p),p}function r(e,r,o=!1){var n;const s=t(e);return null!==(n=(o?s.activeCounts:s.counts).get(r))&&void 0!==n?n:0}return jl=1,Object.defineProperty(eu,"__esModule",{value:!0}),eu.getCachedBodyPartCount=r,eu.hasCachedBodyPart=function(e,t,o=!1){return r(e,t,o)>0},eu.getCachedDamagePotential=function(e){return t(e).damagePotential},eu.getCachedHealPotential=function(e){return t(e).healPotential},eu.getCachedCarryCapacity=function(e){return t(e).carryCapacity},eu.getCachedMoveRatio=function(e){const r=t(e),o=r.moveParts+r.nonMoveParts;return{moveParts:r.moveParts,nonMoveParts:r.nonMoveParts,ratio:o>0?r.moveParts/o:0}},eu.getBodyPartCacheStats=function(){const t=e();return{size:t.data.size,tick:t.tick}},eu.clearBodyPartCache=function(){const e=u;e._bodyPartCache&&e._bodyPartCache.data.clear()},eu}(),e),r(function(){if(Vl)return tu;Vl=1,Object.defineProperty(tu,"__esModule",{value:!0}),tu.findCachedClosest=function(n,s,i,a=t){if(0===s.length)return o(n,i),null;if(1===s.length)return s[0];const c=n.memory,l=c[e],u=null==l?void 0:l[i];if(u&&Game.time-u.t<a&&u.k===i){const e=Game.getObjectById(u.i);if(e&&s.some(t=>t.id===e.id)){const t=n.pos.getRangeTo(e.pos);if(r>=t)return e}}const m=n.pos.findClosestByRange(s);return m?(c[e]||(c[e]={}),c[e][i]={i:m.id,t:Game.time,k:i}):o(n,i),m},tu.clearCache=o,tu.clearCacheOnStateChange=function(e){o(e)};const e="_ct",t=10,r=20;function o(t,r){var o;const n=null!==(o=t.memory)&&void 0!==o?o:{},s=n[e];s&&(r?delete s[r]:delete n[e])}return tu}(),e),r(function(){if(ql)return ru;ql=1,Object.defineProperty(ru,"__esModule",{value:!0}),ru.getCachedObjectById=c,ru.getCachedStorage=function(e){var t;return e.storage&&null!==(t=c(e.storage.id))&&void 0!==t?t:void 0},ru.getCachedTerminal=function(e){var t;return e.terminal&&null!==(t=c(e.terminal.id))&&void 0!==t?t:void 0},ru.getCachedController=function(e){var t;return e.controller&&null!==(t=c(e.controller.id))&&void 0!==t?t:void 0},ru.prefetchRoomObjects=l,ru.getObjectCacheStats=function(){const e=a();return{size:e.objects.size,tick:e.tick}},ru.getCacheStatistics=function(){const e=a(),t=e.stats.hits+e.stats.misses,r=t>0?e.stats.hits/t*100:0;return e.objects.size>s&&console.log(`[ObjectCache] WARN: Cache size exceeds warning threshold: ${e.objects.size} entries, threshold: ${s}`),{hits:e.stats.hits,misses:e.stats.misses,hitRate:r,size:e.objects.size,cpuSaved:e.stats.hits*n}},ru.getCachedStructure=function(t){return c(t,e)},ru.getCachedCreep=function(e){return c(e,r)},ru.getCachedSource=function(e){return c(e,t)},ru.warmCache=function(){var t;Game.cpu.getUsed();for(const r in Game.rooms){const o=Game.rooms[r];if(null===(t=o.controller)||void 0===t?void 0:t.my){l(o);const t=o.find(FIND_MY_SPAWNS),r=o.find(FIND_MY_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_TOWER}),n=a(),s=Game.time;for(const r of t)n.objects.set(r.id,{value:r,expiresAt:s+e,lastAccessed:s});for(const t of r)n.objects.set(t.id,{value:t,expiresAt:s+e,lastAccessed:s})}}},ru.clearObjectCache=function(){const e=u;e._objectCache&&(e._objectCache.objects.clear(),e._objectCache.stats={hits:0,misses:0})},ru.resetCacheStats=function(){const e=u;e._objectCache&&(e._objectCache.stats={hits:0,misses:0})};const e=10,t=5,r=1,o=1,n=.001,s=1e4,i=12e3;function a(){const e=u;return e._objectCache||(e._objectCache={tick:Game.time,objects:new Map,stats:{hits:0,misses:0}}),e._objectCache.tick=Game.time,e._objectCache}function c(n,s){if(!n)return null;const c=a(),l=Game.time,u=c.objects.get(n);if(u&&u.expiresAt>l)return u.lastAccessed=l,c.stats.hits++,u.value;c.stats.misses++;const m=Game.getObjectById(n),d=null!=s?s:function(n){return n?"structureType"in n?e:n instanceof Source||n instanceof Mineral?t:n instanceof Creep?r:o:o}(m);return c.objects.set(n,{value:m,expiresAt:l+d,lastAccessed:l}),c.objects.size>i&&function(e){const t=e.objects.size-1e4;if(0>=t)return;const r=Array.from(e.objects.entries()).sort((e,t)=>e[1].lastAccessed-t[1].lastAccessed);for(let o=0;t>o&&o<r.length;o++)e.objects.delete(r[o][0]);console.log(`[ObjectCache] WARN: Cache LRU eviction: removed ${t} entries, size: ${e.objects.size}, threshold: ${i}`)}(c),m}function l(r){var o;if(!(null===(o=r.controller)||void 0===o?void 0:o.my))return;const n=a(),s=Game.time,i=(e,t)=>{(null==e?void 0:e.id)&&n.objects.set(e.id,{value:e,expiresAt:s+t,lastAccessed:s})};r.storage&&i(r.storage,e),r.terminal&&i(r.terminal,e),r.controller&&i(r.controller,e);const c=r.find(FIND_SOURCES);for(const e of c)i(e,t)}return ru}(),e),r(function(){if(Xl)return ou;Xl=1,Object.defineProperty(ou,"__esModule",{value:!0}),ou.getRoleCache=s,ou.setRoleCache=i,ou.deleteRoleCache=a,ou.hasRoleCache=function(e,t,r){return void 0!==s(e,t,r)},ou.clearRoleTypeCache=function(e){r().entries.delete(e)},ou.clearAllRoleCache=function(){const e=u;e._roleCache&&e._roleCache.entries.clear()},ou.getRoleCacheStats=function(){const e=r();let t=0,o=0;const n={};for(const[r,s]of e.entries){let e=0;for(const r of s.values())t++,e+=r.size,o+=r.size;n[r]=e}return{roles:e.entries.size,creeps:t,totalEntries:o,entriesByRole:n}},ou.getCachedRepairTarget=function(e,t){const r=s(e,"builder","repairTarget");if(r){const e=Game.getObjectById(r);if(e&&e.hits<e.hitsMax)return e}const o=t();return o&&i(e,"builder","repairTarget",o.id),o},ou.getCachedBuildTarget=function(e,t){const r=s(e,"builder","buildTarget");if(r){const e=Game.getObjectById(r);if(e)return e}const o=t();return o&&i(e,"builder","buildTarget",o.id),o},ou.getAssignedSource=function(e,t){let r=s(e,"miner","assignedSource");return!r&&t&&(i(e,"miner","assignedSource",t,200),r=t),r?Game.getObjectById(r):null},ou.getSourceContainer=function(t,r){const o="sourceContainer:"+r.id,n=s(t,"miner",o);if(n){const e=Game.getObjectById(n);if(e)return e}const a=r.room;if(!a)return null;const c=(0,e.cachedRoomFind)(a,FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_CONTAINER,filterKey:STRUCTURE_CONTAINER}).filter(e=>1>=r.pos.getRangeTo(e));if(c.length>0){const e=c[0];return i(t,"miner",o,e.id,100),e}return null},ou.getControllerEnergySource=function(t,r){const o="controllerSource:"+r.id,n=s(t,"upgrader",o);if(n){const e=Game.getObjectById(n);if(e)return e}const a=r.room;if(!a)return null;const c=(0,e.cachedRoomFind)(a,FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_LINK,filterKey:STRUCTURE_LINK}).filter(e=>3>=r.pos.getRangeTo(e)&&e.store.getUsedCapacity(RESOURCE_ENERGY)>0);if(c.length>0){const e=c[0];return i(t,"upgrader",o,e.id,100),e}const l=(0,e.cachedRoomFind)(a,FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_CONTAINER,filterKey:STRUCTURE_CONTAINER}).filter(e=>3>=r.pos.getRangeTo(e)&&e.store.getUsedCapacity(RESOURCE_ENERGY)>0);if(l.length>0){const e=l[0];return i(t,"upgrader",o,e.id,100),e}return null},ou.clearTargetCaches=function(e,t,r){for(const o of r)a(e,t,o)};const e=su(),t={assignedSource:100,assignedController:100,assignedMineral:100,assignedRoom:50,sourceContainer:50,controllerContainer:50,controllerLink:50,repairTarget:10,buildTarget:10,pickupTarget:5,deliveryTarget:5,combatTarget:3,harvestPath:50,deliveryRoute:20,default:10};function r(){const e=u;return e._roleCache&&e._roleCache.tick===Game.time||(e._roleCache={tick:Game.time,entries:new Map}),e._roleCache}function o(e){const t=r();let o=t.entries.get(e);return o||(o=new Map,t.entries.set(e,o)),o}function n(e,t){const r=o(e);let n=r.get(t);return n||(n=new Map,r.set(t,n)),n}function s(e,t,r){const o=n(t,e.name),s=o.get(r);if(s){if(Game.time-s.tick<s.ttl)return s.value;o.delete(r)}}function i(e,r,o,s,i){var a;const c=n(r,e.name),l=null!==(a=null!=i?i:t[o])&&void 0!==a?a:t.default;c.set(o,{value:s,tick:Game.time,ttl:l})}function a(e,t,r){r?n(t,e.name).delete(r):o(t).delete(e.name)}return ou}(),e),r(su(),e)),Jl;var e,t,r}(),ju),qu(function(){return cu||(cu=1,t=Eu&&Eu.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),r=Eu&&Eu.__exportStar||function(e,r){for(var o in e)"default"===o||{}.hasOwnProperty.call(r,o)||t(r,e,o)},Object.defineProperty(e=Eu,"__esModule",{value:!0}),r(function(){if(iu)return Tu;iu=1,Object.defineProperty(Tu,"__esModule",{value:!0}),Tu.ErrorMapper=void 0;const e=V();function t(e){return null==e?"":(e+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}let r=class{static async getConsumer(){if(null==this._consumer){const t=o;let r;if("string"==typeof t)try{r=JSON.parse(t)}catch(e){throw Error("Failed to parse source map JSON: "+(e instanceof Error?e.message:e+""))}else r=t;this._consumer=await new e.SourceMapConsumer(r)}return this._consumer}static async sourceMappedStackTrace(e){const t=e instanceof Error?e.stack:e;if({}.hasOwnProperty.call(this.cache,t))return this.cache[t];const r=/^\s+at\s+(.+?\s+)?\(?([0-z._\-\\\/]+):(\d+):(\d+)\)?$/gm;let o,n=e.toString();const s=await this.getConsumer();for(;(o=r.exec(t))&&"main"===o[2];){const e=s.originalPositionFor({column:parseInt(o[4],10),line:parseInt(o[3],10)});if(null==e.line)break;e.name?n+=`\n    at ${e.name} (${e.source}:${e.line}:${e.column})`:o[1]?n+=`\n    at ${o[1]} (${e.source}:${e.line}:${e.column})`:n+=`\n    at ${e.source}:${e.line}:${e.column}`}return this.cache[t]=n,n}static wrapLoop(e){return()=>{try{e()}catch(e){if(!(e instanceof Error))throw e;"sim"in Game.rooms?console.log(`<span style='color:red'>Source maps don't work in the simulator - displaying original error<br>${t(e.stack)}</span>`):this.sourceMappedStackTrace(e).then(e=>{console.log(`<span style='color:red'>${t(e)}</span>`)}).catch(r=>{console.log(`<span style='color:red'>Error mapping stack trace: ${r}<br>${t(e.stack)}</span>`)})}}}};return Tu.ErrorMapper=r,r.cache={},Tu}(),e),r(function(){if(au)return Cu;function e(e,t,r,o){const n=o instanceof Error?o.message:o+"";console.log(`[SafeFind] WARN: SafeFind error in ${e}(${t+""}) at ${r}: ${n}`)}return au=1,Object.defineProperty(Cu,"__esModule",{value:!0}),Cu.safeFind=function(t,r,o){try{return t.find(r,o)}catch(o){return e("room.find",r,t.name,o),[]}},Cu.safeFindClosestByRange=function(t,r,o){try{return t.findClosestByRange(r,o)}catch(o){return e("pos.findClosestByRange",r,`${t.roomName}:${t.x+""},${t.y+""}`,o),null}},Cu.safeFindInRange=function(t,r,o,n){try{return t.findInRange(r,o,n)}catch(o){return e("pos.findInRange",r,`${t.roomName}:${t.x+""},${t.y+""}`,o),[]}},Cu.safeFindClosestByPath=function(t,r,o){try{return t.findClosestByPath(r,o)}catch(o){return e("pos.findClosestByPath",r,`${t.roomName}:${t.x+""},${t.y+""}`,o),null}},Cu}(),e)),Eu;var e,t,r}(),ju),qu(function(){return uu||(uu=1,t=vu&&vu.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),r=vu&&vu.__exportStar||function(e,r){for(var o in e)"default"===o||{}.hasOwnProperty.call(r,o)||t(r,e,o)},Object.defineProperty(e=vu,"__esModule",{value:!0}),r((lu||(lu=1,Object.defineProperty(Su,"__esModule",{value:!0})),Su),e)),vu;var e,t,r}(),ju),qu(function(){return du||(du=1,t=_u&&_u.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),r=_u&&_u.__exportStar||function(e,r){for(var o in e)"default"===o||{}.hasOwnProperty.call(r,o)||t(r,e,o)},Object.defineProperty(e=_u,"__esModule",{value:!0}),r(function(){if(mu)return bu;mu=1,Object.defineProperty(bu,"__esModule",{value:!0}),bu.canSkipBehaviorEvaluation=function(o,n,s,i){var a,c;const l=null!==(a=null==i?void 0:i.minStateAge)&&void 0!==a?a:e;return!!(null!==(c=null==i?void 0:i.idleEligibleRoles)&&void 0!==c?c:t).has(s)&&!(!n||!n.startTick)&&Game.time-n.startTick>=l&&!!n.targetId&&r(o,n.targetId)},bu.isTargetStillValid=r,bu.isCreepActivelyWorking=function(e){if(e.fatigue>0)return!0;const t=e.store.getCapacity();if(t>0){const r=e.store.getUsedCapacity();if(r>0&&t>r)return!0}return!1};const e=3,t=new Set(["harvester","upgrader","mineralHarvester","builder"]);function r(e,t,r){const o=Game.getObjectById(t);return!!o&&"pos"in o&&o.pos instanceof RoomPosition&&(void 0===r||e.pos.getRangeTo(o.pos)<=r)}return bu}(),e)),_u;var e,t,r}(),ju),qu(function(){return hu||(hu=1,t=Ou&&Ou.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),r=Ou&&Ou.__exportStar||function(e,r){for(var o in e)"default"===o||{}.hasOwnProperty.call(r,o)||t(r,e,o)},Object.defineProperty(e=Ou,"__esModule",{value:!0}),r((pu||(pu=1,function(e){var t;Object.defineProperty(e,"__esModule",{value:!0}),e.globalScheduler=e.ComputationScheduler=e.TaskPriority=void 0,e.scheduleTask=function(r,o,n,s=t.MEDIUM,i){e.globalScheduler.register({id:r,interval:o,execute:n,priority:s,maxCpu:i,skippable:s!==t.CRITICAL})},e.unscheduleTask=function(t){e.globalScheduler.unregister(t)},e.runScheduledTasks=function(t){return e.globalScheduler.run(t)},e.getSchedulerStats=function(){return e.globalScheduler.getStats()},function(e){e[e.CRITICAL=0]="CRITICAL",e[e.HIGH=1]="HIGH",e[e.MEDIUM=2]="MEDIUM",e[e.LOW=3]="LOW"}(t||(e.TaskPriority=t={}));const r={bucketThresholds:{[t.CRITICAL]:0,[t.HIGH]:2e3,[t.MEDIUM]:5e3,[t.LOW]:8e3},defaultMaxCpu:5,logExecution:!1};class o{constructor(e){this.tasks=new Map,this.stats={totalTasks:0,tasksByPriority:{[t.CRITICAL]:0,[t.HIGH]:0,[t.MEDIUM]:0,[t.LOW]:0},executedThisTick:0,skippedThisTick:0,deferredThisTick:0,cpuUsed:0},this.config={...r,...e}}register(e){var t,r;const o={...e,lastRun:Game.time-e.interval,maxCpu:null!==(t=e.maxCpu)&&void 0!==t?t:this.config.defaultMaxCpu,skippable:null===(r=e.skippable)||void 0===r||r};this.tasks.set(e.id,o),this.updateStats()}unregister(e){this.tasks.delete(e),this.updateStats()}run(e){var r;const o=Game.cpu.getUsed(),n=Game.cpu.bucket,s=null!=e?e:1/0;this.stats.executedThisTick=0,this.stats.skippedThisTick=0,this.stats.deferredThisTick=0;const i=Array.from(this.tasks.values()).sort((e,t)=>e.priority-t.priority);let a=0;for(const e of i){if(Game.time-e.lastRun<e.interval)continue;if(e.priority!==t.CRITICAL&&this.config.bucketThresholds[e.priority]>n){this.stats.skippedThisTick++;continue}const o=null!==(r=e.maxCpu)&&void 0!==r?r:this.config.defaultMaxCpu;if(a+o>s&&e.skippable){this.stats.deferredThisTick++;continue}const i=Game.cpu.getUsed();try{e.execute(),e.lastRun=Game.time,this.stats.executedThisTick++;const t=Game.cpu.getUsed()-i;a+=t,t>o&&console.log(`[Scheduler] WARN: Task ${e.id} exceeded CPU budget: ${t.toFixed(2)} > ${o}`)}catch(t){console.log(`[Scheduler] ERROR: Error executing task ${e.id}: ${t+""}`),e.lastRun=Game.time}if(a>s)break}return this.stats.cpuUsed=Game.cpu.getUsed()-o,{...this.stats}}forceRun(e){const t=this.tasks.get(e);if(!t)return!1;try{return t.execute(),t.lastRun=Game.time,!0}catch(t){return console.log(`[Scheduler] ERROR: Error force-executing task ${e}: ${t+""}`),!1}}resetTask(e){const t=this.tasks.get(e);t&&(t.lastRun=Game.time-t.interval)}getStats(){return{...this.stats}}getTasks(){return Array.from(this.tasks.values())}hasTask(e){return this.tasks.has(e)}clear(){this.tasks.clear(),this.updateStats()}updateStats(){this.stats.totalTasks=this.tasks.size,this.stats.tasksByPriority={[t.CRITICAL]:0,[t.HIGH]:0,[t.MEDIUM]:0,[t.LOW]:0};for(const e of this.tasks.values())this.stats.tasksByPriority[e.priority]++}}e.ComputationScheduler=o,e.globalScheduler=function(){const e=u;return e._computationScheduler||(e._computationScheduler=new o),e._computationScheduler}()}(Uu)),Uu),e),r(function(){if(gu)return Mu;function e(e,t,r,o){return Math.max(Math.abs(e-r),Math.abs(t-o))}return gu=1,Object.defineProperty(Mu,"__esModule",{value:!0}),Mu.throttle=function(e,t,r=0){if((Game.time+r)%t===0)return e()},Mu.throttleWithDefault=function(e,t,r,o=0){return(Game.time+o)%t===0?e():r},Mu.filterWithMemoization=function(e,t,r){const o=new Map;return e.filter(e=>{const n=t(e),s=o.get(n);if(void 0!==s)return s;const i=r(e);return o.set(n,i),i})},Mu.chebyshevDistance=e,Mu.isWithinRange=function(e,t,r,o,n){return n>=Math.abs(e-r)&&n>=Math.abs(t-o)},Mu.findClosestByRangeFast=function(t,r){if(0===r.length)return null;let o=null,n=1/0;for(const s of r){if(s.pos.roomName!==t.roomName)continue;const r=e(t.x,t.y,s.pos.x,s.pos.y);n>r&&(n=r,o=s)}return o},Mu.sumValues=function(e,t){let r=0;for(const o of e)r+=t(o);return r},Mu.groupBy=function(e,t){const r=new Map;for(const o of e){const e=t(o),n=r.get(e);n?n.push(o):r.set(e,[o])}return r},Mu.isLowBucket=function(e=2e3){return Game.cpu.bucket<e},Mu.hasCpuBudget=function(e=0,t=.8){const r=Game.cpu.getUsed();return Game.cpu.limit*t-r>=e},Mu}(),e),r(function(){if(fu)return Au;function e(){const e=u;return e._findInRangeCache&&e._findInRangeCache.tick===Game.time||(e._findInRangeCache={tick:Game.time,results:new Map}),e._findInRangeCache}return fu=1,Object.defineProperty(Au,"__esModule",{value:!0}),Au.cachedFindInRange=function(t,r,o,n){if(0===r.length)return[];if(n){const t=e().results.get(n);if(t)return t}const s=r.filter(e=>t.getRangeTo(e.pos)<=o);return n&&e().results.set(n,s),s},Au.optimizedFindClosest=function(e,t){return 0===t.length?null:1===t.length?t[0]:e.findClosestByRange(t)},Au.findStructuresByType=function(e,t,r){const o=e.find(FIND_STRUCTURES),n=new Set(t);let s=o.filter(e=>n.has(e.structureType));return r&&(s=s.filter(r)),s},Au.findPrioritizedConstructionSites=function(e){const t=e.find(FIND_MY_CONSTRUCTION_SITES);if(1>=t.length)return t;const r={[STRUCTURE_SPAWN]:100,[STRUCTURE_EXTENSION]:90,[STRUCTURE_TOWER]:80,[STRUCTURE_STORAGE]:70,[STRUCTURE_TERMINAL]:65,[STRUCTURE_LINK]:60,[STRUCTURE_CONTAINER]:50,[STRUCTURE_ROAD]:30,[STRUCTURE_RAMPART]:20,[STRUCTURE_WALL]:10};return t.sort((e,t)=>{var o,n;const s=null!==(o=r[e.structureType])&&void 0!==o?o:40;return(null!==(n=r[t.structureType])&&void 0!==n?n:40)-s})},Au.findDamagedStructures=function(e,t=.75,r=!0){return e.find(FIND_STRUCTURES).filter(e=>(!r||e.structureType!==STRUCTURE_WALL&&e.structureType!==STRUCTURE_RAMPART)&&e.hits<e.hitsMax*t)},Au.findEnergySources=function(e,t,r=50){const o=[],n=t.find(FIND_DROPPED_RESOURCES,{filter:e=>e.resourceType===RESOURCE_ENERGY&&e.amount>=r});for(const t of n)o.push({target:t,amount:t.amount,range:e.getRangeTo(t.pos)});const s=t.find(FIND_STRUCTURES,{filter:e=>e.structureType===STRUCTURE_CONTAINER&&e.store.getUsedCapacity(RESOURCE_ENERGY)>=r});for(const t of s)o.push({target:t,amount:t.store.getUsedCapacity(RESOURCE_ENERGY),range:e.getRangeTo(t.pos)});return t.storage&&t.storage.store.getUsedCapacity(RESOURCE_ENERGY)>=r&&o.push({target:t.storage,amount:t.storage.store.getUsedCapacity(RESOURCE_ENERGY),range:e.getRangeTo(t.storage.pos)}),t.terminal&&t.terminal.store.getUsedCapacity(RESOURCE_ENERGY)>=r&&o.push({target:t.terminal,amount:t.terminal.store.getUsedCapacity(RESOURCE_ENERGY),range:e.getRangeTo(t.terminal.pos)}),o.sort((e,t)=>e.range-t.range)},Au.findHostilesByThreat=function(e,t){const r=e.find(FIND_HOSTILE_CREEPS);return 0===r.length?[]:r.map(e=>{let r=0;for(const t of e.body)t.hits>0&&(t.type===ATTACK?r+=30:t.type===RANGED_ATTACK?r+=10:t.type===HEAL?r+=15:t.type===WORK&&(r+=5));return{creep:e,threat:r,range:t?t.getRangeTo(e.pos):50}}).sort((e,t)=>t.threat!==e.threat?t.threat-e.threat:e.range-t.range)},Au.getFindOptimizationStats=function(){const t=e();return{cacheSize:t.results.size,tick:t.tick}},Au.clearFindCache=function(){const e=u;e._findInRangeCache&&e._findInRangeCache.results.clear()},Au}(),e)),Ou;var e,t,r}(),ju),qu((yu||(yu=1,Object.defineProperty(wu,"__esModule",{value:!0})),wu),ju),qu(function(){return $u||($u=1,t=ku&&ku.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),r=ku&&ku.__exportStar||function(e,r){for(var o in e)"default"===o||{}.hasOwnProperty.call(r,o)||t(r,e,o)},Object.defineProperty(e=ku,"__esModule",{value:!0}),r(Pu(),e),r(function(){if(Iu)return Lu;Iu=1,Object.defineProperty(Lu,"__esModule",{value:!0}),Lu.clearTargetAssignments=function(){e.clear()},Lu.findDistributedTarget=function(e,o,n){if(0===o.length)return null;if(1===o.length)return r(e,o[0],n),o[0];const s=t(e.room.name);let i=null,a=1/0,c=1/0;for(const t of o){const r=`${n}:${t.id}`,o=(s.assignments.get(r)||[]).length,l=e.pos.getRangeTo(t.pos);(a>o||o===a&&c>l)&&(i=t,a=o,c=l)}return i&&r(e,i,n),i},Lu.registerAssignment=r,Lu.getAssignmentCount=function(e,r,o){const n=`${o}:${r}`;return(t(e).assignments.get(n)||[]).length},Lu.getAssignedCreeps=function(e,r,o){const n=`${o}:${r}`;return t(e).assignments.get(n)||[]};const e=new Map;function t(t){let r=e.get(t);return r&&r.tick===Game.time||(r={assignments:new Map,tick:Game.time},e.set(t,r)),r}function r(e,r,o){const n=t(e.room.name),s=`${o}:${r.id}`,i=n.assignments.get(s)||[];i.includes(e.name)||(i.push(e.name),n.assignments.set(s,i))}return Lu}(),e),r(function(){if(xu)return Du;xu=1,Object.defineProperty(Du,"__esModule",{value:!0}),Du.weightedSelection=t,Du.weightedSelectionEntry=function(e){const r=t(e);return void 0===r?void 0:e.find(e=>e.key===r)},Du.selectTopN=function(e,t){return[...e].sort((e,t)=>t.weight-e.weight).slice(0,t).map(e=>e.key)},Du.selectTopNEntries=function(e,t){return[...e].sort((e,t)=>t.weight-e.weight).slice(0,t)},Du.normalizeWeights=function(e){const t=e.filter(e=>e.weight>0),r=t.reduce((e,t)=>e+t.weight,0);return r>0?t.map(e=>({key:e.key,weight:e.weight/r})):[]},Du.scaleWeights=function(e,t){return e.map(e=>({key:e.key,weight:Math.max(0,e.weight*t)}))},Du.addBonusWeight=function(e,t,r){return e.map(e=>({key:e.key,weight:t(e)?Math.max(0,e.weight+r):e.weight}))},Du.combineWeights=function(e,t=e=>e.reduce((e,t)=>e+t,0)){var r;const o=new Map;for(const t of e)for(const e of t){const t=null!==(r=o.get(e.key))&&void 0!==r?r:[];t.push(e.weight),o.set(e.key,t)}return Array.from(o.entries()).map(([e,r])=>({key:e,weight:t(r)}))},Du.fromRecord=function(e){return Object.entries(e).map(([e,t])=>({key:e,weight:t}))},Du.toRecord=function(e){const t={};for(const r of e)t[r.key]=r.weight;return t},Du.filterByMinWeight=function(e,t){return e.filter(e=>e.weight>=t)},Du.getHighest=function(e){return 0===e.length?void 0:e.reduce((e,t)=>t.weight>e.weight?t:e)},Du.getLowest=function(e){const t=e.filter(e=>e.weight>0);return 0===t.length?void 0:t.reduce((e,t)=>t.weight<e.weight?t:e)},Du.applyDecay=function(e,t){return e.map(e=>({key:e.key,weight:e.weight*t}))},Du.clampWeights=function(e,t,r){return e.map(e=>({key:e.key,weight:Math.max(t,Math.min(r,e.weight))}))};const e=Pu();function t(t){var r;const o=t.filter(e=>e.weight>0);if(0===o.length)return;const n=o.reduce((e,t)=>e+t.weight,0);if(0>=n)return;let s=(0,e.random)()*n;for(const e of o)if(s-=e.weight,0>=s)return e.key;return null===(r=o[o.length-1])||void 0===r?void 0:r.key}return Du}(),e)),ku;var e,t,r}(),ju),qu(function(){return Yu||(Yu=1,t=Fu&&Fu.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),r=Fu&&Fu.__exportStar||function(e,r){for(var o in e)"default"===o||{}.hasOwnProperty.call(r,o)||t(r,e,o)},Object.defineProperty(e=Fu,"__esModule",{value:!0}),r(Hu(),e),r(function(){if(Wu)return zu;Wu=1,Object.defineProperty(zu,"__esModule",{value:!0}),zu.createHelp=function(...e){return o()+n()+`<div class="module-help">${e.map(t).join("")}</div>`};const e=Hu(),t=function(t){const o=t.api.map(r).join("");return`<div class="module-container">\n    <div class="module-info">\n      <span class="module-title">${(0,e.colorful)(t.name,"yellow")}</span>\n      <span class="module-describe">${(0,e.colorful)(t.describe,"green")}</span>\n    </div>\n    <div class="module-api-list">${o}</div>\n  </div>`.replace(/\n/g,"")},r=function(t){const r=[];t.describe&&r.push((0,e.colorful)(t.describe,"green")),t.params&&r.push(t.params.map(t=>`  - ${(0,e.colorful)(t.name,"blue")}: ${(0,e.colorful)(t.desc,"green")}`).map(e=>`<div class="api-content-line">${e}</div>`).join(""));let o=t.params?t.params.map(t=>(0,e.colorful)(t.name,"blue")).join(", "):"",n=(0,e.colorful)(t.functionName,"yellow")+(t.commandType?"":`(${o})`);r.push(n);const s=r.map(e=>`<div class="api-content-line">${e}</div>`).join(""),i=`${t.functionName}${Game.time}`;return`\n  <div class="api-container">\n    <label for="${i}">${t.title} ${(0,e.colorful)(t.functionName,"yellow",!0)}</label>\n    <input id="${i}" type="checkbox" />\n    <div class="api-content">${s}</div>\n  </div>\n  `.replace(/\n/g,"")},o=function(){return"  <style>  .module-help {    display: flex;    flex-flow: column nowrap;  }  .module-container {    padding: 0px 10px 10px 10px;    display: flex;    flex-flow: column nowrap;  }  .module-info {    margin: 5px;    display: flex;    flex-flow: row nowrap;    align-items: baseline;  }  .module-title {    font-size: 19px;    font-weight: bolder;    margin-left: -15px;  }  .module-api-list {    display: flex;    flex-flow: row wrap;  }  </style>"},n=function(){return"  <style>  .api-content-line {    width: max-content;    padding-right: 15px;  }  .api-container {    margin: 5px;    width: 250px;    background-color: #2b2b2b;    overflow: hidden;    display: flex;    flex-flow: column;  }  .api-container label {    transition: all 0.1s;    min-width: 300px;  }  /* Hide checkbox */  .api-container input {    display: none;  }  .api-container label {    cursor: pointer;    display: block;    padding: 10px;    background-color: #3b3b3b;    white-space: nowrap;    overflow: hidden;    text-overflow: ellipsis;  }  .api-container label:hover, label:focus {    background-color: #525252;  }  /* Collapsed state */  .api-container input + .api-content {    overflow: hidden;    transition: all 0.1s;    width: auto;    max-height: 0px;    padding: 0px 10px;  }  /* Expanded state when checkbox is checked */  .api-container input:checked + .api-content {    max-height: 200px;    padding: 10px;    background-color: #1c1c1c;    overflow-x: auto;  }  </style>"};return zu}(),e)),Fu;var e,t,r}(),ju)),Zl);function Qu(e){const t=e.match(/\((.*?)\)/);if(!t||!t[1])return;const r=t[1].split(",").map(e=>e.trim()).filter(e=>e);return 0!==r.length?r.map(e=>({name:e,desc:"Parameter: "+e})):void 0}class Zu{uiHelp(e){return e?function(e){const t=fe.getCommandsByCategory(),r=t.get(e);if(!r||0===r.length)return`Category "${e}" not found. Available categories: ${Array.from(t.keys()).join(", ")}`;const o=r.map(e=>{var t,r;return{title:e.metadata.description,describe:null===(t=e.metadata.examples)||void 0===t?void 0:t[0],functionName:e.metadata.name,commandType:!(null===(r=e.metadata.usage)||void 0===r?void 0:r.includes("(")),params:e.metadata.usage?Qu(e.metadata.usage):void 0}});return Xu.createHelp({name:e,describe:e+" commands",api:o})}(e):function(){const e=fe.getCommandsByCategory(),t=[];for(const[r,o]of e){const e=o.map(e=>{var t;const r={title:e.metadata.description,functionName:e.metadata.name,commandType:!(null===(t=e.metadata.usage)||void 0===t?void 0:t.includes("("))};if(e.metadata.examples&&e.metadata.examples.length>0&&(r.describe=e.metadata.examples[0]),e.metadata.usage){const t=e.metadata.usage.match(/\((.*?)\)/);if(t&&t[1]){const e=t[1].split(",").map(e=>e.trim()).filter(e=>e);e.length>0&&(r.params=e.map(e=>({name:e,desc:"Parameter: "+e})))}}return r});t.push({name:r,describe:r+" commands for bot management",api:e})}return Xu.createHelp(...t)}()}spawnForm(e){return Game.rooms[e]?Xu.createElement.form("spawnCreep",[{type:"select",name:"role",label:"Role:",options:[{value:"harvester",label:"Harvester"},{value:"upgrader",label:"Upgrader"},{value:"builder",label:"Builder"},{value:"hauler",label:"Hauler"},{value:"repairer",label:"Repairer"},{value:"defender",label:"Defender"}]},{type:"input",name:"name",label:"Name (optional):",placeholder:"Auto-generated if empty"}],{content:"Spawn Creep",command:`({role, name}) => {\n        const room = Game.rooms['${e}'];\n        if (!room) return 'Room not found';\n        const spawns = room.find(FIND_MY_SPAWNS);\n        if (spawns.length === 0) return 'No spawns found';\n        const spawn = spawns[0];\n        const body = [WORK, CARRY, MOVE]; // Basic body\n        const creepName = name || role + '_' + Game.time;\n        const result = spawn.spawnCreep(body, creepName, {memory: {role: role}});\n        return result === OK ? 'Spawning ' + creepName : 'Error: ' + result;\n      }`}):Xu.colorful(`Room ${e} not found or not visible`,"red",!0)}roomControl(e){const t=Game.rooms[e];if(!t)return Xu.colorful(`Room ${e} not found or not visible`,"red",!0);let r='<div style="background: #2b2b2b; padding: 10px; margin: 5px;">';return r+=`<h3 style="color: #c5c599; margin: 0 0 10px 0;">Room Control: ${e}</h3>`,r+='<div style="margin-bottom: 10px;">',r+=Xu.colorful(`Energy: ${t.energyAvailable}/${t.energyCapacityAvailable}`,"green")+"<br>",t.controller&&(r+=Xu.colorful(`Controller Level: ${t.controller.level} (${t.controller.progress}/${t.controller.progressTotal})`,"blue")+"<br>"),r+="</div>",r+=Xu.createElement.button({content:" Toggle Visualizations",command:"() => {\n        const config = require('./config').getConfig();\n        require('./config').updateConfig({visualizations: !config.visualizations});\n        return 'Visualizations: ' + (!config.visualizations ? 'ON' : 'OFF');\n      }"}),r+=" ",r+=Xu.createElement.button({content:" Room Stats",command:`() => {\n        const room = Game.rooms['${e}'];\n        if (!room) return 'Room not found';\n        let stats = '=== Room Stats ===\\n';\n        stats += 'Energy: ' + room.energyAvailable + '/' + room.energyCapacityAvailable + '\\n';\n        stats += 'Creeps: ' + Object.values(Game.creeps).filter(c => c.room.name === '${e}').length + '\\n';\n        if (room.controller) {\n          stats += 'RCL: ' + room.controller.level + '\\n';\n          stats += 'Progress: ' + room.controller.progress + '/' + room.controller.progressTotal + '\\n';\n        }\n        return stats;\n      }`}),r+="</div>",r}logForm(){return Xu.createElement.form("configureLogging",[{type:"select",name:"level",label:"Log Level:",options:[{value:"debug",label:"Debug (Verbose)"},{value:"info",label:"Info (Normal)"},{value:"warn",label:"Warning (Important)"},{value:"error",label:"Error (Critical Only)"},{value:"none",label:"None (Disabled)"}]}],{content:"Set Log Level",command:"({level}) => {\n        const levelMap = {\n          debug: 0,\n          info: 1,\n          warn: 2,\n          error: 3,\n          none: 4\n        };\n        const logLevel = levelMap[level];\n        require('./core/logger').configureLogger({level: logLevel});\n        return 'Log level set to: ' + level.toUpperCase();\n      }"})}visForm(){return Xu.createElement.form("configureVisualization",[{type:"select",name:"mode",label:"Visualization Mode:",options:[{value:"debug",label:"Debug (All layers)"},{value:"presentation",label:"Presentation (Clean)"},{value:"minimal",label:"Minimal (Basic only)"},{value:"performance",label:"Performance (Disabled)"}]}],{content:"Set Visualization Mode",command:"({mode}) => {\n        const { visualizationManager } = require('../visuals/visualizationManager');\n        visualizationManager.setMode(mode);\n        return 'Visualization mode set to: ' + mode;\n      }"})}quickActions(){let e='<div style="background: #2b2b2b; padding: 10px; margin: 5px;">';return e+='<h3 style="color: #c5c599; margin: 0 0 10px 0;">Quick Actions</h3>',e+=Xu.createElement.button({content:" Emergency Mode",command:"() => {\n        const config = require('./config').getConfig();\n        require('./config').updateConfig({emergencyMode: !config.emergencyMode});\n        return 'Emergency Mode: ' + (!config.emergencyMode ? 'ON' : 'OFF');\n      }"}),e+=" ",e+=Xu.createElement.button({content:" Toggle Debug",command:"() => {\n        const config = require('./config').getConfig();\n        const newValue = !config.debug;\n        require('./config').updateConfig({debug: newValue});\n        require('./core/logger').configureLogger({level: newValue ? 0 : 1});\n        return 'Debug mode: ' + (newValue ? 'ON' : 'OFF');\n      }"}),e+=" ",e+=Xu.createElement.button({content:" Clear Cache",command:"() => {\n        const { cacheManager } = require('./cache/CacheManager');\n        cacheManager.clear();\n        return 'Cache cleared successfully';\n      }"}),e+="</div>",e}colorDemo(){let e="=== Console Color Demo ===\n\n";return e+=Xu.colorful(" Success message","green",!0)+"\n",e+=Xu.colorful(" Warning message","yellow",!0)+"\n",e+=Xu.colorful(" Error message","red",!0)+"\n",e+=Xu.colorful(" Info message","blue",!0)+"\n",e+="\nNormal text: "+Xu.colorful("colored text","green")+" normal text\n",e+="Bold text: "+Xu.colorful("important",null,!0)+"\n",e}}Q([he({name:"uiHelp",description:"Show interactive help interface with expandable sections",usage:"uiHelp()",examples:["uiHelp()",'uiHelp("Logging")','uiHelp("Visualization")'],category:"System"})],Zu.prototype,"uiHelp",null),Q([he({name:"spawnForm",description:"Show interactive form for spawning creeps",usage:"spawnForm(roomName)",examples:['spawnForm("W1N1")','spawnForm("E2S3")'],category:"Spawning"})],Zu.prototype,"spawnForm",null),Q([he({name:"roomControl",description:"Show interactive room control panel",usage:"roomControl(roomName)",examples:['roomControl("W1N1")'],category:"Room Management"})],Zu.prototype,"roomControl",null),Q([he({name:"logForm",description:"Show interactive form for configuring logging",usage:"logForm()",examples:["logForm()"],category:"Logging"})],Zu.prototype,"logForm",null),Q([he({name:"visForm",description:"Show interactive form for visualization settings",usage:"visForm()",examples:["visForm()"],category:"Visualization"})],Zu.prototype,"visForm",null),Q([he({name:"quickActions",description:"Show quick action buttons for common operations",usage:"quickActions()",examples:["quickActions()"],category:"System"})],Zu.prototype,"quickActions",null),Q([he({name:"colorDemo",description:"Show color demonstration for console output",usage:"colorDemo()",examples:["colorDemo()"],category:"System"})],Zu.prototype,"colorDemo",null);class Ju{setLogLevel(e){const t={debug:Z.DEBUG,info:Z.INFO,warn:Z.WARN,error:Z.ERROR,none:Z.NONE}[e.toLowerCase()];return void 0===t?`Invalid log level: ${e}. Valid levels: debug, info, warn, error, none`:(ee({level:t}),"Log level set to: "+e.toUpperCase())}toggleDebug(){const e=!_e().debug;return be({debug:e}),ee({level:e?Z.DEBUG:Z.INFO}),`Debug mode: ${e?"ENABLED":"DISABLED"} (Log level: ${e?"DEBUG":"INFO"})`}}Q([he({name:"setLogLevel",description:"Set the log level for the bot",usage:"setLogLevel(level)",examples:["setLogLevel('debug')","setLogLevel('info')","setLogLevel('warn')","setLogLevel('error')","setLogLevel('none')"],category:"Logging"})],Ju.prototype,"setLogLevel",null),Q([he({name:"toggleDebug",description:"Toggle debug mode on/off (affects log level and debug features)",usage:"toggleDebug()",examples:["toggleDebug()"],category:"Logging"})],Ju.prototype,"toggleDebug",null);class em{toggleVisualizations(){const e=!_e().visualizations;return be({visualizations:e}),"Visualizations: "+(e?"ENABLED":"DISABLED")}toggleVisualization(e){const t=_l.getConfig(),r=Object.keys(t).filter(e=>e.startsWith("show")&&"boolean"==typeof t[e]);if(!r.includes(e))return`Invalid key: ${e}. Valid keys: ${r.join(", ")}`;const o=e;return _l.toggle(o),`Room visualization '${e}': ${_l.getConfig()[o]?"ENABLED":"DISABLED"}`}toggleMapVisualization(e){const t=bl.getConfig(),r=Object.keys(t).filter(e=>e.startsWith("show")&&"boolean"==typeof t[e]);if(!r.includes(e))return`Invalid key: ${e}. Valid keys: ${r.join(", ")}`;const o=e;return bl.toggle(o),`Map visualization '${e}': ${bl.getConfig()[o]?"ENABLED":"DISABLED"}`}showMapConfig(){const e=bl.getConfig();return Object.entries(e).map(([e,t])=>`${e}: ${t+""}`).join("\n")}setVisMode(e){const t=["debug","presentation","minimal","performance"];if(!t.includes(e))return`Invalid mode: ${e}. Valid modes: ${t.join(", ")}`;const{visualizationManager:r}=require("../visuals/visualizationManager");return r.setMode(e),"Visualization mode set to: "+e}toggleVisLayer(e){const{visualizationManager:t}=require("../visuals/visualizationManager"),{VisualizationLayer:r}=require("../memory/schemas"),o={pheromones:r.Pheromones,paths:r.Paths,traffic:r.Traffic,defense:r.Defense,economy:r.Economy,construction:r.Construction,performance:r.Performance},n=o[e.toLowerCase()];return n?(t.toggleLayer(n),`Layer ${e}: ${t.isLayerEnabled(n)?"enabled":"disabled"}`):`Unknown layer: ${e}. Valid layers: ${Object.keys(o).join(", ")}`}showVisPerf(){const{visualizationManager:e}=require("../visuals/visualizationManager"),t=e.getPerformanceMetrics();let r="=== Visualization Performance ===\n";r+=`Total CPU: ${t.totalCost.toFixed(3)}\n`,r+=`% of Budget: ${t.percentOfBudget.toFixed(2)}%\n`,r+="\nPer-Layer Costs:\n";for(const[e,o]of Object.entries(t.layerCosts))o>0&&(r+=`  ${e}: ${o.toFixed(3)} CPU\n`);return r}showVisConfig(){const{visualizationManager:e}=require("../visuals/visualizationManager"),{VisualizationLayer:t}=require("../memory/schemas"),r=e.getConfig();let o="=== Visualization Configuration ===\n";o+=`Mode: ${r.mode}\n`,o+="\nEnabled Layers:\n";const n={[t.Pheromones]:"Pheromones",[t.Paths]:"Paths",[t.Traffic]:"Traffic",[t.Defense]:"Defense",[t.Economy]:"Economy",[t.Construction]:"Construction",[t.Performance]:"Performance"};for(const[e,t]of Object.entries(n)){const n=parseInt(e,10);o+=`  ${t}: ${0!==(r.enabledLayers&n)?"":""}\n`}return o}clearVisCache(e){const{visualizationManager:t}=require("../visuals/visualizationManager");return t.clearCache(e),e?"Visualization cache cleared for room: "+e:"All visualization caches cleared"}}Q([he({name:"toggleVisualizations",description:"Toggle all visualizations on/off",usage:"toggleVisualizations()",examples:["toggleVisualizations()"],category:"Visualization"})],em.prototype,"toggleVisualizations",null),Q([he({name:"toggleVisualization",description:"Toggle a specific room visualization feature",usage:"toggleVisualization(key)",examples:["toggleVisualization('showPheromones')","toggleVisualization('showPaths')","toggleVisualization('showCombat')"],category:"Visualization"})],em.prototype,"toggleVisualization",null),Q([he({name:"toggleMapVisualization",description:"Toggle a specific map visualization feature",usage:"toggleMapVisualization(key)",examples:["toggleMapVisualization('showRoomStatus')","toggleMapVisualization('showConnections')","toggleMapVisualization('showThreats')","toggleMapVisualization('showExpansion')"],category:"Visualization"})],em.prototype,"toggleMapVisualization",null),Q([he({name:"showMapConfig",description:"Show current map visualization configuration",usage:"showMapConfig()",examples:["showMapConfig()"],category:"Visualization"})],em.prototype,"showMapConfig",null),Q([he({name:"setVisMode",description:"Set visualization mode preset (debug, presentation, minimal, performance)",usage:"setVisMode(mode)",examples:["setVisMode('debug')","setVisMode('presentation')","setVisMode('minimal')","setVisMode('performance')"],category:"Visualization"})],em.prototype,"setVisMode",null),Q([he({name:"toggleVisLayer",description:"Toggle a specific visualization layer",usage:"toggleVisLayer(layer)",examples:["toggleVisLayer('pheromones')","toggleVisLayer('paths')","toggleVisLayer('defense')","toggleVisLayer('economy')","toggleVisLayer('performance')"],category:"Visualization"})],em.prototype,"toggleVisLayer",null),Q([he({name:"showVisPerf",description:"Show visualization performance metrics",usage:"showVisPerf()",examples:["showVisPerf()"],category:"Visualization"})],em.prototype,"showVisPerf",null),Q([he({name:"showVisConfig",description:"Show current visualization configuration",usage:"showVisConfig()",examples:["showVisConfig()"],category:"Visualization"})],em.prototype,"showVisConfig",null),Q([he({name:"clearVisCache",description:"Clear visualization cache",usage:"clearVisCache(roomName?)",examples:["clearVisCache()","clearVisCache('W1N1')"],category:"Visualization"})],em.prototype,"clearVisCache",null);class tm{showStats(){const e=Ye.memorySegmentStats.getLatestStats();return e?`=== SwarmBot Stats (Tick ${e.tick}) ===\nCPU: ${e.cpuUsed.toFixed(2)}/${e.cpuLimit} (Bucket: ${e.cpuBucket})\nGCL: ${e.gclLevel} (${(100*e.gclProgress).toFixed(1)}%)\nGPL: ${e.gplLevel}\nCreeps: ${e.totalCreeps}\nRooms: ${e.totalRooms}\n${e.rooms.map(e=>`  ${e.roomName}: RCL${e.rcl} | ${e.creepCount} creeps | ${e.storageEnergy}E`).join("\n")}`:"No stats available yet. Wait for a few ticks."}cacheStats(){const{getCacheStatistics:e}=require("../utils/objectCache"),t=e();return`=== Object Cache Statistics ===\nCache Size: ${t.size} entries\nCache Hits: ${t.hits}\nCache Misses: ${t.misses}\nHit Rate: ${t.hitRate.toFixed(2)}%\nEstimated CPU Saved: ${t.cpuSaved.toFixed(3)} CPU\n\nPerformance: ${80>t.hitRate?60>t.hitRate?40>t.hitRate?"Poor":"Fair":"Good":"Excellent"}`}resetCacheStats(){const{resetCacheStats:e}=require("../utils/objectCache");return e(),"Cache statistics reset"}roomFindCacheStats(){const{getRoomFindCacheStats:e}=require("../utils/roomFindCache"),t=e(),r=(100*t.hitRate).toFixed(2),o=t.hits+t.misses,n=t.rooms>0?(t.totalEntries/t.rooms).toFixed(1):"0",s=(.05*t.hits).toFixed(3);return`=== Room.find() Cache Statistics ===\nCached Rooms: ${t.rooms}\nTotal Entries: ${t.totalEntries}\nAvg Entries/Room: ${n}\n\nTotal Queries: ${o}\nCache Hits: ${t.hits}\nCache Misses: ${t.misses}\nHit Rate: ${r}%\n\nCache Invalidations: ${t.invalidations}\nEstimated CPU Saved: ~${s} CPU this tick\n\nPerformance: ${.8>t.hitRate?.6>t.hitRate?.5>t.hitRate?"Poor - Consider more caching":"Fair":"Good":"Excellent "}`}clearRoomFindCache(){const{clearRoomFindCache:e}=require("../utils/roomFindCache");return e(),"Room.find() cache cleared and statistics reset"}toggleProfiling(){const e=!_e().profiling;return be({profiling:e}),Ye.unifiedStats.setEnabled(e),ee({cpuLogging:e}),"Profiling: "+(e?"ENABLED":"DISABLED")}cpuBreakdown(e){const t=Memory.stats;if(!t)return"No stats available. Stats collection may be disabled.";const r=!e,o=["=== CPU Breakdown ==="];if(o.push("Tick: "+t.tick),o.push(`Total CPU: ${t.cpu.used.toFixed(2)}/${t.cpu.limit} (${t.cpu.percent.toFixed(1)}%)`),o.push("Bucket: "+t.cpu.bucket),o.push(""),r||"process"===e){const e=t.processes||{},r=Object.values(e);if(r.length>0){o.push("=== Process CPU Usage ===");const e=r.sort((e,t)=>t.avg_cpu-e.avg_cpu);for(const t of e.slice(0,10)){const e=t;o.push(`  ${e.name}: ${e.avg_cpu.toFixed(3)} CPU (runs: ${e.run_count}, max: ${e.max_cpu.toFixed(3)})`)}o.push("")}}if(r||"room"===e){const e=t.rooms||{},r=Object.values(e);if(r.length>0){o.push("=== Room CPU Usage ===");const e=r.sort((e,t)=>t.profiler.avg_cpu-e.profiler.avg_cpu);for(const t of e){const e=t,r=e.name||"unknown";o.push(`  ${r}: ${e.profiler.avg_cpu.toFixed(3)} CPU (RCL ${e.rcl})`)}o.push("")}}if(r||"subsystem"===e){const e=t.subsystems||{},r=Object.values(e);if(r.length>0){o.push("=== Subsystem CPU Usage ===");const e=r.sort((e,t)=>t.avg_cpu-e.avg_cpu);for(const t of e.slice(0,10)){const e=t,r=e.name||"unknown";o.push(`  ${r}: ${e.avg_cpu.toFixed(3)} CPU (calls: ${e.calls})`)}o.push("")}}if(r||"creep"===e){const e=t.creeps||{},r=Object.values(e);if(r.length>0){o.push("=== Top Creeps by CPU (Top 10) ===");const e=r.sort((e,t)=>t.cpu-e.cpu);for(const t of e.slice(0,10)){const e=t;if(e.cpu>0){const t=e.name||e.role+"_unknown";o.push(`  ${t} (${e.role}): ${e.cpu.toFixed(3)} CPU in ${e.current_room}`)}}o.push("")}}return o.join("\n")}cpuBudget(){const e=Ye.unifiedStats.validateBudgets();let t=`=== CPU Budget Report (Tick ${e.tick}) ===\n`;if(t+=`Rooms Evaluated: ${e.roomsEvaluated}\n`,t+=`Within Budget: ${e.roomsWithinBudget}\n`,t+=`Over Budget: ${e.roomsOverBudget}\n\n`,0===e.alerts.length)t+=" All rooms within budget!\n";else{t+=`Alerts: ${e.alerts.length}\n`;const r=e.alerts.filter(e=>"critical"===e.severity),o=e.alerts.filter(e=>"warning"===e.severity);if(r.length>0){t+="\n CRITICAL (100% of budget):\n";for(const e of r)t+=`  ${e.target}: ${e.cpuUsed.toFixed(3)} CPU / ${e.budgetLimit.toFixed(3)} limit (${(100*e.percentUsed).toFixed(1)}%)\n`}if(o.length>0){t+="\n  WARNING (80% of budget):\n";for(const e of o)t+=`  ${e.target}: ${e.cpuUsed.toFixed(3)} CPU / ${e.budgetLimit.toFixed(3)} limit (${(100*e.percentUsed).toFixed(1)}%)\n`}}return t}cpuAnomalies(){const e=Ye.unifiedStats.detectAnomalies();if(0===e.length)return" No CPU anomalies detected";let t=`=== CPU Anomalies Detected: ${e.length} ===\n\n`;const r=e.filter(e=>"spike"===e.type),o=e.filter(e=>"sustained_high"===e.type);if(r.length>0){t+=` CPU Spikes (${r.length}):\n`;for(const e of r)t+=`  ${e.target}: ${e.current.toFixed(3)} CPU (${e.multiplier.toFixed(1)}x baseline ${e.baseline.toFixed(3)})\n`,e.context&&(t+=`    Context: ${e.context}\n`);t+="\n"}if(o.length>0){t+=` Sustained High Usage (${o.length}):\n`;for(const e of o)t+=`  ${e.target}: ${e.current.toFixed(3)} CPU (${e.multiplier.toFixed(1)}x budget ${e.baseline.toFixed(3)})\n`,e.context&&(t+=`    Context: ${e.context}\n`)}return t}cpuProfile(e=!1){const t=Ye.unifiedStats.getCurrentSnapshot();let r=`=== CPU Profile (Tick ${t.tick}) ===\n`;r+=`Total: ${t.cpu.used.toFixed(2)} / ${t.cpu.limit} (${t.cpu.percent.toFixed(1)}%)\n`,r+=`Bucket: ${t.cpu.bucket}\n`,r+=`Heap: ${t.cpu.heapUsed.toFixed(2)} MB\n\n`;const o=Object.values(t.rooms).sort((e,t)=>t.profiler.avgCpu-e.profiler.avgCpu),n=e?o:o.slice(0,10);r+=`Top ${n.length} Rooms by CPU:\n`;for(const e of n){const t=Ye.unifiedStats.postureCodeToName(e.brain.postureCode);r+=`  ${e.name} (RCL${e.rcl}, ${t}): avg ${e.profiler.avgCpu.toFixed(3)} | peak ${e.profiler.peakCpu.toFixed(3)} | samples ${e.profiler.samples}\n`}r+="\nTop Kernel Processes by CPU:\n";const s=Object.values(t.processes).filter(e=>e.avgCpu>.001).sort((e,t)=>t.avgCpu-e.avgCpu).slice(0,e?999:10);for(const e of s){const t=e.cpuBudget>0?(e.avgCpu/e.cpuBudget*100).toFixed(0):"N/A";r+=`  ${e.name} (${e.frequency}): avg ${e.avgCpu.toFixed(3)} / budget ${e.cpuBudget.toFixed(3)} (${t}%)\n`}return r}}Q([he({name:"showStats",description:"Show current bot statistics from memory segment",usage:"showStats()",examples:["showStats()"],category:"Statistics"})],tm.prototype,"showStats",null),Q([he({name:"cacheStats",description:"Show object cache statistics (hits, misses, hit rate, CPU savings)",usage:"cacheStats()",examples:["cacheStats()"],category:"Statistics"})],tm.prototype,"cacheStats",null),Q([he({name:"resetCacheStats",description:"Reset cache statistics counters (for benchmarking)",usage:"resetCacheStats()",examples:["resetCacheStats()"],category:"Statistics"})],tm.prototype,"resetCacheStats",null),Q([he({name:"roomFindCacheStats",description:"Show room.find() cache statistics (hits, misses, hit rate)",usage:"roomFindCacheStats()",examples:["roomFindCacheStats()"],category:"Statistics"})],tm.prototype,"roomFindCacheStats",null),Q([he({name:"clearRoomFindCache",description:"Clear all room.find() cache entries and reset stats",usage:"clearRoomFindCache()",examples:["clearRoomFindCache()"],category:"Statistics"})],tm.prototype,"clearRoomFindCache",null),Q([he({name:"toggleProfiling",description:"Toggle CPU profiling on/off",usage:"toggleProfiling()",examples:["toggleProfiling()"],category:"Statistics"})],tm.prototype,"toggleProfiling",null),Q([he({name:"cpuBreakdown",description:"Show detailed CPU breakdown by process, room, creep, and subsystem",usage:"cpuBreakdown(type?)",examples:["cpuBreakdown() // Show all breakdowns","cpuBreakdown('process') // Show only process breakdown","cpuBreakdown('room') // Show only room breakdown","cpuBreakdown('creep') // Show only creep breakdown","cpuBreakdown('subsystem') // Show only subsystem breakdown"],category:"Statistics"})],tm.prototype,"cpuBreakdown",null),Q([he({name:"cpuBudget",description:"Show CPU budget status and violations for all rooms",usage:"cpuBudget()",examples:["cpuBudget()"],category:"Statistics"})],tm.prototype,"cpuBudget",null),Q([he({name:"cpuAnomalies",description:"Detect and show CPU usage anomalies (spikes and sustained high usage)",usage:"cpuAnomalies()",examples:["cpuAnomalies()"],category:"Statistics"})],tm.prototype,"cpuAnomalies",null),Q([he({name:"cpuProfile",description:"Show comprehensive CPU profiling breakdown by room and subsystem",usage:"cpuProfile(showAll?)",examples:["cpuProfile()","cpuProfile(true)"],category:"Statistics"})],tm.prototype,"cpuProfile",null);class rm{showConfig(){const e=_e(),t=te();return`=== SwarmBot Config ===\nDebug: ${e.debug+""}\nProfiling: ${e.profiling+""}\nVisualizations: ${e.visualizations+""}\nLogger Level: ${Z[t.level]}\nCPU Logging: ${t.cpuLogging+""}`}}Q([he({name:"showConfig",description:"Show current bot configuration",usage:"showConfig()",examples:["showConfig()"],category:"Configuration"})],rm.prototype,"showConfig",null);class om{showKernelStats(){const e=qe.getStatsSummary(),t=qe.getConfig();let r=`=== Kernel Stats ===\nBucket Mode: ${qe.getBucketMode().toUpperCase()}\nCPU Bucket: ${Game.cpu.bucket}\nCPU Limit: ${qe.getCpuLimit().toFixed(2)} (${(100*t.targetCpuUsage).toFixed(0)}% of ${Game.cpu.limit})\nRemaining CPU: ${qe.getRemainingCpu().toFixed(2)}\n\nProcesses: ${e.totalProcesses} total (${e.activeProcesses} active, ${e.suspendedProcesses} suspended)\nTotal CPU Used: ${e.totalCpuUsed.toFixed(3)}\nAvg CPU/Process: ${e.avgCpuPerProcess.toFixed(4)}\nAvg Health Score: ${e.avgHealthScore.toFixed(1)}/100\n\nTop CPU Consumers:`;for(const t of e.topCpuProcesses)r+=`\n  ${t.name}: ${t.avgCpu.toFixed(4)} avg CPU`;if(e.unhealthyProcesses.length>0){r+="\n\nUnhealthy Processes (Health < 50):";for(const t of e.unhealthyProcesses)r+=`\n  ${t.name}: ${t.healthScore.toFixed(1)}/100 (${t.consecutiveErrors} consecutive errors)`}return r}listProcesses(){const e=qe.getProcesses();if(0===e.length)return"No processes registered with kernel.";let t="=== Registered Processes ===\n";t+="ID | Name | Priority | Frequency | State | Runs | Avg CPU | Health | Errors\n",t+="-".repeat(100)+"\n";const r=[...e].sort((e,t)=>t.priority-e.priority);for(const e of r){const r=e.stats.avgCpu.toFixed(4),o=e.stats.healthScore.toFixed(0),n=80>e.stats.healthScore?50>e.stats.healthScore?"":"":"";t+=`${e.id} | ${e.name} | ${e.priority} | ${e.frequency} | ${e.state} | ${e.stats.runCount} | ${r} | ${n}${o} | ${e.stats.errorCount}(${e.stats.consecutiveErrors})\n`}return t}suspendProcess(e){return qe.suspendProcess(e)?`Process "${e}" suspended.`:`Process "${e}" not found.`}resumeProcess(e){return qe.resumeProcess(e)?`Process "${e}" resumed.`:`Process "${e}" not found or not suspended.`}resetKernelStats(){return qe.resetStats(),"Kernel statistics reset."}showProcessHealth(){const e=qe.getProcesses();if(0===e.length)return"No processes registered with kernel.";const t=[...e].sort((e,t)=>e.stats.healthScore-t.stats.healthScore);let r="=== Process Health Status ===\n";r+="Name | Health | Errors | Consecutive | Status | Last Success\n",r+="-".repeat(80)+"\n";for(const e of t){const t=e.stats.healthScore.toFixed(0),o=80>e.stats.healthScore?50>e.stats.healthScore?"":"":"",n=e.stats.lastSuccessfulRunTick>0?Game.time-e.stats.lastSuccessfulRunTick:"never",s="suspended"===e.state?`SUSPENDED (${e.stats.suspensionReason})`:e.state.toUpperCase();r+=`${e.name} | ${o} ${t}/100 | ${e.stats.errorCount} | ${e.stats.consecutiveErrors} | ${s} | ${n}\n`}const o=qe.getStatsSummary();return r+=`\nAverage Health: ${o.avgHealthScore.toFixed(1)}/100`,r+="\nSuspended Processes: "+o.suspendedProcesses,r}resumeAllProcesses(){const e=qe.getProcesses().filter(e=>"suspended"===e.state);if(0===e.length)return"No suspended processes to resume.";let t=0;for(const r of e)qe.resumeProcess(r.id)&&t++;return`Resumed ${t} of ${e.length} suspended processes.`}showCreepStats(){const e=Wa.getStats();let t=`=== Creep Process Stats ===\nTotal Creeps: ${e.totalCreeps}\nRegistered Processes: ${e.registeredCreeps}\n\nCreeps by Priority:`;for(const[r,o]of Object.entries(e.creepsByPriority))t+=`\n  ${r}: ${o}`;return t}showRoomStats(){const e=Hc.getStats();let t=`=== Room Process Stats ===\nTotal Rooms: ${e.totalRooms}\nRegistered Processes: ${e.registeredRooms}\nOwned Rooms: ${e.ownedRooms}\n\nRooms by Priority:`;for(const[r,o]of Object.entries(e.roomsByPriority))t+=`\n  ${r}: ${o}`;return t}listCreepProcesses(e){let t=qe.getProcesses().filter(e=>e.id.startsWith("creep:"));if(e&&(t=t.filter(t=>t.name.includes(`(${e})`))),0===t.length)return e?"No creep processes found with role: "+e:"No creep processes registered.";let r=e?`=== Creep Processes (Role: ${e}) ===\n`:"=== All Creep Processes ===\n";r+="Name | Priority | Runs | Avg CPU | Errors\n",r+="-".repeat(70)+"\n";const o=[...t].sort((e,t)=>t.priority-e.priority);for(const e of o){const t=e.stats.avgCpu.toFixed(4);r+=`${e.name} | ${e.priority} | ${e.stats.runCount} | ${t} | ${e.stats.errorCount}\n`}return r+=`\nTotal: ${t.length} creep processes`,r}listRoomProcesses(){const e=qe.getProcesses().filter(e=>e.id.startsWith("room:"));if(0===e.length)return"No room processes registered.";let t="=== Room Processes ===\n";t+="Name | Priority | Runs | Avg CPU | Errors\n",t+="-".repeat(70)+"\n";const r=[...e].sort((e,t)=>t.priority-e.priority);for(const e of r){const r=e.stats.avgCpu.toFixed(4);t+=`${e.name} | ${e.priority} | ${e.stats.runCount} | ${r} | ${e.stats.errorCount}\n`}return t+=`\nTotal: ${e.length} room processes`,t}}Q([he({name:"showKernelStats",description:"Show kernel statistics including CPU usage and process info",usage:"showKernelStats()",examples:["showKernelStats()"],category:"Kernel"})],om.prototype,"showKernelStats",null),Q([he({name:"listProcesses",description:"List all registered kernel processes",usage:"listProcesses()",examples:["listProcesses()"],category:"Kernel"})],om.prototype,"listProcesses",null),Q([he({name:"suspendProcess",description:"Suspend a kernel process by ID",usage:"suspendProcess(processId)",examples:["suspendProcess('empire:manager')","suspendProcess('cluster:manager')"],category:"Kernel"})],om.prototype,"suspendProcess",null),Q([he({name:"resumeProcess",description:"Resume a suspended kernel process",usage:"resumeProcess(processId)",examples:["resumeProcess('empire:manager')"],category:"Kernel"})],om.prototype,"resumeProcess",null),Q([he({name:"resetKernelStats",description:"Reset all kernel process statistics",usage:"resetKernelStats()",examples:["resetKernelStats()"],category:"Kernel"})],om.prototype,"resetKernelStats",null),Q([he({name:"showProcessHealth",description:"Show health status of all processes with detailed metrics",usage:"showProcessHealth()",examples:["showProcessHealth()"],category:"Kernel"})],om.prototype,"showProcessHealth",null),Q([he({name:"resumeAllProcesses",description:"Resume all suspended processes (use with caution)",usage:"resumeAllProcesses()",examples:["resumeAllProcesses()"],category:"Kernel"})],om.prototype,"resumeAllProcesses",null),Q([he({name:"showCreepStats",description:"Show statistics about creep processes managed by the kernel",usage:"showCreepStats()",examples:["showCreepStats()"],category:"Kernel"})],om.prototype,"showCreepStats",null),Q([he({name:"showRoomStats",description:"Show statistics about room processes managed by the kernel",usage:"showRoomStats()",examples:["showRoomStats()"],category:"Kernel"})],om.prototype,"showRoomStats",null),Q([he({name:"listCreepProcesses",description:"List all creep processes with their details",usage:"listCreepProcesses(role?)",examples:["listCreepProcesses()","listCreepProcesses('harvester')"],category:"Kernel"})],om.prototype,"listCreepProcesses",null),Q([he({name:"listRoomProcesses",description:"List all room processes with their details",usage:"listRoomProcesses()",examples:["listRoomProcesses()"],category:"Kernel"})],om.prototype,"listRoomProcesses",null);class nm{listCommands(){return fe.generateHelp()}commandHelp(e){return fe.generateCommandHelp(e)}}Q([he({name:"listCommands",description:"List all available commands (alias for help)",usage:"listCommands()",examples:["listCommands()"],category:"System"})],nm.prototype,"listCommands",null),Q([he({name:"commandHelp",description:"Get detailed help for a specific command",usage:"commandHelp(commandName)",examples:["commandHelp('setLogLevel')","commandHelp('suspendProcess')"],category:"System"})],nm.prototype,"commandHelp",null);const sm=new Ju,im=new em,am=new tm,cm=new rm,lm=new om,um=new nm,mm=me("Main");!function(e=!1){const t=()=>{fe.initialize(),ye(sm),ye(im),ye(am),ye(cm),ye(lm),ye(um),ye(Nl),ye(Pl),ye(Il),ye($l),ye(Fl),ye(Hl),ye(Kl),global.tooangel=Wl,fe.exposeToGlobal()};e?(fe.initialize(),fe.enableLazyLoading(t),fe.exposeToGlobal()):t()}(_e().lazyLoadConsoleCommands);try{const{loadIntegrationTests:e}=require("./tests/loader");e(),mm.info("Integration tests loaded successfully")}catch(ae){mm.debug("Integration tests not loaded: "+ae)}const dm=X.wrapLoop(()=>{try{!function(){Ul&&Game.time%10!=0||de.info("SwarmBot loop executing at tick "+Game.time,{subsystem:"SwarmBot",meta:{systemsInitialized:Ul}}),Ul||function(){const e=_e();ee({level:e.debug?Z.DEBUG:Z.INFO,cpuLogging:e.profiling}),de.info("Bot initialized",{subsystem:"SwarmBot",meta:{debug:e.debug,profiling:e.profiling}}),Ye.unifiedStats.initialize(),e.profiling&&(function(){if(!PathFinder.search)return;if(PathFinder.search.__nativeCallsTrackerWrapped)return;const e=Object.getOwnPropertyDescriptor(PathFinder,"search");if(e&&!1===e.configurable)return void Fi.warn("Cannot wrap PathFinder.search - property is not configurable");const t=PathFinder.search;try{const e=function(...e){return Ye.unifiedStats.recordNativeCall("pathfinderSearch"),t.apply(PathFinder,e)};e.__nativeCallsTrackerWrapped=!0,Object.defineProperty(PathFinder,"search",{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){Fi.warn("Failed to wrap PathFinder.search",{meta:{error:e+""}})}}(),function(){const e=Creep.prototype;Bi(e,"moveTo","moveTo"),Bi(e,"move","move"),Bi(e,"harvest","harvest"),Bi(e,"transfer","transfer"),Bi(e,"withdraw","withdraw"),Bi(e,"build","build"),Bi(e,"repair","repair"),Bi(e,"upgradeController","upgradeController"),Bi(e,"attack","attack"),Bi(e,"rangedAttack","rangedAttack"),Bi(e,"heal","heal"),Bi(e,"dismantle","dismantle"),Bi(e,"say","say")}()),qe.on("structure.destroyed",e=>{const t=Wt.getSwarmState(e.roomName);t&&(hi.onStructureDestroyed(t,e.structureType),de.debug("Pheromone update: structure destroyed in "+e.roomName,{subsystem:"Pheromone",room:e.roomName}))}),qe.on("remote.lost",e=>{const t=Wt.getSwarmState(e.homeRoom);t&&(hi.onRemoteSourceLost(t),de.info("Pheromone update: remote source lost for "+e.homeRoom,{subsystem:"Pheromone",room:e.homeRoom}))}),de.info("Pheromone event handlers initialized",{subsystem:"Pheromone"}),Tl.initializePathCacheEvents(),Rl.initialize(jc.MEDIUM),bt.initialize(),Sr.initialize(),Ul=!0}(),qe.updateFromCpuConfig(_e().cpu),Ol||(de.info("Registering all processes with kernel...",{subsystem:"ProcessRegistry"}),Rr(Ei,ns.terminalManager,ns.factoryManager,ns.linkManager,Rs,Cs,Vs,ns.marketManager,ws,Ps,Us,$s,Bs,Sr,Xs,pi,Fn,Gn.evacuationManager,Gn.defenseCoordinator),de.info(`Registered ${qe.getProcesses().length} processes with kernel`,{subsystem:"ProcessRegistry"}),qe.initialize(),Ol=!0),Ye.unifiedStats.startTick(),"critical"===qe.getBucketMode()&&Game.time%10==0&&de.warn(`CRITICAL: CPU bucket at ${Game.cpu.bucket}, continuing normal processing`,{subsystem:"SwarmBot"}),po.clear(),ro.clear();const e="_ownedRooms",t="_ownedRoomsTick",r=global,o=r[e],n=r[t];let s;o&&n===Game.time?s=o:(s=Object.values(Game.rooms).filter(e=>{var t;return null===(t=e.controller)||void 0===t?void 0:t.my}),r[e]=s,r[t]=Game.time),uo.preTick(),Wt.initialize(),Ye.unifiedStats.measureSubsystem("processSync",()=>{Wa.syncCreepProcesses(),Hc.syncRoomProcesses()}),Ye.unifiedStats.measureSubsystem("kernel",()=>{qe.run()}),Ye.unifiedStats.measureSubsystem("spawns",()=>{!function(){var e;for(const t of Object.values(Game.rooms))(null===(e=t.controller)||void 0===e?void 0:e.my)&&qr(t,Wt.getOrInitSwarmState(t.name))}()}),Ye.unifiedStats.measureSubsystem("ss2PacketQueue",()=>{vl.processQueue()}),qe.hasCpuBudget()&&Ye.unifiedStats.measureSubsystem("powerCreeps",()=>{!function(){for(const e of Object.values(Game.powerCreeps))void 0!==e.ticksToLive&&Fa(e)}()}),qe.hasCpuBudget()&&Ye.unifiedStats.measureSubsystem("visualizations",()=>{Ml()}),uo.reconcileTraffic(),qe.hasCpuBudget()&&Ye.unifiedStats.measureSubsystem("scheduledTasks",()=>{var e;e=Math.max(0,Game.cpu.limit-Game.cpu.getUsed()),Jc.run(e)}),Wt.persistHeapCache(),Ye.unifiedStats.collectProcessStats(qe.getProcesses().reduce((e,t)=>(e.set(t.id,t),e),new Map)),Ye.unifiedStats.collectKernelBudgetStats(qe),Ye.unifiedStats.setSkippedProcesses(qe.getSkippedProcessesThisTick()),Ye.unifiedStats.finalizeTick()}()}catch(e){throw mm.error("Critical error in main loop: "+e,{meta:{stack:e instanceof Error?e.stack:void 0,tick:Game.time}}),e}});exports.loop=dm;
